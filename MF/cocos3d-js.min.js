System.register([],function(m4){"use strict";return{execute:function(){function be(e){return(be="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function y(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}function s(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&i(e,t)}function g(e){return(g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function i(e,t){return(i=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function x(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?c(e):t}function o(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=g(e)););return e}function p(e,t,i){return(p="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=o(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(i):r.value}})(e,t,i||e)}function a(e,t,i,n){return(a="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(e,t,i,n){var r,a=o(e,t);if(a){if((r=Object.getOwnPropertyDescriptor(a,t)).set)return r.set.call(n,i),!0;if(!r.writable)return!1}if(r=Object.getOwnPropertyDescriptor(n,t)){if(!r.writable)return!1;r.value=i,Object.defineProperty(n,t,r)}else s(n,t,i);return!0})(e,t,i,n)}function r(e,t,i,n,r){if(!a(e,t,i,n||e)&&r)throw new Error("failed to set property");return i}function u(e){return function(e){if(Array.isArray(e)){for(var t=0,i=new Array(e.length);t<e.length;t++)i[t]=e[t];return i}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function v(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function m(i,n,e,t,r){var a={};return Object.keys(t).forEach(function(e){a[e]=t[e]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},a),r&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(i,n,a),a=null),a}m4({BitMask:pt,Enum:vt,EventType:void 0,GFXAddress:void 0,GFXAttributeName:void 0,GFXBindingType:void 0,GFXBlendFactor:void 0,GFXBlendOp:void 0,GFXBufferAccessBit:void 0,GFXBufferFlagBit:void 0,GFXBufferUsageBit:void 0,GFXClearFlag:void 0,GFXColorMask:void 0,GFXCommandBufferType:void 0,GFXComparisonFunc:void 0,GFXCullMode:void 0,GFXDynamicState:void 0,GFXFilter:void 0,GFXFormat:void 0,GFXFormatSize:Sc,GFXFormatSurfaceSize:Tc,GFXFormatType:void 0,GFXGetTypeSize:Ec,GFXLoadOp:void 0,GFXMemoryUsageBit:void 0,GFXObjectType:void 0,GFXPipelineBindPoint:void 0,GFXPolygonMode:void 0,GFXPrimitiveMode:void 0,GFXQueueType:void 0,GFXSampleCount:void 0,GFXShadeModel:void 0,GFXShaderType:void 0,GFXStatus:void 0,GFXStencilFace:void 0,GFXStencilOp:void 0,GFXStoreOp:void 0,GFXTextureFlagBit:void 0,GFXTextureLayout:void 0,GFXTextureType:void 0,GFXTextureUsageBit:void 0,GFXTextureViewType:void 0,GFXType:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,Overflow:void 0,RenderPassStage:void 0,SystemEventType:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:Fo,WorldNode3DToWorldNodeUI:zo,approx:_i,assert:k,assertID:V,bezier:Xk,bezierByTime:eR,clamp:pi,clamp01:vi,color:sr,computeRatioByType:dR,equals:di,error:C,errorID:z,find:af,fragmentText:Zs,getPathFromRoot:NO,getWorldTransformUntilRoot:UO,inverseLerp:Ri,isCustomTargetModifier:ER,isDisplayStats:H,isElementModifier:wR,isPropertyModifier:TR,isUnicodeCJK:Ys,isUnicodeSpace:Ks,lerp:mi,log:E,logID:B,markAsWarning:void 0,mat4:Dn,nextPow2:Ai,pingPong:ki,pseudoRandom:Ti,pseudoRandomRange:wi,pseudoRandomRangeInt:Ei,quat:yn,randomRange:xi,randomRangeInt:Si,rect:$n,removeProperty:void 0,repeat:Ci,replaceProperty:void 0,safeMeasureText:Qs,sampleAnimationCurve:fR,setDefaultLogTimes:function(e){0<e&&(fr=e)},setDisplayStats:W,size:Xn,toDegree:gi,toRadian:yi,tween:L3,tweenUtil:I3,v2:Pi,v3:Gi,v4:Yi,warn:A,warnID:P});var h="undefined"==typeof window?global:window,e=h.cc=h.cc||{};function t(e,t){void 0===h[e]&&(h[e]=t)}e.internal=e.internal||{},e._global=h,t("CC_BUILD",!1),h.CC_BUILD=!0,h.CC_TEST=!1,h.CC_EDITOR=!1,h.CC_PREVIEW=!1,h.CC_DEV=!1,h.CC_DEBUG=!1,h.CC_JSB=!1,h.CC_WECHATGAME=!1,h.CC_QQPLAY=!1,h.CC_RUNTIME=!1,h.CC_SUPPORT_JIT=!0,h.CC_PHYSICS_BUILTIN=!1,h.CC_PHYSICS_CANNON=!0,h.CC_PHYSICS_AMMO=!1;h.CocosEngine=e.ENGINE_VERSION="1.0.0",Object.defineProperty(h,"CC_PHYSICS_BUILT_IN",{get:function(){return console.warn("CC_PHYSICS_BUILT_IN is deprecated, please using CC_PHYSICS_BUILTIN instead."),h.CC_PHYSICS_BUILTIN}});var f=null,d=console.log,b=console.log,S=console.log,T=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];console.log("ASSERT: "+w.apply(void 0,[t].concat(n)))}};function w(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return cc.js.formatStr.apply(null,[e].concat(i))}function E(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return d.apply(void 0,[e].concat(i))}function A(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return b.apply(void 0,[e].concat(i))}function C(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return S.apply(void 0,[e].concat(i))}function k(e,t){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return T.apply(void 0,[e,t].concat(n))}function R(e){if(d=b=S=T=function(){},e!==D.NONE){if(e>D.ERROR){var a=function(e){if(cc.game.canvas){if(!f){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",cc.game.canvas.height);var i=t.style;i.zIndex="99999",i.position="absolute",i.top=i.left="0",(f=document.createElement("textarea")).setAttribute("rows","20"),f.setAttribute("cols","30"),f.setAttribute("disabled","true");var n=f.style;n.backgroundColor="transparent",n.borderBottom="1px solid #cccccc",n.borderTopWidth=n.borderLeftWidth=n.borderRightWidth="0px",n.borderTopStyle=n.borderLeftStyle=n.borderRightStyle="none",n.padding="0px",n.margin="0px",t.appendChild(f),cc.game.canvas.parentNode.appendChild(t)}f.value=f.value+e+"\r\n",f.scrollTop=f.scrollHeight}};S=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];a("ERROR :  "+w.apply(void 0,[e].concat(i)))},T=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];a("ASSERT: "+w.apply(void 0,[t].concat(n)))}},e!==D.ERROR_FOR_WEB_PAGE&&(b=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];a("WARN :  "+w.apply(void 0,[e].concat(i)))}),e===D.INFO_FOR_WEB_PAGE&&(d=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];a(w.apply(void 0,[e].concat(i)))})}else console&&console.log.apply&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),S=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.error.apply(console,[e].concat(i))},T=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];var a=w.apply(void 0,[t].concat(n));throw new Error(a)}});e!==D.ERROR&&(b=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.warn.apply(console,[e].concat(i))}),e===D.INFO&&(d=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.log.apply(console,[e].concat(i))})}}function O(e){var t=e.stack;C(t||e)}function M(a){return function(e){for(var t="".concat(a," ").concat(e,", please go to ").concat("https://github.com/cocos-creator/engine/blob/3d-v1.0.0/EngineErrorMap.md","#").concat(e," to see details."),i=arguments.length,n=new Array(1<i?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];return 0===n.length?t:t+" Arguments: "+n.join(", ")}}var I=M("Log");function B(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];E(I.apply(void 0,[e].concat(i)))}var L=M("Warning");function P(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];A(L.apply(void 0,[e].concat(i)))}var F=M("Error");function z(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];C(F.apply(void 0,[e].concat(i)))}var D,N,U=M("Assert");function V(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];k(!1,U.apply(void 0,[t].concat(n)))}}function G(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return F.apply(void 0,[e].concat(i))}function H(){return!!cc.profiler&&cc.profiler.isShowingStats()}function W(e){cc.profiler&&(e?cc.profiler.showStats():cc.profiler.hideStats(),cc.game.config.showFPS=!!e)}(N=D=D||{})[N.NONE=0]="NONE",N[N.INFO=1]="INFO",N[N.WARN=2]="WARN",N[N.ERROR=3]="ERROR",N[N.INFO_FOR_WEB_PAGE=4]="INFO_FOR_WEB_PAGE",N[N.WARN_FOR_WEB_PAGE=5]="WARN_FOR_WEB_PAGE",N[N.ERROR_FOR_WEB_PAGE=6]="ERROR_FOR_WEB_PAGE";var q=Object.freeze({log:E,warn:A,error:C,assert:k,_resetDebugSetting:R,_throw:O,logID:B,warnID:P,errorID:z,assertID:V,get DebugMode(){return D},getError:G,isDisplayStats:H,setDisplayStats:W}),j=/(\.[^\.\/\?\\]*)(\?.*)?$/,X=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,Y=/[^\.\/]+\/\.\.\//;function K(){for(var e="",t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];for(var r=0,a=i;r<a.length;r++){e=(e+(""===e?"":"/")+a[r]).replace(/(\/|\\\\)$/,"")}return e}function Q(e){var t=j.exec(e);return t?t[1]:""}function Z(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function J(e,t){var i=e.indexOf("?");0<i&&(e=e.substring(0,i));var n=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!n)return"";var r=n[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function $(e){var t=X.exec(e);return t?t[2]:""}function ee(e,t){t=t||"";var i=e.indexOf("?"),n="";return 0<i&&(n=e.substring(i),e=e.substring(0,i)),(i=e.lastIndexOf("."))<0?e+t+n:e.substring(0,i)+t+n}function te(e,t,i){if(0===t.indexOf("."))return ee(e,t);var n=e.indexOf("?"),r="",a=i?Q(e):"";return 0<n&&(r=e.substring(n),e=e.substring(0,n)),n=(n=e.lastIndexOf("/"))<=0?0:n+1,e.substring(0,n)+t+a+r}function ie(e){for(var t=e=String(e);e=(t=e).replace(Y,""),t.length!==e.length;);return e}function ne(e){return e.replace(/[\/\\]$/,"")}function re(){return cc.sys.os===cc.sys.OS_WINDOWS?"\\":"/"}m4("path",Object.freeze({join:K,extname:Q,mainFileName:Z,basename:J,dirname:$,changeExtname:ee,changeBasename:te,_normalize:ie,stripSep:ne,getSeperator:re})),cc.log=E,cc.warn=A,cc.error=C,cc.assert=k,cc._throw=O,cc.logID=B,cc.warnID=P,cc.errorID=z,cc.assertID=V,cc.debug=q,cc.path={join:K,extname:Q,mainFileName:Z,basename:J,dirname:$,changeExtname:ee,changeBasename:te,_normalize:ie,stripSep:ne,get sep(){return re()}};var ae=2147483647;function se(e){return(0<e)-(e<0)}function oe(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}var le=new Array(256);!function(e){for(var t=0;t<256;++t){var i=t,n=t,r=7;for(i>>>=1;i;i>>>=1)n<<=1,n|=1&i,--r;e[t]=n<<r&255}}(le);var ue=Object.freeze({INT_BITS:32,INT_MAX:ae,INT_MIN:-1<<31,sign:se,abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:function(e){var t,i;return t=(65535<e)<<4,t|=i=(255<(e>>>=t))<<3,t|=i=(15<(e>>>=i))<<2,(t|=i=(3<(e>>>=i))<<1)|(e>>>=i)>>1},log10:function(e){return 1e9<=e?9:1e8<=e?8:1e7<=e?7:1e6<=e?6:1e5<=e?5:1e4<=e?4:1e3<=e?3:100<=e?2:10<=e?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:oe,nextPow2:function(e){return e+=0===e,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)+1},prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return le[255&e]<<24|le[e>>>8&255]<<16|le[e>>>16&255]<<8|le[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,i){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return 1+t|(~t&-~t)-1>>>oe(e)+1}});m4("bits",ue);var ce=function(){function t(e){y(this,t),this.array=e,this.i=0}return l(t,[{key:"remove",value:function(e){var t=this.array.indexOf(e);0<=t&&this.removeAt(t)}},{key:"removeAt",value:function(e){this.array.splice(e,1),e<=this.i&&--this.i}},{key:"fastRemove",value:function(e){var t=this.array.indexOf(e);0<=t&&this.fastRemoveAt(t)}},{key:"fastRemoveAt",value:function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i}},{key:"push",value:function(e){this.array.push(e)}},{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),t}();function he(e,t){e.splice(t,1)}function fe(e,t){var i=e.indexOf(t);return 0<=i&&(he(e,i),!0)}function de(e,t){return 0<=e.indexOf(t)}var _e=Object.freeze({removeAt:he,fastRemoveAt:function(e,t){var i=e.length;t<0||i<=t||(e[t]=e[i-1],e.length=i-1)},remove:fe,fastRemove:function(e,t){var i=e.indexOf(t);0<=i&&(e[i]=e[e.length-1],--e.length)},removeIf:function(e,t){var i=e.findIndex(t);if(0<=i){var n=e[i];return he(e,i),n}},verifyType:function(e,t){if(e&&0<e.length){var i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}if(!(a instanceof t))return cc.logID(1300),!1}}return!0},removeArray:function(e,t){for(var i=0,n=t.length;i<n;i++)fe(e,t[i])},appendObjectsAt:function(e,t,i){return e.splice.apply(e,[i,0].concat(u(t))),e},indexOf:function(e,t,i){return Array.prototype.indexOf.call(e,[t,i])},contains:de,copy:function(e){for(var t=e.length,i=new Array(t),n=0;n<t;n+=1)i[n]=e[n];return i},MutableForwardIterator:ce}),pe=function(){function t(e){y(this,t),this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}return l(t,[{key:"getNewId",value:function(){return this.prefix+ ++this.id}}]),t}();pe.global=new pe("global");var ve=new pe("TmpCId.");function me(e){return"number"==typeof e||e instanceof Number}function ye(e){return"string"==typeof e||e instanceof String}var ge,xe,Se,Te,we=(ge={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,i,n,r){ge.value=i,ge.writable=n,ge.enumerable=r,Object.defineProperty(e,t,ge),ge.value=void 0}),Ee=(xe={get:void 0,set:void 0,enumerable:!1},function(e,t,i,n){var r=4<arguments.length&&void 0!==arguments[4]&&arguments[4],a=5<arguments.length&&void 0!==arguments[5]&&arguments[5];"boolean"==typeof n&&(r=n,n=void 0),xe.get=i,xe.set=n,xe.enumerable=r,xe.configurable=a,Object.defineProperty(e,t,xe),xe.get=void 0,xe.set=void 0}),Ae=(Se={get:void 0,enumerable:!1,configurable:!1},function(e,t,i,n,r){Se.get=i,Se.enumerable=n,Se.configurable=r,Object.defineProperty(e,t,Se),Se.get=void 0}),Ce=(Te={set:void 0,enumerable:!1,configurable:!1},function(e,t,i,n,r){Te.set=i,Te.enumerable=n,Te.configurable=r,Object.defineProperty(e,t,Te),Te.set=void 0});function ke(e){var t=Object.create(null);if(e){t["."]=!0,t["/"]=!0,delete t["."],delete t["/"]}return t}function Re(e){if("function"!=typeof e)return e&&e.constructor?Re(e.constructor):"";var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var i="";if(e.name&&(i=e.name),e.toString){var n,r=e.toString();(n="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===n.length&&(i=n[1])}return"Object"!==i?i:""}function Oe(e,t,i,n){var r=/([^.]+)$/,a=r.exec(t)[0],s=r.exec(i)[0];function o(){return this[s]}n?Ee(e,a,o,function(e){this[s]=e}):Ae(e,a,o)}function Me(e,t,i,n){for(var r in i){Oe(e,t+"."+r,i[r],n)}}var Ie=/(%d)|(%s)/,Be=/%s/;function Le(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];if(0===arguments.length)return"";if(0===i.length)return""+e;if("string"==typeof e&&Ie.test(e)){var r=i,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,u="number"==typeof l?Ie:Be;u.test(e)?e=e.replace(u,l):e+=" "+l}}else{var c=i,h=Array.isArray(c),f=0;for(c=h?c:c[Symbol.iterator]();;){var d;if(h){if(f>=c.length)break;d=c[f++]}else{if((f=c.next()).done)break;d=f.value}e+=" "+d}}return e}function Pe(){for(var e=arguments.length-1,t=new Array(e),i=0;i<e;++i)t[i]=arguments[i+1];return t}function Fe(e,t){for(;e;){var i=Object.getOwnPropertyDescriptor(e,t);if(i)return i;e=Object.getPrototypeOf(e)}return null}function ze(e,t,i){var n=Fe(t,e);n&&Object.defineProperty(i,e,n)}function De(e){e=e||{};for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=i;r<a.length;r++){var s=a[r];if(s){if("object"!==be(s)){cc.errorID(5402,s);continue}for(var o in s)o in e||ze(o,s,e)}}return e}function Ne(e){e=e||{};for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=i;r<a.length;r++){var s=a[r];if(s){if("object"!==be(s)){cc.errorID(5403,s);continue}for(var o in s)ze(o,s,e)}}return e}function Ue(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function Ve(e){var t=e.prototype,i=t&&Object.getPrototypeOf(t);return i&&i.constructor}function Ge(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=Ve(e)))return!1;if(e===t)return!0}}return!1}function He(e){for(var t=0,i=Object.keys(e);t<i.length;t++){delete e[i[t]]}}var We={},qe={};function je(e,t){var i="__cid__",n=We;if(t.prototype.hasOwnProperty(i)&&delete n[t.prototype[i]],we(t.prototype,i,e),e){var r=n[e];if(r&&r!==t){var a='A Class already exists with the same __cid__ : "'+e+'".';0,cc.error(a)}else n[e]=t}}function Xe(e,t){if(function(e,t){var i="__classname__",n=qe;if(t.prototype.hasOwnProperty(i)&&delete n[t.prototype[i]],we(t.prototype,i,e),e){var r=n[e];if(r&&r!==t){var a="A Class already exists with the same "+i+' : "'+e+'".';0,cc.error(a)}else n[e]=t}}(e,t),!t.prototype.hasOwnProperty("__cid__")){var i=e||ve.getNewId();i&&je(i,t)}}function Ye(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var n=0,r=t;n<r.length;n++){var a=r[n].prototype,s=a.__cid__;s&&delete We[s];var o=a.__classname__;o&&delete qe[o]}}function Ke(e){return We[e]}function Qe(e){return qe[e]}function Ze(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty("__cid__"))return e.prototype.__cid__;if(e&&e.constructor){var i=e.constructor.prototype;if(i&&i.hasOwnProperty("__cid__"))return e.__cid__}return""}var Je=function(){function r(e,t){y(this,r),this.count=void 0,this._pool=void 0;var i=(this._cleanup=void 0)===t?e:t,n=void 0===t?null:e;this.count=0,this._pool=new Array(i),this._cleanup=n}return l(r,[{key:"get",value:function(){return this._get()}}]),l(r,[{key:"_get",value:function(){if(0<this.count){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null}},{key:"put",value:function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}}},{key:"resize",value:function(e){0<=e&&(this._pool.length=e,this.count>e&&(this.count=e))}}]),r}(),$e=_e,et={IDGenerator:pe,Pool:Je,array:_e,isNumber:me,isString:ye,getPropertyDescriptor:Fe,addon:De,mixin:Ne,extend:Ue,getSuper:Ve,isChildClassOf:Ge,clear:He,value:we,getset:Ee,get:Ae,set:Ce,unregisterClass:Ye,getClassName:Re,setClassName:Xe,getClassByName:Qe,_getClassId:Ze,_setClassId:je,_getClassById:Ke,obsolete:Oe,obsoletes:Me,formatStr:Le,shiftArguments:Pe,createMap:ke};cc.js=et,m4("js",Object.freeze({array:$e,js:et,IDGenerator:pe,Pool:Je,isNumber:me,isString:ye,value:we,getset:Ee,get:Ae,set:Ce,createMap:ke,getClassName:Re,obsolete:Oe,obsoletes:Me,formatStr:Le,shiftArguments:Pe,getPropertyDescriptor:Fe,addon:De,mixin:Ne,extend:Ue,getSuper:Ve,isChildClassOf:Ge,clear:He,_idToClass:We,_nameToClass:qe,_setClassId:je,setClassName:Xe,unregisterClass:Ye,_getClassById:Ke,getClassByName:Qe,_getClassId:Ze}));for(var tt=/^(?:cc|dragonBones|sp|ccsg)\..+/,it=new Array(123),nt=0;nt<123;++nt)it[nt]=64;for(var rt=0;rt<64;++rt)it["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(rt)]=rt;var at=it;function st(e,t,i){function n(e,t,i,n){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[i]=r.get),r.set&&n&&(e[n]=r.set);else{var a=e[i];Ee(e,t,a,e[n])}}for(var r,a=e.prototype,s=0;s<t.length;s++){var o=(r=t[s])[0].toUpperCase()+r.slice(1);n(a,r,"get"+o,"set"+o)}for(r in i){var l=i[r];n(a,r,l[0],l[1])}}function ot(e){return e-=1,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)+1}function lt(e,t,i,n){var r=e[t];r?Array.isArray(r)?n?(r.push(r[0]),r[0]=i):r.push(i):e[t]=n?[i,r]:[r,i]:e[t]=i}function ut(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var i=t.parentNode;if(i)do{if(i===e)return!0;i=i.parentNode}while(null!==i);return!1}function ct(e){return"object"===("undefined"==typeof window?"undefined":be(window))&&"function"==typeof Node?e instanceof Node:e&&"object"===be(e)&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function ht(e,t,i){e&&setTimeout(function(){e(t,i)},0)}function ft(e,t,i,n){return Function("arg","return "+function(e){try{target._FUNC_(_U_ARGS_)}catch(e){cc._throw(e)}_AFTER_CALL_}.toString().replace(/_FUNC_/g,e).replace("_R_ARGS_","target"+(t?", "+t:"")).replace("_U_ARGS_",t||"").replace("_AFTER_CALL_",i||""))(n)}function dt(e){if(!e||e.constructor!==Object)return!1;for(var t in e)return!1;return!0}function _t(e){return e&&"function"==typeof e.clone&&(e.constructor&&e.constructor.prototype.hasOwnProperty("clone")||e.hasOwnProperty("clone"))}function pt(e){if("__bitmask__"in e)return e;we(e,"__bitmask__",null,!0);for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var s=""+a;r!==s&&we(e,s,r)}return e}function vt(e){if("__enums__"in e)return e;we(e,"__enums__",null,!0);for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var s=""+a;r!==s&&we(e,s,r)}return e}function mt(e){"__enums__"in e||we(e,"__enums__",null,!0)}cc.misc={BUILTIN_CLASSID_RE:tt,BASE64_VALUES:at,propertyDefine:st,nextPOT:ot,pushToMap:lt,contains:ut,isDomNode:ct,callInNextTick:ht,tryCatchFunctor_EDITOR:ft,isPlainEmptyObj_DEV:dt,cloneable_DEV:_t},m4("misc",Object.freeze({BUILTIN_CLASSID_RE:tt,BASE64_VALUES:at,propertyDefine:st,nextPOT:ot,pushToMap:lt,contains:ut,isDomNode:ct,callInNextTick:ht,tryCatchFunctor_EDITOR:ft,isPlainEmptyObj_DEV:dt,cloneable_DEV:_t})),pt.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},pt.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var i in e){var n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort(function(e,t){return e.value-t.value}),t},cc.BitMask=pt,vt.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},vt.getList=function(e){if(e.__enums__)return e.__enums__;var t=e.__enums__=[];for(var i in e){var n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort(function(e,t){return e.value-t.value}),t},cc.Enum=vt;var yt=m4("ValueType",function(){function e(){y(this,e)}return l(e,[{key:"clone",value:function(){return z(100,Re(this)+".clone"),this}},{key:"equals",value:function(e){return!1}},{key:"set",value:function(e){z(100,Re(this)+".set")}},{key:"toString",value:function(){return""+{}}}]),e}());Xe("cc.ValueType",yt),cc.ValueType=yt;var gt="$_$";function bt(e,t,i){var n;n=function(){},i&&Ue(n,i.constructor);var r=new n;return we(e,"__attrs__",r),r}function xt(e){for(var t,i=cc.Class.getInheritanceChain(e),n=i.length-1;0<=n;n--){var r=i[n];r.hasOwnProperty("__attrs__")&&r.__attrs__||bt(r,0,(t=i[n+1])&&t.__attrs__)}return bt(e,0,(t=i[0])&&t.__attrs__),e.__attrs__}function St(e,t,i){var n,r;if("function"==typeof e)r=(n=Tt(e)).constructor.prototype;else{var a=e;if(!(n=a.__attrs__))n=bt(a,0,Tt(e=a.constructor));r=n}if(void 0===i){var s=t+gt,o={};for(var l in n)l.startsWith(s)&&(o[l.slice(s.length)]=n[l]);return o}if("object"===be(i))for(var u in i)95!==u.charCodeAt(0)&&(r[t+gt+u]=i[u]);else 0}function Tt(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||xt(e)}function wt(e){return Tt(e).constructor.prototype}function Et(e,t,i,n){wt(e)[t+gt+i]=n}var At=function(){function i(e,t){y(this,i),this.name=void 0,this.default=void 0,this.name=e,this.default=t}return l(i,[{key:"toString",value:function(){return this.name}}]),i}(),Ct=m4("CCInteger",new At("Integer",0));cc.Integer=Ct,cc.CCInteger=Ct;var kt=m4("CCFloat",new At("Float",0));cc.Float=kt,cc.CCFloat=kt;var Rt=m4("CCBoolean",new At("Boolean",!1));cc.Boolean=Rt,cc.CCBoolean=Rt;var Ot=m4("CCString",new At("String",""));function Mt(l,u){return function(e,t){var i='"'+Re(e)+"."+t+'"',n=St(e,t);if(!n.saveUrlAsAsset){var r=n.type;if(r===Ct||r===kt?r="Number":r!==Ot&&r!==Rt||(r=r.toString()),r!==l)return void P(3604,i)}if(n.hasOwnProperty("default")){var a=n.default;if(void 0!==a)if(!(Array.isArray(a)||dt(a))){var s=be(a),o=l.toLowerCase();if(s===o){if(!n.saveUrlAsAsset)if("object"===o){if(!a||a instanceof n.ctor)return;P(3605,i,Re(n.ctor))}else"Number"!==l&&P(3606,u,i,l)}else{if("function"===s)return;l===Ot.default&&null==a?Ge(n.ctor,cc.RawAsset)||P(3607,i):P(3611,u,i,s)}delete n.type}}}}function It(s){return function(e,t){Mt("Object","type")(e,t);var i=Tt(e)[t+gt+"default"],n=cc.Class.getDefault(i);if(!Array.isArray(n)&&Ge(s,cc.ValueType)){var r=Re(s),a=Le('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',Re(e),t,r);i?E(a):P(3612,a,r,Re(e),t,r)}}}cc.String=Ot,cc.CCString=Ot;var Bt=Object.freeze({DELIMETER:gt,createAttrsSingle:bt,createAttrs:xt,attr:St,getClassAttrs:Tt,getClassAttrsProto:wt,setClassAttr:Et,PrimitiveType:At,CCInteger:Ct,CCFloat:kt,CCBoolean:Rt,CCString:Ot,getTypeChecker:Mt,getObjTypeChecker:It}),Lt={url:{canUsedInGet:!0},default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Pt(e,t,i,n){if(!e.get&&!e.set)if(e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,i.call(this,t)};var a={};for(var s in n[r]=a,Lt){var o=Lt[s];e.hasOwnProperty(s)&&(a[s]=e[s],o.canUsedInGet||delete e[s])}}else 0}function Ft(e,t,i,n){if(Array.isArray(t)){if(!(0<t.length))return z(5508,i,n);if(cc.RawAsset.isRawAssetType(t[0]))return e.url=t[0],void delete e.type;e.type=t=t[0]}}function zt(e){if(e&&e.constructor===Object)return null;if(Array.isArray(e)&&0<e.length){e[0];return{default:[],type:e,_short:!0}}if("function"!=typeof e)return e instanceof At?{default:e.default,_short:!0}:{default:e,_short:!0};var t=e;return cc.RawAsset.isRawAssetType(t)?{default:"",url:t,_short:!0}:{default:Ge(t,cc.ValueType)?new t:null,type:t,_short:!0}}var Dt=[];function Nt(){return Dt[Dt.length-1]}cc._RF={push:function(e,t,i){void 0===i&&(i=t,t=""),Dt.push({uuid:t,script:i,module:e,exports:e.exports,beh:null})},pop:function(){var e=Dt.pop(),t=e.module,i=t.exports;if(i===e.exports){for(var n in i)return;t.exports=i=e.cls}},peek:Nt};var Ut=gt,Vt=["name","extends","mixins","ctor","__ctor__","properties","statics","editor","__ES6__"];function Gt(e,t){e.indexOf(t)<0&&e.push(t)}var Ht={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout(function(){t.init()},0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var i=e[t],n=i.cls,r=i.props;"function"==typeof r&&(r=r());var a=Re(n);r?ai(n,a,r,n.$super,i.mixins):z(3633,a)}this.datas=null}}};function Wt(e,t){Gt(e.__props__,t)}var qt=[];function jt(e,t,i,n){var r=n.default;Et(e,i,"default",r),Wt(e,i);var a=ui(e,n,t,i,!1);if(a){for(var s=qt,o=0;o<a.length;o++){var l=a[o];St(e,i,l),!1===l.serializable&&Gt(e.__values__,i),l._onAfterProp&&s.push(l._onAfterProp)}for(var u=0;u<s.length;u++)s[u](e,i);qt.length=0,a.length=0}}function Xt(e,t,i,n,r){var a=n.get,s=n.set,o=e.prototype,l=Object.getOwnPropertyDescriptor(o,i),u=!l;if(a){0;for(var c=ui(e,n,t,i,!0),h=0;h<c.length;h++)St(e,i,c[h]);c.length=0,Et(e,i,"serializable",!1),r||Ae(o,i,a,u,u)}s&&(r||Ce(o,i,s,u,u))}function Yt(e){return"function"==typeof e?e():e}function Kt(e,t,i){for(var n in t)e.hasOwnProperty(n)||i&&!i(n)||Object.defineProperty(e,n,Fe(t,n))}function Qt(e,t,i,n){var r,a,s=n.__ctor__,o=n.ctor,l=n.__ES6__;l?(r=[o],a=o):(r=s?[s]:function(e,t,i){for(var n=[],r=[e].concat(t),a=0;a<r.length;a++){var s=r[a];if(s)for(var o=si._isCCClass(u=s)?u.__ctors__||[]:[u],l=0;l<o.length;l++)Gt(n,o[l])}var u;var c=i.ctor;c&&n.push(c);return n}(t,i,n),a=ti(r,t,e,n),we(a,"extend",function(e){return e.extends=this,si(e)},!0)),we(a,"__ctors__",0<r.length?r:null,!0);var u=a.prototype;if(t&&(l||(Ue(a,t),u=a.prototype),a.$super=t),i){for(var c=function(e){var t=i[e];Kt(u,t.prototype),Kt(a,t,function(e){return t.hasOwnProperty(e)&&!0}),si._isCCClass(t)&&Kt(Tt(a).constructor.prototype,Tt(t).constructor.prototype)},h=i.length-1;0<=h;h--)c(h);u.constructor=a}return l||(u.__initProps__=ei),Xe(e,a),a}function Zt(e){for(var t=Re(e),i=e.constructor,n="new "+t+"(",r=0;r<i.__props__.length;r++){var a=e[i.__props__[r]];0,n+=a,r<i.__props__.length-1&&(n+=",")}return n+")"}function Jt(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")}var $t=/^[A-Za-z_$][0-9A-Za-z_$]*$/;function ei(e){var t=Tt(e),i=e.__props__;null===i&&(Ht.init(),i=e.__props__);var n=function(e,t){for(var i=[],n="",r=0;r<t.length;r++){var a=t[r],s=a+Ut+"default";if(s in e){var o=void 0;o=$t.test(a)?"this."+a+"=":"this["+Jt(a)+"]=";var l=void 0,u=e[s];if("object"===be(u)&&u)l=u instanceof cc.ValueType?Zt(u):Array.isArray(u)?"[]":"{}";else if("function"==typeof u){var c=i.length;i.push(u),l="F["+c+"]()"}else l="string"==typeof u?Jt(u):u;n+=o=o+l+";\n"}}return 0===i.length?Function(n):Function("F","return (function(){\n"+n+"})")(i)}(t,i);(e.prototype.__initProps__=n).call(this)}var ti=function(e,t,i,n){var r="CCClass",a="return function CCClass(){\n";t&&ri(t,n,i)&&(a+="this._super=null;\n"),a+="this.__initProps__(CCClass);\n";var s=e.length;if(0<s){0;var o="].apply(this,arguments);\n";if(1===s)a+=r+".__ctors__[0"+o;else{a+="var cs=CCClass.__ctors__;\n";for(var l=0;l<s;l++)a+="cs["+l+o}0}return a+="}",Function(a)()};var ii=/xyz/.test(function(){}.toString()),ni=ii?/\b\._super\b/:/.*/;function ri(e,t){var i=!1;for(var n in t)if(!(0<=Vt.indexOf(n))){var r=t[n];if("function"==typeof r){var a=Fe(e.prototype,n);if(a){var s=a.value;if("function"==typeof s){ni.test(r)&&(i=!0,t[n]=function(i,n){return function(){var e=this._super;this._super=i;var t=n.apply(this,arguments);return this._super=e,t}}(s,r));continue}}0}}return i}function ai(t,e,i,n,r,a){if(t.__props__=[],n&&n.__props__&&(t.__props__=n.__props__.slice()),r)for(var s=0;s<r.length;++s){var o=r[s];o.__props__&&(t.__props__=t.__props__.concat(o.__props__.filter(function(e){return t.__props__.indexOf(e)<0})))}if(i)for(var l in function(e,t){for(var i in e){var n=e[i],r=zt(n);if(r&&(n=e[i]=r),n){var a=n.notify;a&&Pt(n,i,a,e),"type"in n&&Ft(n,n.type,t,i),"url"in n&&(o=(s=n).url,Array.isArray(o)&&0<o.length&&(o=o[0]),s.type=o),"type"in n&&n.type}}var s,o}(i,e),i){var u=i[l];"default"in u?jt(t,e,l,u):Xt(t,e,l,u,a)}var c=Tt(t);t.__values__=t.__props__.filter(function(e){return!1!==c[e+Ut+"serializable"]})}function si(e){var t=(e=e||{}).name,i=e.extends,n=e.mixins,r=function(e,t,i,n){var r=cc.Component,a=Nt();if(a&&Ge(t,r)){if(Ge(a.cls,r))return z(3615),null;0,e=e||a.script}var s=Qt(e,t,i,n);if(a)if(Ge(t,r)){var o=a.uuid;o&&je(o,s),a.cls=s}else Ge(a.cls,r)||(a.cls=s);return s}(t,i,n,e);t=t||cc.js.getClassName(r),r._sealed=!0,i&&(i._sealed=!1);var a=e.properties;"function"==typeof a||i&&null===i.__props__||n&&n.some(function(e){return null===e.__props__})?(Ht.push({cls:r,props:a,mixins:n}),r.__props__=r.__values__=null):ai(r,t,a,i,e.mixins,e.__ES6__);var s,o,l=e.statics;if(l)for(s in l)r[s]=l[s];for(var u in e)if(!(0<=Vt.indexOf(u))){var c=e[u];"function"!=typeof(o=c)&&null!==o||we(r.prototype,u,c,!0,!0)}var h=e.editor;return h&&Ge(i,cc.Component)&&cc.Component._registerEditorProps(r,h),r}si._isCCClass=function(e){return e&&e.hasOwnProperty&&e.hasOwnProperty("__ctors__")},si.fastDefine=function(e,t,i){Xe(e,t);for(var n=t.__props__=t.__values__=Object.keys(i),r=wt(t),a=0;a<n.length;a++){var s=n[a];r[s+Ut+"visible"]=!1,r[s+Ut+"default"]=i[s]}},si.Attr=Bt,si.attr=St,si.getInheritanceChain=function(e){for(var t=[];e=Ve(e);)e!==Object&&t.push(e);return t};var oi={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"},li=[];function ui(e,n,t,i){var r=null,a="";function s(){return a=i+Ut,r=wt(e)}li.length=0;var o=li,l=n.type;if(l){var u=oi[l];if(u)o.push({type:l,_onAfterProp:void 0});else if("Object"===l)0;else if("object"===be(l))vt.isEnum(l)?o.push({type:"Enum",enumList:vt.getList(l)}):pt.isBitMask(l)&&o.push({type:"BitMask",bitmaskList:pt.getList(l)});else if("function"==typeof l){var c;0,o.push({type:"Object",ctor:l,_onAfterProp:c})}else 0}function h(e,t){if(e in n){var i=n[e];be(i)===t&&((r||s())[a+e]=i)}}n.editorOnly&&((r||s())[a+"editorOnly"]=!0),n.url&&((r||s())[a+"saveUrlAsAsset"]=!0),!1===n.serializable&&((r||s())[a+"serializable"]=!1),h("formerlySerializedAs","string");var f=n.range;return f&&Array.isArray(f)&&2<=f.length&&((r||s())[a+"min"]=f[0],(r||s())[a+"max"]=f[1],2<f.length&&((r||s())[a+"step"]=f[2])),h("min","number"),h("max","number"),h("step","number"),o}si.isArray=function(e){return e=Yt(e),Array.isArray(e)},si.getDefault=Yt,si.escapeForJS=Jt,si.IDENTIFIER_RE=$t,si.getNewValueTypeCode=Zt,m4("CCClass",si),cc.Class=si;var ci=Math.PI/180,hi=180/Math.PI,fi=m4("EPSILON",1e-6);function di(e,t){return Math.abs(e-t)<=fi*Math.max(1,Math.abs(e),Math.abs(t))}function _i(e,t,i){return i=i||fi,Math.abs(e-t)<=i}function pi(e,t,i){if(i<t){var n=t;t=i,i=n}return e<t?t:i<e?i:e}function vi(e){return e<0?0:1<e?1:e}function mi(e,t,i){return e+(t-e)*i}function yi(e){return e*ci}function gi(e){return e*hi}var bi=m4("random",Math.random);function xi(e,t){return Math.random()*(t-e)+e}function Si(e,t){return Math.floor(xi(e,t))}function Ti(e){return(e=(9301*e+49297)%233280)/233280}function wi(e,t,i){return Ti(e)*(i-t)+t}function Ei(e,t,i){return Math.floor(wi(e,t,i))}function Ai(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function Ci(e,t){return e-Math.floor(e/t)*t}function ki(e,t){return e=Ci(e,2*t),e=t-Math.abs(e-t)}function Ri(e,t,i){return(i-e)/(t-e)}var Oi=0,Mi=0,Ii=m4("Vec2",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this))).x=void 0,i.y=void 0,e&&"object"===be(e)?(i.x=e.x,i.y=e.y):(i.x=e||0,i.y=t||0),i}return _(n,yt),l(n,null,[{key:"clone",value:function(e){return new n(e.x,e.y)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e}},{key:"set",value:function(e,t,i){return e.x=t,e.y=i,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e}},{key:"distance",value:function(e,t){return Oi=t.x-e.x,Mi=t.y-e.y,Math.sqrt(Oi*Oi+Mi*Mi)}},{key:"squaredDistance",value:function(e,t){return Oi=t.x-e.x,Mi=t.y-e.y,Oi*Oi+Mi*Mi}},{key:"len",value:function(e){return Oi=e.x,Mi=e.y,Math.sqrt(Oi*Oi+Mi*Mi)}},{key:"lengthSqr",value:function(e){return Oi=e.x,Mi=e.y,Oi*Oi+Mi*Mi}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e}},{key:"inverseSafe",value:function(e,t){return Oi=t.x,Mi=t.y,Math.abs(Oi)<fi?e.x=0:e.x=1/Oi,Math.abs(Mi)<fi?e.y=0:e.y=1/Mi,e}},{key:"normalize",value:function(e,t){Oi=t.x,Mi=t.y;var i=Oi*Oi+Mi*Mi;return 0<i&&(i=1/Math.sqrt(i),e.x=Oi*i,e.y=Mi*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"cross",value:function(e,t,i){return e.x=e.y=0,e.z=t.x*i.y-t.y*i.x,e}},{key:"lerp",value:function(e,t,i,n){return Oi=t.x,Mi=t.y,e.x=Oi+n*(i.x-Oi),e.y=Mi+n*(i.y-Mi),e}},{key:"random",value:function(e,t){t=t||1;var i=2*bi()*Math.PI;return e.x=Math.cos(i)*t,e.y=Math.sin(i)*t,e}},{key:"transformMat3",value:function(e,t,i){return Oi=t.x,Mi=t.y,e.x=i.m00*Oi+i.m03*Mi+i.m06,e.y=i.m01*Oi+i.m04*Mi+i.m07,e}},{key:"transformMat4",value:function(e,t,i){return Oi=t.x,Mi=t.y,e.x=i.m00*Oi+i.m04*Mi+i.m12,e.y=i.m01*Oi+i.m05*Mi+i.m13,e}},{key:"str",value:function(e){return"Vec2(".concat(e.x,", ").concat(e.y,")")}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.x,e[n+1]=t.y,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.x=t[n+0],e.y=t[n+1],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:fi;return Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))}},{key:"angle",value:function(e,t){n.normalize(Bi,e),n.normalize(Li,t);var i=n.dot(Bi,Li);return 1<i?0:i<-1?Math.PI:Math.acos(i)}}]),l(n,[{key:"clone",value:function(){return new n(this.x,this.y)}},{key:"set",value:function(e,t){return e&&"object"===be(e)?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:fi;return Math.abs(this.x-e.x)<=i*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=i*Math.max(1,Math.abs(this.y),Math.abs(e.y))}},{key:"equals2f",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:fi;return Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y}},{key:"strictEquals2f",value:function(e,t){return this.x===e&&this.y===t}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),")")}},{key:"lerp",value:function(e,t){return Oi=this.x,Mi=this.y,this.x=Oi+t*(e.x-Oi),this.y=Mi+t*(e.y-Mi),this}},{key:"clampf",value:function(e,t){return this.x=pi(this.x,e.x,t.x),this.y=pi(this.y,e.y,t.y),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this}},{key:"add2f",value:function(e,t){return this.x=this.x+e,this.y=this.y+t,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this}},{key:"subtract2f",value:function(e,t){return this.x=this.x-e,this.y=this.y-t,this}},{key:"multiplyScalar",value:function(e){return"object"===be(e)&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this}},{key:"multiply",value:function(e){return"object"!==be(e)&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this}},{key:"multiply2f",value:function(e,t){return this.x=this.x*e,this.y=this.y*t,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this}},{key:"divide2f",value:function(e,t){return this.x=this.x/e,this.y=this.y/t,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y}},{key:"cross",value:function(e){return this.x*e.y-this.y*e.x}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y}},{key:"normalize",value:function(){Oi=this.x,Mi=this.y;var e=Oi*Oi+Mi*Mi;return 0<e&&(e=1/Math.sqrt(e),this.x=this.x*e,this.y=this.y*e),this}},{key:"angle",value:function(e){var t=this.lengthSqr(),i=e.lengthSqr();if(0===t||0===i)return console.warn("Can't get angle between zero vector"),0;var n=this.dot(e)/Math.sqrt(t*i);return n=pi(n,-1,1),Math.acos(n)}},{key:"signAngle",value:function(e){var t=this.angle(e);return this.cross(e)<0?-t:t}},{key:"rotate",value:function(e){Oi=this.x,Mi=this.y;var t=Math.sin(e),i=Math.cos(e);return this.x=i*Oi-t*Mi,this.y=t*Oi+i*Mi,this}},{key:"project",value:function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this}},{key:"transformMat4",value:function(e){return Oi=this.x,Mi=this.y,this.x=e.m00*Oi+e.m04*Mi+e.m12,this.y=e.m01*Oi+e.m05*Mi+e.m13,this}}]),n}());Ii.ZERO=Object.freeze(new Ii(0,0)),Ii.ONE=Object.freeze(new Ii(1,1)),Ii.NEG_ONE=Object.freeze(new Ii(-1,-1)),Ii.UNIT_X=Object.freeze(new Ii(1,0)),Ii.UNIT_Y=Object.freeze(new Ii(0,1));var Bi=new Ii,Li=new Ii;function Pi(e,t){return new Ii(e,t)}si.fastDefine("cc.Vec2",Ii,{x:0,y:0}),cc.Vec2=Ii,cc.v2=Pi;var Fi=0,zi=0,Di=0,Ni=m4("Vec3",function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this))).x=void 0,n.y=void 0,n.z=void 0,e&&"object"===be(e)?(n.x=e.x,n.y=e.y,n.z=e.z):(n.x=e||0,n.y=t||0,n.z=i||0),n}return _(r,yt),l(r,null,[{key:"zero",value:function(e){return e.x=0,e.y=0,e.z=0,e}},{key:"clone",value:function(e){return new r(e.x,e.y,e.z)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e}},{key:"set",value:function(e,t,i,n){return e.x=t,e.y=i,e.z=n,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e}},{key:"distance",value:function(e,t){return Fi=t.x-e.x,zi=t.y-e.y,Di=t.z-e.z,Math.sqrt(Fi*Fi+zi*zi+Di*Di)}},{key:"squaredDistance",value:function(e,t){return Fi=t.x-e.x,zi=t.y-e.y,Di=t.z-e.z,Fi*Fi+zi*zi+Di*Di}},{key:"len",value:function(e){return Fi=e.x,zi=e.y,Di=e.z,Math.sqrt(Fi*Fi+zi*zi+Di*Di)}},{key:"lengthSqr",value:function(e){return Fi=e.x,zi=e.y,Di=e.z,Fi*Fi+zi*zi+Di*Di}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e}},{key:"invert",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e}},{key:"invertSafe",value:function(e,t){return Fi=t.x,zi=t.y,Di=t.z,Math.abs(Fi)<fi?e.x=0:e.x=1/Fi,Math.abs(zi)<fi?e.y=0:e.y=1/zi,Math.abs(Di)<fi?e.z=0:e.z=1/Di,e}},{key:"normalize",value:function(e,t){Fi=t.x,zi=t.y,Di=t.z;var i=Fi*Fi+zi*zi+Di*Di;return 0<i&&(i=1/Math.sqrt(i),e.x=Fi*i,e.y=zi*i,e.z=Di*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"cross",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=i.x,o=i.y,l=i.z;return e.x=r*l-a*o,e.y=a*s-n*l,e.z=n*o-r*s,e}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e}},{key:"random",value:function(e,t){t=t||1;var i=2*bi()*Math.PI,n=2*bi()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e}},{key:"transformMat4",value:function(e,t,i){Fi=t.x,zi=t.y,Di=t.z;var n=i.m03*Fi+i.m07*zi+i.m11*Di+i.m15;return n=n?1/n:1,e.x=(i.m00*Fi+i.m04*zi+i.m08*Di+i.m12)*n,e.y=(i.m01*Fi+i.m05*zi+i.m09*Di+i.m13)*n,e.z=(i.m02*Fi+i.m06*zi+i.m10*Di+i.m14)*n,e}},{key:"transformMat4Normal",value:function(e,t,i){Fi=t.x,zi=t.y,Di=t.z;var n=i.m03*Fi+i.m07*zi+i.m11*Di;return n=n?1/n:1,e.x=(i.m00*Fi+i.m04*zi+i.m08*Di)*n,e.y=(i.m01*Fi+i.m05*zi+i.m09*Di)*n,e.z=(i.m02*Fi+i.m06*zi+i.m10*Di)*n,e}},{key:"transformMat3",value:function(e,t,i){return Fi=t.x,zi=t.y,Di=t.z,e.x=Fi*i.m00+zi*i.m03+Di*i.m06,e.y=Fi*i.m01+zi*i.m04+Di*i.m07,e.z=Fi*i.m02+zi*i.m05+Di*i.m08,e}},{key:"transformAffine",value:function(e,t,i){return Fi=t.x,zi=t.y,Di=t.z,e.x=i.m00*Fi+i.m01*zi+i.m02*Di+i.m03,e.y=i.m04*Fi+i.m05*zi+i.m06*Di+i.m07,e.x=i.m08*Fi+i.m09*zi+i.m10*Di+i.m11,e}},{key:"transformQuat",value:function(e,t,i){var n=i.w*t.x+i.y*t.z-i.z*t.y,r=i.w*t.y+i.z*t.x-i.x*t.z,a=i.w*t.z+i.x*t.y-i.y*t.x,s=-i.x*t.x-i.y*t.y-i.z*t.z;return e.x=n*i.w+s*-i.x+r*-i.z-a*-i.y,e.y=r*i.w+s*-i.y+a*-i.x-n*-i.z,e.z=a*i.w+s*-i.z+n*-i.y-r*-i.x,e}},{key:"transformRTS",value:function(e,t,i,n,r){var a=t.x*r.x,s=t.y*r.y,o=t.z*r.z,l=i.w*a+i.y*o-i.z*s,u=i.w*s+i.z*a-i.x*o,c=i.w*o+i.x*s-i.y*a,h=-i.x*a-i.y*s-i.z*o;return e.x=l*i.w+h*-i.x+u*-i.z-c*-i.y+n.x,e.y=u*i.w+h*-i.y+c*-i.x-l*-i.z+n.y,e.z=c*i.w+h*-i.z+l*-i.y-u*-i.x+n.z,e}},{key:"transformInverseRTS",value:function(e,t,i,n,r){var a=t.x-n.x,s=t.y-n.y,o=t.z-n.z,l=i.w*a-i.y*o+i.z*s,u=i.w*s-i.z*a+i.x*o,c=i.w*o-i.x*s+i.y*a,h=i.x*a+i.y*s+i.z*o;return e.x=(l*i.w+h*i.x+u*i.z-c*i.y)/r.x,e.y=(u*i.w+h*i.y+c*i.x-l*i.z)/r.y,e.z=(c*i.w+h*i.z+l*i.y-u*i.x)/r.z,e}},{key:"rotateX",value:function(e,t,i,n){Fi=t.x-i.x,zi=t.y-i.y,Di=t.z-i.z;var r=Math.cos(n),a=Math.sin(n),s=Fi,o=zi*r-Di*a,l=zi*a+Di*r;return e.x=s+i.x,e.y=o+i.y,e.z=l+i.z,e}},{key:"rotateY",value:function(e,t,i,n){Fi=t.x-i.x,zi=t.y-i.y,Di=t.z-i.z;var r=Math.cos(n),a=Math.sin(n),s=Di*a+Fi*r,o=zi,l=Di*r-Fi*a;return e.x=s+i.x,e.y=o+i.y,e.z=l+i.z,e}},{key:"rotateZ",value:function(e,t,i,n){Fi=t.x-i.x,zi=t.y-i.y,Di=t.z-i.z;var r=Math.cos(n),a=Math.sin(n),s=Fi*r-zi*a,o=Fi*a+zi*r,l=Di;return e.x=s+i.x,e.y=o+i.y,e.z=l+i.z,e}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:fi,r=e.x,a=e.y,s=e.z,o=t.x,l=t.y,u=t.z;return Math.abs(r-o)<=n*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(a-l)<=n*Math.max(1,Math.abs(a),Math.abs(l))&&Math.abs(s-u)<=n*Math.max(1,Math.abs(s),Math.abs(u))}},{key:"angle",value:function(e,t){r.normalize(Ui,e),r.normalize(Vi,t);var i=r.dot(Ui,Vi);return 1<i?0:i<-1?Math.PI:Math.acos(i)}},{key:"projectOnPlane",value:function(e,t,i){return r.subtract(e,t,r.project(e,t,i))}},{key:"project",value:function(e,t,i){var n=r.lengthSqr(i);return n<1e-6?r.set(e,0,0,0):r.multiplyScalar(e,i,r.dot(t,i)/n)}}]),l(r,[{key:"clone",value:function(){return new r(this.x,this.y,this.z)}},{key:"set",value:function(e,t,i){return e&&"object"===be(e)?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=i||0),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:fi;return Math.abs(this.x-e.x)<=i*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=i*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=i*Math.max(1,Math.abs(this.z),Math.abs(e.z))}},{key:"equals3f",value:function(e,t,i,n){var r=3<arguments.length&&void 0!==n?n:fi;return Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=r*Math.max(1,Math.abs(this.z),Math.abs(i))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}},{key:"strictEquals3f",value:function(e,t,i){return this.x===e&&this.y===t&&this.z===i}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),")")}},{key:"lerp",value:function(e,t){return this.x=this.x+t*(e.x-this.x),this.y=this.y+t*(e.y-this.y),this.z=this.z+t*(e.z-this.z),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this}},{key:"add3f",value:function(e,t,i){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this}},{key:"subtract3f",value:function(e,t,i){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this}},{key:"multiplyScalar",value:function(e){return"object"===be(e)&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this}},{key:"multiply",value:function(e){return"object"!==be(e)&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this}},{key:"multiply3f",value:function(e,t,i){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this}},{key:"divide3f",value:function(e,t,i){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"clampf",value:function(e,t){return this.x=pi(this.x,e.x,t.x),this.y=pi(this.y,e.y,t.y),this.z=pi(this.z,e.z,t.z),this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z}},{key:"cross",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return this.x=i*s-n*a,this.y=n*r-t*s,this.z=t*a-i*r,this}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"normalize",value:function(){Fi=this.x,zi=this.y,Di=this.z;var e=Fi*Fi+zi*zi+Di*Di;return 0<e&&(e=1/Math.sqrt(e),this.x=Fi*e,this.y=zi*e,this.z=Di*e),this}},{key:"transformMat4",value:function(e){Fi=this.x,zi=this.y,Di=this.z;var t=e.m03*Fi+e.m07*zi+e.m11*Di+e.m15;return t=t?1/t:1,this.x=(e.m00*Fi+e.m04*zi+e.m08*Di+e.m12)*t,this.y=(e.m01*Fi+e.m05*zi+e.m09*Di+e.m13)*t,this.z=(e.m02*Fi+e.m06*zi+e.m10*Di+e.m14)*t,this}}]),r}());Ni.UNIT_X=Object.freeze(new Ni(1,0,0)),Ni.UNIT_Y=Object.freeze(new Ni(0,1,0)),Ni.UNIT_Z=Object.freeze(new Ni(0,0,1)),Ni.ZERO=Object.freeze(new Ni(0,0,0)),Ni.ONE=Object.freeze(new Ni(1,1,1)),Ni.NEG_ONE=Object.freeze(new Ni(-1,-1,-1));var Ui=new Ni,Vi=new Ni;function Gi(e,t,i){return new Ni(e,t,i)}si.fastDefine("cc.Vec3",Ni,{x:0,y:0,z:0}),cc.Vec3=Ni,cc.v3=Gi;var Hi=0,Wi=0,qi=0,ji=0,Xi=m4("Vec4",function(){function a(e,t,i,n){var r;return y(this,a),(r=x(this,g(a).call(this))).x=void 0,r.y=void 0,r.z=void 0,r.w=void 0,e&&"object"===be(e)?(r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w):(r.x=e||0,r.y=t||0,r.z=i||0,r.w=n||0),r}return _(a,yt),l(a,null,[{key:"clone",value:function(e){return new a(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e.w=t.w+i.w,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e.w=t.w-i.w,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e.w=t.w*i.w,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e.w=t.w/i.w,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e.w=Math.min(t.w,i.w),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e.w=Math.max(t.w,i.w),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return Math.sqrt(i*i+n*n+r*r+a*a)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return i*i+n*n+r*r+a*a}},{key:"len",value:function(e){return Hi=e.x,Wi=e.y,qi=e.z,ji=e.w,Math.sqrt(Hi*Hi+Wi*Wi+qi*qi+ji*ji)}},{key:"lengthSqr",value:function(e){return Hi=e.x,Wi=e.y,qi=e.z,ji=e.w,Hi*Hi+Wi*Wi+qi*qi+ji*ji}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e}},{key:"inverseSafe",value:function(e,t){return Hi=t.x,Wi=t.y,qi=t.z,ji=t.w,Math.abs(Hi)<fi?e.x=0:e.x=1/Hi,Math.abs(Wi)<fi?e.y=0:e.y=1/Wi,Math.abs(qi)<fi?e.z=0:e.z=1/qi,Math.abs(ji)<fi?e.w=0:e.w=1/ji,e}},{key:"normalize",value:function(e,t){Hi=t.x,Wi=t.y,qi=t.z,ji=t.w;var i=Hi*Hi+Wi*Wi+qi*qi+ji*ji;return 0<i&&(i=1/Math.sqrt(i),e.x=Hi*i,e.y=Wi*i,e.z=qi*i,e.w=ji*i),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}},{key:"random",value:function(e,t){t=t||1;var i=2*bi()*Math.PI,n=2*bi()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e.w=0,e}},{key:"transformMat4",value:function(e,t,i){return Hi=t.x,Wi=t.y,qi=t.z,ji=t.w,e.x=i.m00*Hi+i.m04*Wi+i.m08*qi+i.m12*ji,e.y=i.m01*Hi+i.m05*Wi+i.m09*qi+i.m13*ji,e.z=i.m02*Hi+i.m06*Wi+i.m10*qi+i.m14*ji,e.w=i.m03*Hi+i.m07*Wi+i.m11*qi+i.m15*ji,e}},{key:"transformAffine",value:function(e,t,i){return Hi=t.x,Wi=t.y,qi=t.z,ji=t.w,e.x=i.m00*Hi+i.m01*Wi+i.m02*qi+i.m03*ji,e.y=i.m04*Hi+i.m05*Wi+i.m06*qi+i.m07*ji,e.x=i.m08*Hi+i.m09*Wi+i.m10*qi+i.m11*ji,e.w=t.w,e}},{key:"transformQuat",value:function(e,t,i){var n=t.x,r=t.y,a=t.z;Hi=i.x,Wi=i.y,qi=i.z;var s=(ji=i.w)*n+Wi*a-qi*r,o=ji*r+qi*n-Hi*a,l=ji*a+Hi*r-Wi*n,u=-Hi*n-Wi*r-qi*a;return e.x=s*ji+u*-Hi+o*-qi-l*-Wi,e.y=o*ji+u*-Wi+l*-Hi-s*-qi,e.z=l*ji+u*-qi+s*-Wi-o*-Hi,e.w=t.w,e}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:fi;return Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),l(a,[{key:"clone",value:function(){return new a(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,t,i,n){return e&&"object"===be(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=n||0),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:fi;return Math.abs(this.x-e.x)<=i*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=i*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=i*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=i*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"equals4f",value:function(e,t,i,n,r){var a=4<arguments.length&&void 0!==r?r:fi;return Math.abs(this.x-e)<=a*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=a*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=a*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-n)<=a*Math.max(1,Math.abs(this.w),Math.abs(n))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"strictEquals4f",value:function(e,t,i,n){return this.x===e&&this.y===t&&this.z===i&&this.w===n}},{key:"lerp",value:function(e,t){return Hi=this.x,Wi=this.y,qi=this.z,ji=this.w,this.x=Hi+t*(e.x-Hi),this.y=Wi+t*(e.y-Wi),this.z=qi+t*(e.z-qi),this.w=ji+t*(e.w-ji),this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),", ").concat(this.w.toFixed(2),")")}},{key:"clampf",value:function(e,t){return this.x=pi(this.x,e.x,t.x),this.y=pi(this.y,e.y,t.y),this.z=pi(this.z,e.z,t.z),this.w=pi(this.w,e.w,t.w),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this.w=this.w+e.w,this}},{key:"add4f",value:function(e,t,i,n){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this.w=this.w+n,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this.w=this.w-e.w,this}},{key:"subtract4f",value:function(e,t,i,n){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this.w=this.w-n,this}},{key:"multiplyScalar",value:function(e){return"object"===be(e)&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e,this}},{key:"multiply",value:function(e){return"object"!==be(e)&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this.w=this.w*e.w,this}},{key:"multiply4f",value:function(e,t,i,n){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this.w=this.w*n,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this.w=this.w/e.w,this}},{key:"divide4f",value:function(e,t,i,n){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this.w=this.w/n,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}},{key:"cross",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return this.x=i*s-n*a,this.y=n*r-t*s,this.z=t*a-i*r,this}},{key:"length",value:function(){return Hi=this.x,Wi=this.y,qi=this.z,ji=this.w,Math.sqrt(Hi*Hi+Wi*Wi+qi*qi+ji*ji)}},{key:"lengthSqr",value:function(){return Hi=this.x,Wi=this.y,qi=this.z,ji=this.w,Hi*Hi+Wi*Wi+qi*qi+ji*ji}},{key:"normalize",value:function(){Hi=this.x,Wi=this.y,qi=this.z,ji=this.w;var e=Hi*Hi+Wi*Wi+qi*qi+ji*ji;return 0<e&&(e=1/Math.sqrt(e),this.x=Hi*e,this.y=Wi*e,this.z=qi*e,this.w=ji*e),this}},{key:"transformMat4",value:function(e){return Hi=this.x,Wi=this.y,qi=this.z,ji=this.w,this.x=e.m00*Hi+e.m04*Wi+e.m08*qi+e.m12*ji,this.y=e.m01*Hi+e.m05*Wi+e.m09*qi+e.m13*ji,this.z=e.m02*Hi+e.m06*Wi+e.m10*qi+e.m14*ji,this.w=e.m03*Hi+e.m07*Wi+e.m11*qi+e.m15*ji,this}}]),a}());function Yi(e,t,i,n){return new Xi(e,t,i,n)}Xi.ZERO=Object.freeze(new Xi(0,0,0,0)),Xi.ONE=Object.freeze(new Xi(1,1,1,1)),Xi.NEG_ONE=Object.freeze(new Xi(-1,-1,-1,-1)),si.fastDefine("cc.Vec4",Xi,{x:0,y:0,z:0,w:0}),cc.Vec4=Xi,cc.v4=Yi;var Ki=0,Qi=0,Zi=0,Ji=0,$i=0,en=0,tn=0,nn=0,rn=0,an=m4("Mat3",function(){function c(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,o=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,l=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,u=8<arguments.length&&void 0!==arguments[8]?arguments[8]:1;return y(this,c),(e=x(this,g(c).call(this))).m00=void 0,e.m01=void 0,e.m02=void 0,e.m03=void 0,e.m04=void 0,e.m05=void 0,e.m06=void 0,e.m07=void 0,e.m08=void 0,"object"===be(t)?(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08):(e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=u),e}return _(c,yt),l(c,null,[{key:"clone",value:function(e){return new c(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,u){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=u,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"transpose",value:function(e,t){return e===t?(Qi=t.m01,Zi=t.m02,en=t.m05,e.m01=t.m03,e.m02=t.m06,e.m03=Qi,e.m05=t.m07,e.m06=Zi,e.m07=en):(e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08),e}},{key:"invert",value:function(e,t){Ki=t.m00,Qi=t.m01,Zi=t.m02,Ji=t.m03,$i=t.m04,en=t.m05,tn=t.m06,nn=t.m07;var i=(rn=t.m08)*$i-en*nn,n=-rn*Ji+en*tn,r=nn*Ji-$i*tn,a=Ki*i+Qi*n+Zi*r;return a&&(a=1/a,e.m00=i*a,e.m01=(-rn*Qi+Zi*nn)*a,e.m02=(en*Qi-Zi*$i)*a,e.m03=n*a,e.m04=(rn*Ki-Zi*tn)*a,e.m05=(-en*Ki+Zi*Ji)*a,e.m06=r*a,e.m07=(-nn*Ki+Qi*tn)*a,e.m08=($i*Ki-Qi*Ji)*a),e}},{key:"determinant",value:function(e){return Ki=e.m00,Qi=e.m01,Zi=e.m02,Ji=e.m03,$i=e.m04,en=e.m05,tn=e.m06,nn=e.m07,rn=e.m08,Ki*(rn*$i-en*nn)+Qi*(-rn*Ji+en*tn)+Zi*(nn*Ji-$i*tn)}},{key:"multiply",value:function(e,t,i){Ki=t.m00,Qi=t.m01,Zi=t.m02,Ji=t.m03,$i=t.m04,en=t.m05,tn=t.m06,nn=t.m07,rn=t.m08;var n=i.m00,r=i.m01,a=i.m02,s=i.m03,o=i.m04,l=i.m05,u=i.m06,c=i.m07,h=i.m08;return e.m00=n*Ki+r*Ji+a*tn,e.m01=n*Qi+r*$i+a*nn,e.m02=n*Zi+r*en+a*rn,e.m03=s*Ki+o*Ji+l*tn,e.m04=s*Qi+o*$i+l*nn,e.m05=s*Zi+o*en+l*rn,e.m06=u*Ki+c*Ji+h*tn,e.m07=u*Qi+c*$i+h*nn,e.m08=u*Zi+c*en+h*rn,e}},{key:"multiplyMat4",value:function(e,t,i){Ki=t.m00,Qi=t.m01,Zi=t.m02,Ji=t.m03,$i=t.m04,en=t.m05,tn=t.m06,nn=t.m07,rn=t.m08;var n=i.m00,r=i.m01,a=i.m02,s=i.m04,o=i.m05,l=i.m06,u=i.m08,c=i.m09,h=i.m10;return e.m00=n*Ki+r*Ji+a*tn,e.m01=n*Qi+r*$i+a*nn,e.m02=n*Zi+r*en+a*rn,e.m03=s*Ki+o*Ji+l*tn,e.m04=s*Qi+o*$i+l*nn,e.m05=s*Zi+o*en+l*rn,e.m06=u*Ki+c*Ji+h*tn,e.m07=u*Qi+c*$i+h*nn,e.m08=u*Zi+c*en+h*rn,e}},{key:"transfrom",value:function(e,t,i){Ki=t.m00,Qi=t.m01,Zi=t.m02,Ji=t.m03,$i=t.m04,en=t.m05,tn=t.m06,nn=t.m07,rn=t.m08;var n=i.x,r=i.y;return e.m00=Ki,e.m01=Qi,e.m02=Zi,e.m03=Ji,e.m04=$i,e.m05=en,e.m06=n*Ki+r*Ji+tn,e.m07=n*Qi+r*$i+nn,e.m08=n*Zi+r*en+rn,e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y;return e.m00=n*t.m00,e.m01=n*t.m01,e.m02=n*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"rotate",value:function(e,t,i){Ki=t.m00,Qi=t.m01,Zi=t.m02,Ji=t.m03,$i=t.m04,en=t.m05,tn=t.m06,nn=t.m07,rn=t.m08;var n=Math.sin(i),r=Math.cos(i);return e.m00=r*Ki+n*Ji,e.m01=r*Qi+n*$i,e.m02=r*Zi+n*en,e.m03=r*Ji-n*Ki,e.m04=r*$i-n*Qi,e.m05=r*en-n*Zi,e.m06=tn,e.m07=nn,e.m08=rn,e}},{key:"fromMat4",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e}},{key:"fromViewUp",value:function(e,t,i){return Ni.lengthSqr(t)<fi*fi?(c.identity(e),e):(i=i||Ni.UNIT_Y,Ni.normalize(sn,Ni.cross(sn,i,t)),Ni.lengthSqr(sn)<fi*fi?c.identity(e):(Ni.cross(on,t,sn),c.set(e,sn.x,sn.y,sn.z,on.x,on.y,on.z,t.x,t.y,t.z)),e)}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=-i,e.m04=n,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,s=i+i,o=n+n,l=r+r,u=i*s,c=n*s,h=n*o,f=r*s,d=r*o,_=r*l,p=a*s,v=a*o,m=a*l;return e.m00=1-h-_,e.m03=c-m,e.m06=f+v,e.m01=c+m,e.m04=1-u-_,e.m07=d-p,e.m02=f-v,e.m05=d+p,e.m08=1-u-h,e}},{key:"inverseTransposeMat4",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,s=t.m04,o=t.m05,l=t.m06,u=t.m07,c=t.m08,h=t.m09,f=t.m10,d=t.m11,_=t.m12,p=t.m13,v=t.m14,m=t.m15,y=i*o-n*s,g=i*l-r*s,b=i*u-a*s,x=n*l-r*o,S=n*u-a*o,T=r*u-a*l,w=c*p-h*_,E=c*v-f*_,A=c*m-d*_,C=h*v-f*p,k=h*m-d*p,R=f*m-d*v,O=y*R-g*k+b*C+x*A-S*E+T*w;return O?(O=1/O,e.m00=(o*R-l*k+u*C)*O,e.m01=(l*A-s*R-u*E)*O,e.m02=(s*k-o*A+u*w)*O,e.m03=(r*k-n*R-a*C)*O,e.m04=(i*R-r*A+a*E)*O,e.m05=(n*A-i*k-a*w)*O,e.m06=(p*T-v*S+m*x)*O,e.m07=(v*b-_*T-m*g)*O,e.m08=(_*S-p*b+m*y)*O,e):null}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=i.m00*n+t.m00,e.m01=i.m01*n+t.m01,e.m02=i.m02*n+t.m02,e.m03=i.m03*n+t.m03,e.m04=i.m04*n+t.m04,e.m05=i.m05*n+t.m05,e.m06=i.m06*n+t.m06,e.m07=i.m07*n+t.m07,e.m08=i.m08*n+t.m08,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:fi;return Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))}}]),l(c,[{key:"clone",value:function(){return new c(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08)}},{key:"set",value:function(e,t,i,n,r,a,s,o,l){var u=0<arguments.length&&void 0!==e?e:1,c=1<arguments.length&&void 0!==t?t:0,h=2<arguments.length&&void 0!==i?i:0,f=3<arguments.length&&void 0!==n?n:0,d=4<arguments.length&&void 0!==r?r:1,_=5<arguments.length&&void 0!==a?a:0,p=6<arguments.length&&void 0!==s?s:0,v=7<arguments.length&&void 0!==o?o:0,m=8<arguments.length&&void 0!==l?l:1;return"object"===be(u)?(this.m00=u.m00,this.m01=u.m01,this.m02=u.m02,this.m03=u.m03,this.m04=u.m04,this.m05=u.m05,this.m06=u.m06,this.m07=u.m07,this.m08=u.m08):(this.m00=u,this.m01=c,this.m02=h,this.m03=f,this.m04=d,this.m05=_,this.m06=p,this.m07=v,this.m08=m),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:fi;return Math.abs(this.m00-e.m00)<=i*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=i*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=i*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=i*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=i*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=i*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=i*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=i*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=i*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08}},{key:"toString",value:function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+",\n"+this.m03+",\n"+this.m04+", "+this.m05+",\n"+this.m06+", "+this.m07+",\n"+this.m08+"\n]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=i,this}},{key:"invert",value:function(){Ki=this.m00,Qi=this.m01,Zi=this.m02,Ji=this.m03,$i=this.m04,en=this.m05,tn=this.m06,nn=this.m07;var e=(rn=this.m08)*$i-en*nn,t=-rn*Ji+en*tn,i=nn*Ji-$i*tn,n=Ki*e+Qi*t+Zi*i;return n?(n=1/n,this.m00=e*n,this.m01=(-rn*Qi+Zi*nn)*n,this.m02=(en*Qi-Zi*$i)*n,this.m03=t*n,this.m04=(rn*Ki-Zi*tn)*n,this.m05=(-en*Ki+Zi*Ji)*n,this.m06=i*n,this.m07=(-nn*Ki+Qi*tn)*n,this.m08=($i*Ki-Qi*Ji)*n,this):null}},{key:"determinant",value:function(){return Ki=this.m00,Qi=this.m01,Zi=this.m02,Ji=this.m03,$i=this.m04,en=this.m05,tn=this.m06,nn=this.m07,rn=this.m08,Ki*(rn*$i-en*nn)+Qi*(-rn*Ji+en*tn)+Zi*(nn*Ji-$i*tn)}},{key:"add",value:function(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this}},{key:"subtract",value:function(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this}},{key:"multiply",value:function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,a=this.m04,s=this.m05,o=this.m06,l=this.m07,u=this.m08,c=e.m00,h=e.m01,f=e.m02,d=e.m03,_=e.m04,p=e.m05,v=e.m06,m=e.m07,y=e.m08;return this.m00=c*t+h*r+f*o,this.m01=c*i+h*a+f*l,this.m02=c*n+h*s+f*u,this.m03=d*t+_*r+p*o,this.m04=d*i+_*a+p*l,this.m05=d*n+_*s+p*u,this.m06=v*t+m*r+y*o,this.m07=v*i+m*a+y*l,this.m08=v*n+m*s+y*u,this}},{key:"multiplyScalar",value:function(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this}},{key:"scale",value:function(e){var t=e.x,i=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=i*this.m03,this.m04=i*this.m04,this.m05=i*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this}},{key:"rotate",value:function(e){Ki=this.m00,Qi=this.m01,Zi=this.m02,Ji=this.m03,$i=this.m04,en=this.m05,tn=this.m06,nn=this.m07,rn=this.m08;var t=Math.sin(e),i=Math.cos(e);return this.m00=i*Ki+t*Ji,this.m01=i*Qi+t*$i,this.m02=i*Zi+t*en,this.m03=i*Ji-t*Ki,this.m04=i*$i-t*Qi,this.m05=i*en-t*Zi,this.m06=tn,this.m07=nn,this.m08=rn,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,s=i+i,o=n+n,l=t*a,u=i*a,c=i*s,h=n*a,f=n*s,d=n*o,_=r*a,p=r*s,v=r*o;return this.m00=1-c-d,this.m03=u-v,this.m06=h+p,this.m01=u+v,this.m04=1-l-d,this.m07=f-_,this.m02=h-p,this.m05=f+_,this.m08=1-l-c,this}}]),c}());an.IDENTITY=Object.freeze(new an);var sn=new Ni,on=new Ni;si.fastDefine("cc.Mat3",an,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),cc.Mat3=an;var ln=0,un=0,cn=0,hn=0,fn=m4("Quat",function(){function s(e,t,i,n){var r;return y(this,s),(r=x(this,g(s).call(this))).x=void 0,r.y=void 0,r.z=void 0,r.w=void 0,e&&"object"===be(e)?(r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w):(r.x=e||0,r.y=t||0,r.z=i||0,r.w=n||1),r}return _(s,yt),l(s,null,[{key:"clone",value:function(e){return new s(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"identity",value:function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e}},{key:"rotationTo",value:function(e,t,i){var n=Ni.dot(t,i);return n<-.999999?(Ni.cross(pn,Ni.UNIT_X,t),pn.length()<1e-6&&Ni.cross(pn,Ni.UNIT_Y,t),Ni.normalize(pn,pn),s.fromAxisAngle(e,pn,Math.PI),e):.999999<n?(e.x=0,e.y=0,e.z=0,e.w=1,e):(Ni.cross(pn,t,i),e.x=pn.x,e.y=pn.y,e.z=pn.z,e.w=1+n,s.normalize(e,e))}},{key:"getAxisAngle",value:function(e,t){var i=2*Math.acos(t.w),n=Math.sin(i/2);return 0!==n?(e.x=t.x/n,e.y=t.y/n,e.z=t.z/n):(e.x=1,e.y=0,e.z=0),i}},{key:"multiply",value:function(e,t,i){return ln=t.x*i.w+t.w*i.x+t.y*i.z-t.z*i.y,un=t.y*i.w+t.w*i.y+t.z*i.x-t.x*i.z,cn=t.z*i.w+t.w*i.z+t.x*i.y-t.y*i.x,hn=t.w*i.w-t.x*i.x-t.y*i.y-t.z*i.z,e.x=ln,e.y=un,e.z=cn,e.w=hn,e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"rotateX",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i);return e.x=t.x*r+t.w*n,e.y=t.y*r+t.z*n,e.z=t.z*r-t.y*n,e.w=t.w*r-t.x*n,e}},{key:"rotateY",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i);return e.x=t.x*r-t.z*n,e.y=t.y*r+t.w*n,e.z=t.z*r+t.x*n,e.w=t.w*r-t.y*n,e}},{key:"rotateZ",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i);return e.x=t.x*r+t.y*n,e.y=t.y*r-t.x*n,e.z=t.z*r+t.w*n,e.w=t.w*r-t.z*n,e}},{key:"rotateAround",value:function(e,t,i,n){return s.invert(dn,t),Ni.transformQuat(pn,i,dn),s.fromAxisAngle(dn,pn,n),s.multiply(e,t,dn),e}},{key:"rotateAroundLocal",value:function(e,t,i,n){return s.fromAxisAngle(dn,i,n),s.multiply(e,t,dn),e}},{key:"calculateW",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}},{key:"slerp",value:function(e,t,i,n){var r=0,a=0,s=t.x*i.x+t.y*i.y+t.z*i.z+t.w*i.w;if(s<0&&(s=-s,i.x=-i.x,i.y=-i.y,i.z=-i.z,i.w=-i.w),1e-6<1-s){var o=Math.acos(s),l=Math.sin(o);r=Math.sin((1-n)*o)/l,a=Math.sin(n*o)/l}else r=1-n,a=n;return e.x=r*t.x+a*i.x,e.y=r*t.y+a*i.y,e.z=r*t.z+a*i.z,e.w=r*t.w+a*i.w,e}},{key:"sqlerp",value:function(e,t,i,n,r,a){return s.slerp(dn,t,r,a),s.slerp(_n,i,n,a),s.slerp(e,dn,_n,2*a*(1-a)),e}},{key:"invert",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,n=i?1/i:0;return e.x=-t.x*n,e.y=-t.y*n,e.z=-t.z*n,e.w=t.w*n,e}},{key:"conjugate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e}},{key:"len",value:function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)}},{key:"lengthSqr",value:function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w}},{key:"normalize",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return 0<i&&(i=1/Math.sqrt(i),e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i),e}},{key:"fromAxes",value:function(e,t,i,n){return an.set(vn,t.x,t.y,t.z,i.x,i.y,i.z,n.x,n.y,n.z),s.normalize(e,s.fromMat3(e,vn))}},{key:"fromViewUp",value:function(e,t,i){return an.fromViewUp(vn,t,i),s.normalize(e,s.fromMat3(e,vn))}},{key:"fromAxisAngle",value:function(e,t,i){i*=.5;var n=Math.sin(i);return e.x=n*t.x,e.y=n*t.y,e.z=n*t.z,e.w=Math.cos(i),e}},{key:"fromMat3",value:function(e,t){var i=t.m00,n=t.m03,r=t.m06,a=t.m01,s=t.m04,o=t.m07,l=t.m02,u=t.m05,c=t.m08,h=i+s+c;if(0<h){var f=.5/Math.sqrt(h+1);e.w=.25/f,e.x=(u-o)*f,e.y=(r-l)*f,e.z=(a-n)*f}else if(s<i&&c<i){var d=2*Math.sqrt(1+i-s-c);e.w=(u-o)/d,e.x=.25*d,e.y=(n+a)/d,e.z=(r+l)/d}else if(c<s){var _=2*Math.sqrt(1+s-i-c);e.w=(r-l)/_,e.x=(n+a)/_,e.y=.25*_,e.z=(o+u)/_}else{var p=2*Math.sqrt(1+c-i-s);e.w=(a-n)/p,e.x=(r+l)/p,e.y=(o+u)/p,e.z=.25*p}return e}},{key:"fromEuler",value:function(e,t,i,n){t*=mn,i*=mn,n*=mn;var r=Math.sin(t),a=Math.cos(t),s=Math.sin(i),o=Math.cos(i),l=Math.sin(n),u=Math.cos(n);return e.x=r*o*u+a*s*l,e.y=a*s*u+r*o*l,e.z=a*o*l-r*s*u,e.w=a*o*u-r*s*l,e}},{key:"toAxisX",value:function(e,t){var i=2*t.y,n=2*t.z;return e.x=1-i*t.y-n*t.z,e.y=i*t.x+n*t.w,e.z=n*t.x+i*t.w,e}},{key:"toAxisY",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=n*t.x-r*t.w,e.y=1-i*t.x-r*t.z,e.z=r*t.y+i*t.w,e}},{key:"toAxisZ",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=r*t.x-n*t.w,e.y=r*t.y-i*t.w,e.z=1-i*t.x-n*t.y,e}},{key:"toEuler",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=t.w,o=0,l=0,u=0,c=n*r+a*s;if(.499999<c)o=0,l=gi(2*Math.atan2(n,s)),u=90;else if(c<-.499999)o=0,l=-gi(2*Math.atan2(n,s)),u=-90;else{var h=n*n,f=r*r,d=a*a;o=gi(Math.atan2(2*n*s-2*r*a,1-2*h-2*d)),l=gi(Math.atan2(2*r*s-2*n*a,1-2*f-2*d)),u=gi(Math.asin(2*c)),i&&(o=-180*Math.sign(o+1e-6)+o,l=-180*Math.sign(l+1e-6)+l,u=180*Math.sign(u+1e-6)-u)}return e.x=o,e.y=l,e.z=u,e}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:fi;return Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),l(s,[{key:"clone",value:function(){return new s(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,t,i,n){return e&&"object"===be(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=n||1),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:fi;return Math.abs(this.x-e.x)<=i*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=i*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=i*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=i*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"getEulerAngles",value:function(e){return s.toEuler(e,this)}},{key:"lerp",value:function(e,t){var i=0,n=0,r=this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w;if(r<0&&(r=-r,e.x=-e.x,e.y=-e.y,e.z=-e.z,e.w=-e.w),1e-6<1-r){var a=Math.acos(r),s=Math.sin(a);i=Math.sin((1-t)*a)/s,n=Math.sin(t*a)/s}else i=1-t,n=t;return this.x=i*this.x+n*e.x,this.y=i*this.y+n*e.y,this.z=i*this.z+n*e.z,this.w=i*this.w+n*e.w,this}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}}]),s}());fn.IDENTITY=Object.freeze(new fn);var dn=new fn,_n=new fn,pn=new Ni,vn=new an,mn=.5*Math.PI/180;function yn(){return new fn(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,3<arguments.length&&void 0!==arguments[3]?arguments[3]:1)}si.fastDefine("cc.Quat",fn,{x:0,y:0,z:0,w:1}),cc.Quat=fn,cc.quat=yn;var gn=0,bn=0,xn=0,Sn=0,Tn=0,wn=0,En=0,An=0,Cn=0,kn=0,Rn=0,On=0,Mn=0,In=0,Bn=0,Ln=0,Pn=m4("Mat4",function(){function m(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,o=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,l=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,u=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0,c=9<arguments.length&&void 0!==arguments[9]?arguments[9]:0,h=10<arguments.length&&void 0!==arguments[10]?arguments[10]:1,f=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,d=12<arguments.length&&void 0!==arguments[12]?arguments[12]:0,_=13<arguments.length&&void 0!==arguments[13]?arguments[13]:0,p=14<arguments.length&&void 0!==arguments[14]?arguments[14]:0,v=15<arguments.length&&void 0!==arguments[15]?arguments[15]:1;return y(this,m),(e=x(this,g(m).call(this))).m00=void 0,e.m01=void 0,e.m02=void 0,e.m03=void 0,e.m04=void 0,e.m05=void 0,e.m06=void 0,e.m07=void 0,e.m08=void 0,e.m09=void 0,e.m10=void 0,e.m11=void 0,e.m12=void 0,e.m13=void 0,e.m14=void 0,e.m15=void 0,"object"===be(t)?(e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e.m00=t.m00):(e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=u,e.m09=c,e.m10=h,e.m11=f,e.m12=d,e.m13=_,e.m14=p,e.m15=v,e.m00=t),e}return _(m,yt),l(m,null,[{key:"clone",value:function(e){return new m(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,u,c,h,f,d,_,p,v){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=u,e.m09=c,e.m10=h,e.m11=f,e.m12=d,e.m13=_,e.m14=p,e.m15=v,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"transpose",value:function(e,t){if(e===t){var i=t.m01,n=t.m02,r=t.m03,a=t.m06,s=t.m07,o=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=i,e.m06=t.m09,e.m07=t.m13,e.m08=n,e.m09=a,e.m11=t.m14,e.m12=r,e.m13=s,e.m14=o}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e}},{key:"invert",value:function(e,t){gn=t.m00,bn=t.m01,xn=t.m02,Sn=t.m03,Tn=t.m04,wn=t.m05,En=t.m06,An=t.m07,Cn=t.m08,kn=t.m09,Rn=t.m10,On=t.m11,Mn=t.m12,In=t.m13,Bn=t.m14,Ln=t.m15;var i=gn*wn-bn*Tn,n=gn*En-xn*Tn,r=gn*An-Sn*Tn,a=bn*En-xn*wn,s=bn*An-Sn*wn,o=xn*An-Sn*En,l=Cn*In-kn*Mn,u=Cn*Bn-Rn*Mn,c=Cn*Ln-On*Mn,h=kn*Bn-Rn*In,f=kn*Ln-On*In,d=Rn*Ln-On*Bn,_=i*d-n*f+r*h+a*c-s*u+o*l;return 0===_||(_=1/_,e.m00=(wn*d-En*f+An*h)*_,e.m01=(xn*f-bn*d-Sn*h)*_,e.m02=(In*o-Bn*s+Ln*a)*_,e.m03=(Rn*s-kn*o-On*a)*_,e.m04=(En*c-Tn*d-An*u)*_,e.m05=(gn*d-xn*c+Sn*u)*_,e.m06=(Bn*r-Mn*o-Ln*n)*_,e.m07=(Cn*o-Rn*r+On*n)*_,e.m08=(Tn*f-wn*c+An*l)*_,e.m09=(bn*c-gn*f-Sn*l)*_,e.m10=(Mn*s-In*r+Ln*i)*_,e.m11=(kn*r-Cn*s-On*i)*_,e.m12=(wn*u-Tn*h-En*l)*_,e.m13=(gn*h-bn*u+xn*l)*_,e.m14=(In*n-Mn*a-Bn*i)*_,e.m15=(Cn*a-kn*n+Rn*i)*_),e}},{key:"determinant",value:function(e){return gn=e.m00,bn=e.m01,xn=e.m02,Sn=e.m03,Tn=e.m04,wn=e.m05,En=e.m06,An=e.m07,Cn=e.m08,kn=e.m09,Rn=e.m10,On=e.m11,Mn=e.m12,In=e.m13,Bn=e.m14,Ln=e.m15,(gn*wn-bn*Tn)*(Rn*Ln-On*Bn)-(gn*En-xn*Tn)*(kn*Ln-On*In)+(gn*An-Sn*Tn)*(kn*Bn-Rn*In)+(bn*En-xn*wn)*(Cn*Ln-On*Mn)-(bn*An-Sn*wn)*(Cn*Bn-Rn*Mn)+(xn*An-Sn*En)*(Cn*In-kn*Mn)}},{key:"multiply",value:function(e,t,i){gn=t.m00,bn=t.m01,xn=t.m02,Sn=t.m03,Tn=t.m04,wn=t.m05,En=t.m06,An=t.m07,Cn=t.m08,kn=t.m09,Rn=t.m10,On=t.m11,Mn=t.m12,In=t.m13,Bn=t.m14,Ln=t.m15;var n=i.m00,r=i.m01,a=i.m02,s=i.m03;return e.m00=n*gn+r*Tn+a*Cn+s*Mn,e.m01=n*bn+r*wn+a*kn+s*In,e.m02=n*xn+r*En+a*Rn+s*Bn,e.m03=n*Sn+r*An+a*On+s*Ln,n=i.m04,r=i.m05,a=i.m06,s=i.m07,e.m04=n*gn+r*Tn+a*Cn+s*Mn,e.m05=n*bn+r*wn+a*kn+s*In,e.m06=n*xn+r*En+a*Rn+s*Bn,e.m07=n*Sn+r*An+a*On+s*Ln,n=i.m08,r=i.m09,a=i.m10,s=i.m11,e.m08=n*gn+r*Tn+a*Cn+s*Mn,e.m09=n*bn+r*wn+a*kn+s*In,e.m10=n*xn+r*En+a*Rn+s*Bn,e.m11=n*Sn+r*An+a*On+s*Ln,n=i.m12,r=i.m13,a=i.m14,s=i.m15,e.m12=n*gn+r*Tn+a*Cn+s*Mn,e.m13=n*bn+r*wn+a*kn+s*In,e.m14=n*xn+r*En+a*Rn+s*Bn,e.m15=n*Sn+r*An+a*On+s*Ln,e}},{key:"transform",value:function(e,t,i){var n=i.x,r=i.y,a=i.z;return t===e?(e.m12=t.m00*n+t.m04*r+t.m08*a+t.m12,e.m13=t.m01*n+t.m05*r+t.m09*a+t.m13,e.m14=t.m02*n+t.m06*r+t.m10*a+t.m14,e.m15=t.m03*n+t.m07*r+t.m11*a+t.m15):(gn=t.m00,bn=t.m01,xn=t.m02,Sn=t.m03,Tn=t.m04,wn=t.m05,En=t.m06,An=t.m07,Cn=t.m08,kn=t.m09,Rn=t.m10,On=t.m11,Mn=t.m12,In=t.m13,Bn=t.m14,Ln=t.m15,e.m00=gn,e.m01=bn,e.m02=xn,e.m03=Sn,e.m04=Tn,e.m05=wn,e.m06=En,e.m07=An,e.m08=Cn,e.m09=kn,e.m10=Rn,e.m11=On,e.m12=gn*n+Tn*r+Cn*a+t.m12,e.m13=bn*n+wn*r+kn*a+t.m13,e.m14=xn*n+En*r+Rn*a+t.m14,e.m15=Sn*n+An*r+On*a+t.m15),e}},{key:"translate",value:function(e,t,i){return console.warn("function changed"),t===e?(e.m12+=i.x,e.m13+=i.y,e.m14+=i.y):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=i.x,e.m13+=i.y,e.m14+=i.z,e.m15=t.m15),e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y,a=i.z;return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*a,e.m09=t.m09*a,e.m10=t.m10*a,e.m11=t.m11*a,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"rotate",value:function(e,t,i,n){var r=n.x,a=n.y,s=n.z,o=Math.sqrt(r*r+a*a+s*s);if(Math.abs(o)<fi)return null;r*=o=1/o,a*=o,s*=o;var l=Math.sin(i),u=Math.cos(i),c=1-u;gn=t.m00,bn=t.m01,xn=t.m02,Sn=t.m03,Tn=t.m04,wn=t.m05,En=t.m06,An=t.m07,Cn=t.m08,kn=t.m09,Rn=t.m10,On=t.m11;var h=r*r*c+u,f=a*r*c+s*l,d=s*r*c-a*l,_=r*a*c-s*l,p=a*a*c+u,v=s*a*c+r*l,m=r*s*c+a*l,y=a*s*c-r*l,g=s*s*c+u;return e.m00=gn*h+Tn*f+Cn*d,e.m01=bn*h+wn*f+kn*d,e.m02=xn*h+En*f+Rn*d,e.m03=Sn*h+An*f+On*d,e.m04=gn*_+Tn*p+Cn*v,e.m05=bn*_+wn*p+kn*v,e.m06=xn*_+En*p+Rn*v,e.m07=Sn*_+An*p+On*v,e.m08=gn*m+Tn*y+Cn*g,e.m09=bn*m+wn*y+kn*g,e.m10=xn*m+En*y+Rn*g,e.m11=Sn*m+An*y+On*g,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e}},{key:"rotateX",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m04,s=t.m05,o=t.m06,l=t.m07,u=t.m08,c=t.m09,h=t.m10,f=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=a*r+u*n,e.m05=s*r+c*n,e.m06=o*r+h*n,e.m07=l*r+f*n,e.m08=u*r-a*n,e.m09=c*r-s*n,e.m10=h*r-o*n,e.m11=f*r-l*n,e}},{key:"rotateY",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m00,s=t.m01,o=t.m02,l=t.m03,u=t.m08,c=t.m09,h=t.m10,f=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r-u*n,e.m01=s*r-c*n,e.m02=o*r-h*n,e.m03=l*r-f*n,e.m08=a*n+u*r,e.m09=s*n+c*r,e.m10=o*n+h*r,e.m11=l*n+f*r,e}},{key:"rotateZ",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m00,s=t.m01,o=t.m02,l=t.m03,u=t.m04,c=t.m05,h=t.m06,f=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r+u*n,e.m01=s*r+c*n,e.m02=o*r+h*n,e.m03=l*r+f*n,e.m04=u*r-a*n,e.m05=c*r-s*n,e.m06=h*r-o*n,e.m07=f*r-l*n,e}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRotation",value:function(e,t,i){var n=i.x,r=i.y,a=i.z,s=Math.sqrt(n*n+r*r+a*a);if(Math.abs(s)<fi)return null;n*=s=1/s,r*=s,a*=s;var o=Math.sin(t),l=Math.cos(t),u=1-l;return e.m00=n*n*u+l,e.m01=r*n*u+a*o,e.m02=a*n*u-r*o,e.m03=0,e.m04=n*r*u-a*o,e.m05=r*r*u+l,e.m06=a*r*u+n*o,e.m07=0,e.m08=n*a*u+r*o,e.m09=r*a*u-n*o,e.m10=a*a*u+l,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromXRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=n,e.m06=i,e.m07=0,e.m08=0,e.m09=-i,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromYRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=0,e.m02=-i,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=i,e.m09=0,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromZRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=0,e.m04=-i,e.m05=n,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRT",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=t.w,o=n+n,l=r+r,u=a+a,c=n*o,h=n*l,f=n*u,d=r*l,_=r*u,p=a*u,v=s*o,m=s*l,y=s*u;return e.m00=1-(d+p),e.m01=h+y,e.m02=f-m,e.m03=0,e.m04=h-y,e.m05=1-(c+p),e.m06=_+v,e.m07=0,e.m08=f+m,e.m09=_-v,e.m10=1-(c+d),e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"getTranslation",value:function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e}},{key:"getScaling",value:function(e,t){var i=zn.m00=t.m00,n=zn.m01=t.m01,r=zn.m02=t.m02,a=zn.m03=t.m04,s=zn.m04=t.m05,o=zn.m05=t.m06,l=zn.m06=t.m08,u=zn.m07=t.m09,c=zn.m08=t.m10;return e.x=Math.sqrt(i*i+n*n+r*r),e.y=Math.sqrt(a*a+s*s+o*o),e.z=Math.sqrt(l*l+u*u+c*c),an.determinant(zn)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e,t){var i=t.m00+t.m05+t.m10,n=0;return 0<i?(n=2*Math.sqrt(i+1),e.w=.25*n,e.x=(t.m06-t.m09)/n,e.y=(t.m08-t.m02)/n,e.z=(t.m01-t.m04)/n):t.m00>t.m05&&t.m00>t.m10?(n=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/n,e.x=.25*n,e.y=(t.m01+t.m04)/n,e.z=(t.m08+t.m02)/n):t.m05>t.m10?(n=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/n,e.x=(t.m01+t.m04)/n,e.y=.25*n,e.z=(t.m06+t.m09)/n):(n=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/n,e.x=(t.m08+t.m02)/n,e.y=(t.m06+t.m09)/n,e.z=.25*n),e}},{key:"toRTS",value:function(e,t,i,n){n.x=Ni.set(Fn,e.m00,e.m01,e.m02).length(),zn.m00=e.m00/n.x,zn.m01=e.m01/n.x,zn.m02=e.m02/n.x,n.y=Ni.set(Fn,e.m04,e.m05,e.m06).length(),zn.m03=e.m04/n.y,zn.m04=e.m05/n.y,zn.m05=e.m06/n.y,n.z=Ni.set(Fn,e.m08,e.m09,e.m10).length(),zn.m06=e.m08/n.z,zn.m07=e.m09/n.z,zn.m08=e.m10/n.z,an.determinant(zn)<0&&(n.x*=-1,zn.m00*=-1,zn.m01*=-1,zn.m02*=-1),fn.fromMat3(t,zn),Ni.set(i,e.m12,e.m13,e.m14)}},{key:"fromRTS",value:function(e,t,i,n){var r=t.x,a=t.y,s=t.z,o=t.w,l=r+r,u=a+a,c=s+s,h=r*l,f=r*u,d=r*c,_=a*u,p=a*c,v=s*c,m=o*l,y=o*u,g=o*c,b=n.x,x=n.y,S=n.z;return e.m00=(1-(_+v))*b,e.m01=(f+g)*b,e.m02=(d-y)*b,e.m03=0,e.m04=(f-g)*x,e.m05=(1-(h+v))*x,e.m06=(p+m)*x,e.m07=0,e.m08=(d+y)*S,e.m09=(p-m)*S,e.m10=(1-(h+_))*S,e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"fromRTSOrigin",value:function(e,t,i,n,r){var a=t.x,s=t.y,o=t.z,l=t.w,u=a+a,c=s+s,h=o+o,f=a*u,d=a*c,_=a*h,p=s*c,v=s*h,m=o*h,y=l*u,g=l*c,b=l*h,x=n.x,S=n.y,T=n.z,w=r.x,E=r.y,A=r.z;return e.m00=(1-(p+m))*x,e.m01=(d+b)*x,e.m02=(_-g)*x,e.m03=0,e.m04=(d-b)*S,e.m05=(1-(f+m))*S,e.m06=(v+y)*S,e.m07=0,e.m08=(_+g)*T,e.m09=(v-y)*T,e.m10=(1-(f+p))*T,e.m11=0,e.m12=i.x+w-(e.m00*w+e.m04*E+e.m08*A),e.m13=i.y+E-(e.m01*w+e.m05*E+e.m09*A),e.m14=i.z+A-(e.m02*w+e.m06*E+e.m10*A),e.m15=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,s=i+i,o=n+n,l=r+r,u=i*s,c=n*s,h=n*o,f=r*s,d=r*o,_=r*l,p=a*s,v=a*o,m=a*l;return e.m00=1-h-_,e.m01=c+m,e.m02=f-v,e.m03=0,e.m04=c-m,e.m05=1-u-_,e.m06=d+p,e.m07=0,e.m08=f+v,e.m09=d-p,e.m10=1-u-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"frustum",value:function(e,t,i,n,r,a,s){var o=1/(i-t),l=1/(r-n),u=1/(a-s);return e.m00=2*a*o,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*a*l,e.m06=0,e.m07=0,e.m08=(i+t)*o,e.m09=(r+n)*l,e.m10=(s+a)*u,e.m11=-1,e.m12=0,e.m13=0,e.m14=s*a*2*u,e.m15=0,e}},{key:"perspective",value:function(e,t,i,n,r){var a=1/Math.tan(t/2),s=1/(n-r);return e.m00=a/i,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=a,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r+n)*s,e.m11=-1,e.m12=0,e.m13=0,e.m14=2*r*n*s,e.m15=0,e}},{key:"ortho",value:function(e,t,i,n,r,a,s){var o=1/(t-i),l=1/(n-r),u=1/(a-s);return e.m00=-2*o,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=-2*l,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=2*u,e.m11=0,e.m12=(t+i)*o,e.m13=(r+n)*l,e.m14=(s+a)*u,e.m15=1,e}},{key:"lookAt",value:function(e,t,i,n){var r=t.x,a=t.y,s=t.z,o=n.x,l=n.y,u=n.z,c=r-i.x,h=a-i.y,f=s-i.z,d=1/Math.sqrt(c*c+h*h+f*f),_=l*(f*=d)-u*(h*=d),p=u*(c*=d)-o*f,v=o*h-l*c,m=h*(v*=d=1/Math.sqrt(_*_+p*p+v*v))-f*(p*=d),y=f*(_*=d)-c*v,g=c*p-h*_;return e.m00=_,e.m01=m,e.m02=c,e.m03=0,e.m04=p,e.m05=y,e.m06=h,e.m07=0,e.m08=v,e.m09=g,e.m10=f,e.m11=0,e.m12=-(_*r+p*a+v*s),e.m13=-(m*r+y*a+g*s),e.m14=-(c*r+h*a+f*s),e.m15=1,e}},{key:"inverseTranspose",value:function(e,t){gn=t.m00,bn=t.m01,xn=t.m02,Sn=t.m03,Tn=t.m04,wn=t.m05,En=t.m06,An=t.m07,Cn=t.m08,kn=t.m09,Rn=t.m10,On=t.m11,Mn=t.m12,In=t.m13,Bn=t.m14,Ln=t.m15;var i=gn*wn-bn*Tn,n=gn*En-xn*Tn,r=gn*An-Sn*Tn,a=bn*En-xn*wn,s=bn*An-Sn*wn,o=xn*An-Sn*En,l=Cn*In-kn*Mn,u=Cn*Bn-Rn*Mn,c=Cn*Ln-On*Mn,h=kn*Bn-Rn*In,f=kn*Ln-On*In,d=Rn*Ln-On*Bn,_=i*d-n*f+r*h+a*c-s*u+o*l;return _?(_=1/_,e.m00=(wn*d-En*f+An*h)*_,e.m01=(En*c-Tn*d-An*u)*_,e.m02=(Tn*f-wn*c+An*l)*_,e.m03=0,e.m04=(xn*f-bn*d-Sn*h)*_,e.m05=(gn*d-xn*c+Sn*u)*_,e.m06=(bn*c-gn*f-Sn*l)*_,e.m07=0,e.m08=(In*o-Bn*s+Ln*a)*_,e.m09=(Bn*r-Mn*o-Ln*n)*_,e.m10=(Mn*s-In*r+Ln*i)*_,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e[n+9]=t.m09,e[n+10]=t.m10,e[n+11]=t.m11,e[n+12]=t.m12,e[n+13]=t.m13,e[n+14]=t.m14,e[n+15]=t.m15,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e.m09=t[n+9],e.m10=t[n+10],e.m11=t[n+11],e.m12=t[n+12],e.m13=t[n+13],e.m14=t[n+14],e.m15=t[n+15],e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e.m09=t.m09+i.m09,e.m10=t.m10+i.m10,e.m11=t.m11+i.m11,e.m12=t.m12+i.m12,e.m13=t.m13+i.m13,e.m14=t.m14+i.m14,e.m15=t.m15+i.m15,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e.m09=t.m09-i.m09,e.m10=t.m10-i.m10,e.m11=t.m11-i.m11,e.m12=t.m12-i.m12,e.m13=t.m13-i.m13,e.m14=t.m14-i.m14,e.m15=t.m15-i.m15,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e.m09=t.m09*i,e.m10=t.m10*i,e.m11=t.m11*i,e.m12=t.m12*i,e.m13=t.m13*i,e.m14=t.m14*i,e.m15=t.m15*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=t.m00+i.m00*n,e.m01=t.m01+i.m01*n,e.m02=t.m02+i.m02*n,e.m03=t.m03+i.m03*n,e.m04=t.m04+i.m04*n,e.m05=t.m05+i.m05*n,e.m06=t.m06+i.m06*n,e.m07=t.m07+i.m07*n,e.m08=t.m08+i.m08*n,e.m09=t.m09+i.m09*n,e.m10=t.m10+i.m10*n,e.m11=t.m11+i.m11*n,e.m12=t.m12+i.m12*n,e.m13=t.m13+i.m13*n,e.m14=t.m14+i.m14*n,e.m15=t.m15+i.m15*n,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:fi;return Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=n*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=n*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=n*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=n*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=n*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=n*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=n*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))}}]),l(m,[{key:"clone",value:function(){var e=this;return new m(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,u,c,h,f,d,_,p){var v=0<arguments.length&&void 0!==e?e:1,m=1<arguments.length&&void 0!==t?t:0,y=2<arguments.length&&void 0!==i?i:0,g=3<arguments.length&&void 0!==n?n:0,b=4<arguments.length&&void 0!==r?r:0,x=5<arguments.length&&void 0!==a?a:1,S=6<arguments.length&&void 0!==s?s:0,T=7<arguments.length&&void 0!==o?o:0,w=8<arguments.length&&void 0!==l?l:0,E=9<arguments.length&&void 0!==u?u:0,A=10<arguments.length&&void 0!==c?c:1,C=11<arguments.length&&void 0!==h?h:0,k=12<arguments.length&&void 0!==f?f:0,R=13<arguments.length&&void 0!==d?d:0,O=14<arguments.length&&void 0!==_?_:0,M=15<arguments.length&&void 0!==p?p:1;return"object"===be(v)?(this.m01=v.m01,this.m02=v.m02,this.m03=v.m03,this.m04=v.m04,this.m05=v.m05,this.m06=v.m06,this.m07=v.m07,this.m08=v.m08,this.m09=v.m09,this.m10=v.m10,this.m11=v.m11,this.m12=v.m12,this.m13=v.m13,this.m14=v.m14,this.m15=v.m15,this.m00=v.m00):(this.m01=m,this.m02=y,this.m03=g,this.m04=b,this.m05=x,this.m06=S,this.m07=T,this.m08=w,this.m09=E,this.m10=A,this.m11=C,this.m12=k,this.m13=R,this.m14=O,this.m15=M,this.m00=v),this}},{key:"equals",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:fi;return Math.abs(this.m00-e.m00)<=i*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=i*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=i*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=i*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=i*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=i*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=i*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=i*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=i*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=i*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=i*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=i*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=i*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=i*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=i*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=i*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15}},{key:"toString",value:function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m03,n=this.m06,r=this.m07,a=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=n,this.m11=this.m14,this.m12=i,this.m13=r,this.m14=a,this}},{key:"invert",value:function(){gn=this.m00,bn=this.m01,xn=this.m02,Sn=this.m03,Tn=this.m04,wn=this.m05,En=this.m06,An=this.m07,Cn=this.m08,kn=this.m09,Rn=this.m10,On=this.m11,Mn=this.m12,In=this.m13,Bn=this.m14,Ln=this.m15;var e=gn*wn-bn*Tn,t=gn*En-xn*Tn,i=gn*An-Sn*Tn,n=bn*En-xn*wn,r=bn*An-Sn*wn,a=xn*An-Sn*En,s=Cn*In-kn*Mn,o=Cn*Bn-Rn*Mn,l=Cn*Ln-On*Mn,u=kn*Bn-Rn*In,c=kn*Ln-On*In,h=Rn*Ln-On*Bn,f=e*h-t*c+i*u+n*l-r*o+a*s;return 0===f?null:(f=1/f,this.m00=(wn*h-En*c+An*u)*f,this.m01=(xn*c-bn*h-Sn*u)*f,this.m02=(In*a-Bn*r+Ln*n)*f,this.m03=(Rn*r-kn*a-On*n)*f,this.m04=(En*l-Tn*h-An*o)*f,this.m05=(gn*h-xn*l+Sn*o)*f,this.m06=(Bn*i-Mn*a-Ln*t)*f,this.m07=(Cn*a-Rn*i+On*t)*f,this.m08=(Tn*c-wn*l+An*s)*f,this.m09=(bn*l-gn*c-Sn*s)*f,this.m10=(Mn*r-In*i+Ln*e)*f,this.m11=(kn*i-Cn*r-On*e)*f,this.m12=(wn*o-Tn*u-En*s)*f,this.m13=(gn*u-bn*o+xn*s)*f,this.m14=(In*t-Mn*n-Bn*e)*f,this.m15=(Cn*n-kn*t+Rn*e)*f,this)}},{key:"determinant",value:function(){return gn=this.m00,bn=this.m01,xn=this.m02,Sn=this.m03,Tn=this.m04,wn=this.m05,En=this.m06,An=this.m07,Cn=this.m08,kn=this.m09,Rn=this.m10,On=this.m11,Mn=this.m12,In=this.m13,Bn=this.m14,Ln=this.m15,(gn*wn-bn*Tn)*(Rn*Ln-On*Bn)-(gn*En-xn*Tn)*(kn*Ln-On*In)+(gn*An-Sn*Tn)*(kn*Bn-Rn*In)+(bn*En-xn*wn)*(Cn*Ln-On*Mn)-(bn*An-Sn*wn)*(Cn*Bn-Rn*Mn)+(xn*An-Sn*En)*(Cn*In-kn*Mn)}},{key:"add",value:function(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this.m09=this.m09+e.m09,this.m10=this.m10+e.m10,this.m11=this.m11+e.m11,this.m12=this.m12+e.m12,this.m13=this.m13+e.m13,this.m14=this.m14+e.m14,this.m15=this.m15+e.m15,this}},{key:"subtract",value:function(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this.m09=this.m09-e.m09,this.m10=this.m10-e.m10,this.m11=this.m11-e.m11,this.m12=this.m12-e.m12,this.m13=this.m13-e.m13,this.m14=this.m14-e.m14,this.m15=this.m15-e.m15,this}},{key:"multiply",value:function(e){gn=this.m00,bn=this.m01,xn=this.m02,Sn=this.m03,Tn=this.m04,wn=this.m05,En=this.m06,An=this.m07,Cn=this.m08,kn=this.m09,Rn=this.m10,On=this.m11,Mn=this.m12,In=this.m13,Bn=this.m14,Ln=this.m15;var t=e.m00,i=e.m01,n=e.m02,r=e.m03;return this.m00=t*gn+i*Tn+n*Cn+r*Mn,this.m01=t*bn+i*wn+n*kn+r*In,this.m02=t*xn+i*En+n*Rn+r*Bn,this.m03=t*Sn+i*An+n*On+r*Ln,t=e.m04,i=e.m05,n=e.m06,r=e.m07,this.m04=t*gn+i*Tn+n*Cn+r*Mn,this.m05=t*bn+i*wn+n*kn+r*In,this.m06=t*xn+i*En+n*Rn+r*Bn,this.m07=t*Sn+i*An+n*On+r*Ln,t=e.m08,i=e.m09,n=e.m10,r=e.m11,this.m08=t*gn+i*Tn+n*Cn+r*Mn,this.m09=t*bn+i*wn+n*kn+r*In,this.m10=t*xn+i*En+n*Rn+r*Bn,this.m11=t*Sn+i*An+n*On+r*Ln,t=e.m12,i=e.m13,n=e.m14,r=e.m15,this.m12=t*gn+i*Tn+n*Cn+r*Mn,this.m13=t*bn+i*wn+n*kn+r*In,this.m14=t*xn+i*En+n*Rn+r*Bn,this.m15=t*Sn+i*An+n*On+r*Ln,this}},{key:"multiplyScalar",value:function(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this.m09=this.m09*e,this.m10=this.m10*e,this.m11=this.m11*e,this.m12=this.m12*e,this.m13=this.m13*e,this.m14=this.m14*e,this.m15=this.m15*e,this}},{key:"translate",value:function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.y,this}},{key:"scale",value:function(e){var t=e.x,i=e.y,n=e.z;return this.m00=this.m00*t,this.m01=this.m01*t,this.m02=this.m02*t,this.m03=this.m03*t,this.m04=this.m04*i,this.m05=this.m05*i,this.m06=this.m06*i,this.m07=this.m07*i,this.m08=this.m08*n,this.m09=this.m09*n,this.m10=this.m10*n,this.m11=this.m11*n,this.m12=this.m12,this.m13=this.m13,this.m14=this.m14,this.m15=this.m15,this}},{key:"rotate",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=Math.sqrt(i*i+n*n+r*r);if(Math.abs(a)<fi)return null;i*=a=1/a,n*=a,r*=a;var s=Math.sin(e),o=Math.cos(e),l=1-o;gn=this.m00,bn=this.m01,xn=this.m02,Sn=this.m03,Tn=this.m04,wn=this.m05,En=this.m06,An=this.m07,Cn=this.m08,kn=this.m09,Rn=this.m10,On=this.m11;var u=i*i*l+o,c=n*i*l+r*s,h=r*i*l-n*s,f=i*n*l-r*s,d=n*n*l+o,_=r*n*l+i*s,p=i*r*l+n*s,v=n*r*l-i*s,m=r*r*l+o;return this.m00=gn*u+Tn*c+Cn*h,this.m01=bn*u+wn*c+kn*h,this.m02=xn*u+En*c+Rn*h,this.m03=Sn*u+An*c+On*h,this.m04=gn*f+Tn*d+Cn*_,this.m05=bn*f+wn*d+kn*_,this.m06=xn*f+En*d+Rn*_,this.m07=Sn*f+An*d+On*_,this.m08=gn*p+Tn*v+Cn*m,this.m09=bn*p+wn*v+kn*m,this.m10=xn*p+En*v+Rn*m,this.m11=Sn*p+An*v+On*m,this}},{key:"getTranslation",value:function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e}},{key:"getScale",value:function(e){var t=zn.m00=this.m00,i=zn.m01=this.m01,n=zn.m02=this.m02,r=zn.m03=this.m04,a=zn.m04=this.m05,s=zn.m05=this.m06,o=zn.m06=this.m08,l=zn.m07=this.m09,u=zn.m08=this.m10;return e.x=Math.sqrt(t*t+i*i+n*n),e.y=Math.sqrt(r*r+a*a+s*s),e.z=Math.sqrt(o*o+l*l+u*u),an.determinant(zn)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e){var t=this.m00+this.m05+this.m10,i=0;return 0<t?(i=2*Math.sqrt(t+1),e.w=.25*i,e.x=(this.m06-this.m09)/i,e.y=(this.m08-this.m02)/i,e.z=(this.m01-this.m04)/i):this.m00>this.m05&&this.m00>this.m10?(i=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/i,e.x=.25*i,e.y=(this.m01+this.m04)/i,e.z=(this.m08+this.m02)/i):this.m05>this.m10?(i=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/i,e.x=(this.m01+this.m04)/i,e.y=.25*i,e.z=(this.m06+this.m09)/i):(i=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/i,e.x=(this.m08+this.m02)/i,e.y=(this.m06+this.m09)/i,e.z=.25*i),e}},{key:"fromRTS",value:function(e,t,i){var n=e.x,r=e.y,a=e.z,s=e.w,o=n+n,l=r+r,u=a+a,c=n*o,h=n*l,f=n*u,d=r*l,_=r*u,p=a*u,v=s*o,m=s*l,y=s*u,g=i.x,b=i.y,x=i.z;return this.m00=(1-(d+p))*g,this.m01=(h+y)*g,this.m02=(f-m)*g,this.m03=0,this.m04=(h-y)*b,this.m05=(1-(c+p))*b,this.m06=(_+v)*b,this.m07=0,this.m08=(f+m)*x,this.m09=(_-v)*x,this.m10=(1-(c+d))*x,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,s=i+i,o=n+n,l=t*a,u=i*a,c=i*s,h=n*a,f=n*s,d=n*o,_=r*a,p=r*s,v=r*o;return this.m00=1-c-d,this.m01=u+v,this.m02=h-p,this.m03=0,this.m04=u-v,this.m05=1-l-d,this.m06=f+_,this.m07=0,this.m08=h+p,this.m09=f-_,this.m10=1-l-c,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}}]),m}());Pn.IDENTITY=Object.freeze(new Pn);var Fn=new Ni,zn=new an;function Dn(e,t,i,n,r,a,s,o,l,u,c,h,f,d,_,p){return new Pn(e,t,i,n,r,a,s,o,l,u,c,h,f,d,_,p)}si.fastDefine("cc.Mat4",Pn,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),cc.Mat4=Pn,cc.mat4=Dn;var Nn=0,Un=0,Vn=0,Gn=0,Hn=0,Wn=0,qn=m4("AffineTransform",function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0;y(this,s),this.a=void 0,this.b=void 0,this.c=void 0,this.d=void 0,this.tx=void 0,this.ty=void 0,this.a=e,this.b=t,this.c=i,this.d=n,this.tx=r,this.ty=a}return l(s,null,[{key:"identity",value:function(){return new s}},{key:"clone",value:function(e){return new s(e.a,e.b,e.c,e.d,e.tx,e.ty)}},{key:"concat",value:function(e,t,i){Nn=t.a,Un=t.b,Vn=t.c,Gn=t.d,Hn=t.tx,Wn=t.ty,e.a=Nn*i.a+Un*i.c,e.b=Nn*i.b+Un*i.d,e.c=Vn*i.a+Gn*i.c,e.d=Vn*i.b+Gn*i.d,e.tx=Hn*i.a+Wn*i.c+i.tx,e.ty=Hn*i.b+Wn*i.d+i.ty}},{key:"invert",value:function(e,t){var i=1/(t.a*t.d-t.b*t.c);e.a=i*t.d,e.b=-i*t.b,e.c=-i*t.c,e.d=i*t.a,e.tx=i*(t.c*t.ty-t.d*t.tx),e.ty=i*(t.b*t.tx-t.a*t.ty)}},{key:"fromMat4",value:function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13}},{key:"transformVec2",value:function(e,t,i,n){var r,a;a=void 0===n?(n=i,r=t.x,t.y):(r=t,i),e.x=n.a*r+n.c*a+n.tx,e.y=n.b*r+n.d*a+n.ty}},{key:"transformSize",value:function(e,t,i){e.width=i.a*t.width+i.c*t.height,e.height=i.b*t.width+i.d*t.height}},{key:"transformRect",value:function(e,t,i){var n=t.x+t.width,r=t.y+t.height,a=i.a*t.x+i.c*t.y+i.tx,s=i.b*t.x+i.d*t.y+i.ty,o=i.a*n+i.c*t.y+i.tx,l=i.b*n+i.d*t.y+i.ty,u=i.a*t.x+i.c*r+i.tx,c=i.b*t.x+i.d*r+i.ty,h=i.a*n+i.c*r+i.tx,f=i.b*n+i.d*r+i.ty,d=Math.min(a,o,u,h),_=Math.max(a,o,u,h),p=Math.min(s,l,c,f),v=Math.max(s,l,c,f);e.x=d,e.y=p,e.width=_-d,e.height=v-p}},{key:"transformObb",value:function(e,t,i,n,r,a){var s=a.a*r.x+a.c*r.y+a.tx,o=a.b*r.x+a.d*r.y+a.ty,l=a.a*r.width,u=a.b*r.width,c=a.c*r.height,h=a.d*r.height;t.x=s,t.y=o,i.x=l+s,i.y=u+o,e.x=c+s,e.y=h+o,n.x=l+c+s,n.y=u+h+o}}]),s}());cc.AffineTransform=qn;var jn=m4("Size",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this))).width=void 0,i.height=void 0,e&&"object"===be(e)?(i.height=e.height,i.width=e.width):(i.width=e||0,i.height=t||0),i}return _(n,yt),l(n,[{key:"x",set:function(e){this.width=e},get:function(){return this.width}},{key:"y",set:function(e){this.height=e},get:function(){return this.height}}],[{key:"lerp",value:function(e,t,i,n){return e.width=t.width+(i.width-t.width)*n,e.height=t.height+(i.height-t.height)*n,e}},{key:"ZERO",get:function(){return new n(0,0)}}]),l(n,[{key:"clone",value:function(){return new n(this.width,this.height)}},{key:"set",value:function(e,t){return e&&"object"===be(e)?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this}},{key:"equals",value:function(e){return this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){return this.width=this.width+(e.width-this.width)*t,this.height=this.height+(e.height-this.height)*t,this}},{key:"toString",value:function(){return"(".concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}}]),n}());function Xn(){return new jn(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0)}si.fastDefine("cc.Size",jn,{width:0,height:0}),cc.size=Xn,cc.Size=jn;var Yn=0,Kn=0,Qn=0,Zn=0,Jn=m4("Rect",function(){function a(e,t,i,n){var r;return y(this,a),(r=x(this,g(a).call(this))).x=void 0,r.y=void 0,r.width=void 0,r.height=void 0,e&&"object"===be(e)?(r.y=e.y,r.width=e.width,r.height=e.height,r.x=e.x):(r.x=e||0,r.y=t||0,r.width=i||0,r.height=n||0),r}return _(a,yt),l(a,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new Ii(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new cc.Vec2(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new jn(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",set:function(e){this.width=e},get:function(){return this.width}},{key:"w",set:function(e){this.height=e},get:function(){return this.height}}],[{key:"fromMinMax",value:function(e,t,i){var n=Math.min(t.x,i.x),r=Math.min(t.y,i.y),a=Math.max(t.x,i.x),s=Math.max(t.y,i.y);return e.x=n,e.y=r,e.width=a-n,e.height=s-r,e}},{key:"lerp",value:function(e,t,i,n){return Yn=t.x,Kn=t.y,Qn=t.width,Zn=t.height,e.x=Yn+(i.x-Yn)*n,e.y=Kn+(i.y-Kn)*n,e.width=Qn+(i.width-Qn)*n,e.height=Zn+(i.height-Zn)*n,e}},{key:"intersection",value:function(e,t,i){var n=t.x,r=t.y,a=t.x+t.width,s=t.y+t.height,o=i.x,l=i.y,u=i.x+i.width,c=i.y+i.height;return e.x=Math.max(n,o),e.y=Math.max(r,l),e.width=Math.min(a,u)-e.x,e.height=Math.min(s,c)-e.y,e}},{key:"union",value:function(e,t,i){Yn=t.x,Kn=t.y,Qn=t.width,Zn=t.height;var n=i.x,r=i.y,a=i.width,s=i.height;return e.x=Math.min(Yn,n),e.y=Math.min(Kn,r),e.width=Math.max(Yn+Qn,n+a)-e.x,e.height=Math.max(Kn+Zn,r+s)-e.y,e}}]),l(a,[{key:"clone",value:function(){return new a(this.x,this.y,this.width,this.height)}},{key:"set",value:function(e,t,i,n){return e&&"object"===be(e)?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=i||0,this.height=n||0),this}},{key:"equals",value:function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){return Yn=this.x,Kn=this.y,Qn=this.width,Zn=this.height,this.x=Yn+(e.x-Yn)*t,this.y=Kn+(e.y-Kn)*t,this.width=Qn+(e.width-Qn)*t,this.height=Zn+(e.height-Zn)*t,this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}},{key:"intersects",value:function(e){var t=this.x+this.width,i=this.y+this.height,n=e.x+e.width,r=e.y+e.height;return!(t<e.x||n<this.x||i<e.y||r<this.y)}},{key:"contains",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y}},{key:"containsRect",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y,n=t+this.width,r=i+this.height,a=e.m00*t+e.m04*i+e.m12,s=e.m01*t+e.m05*i+e.m13,o=e.m00*n+e.m04*i+e.m12,l=e.m01*n+e.m05*i+e.m13,u=e.m00*t+e.m04*r+e.m12,c=e.m01*t+e.m05*r+e.m13,h=e.m00*n+e.m04*r+e.m12,f=e.m01*n+e.m05*r+e.m13,d=Math.min(a,o,u,h),_=Math.max(a,o,u,h),p=Math.min(s,l,c,f),v=Math.max(s,l,c,f);return this.x=d,this.y=p,this.width=_-d,this.height=v-p,this}}]),a}());function $n(){return new Jn(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,3<arguments.length&&void 0!==arguments[3]?arguments[3]:0)}si.fastDefine("cc.Rect",Jn,{x:0,y:0,width:0,height:0}),cc.Rect=Jn,cc.rect=$n;var er=1/255,tr=0,ir=0,nr=0,rr=0,ar=m4("Color",function(){function a(e,t,i,n){var r;return y(this,a),(r=x(this,g(a).call(this)))._val=0,"string"==typeof e?r.fromHEX(e):("object"===be(e)&&(t=e.g,i=e.b,n=e.a,e=e.r),e=e||0,t=t||0,i=i||0,n="number"==typeof n?n:255,r._val=(n<<24>>>0)+(i<<16)+(t<<8)+e),r}return _(a,yt),l(a,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~pi(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~pi(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~pi(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~pi(e,0,255),this._val=(16777215&this._val|e<<24>>>0)>>>0}},{key:"x",get:function(){return this.r*er},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*er},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*er},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*er},set:function(e){this.a=255*e}}],[{key:"clone",value:function(e){var t=new a;return e._val?t._val=e._val:t._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,t}},{key:"copy",value:function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e}},{key:"set",value:function(e,t,i,n,r){return e.r=t,e.g=i,e.b=n,e.a=r,e}},{key:"fromHex",value:function(e,t){return e.r=(t>>24)/255,e.g=(t>>16&255)/255,e.b=(t>>8&255)/255,e.a=(255&t)/255,e}},{key:"add",value:function(e,t,i){return e.r=t.r+i.r,e.g=t.g+i.g,e.b=t.b+i.b,e.a=t.a+i.a,e}},{key:"subtract",value:function(e,t,i){return e.r=t.r-i.r,e.g=t.g-i.g,e.b=t.b-i.b,e.a=t.a-i.a,e}},{key:"multiply",value:function(e,t,i){return e.r=t.r*i.r,e.g=t.g*i.g,e.b=t.b*i.b,e.a=t.a*i.a,e}},{key:"divide",value:function(e,t,i){return e.r=t.r/i.r,e.g=t.g/i.g,e.b=t.b/i.b,e.a=t.a/i.a,e}},{key:"scale",value:function(e,t,i){return e.r=t.r*i,e.g=t.g*i,e.b=t.b*i,e.a=t.a*i,e}},{key:"lerp",value:function(e,t,i,n){return tr=t.r,ir=t.g,nr=t.b,rr=t.a,tr+=(i.r-tr)*n,ir+=(i.g-ir)*n,nr+=(i.b-nr)*n,rr+=(i.a-rr)*n,e._val=Math.floor((rr<<24>>>0)+(nr<<16)+(ir<<8)+tr),e}},{key:"toArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0,r=t instanceof a||1<t.a?1/255:1;return e[n+0]=t.r*r,e[n+1]=t.g*r,e[n+2]=t.b*r,e[n+3]=t.a*r,e}},{key:"fromArray",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:0;return t.r=255*e[n+0],t.g=255*e[n+1],t.b=255*e[n+2],t.a=255*e[n+3],t}},{key:"strictEquals",value:function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}},{key:"equals",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:fi;return Math.abs(e.r-t.r)<=n*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=n*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=n*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=n*Math.max(1,Math.abs(e.a),Math.abs(t.a))}},{key:"hex",value:function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0}}]),l(a,[{key:"clone",value:function(){var e=new a;return e._val=this._val,e}},{key:"equals",value:function(e){return e&&this._val===e._val}},{key:"lerp",value:function(e,t){return tr=this.r,ir=this.g,nr=this.b,rr=this.a,tr+=(e.r-tr)*t,ir+=(e.g-ir)*t,nr+=(e.b-nr)*t,rr+=(e.a-rr)*t,this._val=Math.floor((rr<<24>>>0)+(nr<<16)+(ir<<8)+tr),this}},{key:"toString",value:function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"}},{key:"toCSS",value:function(e){return"rgba"===e?"rgba("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+","+(this.a*er).toFixed(2)+")":"rgb"===e?"rgb("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+")":"#"+this.toHEX(e)}},{key:"fromHEX",value:function(e){return e=0===e.indexOf("#")?e.substring(1):e,tr=parseInt(e.substr(0,2),16)||0,ir=parseInt(e.substr(2,2),16)||0,nr=parseInt(e.substr(4,2),16)||0,rr=parseInt(e.substr(6,2),16)||255,this._val=(rr<<24>>>0)+(nr<<16)+(ir<<8)+tr,this}},{key:"toHEX",value:function(e){var t=[(0|this.r).toString(16),(0|this.g).toString(16),(0|this.b).toString(16)],i=-1;if("#rrggbb"===e)for(i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);else if("#rrggbbaa"===e)for(t.push((0|this.a).toString(16)),i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);return t.join("")}},{key:"toRGBValue",value:function(){return 16777215&this._val}},{key:"fromHSV",value:function(e,t,i){if((nr=ir=tr=0)===t)tr=ir=nr=i;else if(0===i)tr=ir=nr=0;else{1===e&&(e=0),e*=6,t=t,i=i;var n=Math.floor(e),r=e-n,a=i*(1-t),s=i*(1-t*r),o=i*(1-t*(1-r));switch(n){case 0:tr=i,ir=o,nr=a;break;case 1:tr=s,ir=i,nr=a;break;case 2:tr=a,ir=i,nr=o;break;case 3:tr=a,ir=s,nr=i;break;case 4:tr=o,ir=a,nr=i;break;case 5:tr=i,ir=a,nr=s}}return tr*=255,ir*=255,nr*=255,this._val=(this.a<<24>>>0)+(nr<<16)+(ir<<8)+tr,this}},{key:"toHSV",value:function(){tr=this.r*er,ir=this.g*er,nr=this.b*er;var e={h:0,s:0,v:0},t=Math.max(tr,ir,nr),i=Math.min(tr,ir,nr),n=0;return e.v=t,e.s=t?(t-i)/t:0,e.s?(n=t-i,e.h=tr===t?(ir-nr)/n:ir===t?2+(nr-tr)/n:4+(tr-ir)/n,e.h/=6,e.h<0&&(e.h+=1)):e.h=0,e}},{key:"set",value:function(e,t,i,n){return"object"===be(e)&&(t=e.g,i=e.b,n=e.a,e=e.r),e=e||0,t=t||0,i=i||0,n="number"==typeof n?n:255,this._val=(n<<24>>>0)+(i<<16)+(t<<8)+e,this}},{key:"multiply",value:function(e){return tr=(255&this._val)*e.r>>8,ir=(65280&this._val)*e.g>>8,nr=(16711680&this._val)*e.b>>8,rr=((4278190080&this._val)>>>8)*e.a,this._val=4278190080&rr|16711680&nr|65280&ir|255&tr,this}},{key:"_set_r_unsafe",value:function(e){return this._val=(4294967040&this._val|e)>>>0,this}},{key:"_set_g_unsafe",value:function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this}},{key:"_set_b_unsafe",value:function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this}},{key:"_set_a_unsafe",value:function(e){return this._val=(16777215&this._val|e<<24>>>0)>>>0,this}}]),a}());function sr(e,t,i,n){return new ar(e,t,i,n)}ar.WHITE=Object.freeze(new ar(255,255,255,255)),ar.GRAY=Object.freeze(new ar(127,127,127,255)),ar.BLACK=Object.freeze(new ar(0,0,0,255)),ar.TRANSPARENT=Object.freeze(new ar(0,0,0,0)),ar.RED=Object.freeze(new ar(255,0,0,255)),ar.GREEN=Object.freeze(new ar(0,255,0,255)),ar.BLUE=Object.freeze(new ar(0,0,255,255)),ar.CYAN=Object.freeze(new ar(0,255,255,255)),ar.MAGENTA=Object.freeze(new ar(255,0,255,255)),ar.YELLOW=Object.freeze(new ar(255,255,0,255)),si.fastDefine("cc.Color",ar,{r:0,g:0,b:0,a:255}),cc.Color=ar,cc.color=sr;var or,lr,ur,cr,hr,fr=10;var dr=0,_r=new Map;ur=function(e,t,i,n,r,a){var s=_r.get(a);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead.","".concat(e,".").concat(t),"".concat(i,".").concat(n)),s.count++)},or=m4("replaceProperty",function(o,l,e){null!=o&&e.forEach(function(t){var i=dr++;_r.set(i,{id:i,count:0,logTimes:void 0!==t.logTimes?t.logTimes:fr});var n=null!=t.target?t.target:o,r=null!=t.newName?t.newName:t.name,a=null!=t.targetName?t.targetName:l;if(null!=t.customFunction)o[t.name]=function(){return ur(l,t.name,a,r,A,i),t.customFunction.call(this,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3],arguments.length<=4?void 0:arguments[4],arguments.length<=5?void 0:arguments[5],arguments.length<=6?void 0:arguments[6],arguments.length<=7?void 0:arguments[7],arguments.length<=8?void 0:arguments[8],arguments.length<=9?void 0:arguments[9],arguments.length<=10?void 0:arguments[10],arguments.length<=11?void 0:arguments[11])};else if(null!=t.customSetter||null!=t.customGetter){var e=null!=t.customSetter,s=null!=t.customGetter;e&&s?Object.defineProperty(o,t.name,{get:function(){return ur(l,t.name,a,r,A,i),t.customGetter.call(this)},set:function(e){ur(l,t.name,a,r,A,i),t.customSetter.call(this,e)}}):e?Object.defineProperty(o,t.name,{set:function(e){ur(l,t.name,a,r,A,i),t.customSetter.call(this,e)}}):s&&Object.defineProperty(o,t.name,{get:function(){return ur(l,t.name,a,r,A,i),t.customGetter.call(this)}})}else Object.defineProperty(o,t.name,{get:function(){return ur(l,t.name,a,r,A,i),n[r]},set:function(e){ur(l,t.name,a,r,A,i),n[r]=e}})})}),hr=function(e,t,i,n){var r=_r.get(n);r&&r.logTimes>r.count&&(i("'%s' has been removed.","".concat(e,".").concat(t)),r.count++)},lr=m4("removeProperty",function(i,n,e){null!=i&&e.forEach(function(e){var t=dr++;_r.set(t,{id:t,count:0,logTimes:void 0!==e.logTimes?e.logTimes:fr}),Object.defineProperty(i,e.name,{get:function(){return hr(n,e.name,C,t)},set:function(){hr(n,e.name,C,t)}})})}),cr=function(e,t,i,n){var r=_r.get(n);r&&r.logTimes>r.count&&(i("'%s' is deprecated.","".concat(e,".").concat(t)),r.count++)},m4("markAsWarning",function(a,s,e){if(null!=a){var o=function(e,t,i,n,r,a,s){if(i.get){var o=i.get();i.get=function(){return cr(n,r,a,s),o.call(this)}}if(i.set){var l=Object.create(i.set);i.set=function(e){cr(n,r,a,s),l.call(this,e)}}};e.forEach(function(e){var t=e.name,i=Object.getOwnPropertyDescriptor(a,t);if(i){var n=dr++;if(_r.set(n,{id:n,count:0,logTimes:void 0!==e.logTimes?e.logTimes:fr}),null!=i.value)if("function"==typeof i.value){var r=i.value;a[t]=function(){return cr(s,t,A,n),r.call(this)}}else o(0,0,i,s,t,A,n);else o(0,0,i,s,t,A,n)}})}}),or(Ii,"Vec2",[{name:"sub",newName:"subtract",target:Ii,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Ii,targetName:"Vec2"},{name:"div",newName:"divide",target:Ii,targetName:"Vec2"},{name:"dist",newName:"distance",target:Ii,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Ii,targetName:"Vec2"},{name:"mag",newName:"len",target:Ii,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Ii,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Ii,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Ii,targetName:"Vec2"}]),or(Ii.prototype,"Vec2",[{name:"mag",newName:"length",target:Ii.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Ii.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Ii.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Ii.prototype,targetName:"Vec2"}]),lr(Ii.prototype,"vmath",[{name:"divide"}]),or(Ni,"Vec3",[{name:"sub",newName:"subtract",target:Ni,targetName:"Vec3"},{name:"mul",newName:"multiply",target:Ni,targetName:"Vec3"},{name:"div",newName:"divide",target:Ni,targetName:"Vec3"},{name:"dist",newName:"distance",target:Ni,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:Ni,targetName:"Vec3"},{name:"mag",newName:"len",target:Ni,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:Ni,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Ni,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Ni,targetName:"Vec3"}]),or(Ni.prototype,"Vec3",[{name:"mag",newName:"length",target:Ni.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:Ni.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Ni.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Ni.prototype,targetName:"Vec3"}]),lr(Ni.prototype,"vmath",[{name:"divide"}]),or(Xi,"Vec4",[{name:"sub",newName:"subtract",target:Xi,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Xi,targetName:"Vec4"},{name:"div",newName:"divide",target:Xi,targetName:"Vec4"},{name:"dist",newName:"distance",target:Xi,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Xi,targetName:"Vec4"},{name:"mag",newName:"len",target:Xi,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Xi,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Xi,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Xi,targetName:"Vec4"}]),or(Xi.prototype,"Vec4",[{name:"mag",newName:"length",target:Xi.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Xi.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Xi.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Xi.prototype,targetName:"Vec4"}]),lr(Xi.prototype,"vmath",[{name:"divide"}]),or(fn,"Quat",[{name:"mag",newName:"len",target:fn,targetName:"Quat"},{name:"mul",newName:"multiply",target:fn,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:fn,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:fn,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:fn,targetName:"Quat"}]),or(fn.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:fn.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:fn.prototype,targetName:"Quat"}]),or(ar,"Color",[{name:"sub",newName:"subtract",target:ar,targetName:"Color"},{name:"mul",newName:"multiply",target:ar,targetName:"Color"},{name:"div",newName:"divide",target:ar,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:ar,targetName:"Color"}]),or(an,"Mat3",[{name:"sub",newName:"subtract",target:an,targetName:"Mat3"},{name:"mul",newName:"multiply",target:an,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:an,targetName:"Mat3"}]),or(an.prototype,"Mat3",[{name:"sub",newName:"subtract",target:an.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:an.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:an.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:an.prototype,targetName:"Mat3"}]),or(Pn,"Mat4",[{name:"sub",newName:"subtract",target:Pn,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Pn,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Pn,targetName:"Mat4"}]),or(Pn.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Pn.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Pn.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Pn.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Pn.prototype,targetName:"Mat4"}]);var pr=Object.freeze({bits:ue,Vec2:Ii,v2:Pi,Vec3:Ni,v3:Gi,Vec4:Xi,v4:Yi,Quat:fn,quat:yn,Mat3:an,Mat4:Pn,mat4:Dn,AffineTransform:qn,Size:jn,size:Xn,Rect:Jn,rect:$n,Color:ar,color:sr,EPSILON:fi,equals:di,approx:_i,clamp:pi,clamp01:vi,lerp:mi,toRadian:yi,toDegree:gi,random:bi,randomRange:xi,randomRangeInt:Si,pseudoRandom:Ti,pseudoRandomRange:wi,pseudoRandomRangeInt:Ei,nextPow2:Ai,repeat:Ci,pingPong:ki,inverseLerp:Ri});m4("math",pr);var vr={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256},mr=new Ni,yr=new Ni,gr=new Ni,br=new Ni,xr=new Ni,Sr=new Ni,Tr=new Array(3),wr=new Array(3);function Er(e,t){return Ni.dot(t.n,e)-t.d}function Ar(e,t,i){return Ni.copy(e,t),Ni.subtract(xr,i.center,i.halfExtents),Ni.add(Sr,i.center,i.halfExtents),e.x=e.x<xr.x?xr.x:e.x,e.y=e.y<xr.x?xr.y:e.y,e.z=e.z<xr.x?xr.z:e.z,e.x=e.x>Sr.x?Sr.x:e.x,e.y=e.y>Sr.x?Sr.y:e.y,e.z=e.z>Sr.x?Sr.z:e.z,e}function Cr(e,t,i){Ni.set(mr,i.orientation.m00,i.orientation.m01,i.orientation.m02),Ni.set(yr,i.orientation.m03,i.orientation.m04,i.orientation.m05),Ni.set(gr,i.orientation.m06,i.orientation.m07,i.orientation.m08),Tr[0]=mr,Tr[1]=yr,Tr[2]=gr,wr[0]=i.halfExtents.x,wr[1]=i.halfExtents.y,wr[2]=i.halfExtents.z,Ni.subtract(br,t,i.center),Ni.set(e,i.center.x,i.center.y,i.center.z);for(var n=0;n<3;n++){var r=Ni.dot(br,Tr[n]);r>wr[n]&&(r=wr[n]),r<-wr[n]&&(r=-wr[n]),e.x+=r*Tr[n].x,e.y+=r*Tr[n].y,e.z+=r*Tr[n].z}return e}var kr,Rr,Or,Mr,Ir,Br,Lr,Pr,Fr,zr,Dr,Nr,Ur,Vr,Gr,Hr,Wr,qr,jr,Xr,Yr,Kr,Qr,Zr,Jr,$r,ea,ta,ia,na,ra,aa,sa,oa,la,ua,ca,ha,fa=Object.freeze({point_plane:Er,pt_point_plane:function(e,t,i){var n=Er(t,i);return Ni.subtract(e,t,Ni.multiplyScalar(e,i.n,n))},pt_point_aabb:Ar,pt_point_obb:Cr}),da=(kr=new Ni(0,0,0),function(e,t){var i=Ni.dot(e.d,t.n);if(Math.abs(i)<Number.EPSILON)return 0;Ni.multiplyScalar(kr,t.n,t.d);var n=Ni.dot(Ni.subtract(kr,kr,e.o),t.n)/i;return n<0?0:n}),_a=(Rr=new Ni(0,0,0),function(e,t){Ni.subtract(Rr,e.e,e.s);var i=(t.d-Ni.dot(e.s,t.n))/Ni.dot(Rr,t.n);return i<0||1<i?0:i}),pa=(Or=new Ni(0,0,0),Mr=new Ni(0,0,0),Ir=new Ni(0,0,0),Br=new Ni(0,0,0),Lr=new Ni(0,0,0),function(e,t,i){Ni.subtract(Or,t.b,t.a),Ni.subtract(Mr,t.c,t.a),Ni.cross(Ir,e.d,Mr);var n=Ni.dot(Or,Ir);if(n<Number.EPSILON&&(!i||n>-Number.EPSILON))return 0;var r=1/n;Ni.subtract(Br,e.o,t.a);var a=Ni.dot(Br,Ir)*r;if(a<0||1<a)return 0;Ni.cross(Lr,Br,Or);var s=Ni.dot(e.d,Lr)*r;if(s<0||1<a+s)return 0;var o=Ni.dot(Mr,Lr)*r;return o<0?0:o}),va=(Pr=new Ni(0,0,0),Fr=new Ni(0,0,0),zr=new Ni(0,0,0),Dr=new Ni(0,0,0),Nr=new Ni(0,0,0),Ur=new Ni(0,0,0),function(e,t,i){Ni.subtract(Pr,t.b,t.a),Ni.subtract(Fr,t.c,t.a),Ni.subtract(zr,e.s,e.e),Ni.cross(Nr,Pr,Fr);var n=Ni.dot(zr,Nr);if(n<=0)return 0;Ni.subtract(Dr,e.s,t.a);var r=Ni.dot(Dr,Nr);if(r<0||n<r)return 0;Ni.cross(Ur,zr,Dr);var a=Ni.dot(Fr,Ur);if(a<0||n<a)return 0;var s=-Ni.dot(Pr,Ur);if(s<0||n<a+s)return 0;if(i){var o=1/n,l=1-(a*=o)-(s*=o);Ni.set(i,t.a.x*l+t.b.x*a+t.c.x*s,t.a.y*l+t.b.y*a+t.c.y*s,t.a.z*l+t.b.z*a+t.c.z*s)}return 1}),ma=(Vr=new Ni(0,0,0),Gr=new Ni(0,0,0),Hr=new Ni(0,0,0),Wr=new Ni(0,0,0),qr=new Ni(0,0,0),jr=new Ni(0,0,0),Xr=new Ni(0,0,0),function(e,t,i,n,r,a,s){Ni.subtract(Vr,t,e),Ni.subtract(Gr,i,e),Ni.subtract(Hr,n,e),Ni.subtract(Wr,r,e),Ni.cross(jr,Wr,Vr);var o=Ni.dot(Gr,jr);if(0<=o){var l=-Ni.dot(Hr,jr);if(l<0)return 0;var u=Ni.dot(Ni.cross(Xr,Vr,Hr),Gr);if(u<0)return 0;if(s){var c=1/(l+o+u);l*=c,o*=c,u*=c,Ni.set(s,i.x*l+n.x*o+r.x*u,i.y*l+n.y*o+r.y*u,i.z*l+n.z*o+r.z*u)}}else{Ni.subtract(qr,a,e);var h=Ni.dot(qr,jr);if(h<0)return 0;var f=Ni.dot(Ni.cross(Xr,Vr,Gr),qr);if(f<0)return 0;if(s){var d=1/(h+(o=-o)+f);h*=d,o*=d,f*=d,Ni.set(s,i.x*h+a.x*o+r.x*f,i.y*h+a.y*o+r.y*f,i.z*h+a.z*o+r.z*f)}}return 1}),ya=(Yr=new Ni(0,0,0),function(e,t){var i=t.radius,n=t.center,r=e.o,a=e.d,s=i*i;Ni.subtract(Yr,n,r);var o=Yr.lengthSqr(),l=Ni.dot(Yr,a),u=s-(o-l*l);if(u<0)return 0;var c=Math.sqrt(u),h=o<s?l+c:l-c;return h<0?0:h}),ga=(Kr=new Ni,Qr=new Ni,function(e,t){var i=e.o,n=e.d,r=1/n.x,a=1/n.y,s=1/n.z;Ni.subtract(Kr,t.center,t.halfExtents),Ni.add(Qr,t.center,t.halfExtents);var o=(Kr.x-i.x)*r,l=(Qr.x-i.x)*r,u=(Kr.y-i.y)*a,c=(Qr.y-i.y)*a,h=(Kr.z-i.z)*s,f=(Qr.z-i.z)*s,d=Math.max(Math.max(Math.min(o,l),Math.min(u,c)),Math.min(h,f)),_=Math.min(Math.min(Math.max(o,l),Math.max(u,c)),Math.max(h,f));return _<0||_<d?0:d}),ba=(Zr=new Ni,Jr=new Ni,$r=new Ni,ea=new Ni,ta=new Ni,ia=new Ni,na=new Ni,ra=new Array(3),aa=new Array(3),sa=new Array(3),oa=new Array(6),function(e,t){ra[0]=t.halfExtents.x,ra[1]=t.halfExtents.y,ra[2]=t.halfExtents.z,Zr=t.center,Jr=e.o,$r=e.d,Ni.set(ea,t.orientation.m00,t.orientation.m01,t.orientation.m02),Ni.set(ta,t.orientation.m03,t.orientation.m04,t.orientation.m05),Ni.set(ia,t.orientation.m06,t.orientation.m07,t.orientation.m08),Ni.subtract(na,Zr,Jr),aa[0]=Ni.dot(ea,$r),aa[1]=Ni.dot(ta,$r),aa[2]=Ni.dot(ia,$r),sa[0]=Ni.dot(ea,na),sa[1]=Ni.dot(ta,na),sa[2]=Ni.dot(ia,na);for(var i=0;i<3;++i){if(0===aa[i]){if(0<-sa[i]-ra[i]||-sa[i]+ra[i]<0)return 0;aa[i]=1e-7}oa[2*i+0]=(sa[i]+ra[i])/aa[i],oa[2*i+1]=(sa[i]-ra[i])/aa[i]}var n=Math.max(Math.max(Math.min(oa[0],oa[1]),Math.min(oa[2],oa[3])),Math.min(oa[4],oa[5])),r=Math.min(Math.min(Math.max(oa[0],oa[1]),Math.max(oa[2],oa[3])),Math.max(oa[4],oa[5]));return r<0||r<n||n<0?0:n}),xa=(la=new Ni,ua=new Ni,ca=new Ni,ha=new Ni,function(e,t){return Ni.subtract(la,e.center,e.halfExtents),Ni.add(ua,e.center,e.halfExtents),Ni.subtract(ca,t.center,t.halfExtents),Ni.add(ha,t.center,t.halfExtents),la.x<=ha.x&&ua.x>=ca.x&&la.y<=ha.y&&ua.y>=ca.y&&la.z<=ha.z&&ua.z>=ca.z});function Sa(e,t,i,n,r,a){Ni.set(a[0],e.x+i.x*t.x+n.x*t.y+r.x*t.z,e.y+i.y*t.x+n.y*t.y+r.y*t.z,e.z+i.z*t.x+n.z*t.y+r.z*t.z),Ni.set(a[1],e.x-i.x*t.x+n.x*t.y+r.x*t.z,e.y-i.y*t.x+n.y*t.y+r.y*t.z,e.z-i.z*t.x+n.z*t.y+r.z*t.z),Ni.set(a[2],e.x+i.x*t.x-n.x*t.y+r.x*t.z,e.y+i.y*t.x-n.y*t.y+r.y*t.z,e.z+i.z*t.x-n.z*t.y+r.z*t.z),Ni.set(a[3],e.x+i.x*t.x+n.x*t.y-r.x*t.z,e.y+i.y*t.x+n.y*t.y-r.y*t.z,e.z+i.z*t.x+n.z*t.y-r.z*t.z),Ni.set(a[4],e.x-i.x*t.x-n.x*t.y-r.x*t.z,e.y-i.y*t.x-n.y*t.y-r.y*t.z,e.z-i.z*t.x-n.z*t.y-r.z*t.z),Ni.set(a[5],e.x+i.x*t.x-n.x*t.y-r.x*t.z,e.y+i.y*t.x-n.y*t.y-r.y*t.z,e.z+i.z*t.x-n.z*t.y-r.z*t.z),Ni.set(a[6],e.x-i.x*t.x+n.x*t.y-r.x*t.z,e.y-i.y*t.x+n.y*t.y-r.y*t.z,e.z-i.z*t.x+n.z*t.y-r.z*t.z),Ni.set(a[7],e.x-i.x*t.x-n.x*t.y+r.x*t.z,e.y-i.y*t.x-n.y*t.y+r.y*t.z,e.z-i.z*t.x-n.z*t.y+r.z*t.z)}function Ta(e,t){for(var i=Ni.dot(t,e[0]),n=i,r=1;r<8;++r){var a=Ni.dot(t,e[r]);i=a<i?a:i,n=n<a?a:n}return[i,n]}function wa(e,t){var i=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),n=Ni.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1}function Ea(e,t){for(var i=0;i<t.planes.length;i++)if(-1===wa(e,t.planes[i]))return 0;return 1}var Aa,Ca,ka=function(){for(var s=new Array(15),e=0;e<15;e++)s[e]=new Ni(0,0,0);for(var o=new Array(8),l=new Array(8),t=0;t<8;t++)o[t]=new Ni(0,0,0),l[t]=new Ni(0,0,0);var u=new Ni,c=new Ni;return function(e,t){Ni.set(s[0],1,0,0),Ni.set(s[1],0,1,0),Ni.set(s[2],0,0,1),Ni.set(s[3],t.orientation.m00,t.orientation.m01,t.orientation.m02),Ni.set(s[4],t.orientation.m03,t.orientation.m04,t.orientation.m05),Ni.set(s[5],t.orientation.m06,t.orientation.m07,t.orientation.m08);for(var i=0;i<3;++i)Ni.cross(s[6+3*i+0],s[i],s[0]),Ni.cross(s[6+3*i+1],s[i],s[1]),Ni.cross(s[6+3*i+1],s[i],s[2]);Ni.subtract(u,e.center,e.halfExtents),Ni.add(c,e.center,e.halfExtents),function(e,t,i){Ni.set(i[0],e.x,t.y,t.z),Ni.set(i[1],e.x,t.y,e.z),Ni.set(i[2],e.x,e.y,t.z),Ni.set(i[3],e.x,e.y,e.z),Ni.set(i[4],t.x,t.y,t.z),Ni.set(i[5],t.x,t.y,e.z),Ni.set(i[6],t.x,e.y,t.z),Ni.set(i[7],t.x,e.y,e.z)}(u,c,o),Sa(t.center,t.halfExtents,s[3],s[4],s[5],l);for(var n=0;n<15;++n){var r=Ta(o,s[n]),a=Ta(l,s[n]);if(a[0]>r[1]||r[0]>a[1])return 0}return 1}}(),Ra=function(){for(var u=new Array(8),c=0,h=0,e=0;e<u.length;e++)u[e]=new Ni(0,0,0);return function(e,t){for(var i=0,n=!1,r=0;r<t.planes.length;r++){if(-1===(i=wa(e,t.planes[r])))return 0;1===i&&(n=!0)}if(!n)return 1;for(var a=0;a<t.vertices.length;a++)Ni.subtract(u[a],t.vertices[a],e.center);for(var s=h=c=0;s<t.vertices.length;s++)u[s].x>e.halfExtents.x?c++:u[s].x<-e.halfExtents.x&&h++;if(c===t.vertices.length||h===t.vertices.length)return 0;for(var o=h=c=0;o<t.vertices.length;o++)u[o].y>e.halfExtents.y?c++:u[o].y<-e.halfExtents.y&&h++;if(c===t.vertices.length||h===t.vertices.length)return 0;for(var l=h=c=0;l<t.vertices.length;l++)u[l].z>e.halfExtents.z?c++:u[l].z<-e.halfExtents.z&&h++;return c===t.vertices.length||h===t.vertices.length?0:1}}(),Oa=(Aa=new Ni(0,0,0),Ca=new an,function(e,t){return Ni.subtract(Aa,t,e.center),Ni.transformMat3(Aa,Aa,an.transpose(Ca,e.orientation)),function(e,t){return Math.abs(e.x)<t.x&&Math.abs(e.y)<t.y&&Math.abs(e.z)<t.z}(Aa,e.halfExtents)}),Ma=function(e,t){var i=e.halfExtents.x*Ia(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*Ia(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*Ia(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),n=Ni.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1};function Ia(e,t,i,n){return Math.abs(e.x*t+e.y*i+e.z*n)}function Ba(e,t){for(var i=0;i<t.planes.length;i++)if(-1===Ma(e,t.planes[i]))return 0;return 1}function La(e,t){var i=Ni.dot(t.n,e.center),n=e.radius*t.n.length();return i+n<t.d?-1:i-n>t.d?0:1}function Pa(e,t){for(var i=0;i<t.planes.length;i++)if(-1===La(e,t.planes[i]))return 0;return 1}function Fa(e,t){var i=e.radius+t.radius;return Ni.squaredDistance(e.center,t.center)<i*i}var za,Da,Na,Ua,Va=function(){for(var u=new Array(8),c=0,h=0,f=0,e=0;e<u.length;e++)u[e]=new Ni(0,0,0);function d(e,t,i,n){return e.x*t+e.y*i+e.z*n}return function(e,t){for(var i=0,n=!1,r=0;r<t.planes.length;r++){if(-1===(i=Ma(e,t.planes[r])))return 0;1===i&&(n=!0)}if(!n)return 1;for(var a=0;a<t.vertices.length;a++)Ni.subtract(u[a],t.vertices[a],e.center);for(var s=f=h=0;s<t.vertices.length;s++)(c=d(u[s],e.orientation.m00,e.orientation.m01,e.orientation.m02))>e.halfExtents.x?h++:c<-e.halfExtents.x&&f++;if(h===t.vertices.length||f===t.vertices.length)return 0;for(var o=f=h=0;o<t.vertices.length;o++)(c=d(u[o],e.orientation.m03,e.orientation.m04,e.orientation.m05))>e.halfExtents.y?h++:c<-e.halfExtents.y&&f++;if(h===t.vertices.length||f===t.vertices.length)return 0;for(var l=f=h=0;l<t.vertices.length;l++)(c=d(u[l],e.orientation.m06,e.orientation.m07,e.orientation.m08))>e.halfExtents.z?h++:c<-e.halfExtents.z&&f++;return h===t.vertices.length||f===t.vertices.length?0:1}}(),Ga=function(){for(var s=new Array(15),e=0;e<15;e++)s[e]=new Ni(0,0,0);for(var o=new Array(8),l=new Array(8),t=0;t<8;t++)o[t]=new Ni(0,0,0),l[t]=new Ni(0,0,0);return function(e,t){Ni.set(s[0],e.orientation.m00,e.orientation.m01,e.orientation.m02),Ni.set(s[1],e.orientation.m03,e.orientation.m04,e.orientation.m05),Ni.set(s[2],e.orientation.m06,e.orientation.m07,e.orientation.m08),Ni.set(s[3],t.orientation.m00,t.orientation.m01,t.orientation.m02),Ni.set(s[4],t.orientation.m03,t.orientation.m04,t.orientation.m05),Ni.set(s[5],t.orientation.m06,t.orientation.m07,t.orientation.m08);for(var i=0;i<3;++i)Ni.cross(s[6+3*i+0],s[i],s[0]),Ni.cross(s[6+3*i+1],s[i],s[1]),Ni.cross(s[6+3*i+1],s[i],s[2]);Sa(e.center,e.halfExtents,s[0],s[1],s[2],o),Sa(t.center,t.halfExtents,s[3],s[4],s[5],l);for(var n=0;n<15;++n){var r=Ta(o,s[n]),a=Ta(l,s[n]);if(a[0]>r[1]||r[0]>a[1])return 0}return 1}}(),Ha=(za=new Ni(0,0,0),Da=[1,-1,1,-1,1,-1],function(e,t){for(var i=0;i<6;i++){var n=t.planes[i],r=e.radius,a=e.center,s=n.n,o=n.d,l=Ni.dot(s,a);if(l+r<o)return 0;if(!(o<l-r)){Ni.add(za,a,Ni.multiplyScalar(za,s,r));for(var u=0;u<6;u++)if(u!==i&&u!==i+Da[i]){var c=t.planes[u];if(Ni.dot(c.n,za)<c.d)return 0}}}return 1}),Wa=(Na=new Ni,function(e,t){return Ar(Na,e.center,t),Ni.squaredDistance(e.center,Na)<e.radius*e.radius}),qa=(Ua=new Ni,function(e,t){return Cr(Ua,e.center,t),Ni.squaredDistance(e.center,Ua)<e.radius*e.radius}),ja={ray_sphere:ya,ray_aabb:ga,ray_obb:ba,ray_plane:da,ray_triangle:pa,line_plane:_a,line_triangle:va,line_quad:ma,sphere_sphere:Fa,sphere_aabb:Wa,sphere_obb:qa,sphere_plane:La,sphere_frustum:Pa,sphere_frustum_accurate:Ha,aabb_aabb:xa,aabb_obb:ka,aabb_plane:wa,aabb_frustum:Ea,aabb_frustum_accurate:Ra,obb_obb:Ga,obb_plane:Ma,obb_frustum:Ba,obb_frustum_accurate:Va,obb_point:Oa,resolve:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:null,r=e._type,a=t._type,s=this[r|a];return r<a?s(e,t,n):s(t,e,n)}};ja[vr.SHAPE_RAY|vr.SHAPE_SPHERE]=ya,ja[vr.SHAPE_RAY|vr.SHAPE_AABB]=ga,ja[vr.SHAPE_RAY|vr.SHAPE_OBB]=ba,ja[vr.SHAPE_RAY|vr.SHAPE_PLANE]=da,ja[vr.SHAPE_RAY|vr.SHAPE_TRIANGLE]=pa,ja[vr.SHAPE_LINE|vr.SHAPE_PLANE]=_a,ja[vr.SHAPE_LINE|vr.SHAPE_TRIANGLE]=va,ja[vr.SHAPE_SPHERE]=Fa,ja[vr.SHAPE_SPHERE|vr.SHAPE_AABB]=Wa,ja[vr.SHAPE_SPHERE|vr.SHAPE_OBB]=qa,ja[vr.SHAPE_SPHERE|vr.SHAPE_PLANE]=La,ja[vr.SHAPE_SPHERE|vr.SHAPE_FRUSTUM]=Pa,ja[vr.SHAPE_SPHERE|vr.SHAPE_FRUSTUM_ACCURATE]=Ha,ja[vr.SHAPE_AABB]=xa,ja[vr.SHAPE_AABB|vr.SHAPE_OBB]=ka,ja[vr.SHAPE_AABB|vr.SHAPE_PLANE]=wa,ja[vr.SHAPE_AABB|vr.SHAPE_FRUSTUM]=Ea,ja[vr.SHAPE_AABB|vr.SHAPE_FRUSTUM_ACCURATE]=Ra,ja[vr.SHAPE_OBB]=Ga,ja[vr.SHAPE_OBB|vr.SHAPE_PLANE]=Ma,ja[vr.SHAPE_OBB|vr.SHAPE_FRUSTUM]=Ba,ja[vr.SHAPE_OBB|vr.SHAPE_FRUSTUM_ACCURATE]=Va;var Xa=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:-1;y(this,s),this.s=void 0,this.e=void 0,this._type=void 0,this._type=vr.SHAPE_LINE,this.s=new Ni(e,t,i),this.e=new Ni(n,r,a)}return l(s,null,[{key:"create",value:function(e,t,i,n,r,a){return new s(e,t,i,n,r,a)}},{key:"clone",value:function(e){return new s(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)}},{key:"copy",value:function(e,t){return Ni.copy(e.s,t.s),Ni.copy(e.e,t.e),e}},{key:"fromPoints",value:function(e,t,i){return Ni.copy(e.s,t),Ni.copy(e.e,i),e}},{key:"set",value:function(e,t,i,n,r,a,s){return e.s.x=t,e.s.y=i,e.s.z=n,e.e.x=r,e.e.y=a,e.e.z=s,e}},{key:"len",value:function(e){return Ni.distance(e.s,e.e)}}]),l(s,[{key:"length",value:function(){return Ni.distance(this.s,this.e)}}]),s}(),Ya=new Ni(0,0,0),Ka=new Ni(0,0,0),Qa=cc.mat4(),Za=cc.v4(),Ja=function(){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;y(this,r),this.n=void 0,this.d=void 0,this._type=void 0,this._type=vr.SHAPE_PLANE,this.n=new Ni(e,t,i),this.d=n}return l(r,null,[{key:"create",value:function(e,t,i,n){return new r(e,t,i,n)}},{key:"clone",value:function(e){return new r(e.n.x,e.n.y,e.n.z,e.d)}},{key:"copy",value:function(e,t){return Ni.copy(e.n,t.n),e.d=t.d,e}},{key:"fromPoints",value:function(e,t,i,n){return Ni.subtract(Ya,i,t),Ni.subtract(Ka,n,t),Ni.normalize(e.n,Ni.cross(e.n,Ya,Ka)),e.d=Ni.dot(e.n,t),e}},{key:"set",value:function(e,t,i,n,r){return e.n.x=t,e.n.y=i,e.n.z=n,e.d=r,e}},{key:"fromNormalAndPoint",value:function(e,t,i){return Ni.copy(e.n,t),e.d=Ni.dot(t,i),e}},{key:"normalize",value:function(e,t){var i=t.n.length();return Ni.normalize(e.n,t.n),0<i&&(e.d=t.d/i),e}}]),l(r,[{key:"transform",value:function(e){Pn.invert(Qa,e),Pn.transpose(Qa,Qa),Xi.set(Za,this.n.x,this.n.y,this.n.z,this.d),Xi.transformMat4(Za,Za,Qa),Ni.set(this.n,Za.x,Za.y,Za.z),this.d=Za.w}}]),r}(),$a=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:-1;y(this,s),this.o=void 0,this.d=void 0,this._type=void 0,this._type=vr.SHAPE_RAY,this.o=new Ni(e,t,i),this.d=new Ni(n,r,a)}return l(s,null,[{key:"create",value:function(e,t,i,n,r,a){return new s(0<arguments.length&&void 0!==e?e:0,1<arguments.length&&void 0!==t?t:0,2<arguments.length&&void 0!==i?i:0,3<arguments.length&&void 0!==n?n:0,4<arguments.length&&void 0!==r?r:0,5<arguments.length&&void 0!==a?a:1)}},{key:"clone",value:function(e){return new s(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)}},{key:"copy",value:function(e,t){return Ni.copy(e.o,t.o),Ni.copy(e.d,t.d),e}},{key:"fromPoints",value:function(e,t,i){return Ni.copy(e.o,t),Ni.normalize(e.d,Ni.subtract(e.d,i,t)),e}},{key:"set",value:function(e,t,i,n,r,a,s){return e.o.x=t,e.o.y=i,e.o.z=n,e.d.x=r,e.d.y=a,e.d.z=s,e}}]),s}(),es=function(){function u(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:1,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0;y(this,u),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=vr.SHAPE_TRIANGLE,this.a=new Ni(e,t,i),this.b=new Ni(n,r,a),this.c=new Ni(s,o,l)}return l(u,null,[{key:"create",value:function(e,t,i,n,r,a,s,o,l){return new u(0<arguments.length&&void 0!==e?e:1,1<arguments.length&&void 0!==t?t:0,2<arguments.length&&void 0!==i?i:0,3<arguments.length&&void 0!==n?n:0,4<arguments.length&&void 0!==r?r:0,5<arguments.length&&void 0!==a?a:0,6<arguments.length&&void 0!==s?s:0,7<arguments.length&&void 0!==o?o:0,8<arguments.length&&void 0!==l?l:1)}},{key:"clone",value:function(e){return new u(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)}},{key:"copy",value:function(e,t){return Ni.copy(e.a,t.a),Ni.copy(e.b,t.b),Ni.copy(e.c,t.c),e}},{key:"fromPoints",value:function(e,t,i,n){return Ni.copy(e.a,t),Ni.copy(e.b,i),Ni.copy(e.c,n),e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,u){return e.a.x=t,e.a.y=i,e.a.z=n,e.b.x=r,e.b.y=a,e.b.z=s,e.c.x=o,e.c.y=l,e.c.z=u,e}}]),u}(),ts=new Ni;function is(e){return Math.max(Math.max(e.x,e.y),e.z)}function ns(e,t,i){us.m00=Math.abs(i.m00),us.m01=Math.abs(i.m01),us.m02=Math.abs(i.m02),us.m03=Math.abs(i.m04),us.m04=Math.abs(i.m05),us.m05=Math.abs(i.m06),us.m06=Math.abs(i.m08),us.m07=Math.abs(i.m09),us.m08=Math.abs(i.m10),Ni.transformMat3(e,t,us)}var rs=function(){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1;y(this,r),this.center=void 0,this.radius=void 0,this._type=void 0,this._type=vr.SHAPE_SPHERE,this.center=new Ni(e,t,i),this.radius=n}return l(r,null,[{key:"create",value:function(e,t,i,n){return new r(e,t,i,n)}},{key:"clone",value:function(e){return new r(e.center.x,e.center.y,e.center.z,e.radius)}},{key:"copy",value:function(e,t){return Ni.copy(e.center,t.center),e.radius=t.radius,e}},{key:"fromPoints",value:function(e,t,i){return Ni.multiplyScalar(e.center,Ni.add(ts,t,i),.5),e.radius=.5*Ni.subtract(ts,i,t).length(),e}},{key:"set",value:function(e,t,i,n,r){return e.center.x=t,e.center.y=i,e.center.z=n,e.radius=r,e}}]),l(r,[{key:"clone",value:function(){return r.clone(this)}},{key:"copy",value:function(e){return r.copy(this,e)}},{key:"getBoundary",value:function(e,t){Ni.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),Ni.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}},{key:"transform",value:function(e,t,i,n,r){Ni.transformMat4(r.center,this.center,e),r.radius=this.radius*is(n)}},{key:"translateAndRotate",value:function(e,t,i){Ni.transformMat4(i.center,this.center,e)}},{key:"setScale",value:function(e,t){t.radius=this.radius*is(e)}}]),r}(),as=new Ni,ss=new Ni,os=new Ni,ls=new Ni,us=new an,cs=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1;y(this,s),this.center=void 0,this.halfExtents=void 0,this._type=vr.SHAPE_AABB,this.center=new Ni(e,t,i),this.halfExtents=new Ni(n,r,a)}return l(s,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(e,t,i,n,r,a){return new s(e,t,i,n,r,a)}},{key:"clone",value:function(e){return new s(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z)}},{key:"copy",value:function(e,t){return Ni.copy(e.center,t.center),Ni.copy(e.halfExtents,t.halfExtents),e}},{key:"fromPoints",value:function(e,t,i){return Ni.multiplyScalar(e.center,Ni.add(as,t,i),.5),Ni.multiplyScalar(e.halfExtents,Ni.subtract(ss,i,t),.5),e}},{key:"set",value:function(e,t,i,n,r,a,s){return Ni.set(e.center,t,i,n),Ni.set(e.halfExtents,r,a,s),e}},{key:"merge",value:function(e,t,i){return Ni.subtract(as,t.center,t.halfExtents),Ni.subtract(ss,i.center,i.halfExtents),Ni.add(os,t.center,t.halfExtents),Ni.add(ls,i.center,i.halfExtents),Ni.max(ls,os,ls),Ni.min(os,as,ss),s.fromPoints(e,os,ls)}},{key:"transform",value:function(e,t,i){return Ni.transformMat4(e.center,t.center,i),ns(e.halfExtents,t.halfExtents,i),e}}]),l(s,[{key:"getBoundary",value:function(e,t){Ni.subtract(e,this.center,this.halfExtents),Ni.add(t,this.center,this.halfExtents)}},{key:"transform",value:function(e,t,i,n,r){Ni.transformMat4(r.center,this.center,e),ns(r.halfExtents,this.halfExtents,e)}},{key:"clone",value:function(){return s.clone(this)}},{key:"copy",value:function(e){return s.copy(this,e)}}]),s}(),hs=new Ni,fs=new Ni,ds=new an,_s=function(){function p(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:1,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0,u=9<arguments.length&&void 0!==arguments[9]?arguments[9]:0,c=10<arguments.length&&void 0!==arguments[10]?arguments[10]:1,h=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,f=12<arguments.length&&void 0!==arguments[12]?arguments[12]:0,d=13<arguments.length&&void 0!==arguments[13]?arguments[13]:0,_=14<arguments.length&&void 0!==arguments[14]?arguments[14]:1;y(this,p),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=vr.SHAPE_OBB,this.center=new Ni(e,t,i),this.halfExtents=new Ni(n,r,a),this.orientation=new an(s,o,l,u,c,h,f,d,_)}return l(p,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(e,t,i,n,r,a,s,o,l,u,c,h,f,d,_){return new p(e,t,i,n,r,a,s,o,l,u,c,h,f,d,_)}},{key:"clone",value:function(e){return new p(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)}},{key:"copy",value:function(e,t){return Ni.copy(e.center,t.center),Ni.copy(e.halfExtents,t.halfExtents),an.copy(e.orientation,t.orientation),e}},{key:"fromPoints",value:function(e,t,i){return Ni.multiplyScalar(e.center,Ni.add(hs,t,i),.5),Ni.multiplyScalar(e.halfExtents,Ni.subtract(fs,i,t),.5),an.identity(e.orientation),e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,u,c,h,f,d,_,p){return Ni.set(e.center,t,i,n),Ni.set(e.halfExtents,r,a,s),an.set(e.orientation,o,l,u,c,h,f,d,_,p),e}}]),l(p,[{key:"getBoundary",value:function(e,t){!function(e,t,i){ds.m00=Math.abs(i.m00),ds.m01=Math.abs(i.m01),ds.m02=Math.abs(i.m02),ds.m03=Math.abs(i.m03),ds.m04=Math.abs(i.m04),ds.m05=Math.abs(i.m05),ds.m06=Math.abs(i.m06),ds.m07=Math.abs(i.m07),ds.m08=Math.abs(i.m08),Ni.transformMat3(e,t,ds)}(hs,this.halfExtents,this.orientation),Ni.subtract(e,this.center,hs),Ni.add(t,this.center,hs)}},{key:"transform",value:function(e,t,i,n,r){Ni.transformMat4(r.center,this.center,e),an.fromQuat(r.orientation,i),Ni.multiply(r.halfExtents,this.halfExtents,n)}},{key:"translateAndRotate",value:function(e,t,i){Ni.transformMat4(i.center,this.center,e),an.fromQuat(i.orientation,t)}},{key:"setScale",value:function(e,t){Ni.multiply(t.halfExtents,this.halfExtents,e)}}]),p}(),ps=new Array(8);ps[0]=new Ni(1,1,1),ps[1]=new Ni(-1,1,1),ps[2]=new Ni(-1,-1,1),ps[3]=new Ni(1,-1,1),ps[4]=new Ni(1,1,-1),ps[5]=new Ni(-1,1,-1),ps[6]=new Ni(-1,-1,-1),ps[7]=new Ni(1,-1,-1);var vs,ms=function(){function i(){y(this,i),this.planes=void 0,this.vertices=void 0,this._type=void 0,this._type=vr.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=Ja.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new Ni}return l(i,[{key:"accurate",set:function(e){this._type=e?vr.SHAPE_FRUSTUM_ACCURATE:vr.SHAPE_FRUSTUM}}],[{key:"create",value:function(){return new i}},{key:"clone",value:function(e){return i.copy(new i,e)}},{key:"copy",value:function(e,t){e._type=t._type;for(var i=0;i<6;++i)Ja.copy(e.planes[i],t.planes[i]);for(var n=0;n<8;++n)Ni.copy(e.vertices[n],t.vertices[n]);return e}}]),l(i,[{key:"update",value:function(e,t){if(Ni.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),Ni.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),Ni.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),Ni.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),Ni.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),Ni.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===vr.SHAPE_FRUSTUM_ACCURATE){for(var i=0;i<6;i++){var n=this.planes[i],r=1/n.n.length();Ni.multiplyScalar(n.n,n.n,r),n.d*=r}for(var a=0;a<8;a++)Ni.transformMat4(this.vertices[a],ps[a],t)}}},{key:"transform",value:function(e){if(this._type===vr.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)Ni.transformMat4(this.vertices[t],this.vertices[t],e);Ja.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),Ja.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),Ja.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),Ja.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),Ja.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),Ja.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}}]),i}();ms.createOrtho=(vs=new Ni,function(e,t,i,n,r,a){var s=t/2,o=i/2;Ni.set(vs,s,o,n),Ni.transformMat4(e.vertices[0],vs,a),Ni.set(vs,-s,o,n),Ni.transformMat4(e.vertices[1],vs,a),Ni.set(vs,-s,-o,n),Ni.transformMat4(e.vertices[2],vs,a),Ni.set(vs,s,-o,n),Ni.transformMat4(e.vertices[3],vs,a),Ni.set(vs,s,o,r),Ni.transformMat4(e.vertices[4],vs,a),Ni.set(vs,-s,o,r),Ni.transformMat4(e.vertices[5],vs,a),Ni.set(vs,-s,-o,r),Ni.transformMat4(e.vertices[6],vs,a),Ni.set(vs,s,-o,r),Ni.transformMat4(e.vertices[7],vs,a),Ja.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),Ja.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),Ja.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),Ja.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),Ja.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),Ja.fromPoints(e.planes[0],e.vertices[7],e.vertices[5],e.vertices[6])});m4("CircularPool",function(){function n(e,t){y(this,n),this._cursor=void 0,this._data=void 0,this._cursor=0,this._data=new Array(t);for(var i=0;i<t;++i)this._data[i]=e()}return l(n,[{key:"request",value:function(){var e=this._data[this._cursor];return this._cursor=(this._cursor+1)%this._data.length,e}}]),n}());var ys=32,gs=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9];function bs(e){return e<1e5?e<100?e<10?0:1:e<1e4?e<1e3?2:3:4:e<1e7?e<1e6?5:6:e<1e9?e<1e8?7:8:9}function xs(e,t){if(e===t)return 0;if(~~e===e&&~~t===t){if(0===e||0===t)return e<t?-1:1;if(e<0||t<0){if(0<=t)return-1;if(0<=e)return 1;e=-e,t=-t}var i=bs(e),n=bs(t),r=0;return i<n?(e*=gs[n-i-1],t/=10,r=-1):n<i&&(t*=gs[i-n-1],e/=10,r=1),e===t?r:e<t?-1:1}var a=String(e),s=String(t);return a===s?0:a<s?-1:1}function Ss(e,t,i,n){var r=t+1;if(r===i)return 1;if(n(e[r++],e[t])<0){for(;r<i&&n(e[r],e[r-1])<0;)r++;!function(e,t,i){i--;for(;t<i;){var n=e[t];e[t++]=e[i],e[i--]=n}}(e,t,r)}else for(;r<i&&0<=n(e[r],e[r-1]);)r++;return r-t}function Ts(e,t,i,n,r){for(n===t&&n++;n<i;n++){for(var a=e[n],s=t,o=n;s<o;){var l=s+o>>>1;r(a,e[l])<0?o=l:s=1+l}var u=n-s;switch(u){case 3:e[s+3]=e[s+2];case 2:e[s+2]=e[s+1];case 1:e[s+1]=e[s];break;default:for(;0<u;)e[s+u]=e[s+u-1],u--}e[s]=a}}function ws(e,t,i,n,r,a){var s=0,o=0,l=1;if(0<a(e,t[i+r])){for(o=n-r;l<o&&0<a(e,t[i+r+l]);)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o),s+=r,l+=r}else{for(o=r+1;l<o&&a(e,t[i+r-l])<=0;)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o);var u=s;s=r-l,l=r-u}for(s++;s<l;){var c=s+(l-s>>>1);0<a(e,t[i+c])?s=c+1:l=c}return l}function Es(e,t,i,n,r,a){var s=0,o=0,l=1;if(a(e,t[i+r])<0){for(o=r+1;l<o&&a(e,t[i+r-l])<0;)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o);var u=s;s=r-l,l=r-u}else{for(o=n-r;l<o&&0<=a(e,t[i+r+l]);)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o),s+=r,l+=r}for(s++;s<l;){var c=s+(l-s>>>1);a(e,t[i+c])<0?l=c:s=c+1}return l}var As=function(){function i(e,t){y(this,i),this.array=void 0,this.compare=void 0,this.minGallop=void 0,this.length=void 0,this.tmpStorageLength=void 0,this.tmp=void 0,this.stackLength=void 0,this.runStart=void 0,this.runLength=void 0,this.stackSize=void 0,this.array=e,this.compare=t,this.minGallop=7,this.length=e.length,this.tmpStorageLength=256,this.length<512&&(this.tmpStorageLength=this.length>>>1),this.tmp=new Array(this.tmpStorageLength),this.stackLength=this.length<120?5:this.length<1542?10:this.length<119151?19:40,this.runStart=new Array(this.stackLength),this.runLength=new Array(this.stackLength),this.stackSize=0}return l(i,[{key:"pushRun",value:function(e,t){this.runStart[this.stackSize]=e,this.runLength[this.stackSize]=t,this.stackSize+=1}},{key:"mergeRuns",value:function(){for(;1<this.stackSize;){var e=this.stackSize-2;if(1<=e&&this.runLength[e-1]<=this.runLength[e]+this.runLength[e+1]||2<=e&&this.runLength[e-2]<=this.runLength[e]+this.runLength[e-1])this.runLength[e-1]<this.runLength[e+1]&&e--;else if(this.runLength[e]>this.runLength[e+1])break;this.mergeAt(e)}}},{key:"forceMergeRuns",value:function(){for(;1<this.stackSize;){var e=this.stackSize-2;0<e&&this.runLength[e-1]<this.runLength[e+1]&&e--,this.mergeAt(e)}}},{key:"mergeAt",value:function(e){var t=this.compare,i=this.array,n=this.runStart[e],r=this.runLength[e],a=this.runStart[e+1],s=this.runLength[e+1];this.runLength[e]=r+s,e===this.stackSize-3&&(this.runStart[e+1]=this.runStart[e+2],this.runLength[e+1]=this.runLength[e+2]),this.stackSize--;var o=Es(i[a],i,n,r,0,t);n+=o,0!==(r-=o)&&0!==(s=ws(i[n+r-1],i,a,s,s-1,t))&&(r<=s?this.mergeLow(n,r,a,s):this.mergeHigh(n,r,a,s))}},{key:"mergeLow",value:function(e,t,i,n){var r=this.compare,a=this.array,s=this.tmp,o=0;for(o=0;o<t;o++)s[o]=a[e+o];var l=0,u=i,c=e;if(a[c++]=a[u++],0!=--n)if(1!==t){for(var h=this.minGallop;;){var f=0,d=0,_=!1;do{if(r(a[u],s[l])<0){if(a[c++]=a[u++],d++,(f=0)==--n){_=!0;break}}else if(a[c++]=s[l++],f++,d=0,1==--t){_=!0;break}}while((f|d)<h);if(_)break;do{if(0!==(f=Es(a[u],s,l,t,0,r))){for(o=0;o<f;o++)a[c+o]=s[l+o];if(c+=f,l+=f,(t-=f)<=1){_=!0;break}}if(a[c++]=a[u++],0==--n){_=!0;break}if(0!==(d=ws(s[l],a,u,n,0,r))){for(o=0;o<d;o++)a[c+o]=a[u+o];if(c+=d,u+=d,0===(n-=d)){_=!0;break}}if(a[c++]=s[l++],1==--t){_=!0;break}h--}while(7<=f||7<=d);if(_)break;h<0&&(h=0),h+=2}if((this.minGallop=h)<1&&(this.minGallop=1),1===t){for(o=0;o<n;o++)a[c+o]=a[u+o];a[c+n]=s[l]}else{if(0===t)throw new Error("mergeLow preconditions were not respected");for(o=0;o<t;o++)a[c+o]=s[l+o]}}else{for(o=0;o<n;o++)a[c+o]=a[u+o];a[c+n]=s[l]}else for(o=0;o<t;o++)a[c+o]=s[l+o]}},{key:"mergeHigh",value:function(e,t,i,n){var r=this.compare,a=this.array,s=this.tmp,o=0;for(o=0;o<n;o++)s[o]=a[i+o];var l=e+t-1,u=n-1,c=i+n-1,h=0,f=0;if(a[c--]=a[l--],0!=--t)if(1!==n){for(var d=this.minGallop;;){var _=0,p=0,v=!1;do{if(r(s[u],a[l])<0){if(a[c--]=a[l--],_++,(p=0)==--t){v=!0;break}}else if(a[c--]=s[u--],p++,_=0,1==--n){v=!0;break}}while((_|p)<d);if(v)break;do{if(0!==(_=t-Es(s[u],a,e,t,t-1,r))){for(t-=_,f=(c-=_)+1,h=(l-=_)+1,o=_-1;0<=o;o--)a[f+o]=a[h+o];if(0===t){v=!0;break}}if(a[c--]=s[u--],1==--n){v=!0;break}if(0!==(p=n-ws(a[l],s,0,n,n-1,r))){for(n-=p,f=(c-=p)+1,h=(u-=p)+1,o=0;o<p;o++)a[f+o]=s[h+o];if(n<=1){v=!0;break}}if(a[c--]=a[l--],0==--t){v=!0;break}d--}while(7<=_||7<=p);if(v)break;d<0&&(d=0),d+=2}if((this.minGallop=d)<1&&(this.minGallop=1),1===n){for(f=(c-=t)+1,h=(l-=t)+1,o=t-1;0<=o;o--)a[f+o]=a[h+o];a[c]=s[u]}else{if(0===n)throw new Error("mergeHigh preconditions were not respected");for(h=c-(n-1),o=0;o<n;o++)a[h+o]=s[o]}}else{for(f=(c-=t)+1,h=(l-=t)+1,o=t-1;0<=o;o--)a[f+o]=a[h+o];a[c]=s[u]}else for(h=c-(n-1),o=0;o<n;o++)a[h+o]=s[o]}}]),i}();function Cs(e,t,i,n){if(!Array.isArray(e))throw new TypeError("Can only sort arrays");void 0===t&&(t=0),void 0===i&&(i=e.length),void 0===n&&(n=xs);var r=i-t;if(!(r<2)){var a=0;if(r<ys)Ts(e,t,i,t+(a=Ss(e,t,i,n)),n);else{var s=new As(e,n),o=function(e){for(var t=0;ys<=e;)t|=1&e,e>>=1;return e+t}(r);do{if((a=Ss(e,t,i,n))<o){var l=r;o<l&&(l=o),Ts(e,t,t+l,t+a,n),a=l}s.pushRun(t,a),s.mergeRuns(),r-=a,t+=a}while(0!==r);s.forceMergeRuns()}}}for(var ks=m4("FixedArray",function(){function t(e){y(this,t),this._count=void 0,this._data=void 0,this._count=0,this._data=new Array(e)}return l(t,[{key:"_resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=void 0}},{key:"reset",value:function(){for(var e=0;e<this._count;++e)this._data[e]=void 0;this._count=0}},{key:"push",value:function(e){this._count>=this._data.length&&this._resize(2*this._data.length),this._data[this._count]=e,++this._count}},{key:"pop",value:function(){--this._count,this._count<0&&(this._count=0);var e=this._data[this._count];return this._data[this._count]=void 0,e}},{key:"fastRemove",value:function(e){if(!(e>=this._count||e<0)){var t=this._count-1;this._data[e]=this._data[t],this._data[t]=void 0,this._count-=1}}},{key:"indexOf",value:function(e){return this._data.indexOf(e)}},{key:"sort",value:function(e){return Cs(this._data,0,this._count,e)}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),t}()),Rs=m4("Pool",function(){function n(e,t){y(this,n),this._fn=void 0,this._idx=void 0,this._frees=void 0,this._fn=e,this._idx=t-1,this._frees=new Array(t);for(var i=0;i<t;++i)this._frees[i]=e()}return l(n,[{key:"alloc",value:function(){this._idx<0&&this._expand(Math.round(1.2*this._frees.length)+1);var e=this._frees[this._idx];return this._frees.splice(this._idx),--this._idx,e}},{key:"free",value:function(e){++this._idx,this._frees[this._idx]=e}},{key:"clear",value:function(e){for(var t=0;t<=this._idx;t++)e&&e(this._frees[t]);this._frees.splice(0),this._idx=-1}},{key:"_expand",value:function(e){var t=this._frees;this._frees=new Array(e);for(var i=e-t.length,n=0;n<i;++n)this._frees[n]=this._fn();for(var r=i,a=0;r<e;++r,++a)this._frees[r]=t[a];this._idx+=i}}]),n}()),Os=(m4("LinkedArray",function(){function i(e,t){y(this,i),this._fn=void 0,this._count=void 0,this._head=void 0,this._tail=void 0,this._pool=void 0,this._fn=e,this._count=0,this._head=null,this._tail=null,this._pool=new Rs(e,t)}return l(i,[{key:"add",value:function(){var e=this._pool.alloc();return this._tail?(this._tail._next=e)._prev=this._tail:this._head=e,this._tail=e,this._count+=1,e}},{key:"remove",value:function(e){e._prev?e._prev._next=e._next:this._head=e._next,e._next?e._next._prev=e._prev:this._tail=e._prev,e._next=null,e._prev=null,this._pool.free(e),this._count-=1}},{key:"forEach",value:function(e,t){var i=this._head;if(i){t&&(e=e.bind(t));for(var n=0,r=i;i;)r=i._next,e(i,n,this),i=r,++n}}},{key:"head",get:function(){return this._head}},{key:"tail",get:function(){return this._tail}},{key:"length",get:function(){return this._count}}]),i}()),m4("RecyclePool",function(){function n(e,t){y(this,n),this._fn=void 0,this._count=0,this._data=void 0,this._fn=e,this._data=new Array(t);for(var i=0;i<t;++i)this._data[i]=e()}return l(n,[{key:"reset",value:function(){this._count=0}},{key:"resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()}},{key:"add",value:function(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}},{key:"removeAt",value:function(e){if(!(e>=this._count)){var t=this._count-1,i=this._data[e];this._data[e]=this._data[t],this._data[t]=i,this._count-=1}}},{key:"sort",value:function(e){return Cs(this._data,0,this._count,e)}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),n}())),Ms=Array(8),Is=0;Is<8;++Is)Ms[Is]=[];function Bs(e){var t=(65535<e)<<4,i=(255<(e>>>=t))<<3;return t|=i,t|=i=(15<(e>>>=i))<<2,(t|=i=(3<(e>>>=i))<<1)|(e>>>=i)>>1}function Ls(e){var t=function(e){for(var t=16;t<=1<<28;t*=16)if(e<=t)return t;return 0}(e),i=Ms[Bs(t)>>2];return 0<i.length?i.pop():new ArrayBuffer(t)}function Ps(e,t,i,n,r){return Ni.set(e,t.x*i,t.y*n,t.z*r)}m4("TypedArrayPool",{alloc_int8:function(e){var t=new Int8Array(Ls(e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint8:function(e){var t=new Uint8Array(Ls(e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_int16:function(e){var t=new Int16Array(Ls(2*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint16:function(e){var t=new Uint16Array(Ls(2*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_int32:function(e){var t=new Int32Array(Ls(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint32:function(e){var t=new Uint32Array(Ls(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_float32:function(e){var t=new Float32Array(Ls(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_float64:function(e){var t=new Float64Array(Ls(8*e),0,e);return t.length!==e?t.subarray(0,e):t},free:function(e){!function(e){Ms[Bs(e.byteLength)>>2].push(e)}(e.buffer)},reset:function(){Ms=Array(8);for(var e=0;e<8;++e)Ms[e]=[]}});function Fs(){y(this,Fs),this.time=0,this.value=0,this.inTangent=0,this.outTangent=0}var zs=function(){function s(e,t,i,n,r,a){y(this,s),this.minPos=void 0,this.maxPos=void 0,this.boundingBox=void 0,this.capacity=void 0,this.depth=void 0,this.maxDepth=void 0,this.blocks=void 0,this.entries=void 0,this._getBoundingShape=void 0,this.minPos=e,this.maxPos=t,this.boundingBox=cs.fromPoints(cs.create(),e,t),this.capacity=i,this.depth=n,this.maxDepth=r,this._getBoundingShape=a,this.blocks=null,this.entries=new ks(this.capacity)}return l(s,[{key:"addEntry",value:function(e){if(this.blocks){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.addEntry(e)}}else{var a=this._getBoundingShape(e);if(!ja.resolve(this.boundingBox,a))return;this.entries.push(e),this.entries.length>=this.capacity&&this.depth<this.maxDepth&&(this.blocks=Ds.createBlocks(this.minPos,this.maxPos,this.entries,this.capacity,this.depth,this.maxDepth,this._getBoundingShape),this.entries.reset())}}},{key:"removeEntry",value:function(e){if(this.blocks){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.removeEntry(e)}}else this.entries.fastRemove(this.entries.indexOf(e))}},{key:"select",value:function(e,t){if(ja.resolve(this.boundingBox,t))if(this.blocks){var i=this.blocks,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.select(e,t)}}else for(var s=0;s<this.entries.length;s++)e.add(this.entries.data[s])}},{key:"frustumSelect",value:function(e,t){if(ja.aabb_frustum(this.boundingBox,t))if(this.blocks){var i=this.blocks,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.frustumSelect(e,t)}}else for(var s=0;s<this.entries.length;s++)e.add(this.entries.data[s])}}]),s}(),Ds=function(){function c(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:32,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:5;y(this,c),this.blockCapacity=void 0,this.maxDepth=void 0,this.blocks=void 0,this.dynamics=void 0,this._selection=void 0,this._getBoundingShape=void 0,this.blockCapacity=t,this.maxDepth=i,this.blocks=[],this.dynamics=[],this._selection=new Set,this._getBoundingShape=function(){return e._getBoundingShape}}return l(c,null,[{key:"createBlocks",value:function(e,t,i,n,r,a,s){var o=[],l=new Ni;Ni.multiplyScalar(l,Ni.subtract(l,t,e),.5);for(var u=0;u<2;u++)for(var c=0;c<2;c++)for(var h=0;h<2;h++){var f=new Ni,d=new Ni;Ni.add(f,e,Ps(f,l,u,c,h)),Ni.add(d,e,Ps(d,l,u+1,c+1,h+1));for(var _=new zs(f,d,n,r+1,a,s),p=0;p<i.length;p++){var v=(i.data||i)[p];_.addEntry(v)}o.push(_)}return o}}]),l(c,[{key:"build",value:function(e,t){var i=new Ni(1/0,1/0,1/0),n=new Ni(-1/0,-1/0,-1/0),r=new Ni,a=new Ni,s=[];this.dynamics=[];for(var o=0;o<e.length;o++){var l=(e.data||e)[o],u=t(l);u?(u.getBoundary(r,a),Ni.min(i,i,r),Ni.max(n,n,a),s.push(l)):this.dynamics.push(l)}this.blocks=c.createBlocks(i,n,s,this.blockCapacity,0,this.maxDepth,t),this._getBoundingShape=t}},{key:"addEntry",value:function(e){if(this._getBoundingShape(e).shape){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.addEntry(e)}}else this.dynamics.push(e)}},{key:"removeEntry",value:function(e){if(this._getBoundingShape(e).shape){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.removeEntry(e)}}else this.dynamics.splice(this.dynamics.indexOf(e),1)}},{key:"select",value:function(e){this._selection.clear();var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.select(this._selection,e)}var a=this.dynamics,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l;this._selection.add(u)}return this._selection}},{key:"frustumSelect",value:function(e){this._selection.clear();var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.frustumSelect(this._selection,e)}var a=this.dynamics,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l;this._selection.add(u)}return this._selection}}]),c}(),Ns=vt({Default:0,Once:1,Loop:2,PingPong:3,ClampForever:4});si.fastDefine("cc.Keyframe",Fs,{time:0,value:0,inTangent:0,outTangent:0});var Us=function(){function e(){y(this,e),this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return l(e,[{key:"evaluate",value:function(e){return function(e,t){return e*(e*(e*t[0]+t[1])+t[2])+t[3]}(e-this.time,this.coefficient)}}]),e}();var Vs=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;y(this,t),this.keyFrames=void 0,this.preWrapMode=Ns.Loop,this.postWrapMode=Ns.Loop,this.cachedKey=void 0,this.keyFrames=e||[].concat(t.defaultKF),this.cachedKey=new Us}return l(t,[{key:"addKey",value:function(e){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(e)}},{key:"evaluate_slow",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case Ns.Loop:t=Ci(e-n,r-n)+n;break;case Ns.PingPong:t=ki(e-n,r-n)+n;break;case Ns.ClampForever:t=pi(e,n,r)}var a=0;if(t>this.keyFrames[0].time)if(t>=this.keyFrames[this.keyFrames.length-1].time)a=this.keyFrames.length-2;else for(var s=0;s<this.keyFrames.length-1;s++)if(t>=this.keyFrames[0].time&&t<=this.keyFrames[s+1].time){a=s;break}var o=this.keyFrames[a],l=this.keyFrames[a+1],u=Ri(o.time,l.time,t),c=l.time-o.time,h=o.outTangent*c,f=l.inTangent*c,d=u*u,_=d*u,p=_-2*d+u,v=_-d,m=-2*_+3*d;return(2*_-3*d+1)*o.value+p*h+v*f+m*l.value}},{key:"evaluate",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case Ns.Loop:t=Ci(e-n,r-n)+n;break;case Ns.PingPong:t=ki(e-n,r-n)+n;break;case Ns.ClampForever:t=pi(e,n,r)}if(t>=this.cachedKey.time&&t<this.cachedKey.endTime)return this.cachedKey.evaluate(t);var a=this.findIndex(this.cachedKey,t),s=a+1;return s===this.keyFrames.length&&(s-=1),this.calcOptimizedKey(this.cachedKey,a,s),this.cachedKey.evaluate(t)}},{key:"calcOptimizedKey",value:function(e,t,i){var n=this.keyFrames[t],r=this.keyFrames[i];e.index=t,e.time=n.time,e.endTime=r.time;var a=r.time-n.time,s=r.value-n.value,o=1/(a*a),l=n.outTangent*a,u=r.inTangent*a;e.coefficient[0]=(l+u-s-s)*o/a,e.coefficient[1]=(s+s+s-l-l-u)*o,e.coefficient[2]=n.outTangent,e.coefficient[3]=n.value}},{key:"findIndex",value:function(e,t){var i=e.index;if(-1!==i)if(this.keyFrames[i].time<t)for(var n=0;n<3;n++){var r=i+n;if(r+1<this.keyFrames.length&&this.keyFrames[r+1].time>t)return r}else for(var a=0;a<3;a++){var s=i-a;if(0<=s&&this.keyFrames[s-1].time<=t)return s-1}for(var o=0,l=this.keyFrames.length,u=Math.floor((o+l)/2);1<l-o;)this.keyFrames[u].time>=t?l=u:o=u+1,u=Math.floor((o+l)/2);return o}}]),t}();Vs.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],si.fastDefine("cc.AnimationCurve",Vs,{preWrapMode:Ns.Default,postWrapMode:Ns.Default,keyFrames:[]}),or(Xa.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]);var Gs=Object.freeze({distance:fa,enums:vr,intersect:ja,line:Xa,plane:Ja,ray:$a,triangle:es,sphere:rs,aabb:cs,obb:_s,frustum:ms,Octree:Ds,Keyframe:Fs,AnimationCurve:Vs});m4("geometry",Gs);var Hs=/([a-zA-Z0-9--]+|\S)/,Ws=/^[!,.:;'}\]%\?>]/,qs=/([a-zA-Z0-9--]+|\S)$/,js=/[a-zA-Z0-9--]+$/,Xs=/^[a-zA-Z0-9--]/;function Ys(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function Ks(e){var t=e.charCodeAt(0);return 9<=t&&t<=13||32===t||133===t||160===t||5760===t||8192<=t&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function Qs(e,t){var i=e.measureText(t);return i&&i.width||0}function Zs(e,t,i,n){var r=[];if(0===e.length||i<0)return r.push(""),r;for(var a=e;i<t&&1<a.length;){for(var s=a.length*(i/t)|0,o=a.substr(s),l=t-n(o),u=o,c=0,h=0;i<l&&h++<10;)s*=i/l,s|=0,l=t-n(o=a.substr(s));for(h=0;l<=i&&h++<10;){if(o){var f=Hs.exec(o);c=f?f[0].length:1,u=o}s+=c,l=t-n(o=a.substr(s))}0===(s-=c)&&(s=1,u=u.substr(1));var d=a.substr(0,s),_=void 0;Ws.test(u||o)&&(0===(s-=(_=qs.exec(d))?_[0].length:0)&&(s=1),u=a.substr(s),d=a.substr(0,s)),Xs.test(u)&&(_=js.exec(d))&&d!==_[0]&&(s-=_[0].length,u=a.substr(s),d=a.substr(0,s)),0===r.length?r.push(d):0<(d=d.trim()).length&&r.push(d),t=n(a=u||o)}return 0===r.length?r.push(a):0<(a=a.trim()).length&&r.push(a),r}var Js=/^(click)(\s)*=|(param)(\s)*=/,$s=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,eo=m4("HtmlTextParser",function(){function e(){y(this,e),this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}return l(e,[{key:"parse",value:function(e){this._resultObjectArray.length=0;for(var t=this._stack.length=0,i=e.length;t<i;){var n=e.indexOf("<",t);if(n<0)this._stack.pop(),this._processResult(e.substring(t)),t=i;else{this._processResult(e.substring(t,n));var r=e.indexOf(">",t);-1===r?r=n:"/"===e.charAt(n+1)?this._stack.pop():this._addToStack(e.substring(n+1,r)),t=r+1}}return this._resultObjectArray}},{key:"_attributeToObject",value:function(e){var t={},i=(e=e.trim()).match(/^(color|size)(\s)*=/),n="",r=0,a="";if(i){if(n=i[0],""===(e=e.substring(n.length).trim()))return t;switch(r=e.indexOf(" "),n[0]){case"c":t.color=-1<r?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return-1<r&&(a=e.substring(r+1).trim(),t.event=this._processEventHandler(a)),t}if((i=e.match(/^(br(\s)*\/)/))&&0<i[0].length&&(n=i[0].trim()).startsWith("br")&&"/"===n[n.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{newline:!0}}),t;var s="";if((i=e.match(/^(img(\s)*src(\s)*=[^>]+\/)/))&&0<i[0].length&&(n=i[0].trim()).startsWith("img")&&"/"===n[n.length-1]){var o;i=e.match($s);for(var l=!1;i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),o=-1<(r=(s=e.substring(n.length).trim()).indexOf(" "))?s.substr(0,r):s,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=s.substring(r).trim(),"src"===n?(t.isImage=!0,o.endsWith("/")&&(o=o.substring(0,o.length-1)),0===o.indexOf("'")?(l=!0,o=o.substring(1,o.length-1)):0===o.indexOf('"')&&(l=!0,o=o.substring(1,o.length-1)),t.src=o):"height"===n?t.imageHeight=parseInt(o):"width"===n?t.imageWidth=parseInt(o):"click"===n&&(t.event=this._processEventHandler(n+"="+o)),t.event&&"param"===n&&(t.event[n]=o.replace(/^\"|\"$/g,"")),i=e.match($s);return l&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(i=e.match(/^(outline(\s)*[^>]*)/)){var u={color:"#ffffff",width:1};if(e=i[0].substring("outline".length).trim()){var c,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(i=e.match(h);i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),c=-1<(r=(s=e.substring(n.length).trim()).indexOf(" "))?s.substr(0,r):s,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=s.substring(r).trim(),"click"===n?t.event=this._processEventHandler(n+"="+c):"color"===n?u.color=c:"width"===n&&(u.width=parseInt(c)),t.event&&"param"===n&&(t.event[n]=c.replace(/^\"|\"$/g,"")),i=e.match(h)}t.outline=u}if((i=e.match(/^(on|u|b|i)(\s)*/))&&0<i[0].length){switch(n=i[0],e=e.substring(n.length).trim(),n[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t}},{key:"_processEventHandler",value:function(e){for(var t=0,i=new Map,n=e.match(Js),r=!1;n;){var a=n[0],s="";if(r=!1,'"'===(e=e.substring(a.length).trim()).charAt(0))-1<(t=e.indexOf('"',1))&&(s=e.substring(1,t).trim(),r=!0),t++;else if("'"===e.charAt(0))-1<(t=e.indexOf("'",1))&&(s=e.substring(1,t).trim(),r=!0),t++;else{var o=e.match(/(\S)+/);t=(s=o?o[0]:"").length}r&&(i[a=a.substring(0,a.length-1).trim()]=s),n=(e=e.substring(t).trim()).match(Js)}return i}},{key:"_addToStack",value:function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var i=this._stack[this._stack.length-1];for(var n in i)t[n]||(t[n]=i[n]);this._stack.push(t)}}},{key:"_processResult",value:function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),0<this._stack.length?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))}},{key:"_escapeSpecialSymbol",value:function(e){var t=this._specialSymbolArray,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r,s=a[0],o=a[1];e=e.replace(s,o)}return e}}]),e}());var to="__ccclassCache__";function io(e){return e}function no(e,t){return e[t]||(e[t]={})}function ro(i){return function(t){return"function"==typeof t?i(t):function(e){return i(e,t)}}}function ao(e,i,t){return function(t){return function(e){return i(e,t)}}}var so=ao.bind(null,!1);function oo(){return ao.bind(null,!1)}var lo=oo(),uo=oo();function co(e){return no(e,to)}function ho(e,t,i,n,r,a){var s;n&&(s=(s=zt(n))||n);var o=Ne(t[i]||{},s||{});if(r&&(r.get||r.set)){r.get&&(o.get=r.get),r.set&&(o.set=r.set)}else{var l;0;if(r)r.initializer&&(l=function(t){var e;try{e=t()}catch(e){return t}return"object"!==be(e)||null===e?e:t}(r.initializer),!0);else{var u=a.default||(a.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e));u.hasOwnProperty(i)&&(l=u[i],!0)}0,o.default=l}t[i]=o}var fo=ro(function(e,t){var i=Ve(e);i===Object&&(i=null);var n={name:t,extends:i,ctor:e,__ES6__:!0},r=e[to];if(r){var a=r.proto;a&&Ne(n,a),e[to]=void 0}return cc.Class(n)});function _o(e,t,i){var a=null;function n(e,t,i){var n=co(e.constructor);if(n){var r=no(no(n,"proto"),"properties");ho(e.constructor,r,t,a,i,n)}}if(void 0===t)return a=e,n;n(e,t,i)}function po(e,r,a){return e(function(e,t){var i=co(e);if(i){var n=void 0!==a?a:t;no(no(i,"proto"),"editor")[r]=n}},r)}function vo(e){return e(io)}var mo=vo(ro),yo=po(so,"requireComponent"),go=vo(lo),bo=po(uo,"executionOrder"),xo=vo(ro),So=vo(ro),To=vo(lo),wo=vo(lo),Eo=vo(lo);var Ao,Co,ko,Ro,Oo,Mo,Io,Bo=Object.freeze({ccclass:fo,property:_o,executeInEditMode:mo,requireComponent:yo,menu:go,executionOrder:bo,disallowMultiple:xo,playOnFocus:So,inspector:To,icon:wo,help:Eo,mixins:function(){for(var i=[],e=0;e<arguments.length;e++)i[e]=e<0||arguments.length<=e?void 0:arguments[e];return function(e){var t=co(e);t&&(no(t,"proto").mixins=i)}}});m4("_decorator",Bo);var Lo=m4("PrefabInfo",fo("cc.PrefabInfo")((ko=m((Co=function e(){y(this,e),v(this,"root",ko,this),v(this,"asset",Ro,this),v(this,"fileId",Oo,this),v(this,"sync",Mo,this),v(this,"_synced",Io,this)}).prototype,"root",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ro=m(Co.prototype,"asset",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oo=m(Co.prototype,"fileId",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Mo=m(Co.prototype,"sync",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Io=m(Co.prototype,"_synced",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{default:!1,serializable:!1}}}),Ao=Co))||Ao);cc._PrefabInfo=Lo;var Po=new Ni;function Fo(e,t,i,n){n=n||new Ni,e.worldToScreen(t,Po),Po.x=Po.x/cc.view.getScaleX(),Po.y=Po.y/cc.view.getScaleY();var r=i.getComponent("cc.UITransformComponent");if(!r)return n;r.convertToNodeSpaceAR(Po,n);var a=i.getPosition();return n.add(a),n}function zo(e,t,i){return i=i||new Ni,e.worldToScreen(t,i),i.x=i.x/cc.view.getScaleX(),i.y=i.y/cc.view.getScaleY(),i}var Do=m4("convertUtils",{WorldNode3DToLocalNodeUI:Fo,WorldNode3DToWorldNodeUI:zo});cc.pipelineUtils=Do;var No=[];var Uo=m4("CCObject",function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";y(this,t),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}return l(t,null,[{key:"_deferredDestroy",value:function(){for(var e=No.length,t=0;t<e;++t){var i=No[t];1&i._objFlags||i._destroyImmediate()}e===No.length?No.length=0:No.splice(0,e)}}]),l(t,[{key:"destroy",value:function(){return 1&this._objFlags?(cc.warnID(5e3),!1):!(4&this._objFlags)&&(this._objFlags|=4,No.push(this),!0)}},{key:"_destruct",value:function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var i,n=e instanceof cc._BaseNode||e instanceof cc.Component,r=n?"_id":null,a={};for(i in e)if(e.hasOwnProperty(i)){if(i===r)continue;switch(be(e[i])){case"string":a[i]="";break;case"object":case"function":a[i]=null}}if(si._isCCClass(t))for(var s=cc.Class.Attr.getClassAttrs(t),o=t.__props__,l=0;l<o.length;l++){var u=(i=o[l])+cc.Class.Attr.DELIMETER+"default";if(u in s){if(n&&"_id"===i)continue;switch(be(s[u])){case"string":a[i]="";break;case"object":case"function":a[i]=null;break;case"undefined":a[i]=void 0}}}var c="";for(i in a){var h=void 0;h=si.IDENTIFIER_RE.test(i)?"o."+i+"=":"o["+si.escapeForJS(i)+"]=";var f=a[i];""===f&&(f='""'),c+=h+f+";\n"}return Function("o",c)}(this,e),we(e,"__destruct__",t,!0)),t(this)}},{key:"_destroyImmediate",value:function(){1&this._objFlags?cc.errorID(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),t}()),Vo=Uo.prototype;Vo._deserialize=null,Vo._onPreDestroy=null,si.fastDefine("cc.Object",Uo,{_name:"",_objFlags:0}),we(Uo,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),cc.isValid=function(e,t){return"object"===be(e)?!(!e||e._objFlags&(t?5:1)):void 0!==e},cc.Object=Uo;var Go=function(){function e(){y(this,e),this.assignAssetsBy=void 0,this.uuidList=void 0,this.uuidObjList=void 0,this.uuidPropList=void 0,this._stillUseUrl=void 0,this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this._stillUseUrl=ke(!0)}return l(e,[{key:"reset",value:function(){this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,He(this._stillUseUrl)}},{key:"push",value:function(e,t,i,n){n&&(this._stillUseUrl[this.uuidList.length]=!0),this.uuidList.push(i),this.uuidObjList.push(e),this.uuidPropList.push(t)}}]),e}();function Ho(e,t,i,n,r,a){if(t instanceof cc.ValueType){r||e.push("if(prop){");var s=Re(t);e.push("s._deserializeTypedObject(o".concat(i,",prop,").concat(s,");")),r||e.push("}else o"+i+"=null;")}else e.push("if(prop){"),e.push("s._deserializeObjField(o,prop,"+n+",null,"+!!a+");"),e.push("}else o"+i+"=null;")}Go.pool=void 0,Go.pool=new Je(function(e){e.reset()},10),Go.pool.get=function(){return this._get()||new Go};var Wo=function(e,t){for(var i=gt+"type",n=gt+"default",r=gt+"saveUrlAsAsset",a=gt+"formerlySerializedAs",s=Tt(t),o=t.__values__,l=["var prop;"],u=tt.test(Ze(t)),c=0;c<o.length;c++){var h=o[c];0;var f=void 0,d=void 0,_=f=si.IDENTIFIER_RE.test(h)?(d='"'+h+'"',"."+h):"["+(d=si.escapeForJS(h))+"]";if(s[h+a]){var p=s[h+a];_=si.IDENTIFIER_RE.test(p)?"."+p:"["+si.escapeForJS(p)+"]"}l.push("prop=d"+_+";"),l.push("if(typeof ".concat("prop",'!=="undefined"){'));var v=s[h+r],m=si.getDefault(s[h+n]);if(u){var y=void 0,g=s[h+i];if(void 0===m&&g)y=g===cc.String||g===cc.Integer||g===cc.Float||g===cc.Boolean;else{var b=be(m);y="string"===b&&!v||"number"===b||"boolean"===b}y?l.push("o".concat(f,"=prop;")):Ho(l,m,f,d,!0,v)}else l.push("if(typeof ".concat("prop",'!=="object"){')+"o"+f+"=prop;}else{"),Ho(l,m,f,d,!1,v),l.push("}");l.push("}")}(cc.js.isChildClassOf(t,cc._BaseNode)||cc.js.isChildClassOf(t,cc.Component))&&l.push("d._id&&(o._id=d._id);");return"_$erialized"===o[o.length-1]&&(l.push("o._$erialized=JSON.parse(JSON.stringify(d));"),l.push("s._deserializePrimitiveObject(o._$erialized,d);")),Function("s","o","d","k","t",l.join(""))};function qo(e,t,i,n,r){var a;n.hasOwnProperty("__deserialize__")?a=n.__deserialize__:(a=Wo(e,n),we(n,"__deserialize__",a,!0)),a(e,t,i,n,r),t.__postDeserialize&&t.__postDeserialize()}var jo=function(){function a(e,t,i,n,r){y(this,a),this.result=void 0,this.customEnv=void 0,this.deserializedList=void 0,this.deserializedData=void 0,this._classFinder=void 0,this._target=void 0,this._ignoreEditorOnly=void 0,this._idList=void 0,this._idObjList=void 0,this._idPropList=void 0,this.result=e,this.customEnv=n,this.deserializedList=[],this.deserializedData=null,this._classFinder=i,this._idList=[],this._idObjList=[],this._idPropList=[]}return l(a,[{key:"deserialize",value:function(e){if(Array.isArray(e)){var t=e,i=t.length;this.deserializedList.length=i;for(var n=0;n<i;n++){if(t[n])this.deserializedList[n]=this._deserializeObject(t[n],!1)}this.deserializedData=0<i?this.deserializedList[0]:[]}else this.deserializedList.length=1,this.deserializedData=e?this._deserializeObject(e,!1):null,this.deserializedList[0]=this.deserializedData;return function(e){var t,i,n,r=e.deserializedList,a=e._idPropList,s=e._idList,o=e._idObjList;for(e._classFinder&&e._classFinder.onDereferenced,t=0;t<s.length;t++)i=a[t],n=s[t],o[t][i]=r[n]}(this),this.deserializedData}},{key:"_deserializeObject",value:function(e,t,i,n,r){var a,s=null,o=null,l=e.__type__;if("TypedArray"===l){var u=e.array;s=new window[e.ctor](u.length);for(var c=0;c<u.length;++c)s[c]=u[c];return s}if(l){var h=function(){(s=new o)._deserialize?s._deserialize(e.content,f):cc.Class._isCCClass(o)?qo(f,s,e,o,i):f._deserializeTypedObject(s,e,o)};if(!(o=this._classFinder(l,e,n,r)))return this._classFinder===Ke&&cc.deserialize.reportMissingClass(l),null;var f=this;h()}else if(Array.isArray(e)){s=new Array(e.length);for(var d=0;d<e.length;d++)"object"===be(a=e[d])&&a?this._deserializeObjField(s,a,""+d,null,t):s[d]=a}else s={},this._deserializePrimitiveObject(s,e);return s}},{key:"_deserializeObjField",value:function(e,t,i,n,r){var a=t.__id__;if(void 0===a){var s=t.__uuid__;s?this.result.push(e,i,s,r):e[i]=this._deserializeObject(t,r)}else{var o=this.deserializedList[a];o?e[i]=o:(this._idList.push(a),this._idObjList.push(e),this._idPropList.push(i))}}},{key:"_deserializePrimitiveObject",value:function(e,t){for(var i in t)if(t.hasOwnProperty(i)){var n=t[i];"object"!==be(n)?"__type__"!==i&&(e[i]=n):n?this._deserializeObjField(e,n,i):e[i]=null}}},{key:"_deserializeTypedObject",value:function(e,t,i){if(i===cc.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(i===cc.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(i!==cc.Color){if(i===cc.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var n=gt+"default",r=Tt(i),a=i.__props__||Object.keys(e),s=0;s<a.length;s++){var o=a[s],l=t[o];void 0!==l&&t.hasOwnProperty(o)||(l=si.getDefault(r[o+n])),"object"!==be(l)?e[o]=l:l?this._deserializeObjField(e,l,o):e[o]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var u=t.a;e.a=void 0===u?255:u}}}]),a}();function Xo(e,t,i){var n=(i=i||{}).classFinder||Ke,r=i.createAssetRefs||cc.sys.platform===cc.sys.EDITOR_CORE,a=i.customEnv,s=i.ignoreEditorOnly;"string"==typeof e&&(e=JSON.parse(e));var o=!t;t=t||Go.pool.get();var l=jo.pool.get(t,!1,n,a,s);cc.game._isCloning=!0;var u=l.deserialize(e);return cc.game._isCloning=!1,jo.pool.put(l),r&&t.assignAssetsBy(Editor.serialize.asAsset),o&&Go.pool.put(t),u}jo.pool=void 0,jo.pool=new Je(function(e){e.result=null,e.customEnv=null,e.deserializedList.length=0,e.deserializedData=null,e._classFinder=null,e._idList.length=0,e._idObjList.length=0,e._idPropList.length=0},1),jo.pool.get=function(e,t,i,n,r){var a=this._get();return a?(a.result=e,a.customEnv=n,a._classFinder=i,a):new jo(e,t,i,n,r)},Xo.Details=Go,Xo.reportMissingClass=function(e){cc.warnID(5302,e)},cc.deserialize=Xo,m4("deserialize",Xo);var Yo=Uo.Flags.Destroyed,Ko=Uo.Flags.PersistentMask,Qo=[];function Zo(e,t){if(!t){if("object"!==be(e)||Array.isArray(e))return null;if(!e)return null;if(!cc.isValid(e))return null;0}var i;if(e instanceof Uo){if((e=e)._instantiate)return cc.game._isCloning=!0,i=e._instantiate(),cc.game._isCloning=!1,i;if(e instanceof cc.Asset)return null}return cc.game._isCloning=!0,i=Jo(e),cc.game._isCloning=!1,i}function Jo(e,t){if(Array.isArray(e))return null;if(ct(e))return null;var i;if(e._iN$t)i=e._iN$t;else if(e.constructor){i=new e.constructor}else i=Object.create(null);$o(e,i,t);for(var n=0,r=Qo.length;n<r;++n)Qo[n]._iN$t=null;return Qo.length=0,i}function $o(e,t,i){we(e,"_iN$t",t,!0),Qo.push(e);var n=e.constructor;if(cc.Class._isCCClass(n))!function(e,t,i,n){for(var r=e.__values__,a=0;a<r.length;a++){var s=r[a],o=t[s];if("object"===be(o)&&o){var l=i[s];l instanceof yt&&l.constructor===o.constructor?l.set(o):i[s]=o._iN$t||el(o,n)}else i[s]=o}}(n,e,t,i);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var a=e[r];if("object"===be(a)&&a){if(a===t)continue;t[r]=a._iN$t||el(a,i)}else t[r]=a}e instanceof Uo&&(t._objFlags&=Ko)}function el(e,t){if(e instanceof yt)return e.clone();if(e instanceof cc.Asset)return e;var i;if(Array.isArray(e)){var n=e.length;i=new Array(n),e._iN$t=i;for(var r=0;r<n;++r){var a=e[r];"object"===be(a)&&a?i[r]=a._iN$t||el(a,t):i[r]=a}return Qo.push(e),i}if(e._objFlags&Yo)return null;var s=e.constructor;if(cc.Class._isCCClass(s)){if(t)if(t instanceof cc.Component){if(e instanceof cc._BaseNode||e instanceof cc.Component)return e}else if(t instanceof cc._BaseNode)if(e instanceof cc._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof cc.Component&&!e.node.isChildOf(t))return e;i=new s}else if(s===Object)i={};else{if(s)return e;i=Object.create(null)}return $o(e,i,t),i}Zo._clone=Jo,cc.instantiate=Zo,m4("instantiate",Zo),cc._decorator=Bo;var tl=m4("Event",function(){function i(e,t){y(this,i),this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}return l(i,[{key:"unuse",value:function(){this.type=i.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=i.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}},{key:"reuse",value:function(e,t){this.type=e,this.bubbles=t||!1}},{key:"isStopped",value:function(){return this.propagationStopped||this.propagationImmediateStopped}},{key:"getCurrentTarget",value:function(){return this.currentTarget}},{key:"getType",value:function(){return this.type}}]),i}());tl.NO_TYPE="no_type",tl.TOUCH="touch",tl.MOUSE="mouse",tl.KEYBOARD="keyboard",tl.ACCELERATION="acceleration",tl.NONE=0,tl.CAPTURING_PHASE=1,tl.AT_TARGET=2,tl.BUBBLING_PHASE=3,cc.Event=tl;var il=$e.fastRemoveAt;function nl(){}var rl=function(){function e(){y(this,e),this.callback=nl,this.target=void 0,this.once=!1}return l(e,[{key:"set",value:function(e,t,i){this.callback=e,this.target=t,this.once=!!i}}]),e}(),al=new Rs(function(){return new rl},32),sl=function(){function e(){y(this,e),this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}return l(e,[{key:"removeByCallback",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.callback===e&&(al.free(i),il(this.callbackInfos,t),--t)}}},{key:"removeByTarget",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.target===e&&(al.free(i),il(this.callbackInfos,t),--t)}}},{key:"cancel",value:function(e){var t=this.callbackInfos[e];t&&(al.free(t),this.callbackInfos[e]=null),this.containCanceled=!0}},{key:"cancelAll",value:function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(al.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0}},{key:"purgeCanceled",value:function(){for(var e=this.callbackInfos.length-1;0<=e;--e){this.callbackInfos[e]||il(this.callbackInfos,e)}this.containCanceled=!1}},{key:"clear",value:function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}]),e}(),ol=new Rs(function(){return new sl},16),ll=function(){function e(){y(this,e),this._callbackTable=ke(!0)}return l(e,[{key:"on",value:function(e,t,i,n){var r=this._callbackTable[e];r=r||(this._callbackTable[e]=ol.alloc());var a=al.alloc();a.set(t,i,n),r.callbackInfos.push(a)}},{key:"hasEventListener",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:null,r=this._callbackTable[e];if(!r)return!1;var a=r.callbackInfos;if(!t){if(r.isInvoking){var s=a,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if(o){if(l>=s.length)break;u=s[l++]}else{if((l=s.next()).done)break;u=l.value}if(u)return!0}return!1}return 0<a.length}var c=a,h=Array.isArray(c),f=0;for(c=h?c:c[Symbol.iterator]();;){var d;if(h){if(f>=c.length)break;d=c[f++]}else{if((f=c.next()).done)break;d=f.value}var _=d;if(_&&_.callback===t&&_.target===n)return!0}return!1}},{key:"removeAll",value:function(e){if("string"==typeof e){var t=this._callbackTable[e];t&&(t.isInvoking?t.cancelAll():(t.clear(),ol.free(t),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var n=this._callbackTable[i];if(n.isInvoking)for(var r=n.callbackInfos,a=0;a<r.length;++a){var s=r[a];s&&s.target===e&&n.cancel(a)}else n.removeByTarget(e)}}},{key:"off",value:function(e,t,i){var n=this._callbackTable[e];if(n){var r=n.callbackInfos;if(t)for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.callback===t&&s.target===i){n.isInvoking?n.cancel(a):(il(r,a),al.free(s));break}}else this.removeAll(e)}}},{key:"emit",value:function(e){var t=this._callbackTable[e];if(t){var i=!t.isInvoking;t.isInvoking=!0;for(var n=t.callbackInfos,r=arguments.length,a=new Array(1<r?r-1:0),s=1;s<r;s++)a[s-1]=arguments[s];for(var o=0,l=n.length;o<l;++o){var u=n[o];if(u){var c=u.callback,h=u.target;u.once&&this.off(e,c,h),h?c.call.apply(c,[h].concat(a)):c.apply(void 0,a)}}i&&(t.isInvoking=!1,t.containCanceled&&t.purgeCanceled())}}}]),e}();var ul=$e.fastRemove,cl=m4("EventTarget",function(){function r(){return y(this,r),x(this,g(r).apply(this,arguments))}return _(r,ll),l(r,[{key:"on",value:function(e,t,i){if(t){if(!this.hasEventListener(e,t,i)){p(g(r.prototype),"on",this).call(this,e,t,i);var n=i;i&&(n.__eventTargets?n.__eventTargets.push(this):n.node&&n.node.__eventTargets&&n.node.__eventTargets.push(this))}return t}cc.errorID(6800)}},{key:"off",value:function(e,t,i){if(t){p(g(r.prototype),"off",this).call(this,e,t,i);var n=i;i&&(n.__eventTargets?ul(n.__eventTargets,this):n.node&&n.node.__eventTargets&&ul(n.node.__eventTargets,this))}else this.removeAll(e)}},{key:"targetOff",value:function(e){this.removeAll(e)}},{key:"once",value:function(e,t,i){if(t){if(!this.hasEventListener(e,t,i)){p(g(r.prototype),"on",this).call(this,e,t,i,!0);var n=i;i&&(n.__eventTargets?n.__eventTargets.push(this):n.node&&n.node.__eventTargets&&n.node.__eventTargets.push(this))}return t}cc.errorID(6800)}}]),r}());cc.EventTarget=cl;var hl,fl={};fl.LANGUAGE_ENGLISH="en",fl.LANGUAGE_CHINESE="zh",fl.LANGUAGE_FRENCH="fr",fl.LANGUAGE_ITALIAN="it",fl.LANGUAGE_GERMAN="de",fl.LANGUAGE_SPANISH="es",fl.LANGUAGE_DUTCH="du",fl.LANGUAGE_RUSSIAN="ru",fl.LANGUAGE_KOREAN="ko",fl.LANGUAGE_JAPANESE="ja",fl.LANGUAGE_HUNGARIAN="hu",fl.LANGUAGE_PORTUGUESE="pt",fl.LANGUAGE_ARABIC="ar",fl.LANGUAGE_NORWEGIAN="no",fl.LANGUAGE_POLISH="pl",fl.LANGUAGE_TURKISH="tr",fl.LANGUAGE_UKRAINIAN="uk",fl.LANGUAGE_ROMANIAN="ro",fl.LANGUAGE_BULGARIAN="bg",fl.LANGUAGE_UNKNOWN="unknown",fl.OS_IOS="iOS",fl.OS_ANDROID="Android",fl.OS_WINDOWS="Windows",fl.OS_MARMALADE="Marmalade",fl.OS_LINUX="Linux",fl.OS_BADA="Bada",fl.OS_BLACKBERRY="Blackberry",fl.OS_OSX="OS X",fl.OS_WP8="WP8",fl.OS_WINRT="WINRT",fl.OS_UNKNOWN="Unknown",fl.UNKNOWN=-1,fl.WIN32=0,fl.LINUX=1,fl.MACOS=2,fl.ANDROID=3,fl.IPHONE=4,fl.IPAD=5,fl.BLACKBERRY=6,fl.NACL=7,fl.EMSCRIPTEN=8,fl.TIZEN=9,fl.WINRT=10,fl.WP8=11,fl.MOBILE_BROWSER=100,fl.DESKTOP_BROWSER=101,fl.EDITOR_PAGE=102,fl.EDITOR_CORE=103,fl.WECHAT_GAME=104,fl.QQ_PLAY=105,fl.BROWSER_TYPE_WECHAT="wechat",fl.BROWSER_TYPE_WECHAT_GAME="wechatgame",fl.BROWSER_TYPE_WECHAT_GAME_SUB="wechatgamesub",fl.BROWSER_TYPE_QQ_PLAY="qqplay",fl.BROWSER_TYPE_ANDROID="androidbrowser",fl.BROWSER_TYPE_IE="ie",fl.BROWSER_TYPE_QQ="qqbrowser",fl.BROWSER_TYPE_MOBILE_QQ="mqqbrowser",fl.BROWSER_TYPE_UC="ucbrowser",fl.BROWSER_TYPE_UCBS="ucbs",fl.BROWSER_TYPE_360="360browser",fl.BROWSER_TYPE_BAIDU_APP="baiduboxapp",fl.BROWSER_TYPE_BAIDU="baidubrowser",fl.BROWSER_TYPE_MAXTHON="maxthon",fl.BROWSER_TYPE_OPERA="opera",fl.BROWSER_TYPE_OUPENG="oupeng",fl.BROWSER_TYPE_MIUI="miuibrowser",fl.BROWSER_TYPE_FIREFOX="firefox",fl.BROWSER_TYPE_SAFARI="safari",fl.BROWSER_TYPE_CHROME="chrome",fl.BROWSER_TYPE_LIEBAO="liebao",fl.BROWSER_TYPE_QZONE="qzone",fl.BROWSER_TYPE_SOUGOU="sogou",fl.BROWSER_TYPE_UNKNOWN="unknown",fl.isNative=!1,fl.isBrowser="object"===("undefined"==typeof window?"undefined":be(window))&&"object"===("undefined"==typeof document?"undefined":be(document))&&!0,fl.isLittleEndian=(hl=new ArrayBuffer(2),new DataView(hl).setInt16(0,256,!0),256===new Int16Array(hl)[0]);var dl=window,_l=dl.navigator,pl=document,vl=pl.documentElement,ml=_l.userAgent.toLowerCase();fl.isMobile=/mobile|android|iphone|ipad/.test(ml),fl.platform=fl.isMobile?fl.MOBILE_BROWSER:fl.DESKTOP_BROWSER;var yl=_l.language;yl=(yl=yl||_l.browserLanguage)?yl.split("-")[0]:fl.LANGUAGE_ENGLISH,fl.language=yl;var gl=!1,bl=!1,xl="",Sl=0,Tl=/android (\d+(?:\.\d+)+)/i.exec(ml)||/android (\d+(?:\.\d+)+)/i.exec(_l.platform);Tl&&(gl=!0,xl=Tl[1]||"",Sl=parseInt(xl)||0),(Tl=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(ml))?(bl=!0,xl=Tl[2]||"",Sl=parseInt(xl)||0):/(iPhone|iPad|iPod)/.exec(_l.platform)&&(bl=!0,xl="",Sl=0);var wl=fl.OS_UNKNOWN;-1!==_l.appVersion.indexOf("Win")?wl=fl.OS_WINDOWS:bl?wl=fl.OS_IOS:-1!==_l.appVersion.indexOf("Mac")?wl=fl.OS_OSX:-1!==_l.appVersion.indexOf("X11")&&-1===_l.appVersion.indexOf("Linux")?wl=fl.OS_UNIX:gl?wl=fl.OS_ANDROID:-1===_l.appVersion.indexOf("Linux")&&-1===ml.indexOf("ubuntu")||(wl=fl.OS_LINUX),fl.os=wl,fl.osVersion=xl,fl.osMainVersion=Sl,fl.browserType=fl.BROWSER_TYPE_UNKNOWN,Ul=/mqqbrowser|micromessenger|qq|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(ml),"micromessenger"===(Vl=(Ul=(Ul=Ul||/qqbrowser|ucbrowser/i.exec(ml))||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(ml))?Ul[0].toLowerCase():fl.BROWSER_TYPE_UNKNOWN)?Vl=fl.BROWSER_TYPE_WECHAT:"safari"===Vl&&gl?Vl=fl.BROWSER_TYPE_ANDROID:"qq"===Vl&&ml.match(/android.*applewebkit/i)?Vl=fl.BROWSER_TYPE_ANDROID:"trident"===Vl?Vl=fl.BROWSER_TYPE_IE:"360 aphone"===Vl?Vl=fl.BROWSER_TYPE_360:"mxbrowser"===Vl?Vl=fl.BROWSER_TYPE_MAXTHON:"opr/"===Vl&&(Vl=fl.BROWSER_TYPE_OPERA),fl.browserType=Vl,fl.browserVersion="",Nl=(Nl=ml.match(/(mqqbrowser|micromessenger|qq|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui)(mobile)?(browser)?\/?([\d.]+)/i))||ml.match(/(qqbrowser|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i),fl.browserVersion=Nl?Nl[4]:"";var El=window.innerWidth||document.documentElement.clientWidth,Al=window.innerHeight||document.documentElement.clientHeight,Cl=window.devicePixelRatio||1;fl.windowPixelResolution={width:Cl*El,height:Cl*Al},fl._checkWebGLRenderMode=function(){if(cc.game.renderType!==cc.game.RENDER_TYPE_WEBGL)throw new Error("This feature supports WebGL render mode only.")};var kl=document.createElement("canvas");try{var Rl=fl.localStorage=dl.localStorage;Rl.setItem("storage",""),Rl.removeItem("storage"),Rl=null}catch(wr){var Ol=function(){cc.warnID(5200)};fl.localStorage={getItem:Ol,setItem:Ol,removeItem:Ol,clear:Ol}}var Ml=kl.toDataURL("image/webp").startsWith("data:image/webp"),Il=!!kl.getContext("2d"),Bl=!1;if(fl.browserType===fl.BROWSER_TYPE_WECHAT_GAME)Bl=!0;else if(dl.WebGLRenderingContext&&(function e(t,i,n){if(!n)return e(t,i,"webgl")||e(t,i,"experimental-webgl")||e(t,i,"webkit-3d")||e(t,i,"moz-webgl")||null;try{return t.getContext(n,i)}catch(e){return null}}(document.createElement("CANVAS"))&&(Bl=!0),Bl&&fl.os===fl.OS_ANDROID)){var Ll=parseFloat(fl.browserVersion);switch(fl.browserType){case fl.BROWSER_TYPE_MOBILE_QQ:case fl.BROWSER_TYPE_BAIDU:case fl.BROWSER_TYPE_BAIDU_APP:Bl=6.2<=Ll;break;case fl.BROWSER_TYPE_ANDROID:fl.osMainVersion&&5<=fl.osMainVersion&&(Bl=!0);break;case fl.BROWSER_TYPE_CHROME:Bl=30<=Ll;break;case fl.BROWSER_TYPE_UC:Bl=11<Ll;break;case fl.BROWSER_TYPE_360:Bl=!1}}var Pl,Fl=fl.capabilities={canvas:Il,opengl:Bl,webp:Ml};void 0===vl.ontouchstart&&void 0===pl.ontouchstart&&!_l.msPointerEnabled||(Fl.touches=!0),void 0!==vl.onmouseup&&(Fl.mouse=!0),void 0!==vl.onkeyup&&(Fl.keyboard=!0),(dl.DeviceMotionEvent||dl.DeviceOrientationEvent)&&(Fl.accelerometer=!0),Dl=fl.browserType!==fl.BROWSER_TYPE_WECHAT_GAME&&!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),Pl={ONLY_ONE:!1,WEB_AUDIO:Dl,DELAY_CREATE_CTX:!1},fl.os===fl.OS_IOS&&(Pl.USE_LOADER_EVENT="loadedmetadata"),fl.browserType===fl.BROWSER_TYPE_FIREFOX&&(Pl.DELAY_CREATE_CTX=!0,Pl.USE_LOADER_EVENT="canplay"),fl.os===fl.OS_ANDROID&&fl.browserType===fl.BROWSER_TYPE_UC&&(Pl.ONE_SOURCE=!0);try{Pl.WEB_AUDIO&&(Pl._context=null,Object.defineProperty(Pl,"context",{get:function(){return this._context?this._context:this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}}))}catch(C){Pl.WEB_AUDIO=!1,cc.logID(5201)}var zl,Dl,Nl,Ul,Vl,Gl=[];(zl=document.createElement("audio")).canPlayType&&(zl.canPlayType('audio/ogg; codecs="vorbis"')&&Gl.push(".ogg"),zl.canPlayType("audio/mpeg")&&Gl.push(".mp3"),zl.canPlayType('audio/wav; codecs="1"')&&Gl.push(".wav"),zl.canPlayType("audio/mp4")&&Gl.push(".mp4"),zl.canPlayType("audio/x-m4a")&&Gl.push(".m4a")),Pl.format=Gl,fl.__audioSupport=Pl,fl.NetworkType={NONE:0,LAN:1,WWAN:2},fl.getNetworkType=function(){return fl.NetworkType.LAN},fl.getBatteryLevel=function(){return 1},fl.garbageCollect=function(){},fl.dumpRoot=function(){},fl.restartVM=function(){},fl.cleanScript=function(e){},fl.isObjectValid=function(e){return!!e},fl.dump=function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",e+="Using "+(cc.game.renderType===cc.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n",cc.log(e)},fl.openURL=function(e){window.open(e)},fl.now=function(){return Date.now?Date.now():+new Date},cc.sys=fl;var Hl=cc.Enum({JPG:0,PNG:1,TIFF:2,WEBP:3,PVR:4,ETC:5,S3TC:6,ATITC:7,TGA:8,RAWDATA:9,UNKNOWN:10}),Wl=m4("macro",{SUPPORT_TEXTURE_FORMATS:[".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},ImageFormat:Hl,RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,MIN_ZINDEX:-Math.pow(2,15),MAX_ZINDEX:Math.pow(2,15)-1,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,DENSITYDPI_DEVICE:"device-dpi",DENSITYDPI_HIGH:"high-dpi",DENSITYDPI_MEDIUM:"medium-dpi",DENSITYDPI_LOW:"low-dpi",FIX_ARTIFACTS_BY_STRECHING_TEXEL_TMX:!0,DIRECTOR_STATS_POSITION:new Ii(0,0),ENABLE_STACKABLE_ACTIONS:!0,TOUCH_TIMEOUT:5e3,BATCH_VERTEX_COUNT:2e4,ENABLE_TILEDMAP_CULLING:!0,DOWNLOAD_MAX_CONCURRENT:64,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!1,ENABLE_CULLING:!1,CLEANUP_IMAGE_CACHE:!1,SHOW_MESH_WIREFRAME:!1});cc.macro=Wl;var ql={topLeft:cc.v2(0,0),topRight:cc.v2(0,0),top:cc.v2(0,0),bottomLeft:cc.v2(0,0),bottomRight:cc.v2(0,0),bottom:cc.v2(0,0),center:cc.v2(0,0),left:cc.v2(0,0),right:cc.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,n=e.x,r=e.y,a=r+i,s=n+t;this.topLeft.x=n,this.topLeft.y=a,this.topRight.x=s,this.topRight.y=a,this.top.x=n+t/2,this.top.y=a,this.bottomLeft.x=n,this.bottomLeft.y=r,this.bottomRight.x=s,this.bottomRight.y=r,this.bottom.x=n+t/2,this.bottom.y=r,this.center.x=n+t/2,this.center.y=r+i/2,this.left.x=n,this.left.y=r+i/2,this.right.x=s,this.right.y=r+i/2}};cc.visibleRect=ql;var jl,Xl,Yl,Kl,Ql=m4("GFX_MAX_VERTEX_ATTRIBUTES",16),Zl=m4("GFX_MAX_TEXTURE_UNITS",16),Jl=m4("GFX_MAX_ATTACHMENTS",4),$l=m4("GFX_MAX_BUFFER_BINDINGS",24);(Xl=jl=jl||m4("GFXObjectType",{}))[Xl.UNKNOWN=0]="UNKNOWN",Xl[Xl.BUFFER=1]="BUFFER",Xl[Xl.TEXTURE=2]="TEXTURE",Xl[Xl.TEXTURE_VIEW=3]="TEXTURE_VIEW",Xl[Xl.RENDER_PASS=4]="RENDER_PASS",Xl[Xl.FRAMEBUFFER=5]="FRAMEBUFFER",Xl[Xl.SAMPLER=6]="SAMPLER",Xl[Xl.SHADER=7]="SHADER",Xl[Xl.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",Xl[Xl.PIPELINE_STATE=9]="PIPELINE_STATE",Xl[Xl.BINDING_LAYOUT=10]="BINDING_LAYOUT",Xl[Xl.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",Xl[Xl.COMMAND_ALLOCATOR=12]="COMMAND_ALLOCATOR",Xl[Xl.COMMAND_BUFFER=13]="COMMAND_BUFFER",Xl[Xl.QUEUE=14]="QUEUE",Xl[Xl.WINDOW=15]="WINDOW",(Kl=Yl=Yl||m4("GFXStatus",{}))[Kl.UNREADY=0]="UNREADY",Kl[Kl.FAILED=1]="FAILED",Kl[Kl.SUCCESS=2]="SUCCESS";var eu,tu,iu,nu,ru,au,su,ou,lu,uu,cu,hu,fu,du,_u,pu,vu,mu,yu,gu,bu,xu,Su,Tu,wu,Eu,Au,Cu,ku,Ru,Ou,Mu,Iu,Bu,Lu,Pu,Fu,zu,Du,Nu,Uu,Vu,Gu,Hu,Wu,qu,ju,Xu,Yu,Ku,Qu,Zu,Ju,$u,ec,tc,ic,nc,rc,ac,sc,oc,lc,uc,hc,fc,dc,_c,pc=m4("GFXObject",function(){function t(e){y(this,t),this._gfxType=jl.UNKNOWN,this._status=Yl.UNREADY,this._gfxType=e}return l(t,[{key:"gfxType",get:function(){return this._gfxType}},{key:"status",get:function(){return this._status}}]),t}());(tu=eu=eu||m4("GFXAttributeName",{})).ATTR_POSITION="a_position",tu.ATTR_NORMAL="a_normal",tu.ATTR_TANGENT="a_tangent",tu.ATTR_BITANGENT="a_bitangent",tu.ATTR_WEIGHTS="a_weights",tu.ATTR_JOINTS="a_joints",tu.ATTR_COLOR="a_color",tu.ATTR_COLOR1="a_color1",tu.ATTR_COLOR2="a_color2",tu.ATTR_TEX_COORD="a_texCoord",tu.ATTR_TEX_COORD1="a_texCoord1",tu.ATTR_TEX_COORD2="a_texCoord2",tu.ATTR_TEX_COORD3="a_texCoord3",tu.ATTR_TEX_COORD4="a_texCoord4",tu.ATTR_TEX_COORD5="a_texCoord5",tu.ATTR_TEX_COORD6="a_texCoord6",tu.ATTR_TEX_COORD7="a_texCoord7",tu.ATTR_TEX_COORD8="a_texCoord8",tu.ATTR_BATCH_ID="a_batch_id",tu.ATTR_BATCH_UV="a_batch_uv",(nu=iu=iu||m4("GFXType",{}))[nu.UNKNOWN=0]="UNKNOWN",nu[nu.BOOL=1]="BOOL",nu[nu.BOOL2=2]="BOOL2",nu[nu.BOOL3=3]="BOOL3",nu[nu.BOOL4=4]="BOOL4",nu[nu.INT=5]="INT",nu[nu.INT2=6]="INT2",nu[nu.INT3=7]="INT3",nu[nu.INT4=8]="INT4",nu[nu.UINT=9]="UINT",nu[nu.UINT2=10]="UINT2",nu[nu.UINT3=11]="UINT3",nu[nu.UINT4=12]="UINT4",nu[nu.FLOAT=13]="FLOAT",nu[nu.FLOAT2=14]="FLOAT2",nu[nu.FLOAT3=15]="FLOAT3",nu[nu.FLOAT4=16]="FLOAT4",nu[nu.MAT2=17]="MAT2",nu[nu.MAT2X3=18]="MAT2X3",nu[nu.MAT2X4=19]="MAT2X4",nu[nu.MAT3X2=20]="MAT3X2",nu[nu.MAT3=21]="MAT3",nu[nu.MAT3X4=22]="MAT3X4",nu[nu.MAT4X2=23]="MAT4X2",nu[nu.MAT4X3=24]="MAT4X3",nu[nu.MAT4=25]="MAT4",nu[nu.SAMPLER1D=26]="SAMPLER1D",nu[nu.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",nu[nu.SAMPLER2D=28]="SAMPLER2D",nu[nu.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",nu[nu.SAMPLER3D=30]="SAMPLER3D",nu[nu.SAMPLER_CUBE=31]="SAMPLER_CUBE",nu[nu.COUNT=32]="COUNT",(au=ru=ru||m4("GFXFormat",{}))[au.UNKNOWN=0]="UNKNOWN",au[au.A8=1]="A8",au[au.L8=2]="L8",au[au.LA8=3]="LA8",au[au.R8=4]="R8",au[au.R8SN=5]="R8SN",au[au.R8UI=6]="R8UI",au[au.R8I=7]="R8I",au[au.R16F=8]="R16F",au[au.R16UI=9]="R16UI",au[au.R16I=10]="R16I",au[au.R32F=11]="R32F",au[au.R32UI=12]="R32UI",au[au.R32I=13]="R32I",au[au.RG8=14]="RG8",au[au.RG8SN=15]="RG8SN",au[au.RG8UI=16]="RG8UI",au[au.RG8I=17]="RG8I",au[au.RG16F=18]="RG16F",au[au.RG16UI=19]="RG16UI",au[au.RG16I=20]="RG16I",au[au.RG32F=21]="RG32F",au[au.RG32UI=22]="RG32UI",au[au.RG32I=23]="RG32I",au[au.RGB8=24]="RGB8",au[au.SRGB8=25]="SRGB8",au[au.RGB8SN=26]="RGB8SN",au[au.RGB8UI=27]="RGB8UI",au[au.RGB8I=28]="RGB8I",au[au.RGB16F=29]="RGB16F",au[au.RGB16UI=30]="RGB16UI",au[au.RGB16I=31]="RGB16I",au[au.RGB32F=32]="RGB32F",au[au.RGB32UI=33]="RGB32UI",au[au.RGB32I=34]="RGB32I",au[au.RGBA8=35]="RGBA8",au[au.SRGB8_A8=36]="SRGB8_A8",au[au.RGBA8SN=37]="RGBA8SN",au[au.RGBA8UI=38]="RGBA8UI",au[au.RGBA8I=39]="RGBA8I",au[au.RGBA16F=40]="RGBA16F",au[au.RGBA16UI=41]="RGBA16UI",au[au.RGBA16I=42]="RGBA16I",au[au.RGBA32F=43]="RGBA32F",au[au.RGBA32UI=44]="RGBA32UI",au[au.RGBA32I=45]="RGBA32I",au[au.R5G6B5=46]="R5G6B5",au[au.R11G11B10F=47]="R11G11B10F",au[au.RGB5A1=48]="RGB5A1",au[au.RGBA4=49]="RGBA4",au[au.RGB10A2=50]="RGB10A2",au[au.RGB10A2UI=51]="RGB10A2UI",au[au.RGB9E5=52]="RGB9E5",au[au.D16=53]="D16",au[au.D16S8=54]="D16S8",au[au.D24=55]="D24",au[au.D24S8=56]="D24S8",au[au.D32F=57]="D32F",au[au.D32F_S8=58]="D32F_S8",au[au.BC1=59]="BC1",au[au.BC1_ALPHA=60]="BC1_ALPHA",au[au.BC1_SRGB=61]="BC1_SRGB",au[au.BC1_SRGB_ALPHA=62]="BC1_SRGB_ALPHA",au[au.BC2=63]="BC2",au[au.BC2_SRGB=64]="BC2_SRGB",au[au.BC3=65]="BC3",au[au.BC3_SRGB=66]="BC3_SRGB",au[au.BC4=67]="BC4",au[au.BC4_SNORM=68]="BC4_SNORM",au[au.BC5=69]="BC5",au[au.BC5_SNORM=70]="BC5_SNORM",au[au.BC6H_UF16=71]="BC6H_UF16",au[au.BC6H_SF16=72]="BC6H_SF16",au[au.BC7=73]="BC7",au[au.BC7_SRGB=74]="BC7_SRGB",au[au.ETC_RGB8=75]="ETC_RGB8",au[au.ETC2_RGB8=76]="ETC2_RGB8",au[au.ETC2_SRGB8=77]="ETC2_SRGB8",au[au.ETC2_RGB8_A1=78]="ETC2_RGB8_A1",au[au.ETC2_SRGB8_A1=79]="ETC2_SRGB8_A1",au[au.ETC2_RGBA8=80]="ETC2_RGBA8",au[au.ETC2_SRGB8_A8=81]="ETC2_SRGB8_A8",au[au.EAC_R11=82]="EAC_R11",au[au.EAC_R11SN=83]="EAC_R11SN",au[au.EAC_RG11=84]="EAC_RG11",au[au.EAC_RG11SN=85]="EAC_RG11SN",au[au.PVRTC_RGB2=86]="PVRTC_RGB2",au[au.PVRTC_RGBA2=87]="PVRTC_RGBA2",au[au.PVRTC_RGB4=88]="PVRTC_RGB4",au[au.PVRTC_RGBA4=89]="PVRTC_RGBA4",au[au.PVRTC2_2BPP=90]="PVRTC2_2BPP",au[au.PVRTC2_4BPP=91]="PVRTC2_4BPP",(ou=su=su||m4("GFXBufferUsageBit",{}))[ou.NONE=0]="NONE",ou[ou.TRANSFER_SRC=1]="TRANSFER_SRC",ou[ou.TRANSFER_DST=2]="TRANSFER_DST",ou[ou.INDEX=4]="INDEX",ou[ou.VERTEX=8]="VERTEX",ou[ou.UNIFORM=16]="UNIFORM",ou[ou.STORAGE=32]="STORAGE",ou[ou.INDIRECT=64]="INDIRECT",(uu=lu=lu||m4("GFXMemoryUsageBit",{}))[uu.NONE=0]="NONE",uu[uu.DEVICE=1]="DEVICE",uu[uu.HOST=2]="HOST",(hu=cu=cu||m4("GFXBufferFlagBit",{}))[hu.NONE=0]="NONE",hu[hu.BAKUP_BUFFER=4]="BAKUP_BUFFER",(du=fu=fu||m4("GFXBufferAccessBit",{}))[du.NONE=0]="NONE",du[du.READ=1]="READ",du[du.WRITE=2]="WRITE",(pu=_u=_u||m4("GFXPrimitiveMode",{}))[pu.POINT_LIST=0]="POINT_LIST",pu[pu.LINE_LIST=1]="LINE_LIST",pu[pu.LINE_STRIP=2]="LINE_STRIP",pu[pu.LINE_LOOP=3]="LINE_LOOP",pu[pu.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",pu[pu.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",pu[pu.ISO_LINE_LIST=6]="ISO_LINE_LIST",pu[pu.TRIANGLE_LIST=7]="TRIANGLE_LIST",pu[pu.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",pu[pu.TRIANGLE_FAN=9]="TRIANGLE_FAN",pu[pu.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",pu[pu.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",pu[pu.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",pu[pu.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST",(mu=vu=vu||m4("GFXPolygonMode",{}))[mu.FILL=0]="FILL",mu[mu.POINT=1]="POINT",mu[mu.LINE=2]="LINE",(gu=yu=yu||m4("GFXShadeModel",{}))[gu.GOURAND=0]="GOURAND",gu[gu.FLAT=1]="FLAT",(xu=bu=bu||m4("GFXCullMode",{}))[xu.NONE=0]="NONE",xu[xu.FRONT=1]="FRONT",xu[xu.BACK=2]="BACK",(Tu=Su=Su||m4("GFXComparisonFunc",{}))[Tu.NEVER=0]="NEVER",Tu[Tu.LESS=1]="LESS",Tu[Tu.EQUAL=2]="EQUAL",Tu[Tu.LESS_EQUAL=3]="LESS_EQUAL",Tu[Tu.GREATER=4]="GREATER",Tu[Tu.NOT_EQUAL=5]="NOT_EQUAL",Tu[Tu.GREATER_EQUAL=6]="GREATER_EQUAL",Tu[Tu.ALWAYS=7]="ALWAYS",(Eu=wu=wu||m4("GFXStencilOp",{}))[Eu.ZERO=0]="ZERO",Eu[Eu.KEEP=1]="KEEP",Eu[Eu.REPLACE=2]="REPLACE",Eu[Eu.INCR=3]="INCR",Eu[Eu.DECR=4]="DECR",Eu[Eu.INVERT=5]="INVERT",Eu[Eu.INCR_WRAP=6]="INCR_WRAP",Eu[Eu.DECR_WRAP=7]="DECR_WRAP",(Cu=Au=Au||m4("GFXBlendOp",{}))[Cu.ADD=0]="ADD",Cu[Cu.SUB=1]="SUB",Cu[Cu.REV_SUB=2]="REV_SUB",Cu[Cu.MIN=3]="MIN",Cu[Cu.MAX=4]="MAX",(Ru=ku=ku||m4("GFXBlendFactor",{}))[Ru.ZERO=0]="ZERO",Ru[Ru.ONE=1]="ONE",Ru[Ru.SRC_ALPHA=2]="SRC_ALPHA",Ru[Ru.DST_ALPHA=3]="DST_ALPHA",Ru[Ru.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",Ru[Ru.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",Ru[Ru.SRC_COLOR=6]="SRC_COLOR",Ru[Ru.DST_COLOR=7]="DST_COLOR",Ru[Ru.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",Ru[Ru.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",Ru[Ru.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",Ru[Ru.CONSTANT_COLOR=11]="CONSTANT_COLOR",Ru[Ru.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",Ru[Ru.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",Ru[Ru.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA",(Mu=Ou=Ou||m4("GFXColorMask",{}))[Mu.NONE=0]="NONE",Mu[Mu.R=1]="R",Mu[Mu.G=2]="G",Mu[Mu.B=4]="B",Mu[Mu.A=8]="A",Mu[Mu.ALL=15]="ALL",(Bu=Iu=Iu||m4("GFXFilter",{}))[Bu.NONE=0]="NONE",Bu[Bu.POINT=1]="POINT",Bu[Bu.LINEAR=2]="LINEAR",Bu[Bu.ANISOTROPIC=3]="ANISOTROPIC",(Pu=Lu=Lu||m4("GFXAddress",{}))[Pu.WRAP=0]="WRAP",Pu[Pu.MIRROR=1]="MIRROR",Pu[Pu.CLAMP=2]="CLAMP",Pu[Pu.BORDER=3]="BORDER",(zu=Fu=Fu||m4("GFXTextureType",{}))[zu.TEX1D=0]="TEX1D",zu[zu.TEX2D=1]="TEX2D",zu[zu.TEX3D=2]="TEX3D",(Nu=Du=Du||m4("GFXTextureUsageBit",{}))[Nu.NONE=0]="NONE",Nu[Nu.TRANSFER_SRC=1]="TRANSFER_SRC",Nu[Nu.TRANSFER_DST=2]="TRANSFER_DST",Nu[Nu.SAMPLED=4]="SAMPLED",Nu[Nu.STORAGE=8]="STORAGE",Nu[Nu.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",Nu[Nu.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",Nu[Nu.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",Nu[Nu.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT",(Vu=Uu=Uu||m4("GFXSampleCount",{}))[Vu.X1=0]="X1",Vu[Vu.X2=1]="X2",Vu[Vu.X4=2]="X4",Vu[Vu.X8=3]="X8",Vu[Vu.X16=4]="X16",Vu[Vu.X32=5]="X32",Vu[Vu.X64=6]="X64",(Hu=Gu=Gu||m4("GFXTextureFlagBit",{}))[Hu.NONE=0]="NONE",Hu[Hu.GEN_MIPMAP=1]="GEN_MIPMAP",Hu[Hu.CUBEMAP=2]="CUBEMAP",Hu[Hu.BAKUP_BUFFER=4]="BAKUP_BUFFER",(qu=Wu=Wu||m4("GFXTextureViewType",{}))[qu.TV1D=0]="TV1D",qu[qu.TV2D=1]="TV2D",qu[qu.TV3D=2]="TV3D",qu[qu.CUBE=3]="CUBE",qu[qu.TV1D_ARRAY=4]="TV1D_ARRAY",qu[qu.TV2D_ARRAY=5]="TV2D_ARRAY",(Xu=ju=ju||m4("GFXShaderType",{}))[Xu.VERTEX=0]="VERTEX",Xu[Xu.HULL=1]="HULL",Xu[Xu.DOMAIN=2]="DOMAIN",Xu[Xu.GEOMETRY=3]="GEOMETRY",Xu[Xu.FRAGMENT=4]="FRAGMENT",Xu[Xu.COMPUTE=5]="COMPUTE",Xu[Xu.COUNT=6]="COUNT",(Ku=Yu=Yu||m4("GFXBindingType",{}))[Ku.UNKNOWN=0]="UNKNOWN",Ku[Ku.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",Ku[Ku.SAMPLER=2]="SAMPLER",Ku[Ku.STORAGE_BUFFER=3]="STORAGE_BUFFER",(Zu=Qu=Qu||m4("GFXCommandBufferType",{}))[Zu.PRIMARY=0]="PRIMARY",Zu[Zu.SECONDARY=1]="SECONDARY",($u=Ju=Ju||m4("GFXLoadOp",{}))[$u.LOAD=0]="LOAD",$u[$u.CLEAR=1]="CLEAR",$u[$u.DISCARD=2]="DISCARD",(tc=ec=ec||m4("GFXStoreOp",{}))[tc.STORE=0]="STORE",tc[tc.DISCARD=1]="DISCARD",(nc=ic=ic||m4("GFXTextureLayout",{}))[nc.UNDEFINED=0]="UNDEFINED",nc[nc.GENERAL=1]="GENERAL",nc[nc.COLOR_ATTACHMENT_OPTIMAL=2]="COLOR_ATTACHMENT_OPTIMAL",nc[nc.DEPTH_STENCIL_ATTACHMENT_OPTIMAL=3]="DEPTH_STENCIL_ATTACHMENT_OPTIMAL",nc[nc.DEPTH_STENCIL_READONLY_OPTIMAL=4]="DEPTH_STENCIL_READONLY_OPTIMAL",nc[nc.SHADER_READONLY_OPTIMAL=5]="SHADER_READONLY_OPTIMAL",nc[nc.TRANSFER_SRC_OPTIMAL=6]="TRANSFER_SRC_OPTIMAL",nc[nc.TRANSFER_DST_OPTIMAL=7]="TRANSFER_DST_OPTIMAL",nc[nc.PREINITIALIZED=8]="PREINITIALIZED",nc[nc.PRESENT_SRC=9]="PRESENT_SRC",(ac=rc=rc||m4("GFXPipelineBindPoint",{}))[ac.GRAPHICS=0]="GRAPHICS",ac[ac.COMPUTE=1]="COMPUTE",ac[ac.RAY_TRACING=2]="RAY_TRACING",(oc=sc=sc||m4("GFXDynamicState",{}))[oc.VIEWPORT=0]="VIEWPORT",oc[oc.SCISSOR=1]="SCISSOR",oc[oc.LINE_WIDTH=2]="LINE_WIDTH",oc[oc.DEPTH_BIAS=3]="DEPTH_BIAS",oc[oc.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",oc[oc.DEPTH_BOUNDS=5]="DEPTH_BOUNDS",oc[oc.STENCIL_WRITE_MASK=6]="STENCIL_WRITE_MASK",oc[oc.STENCIL_COMPARE_MASK=7]="STENCIL_COMPARE_MASK",(uc=lc=lc||m4("GFXStencilFace",{}))[uc.FRONT=0]="FRONT",uc[uc.BACK=1]="BACK",uc[uc.ALL=2]="ALL",(fc=hc=hc||m4("GFXQueueType",{}))[fc.GRAPHICS=0]="GRAPHICS",fc[fc.COMPUTE=1]="COMPUTE",fc[fc.TRANSFER=2]="TRANSFER",(_c=dc=dc||m4("GFXClearFlag",{}))[_c.NONE=0]="NONE",_c[_c.COLOR=1]="COLOR",_c[_c.DEPTH=2]="DEPTH",_c[_c.STENCIL=4]="STENCIL",_c[_c.DEPTH_STENCIL=6]="DEPTH_STENCIL",_c[_c.ALL=7]="ALL";var vc,mc,yc=m4("GFXTextureSubres",function e(){y(this,e),this.baseMipLevel=0,this.levelCount=1,this.baseArrayLayer=0,this.layerCount=1}),gc=m4("GFXTextureCopy",function e(){y(this,e),this.srcSubres=new yc,this.srcOffset={x:0,y:0,z:0},this.dstSubres=new yc,this.dstOffset={x:0,y:0,z:0},this.extent={width:0,height:0,depth:0}}),bc=m4("GFXBufferTextureCopy",function e(){y(this,e),this.buffOffset=0,this.buffStride=0,this.buffTexHeight=0,this.texOffset={x:0,y:0,z:0},this.texExtent={width:0,height:0,depth:0},this.texSubres=new yc});(mc=vc=vc||m4("GFXFormatType",{}))[mc.NONE=0]="NONE",mc[mc.UNORM=1]="UNORM",mc[mc.SNORM=2]="SNORM",mc[mc.UINT=3]="UINT",mc[mc.INT=4]="INT",mc[mc.UFLOAT=5]="UFLOAT",mc[mc.FLOAT=6]="FLOAT";var xc=m4("GFXFormatInfos",[{name:"UNKNOWN",size:0,count:0,type:vc.NONE,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"A8",size:1,count:1,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"L8",size:1,count:1,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"LA8",size:1,count:2,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8",size:1,count:1,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8SN",size:1,count:1,type:vc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8UI",size:1,count:1,type:vc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8I",size:1,count:1,type:vc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16F",size:2,count:1,type:vc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16UI",size:2,count:1,type:vc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16I",size:2,count:1,type:vc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32F",size:4,count:1,type:vc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32UI",size:4,count:1,type:vc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32I",size:4,count:1,type:vc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8",size:2,count:2,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8SN",size:2,count:2,type:vc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8UI",size:2,count:2,type:vc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8I",size:2,count:2,type:vc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16F",size:4,count:2,type:vc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16UI",size:4,count:2,type:vc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16I",size:4,count:2,type:vc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32F",size:8,count:2,type:vc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32UI",size:8,count:2,type:vc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32I",size:8,count:2,type:vc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8",size:3,count:3,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"SRGB8",size:3,count:3,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8SN",size:3,count:3,type:vc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8UI",size:3,count:3,type:vc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8I",size:3,count:3,type:vc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16F",size:6,count:3,type:vc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16UI",size:6,count:3,type:vc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16I",size:6,count:3,type:vc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32F",size:12,count:3,type:vc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32UI",size:12,count:3,type:vc.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32I",size:12,count:3,type:vc.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8",size:4,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"SRGB8_A8",size:4,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8SN",size:4,count:4,type:vc.SNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8UI",size:4,count:4,type:vc.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8I",size:4,count:4,type:vc.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16F",size:8,count:4,type:vc.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16UI",size:8,count:4,type:vc.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16I",size:8,count:4,type:vc.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32F",size:16,count:4,type:vc.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32UI",size:16,count:4,type:vc.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32I",size:16,count:4,type:vc.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R5G6B5",size:2,count:3,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R11G11B10F",size:4,count:3,type:vc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB5A1",size:2,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA4",size:2,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB10A2",size:2,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB10A2UI",size:2,count:4,type:vc.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB9E5",size:2,count:4,type:vc.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"D16",size:2,count:1,type:vc.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D16S8",size:3,count:2,type:vc.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"D24",size:3,count:1,type:vc.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D24S8",size:4,count:2,type:vc.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"D32F",size:4,count:1,type:vc.FLOAT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D32FS8",size:5,count:2,type:vc.FLOAT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"BC1",size:1,count:3,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_ALPHA",size:1,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_SRGB",size:1,count:3,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_SRGB_ALPHA",size:1,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC2",size:1,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC2_SRGB",size:1,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC3",size:1,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC3_SRGB",size:1,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC4",size:1,count:1,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC4_SNORM",size:1,count:1,type:vc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC5",size:1,count:2,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC5_SNORM",size:1,count:2,type:vc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC6H_UF16",size:1,count:3,type:vc.UFLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC6H_SF16",size:1,count:3,type:vc.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC7",size:1,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC7_SRGB",size:1,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC_RGB8",size:1,count:3,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGB8",size:1,count:3,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8",size:1,count:3,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGB8_A1",size:1,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8_A1",size:1,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGBA8",size:2,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8_A8",size:2,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_R11",size:1,count:1,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_R11SN",size:1,count:1,type:vc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_RG11",size:2,count:2,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_RG11SN",size:2,count:2,type:vc.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGB2",size:2,count:3,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGBA2",size:2,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGB4",size:2,count:3,type:vc.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGBA4",size:2,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC2_2BPP",size:2,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC2_4BPP",size:2,count:4,type:vc.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0}]);function Sc(e,t,i,n){if(!xc[e].isCompressed)return t*i*n*xc[e].size;switch(e){case ru.BC1:case ru.BC1_ALPHA:case ru.BC1_SRGB:case ru.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case ru.BC2:case ru.BC2_SRGB:case ru.BC3:case ru.BC3_SRGB:case ru.BC4:case ru.BC4_SNORM:case ru.BC6H_SF16:case ru.BC6H_UF16:case ru.BC7:case ru.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case ru.BC5:case ru.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(i/4)*32*n;case ru.ETC_RGB8:case ru.ETC2_RGB8:case ru.ETC2_SRGB8:case ru.ETC2_RGB8_A1:case ru.ETC2_SRGB8_A1:case ru.EAC_R11:case ru.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case ru.EAC_RG11:case ru.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case ru.PVRTC_RGB2:case ru.PVRTC_RGBA2:case ru.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/4)*n;case ru.PVRTC_RGB4:case ru.PVRTC_RGBA4:case ru.PVRTC2_4BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/2)*n;default:return 0}}function Tc(e,t,i,n,r){for(var a=0,s=0;s<r;++s)a+=Sc(e,t,i,n),t=Math.max(t>>1,1),i=Math.max(i>>1,1),n=Math.max(n>>1,1);return a}var wc=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function Ec(e){return wc[e]||0}var Ac,Cc,kc,Rc,Oc=Object.freeze({GFX_MAX_VERTEX_ATTRIBUTES:Ql,GFX_MAX_TEXTURE_UNITS:Zl,GFX_MAX_ATTACHMENTS:Jl,GFX_MAX_BUFFER_BINDINGS:$l,get GFXObjectType(){return jl},get GFXStatus(){return Yl},GFXObject:pc,get GFXAttributeName(){return eu},get GFXType(){return iu},get GFXFormat(){return ru},get GFXBufferUsageBit(){return su},get GFXMemoryUsageBit(){return lu},get GFXBufferFlagBit(){return cu},get GFXBufferAccessBit(){return fu},get GFXPrimitiveMode(){return _u},get GFXPolygonMode(){return vu},get GFXShadeModel(){return yu},get GFXCullMode(){return bu},get GFXComparisonFunc(){return Su},get GFXStencilOp(){return wu},get GFXBlendOp(){return Au},get GFXBlendFactor(){return ku},get GFXColorMask(){return Ou},get GFXFilter(){return Iu},get GFXAddress(){return Lu},get GFXTextureType(){return Fu},get GFXTextureUsageBit(){return Du},get GFXSampleCount(){return Uu},get GFXTextureFlagBit(){return Gu},get GFXTextureViewType(){return Wu},get GFXShaderType(){return ju},get GFXBindingType(){return Yu},get GFXCommandBufferType(){return Qu},get GFXLoadOp(){return Ju},get GFXStoreOp(){return ec},get GFXTextureLayout(){return ic},get GFXPipelineBindPoint(){return rc},get GFXDynamicState(){return sc},get GFXStencilFace(){return lc},get GFXQueueType(){return hc},get GFXClearFlag(){return dc},GFXTextureSubres:yc,GFXTextureCopy:gc,GFXBufferTextureCopy:bc,get GFXFormatType(){return vc},GFXFormatInfos:xc,GFXFormatSize:Sc,GFXFormatSurfaceSize:Tc,GFXGetTypeSize:Ec});function Mc(e,t){for(var i=e.length,n=t^i,r=0;4<=i;){var a=255&e.charCodeAt(r)|(255&e.charCodeAt(++r))<<8|(255&e.charCodeAt(++r))<<16|(255&e.charCodeAt(++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),i-=4,++r}switch(i){case 3:n^=(255&e.charCodeAt(r+2))<<16;case 2:n^=(255&e.charCodeAt(r+1))<<8;case 1:n=1540483477*(65535&(n^=255&e.charCodeAt(r)))+((1540483477*(n>>>16)&65535)<<16)}return n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16),(n^=n>>>15)>>>0}mt(ru),(Cc=Ac=Ac||{})[Cc.UNKNOWN=0]="UNKNOWN",Cc[Cc.WEBGL=1]="WEBGL",Cc[Cc.WEBGL2=2]="WEBGL2",(Rc=kc=kc||{})[Rc.COLOR_FLOAT=0]="COLOR_FLOAT",Rc[Rc.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",Rc[Rc.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",Rc[Rc.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",Rc[Rc.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",Rc[Rc.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",Rc[Rc.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",Rc[Rc.FORMAT_D24S8=7]="FORMAT_D24S8",Rc[Rc.FORMAT_ETC1=8]="FORMAT_ETC1",Rc[Rc.FORMAT_ETC2=9]="FORMAT_ETC2",Rc[Rc.FORMAT_DXT=10]="FORMAT_DXT",Rc[Rc.FORMAT_PVRTC=11]="FORMAT_PVRTC",Rc[Rc.FORMAT_ASTC=12]="FORMAT_ASTC",Rc[Rc.MSAA=13]="MSAA",Rc[Rc.COUNT=14]="COUNT";var Ic,Bc=m4("GFXDevice",function(){function e(){y(this,e),this._canvas=null,this._canvas2D=null,this._gfxAPI=Ac.UNKNOWN,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(kc.COUNT),this._queue=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._mainWindow=null,this._cmdAllocator=null,this._maxVertexAttributes=0,this._maxVertexUniformVectors=0,this._maxFragmentUniformVectors=0,this._maxTextureUnits=0,this._maxVertexTextureUnits=0,this._maxUniformBufferBindings=$l,this._maxUniformBlockSize=0,this._maxTextureSize=0,this._maxCubeMapTextureSize=0,this._depthBits=0,this._stencilBits=0,this._colorFmt=ru.UNKNOWN,this._depthStencilFmt=ru.UNKNOWN,this._shaderIdGen=0,this._macros=new Map,this._numDrawCalls=0,this._numTris=0,this._memoryStatus={bufferSize:0,textureSize:0}}return l(e,[{key:"hasFeature",value:function(e){return this._features[e]}},{key:"genShaderId",value:function(){return this._shaderIdGen++}},{key:"defineMacro",value:function(e,t){var i=void 0!==t?t:"";this._macros.set(e,i)}},{key:"canvas",get:function(){return this._canvas}},{key:"canvas2D",get:function(){return this._canvas2D}},{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"devicePixelRatio",get:function(){return this._devicePixelRatio}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"nativeWidth",get:function(){return this._nativeWidth}},{key:"nativeHeight",get:function(){return this._nativeHeight}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"commandAllocator",get:function(){return this._cmdAllocator}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"maxVertexAttributes",get:function(){return this._maxVertexAttributes}},{key:"maxVertexUniformVectors",get:function(){return this._maxVertexUniformVectors}},{key:"maxFragmentUniformVectors",get:function(){return this._maxFragmentUniformVectors}},{key:"maxTextureUnits",get:function(){return this._maxTextureUnits}},{key:"maxVertexTextureUnits",get:function(){return this._maxVertexTextureUnits}},{key:"maxUniformBufferBindings",get:function(){return this._maxUniformBufferBindings}},{key:"maxUniformBlockSize",get:function(){return this._maxUniformBlockSize}},{key:"maxTextureSize",get:function(){return this._maxTextureSize}},{key:"maxCubeMapTextureSize",get:function(){return this._maxCubeMapTextureSize}},{key:"depthBits",get:function(){return this._depthBits}},{key:"stencilBits",get:function(){return this._stencilBits}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"depthStencilFormat",get:function(){return this._depthStencilFmt}},{key:"macros",get:function(){return this._macros}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}}]),e}());function Lc(i,e){e.forEach(function(t){Object.getOwnPropertyNames(t.prototype).forEach(function(e){"constructor"!==e&&Object.defineProperty(i.prototype,e,Object.getOwnPropertyDescriptor(t.prototype,e))})})}var Pc,Fc,zc,Dc,Nc,Uc,Vc,Gc=m4("RawAsset",fo("cc.RawAsset")(Ic=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._uuid=void 0,Object.defineProperty(c(t),"_uuid",{value:"",writable:!0}),t}return _(a,Uo),l(a,null,[{key:"isRawAssetType",value:function(e){return Ge(e,cc.RawAsset)&&!Ge(e,cc.Asset)}}]),a}())||Ic);cc.RawAsset=Gc;var Hc,Wc,qc,jc,Xc,Yc,Kc,Qc,Zc,Jc,$c,eh,th,ih,nh=m4("Asset",(Pc=fo("cc.Asset"),Fc=_o({visible:!1}),Pc((Vc=Uc=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).loaded=!0,v(t,"_native",Nc,c(t)),t._file=null,t._callbackTable=ke(!0),t}return _(a,Gc),l(a,null,[{key:"deserialize",value:function(e){return cc.deserialize(e)}}]),l(a,[{key:"on",value:function(e,t,i){}},{key:"off",value:function(e,t,i){}},{key:"targetOff",value:function(e){}},{key:"once",value:function(e,t,i){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"toString",value:function(){return this.nativeUrl}},{key:"_setRawAsset",value:function(e,t){var i=!(1<arguments.length&&void 0!==t)||t;this._native=!1!==i?e||void 0:"/"+e}},{key:"nativeUrl",get:function(){if(this._native){var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);if(cc.AssetLibrary){var t=cc.AssetLibrary.getLibUrlNoExt(this._uuid,!0);return 46===e.charCodeAt(0)?t+e:t+"/"+e}cc.errorID(6400)}return""}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}}]),a}(),Uc.preventDeferredLoadDependents=!1,Uc.preventPreloadNativeObject=!1,Nc=m((Dc=Vc).prototype,"_native",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),m(Dc.prototype,"nativeUrl",[Fc],Object.getOwnPropertyDescriptor(Dc.prototype,"nativeUrl"),Dc.prototype),m(Dc.prototype,"_nativeAsset",[_o],Object.getOwnPropertyDescriptor(Dc.prototype,"_nativeAsset"),Dc.prototype),zc=Dc))||zc));Lc(nh,[ll,cl]),nh.prototype.createNode=null,cc.Asset=nh,(Wc=Hc=Hc||{})[Wc.RGB565=ru.R5G6B5]="RGB565",Wc[Wc.RGB5A1=ru.RGB5A1]="RGB5A1",Wc[Wc.RGBA4444=ru.RGBA4]="RGBA4444",Wc[Wc.RGB888=ru.RGB8]="RGB888",Wc[Wc.RGBA8888=ru.RGBA8]="RGBA8888",Wc[Wc.RGBA32F=ru.RGBA32F]="RGBA32F",Wc[Wc.A8=ru.A8]="A8",Wc[Wc.I8=ru.L8]="I8",Wc[Wc.AI8=ru.LA8]="AI8",Wc[Wc.RGB_PVRTC_2BPPV1=ru.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",Wc[Wc.RGBA_PVRTC_2BPPV1=ru.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",Wc[Wc.RGB_PVRTC_4BPPV1=ru.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",Wc[Wc.RGBA_PVRTC_4BPPV1=ru.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",Wc[Wc.RGB_ETC1=ru.ETC_RGB8]="RGB_ETC1",Wc[Wc.RGB_ETC2=ru.ETC2_RGB8]="RGB_ETC2",Wc[Wc.RGBA_ETC2=ru.ETC2_RGBA8]="RGBA_ETC2",(jc=qc=qc||{})[jc.REPEAT=Lu.WRAP]="REPEAT",jc[jc.CLAMP_TO_EDGE=Lu.CLAMP]="CLAMP_TO_EDGE",jc[jc.MIRRORED_REPEAT=Lu.MIRROR]="MIRRORED_REPEAT",jc[jc.CLAMP_TO_BORDER=Lu.BORDER]="CLAMP_TO_BORDER",(Yc=Xc=Xc||{})[Yc.NONE=Iu.NONE]="NONE",Yc[Yc.LINEAR=Iu.LINEAR]="LINEAR",Yc[Yc.NEAREST=Iu.POINT]="NEAREST",(Qc=Kc=Kc||{})[Qc.NONE=ru.UNKNOWN]="NONE",Qc[Qc.DEPTH_16=ru.D16]="DEPTH_16",Qc[Qc.DEPTH_24=ru.D24]="DEPTH_24",Qc[Qc.DEPTH_32=ru.D32F]="DEPTH_32",Qc[Qc.DEPTH_16_STENCIL_8=ru.D16S8]="DEPTH_16_STENCIL_8",Qc[Qc.DEPTH_24_STENCIL_8=ru.D24S8]="DEPTH_24_STENCIL_8",Qc[Qc.DEPTH_32_STENCIL_8=ru.D32F_S8]="DEPTH_32_STENCIL_8";var rh,ah,sh=m4("ImageAsset",(Zc=fo("cc.ImageAsset"),Jc=_o({override:!0}),Zc((ih=th=function(){function b(e){var t;return y(this,b),(t=x(this,g(b).call(this)))._nativeData=void 0,t._tex=void 0,t._url=void 0,t._exportedExts=void 0,t._format=Hc.RGBA8888,t._width=0,t._height=0,t._url="",t.loaded=!1,t._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&(t._nativeAsset=e),t}return _(b,nh),l(b,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){this.reset(e)}},{key:"data",get:function(){var e=this._nativeData._data;return ArrayBuffer.isView(e)||e instanceof ArrayBuffer?e:this._nativeData}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=Hc.RGB_ETC1&&this._format<=Hc.RGBA_PVRTC_4BPPV1}},{key:"url",get:function(){return this._url}},{key:"_texture",set:function(e){this._tex=e},get:function(){if(!this._tex){var e=new cc.Texture2D;e.name=this._url,(e.image=this)._tex=e}return this._tex}}]),l(b,[{key:"reset",value:function(e){var t=this;e instanceof HTMLElement?(this._nativeData=e).complete||e instanceof HTMLCanvasElement?this._onDataComplete():(this.loaded=!1,e.addEventListener("load",function(){t._onDataComplete()}),e.addEventListener("error",function(e){cc.warnID(3119,e.message)})):(this._nativeData=e,this._nativeData.format=this._format,this._onDataComplete())}},{key:"_serialize",value:function(){var e=this._exportedExts;if(!e&&this._native&&(e=[this._native]),!e)return"";var t=[],i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a,o=s.split("@"),l=b.extnames.indexOf(o[0]),u=l<0?s:"".concat(l);o[1]&&(u+="@"+o[1]),t.push(u)}return{fmt:t.join("_"),w:this.width,h:this.height}}},{key:"_deserialize",value:function(e,t){var i="";i="string"==typeof e?e:(this._width=e.w,this._height=e.h,e.fmt);var n=cc.director.root?cc.director.root.device:null,r=i.split("_"),a=Number.MAX_VALUE,s=this._format,o="",l=cc.macro.SUPPORT_TEXTURE_FORMATS,u=r,c=Array.isArray(u),h=0;for(u=c?u:u[Symbol.iterator]();;){var f;if(c){if(h>=u.length)break;f=u[h++]}else{if((h=u.next()).done)break;f=h.value}var d=f.split("@"),_=parseInt(d[0],void 0),p=b.extnames[_]||d.join(),v=l.indexOf(p);if(-1!==v&&v<a){var m=d[1]?parseInt(d[1]):this._format;if(!(".pvr"!==p||n&&n.hasFeature(kc.FORMAT_PVRTC)))continue;if(!(m!==Hc.RGB_ETC1||n&&n.hasFeature(kc.FORMAT_ETC1)))continue;if(!(m!==Hc.RGB_ETC2&&m!==Hc.RGBA_ETC2||n&&n.hasFeature(kc.FORMAT_ETC2)))continue;if(".webp"===p&&!cc.sys.capabilities.webp)continue;a=v,o=p,s=m}}o&&(this._setRawAsset(o),this._format=s);var y=t.customEnv,g=y&&y.uuid;g&&(this._uuid=g,this._url=this.nativeUrl)}},{key:"_onDataComplete",value:function(){this.loaded=!0,this.emit("load")}}]),b}(),th.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm"],m((eh=ih).prototype,"_nativeAsset",[Jc],Object.getOwnPropertyDescriptor(eh.prototype,"_nativeAsset"),eh.prototype),$c=eh))||$c));cc.ImageAsset=sh,(ah=rh=rh||{})[ah.minFilter=0]="minFilter",ah[ah.magFilter=1]="magFilter",ah[ah.mipFilter=2]="mipFilter",ah[ah.addressU=3]="addressU",ah[ah.addressV=4]="addressV",ah[ah.addressW=5]="addressW",ah[ah.maxAnisotropy=6]="maxAnisotropy",ah[ah.cmpFunc=7]="cmpFunc",ah[ah.minLOD=8]="minLOD",ah[ah.maxLOD=9]="maxLOD",ah[ah.mipLODBias=10]="mipLODBias",ah[ah.borderColor=11]="borderColor",ah[ah.total=15]="total";var oh=[Iu.LINEAR,Iu.LINEAR,Iu.NONE,Lu.WRAP,Lu.WRAP,Lu.WRAP,16,Su.NEVER,0,0,0,0,0,0,0],lh={};function uh(e){for(var t=0,i=0,n=0;n<oh.length;n++)switch(t=e[n]||oh[n],n){case rh.minFilter:i|=t;break;case rh.magFilter:i|=t<<2;break;case rh.mipFilter:i|=t<<4;break;case rh.addressU:i|=t<<6;break;case rh.addressV:i|=t<<8;break;case rh.addressW:i|=t<<10;break;case rh.maxAnisotropy:i|=t<<12;break;case rh.cmpFunc:i|=t<<16;break;case rh.minLOD:i|=t<<20;break;case rh.maxLOD:i|=t<<24;break;case rh.mipLODBias:i|=t<<28}return i}var ch,hh,fh,dh,_h,ph,vh,mh,yh,gh,bh,xh,Sh,Th,wh,Eh,Ah,Ch,kh,Rh=new(function(){function e(){y(this,e),this._cache={}}return l(e,[{key:"getSampler",value:function(e,t){var i=this._cache[t];return i||(0===t&&(t=uh(oh)),lh.minFilter=3&t,lh.magFilter=t>>2&3,lh.mipFilter=t>>4&3,lh.addressU=t>>6&3,lh.addressV=t>>8&3,lh.addressW=t>>10&3,lh.maxAnisotropy=t>>12&15,lh.cmpFunc=t>>16&15,lh.minLOD=t>>20&15,lh.maxLOD=t>>24&15,lh.mipLODBias=t>>28&15,lh.borderColor={r:0,g:0,b:0,a:0},this._cache[t]=e.createSampler(lh))}}]),e}()),Oh=new pe("Tex"),Mh=fo("cc.TextureBase")((Th=Sh=function(){function i(){var e,t=0<arguments.length&&void 0!==arguments[0]&&arguments[0];return y(this,i),v(e=x(this,g(i).call(this)),"_format",fh,c(e)),v(e,"_premultiplyAlpha",dh,c(e)),v(e,"_flipY",_h,c(e)),v(e,"_minFilter",ph,c(e)),v(e,"_magFilter",vh,c(e)),v(e,"_mipFilter",mh,c(e)),v(e,"_wrapS",yh,c(e)),v(e,"_wrapT",gh,c(e)),v(e,"_wrapR",bh,c(e)),v(e,"_anisotropy",xh,c(e)),e._width=0,e._height=0,e._id=void 0,e._samplerInfo=[],e._samplerHash=0,e._flipY=t,e._id=Oh.getNewId(),e.loaded=!1,e}return _(i,nh),l(i,[{key:"isCompressed",get:function(){return this._format>=Hc.RGB_ETC1&&this._format<=Hc.RGBA_PVRTC_4BPPV1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),l(i,[{key:"getId",value:function(){return this._id}},{key:"getPixelFormat",value:function(){return this._format}},{key:"hasPremultipliedAlpha",value:function(){return this._premultiplyAlpha||!1}},{key:"getAnisotropy",value:function(){return this._anisotropy}},{key:"setWrapMode",value:function(e,t,i){this._wrapS=e,this._samplerInfo[rh.addressU]=e,this._wrapT=t,this._samplerInfo[rh.addressV]=t,void 0!==i&&(this._wrapR=i,this._samplerInfo[rh.addressW]=i),this._samplerHash=uh(this._samplerInfo)}},{key:"setFilters",value:function(e,t){this._minFilter=e,this._samplerInfo[rh.minFilter]=e,this._magFilter=t,this._samplerInfo[rh.magFilter]=t,this._samplerHash=uh(this._samplerInfo)}},{key:"setMipFilter",value:function(e){this._mipFilter=e,this._samplerInfo[rh.mipFilter]=e,this._samplerInfo[rh.maxLOD]=e===Xc.NONE?0:1e3,this._samplerHash=uh(this._samplerInfo)}},{key:"setFlipY",value:function(e){this._flipY=e}},{key:"setPremultiplyAlpha",value:function(e){this._premultiplyAlpha=e}},{key:"setAnisotropy",value:function(e){this._anisotropy=e,this._samplerInfo[rh.maxAnisotropy]=e,this._samplerHash=uh(this._samplerInfo)}},{key:"destroy",value:function(){return p(g(i.prototype),"destroy",this).call(this)}},{key:"getGFXTextureView",value:function(){return null}},{key:"getSamplerHash",value:function(){return this._samplerHash}},{key:"_serialize",value:function(e){return this._minFilter+","+this._magFilter+","+this._wrapS+","+this._wrapT+","+(this._premultiplyAlpha?1:0)+","+this._mipFilter+","+this._anisotropy+","+(this._flipY?1:0)}},{key:"_deserialize",value:function(e,t){var i=e.split(",");i.unshift(""),6<=i.length&&(this.setFilters(parseInt(i[1]),parseInt(i[2])),this.setWrapMode(parseInt(i[3]),parseInt(i[4])),this._premultiplyAlpha=49===i[5].charCodeAt(0)),8<=i.length&&(this.setMipFilter(parseInt(i[6])),this.setAnisotropy(parseInt(i[7]))),9<=i.length&&(this._flipY=49===i[8].charCodeAt(0))}},{key:"_getGFXDevice",value:function(){return cc.director.root&&cc.director.root.device}},{key:"_getGFXFormat",value:function(){return this._format}},{key:"_setGFXFormat",value:function(e){this._format=void 0===e?Hc.RGBA8888:e}}]),i}(),Sh.PixelFormat=Hc,Sh.WrapMode=qc,Sh.Filter=Xc,fh=m((hh=Th).prototype,"_format",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hc.RGBA8888}}),dh=m(hh.prototype,"_premultiplyAlpha",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_h=m(hh.prototype,"_flipY",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ph=m(hh.prototype,"_minFilter",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xc.LINEAR}}),vh=m(hh.prototype,"_magFilter",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xc.LINEAR}}),mh=m(hh.prototype,"_mipFilter",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xc.NONE}}),yh=m(hh.prototype,"_wrapS",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qc.REPEAT}}),gh=m(hh.prototype,"_wrapT",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qc.REPEAT}}),bh=m(hh.prototype,"_wrapR",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qc.REPEAT}}),xh=m(hh.prototype,"_anisotropy",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 16}}),ch=hh))||ch;cc.TextureBase=Mh,mt(Kc);var Ih,Bh=m4("RenderTexture",fo("cc.RenderTexture")((kh=Ch=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._window=null,v(t,"_depthStencilFormat",Ah,c(t)),t}return _(a,Mh),l(a,[{key:"getGFXWindow",value:function(){return this._window}},{key:"getGFXTextureView",value:function(){return this._window?this._window.colorTexView:null}},{key:"getGFXStencilTexture",value:function(){return this._window?this._window.depthStencilTexView:null}},{key:"reset",value:function(e){e&&(this._width=e.width,this._height=e.height,e.colorFormat&&(this._format=e.colorFormat),e.depthStencilFormat&&(this._depthStencilFormat=e.depthStencilFormat),this._tryResetWindow(),this.emit("resize",this))}},{key:"destroy",value:function(){return this._window&&(cc.director.root.destroyWindow(this._window),this._window=null),p(g(a.prototype),"destroy",this).call(this)}},{key:"onLoaded",value:function(){this._tryResetWindow(),this.loaded=!0,this.emit("load")}},{key:"_serialize",value:function(e){return{base:p(g(a.prototype),"_serialize",this).call(this),name:this._name,width:this._width,height:this._height,colorFormat:this._format,depthStencilFormat:this._depthStencilFormat}}},{key:"_deserialize",value:function(e,t){p(g(a.prototype),"_deserialize",this).call(this,e.base,t);var i=e;this.name=i.name||"",this._width=i.width,this._height=i.height,this._format=i.colorFormat,this._depthStencilFormat=i.depthStencilFormat}},{key:"_tryResetWindow",value:function(){var e=this._getGFXDevice();e&&(this._window&&this._window.destroy(),this._createWindow(e))}},{key:"_createWindow",value:function(e){var t={title:this.name,isOffscreen:!0,width:this._width,height:this._height,colorFmt:this._format,depthStencilFmt:this._depthStencilFormat};if(this._window)return this._window.initialize(t),this._window;this._window=cc.director.root.createWindow(t)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this.reset()}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this.reset()}},{key:"depthStencilFormat",get:function(){return this._depthStencilFormat},set:function(e){this._depthStencilFormat=e,this.reset()}}]),a}(),Ch.DepthStencilFormat=Kc,Ah=m((Eh=kh).prototype,"_depthStencilFormat",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kc.NONE}}),m(Eh.prototype,"width",[_o],Object.getOwnPropertyDescriptor(Eh.prototype,"width"),Eh.prototype),m(Eh.prototype,"height",[_o],Object.getOwnPropertyDescriptor(Eh.prototype,"height"),Eh.prototype),m(Eh.prototype,"depthStencilFormat",[_o],Object.getOwnPropertyDescriptor(Eh.prototype,"depthStencilFormat"),Eh.prototype),wh=Eh))||wh);cc.RenderTexture=Bh;var Lh=[{buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:1,height:1,depth:1},texSubres:{baseMipLevel:1,levelCount:1,baseArrayLayer:0,layerCount:1}}];function Ph(e){return e&&0==(e&e-1)}var Fh,zh,Dh,Nh,Uh,Vh=fo("cc.SimpleTexture")(Ih=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._gfxTexture=null,t._gfxTextureView=null,t._mipmapLevel=1,t}return _(a,Mh),l(a,[{key:"getGFXTexture",value:function(){return this._gfxTexture}},{key:"getGFXTextureView",value:function(){return this._gfxTextureView}},{key:"destroy",value:function(){return this._tryDestroyTexture(),p(g(a.prototype),"destroy",this).call(this)}},{key:"updateImage",value:function(){this.updateMipmaps(0)}},{key:"updateMipmaps",value:function(){}},{key:"uploadData",value:function(e,t,i){var n=1<arguments.length&&void 0!==t?t:0,r=2<arguments.length&&void 0!==i?i:0;if(this._gfxTexture&&!(this._gfxTexture.mipLevel<=n)){var a=this._getGFXDevice();if(a){var s=Lh[0];s.texExtent.width=this._gfxTexture.width>>n,s.texExtent.height=this._gfxTexture.height>>n,s.texSubres.baseMipLevel=n,s.texSubres.baseArrayLayer=r,e instanceof ArrayBuffer?a.copyBuffersToTexture([e],this._gfxTexture,Lh):a.copyTexImagesToTexture([e],this._gfxTexture,Lh)}}}},{key:"_assignImage",value:function(i,n,r){function e(){var e,t=i.data;t&&(e=ArrayBuffer.isView(t)?t.buffer:t,a.uploadData(e,n,r),a._checkTextureLoaded())}var a=this;if(i.loaded)e();else{if(i.once("load",function(){e()}),!this.isCompressed){var t=cc.builtinResMgr.get("black-texture").image;this.uploadData(t.data,n,r)}cc.textureUtil.postLoadImage(i)}}},{key:"_checkTextureLoaded",value:function(){this._textureReady()}},{key:"_textureReady",value:function(){this.loaded=!0,this.emit("load")}},{key:"_setMipmapLevel",value:function(e){this._mipmapLevel=e<1?1:e}},{key:"_getGfxTextureCreateInfo",value:function(e){return null}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return null}},{key:"_tryReset",value:function(){this._tryDestroyTexture();var e=this._getGFXDevice();e&&this._createTexture(e)}},{key:"_createTexture",value:function(e){var t=Gu.NONE;this._mipFilter!==Xc.NONE&&Ph(this._width)&&Ph(this._height)&&(this._mipmapLevel=function(e,t){for(var i=Math.max(e,t),n=0;i;)i>>=1,n++;return n}(this._width,this._height),t=Gu.GEN_MIPMAP);var i=this._getGfxTextureCreateInfo({usage:Du.SAMPLED|Du.TRANSFER_DST,format:this._getGFXFormat(),mipLevel:this._mipmapLevel,flags:t});if(i){var n=e.createTexture(i),r=this._getGfxTextureViewCreateInfo({texture:n,format:this._getGFXFormat()});if(r){var a=e.createTextureView(r);a?(this._gfxTexture=n,this._gfxTextureView=a):n.destroy()}else n.destroy()}}},{key:"_tryDestroyTexture",value:function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null),this._gfxTextureView&&(this._gfxTextureView.destroy(),this._gfxTextureView=null)}},{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),a}())||Ih;cc.SimpleTexture=Vh;var Gh,Hh=m4("Texture2D",(Fh=fo("cc.Texture2D"),zh=_o([sh]),Fh((Uh=m((Nh=function(){function a(){var e;return y(this,a),v(e=x(this,g(a).call(this,!0)),"_mipmaps",Uh,c(e)),e}return _(a,Vh),l(a,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var i=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),0<this._mipmaps.length){var t=this._mipmaps[0];this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(function(e,t){i._assignImage(e,t)})}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),l(a,[{key:"onLoaded",value:function(){this.initialize()}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"create",value:function(e,t,i,n){var r=2<arguments.length&&void 0!==i?i:Hc.RGBA8888,a=3<arguments.length&&void 0!==n?n:1;this.reset({width:e,height:t,format:r,mipmapLevel:a})}},{key:"toString",value:function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}},{key:"updateMipmaps",value:function(e,t){var i=0<arguments.length&&void 0!==e?e:0,n=1<arguments.length?t:void 0;if(!(i>=this._mipmaps.length))for(var r=Math.min(void 0===n?this._mipmaps.length:n,this._mipmaps.length-i),a=0;a<r;++a){var s=i+a;this._assignImage(this._mipmaps[s],s)}}},{key:"getHtmlElementObj",value:function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}},{key:"destroy",value:function(){return this._mipmaps=[],p(g(a.prototype),"destroy",this).call(this)}},{key:"description",value:function(){var e=this._mipmaps[0]?this._mipmaps[0].url:"";return"<cc.Texture2D | Name = ".concat(e," | Dimension = ").concat(this.width," x ").concat(this.height,">")}},{key:"releaseTexture",value:function(){this.destroy()}},{key:"_serialize",value:function(t){return{base:p(g(a.prototype),"_serialize",this).call(this,t),mipmaps:this._mipmaps.map(function(e){return e&&e._uuid?t?Editor.Utils.UuidUtils.compressUuid(e._uuid,!0):e._uuid:null})}}},{key:"_deserialize",value:function(e,t){var i=e;p(g(a.prototype),"_deserialize",this).call(this,i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(var n=0;n<i.mipmaps.length;++n)if(this._mipmaps[n]=new sh,i.mipmaps[n]){var r=i.mipmaps[n];t.result.push(this._mipmaps,"".concat(n),r),this._mipmaps[n]._texture=this}}},{key:"initialize",value:function(){this.mipmaps=this._mipmaps}},{key:"_getGfxTextureCreateInfo",value:function(e){return Object.assign({type:Fu.TEX2D,width:this._width,height:this._height},e)}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return Object.assign({type:Wu.TV2D},e)}},{key:"_checkTextureLoaded",value:function(){for(var e=!0,t=0;t<this._mipmaps.length;++t){if(!this._mipmaps[t].loaded){e=!1;break}}e&&p(g(a.prototype),"_textureReady",this).call(this)}}]),a}()).prototype,"_mipmaps",[zh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Dh=Nh))||Dh));cc.Texture2D=Hh;var Wh,qh,jh,Xh,Yh,Kh,Qh,Zh=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],Jh=m4("SpriteFrame",fo("cc.SpriteFrame")(Gh=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this))).vertices=null,e.uv=[],e.uvHash=0,e._image=null,e.uvSliced=[],e._rect=new Jn,e._offset=new Ii,e._originalSize=new jn,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._flipUv=!1,e}return _(t,nh),l(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]=e,this._calculateSlicedUV()}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]=e,this._calculateSlicedUV()}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]=e,this._calculateSlicedUV()}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]=e,this._calculateSlicedUV()}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.set(e),this._calculateUV()}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.set(e),this._calculateUV()}},{key:"_imageSource",set:function(e){this._image=e,window.Editor&&Editor.isBuilder||(this._texture=e._texture,this._texture.on("load",this._textureLoaded,this),this._calculateUV())}},{key:"texture",get:function(){return this._texture||(this._texture=!this._image||window.Editor&&Editor.isBuilder?new Hh:this._image._texture,this._texture.on("load",this._textureLoaded,this)),this._texture},set:function(e){e?(this.reset({texture:e},!0),this._texture instanceof Bh&&this.onLoaded()):console.warn("Error Texture in ".concat(this.name))}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}}]),l(t,[{key:"textureLoaded",value:function(){return this.loaded}},{key:"isRotated",value:function(){return this._rotated}},{key:"setRotated",value:function(e){this._rotated=e}},{key:"getRect",value:function(e){return e?(e.set(this._rect),e):this._rect.clone()}},{key:"setRect",value:function(e){this._rect.set(e)}},{key:"getOriginalSize",value:function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()}},{key:"setOriginalSize",value:function(e){this._originalSize.set(e)}},{key:"getOffset",value:function(e){return e?(e.set(this._offset),e):this._offset.clone()}},{key:"setOffset",value:function(e){this._offset.set(e)}},{key:"getGFXTextureView",value:function(){return this._texture.getGFXTextureView()}},{key:"reset",value:function(e,t){var i=!1;1<arguments.length&&void 0!==t&&t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],i=!(this._rotated=!1)),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._texture&&this._texture.off("load"),this._texture=e.texture,this.checkRect(this._texture),this._texture.on("load",this._textureLoaded,this)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._flipUv=!!e.isFlipUv),this._texture instanceof Bh&&(this._flipUv=!0),i=!0),i&&this._calculateUV()}},{key:"checkRect",value:function(e){var t=this._rect,i=t.x,n=t.y;return this._rotated?(i+=t.height,n+=t.width):(i+=t.width,n+=t.height),i>e.width?(cc.errorID(3300,this.name+"/"+e.name,i,e.width),!1):!(n>e.height)||(cc.errorID(3400,this.name+"/"+e.name,n,e.height),!1)}},{key:"onLoaded",value:function(){this.loaded=!0,this.emit("load")}},{key:"destroy",value:function(){return this._texture&&this._texture.off("load"),p(g(t.prototype),"destroy",this).call(this)}},{key:"_calculateSlicedUV",value:function(){var e=this._rect,t=this.texture,i=t.width,n=t.height,r=this._capInsets[0],a=this._capInsets[2],s=e.width-r-a,o=this._capInsets[1],l=this._capInsets[3],u=e.height-o-l,c=this.uvSliced;if(c.length=0,this._rotated){Zh[0].u=(e.x+e.height)/i,Zh[1].u=(e.x+l+u)/i,Zh[2].u=(e.x+l)/i,Zh[3].u=e.x/i,Zh[3].v=(e.y+e.width)/n,Zh[2].v=(e.y+r+s)/n,Zh[1].v=(e.y+r)/n,Zh[0].v=e.y/n;for(var h=0;h<4;++h)for(var f=Zh[h],d=0;d<4;++d){var _=Zh[3-d];c.push({u:f.u,v:_.v})}}else{Zh[0].u=e.x/i,Zh[1].u=(e.x+r)/i,Zh[2].u=(e.x+r+s)/i,Zh[3].u=(e.x+e.width)/i,Zh[3].v=e.y/n,Zh[2].v=(e.y+o)/n,Zh[1].v=(e.y+o+u)/n,Zh[0].v=(e.y+e.height)/n;for(var p=0;p<4;++p)for(var v=Zh[p],m=0;m<4;++m){var y=Zh[m];c.push({u:y.u,v:v.v})}}}},{key:"_calculateUV",value:function(){var e=this._rect,t=this.uv,i=this.texture,n=i.width,r=i.height;if(this._rotated){var a=0===n?0:e.x/n,s=0===n?0:(e.x+e.height)/n,o=0===r?0:e.y/r,l=0===r?0:(e.y+e.width)/r;this._flipUv?(t[0]=a,t[1]=o,t[2]=a,t[3]=l,t[4]=s,t[5]=o,t[6]=s,t[7]=l):(t[0]=s,t[1]=l,t[2]=s,t[3]=o,t[4]=a,t[5]=l,t[6]=a,t[7]=o)}else{var u=0===n?0:e.x/n,c=0===n?0:(e.x+e.width)/n,h=0===r?0:(e.y+e.height)/r,f=0===r?0:e.y/r;this._flipUv?(t[0]=u,t[1]=f,t[2]=c,t[3]=f,t[4]=u,t[5]=h,t[6]=c,t[7]=h):(t[0]=u,t[1]=h,t[2]=c,t[3]=h,t[4]=u,t[5]=f,t[6]=c,t[7]=f)}for(var d="",_=0;_<t.length;_++)d+=t[_];this.uvHash=Mc(d,666);var p=this.vertices;if(p){p.nu.length=0;for(var v=p.nv.length=0;v<p.u.length;v++)p.nu[v]=p.u[v]/n,p.nv[v]=p.v[v]/r}this._calculateSlicedUV()}},{key:"_serialize",value:function(e){var t,i=this._rect,n=this._offset,r=this._originalSize,a=this._uuid;return a&&e&&(a=Editor.Utils.UuidUtils.compressUuid(a,!0)),this.vertices&&(t={triangles:this.vertices.triangles,x:this.vertices.x,y:this.vertices.y,u:this.vertices.u,v:this.vertices.v}),{image:this._image?e?Editor.Utils.UuidUtils.compressUuid(this._image._uuid,!0):this._image._uuid:void 0,name:this._name,atlas:e?void 0:this._atlasUuid,rect:i,offset:n,originalSize:r,rotated:this._rotated,capInsets:this._capInsets,vertices:t}}},{key:"_deserialize",value:function(e,t){var i=e,n=i.rect;n&&this.setRect(new Jn(n.x,n.y,n.width,n.height));var r=i.offset;i.offset&&this.setOffset(new Ii(r.x,r.y));var a=i.originalSize;i.originalSize&&this.setOriginalSize(new jn(a.width,a.height)),this._rotated=!!i.rotated,this._name=i.name;var s=i.capInsets;s&&(this._capInsets[0]=s[0],this._capInsets[1]=s[1],this._capInsets[2]=s[2],this._capInsets[3]=s[3]),t.result.push(this,"_imageSource",i.image),this.vertices=i.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}},{key:"_textureLoaded",value:function(){var e=this._texture,t={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(t.rect=new Jn(0,0,e.width,e.height),i=!0),0!==this._originalSize.width&&0!==this._originalSize.height&&!i||(t.originalSize=new jn(e.width,e.height),i=!0),i&&(this.reset(t),this.onLoaded())}}]),t}())||Gh);cc.SpriteFrame=Jh,(Qh=Kh=Kh||{})[Qh.right=0]="right",Qh[Qh.left=1]="left",Qh[Qh.top=2]="top",Qh[Qh.bottom=3]="bottom",Qh[Qh.front=4]="front",Qh[Qh.back=5]="back";var $h=m4("TextureCube",fo("cc.TextureCube")((Yh=Xh=function(){function s(){var e;return y(this,s),v(e=x(this,g(s).call(this)),"_mipmaps",jh,c(e)),e}return _(s,Vh),l(s,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var n=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),0<this._mipmaps.length){var t=this._mipmaps[0].front;this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(function(e,i){ef(e,function(e,t){n._assignImage(e,i,t)})})}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}],[{key:"fromTexture2DArray",value:function(e,t){for(var i=[],n=e.length/6,r=0;r<n;r++){var a=6*r;i.push({front:e[a+Kh.front].image,back:e[a+Kh.back].image,left:e[a+Kh.left].image,right:e[a+Kh.right].image,top:e[a+Kh.top].image,bottom:e[a+Kh.bottom].image})}return(t=t||new s).mipmaps=i,t}}]),l(s,[{key:"onLoaded",value:function(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"updateMipmaps",value:function(e,t){var n=this,r=0<arguments.length&&void 0!==e?e:0,i=1<arguments.length?t:void 0;if(!(r>=this._mipmaps.length))for(var a=Math.min(void 0===i?this._mipmaps.length:i,this._mipmaps.length-r),s=function(e){var i=r+e;ef(n._mipmaps[i],function(e,t){n._assignImage(e,i,t)})},o=0;o<a;++o)s(o)}},{key:"destroy",value:function(){return this._mipmaps=[],p(g(s.prototype),"destroy",this).call(this)}},{key:"releaseTexture",value:function(){this.mipmaps=[]}},{key:"_serialize",value:function(t){return{base:p(g(s.prototype),"_serialize",this).call(this),mipmaps:this._mipmaps.map(function(e){return t?{front:Editor.Utils.UuidUtils.compressUuid(e.front._uuid,!0),back:Editor.Utils.UuidUtils.compressUuid(e.back._uuid,!0),left:Editor.Utils.UuidUtils.compressUuid(e.left._uuid,!0),right:Editor.Utils.UuidUtils.compressUuid(e.right._uuid,!0),top:Editor.Utils.UuidUtils.compressUuid(e.top._uuid,!0),bottom:Editor.Utils.UuidUtils.compressUuid(e.bottom._uuid,!0)}:{front:e.front._uuid,back:e.back._uuid,left:e.left._uuid,right:e.right._uuid,top:e.top._uuid,bottom:e.bottom._uuid}})}}},{key:"_deserialize",value:function(e,t){var i=e;p(g(s.prototype),"_deserialize",this).call(this,i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(var n=0;n<i.mipmaps.length;++n){this._mipmaps[n]={front:new sh,back:new sh,left:new sh,right:new sh,top:new sh,bottom:new sh};var r=i.mipmaps[n];t.result.push(this._mipmaps[n],"front",r.front),t.result.push(this._mipmaps[n],"back",r.back),t.result.push(this._mipmaps[n],"left",r.left),t.result.push(this._mipmaps[n],"right",r.right),t.result.push(this._mipmaps[n],"top",r.top),t.result.push(this._mipmaps[n],"bottom",r.bottom)}}},{key:"_getGfxTextureCreateInfo",value:function(e){var t=Object.assign({type:Fu.TEX2D,width:this._width,height:this._height,arrayLayer:6},e);return t.flags=(t.flags||0)|Gu.CUBEMAP,t}},{key:"_getGfxTextureViewCreateInfo",value:function(e){return Object.assign({type:Wu.CUBE,layerCount:6},e)}}]),s}(),Xh.FaceIndex=Kh,jh=m((qh=Yh).prototype,"_mipmaps",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Wh=qh))||Wh);function ef(e,t){t(e.front,Kh.front),t(e.back,Kh.back),t(e.left,Kh.left),t(e.right,Kh.right),t(e.top,Kh.top),t(e.bottom,Kh.bottom)}cc.TextureCube=$h;var tf=m4("GFXBuffer",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,jl.BUFFER)))._device=void 0,t._usage=su.NONE,t._memUsage=lu.NONE,t._size=0,t._stride=1,t._count=0,t._flags=cu.NONE,t._bufferView=null,t._device=e,t}return _(i,pc),l(i,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}},{key:"bufferView",get:function(){return this._bufferView}}]),i}()),nf=m4("GFXCommandBuffer",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,jl.COMMAND_BUFFER)))._device=void 0,t._allocator=null,t._type=Qu.PRIMARY,t._numDrawCalls=0,t._numTris=0,t._device=e,t}return _(i,pc),l(i,[{key:"type",get:function(){return this._type}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numTris",get:function(){return this._numTris}}]),i}()),rf=m4("GFXFramebuffer",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,jl.FRAMEBUFFER)))._device=void 0,t._renderPass=null,t._colorViews=[],t._depthStencilView=null,t._isOffscreen=!0,t._device=e,t}return _(i,pc),l(i,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorViews",get:function(){return this._colorViews}},{key:"depthStencilView",get:function(){return this._depthStencilView}},{key:"isOffscreen",get:function(){return this._isOffscreen}}]),i}());function af(e,t){if(t)0;else{var i=cc.director.getScene();if(!i)return null;t=i}return t.getChildByPath(e)}cc.find=af;var sf,of,lf,uf,cf=function(){function e(){y(this,e),this._arrayBufferOrPaddings=[],this._length=0}return l(e,[{key:"setNextAlignment",value:function(e){if(0!==e){var t=this._length%e;if(0!=t){var i=e-t;this._arrayBufferOrPaddings.push(i),this._length+=i}}}},{key:"addBuffer",value:function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}},{key:"getLength",value:function(){return this._length}},{key:"getCombined",value:function(){var t=new Uint8Array(this._length),i=0;return this._arrayBufferOrPaddings.forEach(function(e){"number"==typeof e?i+=e:(t.set(new Uint8Array(e),i),i+=e.byteLength)}),t.buffer}}]),e}();var hf=function(){function t(e){y(this,t),this._subMeshes=e}return l(t,[{key:"getSubmesh",value:function(e){return this._subMeshes[e]}},{key:"destroySubMeshes",value:function(){for(var e=0;e<this._subMeshes.length;++e){for(var t=this._subMeshes[e],i=0;i<t.vertexBuffers.length;++i)t.vertexBuffers[i].destroy();t.indexBuffer&&t.indexBuffer.destroy()}this._subMeshes.splice(0)}},{key:"destroy",value:function(){this.destroySubMeshes(),this._subMeshes.length=0}},{key:"subMeshes",get:function(){return this._subMeshes}},{key:"subMeshCount",get:function(){return this._subMeshes.length}}]),t}(),ff=m4("Mesh",fo("cc.Mesh")((lf=m((of=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"_struct",lf,c(e)),v(e,"_dataLength",uf,c(e)),e._data=null,e._initialized=!1,e._hasFlatBuffers=!1,e._renderingMesh=null,e.loaded=!1,e}return _(t,nh),l(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data&&this._data.byteLength===e.byteLength?(this._data.set(new Uint8Array(e)),cc.loader._cache[this.nativeUrl]&&(cc.loader._cache[this.nativeUrl].content=this._data.buffer)):this._data=new Uint8Array(e),this.loaded=!0,this.emit("load")}},{key:"subMeshCount",get:function(){var e=this.renderingMesh;return e?e.subMeshCount:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hasFlatBuffers",get:function(){return this._hasFlatBuffers}}]),l(t,[{key:"initialize",value:function(){var c=this;if(!this._initialized){this._initialized=!0,this._data||(this._data=new Uint8Array(this._dataLength),function(i,n){i.loaded?n&&n():i.nativeUrl?cc.loader.load({url:i.nativeUrl},function(e,t){t&&(i.loaded||(i._nativeAsset=t)),n&&n(e)}):n&&n()}(this));var h=this._data.buffer,f=cc.director.root.device,d=this._createVertexBuffers(f,h),_=[],e=function(){if(v){if(m>=p.length)return"break";y=p[m++]}else{if((m=p.next()).done)return"break";y=m.value}var e=y;if(0===e.vertexBundelIndices.length)return"continue";var t=null,i=null;if(e.indexView){var n=e.indexView;t=f.createBuffer({usage:su.INDEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:n.length,stride:n.stride}),i=new(function(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}return Uint8Array}(n.stride))(h,n.offset,n.count),c.loaded?t.update(i):c.once("load",function(){t.update(i)})}var r=e.vertexBundelIndices.map(function(e){return d[e]}),a=[];if(0<e.vertexBundelIndices.length){var s=e.vertexBundelIndices[0];a=c._struct.vertexBundles[s].attributes}var o={primitiveMode:e.primitiveMode,vertexBuffers:r,flatBuffers:[],indexBuffer:t,attributes:a};if(e.geometricInfo){var l=e.geometricInfo,u=new Float32Array(h,l.view.offset,l.view.length/4);o.geometricInfo={indices:i,positions:u}}_.push(o)};var p=this._struct.primitives,v=Array.isArray(p),m=0;e:for(p=v?p:p[Symbol.iterator]();;){var y;switch(e()){case"break":break e;case"continue":continue}}this._renderingMesh=new hf(_)}}},{key:"destroy",value:function(){return this.destroyRenderingMesh(),p(g(t.prototype),"destroy",this).call(this)}},{key:"destroyRenderingMesh",value:function(){this._renderingMesh&&(this._renderingMesh.destroy(),this._renderingMesh=null,this._data=null,this._initialized=!1)}},{key:"assign",value:function(e,t){this.reset({struct:e,data:t})}},{key:"reset",value:function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this.loaded=!0,this.emit("load")}},{key:"getSubMesh",value:function(e){return this.renderingMesh.getSubmesh(e)}},{key:"merge",value:function(e,t){if(void 0!==t&&t&&(!this.loaded||!e.loaded||!this.validateMergingMesh(e)))return!1;if(!this._initialized&&e._data){var i=JSON.parse(JSON.stringify(e._struct)),n=e._data.slice();return this.reset({struct:i,data:n}),this.initialize(),!0}for(var r,a,s,o,l,u=new cf,c=0,h=0,f=0,d=0,_=0,p=0,v=0,m=0,y=!1,g=new Array(this._struct.vertexBundles.length),b=0;b<this._struct.vertexBundles.length;++b){var x=this._struct.vertexBundles[b],S=e._struct.vertexBundles[b];f=x.view.offset,d=S.view.offset,h=x.view.stride,c=x.view.count+S.view.count,r=new ArrayBuffer(c*h),a=new Uint8Array(r),f+=(s=this._data.subarray(f,f+x.view.length)).length,d+=(o=e._data.subarray(d,d+S.view.length)).length,a.set(s),_=0;var T=x.attributes,w=Array.isArray(T),E=0;for(T=w?T:T[Symbol.iterator]();;){var A;if(w){if(E>=T.length)break;A=T[E++]}else{if((E=T.next()).done)break;A=E.value}var C=A;v=0,y=!1;var k=S.attributes,R=Array.isArray(k),O=0;for(k=R?k:k[Symbol.iterator]();;){var M;if(R){if(O>=k.length)break;M=k[O++]}else{if((O=k.next()).done)break;M=O.value}var I=M;if(C.name===I.name&&C.format===I.format){y=!0;break}v+=xc[I.format].size}if(y){m=xc[C.format].size,p=x.view.length+_;for(var B=0;B<S.view.count;++B)l=o.subarray(v,v+m),a.set(l,p),p+=x.view.stride,v+=S.view.stride}_+=xc[C.format].size}g[b]={attributes:x.attributes,view:{offset:u.getLength(),length:r.byteLength,count:c,stride:h}},u.addBuffer(r)}for(var L,P,F,z=0,D=2,N=0,U=new Array(this._struct.primitives.length),V=0;V<this._struct.primitives.length;++V){var G=this._struct.primitives[V],H=e._struct.primitives[V];U[V]={primitiveMode:G.primitiveMode,vertexBundelIndices:G.vertexBundelIndices};var W=G.vertexBundelIndices,q=Array.isArray(W),j=0;for(W=q?W:W[Symbol.iterator]();;){var X;if(q){if(j>=W.length)break;X=W[j++]}else{if((j=W.next()).done)break;X=j.value}var Y=X;N=Math.max(N,this._struct.vertexBundles[Y].view.count)}if(G.indexView&&H.indexView){z=G.indexView.count,z+=H.indexView.count,f=G.indexView.offset,d=H.indexView.offset,D=z<256?1:z<65536?2:4;var K=new ArrayBuffer(z*D);if(L=2===D?new Uint16Array(K):1===D?new Uint8Array(K):new Uint32Array(K),P=2===G.indexView.stride?new Uint16Array(this._data.buffer,f,G.indexView.count):1===G.indexView.stride?new Uint8Array(this._data.buffer,f,G.indexView.count):new Uint32Array(this._data.buffer,f,G.indexView.count),D===G.indexView.stride)L.set(P);else for(var Q=0;Q<G.indexView.count;++Q)L[Q]=P[Q];f+=G.indexView.length,F=2===H.indexView.stride?new Uint16Array(e._data.buffer,d,H.indexView.count):1===H.indexView.stride?new Uint8Array(e._data.buffer,d,H.indexView.count):new Uint32Array(e._data.buffer,d,H.indexView.count);for(var Z=0;Z<H.indexView.count;++Z)L[G.indexView.count+Z]=N+F[Z];d+=H.indexView.length,U[V].indexView={offset:u.getLength(),length:K.byteLength,count:z,stride:D},u.setNextAlignment(D),u.addBuffer(K)}if(G.geometricInfo&&H.geometricInfo){var J=G.geometricInfo.view.length+H.geometricInfo.view.length,$=new ArrayBuffer(J),ee=new Uint8Array($),te=new Uint8Array(this._data.buffer,G.geometricInfo.view.offset,G.geometricInfo.view.length),ie=new Uint8Array(e._data.buffer,H.geometricInfo.view.offset,H.geometricInfo.view.length);ee.set(te),ee.set(ie,te.length),u.setNextAlignment(4),U[V].geometricInfo={doubleSided:G.geometricInfo.doubleSided,view:{offset:u.getLength(),length:ee.length,count:G.geometricInfo.view.count+H.geometricInfo.view.count,stride:G.geometricInfo.view.stride}},u.addBuffer($)}}var ne={vertexBundles:g,primitives:U,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return ne.minPosition&&e._struct.minPosition&&Ni.min(ne.minPosition,ne.minPosition,e._struct.minPosition),ne.maxPosition&&e._struct.maxPosition&&Ni.max(ne.maxPosition,ne.maxPosition,e._struct.maxPosition),this.reset({struct:ne,data:new Uint8Array(u.getCombined())}),this.initialize(),!0}},{key:"validateMergingMesh",value:function(e){if(!this._data&&e._data)return!0;if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var i=this._struct.vertexBundles[t],n=e._struct.vertexBundles[t];if(i.attributes.length!==n.attributes.length)return!1;for(var r=0;r<i.attributes.length;++r)if(i.attributes[r].format!==n.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var a=0;a<this._struct.primitives.length;++a){var s=this._struct.primitives[a],o=e._struct.primitives[a];if(s.vertexBundelIndices.length!==o.vertexBundelIndices.length)return!1;for(var l=0;l<s.vertexBundelIndices.length;++l)if(s.vertexBundelIndices[l]!==o.vertexBundelIndices[l])return!1;if(s.primitiveMode!==o.primitiveMode)return!1;if(s.indexView){if(void 0===o.indexView)return!1}else if(o.indexView)return!1}return!0}},{key:"readAttribute",value:function(e,t){var d=this,_=null;return this._accessAttribute(e,t,function(e,t){var i=e.attributes[t].format,n=new DataView(d._data.buffer,e.view.offset+df(e.attributes,t)),r=xc[i],a=_f(i),s=vf(n,i);if(a&&s){for(var o=e.view.count,l=r.count,u=new a(o*l),c=e.view.stride,h=0;h<o;++h)for(var f=0;f<l;++f)u[l*h+f]=s(c*h+u.BYTES_PER_ELEMENT*f);_=u}}),_}},{key:"copyAttribute",value:function(e,t,v,m,y){var g=this,b=!1;return this._accessAttribute(e,t,function(e,t){var i=e.attributes[t].format,n=new DataView(g._data.buffer,e.view.offset+df(e.attributes,t)),r=new DataView(v,y),a=xc[i],s=vf(n,i),o=function(i,e){var t=xc[e],n=t.size/t.count;switch(t.type){case vc.UNORM:switch(n){case 1:return function(e,t){return i.setUint8(e,t)};case 2:return function(e,t){return i.setUint16(e,t,pf)};case 4:return function(e,t){return i.setUint32(e,t,pf)}}break;case vc.SNORM:switch(n){case 1:return function(e,t){return i.setInt8(e,t)};case 2:return function(e,t){return i.setInt16(e,t,pf)};case 4:return function(e,t){return i.setInt32(e,t,pf)}}break;case vc.INT:switch(n){case 1:return function(e,t){return i.setInt8(e,t)};case 2:return function(e,t){return i.setInt16(e,t,pf)};case 4:return function(e,t){return i.setInt32(e,t,pf)}}break;case vc.UINT:switch(n){case 1:return function(e,t){return i.setUint8(e,t)};case 2:return function(e,t){return i.setUint16(e,t,pf)};case 4:return function(e,t){return i.setUint32(e,t,pf)}}break;case vc.FLOAT:return function(e,t){return i.setFloat32(e,t,pf)}}return null}(r,i);if(s&&o){for(var l=e.view.count,u=a.count,c=e.view.stride,h=function(e){var t=xc[e];return t.size/t.count}(i),f=m,d=h,_=0;_<l;++_)for(var p=0;p<u;++p){o(f*_+d*p,s(c*_+h*p))}b=!0}}),b}},{key:"readIndices",value:function(e){if(!this._data||e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;for(var i=t.indexView.count,n=i<256?ru.R8UI:i<65536?ru.R16UI:ru.R32UI,r=new(_f(n))(i),a=vf(new DataView(this._data.buffer),n),s=0;s<i;++s)r[s]=a(t.indexView.offset+r.BYTES_PER_ELEMENT*s);return r}},{key:"copyIndices",value:function(e,t){if(!this._data||e>=this._struct.primitives.length)return!1;var i=this._struct.primitives[e];if(!i.indexView)return!1;for(var n=i.indexView.count,r=1===i.indexView.stride?ru.R8UI:2===i.indexView.stride?ru.R16UI:ru.R32UI,a=vf(new DataView(this._data.buffer),r),s=0;s<n;++s)t[s]=a(i.indexView.offset+xc[r].size*s);return!0}},{key:"createFlatBuffers",value:function(){if(!this._renderingMesh||this._hasFlatBuffers)return!1;cc.director.root.device;for(var e,t=0,i=0;i<this._struct.primitives.length;++i){var n=this._struct.primitives[i],r=this._renderingMesh.subMeshes[i];n.indexView&&(t=n.indexView.count);var a=n.vertexBundelIndices,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l,c=this._struct.vertexBundles[u],h=n.indexView?n.indexView.count:c.view.count,f=c.view.stride,d=f*h,_=new Uint8Array(this._data.buffer,c.view.offset,c.view.length);if(n.indexView){var p=new Uint8Array(d);e=2===(t<65536?2:4)?new Uint16Array(this._data.buffer,n.indexView.offset,n.indexView.count):new Uint32Array(this._data.buffer,n.indexView.offset,n.indexView.count);for(var v=0;v<t;++v)for(var m=v*f,y=e[v]*f,g=0;g<f;++g)p[m+g]=_[y+g];r.flatBuffers.push({stride:f,count:h,buffer:p.buffer})}else r.flatBuffers.push({stride:f,count:h,buffer:_.buffer})}}return this._hasFlatBuffers=!0}},{key:"destroyFlatBuffers",value:function(){if(this._hasFlatBuffers){if(this._renderingMesh)for(var e=this._renderingMesh.subMeshes,t=0;t<e.length;++t)e[t].flatBuffers.splice(0);this._hasFlatBuffers=!1}}},{key:"_accessAttribute",value:function(e,t,i){if(this._data&&!(e>=this._struct.primitives.length)){var n=this._struct.primitives[e].vertexBundelIndices,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=this._struct.vertexBundles[o],u=l.attributes.findIndex(function(e){return e.name===t});if(!(u<0)){i(l,u);break}}}}},{key:"_createVertexBuffers",value:function(n,r){var a=this;return this._struct.vertexBundles.map(function(e){var t=n.createBuffer({usage:su.VERTEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:e.view.length,stride:e.view.stride}),i=new Uint8Array(r,e.view.offset,e.view.length);return a.loaded?t.update(i):a.once("load",function(){t.update(i)}),t})}},{key:"renderingMesh",get:function(){return this.initialize(),this._renderingMesh}}]),t}()).prototype,"_struct",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),uf=m(of.prototype,"_dataLength",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sf=of))||sf);function df(e,t){for(var i=0,n=0;n<t;++n){var r=e[n];i+=xc[r.format].size}return i}function _f(e){var t=xc[e],i=t.size/t.count;switch(t.type){case vc.UNORM:case vc.UINT:switch(i){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case vc.SNORM:case vc.INT:switch(i){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case vc.FLOAT:return Float32Array}return null}cc.Mesh=ff;var pf=cc.sys.isLittleEndian;function vf(t,e){var i=xc[e],n=i.size/i.count;switch(i.type){case vc.UNORM:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,pf)};case 4:return function(e){return t.getUint32(e,pf)}}break;case vc.SNORM:switch(n){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,pf)};case 4:return function(e){return t.getInt32(e,pf)}}break;case vc.INT:switch(n){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,pf)};case 4:return function(e){return t.getInt32(e,pf)}}break;case vc.UINT:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,pf)};case 4:return function(e){return t.getUint32(e,pf)}}break;case vc.FLOAT:return function(e){return t.getFloat32(e,pf)}}return null}var mf={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},yf=m4("Layers",function(){function i(){y(this,i)}return l(i,null,[{key:"makeMaskInclude",value:function(e){var t=0,i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}t|=a}return t}},{key:"makeMaskExclude",value:function(e){return~i.makeMaskInclude(e)}},{key:"addLayer",value:function(e,t){void 0!==t?19<t||t<0?console.warn("maximum layers reached."):(i.Enum[e]=1<<t,i.Enum[t]=e,i.BitMask[e]=1<<t,i.BitMask[t]=e):console.warn("bitNum can't be undefined")}},{key:"deleteLayer",value:function(e){19<e||e<0?console.warn("do not change buildin layers."):(delete i.Enum[i.Enum[e]],delete i.Enum[e],delete i.BitMask[i.BitMask[e]],delete i.BitMask[e])}}]),i}());yf.Enum=vt(mf),yf.BitMask=pt(Object.assign({},mf)),cc.Layers=yf;var gf,bf,xf,Sf;(bf=gf=gf||m4("RenderPassStage",{}))[bf.DEFAULT=100]="DEFAULT",(Sf=xf=xf||{})[Sf.MIN=0]="MIN",Sf[Sf.MAX=255]="MAX",Sf[Sf.DEFAULT=128]="DEFAULT";var Tf,wf;(wf=Tf=Tf||{})[wf.UBO_GLOBAL=23]="UBO_GLOBAL",wf[wf.UBO_SHADOW=22]="UBO_SHADOW",wf[wf.UBO_LOCAL=21]="UBO_LOCAL",wf[wf.UBO_LOCAL_BATCHED=20]="UBO_LOCAL_BATCHED",wf[wf.UBO_FORWARD_LIGHTS=19]="UBO_FORWARD_LIGHTS",wf[wf.UBO_SKINNING_ANIMATION=18]="UBO_SKINNING_ANIMATION",wf[wf.UBO_SKINNING_TEXTURE=17]="UBO_SKINNING_TEXTURE",wf[wf.UBO_UI=16]="UBO_UI",wf[wf.SAMPLER_JOINTS=25]="SAMPLER_JOINTS",wf[wf.SAMPLER_ENVIRONMENT=26]="SAMPLER_ENVIRONMENT",wf[wf.CUSTUM_UBO_BINDING_END_POINT=17]="CUSTUM_UBO_BINDING_END_POINT",wf[wf.CUSTOM_SAMPLER_BINDING_START_POINT=30]="CUSTOM_SAMPLER_BINDING_START_POINT";function Ef(e){return e>=Tf.CUSTUM_UBO_BINDING_END_POINT&&e<Tf.CUSTOM_SAMPLER_BINDING_START_POINT}function Af(){y(this,Af),this.view=new Float32Array(Af.COUNT)}Af.SIZE=4*(Af.COUNT=(Af.AMBIENT_GROUND_OFFSET=(Af.AMBIENT_SKY_OFFSET=(Af.MAIN_LIT_COLOR_OFFSET=(Af.MAIN_LIT_DIR_OFFSET=(Af.EXPOSURE_OFFSET=(Af.CAMERA_POS_OFFSET=(Af.MAT_VIEW_PROJ_INV_OFFSET=(Af.MAT_VIEW_PROJ_OFFSET=(Af.MAT_PROJ_INV_OFFSET=(Af.MAT_PROJ_OFFSET=(Af.MAT_VIEW_INV_OFFSET=(Af.MAT_VIEW_OFFSET=(Af.NATIVE_SIZE_OFFSET=(Af.SCREEN_SCALE_OFFSET=(Af.SCREEN_SIZE_OFFSET=(Af.TIME_OFFSET=0)+4)+4)+4)+4)+16)+16)+16)+16)+16)+16)+4)+4)+4)+4)+4)+4),Af.BLOCK={binding:Tf.UBO_GLOBAL,name:"CCGlobal",members:[{name:"cc_time",type:iu.FLOAT4,count:1},{name:"cc_screenSize",type:iu.FLOAT4,count:1},{name:"cc_screenScale",type:iu.FLOAT4,count:1},{name:"cc_nativeSize",type:iu.FLOAT4,count:1},{name:"cc_matView",type:iu.MAT4,count:1},{name:"cc_matViewInv",type:iu.MAT4,count:1},{name:"cc_matProj",type:iu.MAT4,count:1},{name:"cc_matProjInv",type:iu.MAT4,count:1},{name:"cc_matViewProj",type:iu.MAT4,count:1},{name:"cc_matViewProjInv",type:iu.MAT4,count:1},{name:"cc_cameraPos",type:iu.FLOAT4,count:1},{name:"cc_exposure",type:iu.FLOAT4,count:1},{name:"cc_mainLitDir",type:iu.FLOAT4,count:1},{name:"cc_mainLitColor",type:iu.FLOAT4,count:1},{name:"cc_ambientSky",type:iu.FLOAT4,count:1},{name:"cc_ambientGround",type:iu.FLOAT4,count:1}]};function Cf(){y(this,Cf),this.view=new Float32Array(Cf.COUNT)}Cf.SIZE=4*(Cf.COUNT=(Cf.SHADOW_COLOR_OFFSET=(Cf.MAT_LIGHT_PLANE_PROJ_OFFSET=0)+16)+4),Cf.BLOCK={binding:Tf.UBO_SHADOW,name:"CCShadow",members:[{name:"cc_matLightPlaneProj",type:iu.MAT4,count:1},{name:"cc_shadowColor",type:iu.FLOAT4,count:1}]};function kf(){y(this,kf),this.view=new Float32Array(kf.COUNT)}var Rf={binding:Tf.SAMPLER_ENVIRONMENT,name:"cc_environment",type:iu.SAMPLER_CUBE,count:1},Of=new Map;kf.BATCHING_COUNT=10,kf.SIZE=4*(kf.COUNT=(kf.MAT_WORLDS_OFFSET=(kf.MAT_WORLD_IT_OFFSET=(kf.MAT_WORLD_OFFSET=0)+16)+16)+16*kf.BATCHING_COUNT),kf.BLOCK={binding:Tf.UBO_LOCAL,name:"CCLocal",members:[{name:"cc_matWorld",type:iu.MAT4,count:1},{name:"cc_matWorldIT",type:iu.MAT4,count:1},{name:"cc_matWorlds",type:iu.MAT4,count:kf.BATCHING_COUNT}]},Of.set(kf.BLOCK.name,{type:Yu.UNIFORM_BUFFER,blockInfo:kf.BLOCK});function Mf(){y(this,Mf),this.view=new Float32Array(Mf.COUNT)}Mf.MAX_SPHERE_LIGHTS=2,Mf.MAX_SPOT_LIGHTS=2,Mf.SIZE=4*(Mf.COUNT=(Mf.SPOT_LIGHT_COLOR_OFFSET=(Mf.SPOT_LIGHT_DIR_OFFSET=(Mf.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET=(Mf.SPOT_LIGHT_POS_OFFSET=(Mf.SPHERE_LIGHT_COLOR_OFFSET=(Mf.SPHERE_LIGHT_SIZE_RANGE_OFFSET=(Mf.SPHERE_LIGHT_POS_OFFSET=0)+4*Mf.MAX_SPHERE_LIGHTS)+4*Mf.MAX_SPHERE_LIGHTS)+4*Mf.MAX_SPOT_LIGHTS)+4*Mf.MAX_SPOT_LIGHTS)+4*Mf.MAX_SPOT_LIGHTS)+4*Mf.MAX_SPOT_LIGHTS)+4*Mf.MAX_SPOT_LIGHTS),Mf.BLOCK={binding:Tf.UBO_FORWARD_LIGHTS,name:"CCForwardLight",members:[{name:"cc_sphereLitPos",type:iu.FLOAT4,count:Mf.MAX_SPHERE_LIGHTS},{name:"cc_sphereLitSizeRange",type:iu.FLOAT4,count:Mf.MAX_SPHERE_LIGHTS},{name:"cc_sphereLitColor",type:iu.FLOAT4,count:Mf.MAX_SPHERE_LIGHTS},{name:"cc_spotLitPos",type:iu.FLOAT4,count:Mf.MAX_SPOT_LIGHTS},{name:"cc_spotLitSizeRangeAngle",type:iu.FLOAT4,count:Mf.MAX_SPOT_LIGHTS},{name:"cc_spotLitDir",type:iu.FLOAT4,count:Mf.MAX_SPOT_LIGHTS},{name:"cc_spotLitColor",type:iu.FLOAT4,count:Mf.MAX_SPOT_LIGHTS}]},Of.set(Mf.BLOCK.name,{type:Yu.UNIFORM_BUFFER,blockInfo:Mf.BLOCK});function If(){y(this,If)}If.SIZE=4*(If.COUNT=(If.JOINTS_TEXTURE_INFO_OFFSET=0)+4),If.BLOCK={binding:Tf.UBO_SKINNING_TEXTURE,name:"CCSkinningTexture",members:[{name:"cc_jointsTextureInfo",type:iu.FLOAT4,count:1}]},Of.set(If.BLOCK.name,{type:Yu.UNIFORM_BUFFER,blockInfo:If.BLOCK});function Bf(){y(this,Bf)}Bf.SIZE=4*(Bf.COUNT=(Bf.JOINTS_ANIM_INFO_OFFSET=0)+4),Bf.BLOCK={binding:Tf.UBO_SKINNING_ANIMATION,name:"CCSkinningAnimation",members:[{name:"cc_jointsAnimInfo",type:iu.FLOAT4,count:1}]},Of.set(Bf.BLOCK.name,{type:Yu.UNIFORM_BUFFER,blockInfo:Bf.BLOCK});var Lf={binding:Tf.SAMPLER_JOINTS,name:"cc_jointsTexture",type:iu.SAMPLER2D,count:1};Of.set(Lf.name,{type:Yu.SAMPLER,samplerInfo:Lf});var Pf=yf.makeMaskExclude([yf.BitMask.UI_2D,yf.BitMask.GIZMOS,yf.BitMask.EDITOR,yf.BitMask.SCENE_GIZMO,yf.BitMask.PROFILER]),Ff=yf.makeMaskExclude([yf.BitMask.UI_2D,yf.BitMask.PROFILER]),zf=(yf.Enum.ALL,function(){function t(e){y(this,t),this._onAttach=void 0,this._onDetach=void 0,this._models={},this._onAttach=e.onAttach,this._onDetach=e.onDetach}return l(t,[{key:"attach",value:function(e){var t=this._models,i=e.id;t[i]?t[i]++:(this._onAttach&&this._onAttach(e),t[i]=1)}},{key:"detach",value:function(e){var t=this._models,i=e.id;!t[i]||0<--t[i]||this._onDetach&&this._onDetach(e)}}]),t}()),Df=new(function(){function e(){y(this,e),this._customs={}}return l(e,[{key:"register",value:function(e,t){this._customs[e]=new zf(t)}},{key:"attach",value:function(e,t){var i=this._customs[e];i?i.attach(t):console.warn("no customization named '".concat(e,"'"))}},{key:"detach",value:function(e,t){var i=this._customs[e];i?i.detach(t):console.warn("no customization named '".concat(e,"'"))}}]),e}());cc.customizationManager=Df;var Nf=function(){function e(){y(this,e),this._subMeshObject=void 0,this._inputAssembler=void 0,this._material=void 0,this._cmdBuffers=void 0,this._psos=void 0,this._priority=void 0,this._subMeshObject=null,this._material=null,this._cmdBuffers=new Array,this._psos=null,this._inputAssembler=null,this._priority=xf.DEFAULT}return l(e,[{key:"initialize",value:function(e,t,i){this._psos=i,this.subMeshData=e,this.material=t}},{key:"destroy",value:function(){this._inputAssembler&&this._inputAssembler.destroy();for(var e=0;e<this.passes.length;e++)this.passes[e].destroyPipelineState(this._psos[e]);var t=this._cmdBuffers,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.destroy()}this._cmdBuffers.splice(0),this._material=null}},{key:"updateCommandBuffer",value:function(){if(this._material){for(var e=0;e<this._material.passes.length;e++)this._subMeshObject&&this._material.passes[e].primitive!==this._subMeshObject.primitiveMode&&console.warn("mesh primitive type doesn't match with pass settings"),this.recordCommandBuffer(e);for(var t=this._cmdBuffers.length-1;t>=this._material.passes.length;t--){var i=this._cmdBuffers.pop();i&&i.destroy()}}}},{key:"recordCommandBuffer",value:function(e){var t=cc.director.root.device,i=this._psos[e];if(null==this._cmdBuffers[e]){var n={allocator:t.commandAllocator,type:Qu.SECONDARY};this._cmdBuffers[e]=t.createCommandBuffer(n)}else this._cmdBuffers[e].status===Yl.UNREADY&&this._cmdBuffers[e].initialize({allocator:t.commandAllocator,type:Qu.SECONDARY});var r=this._inputAssembler,a=this._cmdBuffers[e];a.begin(),a.bindPipelineState(i),a.bindBindingLayout(i.pipelineLayout.layouts[0]),a.bindInputAssembler(r),a.draw(r),a.end()}},{key:"priority",set:function(e){this._priority=e},get:function(){return this._priority}},{key:"subMeshData",set:function(e){this._inputAssembler&&this._inputAssembler.destroy(),this._subMeshObject=e;var t={};t.attributes=this._subMeshObject.attributes,t.vertexBuffers=this._subMeshObject.vertexBuffers,this._subMeshObject.indexBuffer&&(t.indexBuffer=this._subMeshObject.indexBuffer),this._subMeshObject.indirectBuffer&&(t.indirectBuffer=this._subMeshObject.indirectBuffer),this._inputAssembler?this._inputAssembler.initialize(t):this._inputAssembler=cc.director.root.device.createInputAssembler(t)},get:function(){return this._subMeshObject}},{key:"psos",get:function(){return this._psos},set:function(e){this._psos=e}},{key:"material",set:function(e){null!=(this._material=e)&&this.updateCommandBuffer()},get:function(){return this._material}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"passes",get:function(){return this._material.passes}},{key:"commandBuffers",get:function(){return this._cmdBuffers}}]),e}(),Uf=new Pn,Vf=new Rs(function(){return new Nf},32);function Gf(e){var t=0,i=e.members,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t+=Ec(s.type)*s.count}return t}var Hf=function(){function i(e,t){y(this,i),this._type="default",this._device=void 0,this._scene=void 0,this._node=void 0,this._transform=void 0,this._id=void 0,this._enabled=!1,this._visFlags=yf.Enum.NONE,this._cameraID=-1,this._userKey=-1,this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._matPSORecord=void 0,this._matRefCount=void 0,this._uboLocal=void 0,this._localUBO=null,this._localBindings=new Map,this._inited=!1,this._uboUpdated=!1,this._castShadow=!1,this._isDynamicBatching=!1,this._transformUpdated=!0,this._device=cc.director.root.device,this._scene=e,this._id=this._scene.generateModelId(),this._transform=this._node=t,this._matPSORecord=new Map,this._matRefCount=new Map,this._uboLocal=new kf}return l(i,[{key:"scene",set:function(e){this._scene=e,this._id=this._scene.generateModelId()},get:function(){return this._scene}},{key:"id",get:function(){return this._id}},{key:"subModels",get:function(){return this._subModels}},{key:"subModelNum",get:function(){return this._subModels.length}},{key:"inited",get:function(){return this._inited}},{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"userKey",set:function(e){this._userKey=e}},{key:"uboLocal",get:function(){return this._uboLocal}},{key:"localUBO",get:function(){return this._localUBO}},{key:"localBindings",get:function(){return this._localBindings}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"isDynamicBatching",get:function(){return this._isDynamicBatching},set:function(e){this._isDynamicBatching=e}},{key:"UBOUpdated",get:function(){return this._uboUpdated}}]),l(i,[{key:"destroy",value:function(){var e=this._subModels,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.destroy(),Vf.free(r)}for(var a=this._localBindings.values(),s=a.next();!s.done;){var o=s.value;o.buffer&&(o.buffer.destroy(),o.buffer=void 0),s=a.next()}this._localBindings.has(Mf.BLOCK.name)&&this._localBindings.delete(Mf.BLOCK.name),this._worldBounds=null,this._modelBounds=null,this._subModels.splice(0),this._matPSORecord.clear(),this._matRefCount.clear(),this._inited=!1}},{key:"getSubModel",value:function(e){return this._subModels[e]}},{key:"updateTransform",value:function(){var e=this._transform;(e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdated=!0,this._modelBounds&&this._worldBounds&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds))}},{key:"_resetUBOUpdateFlag",value:function(){this._uboUpdated=!1}},{key:"updateUBOs",value:function(){if(this._uboUpdated)return!1;if(this._uboUpdated=!0,this._transformUpdated&&!this._isDynamicBatching){var e=this._transform._mat;Pn.toArray(this._uboLocal.view,e,kf.MAT_WORLD_OFFSET),Pn.inverseTranspose(Uf,e),Pn.toArray(this._uboLocal.view,Uf,kf.MAT_WORLD_IT_OFFSET);var t=this._localBindings.get(kf.BLOCK.name);t&&t.buffer&&t.buffer.update(this._uboLocal.view),this._transformUpdated=!1}return this._matPSORecord.forEach(this._updatePass,this),!0}},{key:"createBoundingShape",value:function(e,t){e&&t&&(this._modelBounds=cs.fromPoints(cs.create(),e,t),this._worldBounds=cs.clone(this._modelBounds),this._transform.updateWorldTransform(),this._modelBounds.transform(this._transform._mat,this._transform._pos,this._transform._rot,this._transform._scale,this._worldBounds))}},{key:"initSubModel",value:function(e,t,i){if(this.initLocalBindings(i),null==this._subModels[e])this._subModels[e]=Vf.alloc();else{var n=this._subModels[e].material;this._subModels[e].destroy(),this.releasePSO(n)}this.allocatePSO(i),this._subModels[e].initialize(t,i,this._matPSORecord.get(i)),this._inited=!0}},{key:"setSubModelMesh",value:function(e,t){null==this._subModels[e]&&(this._subModels[e]=Vf.alloc()),this._subModels[e].subMeshData=t}},{key:"setSubModelMaterial",value:function(e,t){null!=this._subModels[e]&&(this.initLocalBindings(t),this._subModels[e].material===t?t&&(this.destroyPipelineState(t,this._matPSORecord.get(t)),this._matPSORecord.set(t,this.createPipelineState(t))):(this._subModels[e].material&&this.releasePSO(this._subModels[e].material),t&&this.allocatePSO(t)),this._subModels[e].psos=t&&this._matPSORecord.get(t)||null,this._subModels[e].material=t)}},{key:"onPipelineChange",value:function(){var e=this._subModels,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}for(var r=n,a=r.material,s=this._matPSORecord.get(a),o=0;o<a.passes.length;o++){var l=a.passes[o];l.tryCompile(),l.destroyPipelineState(s[o]),s[o]=this._doCreatePSO(l),s[o].pipelineLayout.layouts[0].update()}r.updateCommandBuffer()}}},{key:"createPipelineState",value:function(e){for(var t=new Array(e.passes.length),i=0;i<t.length;i++){var n=e.passes[i],r=n.customizations,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;Df.attach(l,this)}t[i]=this._doCreatePSO(n)}return t}},{key:"destroyPipelineState",value:function(e,t){for(var i=0;i<e.passes.length;i++){var n=e.passes[i];n.destroyPipelineState(t[i]);var r=n.customizations,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;Df.detach(l,this)}}}},{key:"_doCreatePSO",value:function(e){var t=e.createPipelineState();return t.pipelineLayout.layouts[0].bindBuffer(kf.BLOCK.binding,this._localBindings.get(kf.BLOCK.name).buffer),this._localBindings.has(Mf.BLOCK.name)&&t.pipelineLayout.layouts[0].bindBuffer(Mf.BLOCK.binding,this._localBindings.get(Mf.BLOCK.name).buffer),t}},{key:"onSetLocalBindings",value:function(e){this._localBindings.has(kf.BLOCK.name)||this._localBindings.set(kf.BLOCK.name,{type:Yu.UNIFORM_BUFFER,blockInfo:kf.BLOCK});var t=!1,i=e.passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}if(a.bindings.find(function(e){return e.name===Mf.BLOCK.name})){t=!0;break}}t&&"ForwardPipeline"===cc.director.root.pipeline.name&&(this._localBindings.has(Mf.BLOCK.name)||this._localBindings.set(Mf.BLOCK.name,{type:Yu.UNIFORM_BUFFER,blockInfo:Mf.BLOCK}))}},{key:"initLocalBindings",value:function(e){if(e){this.onSetLocalBindings(e);for(var t=this._localBindings.values(),i=t.next();!i.done;){var n=i.value;n.buffer||(n.buffer=this._device.createBuffer({usage:su.UNIFORM|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:Gf(n.blockInfo)})),i=t.next()}}}},{key:"_updatePass",value:function(e,t){for(var i=0;i<t.passes.length;i++)t.passes[i].update();for(var n=0;n<e.length;n++)e[n].pipelineLayout.layouts[0].update()}},{key:"allocatePSO",value:function(e){null==this._matRefCount.get(e)?(this._matRefCount.set(e,1),this._matPSORecord.set(e,this.createPipelineState(e))):this._matRefCount.set(e,this._matRefCount.get(e)+1)}},{key:"releasePSO",value:function(e){this._matRefCount.set(e,this._matRefCount.get(e)-1),0===this._matRefCount.get(e)&&(this.destroyPipelineState(e,this._matPSORecord.get(e)),this._matPSORecord.delete(e),this._matRefCount.delete(e))}}]),i}(),Wf=function(){function a(){y(this,a)}return l(a,null,[{key:"create",value:function(e){var t=a.pool.get(e);if(t)return t;var i=cc.director.root.device.createBuffer({usage:su.UNIFORM|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:Bf.SIZE,stride:Bf.SIZE}),n=new Float32Array([1,0,0,0]);i.update(n);var r={buffer:i,data:n};return a.pool.set(e,r),r}},{key:"destroy",value:function(e){var t=a.pool.get(e);t&&(t.buffer.destroy(),a.pool.delete(e))}},{key:"switchClip",value:function(e,t){var i=a.pool.get(e);i&&(i.data[0]=t?t.keys[0].length:1,i.data[1]=0,i.buffer.update(i.data))}},{key:"get",value:function(e){return a.pool.get(e)||a.create(-1)}}]),a}();Wf.pool=new Map;var qf,jf,Xf,Yf=uh([Iu.POINT,Iu.POINT,Iu.NONE,Lu.CLAMP,Lu.CLAMP,Lu.CLAMP]),Kf=function(){function o(e,t){var i;y(this,o),(i=x(this,g(o).call(this,e,t))).uploadedAnim=null,i._jointsMedium=void 0,i._skeleton=null,i._type="skinning";var n=new Float32Array(4),r=i._scene.texturePool.getDefaultJointsTexture();return i._jointsMedium={buffer:null,jointsTextureInfo:n,texture:r},i}return _(o,Hf),l(o,[{key:"worldBounds",get:function(){return this.uploadedAnim?null:this._worldBounds}}]),l(o,[{key:"destroy",value:function(){p(g(o.prototype),"destroy",this).call(this),this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null)}},{key:"bindSkeleton",value:function(e,t){(this._skeleton=e)&&t&&(this._transform=t,this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer({usage:su.UNIFORM|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:If.SIZE,stride:If.SIZE})),this.uploadAnimation(this.uploadedAnim))}},{key:"uploadAnimation",value:function(e){if(this._skeleton){this.uploadedAnim=e;var t=this.uploadedAnim?this._scene.texturePool.getJointsTextureWithAnimation(this._skeleton,this.uploadedAnim):this._scene.texturePool.getDefaultJointsTexture(this._skeleton);Wf.switchClip(this._transform.uuid,e),this._applyJointsTexture(t)}}},{key:"_applyJointsTexture",value:function(e){if(e){this._jointsMedium.texture=e;var t=this._jointsMedium,i=t.buffer,n=t.jointsTextureInfo;n[0]=e.handle.texture.width,n[1]=1/n[0],n[2]=e.pixelOffset+.1,i&&i.update(n);var r=Rh.getSampler(this._device,Yf),a=this._subModels,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l;if(u.psos){var c=u.psos,h=Array.isArray(c),f=0;for(c=h?c:c[Symbol.iterator]();;){var d;if(h){if(f>=c.length)break;d=c[f++]}else{if((f=c.next()).done)break;d=f.value}var _=d;_.pipelineLayout.layouts[0].bindTextureView(Lf.binding,e.handle.texView),_.pipelineLayout.layouts[0].bindSampler(Lf.binding,r)}}}}}},{key:"_doCreatePSO",value:function(e){var t=p(g(o.prototype),"_doCreatePSO",this).call(this,e),i=this._jointsMedium,n=i.buffer,r=i.texture,a=Wf.get(this._transform.uuid);t.pipelineLayout.layouts[0].bindBuffer(If.BLOCK.binding,n),t.pipelineLayout.layouts[0].bindBuffer(Bf.BLOCK.binding,a.buffer);var s=Rh.getSampler(this._device,Yf);return r&&(t.pipelineLayout.layouts[0].bindTextureView(Lf.binding,r.handle.texView),t.pipelineLayout.layouts[0].bindSampler(Lf.binding,s)),t}}]),o}();(Xf=jf=jf||{})[Xf.positions=eu.ATTR_POSITION]="positions",Xf[Xf.normals=eu.ATTR_NORMAL]="normals",Xf[Xf.uvs=eu.ATTR_TEX_COORD]="uvs",Xf[Xf.colors=eu.ATTR_COLOR]="colors";var Qf=[{name:eu.ATTR_POSITION,format:ru.RGB32F},{name:eu.ATTR_NORMAL,format:ru.RGB32F},{name:eu.ATTR_TEX_COORD,format:ru.RG32F},{name:eu.ATTR_COLOR,format:ru.RGBA32F}],Zf=new Ni;function Jf(e,t,i){i=i||{};var n,r=[],a=0,s=[],o=0;if(0<e.positions.length){if(n=null,e.attributes){var l=e.attributes,u=Array.isArray(l),c=0;for(l=u?l:l[Symbol.iterator]();;){var h;if(u){if(c>=l.length)break;h=l[c++]}else{if((c=l.next()).done)break;h=c.value}var f=h;if(f.name===eu.ATTR_POSITION){n=f;break}}}n=n||Qf[0];var d=xc[n.format];r.push(n),o=Math.max(o,Math.floor(e.positions.length/d.count)),s.push({offset:a,data:e.positions,attribute:n}),a+=d.size}if(e.normals&&0<e.normals.length){if(n=null,e.attributes){var _=e.attributes,p=Array.isArray(_),v=0;for(_=p?_:_[Symbol.iterator]();;){var m;if(p){if(v>=_.length)break;m=_[v++]}else{if((v=_.next()).done)break;m=v.value}var y=m;if(y.name===eu.ATTR_NORMAL){n=y;break}}}n=n||Qf[1];var g=xc[n.format];r.push(n),o=Math.max(o,Math.floor(e.normals.length/g.count)),s.push({offset:a,data:e.normals,attribute:n}),a+=g.size}if(e.uvs&&0<e.uvs.length){if(n=null,e.attributes){var b=e.attributes,x=Array.isArray(b),S=0;for(b=x?b:b[Symbol.iterator]();;){var T;if(x){if(S>=b.length)break;T=b[S++]}else{if((S=b.next()).done)break;T=S.value}var w=T;if(w.name===eu.ATTR_TEX_COORD){n=w;break}}}n=n||Qf[2];var E=xc[n.format];r.push(n),o=Math.max(o,Math.floor(e.uvs.length/E.count)),s.push({offset:a,data:e.uvs,attribute:n}),a+=E.size}if(e.colors&&0<e.colors.length){if(n=null,e.attributes){var A=e.attributes,C=Array.isArray(A),k=0;for(A=C?A:A[Symbol.iterator]();;){var R;if(C){if(k>=A.length)break;R=A[k++]}else{if((k=A.next()).done)break;R=k.value}var O=R;if(O.name===eu.ATTR_COLOR){n=O;break}}}n=n||Qf[3];var M=xc[n.format];r.push(n),o=Math.max(o,Math.floor(e.colors.length/M.count)),s.push({offset:a,data:e.colors,attribute:n}),a+=M.size}if(e.customAttributes){var I=e.customAttributes,B=Array.isArray(I),L=0;for(I=B?I:I[Symbol.iterator]();;){var P;if(B){if(L>=I.length)break;P=I[L++]}else{if((L=I.next()).done)break;P=L.value}var F=P,z=xc[F.attr.format];r.push(F.attr),o=Math.max(o,Math.floor(F.values.length/z.count)),s.push({offset:a,data:F.values,attribute:F.attr}),a+=z.size}}for(var D=new cf,N=new ArrayBuffer(o*a),U=new DataView(N),V=0,G=s;V<G.length;V++){var H=G[V];id(U,H.data,H.attribute.format,H.offset,a)}D.setNextAlignment(0);var W={attributes:r,view:{offset:D.getLength(),length:N.byteLength,count:o,stride:a}};D.addBuffer(N);var q=null,j=0;if(e.indices){var X=e.indices;j=X.length,q=new ArrayBuffer(2*j),id(new DataView(q),X,ru.R16UI)}var Y={primitiveMode:e.primitiveMode||_u.TRIANGLE_LIST,vertexBundelIndices:[0]};if(Y.primitiveMode>=_u.TRIANGLE_LIST){var K=Float32Array.from(e.positions);D.setNextAlignment(4),Y.geometricInfo={doubleSided:e.doubleSided,view:{offset:D.getLength(),length:K.byteLength,count:e.positions.length/4,stride:4}},D.addBuffer(K.buffer)}q&&(D.setNextAlignment(2),Y.indexView={offset:D.getLength(),length:q.byteLength,count:j,stride:2},D.addBuffer(q));var Q=e.minPos;if(!Q&&i.calculateBounds){Q=Ni.set(new Ni,1/0,1/0,1/0);for(var Z=0;Z<o;++Z)Ni.set(Zf,e.positions[3*Z+0],e.positions[3*Z+1],e.positions[3*Z+2]),Ni.min(Q,Q,Zf)}var J=e.maxPos;if(!J&&i.calculateBounds){J=Ni.set(new Ni,-1/0,-1/0,-1/0);for(var $=0;$<o;++$)Ni.set(Zf,e.positions[3*$+0],e.positions[3*$+1],e.positions[3*$+2]),Ni.max(J,J,Zf)}var ee={vertexBundles:[W],primitives:[Y]};return Q&&(ee.minPosition=new Ni(Q.x,Q.y,Q.z)),J&&(ee.maxPosition=new Ni(J.x,J.y,J.z)),(t=t||new ff).reset({struct:ee,data:new Uint8Array(D.getCombined())}),t}var $f=cc.sys.isLittleEndian,ed=(s(qf={},vc.UNORM,"Uint"),s(qf,vc.SNORM,"Int"),s(qf,vc.UINT,"Uint"),s(qf,vc.INT,"Int"),s(qf,vc.UFLOAT,"Float"),s(qf,vc.FLOAT,"Float"),s(qf,"default","Uint"),qf);function td(e){return(ed[e.type]||ed.default)+e.size/e.count*8}function id(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:ru.R32F,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=xc[i];r=r||a.size;for(var s="set"+td(a),o=a.size/a.count,l=Math.floor(t.length/a.count),u=0;u<l;++u)for(var c=n+r*u,h=0;h<a.count;++h){var f=c+o*h;e[s](f,t[a.count*u+h],$f)}}function nd(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:ru.R32F,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:e.byteLength-i,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:[],s=xc[t];r=r||s.size;for(var o="get"+td(s),l=s.size/s.count,u=Math.floor(n/r),c=0;c<u;++c)for(var h=i+r*c,f=0;f<s.count;++f){var d=h+l*f;a[s.count*c+f]=e[o](d,$f)}return a}function rd(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:ru.R32F,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:e.byteLength-n,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,s=6<arguments.length?arguments[6]:void 0;s=s||new DataView(new ArrayBuffer(e.byteLength));var o=xc[i];a=a||o.size;for(var l="set"+td(o),u="get"+td(o),c=o.size/o.count,h=Math.floor(r/a),f=0;f<h;++f)for(var d=n+a*f,_=0;_<o.count;++_){var p=d+c*_,v=e[u](p,$f);s[l](p,t(v,_,e),$f)}return s}var ad=[],sd=new Ni;var od=new(function(){function e(){y(this,e),this._cached=new Map}return l(e,[{key:"use",value:function(e,t){var i=this._cached.get(e);i||(i=new Map,this._cached.set(e,i));var n=i.get(t);return n||(n={bounds:function(e,t){for(var i=new Array(t.joints.length),n=0;n<i.length;++n)i[n]={hasValue:!1,min:new Ni(1/0,1/0,1/0),max:new Ni(-1/0,-1/0,-1/0)};for(var r=0;r<e.struct.primitives.length;++r){var a=e.readAttribute(r,eu.ATTR_JOINTS);if(a){var s=e.readAttribute(r,eu.ATTR_WEIGHTS);if(s){var o=e.readAttribute(r,eu.ATTR_POSITION);if(o)for(var l=Math.min(a.length/4,s.length/4,o.length/3),u=0;u<l;++u){Ni.set(Zf,o[3*u+0],o[3*u+1],o[3*u+2]);for(var c=0;c<4;++c){if(0!==s[4*u+c]){var h=a[4*u+c];if(!(h>=t.joints.length)){t.bindposes?Ni.transformMat4(sd,Zf,t.bindposes[h]):Ni.copy(sd,Zf);var f=i[h];f.hasValue=!0,Ni.min(f.min,f.min,sd),Ni.max(f.max,f.max,sd)}}}}}}}return i.map(function(e){return e.hasValue?cs.fromPoints(new cs,e.min,e.max):null})}(e,t),referenceCount:0},i.set(t,n)),++n.referenceCount,n.bounds}},{key:"unuse",value:function(e,t){var i=this._cached.get(e);if(i){var n=i.get(t);n&&(--n.referenceCount,0===n.referenceCount&&i.delete(t)),0===i.size&&this._cached.delete(e)}}}]),e}()),ld=new Pn,ud=new Pn,cd=new cs,hd=new Ni,fd=new Ni;var dd=Object.freeze({toPPM:function(e,t,i){return"P3 ".concat(t," ").concat(i," 255\n").concat(e.filter(function(e,t){return t%4<3}).toString(),"\n")},createMesh:Jf,readMesh:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i={positions:[]},n=new DataView(e._nativeAsset),r=e.struct,a=r.primitives[t],s=a.vertexBundelIndices,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if(o){if(l>=s.length)break;u=s[l++]}else{if((l=s.next()).done)break;u=l.value}var c=u,h=r.vertexBundles[c],f=h.view.offset,d=h.view,_=d.length,p=d.stride,v=h.attributes,m=Array.isArray(v),y=0;for(v=m?v:v[Symbol.iterator]();;){var g;if(m){if(y>=v.length)break;g=v[y++]}else{if((y=v.next()).done)break;g=y.value}var b=g,x=jf[b.name];x&&(i[x]=(i[x]||[]).concat(nd(n,b.format,f,_,p))),f+=xc[b.format].size}}var S=a.indexView;return i.indices=nd(n,ru["R".concat(8*S.stride,"UI")],S.offset,S.length),i},writeBuffer:id,readBuffer:nd,mapBuffer:rd,LCA:function(e,t){if(e===t)return e;var i=t;for(ad.length=0;i;)ad.push(i),i=i.parent;for(i=e;i;){if(ad.find(function(e){return e===i}))return i;i=i.parent}return null},calculateSkinnedBounds:function(e,t){if(t.model&&t.mesh){var i=t.skeleton,n=t.skinningRoot,r=t.model.uploadedAnim,a=n&&Wf.get(n.uuid);if(!(i&&n&&r&&a)){if(!t.model.worldBounds)return;return cs.copy(e,t.model.worldBounds),!0}Ni.set(hd,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),Ni.set(fd,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),n.getWorldMatrix(ld);for(var s=od.use(t.mesh,i),o=i.joints.length,l=r.convertedData,u=a.data[1],c=0;c<o;++c){var h=s[c],f=l[i.joints[c]];if(h&&f&&f.props){var d=f.props.worldMatrix.values[u];Pn.multiply(ud,ld,d),cs.transform(cd,h,ud),cd.getBoundary(Zf,sd),Ni.min(hd,hd,Zf),Ni.max(fd,fd,sd)}}return cs.fromPoints(e,hd,fd),!0}},find:af});m4("utils",dd);function _d(){y(this,_d),this.isA2C=!1,this.isIndepend=!1,this.blendColor=[0,0,0,0],this.targets=[new bd]}function pd(){y(this,pd),this.attributes=[]}var vd=m4("GFXInputAssembler",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,jl.INPUT_ASSEMBLER)))._device=void 0,t._attributes=[],t._vertexBuffers=[],t._indexBuffer=null,t._vertexCount=0,t._firstVertex=0,t._indexCount=0,t._firstIndex=0,t._vertexOffset=0,t._instanceCount=0,t._firstInstance=0,t._isIndirect=!1,t._indirectBuffer=null,t._device=e,t}return _(i,pc),l(i,[{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"attributes",get:function(){return this._attributes}},{key:"vertexCount",get:function(){return this._vertexCount},set:function(e){this._vertexCount=e}},{key:"firstVertex",get:function(){return this._firstVertex},set:function(e){this._firstVertex=e}},{key:"indexCount",get:function(){return this._indexCount},set:function(e){this._indexCount=e}},{key:"firstIndex",get:function(){return this._firstIndex},set:function(e){this._firstIndex=e}},{key:"vertexOffset",get:function(){return this._vertexOffset},set:function(e){this._vertexOffset=e}},{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"firstInstance",get:function(){return this._firstInstance},set:function(e){this._firstInstance=e}},{key:"isIndirect",get:function(){return this._isIndirect}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}}]),l(i,[{key:"getVertexBuffer",value:function(e){var t=0<arguments.length&&void 0!==e?e:0;return t<this._vertexBuffers.length?this._vertexBuffers[t]:null}},{key:"extractDrawInfo",value:function(e){e.vertexCount=this._vertexCount,e.firstVertex=this._firstVertex,e.indexCount=this._indexCount,e.firstIndex=this._firstIndex,e.vertexOffset=this._vertexOffset,e.instanceCount=this._instanceCount,e.firstInstance=this._firstInstance}},{key:"updateVertexAttr",value:function(e,t,i,n,r){var a=3<arguments.length&&void 0!==n?n:0,s=!(4<arguments.length&&void 0!==r)||r,o=0,l=ru.UNKNOWN,u=this._attributes,c=Array.isArray(u),h=0;for(u=c?u:u[Symbol.iterator]();;){var f;if(c){if(h>=u.length)break;f=u[h++]}else{if((h=u.next()).done)break;f=h.value}var d=f;if(d.name===t){l=d.format;break}o+=xc[d.format].size}var _=this._vertexBuffers[a];l&&_&&(id(new DataView(e),i,l,o,_.stride),s&&_.update(e,0,_.stride*_.count))}},{key:"updateIndexBuffer",value:function(e,t){var i=this._indexCount,n=this._indexBuffer;i&&n&&(id(new DataView(e),t,ru["R".concat(8*n.stride,"UI")]),n.update(e,0,n.stride*n.count),this._indexCount=t.length)}}]),i}()),md=m4("GFXPipelineLayout",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,jl.PIPELINE_LAYOUT)))._device=void 0,t._pushConstantsRanges=[],t._layouts=[],t._device=e,t}return _(i,pc),l(i,[{key:"layouts",get:function(){return this._layouts}}]),i}()),yd=function(){function e(){y(this,e),this.isDiscard=!1,this.polygonMode=vu.FILL,this.shadeModel=yu.GOURAND,this.cullMode=bu.BACK,this.isFrontFaceCCW=!0,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}return l(e,[{key:"compare",value:function(e){return this.isDiscard===e.isDiscard&&this.polygonMode===e.polygonMode&&this.shadeModel===e.shadeModel&&this.cullMode===e.cullMode&&this.isFrontFaceCCW===e.isFrontFaceCCW&&this.depthBias===e.depthBias&&this.depthBiasClamp===e.depthBiasClamp&&this.depthBiasSlop===e.depthBiasSlop&&this.isDepthClip===e.isDepthClip&&this.lineWidth===e.lineWidth&&this.isMultisample===e.isMultisample}}]),e}(),gd=function(){function e(){y(this,e),this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Su.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Su.ALWAYS,this.stencilReadMaskFront=4294967295,this.stencilWriteMaskFront=4294967295,this.stencilFailOpFront=wu.KEEP,this.stencilZFailOpFront=wu.KEEP,this.stencilPassOpFront=wu.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Su.ALWAYS,this.stencilReadMaskBack=4294967295,this.stencilWriteMaskBack=4294967295,this.stencilFailOpBack=wu.KEEP,this.stencilZFailOpBack=wu.KEEP,this.stencilPassOpBack=wu.KEEP,this.stencilRefBack=1}return l(e,[{key:"compare",value:function(e){return this.depthTest===e.depthTest&&this.depthWrite===e.depthWrite&&this.depthFunc===e.depthFunc&&this.stencilTestFront===e.stencilTestFront&&this.stencilFuncFront===e.stencilFuncFront&&this.stencilReadMaskFront===e.stencilReadMaskFront&&this.stencilWriteMaskFront===e.stencilWriteMaskFront&&this.stencilFailOpFront===e.stencilFailOpFront&&this.stencilZFailOpFront===e.stencilZFailOpFront&&this.stencilPassOpFront===e.stencilPassOpFront&&this.stencilRefFront===e.stencilRefFront&&this.stencilTestBack===e.stencilTestBack&&this.stencilFuncBack===e.stencilFuncBack&&this.stencilReadMaskBack===e.stencilReadMaskBack&&this.stencilWriteMaskBack===e.stencilWriteMaskBack&&this.stencilFailOpBack===e.stencilFailOpBack&&this.stencilZFailOpBack===e.stencilZFailOpBack&&this.stencilPassOpBack===e.stencilPassOpBack&&this.stencilRefBack===e.stencilRefBack}}]),e}(),bd=function(){function e(){y(this,e),this.blend=!1,this.blendSrc=ku.ONE,this.blendDst=ku.ZERO,this.blendEq=Au.ADD,this.blendSrcAlpha=ku.ONE,this.blendDstAlpha=ku.ZERO,this.blendAlphaEq=Au.ADD,this.blendColorMask=Ou.ALL}return l(e,[{key:"compare",value:function(e){return this.blend===e.blend&&this.blendSrc===e.blendSrc&&this.blendDst===e.blendDst&&this.blendEq===e.blendEq&&this.blendSrcAlpha===e.blendSrcAlpha&&this.blendDstAlpha===e.blendDstAlpha&&this.blendAlphaEq===e.blendAlphaEq&&this.blendColorMask===e.blendColorMask}}]),e}(),xd=m4("GFXPipelineState",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,jl.PIPELINE_STATE)))._device=void 0,t._shader=null,t._primitive=_u.TRIANGLE_LIST,t._is=null,t._rs=null,t._dss=null,t._bs=null,t._dynamicStates=[],t._layout=null,t._renderPass=null,t._device=e,t}return _(i,pc),l(i,[{key:"shader",get:function(){return this._shader}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"pipelineLayout",get:function(){return this._layout}},{key:"renderPass",get:function(){return this._renderPass}}]),i}()),Sd=m4("GFXQueue",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,jl.QUEUE)))._device=void 0,t._type=hc.GRAPHICS,t._device=e,t}return _(i,pc),l(i,[{key:"type",get:function(){return this._type}}]),i}()),Td=m4("GFXRenderPass",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,jl.RENDER_PASS)))._device=void 0,t._colorInfos=[],t._depthStencilInfo=null,t._device=e,t}return _(i,pc),i}()),wd=function(){function e(){y(this,e),this.name="",this.minFilter=Iu.LINEAR,this.magFilter=Iu.LINEAR,this.mipFilter=Iu.NONE,this.addressU=Lu.WRAP,this.addressV=Lu.WRAP,this.addressW=Lu.WRAP,this.maxAnisotropy=16,this.cmpFunc=Su.NEVER,this.borderColor={r:0,g:0,b:0,a:0},this.minLOD=0,this.maxLOD=0,this.mipLODBias=0}return l(e,[{key:"compare",value:function(e){return this.minFilter===e.minFilter&&this.magFilter===e.magFilter&&this.mipFilter===e.mipFilter&&this.addressU===e.addressU&&this.addressV===e.addressV&&this.addressW===e.addressW&&this.maxAnisotropy===e.maxAnisotropy&&this.cmpFunc===e.cmpFunc&&this.borderColor.r===e.borderColor.r&&this.borderColor.g===e.borderColor.g&&this.borderColor.b===e.borderColor.b&&this.borderColor.a===e.borderColor.a&&this.minLOD===e.minLOD&&this.maxLOD===e.maxLOD&&this.mipLODBias===e.mipLODBias}}]),e}(),Ed=m4("GFXSampler",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,jl.SAMPLER)))._device=void 0,t._state=new wd,t._device=e,t}return _(i,pc),l(i,[{key:"state",get:function(){return this._state}}]),i}()),Ad=m4("GFXShader",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,jl.SHADER)))._device=void 0,t._id=void 0,t._name="",t._stages=[],t._blocks=[],t._samplers=[],t._device=e,t._id=e.genShaderId(),t}return _(i,pc),l(i,[{key:"id",get:function(){return this._id}},{key:"name",get:function(){return this._name}}]),i}()),Cd=m4("GFXTexture",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,jl.TEXTURE)))._device=void 0,t._type=Fu.TEX2D,t._usage=Du.NONE,t._format=ru.UNKNOWN,t._width=0,t._height=0,t._depth=1,t._arrayLayer=1,t._mipLevel=1,t._samples=Uu.X1,t._flags=Gu.NONE,t._isPowerOf2=!1,t._size=0,t._buffer=null,t._device=e,t}return _(i,pc),l(i,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"arrayLayer",get:function(){return this._arrayLayer}},{key:"mipLevel",get:function(){return this._mipLevel}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}},{key:"buffer",get:function(){return this._buffer}}]),i}()),kd=m4("GFXTextureView",function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,jl.TEXTURE_VIEW)))._device=void 0,t._texture=null,t._type=Wu.TV2D,t._format=ru.UNKNOWN,t._baseLevel=0,t._levelCount=1,t._baseLayer=0,t._layerCount=1,t._device=e,t}return _(i,pc),l(i,[{key:"texture",get:function(){return this._texture}},{key:"type",get:function(){return this._type}},{key:"format",get:function(){return this._format}},{key:"baseLevel",get:function(){return this._baseLevel}},{key:"levelCount",get:function(){return this._levelCount}},{key:"baseLayer",get:function(){return this._baseLayer}},{key:"layerCount",get:function(){return this._layerCount}}]),i}());cc.GFXDevice=Bc,cc.GFXBuffer=tf,cc.GFXTexture=Cd,cc.GFXTextureView=kd,cc.GFXSampler=Ed,cc.GFXShader=Ad,cc.GFXInputAssembler=vd,cc.GFXRenderPass=Td,cc.GFXFramebuffer=rf,cc.GFXPipelineLayout=md,cc.GFXPipelineState=xd,cc.GFXCommandBuffer=nf,cc.GFXQueue=Sd,Object.assign(cc,Oc);var Rd,Od,Md,Id=function(){function t(e){y(this,t),this._device=void 0,this._format=ru.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new bc,this._region1=new bc,this._region2=new bc,this._roundUpFn=null,this._inOrderFree=!1,this._device=e}return l(t,[{key:"initialize",value:function(e){return this._format=e.format,this._formatSize=xc[this._format].size,this._chunks=new Array(e.maxChunks),this._roundUpFn=e.roundUpFn||null,this._inOrderFree=e.inOrderFree||!1,!0}},{key:"destroy",value:function(){for(var e=0;e<this._chunkCount;++e){var t=this._chunks[e];t.texView.destroy(),t.texture.destroy()}this._chunks.splice(0),this._handles.splice(0)}},{key:"alloc",value:function(l){var u=this;if(0===l)return null;for(var e=function(t){var e=u._chunks[t],i=!1,n=e.start;if(n+l<=e.end)i=!0;else if(u._inOrderFree)n>e.end?n+l<=e.size?i=!0:l<=e.end&&(e.start=n=0,i=!0):n===e.end&&(e.start=n=0,e.end=e.size,l<=e.end&&(i=!0));else{n=0;for(var r=u._handles.filter(function(e){return e.chunkIdx===t}).sort(function(e,t){return e.start-t.start}),a=0;a<r.length;a++){var s=r[a];if(n+l<=s.start){i=!0;break}n=s.end}!i&&n+l<=e.size&&(i=!0)}if(i){e.start+=l;var o={chunkIdx:t,start:n,end:n+l,texture:e.texture,texView:e.texView};return u._handles.push(o),{v:o}}},t=0;t<this._chunkCount;++t){var i=e(t);if("object"===be(i))return i.v}if(this._chunkCount>=this._chunks.length)return console.error("TextureBufferPool: Reach max chunk count."),null;var n=Math.sqrt(l/this._formatSize),r=this._roundUpFn&&this._roundUpFn(n,this._formatSize)||Math.max(1024,function(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}(n)),a=r*r*this._formatSize;console.info("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+a);var s=this._device.createTexture({type:Fu.TEX2D,usage:Du.SAMPLED,format:this._format,width:r,height:r,mipLevel:1}),o=this._device.createTextureView({texture:s,type:Wu.TV2D,format:this._format}),c={chunkIdx:this._chunkCount,start:0,end:l,texture:s,texView:o};return this._handles.push(c),this._chunks[this._chunkCount++]={texture:s,texView:o,size:a,start:l,end:a},c}},{key:"free",value:function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)}},{key:"update",value:function(e,t){var i=[],n=[],r=e.start/this._formatSize,a=t.byteLength/this._formatSize,s=r%e.texture.width,o=Math.floor(r/e.texture.width),l=Math.min(e.texture.width-s,a),u=0;0<s&&(this._region0.texOffset.x=s,this._region0.texOffset.y=o,this._region0.texExtent.width=l,this._region0.texExtent.height=1,i.push(t.slice(u*this._formatSize,(u+l)*this._formatSize)),n.push(this._region0),s=0,o+=1,a-=l,u+=l),0<a&&(this._region1.texOffset.x=s,this._region1.texOffset.y=o,a>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(a/e.texture.width),l=this._region1.texExtent.width*this._region1.texExtent.height):(l=a,this._region1.texExtent.width=l,this._region1.texExtent.height=1),i.push(t.slice(u*this._formatSize,(u+l)*this._formatSize)),n.push(this._region1),s=0,o+=this._region1.texExtent.height,a-=l,u+=l),0<a&&(this._region2.texOffset.x=s,this._region2.texOffset.y=o,this._region2.texExtent.width=a,this._region2.texExtent.height=1,i.push(t.slice(u*this._formatSize,(u+a)*this._formatSize)),n.push(this._region2)),this._device.copyBuffersToTexture(i,e.texture,n)}}]),t}(),Bd=function(e,t,i,n){Pn.toRTS(i,Ud,Nd,Vd),n?fn.copy(zd,Ud):fn.dot(zd,Ud)<0&&fn.multiplyScalar(Ud,Ud,-1);fn.set(Dd,Nd.x,Nd.y,Nd.z,0),fn.multiplyScalar(Dd,fn.multiply(Dd,Dd,Ud),.5),e[t+0]=Ud.x,e[t+1]=Ud.y,e[t+2]=Ud.z,e[t+3]=Ud.w,e[t+4]=Dd.x,e[t+5]=Dd.y,e[t+6]=Dd.z,e[t+7]=Dd.w,e[t+8]=Vd.x,e[t+9]=Vd.y,e[t+10]=Vd.z};function Ld(e){return e.hasFeature(kc.TEXTURE_FLOAT)?Od.RGBA32F:Od.RGBA8}(Md=Od=Od||{})[Md.NONE=0]="NONE",Md[Md.RGBA8=1]="RGBA8",Md[Md.RGBA32F=2]="RGBA32F";var Pd=Object.freeze(new Pn),Fd=new Pn,zd=new fn,Dd=new fn,Nd=new Ni,Ud=new fn,Vd=new Ni;function Gd(e,t){var i=4/Math.sqrt(t);return 12*Math.ceil(Math.max(204*i,e)/12)}function Hd(e){return Math.ceil(Math.log2(Math.max(e,2)))}function Wd(e,t){switch(e.type){case"boolean":return t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return(void 0!==t?t:e.range[0])+""}return console.warn("unknown define type '".concat(e.type,"'")),"-1"}function qd(e,t,i){var n=e.builtins[i],r=e.blocks,a=n.blocks,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l,c=t.get(u.name);if(c&&c.type===Yu.UNIFORM_BUFFER){var h=Object.assign({defines:u.defines},c.blockInfo);r.push(h)}else console.warn("builtin UBO '".concat(u.name,"' not available!"))}var f=e.samplers,d=n.samplers,_=Array.isArray(d),p=0;for(d=_?d:d[Symbol.iterator]();;){var v;if(_){if(p>=d.length)break;v=d[p++]}else{if((p=d.next()).done)break;v=p.value}var m=v,y=t.get(m.name);if(y&&y.type===Yu.SAMPLER){var g=Object.assign({defines:m.defines},y.samplerInfo);f.push(g)}else console.warn("builtin sampler '".concat(m.name,"' not available!"))}}var jd,Xd,Yd,Kd,Qd,Zd=(s(Rd={},Od.RGBA8,ru.RGBA8),s(Rd,Od.RGBA32F,ru.RGBA32F),Rd),Jd=function(){function t(e){y(this,t),this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=0,this._device=e,this._pool=new Id(e)}return l(t,[{key:"initialize",value:function(e){var t=0<arguments.length&&void 0!==e?e:8,i=Zd[Ld(this._device)];this._formatSize=xc[i].size;var n=16/this._formatSize;this._pool.initialize({format:i,maxChunks:t*n,roundUpFn:Gd})}},{key:"destroy",value:function(){this._pool.destroy()}},{key:"getDefaultJointsTexture",value:function(e){var t=e&&e.joints.length||1,i=this._textureBuffers.get(t)||null;if(i)return i.refCount++,i;var n=this._pool.alloc(12*t*Float32Array.BYTES_PER_ELEMENT);if(!n)return null;i={pixelOffset:n.start/this._formatSize,refCount:1,hash:t,handle:n};for(var r=new Float32Array(12*t),a=0;a<t;a++)Bd(r,12*a,Pd,0===a);return this._pool.update(n,r.buffer),this._textureBuffers.set(t,i),i}},{key:"getJointsTextureWithAnimation",value:function(e,t){var i=e.hash^t.hash,n=this._textureBuffers.get(i)||null;if(n)return n.refCount++,n;var r=t.keys[0].length,a=12*e.joints.length*r,s=this._pool.alloc(a*Float32Array.BYTES_PER_ELEMENT);if(!s)return null;n={pixelOffset:s.start/this._formatSize,refCount:1,hash:i,handle:s};for(var o=new Float32Array(a),l=t.convertedData,u=0;u<e.joints.length;u++){var c=l[e.joints[u]];if(c&&c.props)for(var h=e.bindposes[u],f=c.props.worldMatrix.values,d=0;d<r;d++){var _=f[d];Pn.multiply(Fd,_,h),Bd(o,12*(r*u+d),Fd,0===u)}}return this._pool.update(s,o.buffer),this._textureBuffers.set(i,n),n}},{key:"releaseTexture",value:function(e){0==--e.refCount&&(this._pool.free(e.handle),this._textureBuffers.delete(e.hash))}}]),t}(),$d=m4("effects",[{name:"builtin-billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-billboard|vert:vs_main|tinted-fs:add",hash:3876741410,glsl3:{vert:"\nprecision mediump float;\nuniform Constants{\n    vec4 mainTiling_Offset;\n    vec4 frameTile_velLenScale;\n    vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp mat4 cc_matWorlds[10];\n};\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if 1 || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if 1\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nuniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(0., 0., cc_size_rotation.z), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewInv;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if 1 || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if 1\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(0., 0., cc_size_rotation.z), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture2D(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean"},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean"},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean"},{name:"CC_USE_MESH",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}]}]},{name:"builtin-particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",hash:207867717,glsl3:{vert:"\nprecision mediump float;\nuniform Constants{\n    vec4 mainTiling_Offset;\n    vec4 frameTile_velLenScale;\n    vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp mat4 cc_matWorlds[10];\n};\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n    out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n    highp vec4 pos = vec4(a_position, 1);\n    vec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n#endif\n    float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n    vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n    pos.xyz += camUp * vertOffset;\n    pos = cc_matViewProj * pos;\n    uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n    color = a_color;\n#if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n#endif\n    return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\n  precision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  in vec2 uv;\n  in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    in vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\n  vec4 multiply () {\n    vec4 col;\n    vec4 texColor = texture(mainTexture, uv);\n    col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n    col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., col.a);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n    highp vec4 pos = vec4(a_position, 1);\n    vec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n#endif\n    float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n    vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n    pos.xyz += camUp * vertOffset;\n    pos = cc_matViewProj * pos;\n    uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n    color = a_color;\n#if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n#endif\n    return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\n  precision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  varying vec2 uv;\n  varying vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform vec4 tintColor;\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\n  vec4 multiply () {\n    vec4 col;\n    vec4 texColor = texture2D(mainTexture, uv);\n    col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n    col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., col.a);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_BILLBOARD",type:"boolean"},{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean"},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean"},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean"},{name:"CC_USE_MESH",type:"boolean"},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}]}]},{name:"builtin-particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:1044134572,glsl3:{vert:"\nprecision highp float;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nuniform Constants{\n    vec4 mainTiling_Offset;\n    vec4 frameTile_velLenScale;\n    vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp mat4 cc_matWorlds[10];\n};\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_USE_STRETCHED_BILLBOARD\n    in vec3 a_color1;\n#endif\n#if CC_USE_MESH\n    in vec3 a_texCoord3;\n    in vec3 a_normal;\n    in vec4 a_color1;\n#endif\nvec4 lpvs_main() {\n    vec3 compScale = scale.xyz * a_texCoord1;\n    vec4 pos = vec4(a_position, 1);\n#if CC_USE_STRETCHED_BILLBOARD\n    vec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_USE_STRETCHED_BILLBOARD\n        velocity = cc_matWorld * velocity;\n    #endif\n#endif\n#if !CC_USE_MESH\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_USE_BILLBOARD\n        vec3 rotEuler = a_texCoord2;\n    #elif CC_USE_STRETCHED_BILLBOARD\n        vec3 rotEuler = vec3(0.);\n    #else\n        vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n        , cc_matViewInv\n    #endif\n    #if CC_USE_STRETCHED_BILLBOARD\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n#else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n#endif\n    uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n    pos = cc_matViewProj * pos;\n    return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision highp float;\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n    angle /= 2.;\n    float s = sin(angle);\n    vec4 res;\n    res.xyz = s * axis;\n    res.w = cos(angle);\n    return res;\n}\nvec4 quaternionFromAxis(vec3 xAxis,vec3 yAxis,vec3 zAxis){\n    mat3 m = mat3(xAxis,yAxis,zAxis);\n    float trace = m[0][0] + m[1][1] + m[2][2];\n    vec4 quat;\n    if (trace > 0.) {\n        float s = 0.5 / sqrt(trace + 1.0);\n        quat.w = 0.25 / s;\n        quat.x = (m[2][1] - m[1][2]) * s;\n        quat.y = (m[0][2] - m[2][0]) * s;\n        quat.z = (m[1][0] - m[0][1]) * s;\n    } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n        float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n        quat.w = (m[2][1] - m[1][2]) / s;\n        quat.x = 0.25 * s;\n        quat.y = (m[0][1] + m[1][0]) / s;\n        quat.z = (m[0][2] + m[2][0]) / s;\n    } else if (m[1][1] > m[2][2]) {\n        float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n        quat.w = (m[0][2] - m[2][0]) / s;\n        quat.x = (m[0][1] + m[1][0]) / s;\n        quat.y = 0.25 * s;\n        quat.z = (m[1][2] + m[2][1]) / s;\n    } else {\n        float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n        quat.w = (m[1][0] - m[0][1]) / s;\n        quat.x = (m[0][2] + m[2][0]) / s;\n        quat.y = (m[1][2] + m[2][1]) / s;\n        quat.z = 0.25 * s;\n    }\n    float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n    if (len > 0.) {\n        len = 1. / sqrt(len);\n        quat.x = quat.x * len;\n        quat.y = quat.y * len;\n        quat.z = quat.z * len;\n        quat.w = quat.w * len;\n    }\n    return quat;\n}\nvec4 quaternionFromEuler(vec3 angle){\n    float x = angle.x / 2.;\n    float y = angle.y / 2.;\n    float z = angle.z / 2.;\n    float sx = sin(x);\n    float cx = cos(x);\n    float sy = sin(y);\n    float cy = cos(y);\n    float sz = sin(z);\n    float cz = cos(z);\n    vec4 quat = vec4(0);\n    quat.x = sx * cy * cz + cx * sy * sz;\n    quat.y = cx * sy * cz + sx * cy * sz;\n    quat.z = cx * cy * sz - sx * sy * cz;\n    quat.w = cx * cy * cz - sx * sy * sz;\n    return quat;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n    float x2 = q.x + q.x;\n    float y2 = q.y + q.y;\n    float z2 = q.z + q.z;\n    float xx = q.x * x2;\n    float xy = q.x * y2;\n    float xz = q.x * z2;\n    float yy = q.y * y2;\n    float yz = q.y * z2;\n    float zz = q.z * z2;\n    float wx = q.w * x2;\n    float wy = q.w * y2;\n    float wz = q.w * z2;\n    return mat4(\n        1. - (yy + zz), xy + wz, xz - wy, 0,\n        xy - wz, 1. - (xx + zz), yz + wx, 0,\n        xz + wy, yz - wx, 1. - (xx + yy), 0,\n        p.x, p.y, p.z, 1\n    );\n}\nmat4 matFromRTS(vec4 q, vec3 t, vec3 s){\n    float x = q.x, y = q.y, z = q.z, w = q.w;\n    float x2 = x + x;\n    float y2 = y + y;\n    float z2 = z + z;\n    float xx = x * x2;\n    float xy = x * y2;\n    float xz = x * z2;\n    float yy = y * y2;\n    float yz = y * z2;\n    float zz = z * z2;\n    float wx = w * x2;\n    float wy = w * y2;\n    float wz = w * z2;\n    float sx = s.x;\n    float sy = s.y;\n    float sz = s.z;\n    return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n        (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n        (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n        t.x, t.y, t.z, 1);\n}\nvoid scaleMatrix(inout mat4 m, float s){\n    m[0].xyz *= s;\n    m[1].xyz *= s;\n    m[2].xyz *= s;\n}\nvec4 quatMultiply(vec4 a, vec4 b){\n    vec4 quat;\n    quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n    quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n    quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n    quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n    return quat;\n}\nvoid rotateVecFromQuat(inout vec3 v, vec4 q){\n    float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n    float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n    float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n    float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n    v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n    v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n    v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateVecFromAxis(vec3 v, vec3 axis, float theta){\n    return cos(theta) * v + sin(theta) * cross(v, axis) + (1. - cos(theta)) * dot(v, axis) * axis;\n}\nvec3 rotateInLocalSpace(vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n    vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n    vec4 rotQuat = quatMultiply(viewQuat, q);\n    rotateVecFromQuat(pos, rotQuat);\n    return pos;\n}\nvoid rotateCorner(inout vec2 corner, float angle){\n    float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n    float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n    corner.x = xOS;\n    corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewInv;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n    , mat4 viewInv\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n    , vec3 eye\n    , vec4 velocity\n    , float velocityScale\n    , float lengthScale\n    , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n    vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n    vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_USE_STRETCHED_BILLBOARD\n    vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n    vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n    pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n    vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n    vec3 camX = vec3(1, 0, 0);\n    vec3 camY = vec3(0, 0, -1);\n    pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_USE_VERTICAL_BILLBOARD\n    vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n    rotateCorner(viewSpaceVert, q.z);\n    vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n    vec3 camY = vec3(0, 1, 0);\n    vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n    pos.xyz += offset;\n#else\n    pos.x += vertOffset.x;\n    pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile){\n    vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n    aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if !CC_USE_MESH\n    vertIndex.y = 1. - vertIndex.y;\n#endif\n    return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_USE_STRETCHED_BILLBOARD\n    attribute vec3 a_color1;\n#endif\n#if CC_USE_MESH\n    attribute vec3 a_texCoord3;\n    attribute vec3 a_normal;\n    attribute vec4 a_color1;\n#endif\nvec4 lpvs_main() {\n    vec3 compScale = scale.xyz * a_texCoord1;\n    vec4 pos = vec4(a_position, 1);\n#if CC_USE_STRETCHED_BILLBOARD\n    vec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_USE_STRETCHED_BILLBOARD\n        velocity = cc_matWorld * velocity;\n    #endif\n#endif\n#if !CC_USE_MESH\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_USE_BILLBOARD\n        vec3 rotEuler = a_texCoord2;\n    #elif CC_USE_STRETCHED_BILLBOARD\n        vec3 rotEuler = vec3(0.);\n    #else\n        vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n        , cc_matViewInv\n    #endif\n    #if CC_USE_STRETCHED_BILLBOARD\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n#else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n#endif\n    uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n    pos = cc_matViewProj * pos;\n    return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture2D(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_BILLBOARD",type:"boolean"},{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean"},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean"},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean"},{name:"CC_USE_MESH",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}]}]},{name:"builtin-sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",priority:244,depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"white",type:28}}}]}],shaders:[{name:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",hash:1678704147,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#if USE_LOCAL\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp mat4 cc_matWorlds[10];\n};\n#endif\nin vec3 a_position;\nin vec4 a_color;\nout vec4 color;\nin vec2 a_texCoord;\nout vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matViewProj * cc_matWorld * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nin vec4 color;\n#if USE_TEXTURE\n  in vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture(mainTexture, uv0);\n  #endif\n  o *= color;\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 color;\nattribute vec2 a_texCoord;\nvarying vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matViewProj * cc_matWorld * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nvarying vec4 color;\n#if USE_TEXTURE\n  varying vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, uv0);\n  #endif\n  o *= color;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplers:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"}],blocks:[],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],binding:30}]}]},{name:"builtin-standard",techniques:[{name:"opaque",passes:[{program:"builtin-standard|standard-vs:vert|standard-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},albedo:{value:[1,1,1,1],type:16},albedoScale:{value:[1,1,1,0],type:16},pbrParams:{value:[.8,.6,1,1],type:16},pbrScale:{value:[1,1,1,1],type:16},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1,1],type:16},albedoMap:{value:"grey",type:28},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-standard|standard-vs:vert|standard-fs:frag",hash:1071940485,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp mat4 cc_matWorlds[10];\n};\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec4 a_tangent;\n#if USE_BATCHING\nin float a_index;\n#endif\nvoid CCDecode (out StandardAttributes attr) {\n  attr.position = vec4(a_position, 1.0);\n  attr.normal = a_normal;\n  attr.tangent = a_tangent;\n#if USE_BATCHING\n  attr.index = int(a_index + 0.5);\n#endif\n}\n#if CC_USE_SKINNING\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform CCSkinningAnimation {\n  highp vec4 cc_jointsAnimInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nvoid CCAttrToInput (in StandardAttributes attr, out StandardVertInput In) {\n  In.position = attr.position;\n  In.normal = attr.normal;\n  In.tangent = attr.tangent;\n  In.index = attr.index;\n}\nvoid CCVertInput (out StandardVertInput In) {\n  StandardAttributes attr;\n  CCDecode(attr);\n  #if CC_USE_SKINNING\n    CCSkin(attr);\n  #endif\n  CCAttrToInput(attr, In);\n}\nuniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScale;\n  vec4 pbrParams;\n  vec4 pbrScale;\n  vec4 emissive;\n  vec4 emissiveScale;\n};\n#define saturate(a) clamp( a, 0.0, 1.0 )\nhighp mat4 transposeMat4(in highp mat4 mat) {\n    highp vec4 i0 = mat[0];\n    highp vec4 i1 = mat[1];\n    highp vec4 i2 = mat[2];\n    highp vec4 i3 = mat[3];\n    return mat4(vec4(i0.x, i1.x, i2.x, i3.x),\n                vec4(i0.y, i1.y, i2.y, i3.y),\n                vec4(i0.z, i1.z, i2.z, i3.z),\n                vec4(i0.w, i1.w, i2.w, i3.w));\n}\nout vec3 v_position;\nout vec3 v_normal;\n#if USE_NORMAL_MAP\n  out vec3 v_tangent;\n  out vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  in vec2 a_texCoord;\n  out vec2 v_uv;\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  CCVertInput(In);\n  #if USE_BATCHING\n    mat4 matWorld = cc_matWorlds[In.index];\n    mat4 matWorldIT = transposeMat4(matWorld);\n  #else\n    mat4 matWorld = cc_matWorld;\n    mat4 matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorldIT * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  #if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  return cc_matViewProj * pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\n#endif\n#define saturate(a) clamp( a, 0.0, 1.0 )\nhighp mat4 transposeMat4(in highp mat4 mat) {\n    highp vec4 i0 = mat[0];\n    highp vec4 i1 = mat[1];\n    highp vec4 i2 = mat[2];\n    highp vec4 i3 = mat[3];\n    return mat4(vec4(i0.x, i1.x, i2.x, i3.x),\n                vec4(i0.y, i1.y, i2.y, i3.y),\n                vec4(i0.z, i1.z, i2.z, i3.z),\n                vec4(i0.w, i1.w, i2.w, i3.w));\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nuniform CCForwardLight {\n  highp vec4 cc_sphereLitPos[2];\n  vec4 cc_sphereLitSizeRange[2];\n  vec4 cc_sphereLitColor[2];\n  highp vec4 cc_spotLitPos[2];\n  vec4 cc_spotLitSizeRangeAngle[2];\n  vec4 cc_spotLitDir[2];\n  vec4 cc_spotLitColor[2];\n};\nfloat SmoothDistAtt2(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float factor2 = factor * factor;\n  float factor3 = factor2 * factor2;\n  float smoothFactor = clamp(1.0 - factor3 * factor3, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat SmoothDistAtt(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt(float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt(vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\nfloat GGXMobile(float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular(float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox(vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nvec3 CalcDynamicLighting(vec3 worldPos, vec3 N, vec3 V, vec3 diffuse, vec3 specular, float roughness) {\n  vec3 lighting = vec3(0.0);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  for (int i = 0; i < 2; i++) {\n    vec3 PLU = cc_sphereLitPos[i].xyz - worldPos;\n    vec3 PL = normalize(PLU);\n    vec3 PH = normalize(PL + V);\n    float PNL = max(dot(N, PL), 0.001);\n    float PNH = max(dot(N, PH), 0.0);\n    float distSqr = dot(PLU, PLU);\n    float litRadius = cc_sphereLitSizeRange[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_sphereLitSizeRange[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    vec3 lspec = specular * CalcSpecular(roughness, PNH, PH, N);\n    lighting += PNL * cc_sphereLitColor[i].rgb * cc_sphereLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  for (int i = 0; i < 2; i++) {\n    vec3 SLU = cc_spotLitPos[i].xyz - worldPos;\n    vec3 SL = normalize(SLU);\n    vec3 SH = normalize(SL + V);\n    float SNL = max(dot(N, SL), 0.001);\n    float SNH = max(dot(N, SH), 0.0);\n    float distSqr = dot(SLU, SLU);\n    float litRadius = cc_spotLitSizeRangeAngle[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_spotLitSizeRangeAngle[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float cosInner = max(dot(-cc_spotLitDir[i].xyz, SL), 0.01);\n    float cosOuter = cc_spotLitSizeRangeAngle[i].z;\n    float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n    float litAngleOffset = -cosOuter * litAngleScale;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    att *= GetAngleAtt(SL, -cc_spotLitDir[i].xyz, litAngleScale, litAngleOffset);\n    vec3 lspec = specular * CalcSpecular(roughness, SNH, SH, N);\n    lighting += SNL * cc_spotLitColor[i].rgb * cc_spotLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  return lighting;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\nvec4 CCStandardShading (StandardSurface s) {\n  vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n  vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n  vec3 N = normalize(s.normal);\n  vec3 V = normalize(cc_cameraPos.xyz - s.position);\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 H = normalize(L+V);\n  float NV = max(abs(dot(N, V)), 0.001);\n  float NL = max(dot(N, L), 0.001);\n  float NH = max(dot(N, H), 0.0);\n  specular = BRDFApprox(specular, s.roughness, NV);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n  vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w * (diffuseContrib + specularContrib);\n  finalColor += CalcDynamicLighting(s.position, N, V, diffuse, specular, s.roughness);\n  float fAmb = 0.5 - N.y * 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  finalColor += (ambDiff.rgb * diffuse);\n  #if CC_USE_IBL\n    vec3 R = normalize(reflect(-V, N));\n    vec4 envmap = textureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n    #if CC_USE_IBL == 2\n      vec3 env = unpackRGBE(envmap);\n    #else\n      vec3 env = SRGBToLinear(envmap.rgb) * cc_ambientSky.w;\n    #endif\n    finalColor += env * specular;\n  #endif\n  finalColor = finalColor * s.occlusion;\n  #if CC_USE_HDR\n    s.emissive *= cc_exposure.w;\n  #endif\n  finalColor += s.emissive;\n  return vec4(finalColor, s.albedo.a);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nuniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScale;\n  vec4 pbrParams;\n  vec4 pbrScale;\n  vec4 emissive;\n  vec4 emissiveScale;\n};\nin vec3 v_position;\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  in vec2 v_uv;\n#endif\nin vec3 v_normal;\n#if USE_NORMAL_MAP\n  in vec3 v_tangent;\n  in vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, v_uv);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScale.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScale.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, v_uv).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrScale.w) * normalize(v_tangent) +\n      (nmmp.y * pbrScale.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    pbr = texture(pbrMap, v_uv);\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, v_uv);\n    pbr.METALLIC_CHANNEL = metallicRoughness.METALLIC_CHANNEL;\n    pbr.ROUGHNESS_CHANNEL = metallicRoughness.ROUGHNESS_CHANNEL;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.OCCLUSION_CHANNEL = texture(occlusionMap, v_uv).OCCLUSION_CHANNEL;\n  #endif\n  pbr *= pbrScale;\n  s.roughness = clamp(pbr.ROUGHNESS_CHANNEL, 0.04, 1.0);\n  s.metallic = clamp(pbr.METALLIC_CHANNEL, 0.0, 0.96);\n  s.occlusion = pbr.OCCLUSION_CHANNEL;\n  s.emissive = emissive.rgb * emissiveScale.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, v_uv).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp mat4 cc_matWorlds[10];\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec4 a_tangent;\n#if USE_BATCHING\nattribute float a_index;\n#endif\nvoid CCDecode (out StandardAttributes attr) {\n  attr.position = vec4(a_position, 1.0);\n  attr.normal = a_normal;\n  attr.tangent = a_tangent;\n#if USE_BATCHING\n  attr.index = int(a_index + 0.5);\n#endif\n}\n#if CC_USE_SKINNING\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform highp vec4 cc_jointsAnimInfo;\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nvoid CCAttrToInput (in StandardAttributes attr, out StandardVertInput In) {\n  In.position = attr.position;\n  In.normal = attr.normal;\n  In.tangent = attr.tangent;\n  In.index = attr.index;\n}\nvoid CCVertInput (out StandardVertInput In) {\n  StandardAttributes attr;\n  CCDecode(attr);\n  #if CC_USE_SKINNING\n    CCSkin(attr);\n  #endif\n  CCAttrToInput(attr, In);\n}\nuniform vec4 tilingOffset;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nhighp mat4 transposeMat4(in highp mat4 mat) {\n    highp vec4 i0 = mat[0];\n    highp vec4 i1 = mat[1];\n    highp vec4 i2 = mat[2];\n    highp vec4 i3 = mat[3];\n    return mat4(vec4(i0.x, i1.x, i2.x, i3.x),\n                vec4(i0.y, i1.y, i2.y, i3.y),\n                vec4(i0.z, i1.z, i2.z, i3.z),\n                vec4(i0.w, i1.w, i2.w, i3.w));\n}\nvarying vec3 v_position;\nvarying vec3 v_normal;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  attribute vec2 a_texCoord;\n  varying vec2 v_uv;\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  CCVertInput(In);\n  #if USE_BATCHING\n    mat4 matWorld = cc_matWorlds[In.index];\n    mat4 matWorldIT = transposeMat4(matWorld);\n  #else\n    mat4 matWorld = cc_matWorld;\n    mat4 matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorldIT * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  #if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  return cc_matViewProj * pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\n#if CC_USE_IBL\n  #ifdef GL_EXT_shader_texture_lod\n    #extension GL_EXT_shader_texture_lod : enable\n  #endif\n#endif\nprecision highp float;\nuniform vec4 cc_cameraPos;\nuniform vec4 cc_exposure;\nuniform vec4 cc_mainLitDir;\nuniform vec4 cc_mainLitColor;\nuniform vec4 cc_ambientSky;\nuniform vec4 cc_ambientGround;\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\n#endif\n#define saturate(a) clamp( a, 0.0, 1.0 )\nhighp mat4 transposeMat4(in highp mat4 mat) {\n    highp vec4 i0 = mat[0];\n    highp vec4 i1 = mat[1];\n    highp vec4 i2 = mat[2];\n    highp vec4 i3 = mat[3];\n    return mat4(vec4(i0.x, i1.x, i2.x, i3.x),\n                vec4(i0.y, i1.y, i2.y, i3.y),\n                vec4(i0.z, i1.z, i2.z, i3.z),\n                vec4(i0.w, i1.w, i2.w, i3.w));\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nuniform highp vec4 cc_sphereLitPos[2];\nuniform vec4 cc_sphereLitSizeRange[2];\nuniform vec4 cc_sphereLitColor[2];\nuniform highp vec4 cc_spotLitPos[2];\nuniform vec4 cc_spotLitSizeRangeAngle[2];\nuniform vec4 cc_spotLitDir[2];\nuniform vec4 cc_spotLitColor[2];\nfloat SmoothDistAtt2(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float factor2 = factor * factor;\n  float factor3 = factor2 * factor2;\n  float smoothFactor = clamp(1.0 - factor3 * factor3, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat SmoothDistAtt(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt(float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt(vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\nfloat GGXMobile(float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular(float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox(vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nvec3 CalcDynamicLighting(vec3 worldPos, vec3 N, vec3 V, vec3 diffuse, vec3 specular, float roughness) {\n  vec3 lighting = vec3(0.0);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  for (int i = 0; i < 2; i++) {\n    vec3 PLU = cc_sphereLitPos[i].xyz - worldPos;\n    vec3 PL = normalize(PLU);\n    vec3 PH = normalize(PL + V);\n    float PNL = max(dot(N, PL), 0.001);\n    float PNH = max(dot(N, PH), 0.0);\n    float distSqr = dot(PLU, PLU);\n    float litRadius = cc_sphereLitSizeRange[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_sphereLitSizeRange[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    vec3 lspec = specular * CalcSpecular(roughness, PNH, PH, N);\n    lighting += PNL * cc_sphereLitColor[i].rgb * cc_sphereLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  for (int i = 0; i < 2; i++) {\n    vec3 SLU = cc_spotLitPos[i].xyz - worldPos;\n    vec3 SL = normalize(SLU);\n    vec3 SH = normalize(SL + V);\n    float SNL = max(dot(N, SL), 0.001);\n    float SNH = max(dot(N, SH), 0.0);\n    float distSqr = dot(SLU, SLU);\n    float litRadius = cc_spotLitSizeRangeAngle[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_spotLitSizeRangeAngle[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float cosInner = max(dot(-cc_spotLitDir[i].xyz, SL), 0.01);\n    float cosOuter = cc_spotLitSizeRangeAngle[i].z;\n    float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n    float litAngleOffset = -cosOuter * litAngleScale;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    att *= GetAngleAtt(SL, -cc_spotLitDir[i].xyz, litAngleScale, litAngleOffset);\n    vec3 lspec = specular * CalcSpecular(roughness, SNH, SH, N);\n    lighting += SNL * cc_spotLitColor[i].rgb * cc_spotLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  return lighting;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\nvec4 CCStandardShading (StandardSurface s) {\n  vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n  vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n  vec3 N = normalize(s.normal);\n  vec3 V = normalize(cc_cameraPos.xyz - s.position);\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 H = normalize(L+V);\n  float NV = max(abs(dot(N, V)), 0.001);\n  float NL = max(dot(N, L), 0.001);\n  float NH = max(dot(N, H), 0.0);\n  specular = BRDFApprox(specular, s.roughness, NV);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n  vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w * (diffuseContrib + specularContrib);\n  finalColor += CalcDynamicLighting(s.position, N, V, diffuse, specular, s.roughness);\n  float fAmb = 0.5 - N.y * 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  finalColor += (ambDiff.rgb * diffuse);\n  #if CC_USE_IBL\n    vec3 R = normalize(reflect(-V, N));\n    #ifdef GL_EXT_shader_texture_lod\n      vec4 envmap = textureCubeLodEXT(cc_environment, R, s.roughness * cc_ambientGround.w);\n    #else\n      vec4 envmap = textureCube(cc_environment, R);\n    #endif\n    #if CC_USE_IBL == 2\n      vec3 env = unpackRGBE(envmap);\n    #else\n      vec3 env = SRGBToLinear(envmap.rgb) * cc_ambientSky.w;\n    #endif\n    finalColor += env * specular;\n  #endif\n  finalColor = finalColor * s.occlusion;\n  #if CC_USE_HDR\n    s.emissive *= cc_exposure.w;\n  #endif\n  finalColor += s.emissive;\n  return vec4(finalColor, s.albedo.a);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nuniform vec4 albedo;\nuniform vec4 albedoScale;\nuniform vec4 pbrParams;\nuniform vec4 pbrScale;\nuniform vec4 emissive;\nuniform vec4 emissiveScale;\nvarying vec3 v_position;\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  varying vec2 v_uv;\n#endif\nvarying vec3 v_normal;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture2D(albedoMap, v_uv);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScale.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScale.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture2D(normalMap, v_uv).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrScale.w) * normalize(v_tangent) +\n      (nmmp.y * pbrScale.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    pbr = texture2D(pbrMap, v_uv);\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture2D(metallicRoughnessMap, v_uv);\n    pbr.METALLIC_CHANNEL = metallicRoughness.METALLIC_CHANNEL;\n    pbr.ROUGHNESS_CHANNEL = metallicRoughness.ROUGHNESS_CHANNEL;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.OCCLUSION_CHANNEL = texture2D(occlusionMap, v_uv).OCCLUSION_CHANNEL;\n  #endif\n  pbr *= pbrScale;\n  s.roughness = clamp(pbr.ROUGHNESS_CHANNEL, 0.04, 1.0);\n  s.metallic = clamp(pbr.METALLIC_CHANNEL, 0.0, 0.96);\n  s.occlusion = pbr.OCCLUSION_CHANNEL;\n  s.emissive = emissive.rgb * emissiveScale.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture2D(emissiveMap, v_uv).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING"]},{name:"CCForwardLight",defines:[]}],samplers:[{name:"cc_jointsTexture",defines:["CC_USE_SKINNING"]}]}},defines:[{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"number",range:[0,2]},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"ROUGHNESS_CHANNEL",type:"string",options:["r","g","b"]},{name:"METALLIC_CHANNEL",type:"string",options:["g","r","b"]},{name:"OCCLUSION_CHANNEL",type:"string",options:["b","r","g"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScale",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"pbrScale",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScale",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],binding:30},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],binding:31},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],binding:32},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],binding:33},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],binding:34},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],binding:35}]}]},{name:"builtin-terrain",techniques:[{name:"opaque",passes:[{program:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",properties:{UVScale:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",hash:2907199317,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp mat4 cc_matWorlds[10];\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 uvw;\nout vec2 uv0;\nout vec2 uv1;\nout vec2 uv2;\nout vec2 uv3;\nout vec3 diffuse;\nuniform TexCoords {\n  vec4 UVScale;\n};\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  pos = cc_matViewProj * pos;\n  uvw = a_texCoord;\n  uv0 = a_position.xz * UVScale.x;\n  uv1 = a_position.xz * UVScale.y;\n  uv2 = a_position.xz * UVScale.z;\n  uv3 = a_position.xz * UVScale.w;\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 N = a_normal;\n  float fAmb = dot(N, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  diffuse = ambDiff + vec3(dot(N, L));\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  in vec2 uvw;\n  in vec2 uv0;\n  in vec2 uv1;\n  in vec2 uv2;\n  in vec2 uv3;\n  in vec3 diffuse;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n    color += texture(detailMap3, uv3) * w.a;\n  #else\n    color = texture(detailMap0, uv0);\n  #endif\n  color.rgb *= diffuse;\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_mainLitDir;\nuniform vec4 cc_ambientSky;\nuniform vec4 cc_ambientGround;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 uvw;\nvarying vec2 uv0;\nvarying vec2 uv1;\nvarying vec2 uv2;\nvarying vec2 uv3;\nvarying vec3 diffuse;\nuniform vec4 UVScale;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  pos = cc_matViewProj * pos;\n  uvw = a_texCoord;\n  uv0 = a_position.xz * UVScale.x;\n  uv1 = a_position.xz * UVScale.y;\n  uv2 = a_position.xz * UVScale.z;\n  uv3 = a_position.xz * UVScale.w;\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 N = a_normal;\n  float fAmb = dot(N, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  diffuse = ambDiff + vec3(dot(N, L));\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n  varying vec2 uvw;\n  varying vec2 uv0;\n  varying vec2 uv1;\n  varying vec2 uv2;\n  varying vec2 uv3;\n  varying vec3 diffuse;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture2D(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n    color += texture2D(detailMap3, uv3) * w.a;\n  #else\n    color = texture2D(detailMap0, uv0);\n  #endif\n  color.rgb *= diffuse;\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,3]}],blocks:[{name:"TexCoords",defines:[],binding:0,members:[{name:"UVScale",type:16,count:1}]}],samplers:[{name:"weightMap",type:28,count:1,defines:[],binding:30},{name:"detailMap0",type:28,count:1,defines:[],binding:31},{name:"detailMap1",type:28,count:1,defines:[],binding:32},{name:"detailMap2",type:28,count:1,defines:[],binding:33},{name:"detailMap3",type:28,count:1,defines:[],binding:34}]}]},{name:"builtin-unlit",techniques:[{name:"opaque",passes:[{program:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",properties:{color:{value:[1,1,1,1],type:16},tilingOffset:{value:[1,1,0,0],type:16},mainTexture:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",hash:2096712480,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp mat4 cc_matWorlds[10];\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform CCSkinningAnimation {\n  highp vec4 cc_jointsAnimInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\n#if USE_VERTEX_COLOR\n  in vec4 a_color;\n  out vec4 v_color;\n#endif\n#if USE_TEXTURE\n  in vec2 a_texCoord;\n  out vec2 v_uv;\n  uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nhighp vec4 vert () {\n  vec4 position;\n  CCVertInput(position);\n  highp vec4 pos = cc_matViewProj * cc_matWorld * position;\n  #if USE_TEXTURE\n    v_uv = a_texCoord;\n  #if FLIP_UV\n    v_uv.y = 1.0 - v_uv.y;\n  #endif\n    v_uv = v_uv * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n#if USE_TEXTURE\n  in vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\n#if USE_COLOR\n  uniform Constant {\n    vec4 color;\n  };\n#endif\n#if USE_VERTEX_COLOR\n  in vec4 v_color;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  return CCFragOutput(o);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform highp vec4 cc_jointsAnimInfo;\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\n#if USE_VERTEX_COLOR\n  attribute vec4 a_color;\n  varying vec4 v_color;\n#endif\n#if USE_TEXTURE\n  attribute vec2 a_texCoord;\n  varying vec2 v_uv;\n  uniform vec4 tilingOffset;\n#endif\nhighp vec4 vert () {\n  vec4 position;\n  CCVertInput(position);\n  highp vec4 pos = cc_matViewProj * cc_matWorld * position;\n  #if USE_TEXTURE\n    v_uv = a_texCoord;\n  #if FLIP_UV\n    v_uv.y = 1.0 - v_uv.y;\n  #endif\n    v_uv = v_uv * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\n#if USE_COLOR\n  uniform vec4 color;\n#endif\n#if USE_VERTEX_COLOR\n  varying vec4 v_color;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, v_uv);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  return CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING"]}],samplers:[{name:"cc_jointsTexture",defines:["CC_USE_SKINNING"]}]}},defines:[{name:"CC_USE_SKINNING",type:"number",range:[0,2]},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"FLIP_UV",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_COLOR",type:"boolean"}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:["USE_COLOR"],binding:1,members:[{name:"color",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],binding:30}]}]},{name:"editor/terrain-circle-brush",techniques:[{name:"transparent",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"editor/terrain-circle-brush|terrain-brush-vs:vert|terrain-brush-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{BrushPos:{value:[0,0,0,1],type:16},BrushParams:{value:[2.5,2.5,0,0],type:16}}}]}],shaders:[{name:"editor/terrain-circle-brush|terrain-brush-vs:vert|terrain-brush-fs:frag",hash:394086792,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp mat4 cc_matWorlds[10];\n};\nin vec3 a_position;\nout vec4 wposition;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  wposition = cc_matWorld * pos;\n  wposition.y += 0.01;\n  pos = cc_matViewProj * wposition;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec4 wposition;\nuniform TexCoords {\n  vec4 BrushPos;\n  vec4 BrushParams;\n};\nvec4 frag () {\n  float Radius = BrushParams.x;\n  float Falloff = BrushParams.y;\n  float Distance = length(wposition.xz - BrushPos.xz);\n  float k = 0.0;\n  #if LINEAR\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      k = max(0.0, 1.0 - (Distance - Radius) / Falloff);\n    }\n  #elif SMOOTH\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      float y = (Distance - Radius) / Falloff;\n      k = sqrt(1.0 - y * y);\n    }\n  #elif SPHERICAL\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      k = max(0.0, 1.0 - (Distance - Radius) / Falloff);\n    }\n    k = k*k*(3 - 2 * k);\n  #elif TIP\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      float y = (Falloff + Radius - Distance) / Falloff;\n      k = 1.0 - sqrt(1.0 - y * y);\n    }\n  #endif\n  vec4 color = vec4(0, 0, 0, 0);\n  color.rgb = vec3(100, 100, 135) / 255.0;\n  color.a = 0.85 * k;\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nvarying vec4 wposition;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  wposition = cc_matWorld * pos;\n  wposition.y += 0.01;\n  pos = cc_matViewProj * wposition;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec4 wposition;\nuniform vec4 BrushPos;\nuniform vec4 BrushParams;\nvec4 frag () {\n  float Radius = BrushParams.x;\n  float Falloff = BrushParams.y;\n  float Distance = length(wposition.xz - BrushPos.xz);\n  float k = 0.0;\n  #if LINEAR\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      k = max(0.0, 1.0 - (Distance - Radius) / Falloff);\n    }\n  #elif SMOOTH\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      float y = (Distance - Radius) / Falloff;\n      k = sqrt(1.0 - y * y);\n    }\n  #elif SPHERICAL\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      k = max(0.0, 1.0 - (Distance - Radius) / Falloff);\n    }\n    k = k*k*(3 - 2 * k);\n  #elif TIP\n    if (Distance <= Radius) {\n      k = 1.0;\n    }\n    else if (Distance > Radius + Falloff) {\n      k = 0.0;\n    }\n    else {\n      float y = (Falloff + Radius - Distance) / Falloff;\n      k = 1.0 - sqrt(1.0 - y * y);\n    }\n  #endif\n  vec4 color = vec4(0, 0, 0, 0);\n  color.rgb = vec3(100, 100, 135) / 255.0;\n  color.a = 0.85 * k;\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"},{name:"LINEAR",type:"boolean"},{name:"SMOOTH",type:"boolean"},{name:"SPHERICAL",type:"boolean"},{name:"TIP",type:"boolean"}],blocks:[{name:"TexCoords",defines:[],binding:0,members:[{name:"BrushPos",type:16,count:1},{name:"BrushParams",type:16,count:1}]}],samplers:[]}]},{name:"pipeline/planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:2934695859,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp mat4 cc_matWorlds[10];\n};\nuniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  vec4 cc_shadowColor;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nin vec4 a_weights;\nin vec4 a_joints;\nuniform CCSkinningTexture {\n  highp vec4 cc_jointsTextureInfo;\n};\nuniform CCSkinningAnimation {\n  highp vec4 cc_jointsAnimInfo;\n};\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\nhighp vec4 vert () {\n  highp vec4 position;\n  CCVertInput(position);\n  position = cc_matViewProj * cc_matLightPlaneProj * cc_matWorld * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  vec4 cc_shadowColor;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightPlaneProj;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec4 position;\n  vec3 normal;\n  vec4 tangent;\n  int index;\n};\nattribute vec4 a_weights;\nattribute vec4 a_joints;\nuniform highp vec4 cc_jointsTextureInfo;\nuniform highp vec4 cc_jointsAnimInfo;\nuniform sampler2D cc_jointsTexture;\n#if CC_USE_SKINNING == 1\n  highp float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    highp float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    highp float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 12.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 3.5) * invSize, y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 4.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 5.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 6.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 7.5) * invSize, y)))\n    );\n    S = vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((x + 8.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 9.5) * invSize, y))),\n      decode32(texture2D(cc_jointsTexture, vec2((x + 10.5) * invSize, y)))\n    );\n  }\n#elif CC_USE_SKINNING == 2\n  void getJointDQ(float i, out vec4 Qr, out vec4 Qt, out vec3 S) {\n    highp float j = 3.0 * (cc_jointsAnimInfo.x * i + cc_jointsAnimInfo.y) + cc_jointsTextureInfo.z;\n    highp float invSize = cc_jointsTextureInfo.y;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointsTextureInfo.x;\n    y = (y + 0.5) * invSize;\n    Qr = texture2D(cc_jointsTexture, vec2((x + 0.5) * invSize, y));\n    Qt = texture2D(cc_jointsTexture, vec2((x + 1.5) * invSize, y));\n    S = texture2D(cc_jointsTexture, vec2((x + 2.5) * invSize, y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0); vec3 s;\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    getJointDQ(a_joints[i], r, t, s);\n    S += s * w; R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n  return v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec4 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position.xyz = VectorTransformQuat(position.xyz * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position.xyz = VectorTransformQuat(attr.position.xyz * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent.xyz = VectorTransformQuat(attr.tangent.xyz, R);\n}\n#endif\nvoid CCVertInput (out highp vec4 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\nhighp vec4 vert () {\n  highp vec4 position;\n  CCVertInput(position);\n  position = cc_matViewProj * cc_matLightPlaneProj * cc_matWorld * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_shadowColor;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING"]}],samplers:[{name:"cc_jointsTexture",defines:["CC_USE_SKINNING"]}]}},defines:[{name:"CC_USE_SKINNING",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplers:[]}]},{name:"pipeline/skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"pipeline/skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"pipeline/skybox|sky-vs:vert|sky-fs:frag",hash:234120969,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nout vec4 viewDir;\nhighp vec4 vert () {\n  CCDecode(viewDir);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  highp vec4 pos = matViewRotOnly * viewDir;\n  highp vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_screenSize.y * cc_screenSize.z, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nin vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb) * cc_ambientSky.w;\n  #endif\n  return CCFragOutput(vec4(c, 1.0));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 cc_screenSize;\nuniform mat4 cc_matView;\nuniform mat4 cc_matProj;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nvarying vec4 viewDir;\nhighp vec4 vert () {\n  CCDecode(viewDir);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  highp vec4 pos = matViewRotOnly * viewDir;\n  highp vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_screenSize.y * cc_screenSize.z, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nvarying vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb) * cc_ambientSky.w;\n  #endif\n  return CCFragOutput(vec4(c, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplers:[]}]},{name:"pipeline/smaa",techniques:[{name:"smaa",passes:[{program:"pipeline/smaa|smaa-edge-vs:vert|smaa-edge-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{u_texSampler:{type:28,samplerHash:66186}}},{program:"pipeline/smaa|smaa-blend-vs:vert|smaa-blend-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{u_edgeTexSampler:{type:28,samplerHash:66186},u_areaTexSampler:{type:28,samplerHash:66186},u_searchTexSampler:{type:28,samplerHash:66181}}}]}],shaders:[{name:"pipeline/smaa|smaa-edge-vs:vert|smaa-edge-fs:frag",hash:2142686600,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout vec4 v_offsets[3];\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0.0, 1.0);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_offsets[0] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-1.0, 0.0, 0.0, 1.0);\n  v_offsets[1] = v_uv.xyxy + cc_nativeSize.zwzw * vec4( 1.0, 0.0, 0.0, -1.0);\n  v_offsets[2] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-2.0, 0.0, 0.0, 2.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#define saturate(a) clamp( a, 0.0, 1.0 )\nhighp mat4 transposeMat4(in highp mat4 mat) {\n    highp vec4 i0 = mat[0];\n    highp vec4 i1 = mat[1];\n    highp vec4 i2 = mat[2];\n    highp vec4 i3 = mat[3];\n    return mat4(vec4(i0.x, i1.x, i2.x, i3.x),\n                vec4(i0.y, i1.y, i2.y, i3.y),\n                vec4(i0.z, i1.z, i2.z, i3.z),\n                vec4(i0.w, i1.w, i2.w, i3.w));\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nin vec2 v_uv;\nin vec4 v_offsets[3];\nuniform sampler2D u_texSampler;\nvec3 ToLDR(vec3 color) {\n#if CC_USE_HDR\n  color *= cc_exposure.x * 1024.0;\n  color = ACESToneMap(color);\n  color = LinearToSRGB(color);\n#endif\n  return color;\n}\nvec4 frag () {\n  vec2 threshold = vec2(0.1, 0.1);\n  vec4 delta;\n  vec3 C = ToLDR(texture(u_texSampler, v_uv).rgb);\n  vec3 Cleft = ToLDR(texture(u_texSampler, v_offsets[0].xy).rgb);\n  vec3 t = abs(C - Cleft);\n  delta.x = max(max(t.r, t.g), t.b);\n  vec3 Ctop = ToLDR(texture(u_texSampler, v_offsets[0].zw).rgb);\n  t = abs(C - Ctop);\n  delta.y = max(max(t.r, t.g), t.b);\n  vec2 edges = step(threshold, delta.xy);\n  if (dot(edges, vec2(1.0, 1.0)) == 0.0)\n    discard;\n  vec3 Cright = ToLDR(texture(u_texSampler, v_offsets[1].xy).rgb);\n  t = abs(C - Cright);\n  delta.z = max(max(t.r, t.g), t.b);\n  vec3 Cbottom = ToLDR(texture(u_texSampler, v_offsets[1].zw).rgb);\n  t = abs(C - Cbottom);\n  delta.w = max(max(t.r, t.g), t.b);\n  float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);\n  vec3 Cleftleft = ToLDR(texture(u_texSampler, v_offsets[2].xy).rgb);\n  t = abs(C - Cleftleft);\n  delta.z = max(max(t.r, t.g), t.b);\n  vec3 Ctoptop = ToLDR(texture(u_texSampler, v_offsets[2].zw).rgb);\n  t = abs(C - Ctoptop);\n  delta.w = max(max(t.r, t.g), t.b);\n  maxDelta = max(max(maxDelta, delta.z), delta.w);\n  edges.xy *= step(0.5 * maxDelta, delta.xy);\n  vec4 o = vec4(edges, 0.0, 0.0);\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\nuniform vec4 cc_screenScale;\nuniform vec4 cc_nativeSize;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying vec4 v_offsets[3];\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0.0, 1.0);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_offsets[0] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-1.0, 0.0, 0.0, 1.0);\n  v_offsets[1] = v_uv.xyxy + cc_nativeSize.zwzw * vec4( 1.0, 0.0, 0.0, -1.0);\n  v_offsets[2] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-2.0, 0.0, 0.0, 2.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_exposure;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nhighp mat4 transposeMat4(in highp mat4 mat) {\n    highp vec4 i0 = mat[0];\n    highp vec4 i1 = mat[1];\n    highp vec4 i2 = mat[2];\n    highp vec4 i3 = mat[3];\n    return mat4(vec4(i0.x, i1.x, i2.x, i3.x),\n                vec4(i0.y, i1.y, i2.y, i3.y),\n                vec4(i0.z, i1.z, i2.z, i3.z),\n                vec4(i0.w, i1.w, i2.w, i3.w));\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvarying vec2 v_uv;\nvarying vec4 v_offsets[3];\nuniform sampler2D u_texSampler;\nvec3 ToLDR(vec3 color) {\n#if CC_USE_HDR\n  color *= cc_exposure.x * 1024.0;\n  color = ACESToneMap(color);\n  color = LinearToSRGB(color);\n#endif\n  return color;\n}\nvec4 frag () {\n  vec2 threshold = vec2(0.1, 0.1);\n  vec4 delta;\n  vec3 C = ToLDR(texture2D(u_texSampler, v_uv).rgb);\n  vec3 Cleft = ToLDR(texture2D(u_texSampler, v_offsets[0].xy).rgb);\n  vec3 t = abs(C - Cleft);\n  delta.x = max(max(t.r, t.g), t.b);\n  vec3 Ctop = ToLDR(texture2D(u_texSampler, v_offsets[0].zw).rgb);\n  t = abs(C - Ctop);\n  delta.y = max(max(t.r, t.g), t.b);\n  vec2 edges = step(threshold, delta.xy);\n  if (dot(edges, vec2(1.0, 1.0)) == 0.0)\n    discard;\n  vec3 Cright = ToLDR(texture2D(u_texSampler, v_offsets[1].xy).rgb);\n  t = abs(C - Cright);\n  delta.z = max(max(t.r, t.g), t.b);\n  vec3 Cbottom = ToLDR(texture2D(u_texSampler, v_offsets[1].zw).rgb);\n  t = abs(C - Cbottom);\n  delta.w = max(max(t.r, t.g), t.b);\n  float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);\n  vec3 Cleftleft = ToLDR(texture2D(u_texSampler, v_offsets[2].xy).rgb);\n  t = abs(C - Cleftleft);\n  delta.z = max(max(t.r, t.g), t.b);\n  vec3 Ctoptop = ToLDR(texture2D(u_texSampler, v_offsets[2].zw).rgb);\n  t = abs(C - Ctoptop);\n  delta.w = max(max(t.r, t.g), t.b);\n  maxDelta = max(max(maxDelta, delta.z), delta.w);\n  edges.xy *= step(0.5 * maxDelta, delta.xy);\n  vec4 o = vec4(edges, 0.0, 0.0);\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplers:[{name:"u_texSampler",type:28,count:1,defines:[],binding:30}]},{name:"pipeline/smaa|smaa-blend-vs:vert|smaa-blend-fs:frag",hash:1697076750,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout vec4 v_offsets[3];\nout vec2 v_pixCoord;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0.0, 1.0);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_pixCoord = v_uv * cc_nativeSize.xy;\n  v_offsets[0] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-0.25, 0.125, 1.25, 0.125);\n  v_offsets[1] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-0.125, 0.25, -0.125, -1.25);\n  v_offsets[2] = vec4(v_offsets[0].xz, v_offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * cc_nativeSize.zzww * float(8);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec2 v_uv;\nin vec4 v_offsets[3];\nin vec2 v_pixCoord;\nuniform sampler2D u_edgeTexSampler;\nuniform sampler2D u_areaTexSampler;\nuniform sampler2D u_searchTexSampler;\nfloat SMAASearchLength(vec2 e, float bias, float scale) {\n  e.r = bias + e.r * scale;\n  return 255.0 * texture(u_searchTexSampler, e).r;\n}\nfloat SMAASearchXLeft(vec2 texcoord, float end) {\n  vec2 e = vec2(0.0, 1.0);\n  for (int i = 0; i < 8; ++i) {\n      e = texture(u_edgeTexSampler, texcoord).rg;\n      texcoord -= vec2( 2.0, 0.0 ) * cc_nativeSize.zw;\n      if (!(texcoord.x > end && e.g > 0.8281 && e.r == 0.0))\n        break;\n  }\n  texcoord.x += 0.25 * cc_nativeSize.z;\n  texcoord.x += cc_nativeSize.z;\n  texcoord.x += 2.0 * cc_nativeSize.z;\n  texcoord.x -= cc_nativeSize.z * SMAASearchLength(e, 0.0, 0.5);\n  return texcoord.x;\n}\nfloat SMAASearchXRight(vec2 texcoord, float end) {\n  vec2 e = vec2(0.0, 1.0);\n  for (int i = 0; i < 8; ++i) {\n      e = texture(u_edgeTexSampler, texcoord).rg;\n      texcoord += vec2( 2.0, 0.0 ) * cc_nativeSize.zw;\n      if (!(texcoord.x < end && e.g > 0.8281 && e.r == 0.0))\n        break;\n  }\n  texcoord.x -= 0.25 * cc_nativeSize.z;\n  texcoord.x -= cc_nativeSize.z;\n  texcoord.x -= 2.0 * cc_nativeSize.z;\n  texcoord.x += cc_nativeSize.z * SMAASearchLength(e, 0.5, 0.5);\n  return texcoord.x;\n}\nfloat SMAASearchYUp(vec2 texcoord, float end) {\n    vec2 e = vec2(1.0, 0.0);\n    for (int i = 0; i < 8; ++i) {\n        e = texture(u_edgeTexSampler, texcoord).rg;\n        texcoord += vec2( 0.0, 2.0 ) * cc_nativeSize.zw;\n        if (!(texcoord.y > end && e.r > 0.8281 && e.g == 0.0))\n          break;\n    }\n    texcoord.y -= 0.25 * cc_nativeSize.w;\n    texcoord.y -= cc_nativeSize.w;\n    texcoord.y -= 2.0 * cc_nativeSize.w;\n    texcoord.y += cc_nativeSize.w * SMAASearchLength(e.gr, 0.0, 0.5);\n    return texcoord.y;\n}\nfloat SMAASearchYDown(vec2 texcoord, float end) {\n    vec2 e = vec2(1.0, 0.0);\n    for (int i = 0; i < 8; ++i) {\n        e = texture(u_edgeTexSampler, texcoord).rg;\n        texcoord -= vec2( 0.0, 2.0 ) * cc_nativeSize.zw;\n        if (!(texcoord.y < end && e.r > 0.8281 && e.g == 0.0))\n          break;\n    }\n    texcoord.y += 0.25 * cc_nativeSize.w;\n    texcoord.y += cc_nativeSize.w;\n    texcoord.y += 2.0 * cc_nativeSize.w;\n    texcoord.y -= cc_nativeSize.w * SMAASearchLength(e.gr, 0.5, 0.5);\n    return texcoord.y;\n}\nvec2 Round(vec2 x) {\n  return sign(x) * floor(abs(x) + 0.5);\n}\nvec2 SMAAArea(vec2 dist, float e1, float e2) {\n    vec2 texcoord = float(16) * Round(4.0 * vec2(e1, e2)) + dist;\n    texcoord = (1.0 / vec2(160.0, 560.0)) * texcoord + 0.5 * (1.0 / vec2(160.0, 560.0));\n    return texture(u_areaTexSampler, texcoord).rg;\n}\nvec4 frag () {\n  vec4 weights = vec4(0.0);\n  vec2 e = texture(u_edgeTexSampler, v_uv).rg;\n  vec2 d;\n  vec2 coords;\n  if ( e.g > 0.0 ) {\n      coords.x = SMAASearchXLeft(v_offsets[0].xy, v_offsets[2].x);\n      coords.y = v_offsets[1].y;\n      d.x = coords.x;\n      float e1 = texture(u_edgeTexSampler, coords).r;\n      coords.x = SMAASearchXRight(v_offsets[0].zw, v_offsets[2].y);\n      d.y = coords.x;\n      d = d / cc_nativeSize.z - v_pixCoord.x;\n      vec2 sqrt_d = sqrt(abs(d));\n      coords.y -= 1.0 * cc_nativeSize.w;\n      float e2 = texture(u_edgeTexSampler, coords + vec2(cc_nativeSize.z, 0.0)).r;\n      weights.rg = SMAAArea(sqrt_d, e1, e2);\n  }\n  if ( e.r > 0.0 ) {\n      coords.y = SMAASearchYUp(v_offsets[1].xy, v_offsets[2].z);\n      coords.x = v_offsets[0].x;\n      d.x = coords.y;\n      float e1 = texture(u_edgeTexSampler, coords).g;\n      coords.y = SMAASearchYDown(v_offsets[1].zw, v_offsets[2].w);\n      d.y = coords.y;\n      d = d / cc_nativeSize.w - v_pixCoord.y;\n      vec2 sqrt_d = sqrt(abs(d));\n      coords.y -= 1.0 * cc_nativeSize.w;\n      float e2 = texture(u_edgeTexSampler, coords + vec2(0.0, cc_nativeSize.w)).g;\n      weights.ba = SMAAArea(sqrt_d, e1, e2);\n  }\n  return weights;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\nuniform vec4 cc_screenScale;\nuniform vec4 cc_nativeSize;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying vec4 v_offsets[3];\nvarying vec2 v_pixCoord;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0.0, 1.0);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_pixCoord = v_uv * cc_nativeSize.xy;\n  v_offsets[0] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-0.25, 0.125, 1.25, 0.125);\n  v_offsets[1] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-0.125, 0.25, -0.125, -1.25);\n  v_offsets[2] = vec4(v_offsets[0].xz, v_offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * cc_nativeSize.zzww * float(8);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_nativeSize;\nvarying vec2 v_uv;\nvarying vec4 v_offsets[3];\nvarying vec2 v_pixCoord;\nuniform sampler2D u_edgeTexSampler;\nuniform sampler2D u_areaTexSampler;\nuniform sampler2D u_searchTexSampler;\nfloat SMAASearchLength(vec2 e, float bias, float scale) {\n  e.r = bias + e.r * scale;\n  return 255.0 * texture2D(u_searchTexSampler, e).r;\n}\nfloat SMAASearchXLeft(vec2 texcoord, float end) {\n  vec2 e = vec2(0.0, 1.0);\n  for (int i = 0; i < 8; ++i) {\n      e = texture2D(u_edgeTexSampler, texcoord).rg;\n      texcoord -= vec2( 2.0, 0.0 ) * cc_nativeSize.zw;\n      if (!(texcoord.x > end && e.g > 0.8281 && e.r == 0.0))\n        break;\n  }\n  texcoord.x += 0.25 * cc_nativeSize.z;\n  texcoord.x += cc_nativeSize.z;\n  texcoord.x += 2.0 * cc_nativeSize.z;\n  texcoord.x -= cc_nativeSize.z * SMAASearchLength(e, 0.0, 0.5);\n  return texcoord.x;\n}\nfloat SMAASearchXRight(vec2 texcoord, float end) {\n  vec2 e = vec2(0.0, 1.0);\n  for (int i = 0; i < 8; ++i) {\n      e = texture2D(u_edgeTexSampler, texcoord).rg;\n      texcoord += vec2( 2.0, 0.0 ) * cc_nativeSize.zw;\n      if (!(texcoord.x < end && e.g > 0.8281 && e.r == 0.0))\n        break;\n  }\n  texcoord.x -= 0.25 * cc_nativeSize.z;\n  texcoord.x -= cc_nativeSize.z;\n  texcoord.x -= 2.0 * cc_nativeSize.z;\n  texcoord.x += cc_nativeSize.z * SMAASearchLength(e, 0.5, 0.5);\n  return texcoord.x;\n}\nfloat SMAASearchYUp(vec2 texcoord, float end) {\n    vec2 e = vec2(1.0, 0.0);\n    for (int i = 0; i < 8; ++i) {\n        e = texture2D(u_edgeTexSampler, texcoord).rg;\n        texcoord += vec2( 0.0, 2.0 ) * cc_nativeSize.zw;\n        if (!(texcoord.y > end && e.r > 0.8281 && e.g == 0.0))\n          break;\n    }\n    texcoord.y -= 0.25 * cc_nativeSize.w;\n    texcoord.y -= cc_nativeSize.w;\n    texcoord.y -= 2.0 * cc_nativeSize.w;\n    texcoord.y += cc_nativeSize.w * SMAASearchLength(e.gr, 0.0, 0.5);\n    return texcoord.y;\n}\nfloat SMAASearchYDown(vec2 texcoord, float end) {\n    vec2 e = vec2(1.0, 0.0);\n    for (int i = 0; i < 8; ++i) {\n        e = texture2D(u_edgeTexSampler, texcoord).rg;\n        texcoord -= vec2( 0.0, 2.0 ) * cc_nativeSize.zw;\n        if (!(texcoord.y < end && e.r > 0.8281 && e.g == 0.0))\n          break;\n    }\n    texcoord.y += 0.25 * cc_nativeSize.w;\n    texcoord.y += cc_nativeSize.w;\n    texcoord.y += 2.0 * cc_nativeSize.w;\n    texcoord.y -= cc_nativeSize.w * SMAASearchLength(e.gr, 0.5, 0.5);\n    return texcoord.y;\n}\nvec2 Round(vec2 x) {\n  return sign(x) * floor(abs(x) + 0.5);\n}\nvec2 SMAAArea(vec2 dist, float e1, float e2) {\n    vec2 texcoord = float(16) * Round(4.0 * vec2(e1, e2)) + dist;\n    texcoord = (1.0 / vec2(160.0, 560.0)) * texcoord + 0.5 * (1.0 / vec2(160.0, 560.0));\n    return texture2D(u_areaTexSampler, texcoord).rg;\n}\nvec4 frag () {\n  vec4 weights = vec4(0.0);\n  vec2 e = texture2D(u_edgeTexSampler, v_uv).rg;\n  vec2 d;\n  vec2 coords;\n  if ( e.g > 0.0 ) {\n      coords.x = SMAASearchXLeft(v_offsets[0].xy, v_offsets[2].x);\n      coords.y = v_offsets[1].y;\n      d.x = coords.x;\n      float e1 = texture2D(u_edgeTexSampler, coords).r;\n      coords.x = SMAASearchXRight(v_offsets[0].zw, v_offsets[2].y);\n      d.y = coords.x;\n      d = d / cc_nativeSize.z - v_pixCoord.x;\n      vec2 sqrt_d = sqrt(abs(d));\n      coords.y -= 1.0 * cc_nativeSize.w;\n      float e2 = texture2D(u_edgeTexSampler, coords + vec2(cc_nativeSize.z, 0.0)).r;\n      weights.rg = SMAAArea(sqrt_d, e1, e2);\n  }\n  if ( e.r > 0.0 ) {\n      coords.y = SMAASearchYUp(v_offsets[1].xy, v_offsets[2].z);\n      coords.x = v_offsets[0].x;\n      d.x = coords.y;\n      float e1 = texture2D(u_edgeTexSampler, coords).g;\n      coords.y = SMAASearchYDown(v_offsets[1].zw, v_offsets[2].w);\n      d.y = coords.y;\n      d = d / cc_nativeSize.w - v_pixCoord.y;\n      vec2 sqrt_d = sqrt(abs(d));\n      coords.y -= 1.0 * cc_nativeSize.w;\n      float e2 = texture2D(u_edgeTexSampler, coords + vec2(0.0, cc_nativeSize.w)).g;\n      weights.ba = SMAAArea(sqrt_d, e1, e2);\n  }\n  return weights;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[],blocks:[],samplers:[{name:"u_edgeTexSampler",type:28,count:1,defines:[],binding:30},{name:"u_areaTexSampler",type:28,count:1,defines:[],binding:31},{name:"u_searchTexSampler",type:28,count:1,defines:[],binding:32}]}]},{name:"pipeline/tonemap",techniques:[{name:"tonemap",passes:[{program:"pipeline/tonemap|tonemap-vs:vert|tonemap-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{u_texSampler:{type:28,samplerHash:66186},u_blendTexSampler:{type:28,samplerHash:66186}}}]}],shaders:[{name:"pipeline/tonemap|tonemap-vs:vert|tonemap-fs:frag",hash:1769238053,glsl3:{vert:"\nprecision highp float;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nhighp mat4 transposeMat4(in highp mat4 mat) {\n    highp vec4 i0 = mat[0];\n    highp vec4 i1 = mat[1];\n    highp vec4 i2 = mat[2];\n    highp vec4 i3 = mat[3];\n    return mat4(vec4(i0.x, i1.x, i2.x, i3.x),\n                vec4(i0.y, i1.y, i2.y, i3.y),\n                vec4(i0.z, i1.z, i2.z, i3.z),\n                vec4(i0.w, i1.w, i2.w, i3.w));\n}\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout vec4 v_offset;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_offset = v_uv.xyxy + cc_nativeSize.zwzw * vec4(1.0, 0.0, 0.0, -1.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#define saturate(a) clamp( a, 0.0, 1.0 )\nhighp mat4 transposeMat4(in highp mat4 mat) {\n    highp vec4 i0 = mat[0];\n    highp vec4 i1 = mat[1];\n    highp vec4 i2 = mat[2];\n    highp vec4 i3 = mat[3];\n    return mat4(vec4(i0.x, i1.x, i2.x, i3.x),\n                vec4(i0.y, i1.y, i2.y, i3.y),\n                vec4(i0.z, i1.z, i2.z, i3.z),\n                vec4(i0.w, i1.w, i2.w, i3.w));\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nin vec2 v_uv;\nin vec4 v_offset;\nuniform sampler2D u_texSampler;\nuniform sampler2D u_blendTexSampler;\nvec3 ToLDR(vec3 color) {\n  #if CC_USE_HDR\n    color *= cc_exposure.x * 1024.0;\n    color = ACESToneMap(color);\n    color = LinearToSRGB(color);\n  #endif\n  return color;\n}\nvec4 frag () {\n  #if CC_USE_SMAA\n    vec4 a;\n    a.rb = texture(u_blendTexSampler, v_uv).rb;\n    a.g = texture(u_blendTexSampler, v_offset.zw).g;\n    a.a = texture(u_blendTexSampler, v_offset.xy).a;\n    if (dot(a, vec4(1.0)) < 1e-5) {\n      vec4 o = texture(u_texSampler, v_uv);\n      o.rgb = ToLDR(o.rgb);\n      return o;\n    } else {\n      vec2 offset;\n      offset.x = a.a > a.b ? a.a : -a.b;\n      offset.y = a.g > a.r ? -a.g : a.r;\n      if (abs(offset.x) > abs(offset.y)) {\n        offset.y = 0.0;\n      } else {\n        offset.x = 0.0;\n      }\n      vec4 C = texture(u_texSampler, v_uv);\n      C.rgb = ToLDR(C.rgb);\n      vec2 uv = v_uv + sign(offset) * cc_nativeSize.zw;\n      vec4 Cop = texture(u_texSampler, uv);\n      Cop.rgb = ToLDR(Cop.rgb);\n      float s = abs(offset.x) > abs(offset.y) ? abs(offset.x) : abs(offset.y);\n      C.rgb = pow(C.rgb, vec3(2.2));\n      Cop.rgb = pow(Cop.rgb, vec3(2.2));\n      vec4 mixed = mix(C, Cop, s);\n      mixed.rgb = pow(mixed.rgb, vec3(1.0 / 2.2));\n      return mixed;\n    }\n  #else\n    vec4 o = texture(u_texSampler, v_uv);\n    o.rgb = ToLDR(o.rgb);\n    return o;\n  #endif\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nhighp mat4 transposeMat4(in highp mat4 mat) {\n    highp vec4 i0 = mat[0];\n    highp vec4 i1 = mat[1];\n    highp vec4 i2 = mat[2];\n    highp vec4 i3 = mat[3];\n    return mat4(vec4(i0.x, i1.x, i2.x, i3.x),\n                vec4(i0.y, i1.y, i2.y, i3.y),\n                vec4(i0.z, i1.z, i2.z, i3.z),\n                vec4(i0.w, i1.w, i2.w, i3.w));\n}\nuniform vec4 cc_screenScale;\nuniform vec4 cc_nativeSize;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying vec4 v_offset;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_offset = v_uv.xyxy + cc_nativeSize.zwzw * vec4(1.0, 0.0, 0.0, -1.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_nativeSize;\nuniform vec4 cc_exposure;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nhighp mat4 transposeMat4(in highp mat4 mat) {\n    highp vec4 i0 = mat[0];\n    highp vec4 i1 = mat[1];\n    highp vec4 i2 = mat[2];\n    highp vec4 i3 = mat[3];\n    return mat4(vec4(i0.x, i1.x, i2.x, i3.x),\n                vec4(i0.y, i1.y, i2.y, i3.y),\n                vec4(i0.z, i1.z, i2.z, i3.z),\n                vec4(i0.w, i1.w, i2.w, i3.w));\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvarying vec2 v_uv;\nvarying vec4 v_offset;\nuniform sampler2D u_texSampler;\nuniform sampler2D u_blendTexSampler;\nvec3 ToLDR(vec3 color) {\n  #if CC_USE_HDR\n    color *= cc_exposure.x * 1024.0;\n    color = ACESToneMap(color);\n    color = LinearToSRGB(color);\n  #endif\n  return color;\n}\nvec4 frag () {\n  #if CC_USE_SMAA\n    vec4 a;\n    a.rb = texture2D(u_blendTexSampler, v_uv).rb;\n    a.g = texture2D(u_blendTexSampler, v_offset.zw).g;\n    a.a = texture2D(u_blendTexSampler, v_offset.xy).a;\n    if (dot(a, vec4(1.0)) < 1e-5) {\n      vec4 o = texture2D(u_texSampler, v_uv);\n      o.rgb = ToLDR(o.rgb);\n      return o;\n    } else {\n      vec2 offset;\n      offset.x = a.a > a.b ? a.a : -a.b;\n      offset.y = a.g > a.r ? -a.g : a.r;\n      if (abs(offset.x) > abs(offset.y)) {\n        offset.y = 0.0;\n      } else {\n        offset.x = 0.0;\n      }\n      vec4 C = texture2D(u_texSampler, v_uv);\n      C.rgb = ToLDR(C.rgb);\n      vec2 uv = v_uv + sign(offset) * cc_nativeSize.zw;\n      vec4 Cop = texture2D(u_texSampler, uv);\n      Cop.rgb = ToLDR(Cop.rgb);\n      float s = abs(offset.x) > abs(offset.y) ? abs(offset.x) : abs(offset.y);\n      C.rgb = pow(C.rgb, vec3(2.2));\n      Cop.rgb = pow(Cop.rgb, vec3(2.2));\n      vec4 mixed = mix(C, Cop, s);\n      mixed.rgb = pow(mixed.rgb, vec3(1.0 / 2.2));\n      return mixed;\n    }\n  #else\n    vec4 o = texture2D(u_texSampler, v_uv);\n    o.rgb = ToLDR(o.rgb);\n    return o;\n  #endif\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_SMAA",type:"boolean"}],blocks:[],samplers:[{name:"u_texSampler",type:28,count:1,defines:[],binding:30},{name:"u_blendTexSampler",type:28,count:1,defines:[],binding:31}]}]},{name:"util/profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"util/profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},offset:{type:16}}}]}],shaders:[{name:"util/profiler|profiler-vs:vert|profiler-fs:frag",hash:3710757766,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nin vec2 a_texCoord;\nout vec2 v_uv;\nuniform Constants {\n  vec4 offset;\n};\nvec4 vert () {\n  vec4 position;\n  CCDecode(position);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy + abs(position.xy);\n  v_uv = a_texCoord;\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 cc_screenSize;\nattribute vec3 a_position;\nvoid CCDecode (out vec4 position) {\n  position = vec4(a_position, 1.0);\n}\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 offset;\nvec4 vert () {\n  vec4 position;\n  CCDecode(position);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy + abs(position.xy);\n  v_uv = a_texCoord;\n  return position;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,members:[{name:"offset",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}]}]}]),e_=function(){function e(){y(this,e),this._device=null,this._resources={}}return l(e,[{key:"initBuiltinRes",value:function(e){this._device=e;var t=this._resources,i=document.createElement("canvas"),n=i.getContext("2d"),r=new sh(i),a=i.width=i.height=2;n.fillStyle="#000",n.fillRect(0,0,a,a);var s=new Hh;s._uuid="black-texture",s.image=r,t[s._uuid]=s;var o=new $h;o._uuid="black-cube-texture",o.setMipFilter($h.Filter.LINEAR),o.image={front:new sh(i),back:new sh(i),left:new sh(i),right:new sh(i),top:new sh(i),bottom:new sh(i)},t[o._uuid]=o,n.fillStyle="#777",n.fillRect(0,0,a,a);var l=new Hh;l._uuid="grey-texture",l.image=r,t[l._uuid]=l,n.fillStyle="#fff",n.fillRect(0,0,a,a);var u=new Hh;u._uuid="white-texture",u.image=r,t[u._uuid]=u;var c=new $h;c._uuid="white-cube-texture",c.setMipFilter($h.Filter.LINEAR),c.image={front:new sh(i),back:new sh(i),left:new sh(i),right:new sh(i),top:new sh(i),bottom:new sh(i)},t[c._uuid]=c,n.fillStyle="#7f7fff",n.fillRect(0,0,a,a);var h=new Hh;h._uuid="normal-texture",h.image=r,t[h._uuid]=h,i.width=i.height=16,n.fillStyle="#ddd",n.fillRect(0,0,16,16),n.fillStyle="#555",n.fillRect(0,0,8,8),n.fillStyle="#555",n.fillRect(8,8,8,8);var f=new Hh;f._uuid="default-texture",f.image=r,t[f._uuid]=f;var d=new $h;d.setMipFilter($h.Filter.LINEAR),d._uuid="default-cube-texture",d.image={front:new sh(i),back:new sh(i),left:new sh(i),right:new sh(i),top:new sh(i),bottom:new sh(i)},t[d._uuid]=d;var _=new Jh,p=r._texture;_.texture=p,_._uuid="default-spriteframe",t[_._uuid]=_,$d.forEach(function(e){Object.assign(new cc.EffectAsset,e).onLoaded()});var v=new cc.Material;v._uuid="standard-material",v.initialize({effectName:"builtin-standard"}),t[v._uuid]=v;var m=new cc.Material;m._uuid="missing-material",m.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),m.setProperty("color",cc.color("#ff00ff")),t[m._uuid]=m;var y=new cc.Material;y._uuid="missing-skinning-material";var g=Ld(e);y.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0,CC_USE_SKINNING:g}}),y.setProperty("color",cc.color("#ff00ff")),t[y._uuid]=y;var b=new cc.Material;b._uuid="missing-effect-material",b.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),b.setProperty("color",cc.color("#ffff00")),t[b._uuid]=b;var x=new cc.Material;x._uuid="ui-base-material",x.initialize({defines:{USE_TEXTURE:!1},effectName:"builtin-sprite"}),t[x._uuid]=x;var S=new cc.Material;S._uuid="ui-sprite-material",S.initialize({defines:{USE_TEXTURE:!0},effectName:"builtin-sprite"}),t[S._uuid]=S;var T=new cc.Material;T._uuid="default-particle-material",T.initialize({effectName:"builtin-particle"}),t[T._uuid]=T;var w=new cc.Material;w._uuid="default-trail-material",w.initialize({effectName:"builtin-particle-trail"}),t[w._uuid]=w;var E=new cc.Material;E._uuid="default-billboard-material",E.initialize({effectName:"builtin-billboard"}),t[E._uuid]=E}},{key:"get",value:function(e){return this._resources[e]}}]),e}(),t_=m4("builtinResMgr",cc.builtinResMgr=new e_),i_=function(){function t(e){y(this,t),this.batches=[],this.pso=null,this.ubo=void 0,this.pass=void 0,this._limitCount=10,this.pass=e,this.ubo=e.device.createBuffer({usage:su.UNIFORM|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:kf.SIZE})}return l(t,[{key:"destroy",value:function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],i=0;i<t.vbs.length;++i)t.vbs[i].destroy();t.vbIdx.destroy(),t.ia.destroy()}this.batches.splice(0),this.pso=null,this.ubo.destroy()}},{key:"merge",value:function(e,t){var i=e.subMeshData.flatBuffers;if(0!==i.length){for(var n=0,r=0,a=i[0].count,s=!1,o=0;o<this.batches.length;++o){var l=this.batches[o];if(l.vbs.length===i.length&&l.mergeCount<=this._limitCount){s=!0;for(var u=0;u<l.vbs.length;++u){if(l.vbs[u].stride!==i[u].stride){s=!1;break}}if(s){for(var c=0;c<l.vbs.length;++c){var h=i[c],f=l.vbs[c];(n=(a+l.vbCount)*h.stride)>f.size&&f.resize(n),f.update(h.buffer,l.vbCount*h.stride)}(r=4*(a+l.vbCount))>l.vbIdx.size&&l.vbIdx.resize(r);var d=new Float32Array(i[0].count);return d.fill(l.mergeCount),l.vbIdx.update(d.buffer,4*l.vbCount),Pn.toArray(l.uboLocal.view,t.model.transform.worldMatrix,kf.MAT_WORLDS_OFFSET+16*l.mergeCount),++l.mergeCount,l.vbCount+=a,void(l.ia.vertexCount+=a)}}}for(var _=this.pass.device,p=[],v=[],m=0;m<i.length;++m){var y=i[m],g=_.createBuffer({usage:su.VERTEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:y.count*y.stride,stride:y.stride,flags:cu.BAKUP_BUFFER});g.update(y.buffer),p.push(g),v.push(g)}var b=_.createBuffer({usage:su.VERTEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:4*a,stride:4,flags:cu.BAKUP_BUFFER}),x=new Float32Array(a);x.fill(0),b.update(x),v.push(b);for(var S=e.inputAssembler.attributes,T=new Array(S.length+1),w=0;w<S.length;++w)T[w]=S[w];T[S.length]={name:"a_index",format:ru.R32F,stream:i.length};var E={vbs:p,vbIdx:b,vbCount:a,mergeCount:1,ia:_.createInputAssembler({attributes:T,vertexBuffers:v}),uboLocal:new kf};if(Pn.toArray(E.uboLocal.view,t.model.transform.worldMatrix,kf.MAT_WORLDS_OFFSET),this.batches.push(E),this.pass.bindBuffer(Tf.UBO_LOCAL,this.ubo),this.pass.update(),!this.pso)this.pso=e.psos[this.pass.idxInTech],this.pso.pipelineLayout.layouts[0].update()}}},{key:"clear",value:function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}}}]),t}(),n_=(jd=new Map,Xd=0,function(e){return jd.has(e)||(jd.set(e,1<<Xd),Xd++),jd.get(e)}),r_=0,a_=new(function(){function e(){y(this,e),this._templates=void 0,this._cache=void 0,this._templates={},this._cache={}}return l(e,[{key:"define",value:function(e){var t=this._templates[e.name];if(!t||t.hash!==e.hash){var i=Object.assign({id:++r_},e);i.localsInited||(qd(i,Of,"locals"),i.localsInited=!0);var n=0,r=function(){if(s){if(o>=a.length)return"break";l=a[o++]}else{if((o=a.next()).done)return"break";l=o.value}var i=l,e=1;if("number"===i.type){var t=i.range;e=Hd(t[1]-t[0]+1),i._map=function(e){return e-t[0]<<i._offset}}else"string"===i.type?(e=Hd(i.options.length),i._map=function(t){return Math.max(0,i.options.findIndex(function(e){return e===t}))<<i._offset}):"boolean"===i.type&&(i._map=function(e){return e?1<<i._offset:0});i._offset=n,n+=e},a=i.defines,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if("break"===r())break}this._templates[e.name]=i}}},{key:"getTemplate",value:function(e){return this._templates[e]}},{key:"hasProgram",value:function(e){return void 0!==this._templates[e]}},{key:"getKey",value:function(e,t){var i=this._templates[e],n=0,r=i.defines,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,u=t[l.name];void 0!==u&&l._map&&(n|=l._map(u))}return n<<8|255&i.id}},{key:"destroyShaderByDefines",value:function(e){var i=this,n=Object.keys(e);if(n.length){var r=n.map(function(e){var t=n[e];return"boolean"==typeof t&&(t=t?"1":"0"),new RegExp(e+t)}),t=Object.keys(this._cache).filter(function(t){return r.every(function(e){return e.test(i._cache[t].name)})}),a=Array.isArray(t),s=0;for(t=a?t:t[Symbol.iterator]();;){var o;if(a){if(s>=t.length)break;o=t[s++]}else{if((s=t.next()).done)break;o=s.value}var l=o;console.log("destroyed shader ".concat(this._cache[l].name)),this._cache[l].destroy(),delete this._cache[l]}}}},{key:"getGFXShader",value:function(e,t,i,n){Object.assign(i,n.macros);var r=this.getKey(t,i),a=this._cache[r];if(void 0!==a)return a;var s=this._templates[t];s.globalsInited||(qd(s,n.globalBindings,"globals"),s.globalsInited=!0);var o=function(e,t){var i=[],n=t,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.name,u=Wd(o,e[l]);i.push({name:l,result:u})}return i}(i,s.defines),l=o.reduce(function(e,t){return"".concat(e,"#define ").concat(t.name," ").concat(t.result,"\n")},""),u="",c="";return c=e.gfxAPI===Ac.WEBGL2?(u="#version 300 es\n".concat(l,"\n").concat(s.glsl3.vert),"#version 300 es\n".concat(l,"\n").concat(s.glsl3.frag)):(u="#version 100\n".concat(l,"\n").concat(s.glsl1.vert),"#version 100\n".concat(l,"\n").concat(s.glsl1.frag)),a=e.createShader({name:function(e,t){return e+t.reduce(function(e,t){return"0"!==t.result?"".concat(e,"|").concat(t.name).concat(t.result):e},"")}(t,o),blocks:s.blocks,samplers:s.samplers,stages:[{type:ju.VERTEX,source:u},{type:ju.FRAGMENT,source:c}]}),this._cache[r]=a}}]),e}());cc.programLib=a_;function s_(e,t,i,n){return e<<28&f_|i<<22&d_|t<<14&4177920|16383&(3<arguments.length&&void 0!==n?n:0)}function o_(e){return(e&d_)>>>22}function l_(e,t){return e&~d_|t<<22&d_}var u_=(s(Yd={},iu.UNKNOWN,function(e,t){return console.warn("illegal uniform handle")}),s(Yd,iu.INT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]=t}),s(Yd,iu.INT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Ii.toArray(e,t,i)}),s(Yd,iu.INT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Ni.toArray(e,t,i)}),s(Yd,iu.INT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Xi.toArray(e,t,i)}),s(Yd,iu.FLOAT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]=t}),s(Yd,iu.FLOAT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Ii.toArray(e,t,i)}),s(Yd,iu.FLOAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Ni.toArray(e,t,i)}),s(Yd,iu.FLOAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Xi.toArray(e,t,i)}),s(Yd,iu.MAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return an.toArray(e,t,i)}),s(Yd,iu.MAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Pn.toArray(e,t,i)}),Yd),c_=(s(Kd={},iu.UNKNOWN,function(e,t){return console.warn("illegal uniform handle")}),s(Kd,iu.INT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]}),s(Kd,iu.INT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Ii.fromArray(t,e,i)}),s(Kd,iu.INT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Ni.fromArray(t,e,i)}),s(Kd,iu.INT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Xi.fromArray(t,e,i)}),s(Kd,iu.FLOAT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]}),s(Kd,iu.FLOAT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Ii.fromArray(t,e,i)}),s(Kd,iu.FLOAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Ni.fromArray(t,e,i)}),s(Kd,iu.FLOAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Xi.fromArray(t,e,i)}),s(Kd,iu.MAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return an.fromArray(t,e,i)}),s(Kd,iu.MAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Pn.fromArray(t,e,i)}),Kd),h_=(s(Qd={},iu.INT,[0]),s(Qd,iu.INT2,[0,0]),s(Qd,iu.INT3,[0,0,0]),s(Qd,iu.INT4,[0,0,0,0]),s(Qd,iu.FLOAT,[0]),s(Qd,iu.FLOAT2,[0,0]),s(Qd,iu.FLOAT3,[0,0,0]),s(Qd,iu.FLOAT4,[0,0,0,0]),s(Qd,iu.MAT3,[1,0,0,0,1,0,0,0,1]),s(Qd,iu.MAT4,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),s(Qd,iu.SAMPLER2D,"default-texture"),s(Qd,iu.SAMPLER_CUBE,"default-cube-texture"),Qd),f_=4026531840,d_=264241152,__=function(){function f(e){y(this,f),this._buffers={},this._samplers={},this._textureViews={},this._resources=[],this._phase=0,this._idxInTech=0,this._programName="",this._priority=xf.DEFAULT,this._primitive=_u.TRIANGLE_LIST,this._stage=gf.DEFAULT,this._bindings=[],this._bs=new _d,this._dss=new gd,this._rs=new yd,this._dynamicStates=[],this._dynamics={},this._customizations=[],this._handleMap={},this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._device=void 0,this._renderPass=null,this._shader=null,this._batchedBuffer=null,this._device=e}return l(f,null,[{key:"createPasses",value:function(e,t){var i=t.techIdx,n=t.defines,r=t.states,a=e.techniques[i||0];if(!a)return[];for(var s=a.passes.length,o=[],l=0;l<s;++l){var u=a.passes[l],c=u.curDefs=n.length>l?n[l]:{};if(!u.switch||c[u.switch]){u.states=r.length>l?r[l]:{},u.idxInTech=l;var h=new f(cc.game._gfxDevice);h.initialize(u),o.push(h)}}return o}}]),l(f,[{key:"initialize",value:function(e){var n=this;this._idxInTech=e.idxInTech,this._programName=e.program,this._defines=e.curDefs,this._shaderInfo=a_.getTemplate(e.program),this._properties=e.properties||this._properties;var r=this._device;this._fillinPipelineInfo(e),this._fillinPipelineInfo(e.states);function t(){if(s){if(o>=a.length)return"break";l=a[o++]}else{if((o=a.next()).done)return"break";l=o.value}var i=l;if(Ef(i.binding))return"continue";var e=i.members.reduce(function(e,t){return e+Ec(t.type)*t.count},0);n._buffers[i.binding]=r.createBuffer({memUsage:lu.HOST|lu.DEVICE,size:16*Math.ceil(e/16),usage:su.UNIFORM|su.TRANSFER_DST});var t=new ArrayBuffer(e);n._blocks[i.binding]={buffer:t,dirty:!1,view:new Float32Array(t)},i.members.reduce(function(e,t){return n._handleMap[t.name]=s_(Yu.UNIFORM_BUFFER,i.binding,t.type,e),e+(Ec(t.type)>>2)*t.count},0)}var a=this._shaderInfo.blocks,s=Array.isArray(a),o=0;e:for(a=s?a:a[Symbol.iterator]();;){var l;switch(t()){case"break":break e;case"continue":continue}}for(var i=0,u=Object.keys(this._properties);i<u.length;i++){var c=u[i],h=this._properties[c];h.handleInfo&&(this._handleMap[c]=this.getHandle.apply(this,h.handleInfo))}var f=this._shaderInfo.samplers,d=Array.isArray(f),_=0;for(f=d?f:f[Symbol.iterator]();;){var p;if(d){if(_>=f.length)break;p=f[_++]}else{if((_=f.next()).done)break;p=_.value}var v=p;this._handleMap[v.name]=s_(Yu.SAMPLER,v.binding,v.type)}this.resetUBOs(),this.resetTextures(),this.tryCompile()}},{key:"getHandle",value:function(e,t,i){var n=1<arguments.length&&void 0!==t?t:0,r=2<arguments.length&&void 0!==i?i:iu.UNKNOWN,a=this._handleMap[e];if(a)return r?a=l_(a,r):n&&(a=l_(a,o_(a)-n)),a+n}},{key:"getBinding",value:function(e){var t=this.getHandle(e);if(void 0!==t)return f.getBindingFromHandle(t)}},{key:"setUniform",value:function(e,t){var i=f.getBindingFromHandle(e),n=f.getTypeFromHandle(e),r=f.getOffsetFromHandle(e),a=this._blocks[i];u_[n](a.view,t,r),a.dirty=!0}},{key:"getUniform",value:function(e,t){var i=f.getBindingFromHandle(e),n=f.getTypeFromHandle(e),r=f.getOffsetFromHandle(e),a=this._blocks[i];return c_[n](a.view,t,r)}},{key:"setUniformArray",value:function(e,t){for(var i=f.getBindingFromHandle(e),n=f.getTypeFromHandle(e),r=Ec(n)>>2,a=this._blocks[i],s=f.getOffsetFromHandle(e),o=0;o<t.length;o++,s+=r)null!==t[o]&&u_[n](a.view,t[o],s);a.dirty=!0}},{key:"bindBuffer",value:function(e,t){if(this._buffers[e]!==t){this._buffers[e]=t;for(var i=this._resources.length,n=0;n<i;n++){this._resources[n].bindingLayout.bindBuffer(e,t)}}}},{key:"bindTextureView",value:function(e,t){if(this._textureViews[e]!==t){this._textureViews[e]=t;for(var i=this._resources.length,n=0;n<i;n++){this._resources[n].bindingLayout.bindTextureView(e,t)}}}},{key:"bindSampler",value:function(e,t){if(this._samplers[e]!==t){this._samplers[e]=t;for(var i=this._resources.length,n=0;n<i;n++){this._resources[n].bindingLayout.bindSampler(e,t)}}}},{key:"setDynamicState",value:function(e,t){var i=this._dynamics[e];i&&i.value===t||(i.value=t,i.dirty=!0)}},{key:"overridePipelineStates",value:function(e,t){this._bs=new _d,this._dss=new gd,this._rs=new yd,this._fillinPipelineInfo(e),this._fillinPipelineInfo(t)}},{key:"update",value:function(){for(var e=this._blocks.length,t=0;t<e;t++){var i=this._blocks[t];i.dirty&&(this._buffers[t].update(i.buffer),i.dirty=!1)}for(var n=cc.director.root.pipeline.globalBindings,r=this._shaderInfo.builtins.globals,a=r.samplers.length,s=0;s<a;s++){var o=r.samplers[s],l=n.get(o.name);l.sampler&&this.bindSampler(l.samplerInfo.binding,l.sampler),this.bindTextureView(l.samplerInfo.binding,l.textureView)}}},{key:"destroy",value:function(){var e=this._shaderInfo.blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;Ef(r.binding)||this._buffers[r.binding].destroy()}this._buffers={},this._samplers={},this._textureViews={},this._batchedBuffer&&(this._batchedBuffer.destroy(),this._batchedBuffer=null)}},{key:"resetUBOs",value:function(){var e=this._shaderInfo.blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;if(!Ef(r.binding)){for(var a=this._blocks[r.binding],s=0,o=0;o<r.members.length;o++){for(var l=r.members[o],u=this._properties[l.name],c=u&&u.value,h=c||h_[l.type],f=Ec(l.type)>>2,d=0;d<l.count;d++)a.view.set(h,s+d*f);s+=f*l.count}a.dirty=!0}}}},{key:"resetTextures",value:function(){var e=this._shaderInfo.samplers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;if(!Ef(r.binding)){var a=this._properties[r.name],s=a&&a.value?a.value+"-texture":h_[r.type],o=t_.get(s),l=o&&o.getGFXTextureView();if(l){this._textureViews[r.binding]=l;for(var u=a&&void 0!==a.samplerHash?a.samplerHash:o.getSamplerHash(),c=this._samplers[r.binding]=Rh.getSampler(this._device,u),h=0;h<this._resources.length;h++){var f=this._resources[h];f.bindingLayout.bindSampler(r.binding,c),f.bindingLayout.bindTextureView(r.binding,l)}}else console.warn("illegal texture default value: "+s)}}}},{key:"tryCompile",value:function(e){var i=this;e&&Object.assign(this._defines,e);var t=cc.director.root.pipeline;return!!t&&(this._renderPass=t.getRenderPass(this._stage),this._renderPass?(this._shader=a_.getGFXShader(this._device,this._programName,this._defines,t),this._shader?(this._bindings=this._shaderInfo.blocks.reduce(function(e,t){return t.defines.every(function(e){return i._defines[e]})&&e.push({name:t.name,binding:t.binding,type:Yu.UNIFORM_BUFFER}),e},[]).concat(this._shaderInfo.samplers.reduce(function(e,t){return t.defines.every(function(e){return i._defines[e]})&&e.push({name:t.name,binding:t.binding,type:Yu.SAMPLER}),e},[])),!0):(console.warn("create shader ".concat(this._programName," failed")),!1)):(console.warn("illegal pass stage."),!1))}},{key:"createPipelineState",value:function(){if(!(this._renderPass&&this._shader&&this._bindings.length||this.tryCompile()))return console.warn("pass resources not complete, create PSO failed"),null;for(var e=this._device.createBindingLayout({bindings:this._bindings}),t=0,i=Object.keys(this._buffers);t<i.length;t++){var n=i[t];e.bindBuffer(parseInt(n),this._buffers[n])}for(var r=0,a=Object.keys(this._samplers);r<a.length;r++){var s=a[r];e.bindSampler(parseInt(s),this._samplers[s])}for(var o=0,l=Object.keys(this._textureViews);o<l.length;o++){var u=l[o];e.bindTextureView(parseInt(u),this._textureViews[u])}var c=cc.director.root.pipeline.globalBindings,h=this._shaderInfo.builtins.globals,f=h.blocks,d=Array.isArray(f),_=0;for(f=d?f:f[Symbol.iterator]();;){var p;if(d){if(_>=f.length)break;p=f[_++]}else{if((_=f.next()).done)break;p=_.value}var v=p,m=c.get(v.name);m&&m.type===Yu.UNIFORM_BUFFER?e.bindBuffer(m.blockInfo.binding,m.buffer):console.warn("builtin UBO '".concat(v.name,"' not available!"))}var y=h.samplers,g=Array.isArray(y),b=0;for(y=g?y:y[Symbol.iterator]();;){var x;if(g){if(b>=y.length)break;x=y[b++]}else{if((b=y.next()).done)break;x=b.value}var S=x,T=c.get(S.name);T&&T.type===Yu.SAMPLER?(T.sampler&&e.bindSampler(T.samplerInfo.binding,T.sampler),e.bindTextureView(T.samplerInfo.binding,T.textureView)):console.warn("builtin texture '".concat(S.name,"' not available!"))}var w=this._device.createPipelineLayout({layouts:[e]}),E=this._device.createPipelineState({bs:this._bs,dss:this._dss,dynamicStates:this._dynamicStates,is:new pd,layout:w,primitive:this._primitive,renderPass:this._renderPass,rs:this._rs,shader:this._shader});return this._resources.push({bindingLayout:e,pipelineLayout:w,pipelineState:E}),E}},{key:"destroyPipelineState",value:function(t){var e=this._resources.findIndex(function(e){return e.pipelineState===t});if(0<=e){var i=this._resources[e],n=i.bindingLayout,r=i.pipelineLayout,a=i.pipelineState;n.destroy(),r.destroy(),a.destroy(),this._resources.splice(e,1)}}},{key:"serializePipelineStates",value:function(){var e=a_.getKey(this._programName,this._defines),t="".concat(e,",").concat(this._stage,",").concat(this._primitive);return t+=M_(this._bs),t+=B_(this._dss),t+=I_(this._rs)}},{key:"createBatchedBuffer",value:function(){this._batchedBuffer||(this._batchedBuffer=new i_(this))}},{key:"destroyBatchedBuffer",value:function(){this._batchedBuffer&&(this._batchedBuffer.destroy(),this._batchedBuffer=null)}},{key:"clearBatchedBuffer",value:function(){if(this._batchedBuffer){var e=new kf;this._batchedBuffer.ubo.update(e.view.buffer)}}},{key:"_fillinPipelineInfo",value:function(e){if(void 0!==e.priority&&(this._priority=e.priority),void 0!==e.primitive&&(this._primitive=e.primitive),void 0!==e.stage&&(this._stage=e.stage),void 0!==e.dynamics&&(this._dynamicStates=e.dynamics),e.customizations&&(this._customizations=e.customizations),0===this._phase){var t=e.phase||"default";this._phase=n_(t)}var i=this._bs;if(e.blendState){var n=Object.assign({},e.blendState);n.targets&&n.targets.forEach(function(e,t){return Object.assign(i.targets[t]||(i.targets[t]=new bd),e)}),delete n.targets,Object.assign(i,n)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState)}},{key:"device",get:function(){return this._device}},{key:"idxInTech",get:function(){return this._idxInTech}},{key:"programName",get:function(){return this._programName}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"bindings",get:function(){return this._bindings}},{key:"blendState",get:function(){return this._bs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"rasterizerState",get:function(){return this._rs}},{key:"dynamics",get:function(){return this._dynamics}},{key:"customizations",get:function(){return this._customizations}},{key:"shader",get:function(){return this._shader}},{key:"batchedBuffer",get:function(){return this._batchedBuffer}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"properties",get:function(){return this._properties}}]),f}();__.getBindingTypeFromHandle=function(e){return(e&f_)>>>28},__.getTypeFromHandle=o_,__.getBindingFromHandle=function(e){return(4177920&e)>>>14},__.getOffsetFromHandle=function(e){return 16383&e};var p_,v_,m_,y_,g_,b_,x_,S_,T_,w_,E_,A_,C_,k_,R_,O_,M_=function(e){var t=",bs,".concat(e.isA2C,",").concat(e.blendColor),i=e.targets,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t+=",bt,".concat(s.blend,",").concat(s.blendEq,",").concat(s.blendAlphaEq,",").concat(s.blendColorMask),t+=",".concat(s.blendSrc,",").concat(s.blendDst,",").concat(s.blendSrcAlpha,",").concat(s.blendDstAlpha)}return t},I_=function(e){return",rs,".concat(e.cullMode,",").concat(e.depthBias,",").concat(e.isFrontFaceCCW)},B_=function(e){var t=",dss,".concat(e.depthTest,",").concat(e.depthWrite,",").concat(e.depthFunc);return t+=",".concat(e.stencilTestFront,",").concat(e.stencilFuncFront,",").concat(e.stencilRefFront,",").concat(e.stencilReadMaskFront),t+=",".concat(e.stencilFailOpFront,",").concat(e.stencilZFailOpFront,",").concat(e.stencilPassOpFront,",").concat(e.stencilWriteMaskFront),t+=",".concat(e.stencilTestBack,",").concat(e.stencilFuncBack,",").concat(e.stencilRefBack,",").concat(e.stencilReadMaskBack),t+=",".concat(e.stencilFailOpBack,",").concat(e.stencilZFailOpBack,",").concat(e.stencilPassOpBack,",").concat(e.stencilWriteMaskBack)},L_={},P_=m4("EffectAsset",fo("cc.EffectAsset")((x_=b_=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"techniques",m_,c(t)),v(t,"shaders",y_,c(t)),v(t,"combinations",g_,c(t)),t}return _(a,nh),l(a,[{key:"onLoaded",value:function(){this.shaders.forEach(function(e){return a_.define(e)}),cc.game.once(cc.Game.EVENT_ENGINE_INITED,this._precompile,this),a.register(this)}},{key:"_precompile",value:function(){for(var i=this,n=cc.director.root,e=function(e){var t=i.shaders[e],a=i.combinations[e];if(!a)return"continue";Object.keys(a).reduce(function(e,r){return e.reduce(function(e,t){var i=a[r],n=[t].concat(u(Array(i.length-1)).map(function(){return Object.assign({},t)}));return n.forEach(function(e,t){return e[r]=i[t]}),e.concat(n)},[])},[{}]).forEach(function(e){return a_.getGFXShader(n.device,t.name,e,n.pipeline)})},t=0;t<this.shaders.length;t++)e(t)}}],[{key:"register",value:function(e){L_[e.name]=e}},{key:"remove",value:function(e){if(L_[e])delete L_[e];else for(var t in L_)if(L_[t]._uuid===e)return void delete L_[t]}},{key:"get",value:function(e){if(L_[e])return L_[e];for(var t in L_)if(L_[t]._uuid===e)return L_[t];return null}},{key:"getAll",value:function(){return L_}}]),a}(),b_._effects={},m_=m((v_=x_).prototype,"techniques",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),y_=m(v_.prototype,"shaders",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),g_=m(v_.prototype,"combinations",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),p_=v_))||p_);cc.EffectAsset=P_;var F_=m4("Material",(S_=fo("cc.Material"),T_=_o(P_),S_((A_=m((E_=function(){function r(){var e;return y(this,r),v(e=x(this,g(r).call(this)),"_effectAsset",A_,c(e)),v(e,"_techIdx",C_,c(e)),v(e,"_defines",k_,c(e)),v(e,"_states",R_,c(e)),v(e,"_props",O_,c(e)),e._passes=[],e._owner=null,e._hash=0,e.loaded=!1,e}return _(r,nh),l(r,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}}],[{key:"getInstantiatedMaterial",value:function(e,t,i){if(e._owner===t)return e;var n=new r;return n.copy(e),n._native=e._native+" (Instance)",n._owner=t,i&&(n._uuid=e._uuid),n}}]),l(r,[{key:"reset",value:function(e){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=P_.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update()}},{key:"initialize",value:function(e){this.reset(e)}},{key:"destroy",value:function(){if(this._passes&&this._passes.length){var e=this._passes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}}return this._passes=[],this._effectAsset=null,this._props=[],this._defines=[],this._states=[],p(g(r.prototype),"destroy",this).call(this)}},{key:"resetUniforms",value:function(e){var t=!(0<arguments.length&&void 0!==e)||e;this._props.length=this._passes.length;for(var i=0;i<this._props.length;i++)this._props[i]={};if(t){var n=this._passes,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.resetUBOs(),o.resetTextures()}}}},{key:"recompileShaders",value:function(e,t){if(this._passes&&this._effectAsset){if(void 0===t){var i=this._passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.tryCompile(e)}}else this._passes[t].tryCompile(e);this._onPassesChange()}}},{key:"overridePipelineStates",value:function(e,t){if(this._passes&&this._effectAsset){var i=this._effectAsset.techniques[this._techIdx].passes;if(void 0===t)for(var n=0;n<this._passes.length;n++){var r=this._passes[n];this._states[n]=e,r.overridePipelineStates(i[r.idxInTech],e)}else this._states[t]=e,this._passes[t].overridePipelineStates(i[t],e);this._onPassesChange()}}},{key:"onLoaded",value:function(){this._update(),this.loaded=!0,this.emit("load")}},{key:"setProperty",value:function(e,t,i){var n=!1;if(void 0===i)for(var r=this._passes,a=r.length,s=0;s<a;s++){var o=r[s];this._uploadProperty(o,e,t)&&(this._props[s][e]=t,n=!0)}else{if(i>=this._passes.length)return void console.warn("illegal pass index: ".concat(i,"."));var l=this._passes[i];this._uploadProperty(l,e,t)&&(this._props[i][e]=t,n=!0)}n||console.warn("illegal property name: ".concat(e,"."))}},{key:"getProperty",value:function(e,t){if(void 0===t)for(var i=this._props,n=i.length,r=0;r<n;r++)for(var a=i[r],s=0,o=Object.keys(a);s<o.length;s++){var l=o[s];if(l===e)return a[l]}else{if(t>=this._props.length)return console.warn("illegal pass index: ".concat(t,".")),null;for(var u=this._props[t],c=0,h=Object.keys(u);c<h.length;c++){var f=h[c];if(f===e)return u[f]}}return null}},{key:"copy",value:function(e){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var t=0;t<e._props.length;t++)this._props[t]=Object.assign({},e._props[t]);this._defines.length=e._defines.length;for(var i=0;i<e._defines.length;i++)this._defines[i]=Object.assign({},e._defines[i]);this._states.length=e._states.length;for(var n=0;n<e._states.length;n++)this._states[n]=Object.assign({},e._states[n]);this._effectAsset=e._effectAsset,this._update()}},{key:"_prepareInfo",value:function(e,t){if(!Array.isArray(e)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;e=Array(i).fill(e)}for(var n=0;n<e.length;++n)Object.assign(t[n]||(t[n]={}),e[n])}},{key:"_update",value:function(e){var s=this,t=!(0<arguments.length&&void 0!==e)||e;if(this._effectAsset){if(this._passes&&this._passes.length){var i=this._passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.destroy()}}this._passes=__.createPasses(this._effectAsset,{techIdx:this._techIdx,defines:this._defines,states:this._states});var o=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=o,t)this._passes.forEach(function(e,t){var i=s._props[e.idxInTech];i=i||(s._props[t]={});for(var n=0,r=Object.keys(i);n<r.length;n++){var a=r[n];i[a]&&s._uploadProperty(e,a,i[a])}});else for(var l=0;l<this._props.length;l++)this._props[l]={}}else{var u=t_.get("missing-effect-material");u&&(this._passes=u._passes.slice())}this._onPassesChange()}},{key:"_uploadProperty",value:function(e,t,i){var n=e.getHandle(t);if(void 0===n)return!1;var r=__.getBindingTypeFromHandle(n);if(r===Yu.UNIFORM_BUFFER)Array.isArray(i)?e.setUniformArray(n,i):e.setUniform(n,i);else if(r===Yu.SAMPLER){var a=__.getBindingFromHandle(n);if(i instanceof kd)e.bindTextureView(a,i);else if(i instanceof Mh||i instanceof Jh){var s=i.getGFXTextureView();if(!s||!s.texture.width||!s.texture.height)return!1;e.bindTextureView(a,s),i instanceof Mh&&e.bindSampler(a,Rh.getSampler(cc.game._gfxDevice,i.getSamplerHash()))}}return!0}},{key:"_onPassesChange",value:function(){var t=this,e="",i=this._passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}e+=a.serializePipelineStates()}if(this._hash=Mc(e,666),this._owner){var s=this._owner,o=s.sharedMaterials.findIndex(function(e){return e===t});0<=o&&s._onRebuildPSO(o,this)}}}]),r}()).prototype,"_effectAsset",[T_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),C_=m(E_.prototype,"_techIdx",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),k_=m(E_.prototype,"_defines",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),R_=m(E_.prototype,"_states",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),O_=m(E_.prototype,"_props",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),w_=E_))||w_));function z_(e){return e*e}function D_(e){return e*(2-e)}function N_(e){return e*e*e}function U_(e){return--e*e*e+1}function V_(e){return e*e*e*e}function G_(e){return 1- --e*e*e*e}function H_(e){return e*e*e*e*e}function W_(e){return--e*e*e*e*e+1}function q_(e){return 1-Math.cos(e*Math.PI/2)}function j_(e){return Math.sin(e*Math.PI/2)}function X_(e){return 0===e?0:Math.pow(1024,e-1)}function Y_(e){return 1===e?1:1-Math.pow(2,-10*e)}function K_(e){return 1-Math.sqrt(1-e*e)}function Q_(e){return Math.sqrt(1- --e*e)}function Z_(e){return e*e*(2.70158*e-1.70158)}function J_(e){return--e*e*(2.70158*e+1.70158)+1}function $_(e){return 1-ep(1-e)}function ep(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}cc.Material=F_;var tp=cp(z_,D_),ip=cp(N_,U_),np=cp(V_,G_),rp=cp(H_,W_),ap=cp(q_,j_),sp=cp(X_,Y_),op=cp(K_,Q_),lp=cp(Z_,J_),up=cp($_,ep);function cp(t,i){return function(e){return e<.5?i(2*e)/2:t(2*e-1)/2+.5}}var hp=Object.freeze({constant:function(){return 0},linear:function(e){return e},quadIn:z_,quadOut:D_,quadInOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)},cubicIn:N_,cubicOut:U_,cubicInOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)},quartIn:V_,quartOut:G_,quartInOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)},quintIn:H_,quintOut:W_,quintInOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)},sineIn:q_,sineOut:j_,sineInOut:function(e){return.5*(1-Math.cos(Math.PI*e))},expoIn:X_,expoOut:Y_,expoInOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))},circIn:K_,circOut:Q_,circInOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)},elasticIn:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4))},elasticOut:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/.4)+1)},elasticInOut:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4)*-.5:i*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4)*.5+1)},backIn:Z_,backOut:J_,backInOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((1+t)*e-t)*.5:.5*((e-=2)*e*((1+t)*e+t)+2)},bounceIn:$_,bounceOut:ep,bounceInOut:function(e){return e<.5?.5*$_(2*e):.5*ep(2*e-1)+.5},smooth:function(e){return e<=0?0:1<=e?1:e*e*(3-2*e)},fade:function(e){return e<=0?0:1<=e?1:e*e*e*(e*(6*e-15)+10)},quadOutIn:tp,cubicOutIn:ip,quartOutIn:np,quintOutIn:rp,sineOutIn:ap,expoOutIn:sp,circOutIn:op,backOutIn:lp,bounceOutIn:up});m4("easing",hp);var fp="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADqCAYAAADnPAqjAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAFbVSURBVHhe7X0HgBRF9vfrns2wu4Ql55xzBhMiiAqCqICoKGI6vVP/oud5gLiC9x2nnOE805kAAQkCAookEYkqKjnnvGR2F9g03d97r6pnemZ6ZmeX3ZnZ2fnNvKmqV9U9Fd6r1NVVCkRQ5NB13XblypWqiqLUtdlstdFdU1H0aroOVZCXgu4Kiq4ng6KWxdAJeEkcUjT6qfJ6DY1cpCykK8jI1BXlkgLKeR30s4oOabqin1QUOGa3w5G4uLiDeG0akp2uj6DoEFGQawAKsoqKUB2VoC1KdmtN11sitzl6NUFhJaEPGDAuWaAou0CHnaDo2wC0LTExCX9gPFCRFFK4CAqBiIIUANqePbF5NWt21FS4TtGVbph73ZBdWfiGJrDVOq2Avh7N9agla+Lj439FhcmR3hHkg4iC+AC1EJcvX24VFaX2AU3vjTV0D2RTl6jEAtN0BQt9LRb9MsVmWxITE7Mt0sJ4R0RB3KBpWmx2dvaN2McfiH39O5FVQ/hcO1A4IS8vD7KysgG7ZnA1OxtykHJz8yBPs4Ou6RxOURWIUm0QHR0FMbGxEI+UkJAAcXGxEBUVhXpapMV2HKO1ANM9v0yZMj9GWhdXRBQEgYJry8zM7IljiaHovBuFpJzwKThyc3Mh7cwZOJV2Gs2zcPbcOTh3/gKcu3ARLly8BDk5OWDXCldh21QVsMaHCuWSoUL58lCxQjmoVLEiVK6UAlWrVIYqlSqhUkXL0IXCBcyLuZj+GTjwJ2Up9YP+Uq0gWVlZTVAgHkZ6EJ0FbimwpYEjR4/BgSNH4TDSkWPHWSkKqwDXCptNhSopKVC7Zk2oW7sm1KtdG2rXqgGx2AIVAtiy6FOxxfsiOTl5t+SVOpQ6BcFCj7l69epAXdeewuTfgL0Vv/OAFGLv/oOwc89e2L3vABxC5cCuifQNTVCrU6dWTWjSsAE0a9wQGjWoVyCFwe4X9ftWYWvyPg7wvyltXbBSoyCXLl2qGB1tewJAfRqLvbpk54szZ8/Bpq3bYcu2HbB7/34cQ5TsXgeNYZo0qA9tWjaHtq1aQEpKRenjD/QTmH/vYTfyY2xVzklmWCPsFQQHw7Wxlh+lqspITG4ZyfaJ0ziG+PX3TUxHjqNMhCmo8GvVqA6d2rdlqoxjGH+ArfBlbEk+QeukhISEo4IbnghbBcFuVF27rr+MpTlCVZR8R640q/QLKsTaDb/A/kOHJbd0oWG9OtCjS2dUlnaQkBAvud6BipKDivI5dj3/Wb58+UOSHVYIOwXJzMysiqOCMZiwx7HwfCsG9q4PHTkCK1evZeWgGagIAGKio6Fzh3Zw03XdcbBfO18pIUXRNfgYhzuvly1b9pRkhwXCRkHS0tLKlilTZhQOKl9ExfDZlbLb7fD7ps2wbOUqOHD4iOQWA+h5BUaoJKN+3TrQu+eN0L5Na7DZbJLrFZmY4DcyMjImVatW7bLklWiUeAXB2kvFVuM+tE7E1Picqs3JycUu1M+wZMWPcPb8BcktPnTBfv0vf2ymOEpOyUVKhfJwa6+e0KNrZ4iJyadh1vXjGigvJZctOwMrqxL9lL5EKwjWVK0wCe+j9TrBsQZ1nVatXQeLl/0AlzIyJLf40a1TB55e/WLGLMkp+UhOSoTbb+kFN/Tolu9DSU3T1+TlwVMVKyZulawShxKpIJqmxaNyjMMuzCisoaIk2wP0jGIdDroXLF4KFy5dktzAIS42Bj586w34dskymP3NIskND5Qvlwx33nYrdO/SCVQcfHiFDrm6ApMSy5R5DcNdldwSgxKnIOnp6TegQVOMjZjhBdt27ITZ8xfBibQ0yQkOnhr5MFzfvStMxVbku+U/SG74oHrVKnDvgP7QsnlTyfGKvUgjk5KSVgtnyUCJUZAjR47EJ5Ur9zp2cJ/DVsNrvM+cOQszvp4PW1FBQgH0QO7l55/FaGvw4WeTsau3QfqEF1q3aAZDBw2ESpVSJMcCmAm6orydfvHimNq1a5eI1qREKAh2p1rb7dp07FK1kCwP0CrZ77GG/m7ZCshFe6iAlnp8+O+JkJiYiF0+O7z9wf94SjkcER0VBbf3uQX64mCenth7h75Ns9vvr1ChwhbJCFmEtILouq5cunTpKTQmYaPhdQHR/oMHYfJXs+Bk2mnJCS2MGDYEbu11E9tpafsb7/4XtuzYxe5wRPUqVWD40MHQoF5dyfEElm0Wlumo5OTED9AM2Wm+kFWQs2e1pKiojE8xivdIlgdoduqb7xbD0h9XUYZLbuihUf16MH70S9IlFj1OePNt2HvgoOSEH6gX3OemG2HA7bflM9ulz87Ly300JSUlXTJCCiGpIGfPnm1us8XMxcxrIlkeOHbiBHwydRqcOBX6D25pwfA7/3zNZa1TZuZleO1fk8J6rRehetWq8OiD90PN6t7Xh2LltlvT1LtSUpJCY+BoQsgpyPnz5wfoijoVa6BEyXIBtRQ/rl4Lc75ZGFJjjfwwZGB/GHTnHWw3WruLly7Bq/+cBKdOn2F3uILGJvdg+nte14OaFsn1QDpK44MVkpMXSHdIwMcEdmCBQqOgcvwNM3CuCnqiomvgTllXrsBHn02GGV/PK1HKQVj786/S5kS55GQY/fwzUKFcoV9gLBGgspoxZx589PlkyLp6xaNcJSWB3T7v3LlzfyVZkJcGHSGhIBs3boy+cOHC/7B6+X+gg0oVrDudOJkGr//7Hfh9S8l8KHvs5Cl+69Ad9D7G3//vL5BY1q+V+CUav23eCq9PeofL0qqMsfxVRVEnXrhw6WNUEl/TYAFD0DUVM6LsuQsXZmM/va9keWDz1m3w2bSvIAsHtyUZ/W69BR4YfLd0CRgbNRw4dBgmoPBczaK94sIbcbGx8MgD90Gbll5n7bGe1Bfbc3MHV6lSJVOygoKgKkh6enpKdp79W4xEZ8nywNIVK2HuosWkSJJTclGhfDn47xuvO5dmcM0p0kW/O3btgonvfAA5pWDZPc1yDep/O/S5WUx/WwHz5OcYm3pHMN9eDFoX6/TpzGqoHD96Uw5aR/XlzDnw9cLvwkI5COcvXISdu2nFhYBLutDevEljePaJR3jzhXAHpf3rBd/CtFlzuKytgLLRJceurTp9+nQ1yQo4glISOBCrpdhyVmEV0YJkxJ2ys3Pgg0+/gNXrf5ZXhA/WbPhFWDCdrhCMdq1bwpMPP8A1bGnAT+t+hg8/nczbIVnJAsuIGrXq7NmzNcUVgUXAS4GUQwPlR7TWFxxXXL16Fd7/32dh+xCtbEICfPTOG2BTnS8f8cYhLA1kCHPZyp/gi+kzPfUoTEEPU596bCTEx3vZ0ljX9yug35SSknJMcgKCgLYgZ86cqW7X4QcUgvokCO6UefkyvPXfj2APKoeoPMKP7DotwXeb8sW0u+OWm26Aewf2t7xHOBKV+VvvfwiXUQasZAPDNNBB+SHQ3a2AKQgNyDVQl6G1oeC4gpTjbVSOw8cCWkEEFDQ4b49dqCnY76Yn6QQuegkSBCd0GHD7rXBH717SHf44fPQYKslHqCRXJMcVmDuNdEVdRls4SVaxIyAKgi1H4tWc3O/Q2pxkwJ0uX7kC777/MRw7fgJo2Vq40l0o8AcPH4WM9EyYNvtrkTnId4fBIvO+e+6Cntd1t7xfONKxYyfgnQ8+4l1mrGQFQ7XIys77jvYgIFdxo9gVBGvFaLuuzsHEd6IBjzvRwr33PvwEjob5miTapK16tar8kIzw45r1sHvvPrRxqVM+scmQdoMz4v6h0KVDW+kKfxxFJXnvo095Y28rmVEU6Kwotjn0gBmdxYp8t6m4FmChK2lnzv4PE2W5Ipfe4fjg089g30EckHvkQvgQbS794jNPwSdTpsGljHTmUddq/8FDcPMN17m8smooBZvSQRNa7du2hoOHjsCps2dc7h2uRK9IHzpyFDq0bePtld6GyUnJNd58841iXbtVrC3ImTPnXlZAGSGdLtA1Db6Y8RXsxFqU5CBciZZ6P/Pko7Bn/344fPy4i99hbDW/XbrCrfVwMRygF5Ce/dOj0LhBfZd7hDPt3LuXZYRkxRKK8sipU6f/Ll3FgmJTkBNpaYPsmjaBCt+K5i78Fn79Y5OlX7gQlfLD9w3mzaPnydUA7jQH8+HcufOcZyQUxq9hmCx89MHzTz8JdWrUsLxXOBLJyNxF31r6MQGMP3XqzECZRUWOYlGQkydPtlR0dbLi5WnXmvUb+CUnLvswppuu6wY34gB76/ad2J06bBmGDtP5bPpMdEie0/AA8RPi47i7Vq1SZcc9wp2WrlzF+5lZAUVMxdH9lJMnz3lf2HUNKHIFOXjwYDlQouhlp7JWGr93335erh7uqF+nNjw8bAjb53+7mE1v2LhpC2z8YzPaSCLwVxgIh4VB+UdISkqEl557GiqWL8/u0gCSmb37D7jIkpMgUYe8efv3n0+WwYsMRaog48aNU2NjEz7Xda2RVULOX7gAH0+ZGrQDZgKFsmUScLzwGI8/du7eA7v27pc+3kGby9GMnqtKuAHzUJgAFStUgL9iS5JUNiCznUFHnt0OH0+eyjJkJVuIRnEJOZ+h3bLXUlgUqYI8/qen/6IrykAdFCxDV8rNs8P/pnwJGfIBWbhCxV7l048+DJXkuRvzFtLjn/xxBschcxZgX1u6PVsPaQqDhaJalcrwwl+ehIS4gJ44HTRkZGbCJyhDeXbNIVdmwtwfdOLUmb+I0EWDIlOQ48dPtwdN/xeXpAXNW7gIDtFG0RZ+4UR33dEX2rRqyXmyD7sE23butgxnRbQ1Kj0os4KsJdEiDApP1tq1asFzf3qcd2Q33ytc6SDK0LwFCy39JP3r2LHT7UQmXTuKREGOHz+eoCvaNLTGCI4rtmzbBj+uWStd4QvaJG7QgH7Sha3HIt9jD3dQN+LTqdOxjLGgTRBOoRDC5mo2alAf/vzoCH92Xw8L/Lh2HWzZvl26PBCLg/ZptD2tdF8TikRBdMU2EUuxKe0e6E4XL12EqbPmcGGGM6VUrABPP/YIzaqgC7i1/H3LNsuwvmjXvv2wyq0ycaiGNDBjpcVpbdWiGTz+0P38/8QKZ9Iw0V/Oms2bXljJHIZodvzEqX+h5ZpxzQpy6NixXrqmPS2dLqCa8MuvZvMKTXSELcVERcFzTz0OZU3vlc9biK2HRVh/aPrseZCRId40RY7gSxhuB8fkRydDDR9yD69pMu4VrkSLPafNnIVWdFvjqaNHT/aU9kLjmhRk27a0sjZQ/0fVFkXTnWjuesfuPZ4eYUYPDRvMB80YoEWXdL6hVVh/iCYyps2aiw50SgEQvwiT2ykbhkXnYwnuoe2FOEB40/Zde1jGLLzoAQk9H/lk06aT17QbxjUpSFK5vNfQqMcl5UYXzl/wewanJIMeBt584/XSJTAfWw8fNZtf+GndBti1Z5/IT4JxO3Q77mz6D4ciodG3dy+4vU/pWCY/f9F3cPHCRZFwdwKoX7GiRjJaaBRaQQ4dP94e4/AMRcOKvpo3H67kZIOGXfJwpTq1a8KIB+lwKydOnkqDtRt/swxfELJjLn6CA3Y6Lo7yk+DSmhhMp680yabDXf1vhxtRea3uHU50OTsbZsydx6m3JEV55uCxY4We1SrUtAcWlC3zUvo8BZRaGEeegTbTpi1bYfEPK9EWvqBXZ8e++BwkJcoNIOXgfNrMr+Ggxf5XhUF6RibERkdDk4byHTNUECp0tkqTYG49DFBs6EgCOtKa9uQKZ5w+exZqVq0C1SpX9pBFJFXRlTZJSYmfr1q1ypxtfqFQLcjRo8cf0kHpTP/mTlk5OTBnwSJRWmFKlPFPjXwIKqXQWRjkQiCfziahrpF7+Gsh2vLo7LlzaEU3/Q3/IqTbDL7EGQKjpsAj9w+F1s2aSs/wpTkLFkI2bfyAyXYnLKKuIx977CGyFhQFVpCzZ88m4T/+wzImSLSPVTCOOwskBtx2K7Rt3RKTq/OUo1ASBRYsXlLky2io0L+YPgvzlv5HwGk1LBgTp7czAJqqaoMnHxnOy+TDGecvXoIlKHucJVakwT/ozVa0FQgFVpDMK1l/00CvgoT/6Upnz5+H5T+tRpt1HMOBWjZrAncP6McySLU6ESkJrRH6YfU6y2uulWi71d82bWY7g/5cwqp7RTCF4DVhf37sYahTs4bjnuFIK1avgXNYDlayidVW1ctXs1/GYAVCgRRkz9GjNbEgnpNODyz8fkmJ21S6IKDVs0+NFO9/CeVgG5oaHxRaXGmnv5n81RzeetWpCIbF2XqgTVgIjvgJe1xsHDzz+EioWtl5BEO4gXakXPD999LlCSym544cOeLzqHB3FEhBojQYh38Tb9ScZjp27DhsxFqOCiMcKdpmg788NgLKlE0QLA1rJexOaWhevJQOy1f95HFNURK1zrQTIbslKN+FyYaAq0OqDJURQJkyZeC5J0ZCRdpNnhhhSPTaAD2HcpdPzitFj7frJMP+w28F2Xf0aCPsS4zgHLeghUuWikiEKYbdc5d4GEiZzY02ZTo5dfhu6XLIySn+/XSX/LASjmJFJDKd4Mxvio8Bl1Kg+JoYdOTCs6gkSYnhuUyeymMR9mQ4EywIvR/ec/hwA3T5Bb8VRLHDaFAUm8V/8sv123ftRlt4onvnjnDTDT2oHyuEDVsNrpWQQ0+9aRfEQMBu1+Dz6V+J/+aIyPgYMBzsL6xUQmQX8RVMWor/zGOP8NuJ4YhtKIuHjh7l1LoTSnK0TVfHstUP+KUgh1HjFF1/QDpdgf+6ePlyHqiGI9WsXg0eum8wp1MshpNihibRkhU/wJWsLMtri4N27z8AP65Zx1lPQBbGh2PEMNv442Swp+GuUa0aPPXIQziAj7L8n5JO36NMeoOiw7BDh07Wk06f8EtB8jTlRWo9pNMFx0+cwNaDTmylnA8vohr26UdHOA+hRDYpCBcCOq9cycJuD20z7HltcRKtUsjIyHATfulA08E32xniemHT+bXgx4ffD1FRVLSGX3gQtSInTp5EuwUUiLbruc5TVX0gXwXZv39/FVS5h2gi2YqW/0SbtIcfaNn4yAfug8opKShkJGiYSiOh7NZg2Y+reFfIQCPz8hWY/vU8Fn4SdANmG38kw9y9YpAViYxmjRvBiPvu5TchC4OqpoNJQwmU5mU/UuVlLbcY4KGTJ09WRodP5N+CqFFPga7E0au+7nThwiX4fXPInwVfKNx2c08+AclQDJ61IkGTUpedlQ3fY/cqWFjz86+wa6/zrBEGx8+wS9OA2U9qiEiLDm1btYRhdw/kSqGg6N+3Dx/SGYqg50cXL6ZjOj1lFxMbdyUrx/I1DTN8KsiRI0fiMQ//xDWQBa1evwHsfISYeJIcLtSsUUMYcMdtmEasa7ClIMIUSyETRCftZmRS62F9j+Imitvkr2bxYkZ2OMAxFSZHmdyGv+Fj2CTQ0bVTR7jr9r54Z+v/80atWzSH5k3otG5r/2ASTWr8tG69yAMLQtF9Ak3Lt2AN+FSQ7Oy8e/FOlZAop10oLzcX1v/6K0bD/Np8yacKyUl8rjdXpphOTi61HpoYoGMQyMnOge+W/2B5fSDpxMlTsHiZGIxitJyQ8XbA7OY0oFs6ndB56X7fm2+0/C8riouJhtq1amIL1NzSPxRow8ZfwU4PcGW6zaToepWDBw+LvZm8wHcXS1X/RBlpRZu3b+cjC8IJUTYbPIaD1rJlyrBSOGob9KM8NVoTajkvpaeLi4KMhd8v48WMFEGKo4Cwi7gbTGHSL9s4sMmXLwDo26snXN/V65GRLqBBPm2J2qal2KQiFEHT8Ju2eX/1OQ97SGh4hVcF2bV/f2vMta7S6YH1v3ie+13ScXf/O6BeHXozUGSfEBoyeVBHX8jNzYPFy1dw+FAALWacOnMOx43jzPFmLwEZb2EXZPY23OZr7sLuZcc2raXLOxo1FM/bGtSrG9JbD23Ano5XoIzv2LfPq4Z7VRCbJjedppxzo/NYY+09eNDI77Cgjm3bwPXdu2HypEAR4Q+7Ta3J+l82wtkLF12uDTZt2r4Dftu0CW3EkPFnGBZhoo+wcwDhIhgVAdv5F2DIXQOgZdMmxhWW1LiBUBBqRVrhWMQqTCgQHed34cIFdKDLjbAnrUTr6kgMZglLBaFzF7DOvF86PUBrrnQcANEoJxyoeuXKvJQEcwydRPKBIHoTj4jc1JflPr/FPYJN0+fMg6zsLBlnKnunAjDIgeTOY7a8yKwoqqrAA/cOgka0vMbi/4iaNnYeFsZnnluECQXSUFY3/v6HjKknUE2GYdotp+IsFSQxsVwfNCoZTyXdyVFbhQHi4mLh0eHDIBoHnFJcWFAonSxkgsU/v2Imnz4btCO7fYKOmKY9ADi+Boz4M5xpY5N5BLTJQE6eALUMD983BGrXqC45TtBaripYsRigA4JCGb9t3uwhxwbhp/KePftvlUFdYN3FUlXXF61NOHnqFJw6fUa6SjZo3v/+ewZBSsWKLDhOMeFMkxkoWhOaMqSdD0MZK1atgWN0BokodMk1p8oEdDAPw0onOcS10o8QGxsDjz54n8cy+Yb167k8N6lVsyaUTy7yvaOLDCfTTkMakjfoXmTeQ0Gwe5WAg9IBYt2RJ23Ztp0zMhyIzv6jeXwWFmyKxViDnQj6FQJDivLHlq2YyWnIEteGItEzkSlfzUarcJPBIJPcwuUwyeZQEEdgAtr5enFNfEI8K0mFcqgAFA7JGH8YIGXhVkT6hyJt2roVDWu5xkLut2fPnliZHAc8FKRMmeRb0PC6Fpq2fMS/K/FEMy/9bu2NmSObWWSyXT7voDBGaMrAxctWOK4NZdp/6DD8tNZYzEgc+pXpoUQ6eOTEX/Elh6vbAcFILFsWlWQYdr/Lsn/jhp6v8NKexOQXqrR1xw789QJFT7aDjYYWLvBQEF2BgVY3J7pw8RI/nCrpSE5MhOFD72W7EAqhBFSRUELdW5OtO3bC0RNeFr6FIOYu+o53RGFQAih9wiXADpE+thkWBIfk/DDxpL1i+XIw8oGhkBAfjwrSkPnmcDxQD2EcxzLk7UrRbkWKrnucVOWiIJhYGwbrZ3k10q49e9hakkEbPA8feg8/DKREGYUsiB4Ekok+NPtBrQmaoT72cMflK1dh9nxxtiWmhk1OlNMlndLNaUab4SnBvvTlwMK7SqVK/H57OepuSRj5V6lSClSvku/6v6CB4k/ntbDFgjAVt2M6XHTCxbF794H22IJUoorUininvxKO/rf2grp1alFmkFxIE4lbDGKQKbpZ6MUZeujoMXl1ycHPG38Xx0yLZDgh3Zw+djt9HXnhxhMWvor96tauLXgWoN1eQhkkw1ayLUipumv/fpdN5lwURAN7X9pk14p0HADu3bfPkYElkdq2bAbXde1C5cwFzx/pZxS+mag1+R5bD3d+SSCK+7RZX0NeXi67RYoF2M084lqDQ3MwZzi+DM147GIJmydo2YkRh1Ck/QcPoKDTOixrOdfscJtMCsNNQZRb8DaWn1NpafzmXElFFWz+77mzv0gNZhT+CJLpY6f0M1oTOgBnHw56SypOnj4DS35YJV0ITqO00K/MA06zw88J5Eom/ZCL3DrPaolrxAyQo8VF/5YtmrlM/4Ya6F2aU2mnZGo8P5gQmqRywKEgNL2L/l0ojBUdoFNagwR6qnstoLn84YPv5lOYnF0p+jpN/nChI0PaxduCJRuLl/8gdmaUbiNtwmYGZYTMA4dThhNeTLQ2gwbpnhDXJiclQr3atSQvNLH/wCGKriWhrnel1zzQxXAoSFxc2a4K6LEeV0g6eCR4CtLuGlaLUm12T/87ICVFPAyk5JApBuNSWAxCT/6glTai2L0v/8M3Qx20V9RXX88X6Ua3Iw/IE+0ubgdEPggm/RhuHSubWM5TI+/4cg7nRLsQH4cIWRbpcidF0WPT0690QwfD2cWKUntYXyLo8JHgnS/YqGF9qFurpqVfftSjcwdo2awpWkUhGwVL/VBfrcnSldh6sF/JJ3o/+4/NW7kkiUXgdEuItJOfk0cswyQ2EzrF+MMM4oprDWpN072Oi0KPjnjZ8cQg0gUyCA4F0ex6d3MizZSZmQnnLl6kZyRBIaqx+vS6ydLPF9HxBLf26omJpnSQTrimi3KDTPfW5NiJE7Bjz17Le5ZIwvKd+c0CuHoVx5CUTipwR3rJ4QT70pf82C3Bbhx/xOH4w6hcTBWMMyBA86aNwRZts45LCNB5lOUrV65w3C1J011bkFmzZtF+V13QDwN4UvAfDurQ8/oeBXr3ObFsGbhv0EAcv6iYBmfiHcpAH2l3b02Wr/xJ2MMItPvjwu+XCocpbS75IOGwk+nm5zH+4CDyHjIf4+LioInbUpRQAskAVYKULCvSNL0jpgdVSSpI49ata6OrPNmtQAsUFbwyWERILJsIXTu0t/R3J5uiwtCBd/KZgejEVNOXf9gknrfWhA7A2bJjp+V9Szr9tHa92JaTcxThsAhQ3oiv8KBfM1FLThMe7rNXnH/yGgZaaSMIqziECp30UeljOitt376dZxpEFytX83kCT9rp0645FQSiQujd80YPvhX1uel6qFOrlig4KkT6kJVNJ1m1Jj+sWsMtCrLCjui9CBqw66b1ZkxoN8Bcdgpf9mN/2gBbrOUzhzeHMytOfXozU3iFJLFM+0CernYkkxVEUW0+369MO33G6j8CRzLzW7dsDhUrlLcOI4n6v906d0K7LDTkoYV9pcF+hkk8Q1FoOvSPrQU/urkkEZ1+RQdfCiCHM4VsZCendEsvcjHhj3mALsrElcyoXLmi89oQpNP5vLJh6IRQEE1vQTWtJWFtc/bcWQoWVFAB0Hiil9uBmWakoPIMuL0vZgB+ZCsgCk+YlB7KHLbSh/0EkZL88NNaNsMdCxYvg3TamVG6DVCeCCb9cA6hIexE8Ti2MOcZkRlmfqWKFSU3NCE2urCQd0msEwhWEKydm+MPWTwoOzuLnz4GE+Z5dzpRltzuiImJhsED+0NMNA7kKer0kdc47RiQMoDdbLAffS9cvAi/81Ro+ONqVhbMXyTOcad8cUBaieUg6SZLbFy8Z+8TPa0oISEBypZJwBChiYzLl1G2sykBloQ60YzCqRs36tGgQCMcumCCPYmOtsLgwf9gvKlwKleuDC2aNTb78Kdfn1u41uICkqtwHQVmtCb04fTTj2tr8uPadZCn0YmypeND+wrskQ9Cyc1fygwJwSO3IFoFTZUQ+0kvIspazl4iGZpA96pSuRK6Q/dDrylbybwgqLdy5cooVVF20AvHmHIjea7E6+fRGnTC2IhfHKzfdKOLX+d2baEFjj0cCiE9aNxCl3B2GH6GnW8nWpNL6Rnw6++b6ZJSQyTUs79ZBHl2cSoW55mwSOIvW8lCU7cCkuFC0oY/RIbS0CGnjtuFIJFso82aFEhISkqqrCrRSl0SE290CfuqwYboUlHEBbp07ghlsAkn1KpeDW7BbpdINAm/YUry1pqwW5ir121AQbHz/UoT0s6chRU/rnbkB4F+DTLDqSBWMF/lpMqV6BTg0AXJtpXME1EKlOj4Rqqq6LWlpFgSbbMfKqAo0SCaHhje0L0LK8mgfrehAsmHgfQxm5LwB7+YbLKa/fBDu0P+/Hv47NJSUCxDBTlDA1YC5ZXMH8MuSCiIOHJOHDvnyEPhbYlQV5BMkm0jrRZEuqFqdp0O5rTyZ7qMAuTMjOCReFeciNwAvW68AQbd3oefmJPOcxjkY6zZ3whnXM9kak2o3Mm+Zv0vkEPna5vDlSKixYxzsKslco7yS5rSzhYELVJkPyYqD+MeTqVx8sQ15qMjQpGockTDK5FuUNVbTSTHGleuXnVmWJCIYESaGJS4enVqQ5NGjdw9sJCEP3/MpiT8wa9QKErb+o2/05Wlmnbu3Q+btmxjF30oj5y+ADZssW20ZIcrKXM+iqCCBF8oiVAaOuqN7hCqROXvE6gbqgZKZcoUb5+rNBUWbJimeY1Con5iBZ61EollC9ucrQmngEz8cZqS8D7rf93Ie9tGADBv8RLIyhLHTFMukikyFrtX2Ho4+uYy//jhKpWFQXyhIMNaoUIFyyn5UAHJNsbW64d0QwVF99lRzMFMs1rLEkgiaXcUDMYJOVwA5cqXc9iJTBY2edhBpuGmD5lIWVlZsO6X3yz/rzRS+qV0+G7ZCmf+MdGvDjHUvaIyQOKKR5KhNIbikNKYFYc2tE6Ii7X8v1Agkm2fQN1QMVx5I/FWlIt91KADKyEqLoyOI174w8cVJCcnOQoHv6JYySKukH7kkv4y3C84MCclicCJdb9shGMnTjqzj4AmjT8EA0l2T5lkWRBxHhNhKIfSIFWrUgV/QxMk2+Y0eBDqhopJoe3yMLg12bVQmP7ELhZGGH/QbsQNfzEFFbEZN5p4h5JwEIeFTQyCBvrjhwbl67B7FYEraPwwl/f3pXymnMO8w8opNsa8gpfyWNg5bw0y/EwCRkVGA/VQhZBtUxrcSdeSceSllsUGB51eiMIGHUak8ZcLSBYSfsqUTRQbT3PhGAVIJK8gC9uEHxXab5u28N5REXji6PETsAG7ngzMq6goenqucAUjyMhfqnSEojjz3FNpaKAeqsAoYywtZF4SgFoWu1haggjpg0IARgHgL7cU3CIQ4adc+fKi9aCPVBJvrQkdHUddiQi8gzaryMjM5PwUrYfMW/kx562hNIbiOJVGlEMoKwgnwAeRbtBiRY8Nez1gcXFAiaNgUgq0Gx8Cd7OIZ/DJlIoiCK8RN4HNW7dx4QtmhKyIXs1duFi8fcgDdOQRmcM48tb0MRRHKI1QHNo537gm5Ch/xNLkNu2FgxdYUyhM09GqS06T/DggExqNtVzZsmXZybUZWviDpUR2o+Dy8uyw9udI6+EPNm/bAXv3HxRbJaEciEGrG9GHMtZEDr780G4yoQqWbTd5d6NolUJh0jAp1kSrODFoUCkrOwfjQrFBmAtCErlpzl24ySn96BoyZWuyZccuuOBj/U2EXOnbpSv4EB2Rn+LhnyNv0e0YkDt4zryXDn5HR0dBtLp/sIlkG2PplUg3+H0QX4jGGiTYoOUQlNmc+eg2CkAYgk/TvTYbJcfgYyZQa0Ju/NDxaWvD8ODR4gStdXPko4OcS0vEOMOsOMJtVpqYmFgoY7nRXPDhj2zTcxA7ZYI34o3CMGAwyW7sL4vkUmMZHywUClguuZyINKkFh0GnDE/b+NDxDe73jpB3ql+3jhR+Iz9JQQzZMCuNU3FEOKcdQ/J7IVb3Dza5ri+zJDutxfL5JDAuNkbagods6mJxhPHHoRSiIEgB8IsmQHmjm0UMDMNh0aACjMxcFRy03k0Iu8xrJrubMhh5TOVj3dqE6kxWfrKNactVMXm0mxg5LSmBNioO8ifLWDPDhWEoBdodtRmRDrFxsRAbH4ch0Y1h2ANbE3pz7sz58+IekY/fnwaoICJzRZ4zodtQFqEkRHY3twhnKE0KVVwh+CHZxhj6oizqtF/mPPBCCfEJaHG/LrAklgRgAWCEjEwXhMlkwkKhgGgvX05s78WXopsKbS21HsyIkL9E44aKKSlg55YAqxkjr42Khwnz3UNpnHajtalYsYLjvqFEJNuOpFgQ4jKOQZQMsnsjmj61vDqAxApiOCleaDGUgk0qFFlQxslHHAZN2pX+9Jmz8uII+Uu0FzL108ku8lhWUEhCacguFYcsaApyLQ+6lmaynP6hQ/xogJLojVA3VEzgJZEQa6IdDYONHB6DUHyoVhKEP7IQKIRMEjrovYWkJBFnumbdr3LZRAQFQl3sXrHwmz/mvCdCpTEUh5TGW2tDXaxQBMm2kCtrIt2gQTp1zlm+rIhXy1p7BYyuyjf+8MehFOw2Qhh+5MKfcuXKsT8dYXAi7bTjPhHyn2hnSuoe0fnwZIquk8h7K8VhD/Y3lMapOOXL+97sL1iUTOe6W3k4SD+v6gqcMe987U5JScmg0NtkVtcHiPLy8jCulPkmrqNAiMgq7Fg8kFCmDM9xR94WLByBovAMlhh0y+4UK4swzeTIdzLNH+YLxaGn8cbx0aFCJNOkIO7y7kZnVAycZnkHSfS0kY5NpoQGi3L5rT+nmzOfONJOSkEFxIWERGHpuDhamUrhI1QwKo9dVDoFmARcKIFBzileoTTYQmALYyiOZ2sjywQ/3M2S9w8FKodppJ06hSBZEyY5jbpYJyz8XIgXnAURjk0V0C7SZ8p8g9CPFimLGAPUqF4tJNaRlURw94rylAUdFYOUhOyGm/KeeG6KI/hmZRF2Ih6ohxAqVsj/fXlQ9BOqatePKZgAXxTsl16ycsSTdC4Ao4DIzb7OJAm3cFVEpW7auKFgRFAg0MFDJPiUx9xKkKCzG/NeKglanIrDZSMUwak0Tjfdg9bKhRJIpq1k3UxRunJURdE77BQxa6LtPq34gSI7RpZrIqkUxq9hox92kUlhOKwG13XzeiZphHxQ7Zo1RD5KQaeHrcItFUUqjUNxSEmIKDzmvVNxhB+VXUVj/4AQIX9kOk+BQ9iCRB1CwaPke/1UrVKZuy/BItCoCTe/HikMdrGJH3NhCSa0a90KysTHWd4zQtZkUxWoXaMGZjnlpSHgQsgNJTGUxqk4GE7mvVAaURYOpUEiBbH6v2BRtapV8Nf7B9OgxUfp+9Trr293Ft0ZLFNeKCWlkhjQBAnUgvDWoBQfdAvCDxeGq1IQyEoFSku1u3RsL5gR+IXKKRV5BpAFm/KVlASVxTAdisMDc0HuimO4jbIhoqneUAFt9kEyTXLijVCWLnTo0CFdpddBMDk7xKXWoAyrik1SsEAFkkeFhHZHocmCcSqFwRcFRKkks3uXTiJABH6hFrUemG+iC4X5SUJuCDopDRHZKZ+ZsHX3o7Wh89NDZdKEuldUefoCxnwv6YZoFnRlhzNB1lSjRk3MIExqkIjeJRcFRPHhWAs7F4y5QAwS/lTgNapV87hfhKypFo4/DKUg4TaE3i7t3IWiPDf5+dPaxMTEQDx2dzFY0KlGdWOM5Z1IJ0jGWEE0sNO+kz5Ru5DnlBcVicNOMCJopwR4Uwr64cIiBzMAenTtLOwRypdq16juyD/HWII+hp0UQyqHaGH8b20qVQiN99NZlvOBoROsIDgu28yZ4ONTp1ZtCho0XL16VdRGmECnQlDMEGTKQiVChsunU4e2+TapEWBXGvOID71hwRYk8tZwG0ojiD6GUri0NlRObJJb+JO7Ag7Ugw3q5tWtU0dKhvcP6QSFZwXJiVI2o2BhmtHLCyViHzKYCbyanSMKSxLbMdMNxXBRCvJjk4KJ48DatuIj5yLwgWo0W6moDkEXJIRb5LtTadDCdqMMhNKgW34cSkOE/qQ05f2QnxrVqvKMV3GhYvnycoMPSo9XssfagN+wYwXp3aXLOV1XDpsXoVhRg/oNMOloDQLl8XostFMCZIGRj/hIPn0oDJvSjX7E7N6lI9sj5J1qVq/GQq/Z5ZNxspPwO0yDnG5WGiLkUT4LpSFCf3SbW5vytIjU4n+JaCJo+NB7YdSf/wTn+Gg063DXSvXq1UOLtXwbhLpwoGvXrukYXCgIQdG1deiLNu/UsH59NNAeBMqVS97ZjXExfs0f8pM2Ec5BAE0aNoQK9K6ICz9CZqLlOUL4ScDluitSFjMxT4QRJBTFrDhcOZmUBi1s95b/ndq2gU/fexuGDxsKn385A1meYYqKWIZZQrwT6sIvaGE4FAS9UEF8o17detiXt0lXYJGVY7FVPaeHTHKRFX8dJNwGAVYO3Tp14HtFYI1aOEDnLhERtwDCTvlHwi+E3kJxWDHkNQ7TIKdfOVpebkKlihVg3EujYOL4caycG375Fbbs2Cl9ix40Dq1PLUg+QGlx6IJDQVRNX405YBIwT4qNiYZ6derKKwIL2vqH1EBERQo+u01xRDj8zIQf+tJDw8gCRmvQUQXlkpMcgm0MtJnMSiPdRt6S8JPSUAvhojSG4nBrI8IlJSbi4FfhB3X3DugPX3z4Htx4/XX8/+T/v8lfsr24UB8H57T0HiPuk1gXJBwKsnLlku3Yb8SxiOU1DmrWpAnJWsApz3gnhD7mCBHYKvgOYiZ+sXCMMUvFCuWhccP6xI6QG9HSC7KIbpEgFnxWDCHkxrSu0y6JFIDCy7xnpZHXCyURCkNve3Zs1xY+fPsN+NNjj0C8ab+sJct/gINHjnrEqyipaZOmGC+0+yBM39kbb+zmeOzhUJDU1FQNq9cfpNMrmjZuwrWA5d2LkWjJu8NNYKsoEDOJ3EC7VApiGB9kiW4Wh4uQmaqjgthRiEnw+R0PEnpJopIxKY2V4hgm8dlPXk/X4P1t2DWvW68u/PO1Vzy6OXSy1WdfTveIU1ESKSdV7vlBAWUlPUGXTqeCEHAAv0xavaJMmTJQv27gu1m0NxbKOKYVC8udhIcoSOZRUPFBFvO4oNFs1aI5JMT7OtK4dIKmeIWgCyURpqj5yTQUxxB8Z8vsvbUxlIz2523dqhWfm26FuQsWwtlz56WreFAPu1c03Z8fMAkuOuCiIGDTlmITg+kmwfJOrVq0lBcEDmJnEyHkTPhBi6mgKJTg8wcZhlKQn3EdDdQ6tmvD94zACWpBhIBTvpEyiPxzKoYgVhrmSUXy0dqUSYiDllgh1a9f3+uD2kvp6TB99lzpKj6QzFrJshtpKiiL5SUMFwXp1aPHYZSl7dLpFU2xqfJnX9OiBI9B8MNfoyDclAJZzoKicPhjRZEVvq5IKlsWW9V4mXfUGlC3SCiCsAu+UBajdSCFsW5taCKkDvYyWrduDYn0urYPTJs5Gy5fuSJdxQM646R5s6bS5R2Yzm09e3Y9Jp0M1xYEgRky3yxMVkQLz1o0a+aufcVKdBqtUArSCjQtlcKVOD0OO2sMU83q1fmJrdX/lEaqWqWSsKOwU14Ju8g3B98g2kWRTVIM4cdKIxUnpWIKdOzYAWpgHuc3Y3gqLQ3mLVrsiEdxUbOmTbEFoyX8rvJhQQtk1BzwVBDQ50urT3Ro207aAgPen1d+SCkoQfkpBbsdxF5sEEVaESd4BkvCnHck/A4iN/NMJvINpYmPj4U2rVtB8+bNuAL1B59M/lLs3F/M8FdWFVXx6Ot5KMi6Vdf9gQk/ZM4oK6pRo0ZA3xHJldO8TqVwFibBsAs3ewoSLiYsSixcKmwN2rVtxfPxEeD4w4+TaM35aygN5zW2ErR8o0vnzgV673zvvv2wfJXjcUOxgU7ZJVk1x9+KUCb233Jj903yMgc8FCQ1VcGUK19Jp0907hi4l5HEcxDXgjITqwCZTPx1KAX5G9ONBujsi9Ytm0tX6QV1g8wtSEFAe+5279aVp20L+sbpR59PdimP4kLnDh2lLR9o+mzz9K4By1QpWt50Q/B8UasWLaBMXBwfyl7cZGz9QzD+X2iCQfy1VAr6OEDhiIctUZf27Sz/qzRRxXLJPIgtCOLisDvVpjW0b9fO5WGfv9j4+x9ImyzjU5REG3C3RBk15MUX5WnadBk9F1gqSJ8+N23FyzyaG3fQ1F2njoFZJUsH3NPUIiUGfyShh/RnQp6lUiCYJ7tnhlfDBvV5s2vH9aWQaHrXX/DsVJ3a3GpUKWT3OiMjA/7z0SeWcSlq6tShg9fpZTNQJjbdgTIvnS7w2i7quvYFC1U+1LF9h4BM+dKDpPc+/pQ3/OKpQ3qYj3xqLUgpWDGY4wTHkZQCyc2LoaoKdOlQugfr1atWlTbfoP2Ou3bpBI0bNZRn+1lkaD64fPkyvDjmVd4zubhBEwWdsHvlLq+WBNoX8jIPeFWQOJs+Tdc06teQpHklmj/vGKAZLTp19R9vvsV7qtaqVZv3e/UARcuHUrijcwfsZuUzHRnOqF7NdwtCi/toZqpTx/biKAwDVP4FwNWsLHjplddg5569klO86NCmLcRj999dXj1Ju6rkZU2Vl3nAq4L07NnzLBqz8RYsZ76oa5cu/LpmILBt5y6Y8K9J/MeVUirxNpnJSUm0hkYoBiW6AKC33BpjV6s0gsqsMuahFajSqFGjOnTr1gWVyLqV8TevaYp+9KsTYGsxLmU3g3o03bp29ZBTS9Jhbt++fb2uc/GqIATFprxvfVdXKlumLHa12qM1MJ+NmzbDG++8C/QEl/qY9HCqNrYo9L5BYfbvomci5vuXlk+llAryZGBXUMvcEVvWZk2dKyaslYHu4hu0RGjshH/Axs2b5b8W/6dju3ZQJqGMi4x6JTv8F3+9wqc03XrzDeuxb/+H9Z1dqTtqLJ0aGiis2fALvPP+R/K5iNiFvkLFitj1qsX95YIoSsvmTUvlAkb38QdVNjTG6NSxAyRhq0wla4a7m4FjP2+gzf5S//kv2LAxcIcYxaEM9ujaDW1O2fRGqPQbb7vtpvXo8ArfLYii6Ng7/zcJYH4UH5cAPbp0lVcGBvSg6ePPJrOdag4CK0r58gVSFKolO7YtfQsYzTNYtJlaly6doQYdvWaMyahgzXB3Sxh5bwY9SPzHG/+Gn9ZtkJzAoDvKYFxcvItseiP8fYcv8oF8padyxcSZuqIfpVmj/IgeHAb6LJGF3y+BqTPkc02Dj6B3VmiTgJo1avBUbn6KwktPTPctDVQDWxDe8aVta2jRorlYIkJeMk8IFNQMy66WG4+U419vvQPLf1wl/AJE5bDV69Kps6VsehDAkaOHEmeyzQfyVZCOHTvmYnqxFeEmySdRE92r582cwYGkmfO+ga+RDJjjRLUhDeJp8Vy55HJgU62Xl5A/vRdtdf9wJDogpwOOMzp36ij3zSWugNNGcHV5A+W1Yb79/ofw7bIVjv8KFPW6qaeYgjaVvzey6/pbTzzRMd+FYPn3PxBX0+ETjMAZ9whZUbOmzaBu7TpoCywmfzULvlu6zJEBBGHqWKORS+FpyqpYa9I0MWWkO0rLpg5dUDE+ePtNqFu3Di3Qk1wTMNtEDgoY+WnA3S2A+Y6f9z/5DOYt+k7yAgfaDK4pyp4ocd+Ew9bTek7Gx2jNF34pyODBPTN1TX/T8t8sqG/vPpYCWJygQvsQxyMrfxIL4Gg5NkVGKIfwlzauPStXqsQtizme7du0Cdh0dTBAO7e/+rcX4PVxY6Ca5dStkUeUX9Ii4eb0cBM++WIKfPX1POkKHGjR6W29bxWR8ov0SXfeeadfL6H4pSCEsnE85XtaOn2Cpl15wE65HECipdfvfvgxbx9DLFfloJZFMMhN9SYtWKSThgxFSUiIh9YtmjnuFy4UZVN5F5FP//suXNedZniIjX4OmFsRJ19mn4BLeISbe+qMmTBlxizBDzDRwJxWWPgDlIJTem7me9KZL/yu5idPnpwz9IGH6DTN2wTHN2hwvGvPHrh8tXjfFnMHvauw4dff+OGfsV7IqSBkMsNhJ5PGTqQcND6hGa0NG39nv3BAq2ZN4bXRL8MtN98k1iWhLjjVQcExmrS6wMTMJzyN8Wbj+O+DT78wqVbgQBXcgP53Omfe8gHGcfSd/fqukc58UaB+0IP3D9mk67b7MVvyPQ1FVVSoXrUabN621SmYAQLNoqxHJWnZrAlv9UOwUg5SJs4y+kWDWhEaqNMGBifT0iA9I4P9SiJoj6unHxvJ2+vQbB7BIUQmofcuWJ5hCe7hF3y7GN76wK/ufJGDZiaHDLoXkhKTJMc3sIgPZGWeHTF79mw6rswveMsdr1jw7Q9DsGPm1/sihJ/W/ASr162VrsCCWoXUl//KO1qwBiBIOVgt3JSD+W5Ey7K/+e57OHTU5TXlkAYtwOzb62Z4ZPiDjrVqVMhc0ChQRoE7dAUrMqfMk0XkibyCQf5OF7mF6/tlK+D/vfUu51UwcH33HnDDdTdIV/7Q7fqQAf16YT/Qf5jT7RcwM5QFi1eswca2u2T5BL3EP2XaVDhx8qTkBBa0m9/40X8TU7gk+MgTBUpKwEEE34LYD1ujzdu2wzdYU+4/dJh5oYoG9erCX558DJo0aQz8iBcF2RB+HmyyWzLIW9j4UH3D7gon12WyC++xctVqeG3im9xaBwM1qlWH4fc/6NeDYIIG+toBt/W6HtNfIG22zpd8MP/bpR3x0p/xz/yK3YULF+CzyZ/zxgvBAD1ZHz/6Jd6XSYo9KgBbWBGMQnZXDgokumFk1WD7jl2wYPES2LP/APNCBfSwj3ZG73/7bdxNZN2gH4QxjUu/bLNoRcjCmwEKB5JZhiQfDaOw16z/GV55/Z/8fk4wQEuaRj40gldK+AVdz8N86HLnbbcUeHBp5EqB8c2iZR/g5U9KZ77YuXsnzF3gfJgXaFSplIKD1Zd49S7JvKEEpByG3aEcZJrdUmCM9+H37N3HirJrzz4XUQo0qDW4oXtXePyRh/h9cD7BVdZZDiXBMIbsGwJOLYaw8FdYXbpaZjiZ5P8rju1eTn2d9wgIFgbdORCaNcl/Gx8DWEYfDOx3y1PSWSBYZok/WLRodflcyNqFheT3q2XLli+DX38P3MI1d9SqUQ3G4ZiEnoMYwi8UwKQMZJrd6BJsk7+k/QcPwaIly2D7zt0BV5Sa1aviAHwktG3TSigCthQqx8LUjZLF69GKsNLIMGgYvjR+ESDTnCLB37RlC7w0NhV7AsW/E4k30FuCvXv1lq78geWUBmWimt7Vs+dFySoQjBwpFOYvXD4US2eGl6rHA7Sx2PSZM+DoseJ/o8wbaIfvv7/4PB8oaQg6EcNws5V/iSV4wsImdbuEP4eAw4ePwOKlK3jrfoNfXKD3x+8dNADuHjAAomPkm5yY/aQkpAjUihCDFMCqFSGDrQUcsG/HtL04+hV+8SlYqF2zFtw35D5QTQ93fYLKSYGhd93RO981V97gyI7CYu6iZQvwJv2lM19cuXIZvpg6GdLT+QCfoKBJo4bw0v89w888HAKNpjHtK1jC5PEJWoxwhnLwh3iST/bjx0/C4uUreFBP3bGiBu2M/sTIEVC1ahVRcCapdyoCPQQVCkKwUhLuYLFbMshb2CwH7Lv37IVRL48t9h0QfSE5KRkeevAhHm8VAAvu6td7gLQXCu55UWDMX7q0up6tbMM7+X1S/OnTp2HqdNo0LDiDdkLrFs3h/55+kpcpkCiz0LOwC8E2xhukAOxnCsMf6UcQfKc/7Ri4ZMVK+H3L1iJRFDpo5rGHh0O3Lp3RJQWdBJw8zUJOiuDW1XIoCHHcu1p+DNgPHDwAz/11NKRnZkpe4EGrjB8c9gBUruT/RhFYDuf1HHvLu+++7ZqmT42cuCbMXbT0Pqy4LLdN8Yb9B/bDnPlzRQ0dJHTCGvnpxx7hWpMFngXfKejkMOyO2SyTcgg/EZ79yC0H/URnzp6DZT/+BL9t3lKoGR968t2/bx8Ycs8g8UIXdYHYx4eSSD/BcVMSCi88/BqwHzl6DJ7968tw4eIl6RN40DTuPQMH8fmYBYGuwbBBA/rMkM5Cw8iTa8bchUun4c2GSadf2LRlM3y3xGUz7YDjuq5d4NGHHmCBMISdBV6a7uMNs5+wGnZJrCAc3BH+3Pnz8MOqNfDrps28AZ4/aNG0CXenateqxYVE8SNhF90iKejkpsDsIBO/pAhurYiAMP0dsJ88dQqeefFvxX4sgS9QvG7v0xfatC7gy2w6TLvrzj4PSNc1ociW3N79yPAVah4MQYnwu6tVtUoViFJtcOhI8B7AHTl2HDKx+0DnhpAwk3SzifA13hBO6U/kaDk4CF9jTCHHx8VC8yaN+K1FaklOpZ322nImJyXCEw8/BI8MfwCSk5NchFeQVAr8ZdNwm4Wc4sB8ERm6BzcgHBJ/ZVACW417CCuknT6D3aq/cwsYTNx0/Q3Qsb2fOyNKYL4fjIuy9582bVq2ZF0TTFl17Zi/aEkXu11fjQVSoI2yVq5aCet/dRwsGhT0u7U33N3/DiHk6HYIPn1I6okcfJM/kUk58NfFj5iGnRUOxyS0xmv1+g3wyx+bHQ9PqSvR+6Yb4IEhg6Fs2TLIQaHlWSksIkOA8YfHB+wWRSfCkEW4yeHsThV8wE6tHSnHsSCtfDDQrVMX6HnjTdLlHzB7sxVVv2FQ/75FJkxF1oIQvpr+5fEhwx6kDqtfK34N1K1TF7KysuDEqeAVCj0dj8YBe8P69Qo13mA/Gd7ROmBHmPhCMWhzO7pO472mGtarhy1KaxZ42r7zhb88BX169YLYWGMbUBJtNqQphZrcBg9/HX7SZJA/RZP5Ir6sAPwVYQyFILAN3ZcuXYLnXx4LR48fZ36w0Kl9B7j5pp4cpwJBh1F3D+hbpKfxFDAG+QMFRPl6wffT8cZDJcsvkCAt/2E5bPwjiEvNsUDuxwHxTdf3cAg7RcyhAA67JFYQcSm6mOddOYQ/MY3raYBcqVIlKE9PwfG/SVlYgB2lgi4SEvoaA3T84WGE3wN2+qVICru3ViQjIxOe//sYfvgZTJBy9Lq5F0W/QECxm3HPwL4FGgP7A2Myo8iAhaAnxqmPogBsliy/QIV1y823QJcA7hjvARTa6XPmwnp64YoE3SHMZHUKNiuGm3KQYgjloMCitTB4RteKyFCUxKQkqN+gPiqHc8jG9xYWdhMkh3nCT3qbwngFhZVWA9yyEEzXZ16+DC+98mrQlaNrp84oAwVXDsSmGDXnUWkvUhQiLv5h3rzFdfNA+wVrOuut+3xg3fp1sHrdGr9koDhAJ6I+/vAD0KYVncVIAk3yJARbKIbksZ+TiGnYDaUgkxSGDfyhp9+Vq1SBMjjOcGa+sInaXtT0Ru1OfmxnnqjPyC3Ij1YEWwtfT9izs7Pgb2NTA7broRUoTjf06AHduvq1QNwVup6m2LUu99zTr1hmemROFg9mz/u+O4rICrQWeFe2TZs3wdIVy1mogoGoKBs8NXIENGvSiOPgVAwip3J471JR2RmtEPpjTlNXinYQYYElYSYSVyOEm0Avm7FASzf7FcOAPSc7F8akToA/tlhubB4Q0OREn163FHwql6FnYT71uveufusko8ghc7L4MHPet0OwWOghYoG7c/v274MFixbx9pXBQAzW9n95/BGoV7eOVBDBd1UO1gT2I+UgnqFIgq/z8oiUypUd23gauW68yyCc8lcKvFAgZiGkXfqxKQwkyXMJI0wGhSFtQOUxPxvJycuFV8f/E3757Q8RLgig/LizXz9o2KCh5BQE2D7bYdiQe+4o9DorfyBzsXgxc+63z2OZTJLOAiEtLQ2+njcPMoK01IF2CH/miUd43ywCKYehBIZycGvBrQb60liDPmjSk/CUSinYnbLYhZ4Elz5Grc9wCndxDtjpWOcJEyfxex3BAh1hcffAgVDFj+Pf3EHZDKo+asjAfm9JVrFB5mDxY+bXiyZiCf1VOguEy5czYd433wTtrcQyZRLg2SdGQuXKlVgxzK0Dkft4g7I1uVwy7xXMQu0N6EXdKTKdoQxBRptLV4v4zCSbNIUXhxee7Db8hINM/MpWhA78nzjpXVj5k9/7FhQ5qmNlc9edAzBf6XlPwYG5PXHooH5/k85iRZE+B/GF2TOnrdi+a29VTF7BHo0i+Njp5s3hypUrcOp0Ghd4IIlOYt26Yxe0at5UnjnhfbxB+8JWrV6Na0ifykFgb3rJSQo0Q9ocwi2FnmEIPrENf4OMeziVwzAZZGBE//3eB7D8x5+EOwjUtk1rGIDdqsJudI5Z/OHQu/s9L53FjiKf5vUGLFB9x+ZfnsIETibhKiipqg363NIb7rj1VojGATTX1AGki5cuwvuffs4P00ghePrW6FahP818VcLuQvWaNcQet/6A0kYG3UNwEGabtFMGCIvJavhJq+kejjAm0H/896OPYcnyFeiwTmNxUgyW2R239sUBeW8uS4pjQQmze/LOLb8+TckRqSp+kF4HFLNmzbLZ1fgvUGEKvZjs/PlzsODbRXD6jF/72BUp6NXdp0Y+zE+/xVJ2nY8KoO6UvxsIuECWQHEO2CmWn3w+GeZ8sxBtgQctU7/zjv4FOibaHdhDnLJr8x0j+BTmAILyL+AQSpLwP7SOEJyCgxb9rV7zE2z84zesXQJWoTBqYhfqseEPoGIk4iC80rWfi2IItxRoAWlH3rUO2KdMmwHTZ3/N3ECC4kiLDa/vcf21bkX72a6tdzwWaOUgiLwMAlColRlzvn0X8/DPklUo0Ou73y/9Hi5gFyiQoM3l6tct6k26DdE2weEgFaGKwOTLVqfbzcm4cuUqn8gVaNBmdX1794VaNWtJTmGh/wfHHM+isgW2FpRwy86AQ5k+e+GrmAljRZVYONBzkjVr18Dvm/7gcUEEwQN1FTu0awfXdb8OooznPoUAVqA6SkTqsHvuTJWsoCDYCsKYPnvBk1g9vIeRuaZ2mJ6ZLFuxHE6mnZKcCAKJalWrQu9et0CVygV/tuGGPOw1//n+wXd+JN1BQ0goCOHL2d/0Q2MGdiQsnqr5DxqPbN22FdasW8vTwhEUP2ilAG0D2qplK5SoaxQpHTIUXbtv2JCB30pOUBEyCkL46uuFbex52gLM5NqSVWjk5GTD+p9/ht83/+H3a64RFAx0lkr7tu2ga+cuEBNTBAe46vphu64OGD60f+AHTV4QUgpCmPL115VtedFzMGbXS9Y1ISMjA9auXws7du6IjE+KCDTOaNGsOXTv1oMfiBYFsOVfrUXl3TP87rsDP3fvAyGnIIRZs2bF5OhxbwJof772Nlvg4sULsOHnDbBz966IohQS9DC0adOm2GJ0hXLl/N56wCf40aei/OfKhVMvPPHEE8HbstELQlJBDHw5c94QTYePcVzi3wEQfiA9/RJs/G0jbMcWJVirhEsaaNVti2YtoGOHjvxQtKiAypGu6vD4A/fdVawrcq8FIa0ghCkzv2moaPpXGNMiPWGT3oHfsmUzbN66BdIzS+5BOcWJpLKJ/J5G61atIY7WoBUp9I26ot43fMiAfZIRkgh5BSFQl+uqPWq8oqujsMNVpAssNV2D/QcOwJZtW+DwkcOlvvtF4ws6pZiUon69+mK1cRECO1R2FLo3mzWuOZaOGJfskEWJUBADk2ctuA40++fY5SrMGzb5gvbHosH8zl074ey5s5JbOkBnpzRr0gya4eCbjssuDuBAfB/WSCMeun9Q8NbaFxAlSkEICxYsSLiQaf8HRv3PRd2amHEOFWT33j2wd9/esFUWUoqGDRpBk0ZNoGJF/06JLQy41VDgP1fT1dFPPOHf8cuhghKnIAamTJ/fRVe0DzEJbSWr2EBL3A8eOgCHDh2CY8ePB3XT7WsBLcOn04dpH7J6detDcnKy9Ck+YKuxCauxJx4eMii4OwMWEiVWQQjjxo2Lqt+k7Z+xGMZhUvw8j+vaQGOWUydPwtHjx+A40qm0U+LMDKwmQwpYZdPLXVWrVoMa1WtArRo1oWq1akU+pvAO/aKuwKsJtrz3Bg8eHJyz2ooAJVpBDEyZ8nVlzQbU7XoYC6bYul1WoKUtdNYJKcqZM6e5O3bu3HnIyEjnl6kCAVoOn5iYhN2kCpBSsRJvRkfrohITk4voKZL/oO4U/n5u05TRw4eH1kO/wiAsFMTAF9NntwZdmYjJ6itZQQMtbyHFoe5ZOioLTQBcvnwZrly9gi3OVcjGVode5bXn2UHTkFCySNkItLCZhJ7evLNF2Xir0ti4eG4REuIT+F1uGkjT+eDUTaJnE7RBRDCBMcfo60tUVX/p4WH3bpHsEo+wUhADn0+dfZOuqhMwcT0kK+Th3tgEuua/JuiwRlOUMSPvH7RKcsIGYakgEspnU2beAortFRS26yQvgqLFak2B10bef89y6Q47hLOCOPDZ1NnXY1Jpy6HbMcUB26giLCG2b/lOV6MmYotRYp5nFBalQkEMfDJ1fhMVcp/FLgEdKVU0y1BLCXB8kYHiMlVX7O8++uCQ3ZId9ihVCmLgk/nzE/WLeQ8pKjyGztaCG4EldNisKPr/9JzoKY8+OrDULVorlQpixv+mzesAefYRmBODMTMKvBN9WELXaXp2FrYaXzz28ODfBLN0otQriIGVK1dGHTh+trdmh8G6ovdXQCm+tRehibPYWizSdJh14mDKstTUnpHXMBERBbHAuHEro2o0OH+DAtqdWJ3eruvQULmGXVdCEfTQAo19aPsOpWDB8f07fkpNTY0ohRsiCuIHPp4ys56uKX0U0Htiht2A2VZNepUooEacwN/Vimr7QQf7sseHDzkovSLwgoiCFAIffjGjQZSudgcVOuu60lEHvQV2yUJqVgzjlIFx2o4NxUZUjF90RVv35MP37ZfeEfiJiIIUAWgr1XOZufVVxdZaUdRm2NI0pm4Z5m49lNQU7J0VyzoQFP48/A8aOxxEk7pLe/B/d6o2ZXNynHKwJC8SDBVEFKSY8fnnK+Ny1DOVVU2rBbqtCqh6Cgp0BV3Rk9Esi8qTALoSpSmajU9JQ+ioYaqu2jFMHmrBFeRmKrpyCc3zoClnQbGnaap6NEa7fHrEiBFZ/EcRRBBBBBFEEEEEEUQQQQQRRBBBBBFEEEEEEUQQQQQRRBBBBBFEEEEEEUQQQQQRRBBBBBFEEEEEEUQQQWlBkb8PMm7Cv9pqoE7EG9eSLAd0XcnNTICuSenpdj06aTxybkO2y8tEug65igJzldyM8ampqdqY195qpqj2N/F+9WQQBzCsvUx04nVXr564rEUlvYKsAYqiRwtfB/J0BRapORmv0DvXo8f/q4ENbJNA0RtLfw/oduXp8eNGrZROrxib+kYnxab+A6+oIVkmKFlKbnpHLTrxE4x7V8l0Rw6Gm5k6+vl/jpkwqaYKyvcYf59loihRQ1NHP7fllfFvPq0DPIJ5FS+9DGigK2uvxuS98MZLL2WMnTBplQK6z91aFFD+mTpm1JSxr7/ZG699BcNbbFih7FVUGJX691H78L/fwYt6Sw8XUBljGha0bFz7VX9e2MJ7zcV7NZVOV+jKVfz54rWxL/zn5dffaBmtK7Okjyd05YgWBS9NeHlUkR4hXaQKMmnSpPiLV/SDiqJUkSwPKLlqeT3a/izaXpUsa2j6cy2b1n5v256je9HloRwG8kCpbtO1+/A/J0mWJXRdG6vmZf4DFWkrClVzybaGrg/DQpkhXZZ4ceLExPicKHqTz+vuJzs3b4hq1rrrWgzTRbKsocPjiqqt13V1q+R4haJrvTTFlohCPF+yrKEDCtaoEWMnvHkJFcDnyZtY0YxVo21TtNy8PZiPXg88x3A7XhvzfMtxE/69GNN0q2R7w19fGzPqDWn3ilcmTKIzChsIlzUURbsb1f6srqg+9/6ld+7V3Fr1UlMHF9kBLkWqIGNem9RKVUHs7K3rX2qKfoTtElhD5mDL8DrWqkuw0G7GDN+jK9oc6c17gmIN9AAWUm20fG0H/UWboh4QvjBLA83lwEe8X17FxOh/nEvPnYm5OEDX9UO6ok+X3gwV1HvRaIS0NE6NGZal5RjHRc3H++2QdgcUepfPBl9QTSlZlhg3YVJnLJCfya6D/jnSSfaQUDUl67VXXpjwyvhJ66WC/Ir/t0z4crxI4B5GZa2O8f5SVfWJhoIg/xPMF4+jAyhudkX5L175AubV8/jHF/B/P8Q0Y1QEsAG6BfOvM97zwPixLzQYO/7NF9Cfz2zGPG+P1Bf/IRubGa5QFAXTq8MCDVt8FAZRFrr+Npad4yQoVVeaYcC7yM4VXJRGh6qiguhb8T4LOZAE/v9Q/P/6GKNF48eO6i/ZXjF2wr+fxI6AR28D74NRhSfwpwIm7h1V1+Y6FETX38X4ZbIdgfGrjfF7gOyoTK1SR7+4jT2KAEX6rrRNVW06qjpBUaMmThj9nGVEsdkX++Mq+uoJY14czXYJbHKboFEbCcPEIImdaHS7/e0J4/66nh1uwPvZpKb/4nm/SdUxoxuhMNkydE01+l8oNO9PGP2iQ2ALCs1utyk2cRRJjK6njh374mF2eIOur58w1iNubdCojiTyQwKz8T+po0d5PUIA8wjrBkyxAgfGj3nh75LNGDv+DeyWKJ1J8smNSvImeyBIGDEifVHgsj3yacKkOmSin6bmZYyagN1b9kCMfX1ST0UHVpDs2Ku2GLtsZHT4wz1NqJB10ahP2iw4vjF+zPMfSqsHME43o9EF9d/lzBclxj5xwksvnZBOGPf62y113c4KYrdj9VaE8CsREURQWhFRkAgi8IFSqyCqphbp+KtwEN0QBdSL7AwH4ACEDYBrThOOo/heuqpcYEYQUKoUJCZHy8VM5wEtjkE+xD7uOjONHT9p4djUfxXLqVT4p4Pd/w/HoT1xkH1RUe3/lcEYup43xS2s5fQmpqSpW7h1OPR4XHoHAre5/z/y+mO8LuPg+h0RxD/guOp+831wLLMela09JjJN07RPZbCAo1QpSGrq/13ECu4b6aSp425mwrqvH6i2JePGTaSBc5EC/7cqGi7/h1pjx8HvU6mjX3SbTVNo8O4IhwJ3I3HdgfEtg4brPS2ePxUbFIWer7j9vx6FA/TnU8eMKtCxzzooNDnjuA/mV1fk0n5gj7ye3wRIMaLUdbGU3PT76BkL1uj/xdrpfYOwJp/M/ih0enRUkbciKORbzP+HTdj7yL2C8Zg6bvwbNFvjAPJmuoSluFpB18+4hBNheeo5MNB3e/y/zjs9fjju9TcHykB+QQXtR/N9MA8+ILam6vPGvvZmBxEq8Aju0ahBQGpqKu1E6NH8/+Uv78SWq5L3IHZ66QFFkeeLAvqPr4194VnpZLwyflId9LgDu9r3K6C9JdmgKrZ/pI55Lv+TYhXlyGtjRj0tXYyx498Yg90s3w8miwo6/Ixpcvv/N8th7T8MK4QH0en7YaYJqWNf/AENIgewq9UejS5YIkOxTFyetwQKpXaQHkrA1itOWsMGRZomPXj5E1GQCCLwgYiCRBCBD0QUJIIIfCCiIBFE4ANFOltj1zRdlSqnafbBY16f1Fa4BFRNz1XyMmbzwzp64KpDKwzDi8wItMoMvcS7AYqiR9nsum68URCl3oVhXZZF4/3sfD96B4KhNB2H93N5CUGDlmTQilc66Gb73qP3or9HulUtN5EneREaBmamD9htNsdUV66iPIBxc5mrV3XIfm3MqNnSWSBoWl4/vJ/H8dSqpujZ0TmLIFcyihAal51KT8BVPSbpMfz/y9KLyqmjtEFsdmyRzvGNG//vPnZVryydDmBasRB0WmGMMkFre51FoufY7sb4OZ6uo6w1FiWHMoQyI2xFgyJtQXJjcg9hongZMkZ4LArJVDMh8yuAckmYWp7CVBSls9kf1WYqcluQH9q3nk+wHUfLOQ6rKy+awxLhDabnRidXwtDyftCa7uEaRhQuauSWP/aerID+M8z+znD0XAL/BvPbZtPynWKNztX3YVrl4TXKBI/7Acy69957C7WyFPPldff78T0V/cu4XFsxPROI2u6oaHT40Py/KHtielrXj+/YseES24sIuqK9b/4vgzCtU/B/+YEtlqvrS1CK8q45LMkasbE80svGKEV6zFyRKsjEv/0NM08fhhl9TLLcoGPdF52n5qqvYmq+xdbC4o0zCgOzyyXAxP88+2y2AupQvN8h4ecKuj46F6v+WP2fKPhzMZzHKa2St8CWG5Wqq1fyrMIYwPtdwIbmGc8n255ITX3hLJbUA3iRy3sgBvBe2c2bN6fVRFfJjRWixUlQUsEwjN2uZeM1GD3f0GxRVzEQ39MwzcA2gN/jUED38EPtZ55hmjHhlf/biWn/MwrZeclyg74fm5j7Zs+ebTfSZJgukDyr//ACx3sn7sD0ZeHPhy2b1PoCFNXnSVqYdcdUDe5/8cUXnS3fNQPg/wNUUJtMEKHeLQAAAABJRU5ErkJggg==",dp=function(){function t(){y(this,t),this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.setting=void 0,this.image=void 0,this.device=void 0,this.cmdBuff=void 0,this.assmebler=void 0,this.vertexBuffers=void 0,this.indicesBuffers=void 0,this.pso=void 0,this.framebuffer=void 0,this.renderArea=void 0,this.region=void 0,this.material=void 0,this.texture=void 0,this.textureView=void 0,this._splashFinish=!1,this._loadFinish=!1}return l(t,[{key:"_tryToStart",value:function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide())}},{key:"main",value:function(e){if(window._CCSettings&&window._CCSettings.PreviewSetting?(this.setting=window._CCSettings.PreviewSetting,this.setting.totalTime=null!=this.setting.totalTime?this.setting.totalTime:3e3,this.setting.base64src=null!=this.setting.base64src?this.setting.base64src:fp,this.setting.effect=null!=this.setting.effect?this.setting.effect:"none"):this.setting={totalTime:3e3,base64src:fp,effect:"none"},this.setting.totalTime<=0)return this.callBack&&this.callBack(),this.callBack=null,this.setting=null,void delete t._ins;this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.device=e,this.image=new Image,this.image.onload=this.init.bind(this),this.image.src=this.setting.base64src}},{key:"setOnFinish",value:function(e){this.callBack=e}},{key:"init",value:function(){var r=this;this.initCMD(),this.initIA(),this.initPSO();this.handle=requestAnimationFrame(function e(t){if(!r.cancelAnimate){r.startTime<0&&(r.startTime=t);var i=t-r.startTime,n=vi(i/r.setting.totalTime);r.material.setProperty("u_precent",U_(n)),r.material.passes[0].update(),r.frame(t),i>r.setting.totalTime&&(r.splashFinish=!0),requestAnimationFrame(e)}})}},{key:"hide",value:function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,this.destoy(),delete t._ins}},{key:"frame",value:function(e){var t=this.device,i=this.pso,n=this.cmdBuff,r=this.framebuffer,a=this.renderArea,s=this.assmebler;n.begin(),n.beginRenderPass(r,a,dc.ALL,[{r:.88,g:.88,b:.88,a:1}],1,0),n.bindPipelineState(i),n.bindBindingLayout(i.pipelineLayout.layouts[0]),n.bindInputAssembler(s),n.draw(s),n.endRenderPass(),n.end(),t.queue.submit([n]),t.present()}},{key:"initCMD",value:function(){var e=this.device;this.renderArea={x:0,y:0,width:e.width,height:e.height},this.framebuffer=e.mainWindow.framebuffer,this.cmdBuff=e.createCommandBuffer({allocator:e.commandAllocator,type:Qu.PRIMARY})}},{key:"initIA",value:function(){var e=this.device,t=4*Float32Array.BYTES_PER_ELEMENT,i=4*t;this.vertexBuffers=e.createBuffer({usage:su.VERTEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:i,stride:t});var n=new Float32Array(16),r=-this.image.width/2,a=-this.image.height/2,s=0;n[s++]=r,n[s++]=a,n[s++]=0,n[s++]=1,n[s++]=-r,n[s++]=a,n[s++]=1,n[s++]=1,n[s++]=r,n[s++]=-a,n[s++]=0,n[s++]=0,n[s++]=-r,n[s++]=-a,n[s++]=1;for(var o=n[s++]=0;o<n.length;o+=4)n[o]=n[o]+e.width/2,n[o+1]=n[o+1]+e.height/2;for(var l=0;l<n.length;l+=4)n[l]=n[l]/e.width*2-1,n[l+1]=n[l+1]/e.height*2-1;this.vertexBuffers.update(n);var u=Uint8Array.BYTES_PER_ELEMENT,c=6*u;this.indicesBuffers=e.createBuffer({usage:su.INDEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:c,stride:u});var h=new Uint8Array(6);h[0]=0,h[1]=1,h[2]=2,h[3]=1,h[4]=3,h[5]=2,this.indicesBuffers.update(h);var f=[{name:"a_position",format:ru.RG32F},{name:"a_texCoord",format:ru.RG32F}];this.assmebler=e.createInputAssembler({attributes:f,vertexBuffers:[this.vertexBuffers],indexBuffer:this.indicesBuffers})}},{key:"initPSO",value:function(){var e=this.device,t="util/splash-image",i=[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"util/splash-image|splash-vs:vert|splash-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},u_precent:{type:13}}}]}],n=[{name:"util/splash-image|splash-vs:vert|splash-fs:frag",hash:2381344969,glsl3:{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nuniform splashFrag {\n  float u_precent;\n};\nvec4 frag () {\n  vec4 color = texture(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nuniform float u_precent;\nvec4 frag () {\n  vec4 color = texture2D(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:[],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[],blocks:[{name:"splashFrag",defines:[],binding:0,members:[{name:"u_precent",type:13,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}],dependencies:{}}],r=new P_;r.name=t,r.techniques=i,r.shaders=n,r.onLoaded(),this.material=new F_,this.material.initialize({effectAsset:r}),this.texture=e.createTexture({type:Fu.TEX2D,usage:Du.SAMPLED,format:ru.RGBA8,width:this.image.width,height:this.image.height,mipLevel:1}),this.textureView=e.createTextureView({texture:this.texture,type:Wu.TV2D,format:ru.RGBA8});var a=this.material.passes[0],s=a.getBinding("mainTexture");a.bindTextureView(s,this.textureView),this.pso=a.createPipelineState(),this.pso.pipelineLayout.layouts[0].update(),this.region=new bc,this.region.texExtent.width=this.image.width,this.region.texExtent.height=this.image.height,this.region.texExtent.depth=1,e.copyTexImagesToTexture([this.image],this.texture,[this.region])}},{key:"destoy",value:function(){this.callBack=null,this.setting=null,this.device=null,this.image=null,this.framebuffer=null,this.renderArea=null,this.region=null,this.cmdBuff.destroy(),this.cmdBuff=null,this.pso.destroy(),this.pso=null,this.material.destroy(),this.material=null,this.textureView.destroy(),this.textureView=null,this.texture.destroy(),this.texture=null,this.assmebler.destroy(),this.assmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null}},{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return null==t._ins&&(t._ins=new t),t._ins}}]),t}();dp._ins=void 0;var _p=m4("Game",function(){function d(){var e,t;y(this,d);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(d)).call.apply(e,[this].concat(n)))).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=p(g(d.prototype),"on",c(t)),t.eventTargetOnce=p(g(d.prototype),"once",c(t)),t.config={},t.onStart=null,t._persistRootNodes={},t._paused=!0,t._configLoaded=!1,t._isCloning=!1,t._prepared=!1,t._rendererInitialized=!1,t._gfxDevice=null,t._intervalId=null,t._lastTime=null,t._frameTime=null,t._sceneInfos=[],t.collisionMatrix=[],t.groupList=[],t}return _(d,cl),l(d,[{key:"setFrameRate",value:function(e){var t=this.config;"number"!=typeof e&&(e=parseInt(e),isNaN(e)&&(e=60)),t.frameRate=e,this._intervalId&&window.cancelAnimationFrame(this._intervalId),this._intervalId=0,this._paused=!0,this._setAnimFrame(),this._runMainLoop()}},{key:"getFrameRate",value:function(){return this.config.frameRate||0}},{key:"step",value:function(){cc.director.mainLoop()}},{key:"pause",value:function(){this._paused||(this._paused=!0,this._intervalId&&window.cancelAnimationFrame(this._intervalId),this._intervalId=0)}},{key:"resume",value:function(){this._paused&&(this._paused=!1,this._runMainLoop())}},{key:"isPaused",value:function(){return this._paused}},{key:"restart",value:function(){cc.director.once(cc.Director.EVENT_AFTER_DRAW,function(){for(var e in cc.game._persistRootNodes)cc.game.removePersistRootNode(cc.game._persistRootNodes[e]);cc.director.getScene().destroy(),cc.Object._deferredDestroy(),cc.director.purgeDirector(),cc.director.reset(),cc.game.onStart()})}},{key:"end",value:function(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),close()}},{key:"on",value:function(e,t,i){this._prepared&&e===d.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOn(e,t,i)}},{key:"once",value:function(e,t,i){this._prepared&&e===d.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOnce(e,t,i)}},{key:"run",value:function(e,t){this._initConfig(e),this._initRenderer(),this.onStart=t,this.prepare(cc.game.onStart&&cc.game.onStart.bind(cc.game))}},{key:"addPersistRootNode",value:function(e){if(cc.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=cc.director._scene;if(cc.isValid(i))if(e.parent){if(!(e.parent instanceof cc.Scene))return void P(3801);if(e.parent!==i)return void P(3802)}else e.parent=i;(this._persistRootNodes[t]=e)._persistNode=!0}}else P(3800)}},{key:"removePersistRootNode",value:function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1)}},{key:"isPersistRootNode",value:function(e){return e._persistNode}},{key:"prepare",value:function(t){if(this._prepared)t&&t();else{var e=this.config.jsList;if(e&&0<e.length){var i=this;cc.loader.load(e,function(e){if(e)throw new Error(JSON.stringify(e));i._prepareFinished(t)})}else this._prepareFinished(t)}}},{key:"_initEngine",value:function(){this._initEvents(),this.emit(d.EVENT_ENGINE_INITED)}},{key:"_prepareFinished",value:function(e){var t=this;this._prepared=!0,this._initEngine(),console.log("Cocos Creator 3D v"+cc.ENGINE_VERSION);function i(){t._setAnimFrame(),t._runMainLoop(),t.emit(d.EVENT_GAME_INITED),e&&e()}i()}},{key:"_setAnimFrame",value:function(){this._lastTime=new Date;var e=cc.game.config.frameRate;this._frameTime=1e3/e,60!==e&&30!==e?(window.requestAnimationFrame=this._stTime,window.cancelAnimationFrame=this._ctTime):(window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||this._stTime,window.cancelAnimationFrame=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime)}},{key:"_stTime",value:function(e){var t=(new Date).getTime(),i=Math.max(0,cc.game._frameTime-(t-cc.game._lastTime)),n=window.setTimeout(function(){e()},i);return cc.game._lastTime=t+i,n}},{key:"_ctTime",value:function(e){window.clearTimeout(e)}},{key:"_runMainLoop",value:function(){var t,i=this,e=i.config,n=cc.director,r=!0,a=e.frameRate;W(!!e.showFPS),t=function(e){if(!i._paused){if(i._intervalId=window.requestAnimationFrame(t),30===a&&(r=!r))return;n.mainLoop(e)}},i._intervalId=window.requestAnimationFrame(t),i._paused=!1}},{key:"_initConfig",value:function(e){"number"!=typeof e.debugMode&&(e.debugMode=0),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||2<t||t<0)&&(e.renderMode=0),"boolean"!=typeof e.registerSystemEvent&&(e.registerSystemEvent=!0),e.showFPS=!!e.showFPS,this._sceneInfos=e.scenes||[],this.collisionMatrix=e.collisionMatrix||[],this.groupList=e.groupList||[],R(e.debugMode),this.config=e,this._configLoaded=!0}},{key:"_determineRenderType",value:function(){var e=this.config,t=parseInt(e.renderMode);this.renderType=d.RENDER_TYPE_CANVAS;var i=!1;if(0===t?cc.sys.capabilities.opengl?(this.renderType=d.RENDER_TYPE_WEBGL,i=!0):cc.sys.capabilities.canvas&&(this.renderType=d.RENDER_TYPE_CANVAS,i=!0):1===t&&cc.sys.capabilities.canvas?(this.renderType=d.RENDER_TYPE_CANVAS,i=!0):2===t&&cc.sys.capabilities.opengl&&(this.renderType=d.RENDER_TYPE_WEBGL,i=!0),!i)throw new Error(G(3820,t))}},{key:"_initRenderer",value:function(){if(!this._rendererInitialized){var e,t,i,n,r,a,s=this.config.id,o=cc.sys.platform===cc.sys.WECHAT_GAME,l=cc.sys.platform===cc.sys.QQ_PLAY;if(o)this.container=n=document.createElement("div"),this.frame=n.parentNode===document.body?document.documentElement:n.parentNode,i=cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?window.sharedCanvas||wx.getSharedCanvas():window.canvas,this.canvas=i;else if(l)this.container=cc.container=document.createElement("div"),this.frame=document.documentElement,this.canvas=i=window.canvas;else{var u=s?s instanceof HTMLElement?s:document.querySelector(s)||document.querySelector("#"+s):null;if(!u)throw new Error(G(200));"CANVAS"===u.tagName?(e=u.width,t=u.height,this.canvas=i=u,this.container=n=document.createElement("div"),i&&i.parentNode&&i.parentNode.insertBefore(n,i)):("DIV"!==u.tagName&&P(3819),e=u.clientWidth,t=u.clientHeight,this.canvas=i=document.createElement("canvas"),this.container=n=document.createElement("div"),u.appendChild(n)),n.setAttribute("id","Cocos3dGameContainer"),n.appendChild(i),this.frame=n.parentNode===document.body?document.documentElement:n.parentNode,a="gameCanvas",-1<(" "+(r=i).className+" ").indexOf(" "+a+" ")||(r.className&&(r.className+=" "),r.className+=a),i.setAttribute("width",e||"480"),i.setAttribute("height",t||"320"),i.setAttribute("tabindex","99")}if(this._determineRenderType(),this.renderType===d.RENDER_TYPE_WEBGL){var c=!!window.WebGL2RenderingContext,h=navigator.userAgent.toLowerCase();-1!==h.indexOf("safari")&&-1===h.indexOf("chrome")&&(c=!1),c&&cc.WebGL2GFXDevice?this._gfxDevice=new cc.WebGL2GFXDevice:cc.WebGLGFXDevice&&(this._gfxDevice=new cc.WebGLGFXDevice);var f={canvasElm:i,debug:!0,devicePixelRatio:window.devicePixelRatio,nativeWidth:Math.floor(screen.width*cc.view._devicePixelRatio),nativeHeight:Math.floor(screen.height*cc.view._devicePixelRatio)};!this._gfxDevice.initialize(f)&&c&&(this._gfxDevice=new cc.WebGLGFXDevice,this._gfxDevice.initialize(f))}if(!this._gfxDevice)return console.error("can not support canvas rendering in 3D"),void(this.renderType=d.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){if(!cc._isContextMenuEnable)return!1},this._rendererInitialized=!0,this.emit(d.EVENT_RENDERER_INITED)}}},{key:"_initEvents",value:function(){var i,e=window;void 0!==document.hidden?i="hidden":void 0!==document.mozHidden?i="mozHidden":void 0!==document.msHidden?i="msHidden":void 0!==document.webkitHidden&&(i="webkitHidden");var t=!1;function n(){t||(t=!0,cc.game.emit(d.EVENT_HIDE))}function r(){t&&(t=!1,cc.game.emit(d.EVENT_SHOW))}if(i)for(var a=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],s=0;s<a.length;s++)document.addEventListener(a[s],function(e){var t=document[i];(t=t||e.hidden)?n():r()});else e.addEventListener("blur",n),e.addEventListener("focus",r);-1<navigator.userAgent.indexOf("MicroMessenger")&&(e.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(e.addEventListener("pagehide",n),e.addEventListener("pageshow",r),document.addEventListener("pagehide",n),document.addEventListener("pageshow",r)),this.on(d.EVENT_HIDE,function(){cc.game.pause()}),this.on(d.EVENT_SHOW,function(){cc.game.resume()})}}]),d}());_p.EVENT_HIDE="game_on_hide",_p.EVENT_SHOW="game_on_show",_p.EVENT_GAME_INITED="game_inited",_p.EVENT_ENGINE_INITED="engine_inited",_p.EVENT_RENDERER_INITED="renderer_inited",_p.RENDER_TYPE_CANVAS=0,_p.RENDER_TYPE_WEBGL=1,_p.RENDER_TYPE_OPENGL=2,cc.Game=_p;var pp=m4("game",cc.game=new _p),vp=new(function(){function e(){y(this,e),this.html=void 0,this.meta={width:"device-width"},this.adaptationType=cc.sys.browserType}return l(e,[{key:"init",value:function(){this.html=document.getElementsByTagName("html")[0]}},{key:"availWidth",value:function(e){return cc.sys.isMobile||!e||e===this.html?window.innerWidth:e.clientWidth}},{key:"availHeight",value:function(e){return cc.sys.isMobile||!e||e===this.html?window.innerHeight:e.clientHeight}}]),e}());switch(cc.sys.os===cc.sys.OS_IOS&&(vp.adaptationType=cc.sys.BROWSER_TYPE_SAFARI),vp.adaptationType){case cc.sys.BROWSER_TYPE_SAFARI:vp.meta["minimal-ui"]="true";case cc.sys.BROWSER_TYPE_SOUGOU:case cc.sys.BROWSER_TYPE_UC:vp.availWidth=function(e){return e.clientWidth},vp.availHeight=function(e){return e.clientHeight};break;case cc.sys.BROWSER_TYPE_WECHAT_GAME:vp.availWidth=function(){return window.innerWidth},vp.availHeight=function(){return window.innerHeight};break;case cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB:var mp=window.sharedCanvas||wx.getSharedCanvas();vp.availWidth=function(){return mp.width},vp.availHeight=function(){return mp.height}}var yp=null,gp=m4("View",function(){function n(){var e;y(this,n),(e=x(this,g(n).call(this)))._frameSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._devicePixelRatio=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resizing=void 0,e._orientationChanging=void 0,e._isRotated=void 0,e._orientation=void 0,e._isAdjustViewport=void 0,e._antiAliasEnabled=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0,e._resizeWithBrowserSize=void 0,e._designResolutionSize=void 0,e._originalDesignResolutionSize=void 0;c(e);var t=bp,i=xp;return e._frameSize=new jn(0,0),e._designResolutionSize=new jn(0,0),e._originalDesignResolutionSize=new jn(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new Jn(0,0,0,0),e._visibleRect=new Jn(0,0,0,0),e._autoFullScreen=!1,e._devicePixelRatio=1,e._retinaEnabled=!1,e._resizeCallback=null,e._resizing=!1,e._resizeWithBrowserSize=!1,e._orientationChanging=!0,e._isRotated=!1,e._orientation=cc.macro.ORIENTATION_AUTO,e._isAdjustViewport=!0,e._antiAliasEnabled=!1,e._resolutionPolicy=null,e._rpExactFit=new Sp(t.EQUAL_TO_FRAME,i.EXACT_FIT),e._rpShowAll=new Sp(t.EQUAL_TO_FRAME,i.SHOW_ALL),e._rpNoBorder=new Sp(t.EQUAL_TO_FRAME,i.NO_BORDER),e._rpFixedHeight=new Sp(t.EQUAL_TO_FRAME,i.FIXED_HEIGHT),e._rpFixedWidth=new Sp(t.EQUAL_TO_FRAME,i.FIXED_WIDTH),cc.game.once(cc.Game.EVENT_ENGINE_INITED,e.init,c(e)),e}return _(n,cl),l(n,[{key:"init",value:function(){vp.init(),this._initFrameSize(),this.enableAntiAlias(!0);var e=cc.game.canvas.width,t=cc.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._originalDesignResolutionSize.width=e,this._originalDesignResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,cc.winSize.width=this._visibleRect.width,cc.winSize.height=this._visibleRect.height,cc.visibleRect&&cc.visibleRect.init(this._visibleRect)}},{key:"resizeWithBrowserSize",value:function(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,window.addEventListener("resize",this._resizeEvent),window.addEventListener("orientationchange",this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,window.removeEventListener("resize",this._resizeEvent),window.removeEventListener("orientationchange",this._orientationChange))}},{key:"setResizeCallback",value:function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)}},{key:"setOrientation",value:function(e){(e&=cc.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)}},{key:"adjustViewportMeta",value:function(e){this._isAdjustViewport=e}},{key:"enableRetina",value:function(e){this._retinaEnabled=!!e}},{key:"isRetinaEnabled",value:function(){return this._retinaEnabled}},{key:"enableAntiAlias",value:function(e){if(this._antiAliasEnabled!==e)if(this._antiAliasEnabled=e,cc.game.renderType===cc.Game.RENDER_TYPE_WEBGL){var t=cc.loader._cache;for(var i in t){var n=t[i],r=n&&n.content instanceof cc.Texture2D?n.content:null;if(r){var a=cc.Texture2D.Filter;e?r.setFilters(a.LINEAR,a.LINEAR):r.setFilters(a.NEAREST,a.NEAREST)}}}else if(cc.game.renderType===cc.Game.RENDER_TYPE_CANVAS){var s=cc.game.canvas.getContext("2d");s.imageSmoothingEnabled=e,s.mozImageSmoothingEnabled=e}}},{key:"isAntiAliasEnabled",value:function(){return this._antiAliasEnabled}},{key:"enableAutoFullScreen",value:function(e){e&&e!==this._autoFullScreen&&cc.sys.isMobile&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT?(this._autoFullScreen=!0,cc.screen.autoFullScreen(cc.game.frame)):this._autoFullScreen=!1}},{key:"isAutoFullScreenEnabled",value:function(){return this._autoFullScreen}},{key:"setCanvasSize",value:function(e,t){var i=cc.game.canvas,n=cc.game.container;i.width=e*this._devicePixelRatio,i.height=t*this._devicePixelRatio,i.style.width=e+"px",i.style.height=t+"px",n.style.width=e+"px",n.style.height=t+"px",this._resizeEvent()}},{key:"getCanvasSize",value:function(){return cc.size(cc.game.canvas.width,cc.game.canvas.height)}},{key:"getFrameSize",value:function(){return cc.size(this._frameSize.width,this._frameSize.height)}},{key:"setFrameSize",value:function(e,t){this._frameSize.width=e,this._frameSize.height=t,cc.frame.style.width=e+"px",cc.frame.style.height=t+"px",this._resizeEvent()}},{key:"getVisibleSize",value:function(){return cc.size(this._visibleRect.width,this._visibleRect.height)}},{key:"getVisibleSizeInPixel",value:function(){return cc.size(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}},{key:"getVisibleOrigin",value:function(){return cc.v2(this._visibleRect.x,this._visibleRect.y)}},{key:"getVisibleOriginInPixel",value:function(){return cc.v2(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}},{key:"getResolutionPolicy",value:function(){return this._resolutionPolicy}},{key:"setResolutionPolicy",value:function(e){var t=this;if(e instanceof Sp)t._resolutionPolicy=e;else{var i=Sp;e===i.EXACT_FIT&&(t._resolutionPolicy=t._rpExactFit),e===i.SHOW_ALL&&(t._resolutionPolicy=t._rpShowAll),e===i.NO_BORDER&&(t._resolutionPolicy=t._rpNoBorder),e===i.FIXED_HEIGHT&&(t._resolutionPolicy=t._rpFixedHeight),e===i.FIXED_WIDTH&&(t._resolutionPolicy=t._rpFixedWidth)}}},{key:"setDesignResolutionSize",value:function(e,t,i){if(0<e||0<t){this.setResolutionPolicy(i);var n=this._resolutionPolicy;if(n&&n.preApply(this),cc.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),n){this._originalDesignResolutionSize.width=this._designResolutionSize.width=e,this._originalDesignResolutionSize.height=this._designResolutionSize.height=t;var r=n.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var a=this._viewportRect,s=this._visibleRect,o=r.viewport;a.x=o.x,a.y=o.y,a.width=o.width,a.height=o.height,s.x=0,s.y=0,s.width=o.width/this._scaleX,s.height=o.height/this._scaleY}n.postApply(this),cc.winSize.width=this._visibleRect.width,cc.winSize.height=this._visibleRect.height,cc.visibleRect&&cc.visibleRect.init(this._visibleRect),this.emit("design-resolution-changed")}else cc.logID(2201)}else cc.logID(2200)}},{key:"getDesignResolutionSize",value:function(){return cc.size(this._designResolutionSize.width,this._designResolutionSize.height)}},{key:"setRealPixelResolution",value:function(e,t,i){this._setViewportMeta({width:e},!0),document.documentElement.style.width=e+"px",document.body.style.width=e+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,i)}},{key:"setViewportInPoints",value:function(e,t,i,n){var r=this._scaleX,a=this._scaleY;cc.game._renderContext.viewport(e*r+this._viewportRect.x,t*a+this._viewportRect.y,i*r,n*a)}},{key:"setScissorInPoints",value:function(e,t,i,n){var r=this._scaleX,a=this._scaleY,s=Math.ceil(e*r+this._viewportRect.x),o=Math.ceil(t*a+this._viewportRect.y),l=Math.ceil(i*r),u=Math.ceil(n*a),c=cc.game._renderContext;if(!yp){var h=c.getParameter(c.SCISSOR_BOX);yp=new Jn(h[0],h[1],h[2],h[3])}yp.x===s&&yp.y===o&&yp.width===l&&yp.height===u||(yp.x=s,yp.y=o,yp.width=l,yp.height=u,c.scissor(s,o,l,u))}},{key:"isScissorEnabled",value:function(){var e=cc.game._renderContext;return e.isEnabled(e.SCISSOR_TEST)}},{key:"getScissorRect",value:function(){var e=cc.game._renderContext;if(!yp){var t=e.getParameter(e.SCISSOR_BOX);yp=new Jn(t[0],t[1],t[2],t[3])}var i=1/this._scaleX,n=1/this._scaleY;return new Jn((yp.x-this._viewportRect.x)*i,(yp.y-this._viewportRect.y)*n,yp.width*i,yp.height*n)}},{key:"getViewportRect",value:function(){return this._viewportRect}},{key:"getScaleX",value:function(){return this._scaleX}},{key:"getScaleY",value:function(){return this._scaleY}},{key:"getDevicePixelRatio",value:function(){return this._devicePixelRatio}},{key:"convertToLocationInView",value:function(e,t,i,n){var r=n||cc.v2(),a=this._devicePixelRatio*(e-i.left),s=this._devicePixelRatio*(i.top+i.height-t);return this._isRotated?(r.x=cc.game.canvas.width-s,r.y=a):(r.x=a,r.y=s),r}},{key:"_resizeEvent",value:function(){var e,t=(e=this.setDesignResolutionSize?this:cc.view)._frameSize.width,i=e._frameSize.height,n=e._isRotated;if(cc.sys.isMobile){var r=cc.game.container.style,a=r.margin;r.margin="0",r.display="none",e._initFrameSize(),r.margin=a,r.display="block"}else e._initFrameSize();if(e._orientationChanging||e._isRotated!==n||e._frameSize.width!==t||e._frameSize.height!==i){var s=e._originalDesignResolutionSize.width,o=e._originalDesignResolutionSize.height;e._resizing=!0,0<s&&e.setDesignResolutionSize(s,o,e._resolutionPolicy),e._resizing=!1,e._resizeCallback&&e._resizeCallback.call()}}},{key:"_orientationChange",value:function(){cc.view._orientationChanging=!0,cc.view._resizeEvent()}},{key:"_initFrameSize",value:function(){var e=this._frameSize,t=vp.availWidth(cc.game.frame),i=vp.availHeight(cc.game.frame),n=i<=t;!cc.sys.isMobile||n&&this._orientation&cc.macro.ORIENTATION_LANDSCAPE||!n&&this._orientation&cc.macro.ORIENTATION_PORTRAIT?(e.width=t,e.height=i,cc.game.container.style["-webkit-transform"]="rotate(0deg)",cc.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=i,e.height=t,cc.game.container.style["-webkit-transform"]="rotate(90deg)",cc.game.container.style.transform="rotate(90deg)",cc.game.container.style["-webkit-transform-origin"]="0px 0px 0px",cc.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,cc.game.canvas.style["-webkit-transform"]="translateZ(0px)",cc.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout(function(){cc.view._orientationChanging=!1},1e3)}},{key:"_adjustSizeKeepCanvasSize",value:function(){var e=this._originalDesignResolutionSize.width,t=this._originalDesignResolutionSize.height;0<e&&this.setDesignResolutionSize(e,t,this._resolutionPolicy)}},{key:"_setViewportMeta",value:function(e,t){var i=document.getElementById("cocosMetaElement");i&&t&&document.head.removeChild(i);var n,r,a,s=document.getElementsByName("viewport"),o=s?s[0]:null;for(r in n=o?o.content:"",(i=i||document.createElement("meta")).id="cocosMetaElement",i.name="viewport",i.content="",e)-1===n.indexOf(r)?n+=","+r+"="+e[r]:t&&(a=new RegExp(r+"s*=s*[^,]+"),n.replace(a,r+"="+e[r]));/^,/.test(n)&&(n=n.substr(1)),i.content=n,o&&(o.content=n),document.head.appendChild(i)}},{key:"_adjustViewportMeta",value:function(){this._isAdjustViewport&&(this._setViewportMeta(vp.meta,!1),this._isAdjustViewport=!1)}},{key:"_convertMouseToLocation",value:function(e,t){e.x=this._devicePixelRatio*(e.x-t.left),e.y=this._devicePixelRatio*(t.top+t.height-e.y)}},{key:"_convertPointWithScale",value:function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY}},{key:"_convertTouchWidthScale",value:function(e){var t=this._viewportRect,i=this._scaleX,n=this._scaleY;e._point.x=(e._point.x-t.x)/i,e._point.y=(e._point.y-t.y)/n,e._prevPoint.x=(e._prevPoint.x-t.x)/i,e._prevPoint.y=(e._prevPoint.y-t.y)/n}},{key:"_convertTouchesWithScale",value:function(e){for(var t,i,n=this._viewportRect,r=this._scaleX,a=this._scaleY,s=0;s<e.length;s++){var o=e[s];t=o._point,i=o._prevPoint,t.x=(t.x-n.x)/r,t.y=(t.y-n.y)/a,i.x=(i.x-n.x)/r,i.y=(i.y-n.y)/a}}}]),n}());gp.instance=void 0;var bp=function(){function e(){y(this,e),this.name="ContainerStrategy"}return l(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){}},{key:"postApply",value:function(e){}},{key:"_setupContainer",value:function(e,t,i){var n=cc.game.canvas,r=cc.game.container;cc.sys.platform!==cc.sys.WECHAT_GAME&&(cc.sys.os===cc.sys.OS_ANDROID&&(document.body.style.width=(e._isRotated?i:t)+"px",document.body.style.height=(e._isRotated?t:i)+"px"),r.style.width=n.style.width=t+"px",r.style.height=n.style.height=i+"px");var a=e._devicePixelRatio=1;e.isRetinaEnabled()&&(a=e._devicePixelRatio=Math.min(2,window.devicePixelRatio||1)),n.width=t*a,n.height=i*a}},{key:"_fixContainer",value:function(){document.body.insertBefore(cc.game.container,document.body.firstChild);var e=document.body.style;e.width=window.innerWidth+"px",e.height=window.innerHeight+"px",e.overflow="hidden";var t=cc.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0}}]),e}();bp.EQUAL_TO_FRAME=void 0,bp.PROPORTION_TO_FRAME=void 0;var xp=function(){function e(){y(this,e),this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}return l(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){return{scale:[1,1]}}},{key:"postApply",value:function(e){}},{key:"_buildResult",value:function(e,t,i,n,r,a){Math.abs(e-i)<2&&(i=e),Math.abs(t-n)<2&&(n=t);var s=new Jn(Math.round((e-i)/2),Math.round((t-n)/2),i,n);return this._result.scale=[r,a],this._result.viewport=s,this._result}}]),e}();xp.EXACT_FIT=void 0,xp.SHOW_ALL=void 0,xp.NO_BORDER=void 0,xp.FIXED_HEIGHT=void 0,xp.FIXED_WIDTH=void 0,function(){var e=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="EqualToFrame",t}return _(a,bp),l(a,[{key:"apply",value:function(e){var t=e._frameSize.height,i=cc.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?i.margin="0 0 0 "+t+"px":i.margin="0px",i.padding="0px"}}]),a}(),t=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="ProportionalToFrame",t}return _(a,bp),l(a,[{key:"apply",value:function(e,t){var i,n,r=e._frameSize.width,a=e._frameSize.height,s=cc.game.container.style,o=t.width,l=t.height,u=r/o,c=a/l;n=u<c?(i=r,l*u):(i=o*c,a);var h=Math.round((r-i)/2),f=Math.round((a-n)/2);i=r-2*h,n=a-2*f,this._setupContainer(e,i,n),e._isRotated?s.margin="0 0 0 "+a+"px":s.margin="0px",s.paddingLeft=h+"px",s.paddingRight=h+"px",s.paddingTop=f+"px",s.paddingBottom=f+"px"}}]),a}();bp.EQUAL_TO_FRAME=new e,bp.PROPORTION_TO_FRAME=new t;var i=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="ExactFit",t}return _(a,xp),l(a,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=i/t.width,a=n/t.height;return this._buildResult(i,n,i,n,r,a)}}]),a}(),n=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="ShowAll",t}return _(a,xp),l(a,[{key:"apply",value:function(e,t){var i,n,r=cc.game.canvas.width,a=cc.game.canvas.height,s=t.width,o=t.height,l=r/s,u=a/o,c=0;return n=l<u?(i=r,o*(c=l)):(i=s*(c=u),a),this._buildResult(r,a,i,n,c,c)}}]),a}(),r=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="NoBorder",t}return _(a,xp),l(a,[{key:"apply",value:function(e,t){var i,n,r,a=cc.game.canvas.width,s=cc.game.canvas.height,o=t.width,l=t.height,u=a/o,c=s/l;return r=u<c?(n=o*(i=c),s):(n=a,l*(i=u)),this._buildResult(a,s,n,r,i,i)}}]),a}(),a=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="FixedHeight",t}return _(a,xp),l(a,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=n/t.height,a=i,s=n;return this._buildResult(i,n,a,s,r,r)}}]),a}(),s=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).name="FixedWidth",t}return _(a,xp),l(a,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=i/t.width,a=i,s=n;return this._buildResult(i,n,a,s,r,r)}}]),a}();xp.EXACT_FIT=new i,xp.SHOW_ALL=new n,xp.NO_BORDER=new r,xp.FIXED_HEIGHT=new a,xp.FIXED_WIDTH=new s}();var Sp=m4("ResolutionPolicy",function(){function i(e,t){y(this,i),this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}return l(i,[{key:"preApply",value:function(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)}},{key:"apply",value:function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)}},{key:"postApply",value:function(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)}},{key:"setContainerStrategy",value:function(e){e instanceof bp&&(this._containerStrategy=e)}},{key:"setContentStrategy",value:function(e){e instanceof xp&&(this._contentStrategy=e)}},{key:"canvasSize",get:function(){return cc.v2(cc.game.canvas.width,cc.game.canvas.height)}}]),i}());Sp.EXACT_FIT=void 0,Sp.SHOW_ALL=void 0,Sp.NO_BORDER=void 0,Sp.FIXED_HEIGHT=void 0,Sp.FIXED_WIDTH=void 0,Sp.UNKNOWN=void 0,Sp.ContainerStrategy=void 0,Sp.ContentStrategy=void 0,Sp.EXACT_FIT=0,Sp.NO_BORDER=1,Sp.SHOW_ALL=2,Sp.FIXED_HEIGHT=3,Sp.FIXED_WIDTH=4,Sp.UNKNOWN=5,Sp.ContainerStrategy=bp,Sp.ContentStrategy=xp,cc.ResolutionPolicy=Sp;var Tp=m4("view",gp.instance=cc.view=new gp);cc.winSize=cc.v2();var wp=m4("EventMouse",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,tl.MOUSE,t))).movementX=0,i.movementY=0,i._eventType=void 0,i._button=0,i._x=0,i._y=0,i._prevX=0,i._prevY=0,i._scrollX=0,i._scrollY=0,i._eventType=e,i}return _(n,tl),l(n,[{key:"setScrollData",value:function(e,t){this._scrollX=e,this._scrollY=t}},{key:"getScrollX",value:function(){return this._scrollX}},{key:"getScrollY",value:function(){return this._scrollY}},{key:"setLocation",value:function(e,t){this._x=e,this._y=t}},{key:"getLocation",value:function(e){return e=e||new Ii,Ii.set(e,this._x,this._y),e}},{key:"getLocationInView",value:function(e){return e=e||new Ii,Ii.set(e,this._x,cc.view._designResolutionSize.height-this._y),e}},{key:"getUILocation",value:function(e){return e=e||new Ii,Ii.set(e,this._x,this._y),cc.view._convertPointWithScale(e),e}},{key:"_setPrevCursor",value:function(e,t){this._prevX=e,this._prevY=t}},{key:"getPreviousLocation",value:function(e){return e=e||new Ii,Ii.set(e,this._prevX,this._prevY),e}},{key:"getUIPreviousLocation",value:function(e){return e=e||new Ii,Ii.set(e,this._prevX,this._prevY),cc.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e=e||new Ii,Ii.set(e,this._x-this._prevX,this._y-this._prevY),e}},{key:"getDeltaX",value:function(){return this._x-this._prevX}},{key:"getDeltaY",value:function(){return this._y-this._prevY}},{key:"getUIDelta",value:function(e){return e=e||new Ii,Ii.set(e,(this._x-this._prevX)/cc.view.getScaleX(),(this._y-this._prevY)/cc.view.getScaleY()),e}},{key:"getUIDeltaX",value:function(){return(this._x-this._prevX)/cc.view.getScaleX()}},{key:"getUIDeltaY",value:function(){return(this._y-this._prevY)/cc.view.getScaleY()}},{key:"setButton",value:function(e){this._button=e}},{key:"getButton",value:function(){return this._button}},{key:"getLocationX",value:function(){return this._x}},{key:"getLocationY",value:function(){return this._y}},{key:"getUILocationX",value:function(){var e=cc.view.getViewportRect();return(this._x-e.x)/cc.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=cc.view.getViewportRect();return(this._y-e.y)/cc.view.getScaleY()}}]),n}());wp.NONE=0,wp.DOWN=1,wp.UP=2,wp.MOVE=3,wp.SCROLL=4,wp.BUTTON_LEFT=0,wp.BUTTON_RIGHT=2,wp.BUTTON_MIDDLE=1,wp.BUTTON_4=3,wp.BUTTON_5=4,wp.BUTTON_6=5,wp.BUTTON_7=6,wp.BUTTON_8=7;var Ep=m4("EventTouch",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,tl.TOUCH,t))).touch=null,i._eventCode=0,i.simulate=!1,i._touches=void 0,i._eventCode=0,i._touches=e||[],i}return _(n,tl),l(n,[{key:"getEventCode",value:function(){return this._eventCode}},{key:"getTouches",value:function(){return this._touches}},{key:"_setEventCode",value:function(e){this._eventCode=e}},{key:"_setTouches",value:function(e){this._touches=e}},{key:"setLocation",value:function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)}},{key:"getLocation",value:function(e){return this.touch?this.touch.getLocation(e):new Ii}},{key:"getUILocation",value:function(e){return this.touch?this.touch.getUILocation(e):new Ii}},{key:"getLocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new Ii}},{key:"getUILocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new Ii}},{key:"getPreviousLocation",value:function(e){return this.touch?this.touch.getPreviousLocation(e):new Ii}},{key:"getStartLocation",value:function(e){return this.touch?this.touch.getStartLocation(e):new Ii}},{key:"getUIStartLocation",value:function(e){return this.touch?this.touch.getUIStartLocation(e):new Ii}},{key:"getID",value:function(){return this.touch?this.touch.getID():null}},{key:"getDelta",value:function(e){return this.touch?this.touch.getDelta(e):new Ii}},{key:"getUIDelta",value:function(e){return this.touch?this.touch.getUIDelta(e):new Ii}},{key:"getDeltaX",value:function(e){return this.touch?this.touch.getDelta(e).x:0}},{key:"getDeltaY",value:function(e){return this.touch?this.touch.getDelta(e).y:0}},{key:"getLocationX",value:function(){return this.touch?this.touch.getLocationX():0}},{key:"getLocationY",value:function(){return this.touch?this.touch.getLocationY():0}}]),n}());Ep.MAX_TOUCHES=5,Ep.BEGAN=0,Ep.MOVED=1,Ep.ENDED=2,Ep.CANCELLED=3;var Ap=m4("EventAcceleration",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,tl.ACCELERATION,t))).acc=void 0,i.acc=e,i}return _(n,tl),n}()),Cp=m4("EventKeyboard",function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this,tl.KEYBOARD,i))).keyCode=void 0,n.rawEvent=void 0,n.isPressed=void 0,"number"==typeof e?n.keyCode=e:(n.keyCode=e.keyCode,n.rawEvent=e),n.isPressed=t,n}return _(r,tl),r}());tl.EventMouse=wp,tl.EventTouch=Ep,tl.EventAcceleration=Ap,tl.EventKeyboard=Cp;var kp=function(){function n(e,t,i){y(this,n),this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=i,this._type=e||0,this._listenerID=t||""}return l(n,[{key:"onEvent",get:function(){return this._onEvent}}],[{key:"create",value:function(e){cc.assertID(e&&e.event,1900);var t=e.event;delete e.event;var i=null;if(t===cc.EventListener.TOUCH_ONE_BY_ONE?i=new Mp:t===cc.EventListener.TOUCH_ALL_AT_ONCE?i=new Ip:t===cc.EventListener.MOUSE?i=new Op:t===cc.EventListener.KEYBOARD?i=new Lp:t===cc.EventListener.ACCELERATION&&(i=new Bp(e.callback),delete e.callback),i)for(var n=0,r=Object.keys(e);n<r.length;n++){var a=r[n];i[a]=e[a]}return i}}]),l(n,[{key:"_setPaused",value:function(e){this._paused=e}},{key:"_isPaused",value:function(){return this._paused}},{key:"_setRegistered",value:function(e){this._registered=e}},{key:"_isRegistered",value:function(){return this._registered}},{key:"_getType",value:function(){return this._type}},{key:"_getListenerID",value:function(){return this._listenerID}},{key:"_setFixedPriority",value:function(e){this._fixedPriority=e}},{key:"_getFixedPriority",value:function(){return this._fixedPriority}},{key:"_setSceneGraphPriority",value:function(e){this._target=e,this._node=e}},{key:"_getSceneGraphPriority",value:function(){return this._node}},{key:"checkAvailable",value:function(){return null!==this._onEvent}},{key:"clone",value:function(){return null}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}}]),n}();kp.UNKNOWN=0,kp.TOUCH_ONE_BY_ONE=1,kp.TOUCH_ALL_AT_ONCE=2,kp.KEYBOARD=3,kp.MOUSE=4,kp.ACCELERATION=6,kp.CUSTOM=8,kp.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};var Rp=kp.ListenerID,Op=function(){function i(){var t;return y(this,i),(t=x(this,g(i).call(this,kp.MOUSE,Rp.MOUSE,null))).onMouseDown=null,t.onMouseUp=null,t.onMouseMove=null,t.onMouseScroll=null,t._onEvent=function(e){return t._callback(e)},t}return _(i,kp),l(i,[{key:"_callback",value:function(e){var t=cc.Event.EventMouse;switch(e._eventType){case t.DOWN:this.onMouseDown&&this.onMouseDown(e);break;case t.UP:this.onMouseUp&&this.onMouseUp(e);break;case t.MOVE:this.onMouseMove&&this.onMouseMove(e);break;case t.SCROLL:this.onMouseScroll&&this.onMouseScroll(e)}}},{key:"clone",value:function(){var e=new i;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e}},{key:"checkAvailable",value:function(){return!0}}]),i}(),Mp=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,kp.TOUCH_ONE_BY_ONE,Rp.TOUCH_ONE_BY_ONE,null))).swallowTouches=!1,e.onTouchBegan=null,e.onTouchMoved=null,e.onTouchEnded=null,e.onTouchCancelled=null,e._claimedTouches=[],e}return _(t,kp),l(t,[{key:"setSwallowTouches",value:function(e){this.swallowTouches=e}},{key:"isSwallowTouches",value:function(){return this.swallowTouches}},{key:"clone",value:function(){var e=new t;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e}},{key:"checkAvailable",value:function(){return!!this.onTouchBegan||(cc.logID(1801),!1)}}]),t}(),Ip=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,kp.TOUCH_ALL_AT_ONCE,Rp.TOUCH_ALL_AT_ONCE,null))).onTouchesBegan=null,e.onTouchesMoved=null,e.onTouchesEnded=null,e.onTouchesCancelled=null,e}return _(t,kp),l(t,[{key:"clone",value:function(){var e=new t;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e}},{key:"checkAvailable",value:function(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(cc.logID(1802),!1)}}]),t}(),Bp=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,kp.ACCELERATION,Rp.ACCELERATION,null)))._onAccelerationEvent=null,t._onEvent=function(e){return t._callback(e)},t._onAccelerationEvent=e,t}return _(i,kp),l(i,[{key:"_callback",value:function(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)}},{key:"checkAvailable",value:function(){return cc.assertID(this._onAccelerationEvent,1803),!0}},{key:"clone",value:function(){return new i(this._onAccelerationEvent)}}]),i}(),Lp=function(){function i(){var t;return y(this,i),(t=x(this,g(i).call(this,kp.KEYBOARD,Rp.KEYBOARD,null))).onKeyPressed=null,t.onKeyReleased=null,t._onEvent=function(e){return t._callback(e)},t}return _(i,kp),l(i,[{key:"_callback",value:function(e){e.isPressed?this.onKeyPressed&&this.onKeyPressed(e.keyCode,e):this.onKeyReleased&&this.onKeyReleased(e.keyCode,e)}},{key:"clone",value:function(){var e=new i;return e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e}},{key:"checkAvailable",value:function(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(cc.logID(1800),!1)}}]),i}(),Pp=(cc.EventListener=kp).ListenerID;var Fp=function(){function e(){y(this,e),this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}return l(e,[{key:"size",value:function(){return this._fixedListeners.length+this._sceneGraphListeners.length}},{key:"empty",value:function(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}},{key:"push",value:function(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)}},{key:"clearSceneGraphListeners",value:function(){this._sceneGraphListeners.length=0}},{key:"clearFixedListeners",value:function(){this._fixedListeners.length=0}},{key:"clear",value:function(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}},{key:"getFixedPriorityListeners",value:function(){return this._fixedListeners}},{key:"getSceneGraphPriorityListeners",value:function(){return this._sceneGraphListeners}}]),e}();var zp=m4("eventManager",new(function(){function e(){y(this,e),this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners=[],this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[]}return l(e,[{key:"pauseTarget",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;if(e instanceof cc._BaseNode){var n=this._nodeListenersMap[e.uuid];if(n)for(var r=0;r<n.length;++r){n[r]._setPaused(!0)}if(!0===i){var a=e.children;if(a)for(var s=0;s<a.length;++s){var o=a[s];this.pauseTarget(o,!0)}}}else cc.warnID(3506)}},{key:"resumeTarget",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;if(e instanceof cc._BaseNode){var n=this._nodeListenersMap[e.uuid];if(n)for(var r=0;r<n.length;++r){n[r]._setPaused(!1)}if(this._setDirtyForNode(e),!0===i&&0<e.children.length){var a=e.children;if(a)for(var s=0;s<a.length;++s){var o=a[s];this.resumeTarget(o,!0)}}}else cc.warnID(3506)}},{key:"frameUpdateListeners",value:function(){var e=this._listenersMap,t=this._priorityDirtyFlagMap;for(var i in e)e[i].empty()&&(delete t[i],delete e[i]);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,a=n.length;r<a;r++)this._forceAddEventListener(n[r]);n.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}},{key:"hasEventListener",value:function(e){return!!this._getListeners(e)}},{key:"addListener",value:function(e,t){if(cc.assertID(e&&t,3503),cc.js.isNumber(t)||t instanceof cc._BaseNode){if(e instanceof cc.EventListener){if(e._isRegistered())return void cc.logID(3505)}else cc.assertID(!cc.js.isNumber(t),3504),e=cc.EventListener.create(e);if(e.checkAvailable()){if(cc.js.isNumber(t)){if(0===t)return void cc.logID(3500);e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else{if(!function(e){for(;e;){if(e.getComponent("cc.CanvasComponent"))return!0;e=e.parent}return!1}(t))return void cc.logID(3512);e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e)}return e}}else cc.warnID(3506)}},{key:"addCustomListener",value:function(e,t){var i=kp.create({event:cc.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(i,1),i}},{key:"removeListener",value:function(e){if(null!=e){var t=!1,i=this._listenersMap;for(var n in i){var r=i[n],a=r.getFixedPriorityListeners(),s=r.getSceneGraphPriorityListeners();if((t=this._removeListenerInVector(s,e))?this._setDirty(e._getListenerID(),2):(t=this._removeListenerInVector(a,e))&&this._setDirty(e._getListenerID(),1),r.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete i[n]),t)break}if(!t)for(var o=this._toAddedListeners,l=o.length-1;0<=l;l--){var u=o[l];if(u===e){cc.js.array.removeAt(o,l),u._setRegistered(!1);break}}}}},{key:"removeListeners",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;if(cc.js.isNumber(e)||e instanceof cc._BaseNode)if(void 0!==e._id){var n=this._nodeListenersMap[e._id];if(n){for(var r=cc.js.array.copy(n),a=0;a<r.length;++a){var s=r[a];this.removeListener(s)}delete this._nodeListenersMap[e._id]}for(var o=this._toAddedListeners,l=0;l<o.length;){var u=o[l];u._getSceneGraphPriority()===e?(u._setSceneGraphPriority(null),u._setRegistered(!1),o.splice(l,1)):++l}if(!0===i)for(var c=e.getChildren(),h=0;h<c.length;++h){var f=c[h];this.removeListeners(f,!0)}}else e===cc.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(Pp.TOUCH_ONE_BY_ONE):e===cc.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(Pp.TOUCH_ALL_AT_ONCE):e===cc.EventListener.MOUSE?this._removeListenersForListenerID(Pp.MOUSE):e===cc.EventListener.ACCELERATION?this._removeListenersForListenerID(Pp.ACCELERATION):e===cc.EventListener.KEYBOARD?this._removeListenersForListenerID(Pp.KEYBOARD):cc.logID(3501);else cc.warnID(3506)}},{key:"removeCustomListeners",value:function(e){this._removeListenersForListenerID(e)}},{key:"removeAllListeners",value:function(){var e=this._listenersMap,t=this._internalCustomListenerIDs;for(var i in e)-1===t.indexOf(i)&&this._removeListenersForListenerID(i)}},{key:"setPriority",value:function(e,t){if(null!=e){var i=this._listenersMap;for(var n in i){var r=i[n].getFixedPriorityListeners();if(r)if(-1!==r.indexOf(e))return null!=e._getSceneGraphPriority()&&cc.logID(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),1)))}}}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}},{key:"dispatchEvent",value:function(e){if(this._isEnabled)if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,e&&e.getType){if(e.getType().startsWith(cc.Event.TOUCH))return this._dispatchTouchEvent(e),void this._inDispatch--;var t=function(e){var t=tl,i=e.type;return i===t.ACCELERATION?Pp.ACCELERATION:i===t.KEYBOARD?Pp.KEYBOARD:i.startsWith(t.MOUSE)?Pp.MOUSE:(i.startsWith(t.TOUCH)&&cc.logID(2e3),"")}(e);this._sortEventListeners(t);var i=this._listenersMap[t];null!=i&&(this._dispatchEventToListeners(i,this._onListenerCallback,e),this._onUpdateListeners(i)),this._inDispatch--}else cc.errorID(3511)}},{key:"_onListenerCallback",value:function(e,t){t.currentTarget=e._target;var i=e.onEvent;return i&&i(t),t.isStopped()}},{key:"dispatchCustomEvent",value:function(e,t){var i=new cc.Event.EventCustom(e);i.setUserData(t),this.dispatchEvent(i)}},{key:"_setDirtyForNode",value:function(e){var t=this._nodeListenersMap[e._id];if(void 0!==t)for(var i=0,n=t.length;i<n;i++){var r=t[i]._getListenerID();null==this._dirtyListeners[r]&&(this._dirtyListeners[r]=!0)}if(0<e.children.length)for(var a=e.children,s=0,o=a?a.length:0;s<o;s++)this._setDirtyForNode(a[s])}},{key:"_addListener",value:function(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)}},{key:"_forceAddEventListener",value:function(e){var t=e._getListenerID(),i=this._listenersMap[t];if(i||(i=new Fp,this._listenersMap[t]=i),i.push(e),0===e._getFixedPriority()){this._setDirty(t,2);var n=e._getSceneGraphPriority();null===n&&cc.logID(3507),this._associateNodeAndEventListener(n,e),n.activeInHierarchy&&this.resumeTarget(n)}else this._setDirty(t,1)}},{key:"_getListeners",value:function(e){return this._listenersMap[e]}},{key:"_updateDirtyFlagForSceneGraph",value:function(){var e=this._dirtyListeners;for(var t in e)this._setDirty(t,2);this._dirtyListeners.length=0}},{key:"_removeAllListenersInVector",value:function(e){if(e)for(var t,i=e.length-1;0<=i;i--)(t=e[i])._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch&&cc.js.array.removeAt(e,i)}},{key:"_removeListenersForListenerID",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners(),n=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(n),this._removeAllListenersInVector(i),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}for(var r=this._toAddedListeners,a=r.length-1;0<=a;a--){var s=r[a];s&&s._getListenerID()===e&&cc.js.array.removeAt(r,a)}}},{key:"_sortEventListeners",value:function(e){var t=0,i=this._priorityDirtyFlagMap;i[e]&&(t=i[e]),0!==t&&(i[e]=0,1&t&&this._sortListenersOfFixedPriority(e),2&t&&cc.director.getScene()&&this._sortListenersOfSceneGraphPriority(e))}},{key:"_sortListenersOfSceneGraphPriority",value:function(e){var t=this._getListeners(e);if(t){var i=t.getSceneGraphPriorityListeners();i&&0!==i.length&&t.getSceneGraphPriorityListeners().sort(this._sortEventListenersOfSceneGraphPriorityDes)}}},{key:"_sortEventListenersOfSceneGraphPriorityDes",value:function(e,t){var i=e._getSceneGraphPriority(),n=t._getSceneGraphPriority();if(!(t&&n&&n._activeInHierarchy))return-1;if(!e||!i||!i._activeInHierarchy)return 1;for(var r=i,a=n,s=!1;r.parent._id!==a.parent._id;)r=null===r.parent.parent?(s=!0)&&n:r.parent,a=null===a.parent.parent?(s=!0)&&i:a.parent;if(r._id===a._id){if(r._id===n._id)return-1;if(r._id===i._id)return 1}var o=r.getSiblingIndex(),l=a.getSiblingIndex();return s?o-l:l-o}},{key:"_sortListenersOfFixedPriority",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners();if(i&&0!==i.length){i.sort(this._sortListenersOfFixedPriorityAsc);for(var n=0,r=i.length;n<r&&!(0<=i[n]._getFixedPriority());)++n;t.gt0Index=n}}}},{key:"_sortListenersOfFixedPriorityAsc",value:function(e,t){return e._getFixedPriority()-t._getFixedPriority()}},{key:"_onUpdateListeners",value:function(e){var t=e.getFixedPriorityListeners(),i=e.getSceneGraphPriorityListeners(),n=this._toRemovedListeners;if(i)for(var r=i.length-1;0<=r;r--){var a=i[r];if(!a._isRegistered()){cc.js.array.removeAt(i,r);var s=n.indexOf(a);-1!==s&&n.splice(s,1)}}if(t)for(var o=t.length-1;0<=o;o--){var l=t[o];if(!l._isRegistered()){cc.js.array.removeAt(t,o);var u=n.indexOf(l);-1!==u&&n.splice(u,1)}}i&&0===i.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()}},{key:"_updateTouchListeners",value:function(e){var t=this._inDispatch;if(cc.assertID(0<t,3508),!(1<t)){var i;(i=this._listenersMap[Pp.TOUCH_ONE_BY_ONE])&&this._onUpdateListeners(i),(i=this._listenersMap[Pp.TOUCH_ALL_AT_ONCE])&&this._onUpdateListeners(i),cc.assertID(1===t,3509);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,a=n.length;r<a;r++)this._forceAddEventListener(n[r]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}}},{key:"_cleanToRemovedListeners",value:function(){for(var e=this._toRemovedListeners,t=0;t<e.length;++t){var i=e[t],n=this._listenersMap[i._getListenerID()];if(n){var r=n.getFixedPriorityListeners(),a=n.getSceneGraphPriorityListeners();if(a){var s=a.indexOf(i);-1!==s&&a.splice(s,1)}if(r){var o=r.indexOf(i);-1!==o&&r.splice(o,1)}}}e.length=0}},{key:"_onTouchEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=i.touch;i.currentTarget=e._getSceneGraphPriority();var r=!1,a=-1,s=i.getEventCode();return s===Ep.BEGAN?e.onTouchBegan&&(r=e.onTouchBegan(n,i))&&e._isRegistered()&&e._claimedTouches.push(n):0<e._claimedTouches.length&&-1!==(a=e._claimedTouches.indexOf(n))&&(r=!0,s===Ep.MOVED&&e.onTouchMoved?e.onTouchMoved(n,i):s===Ep.ENDED?(e.onTouchEnded&&e.onTouchEnded(n,i),e._isRegistered()&&e._claimedTouches.splice(a,1)):s===Ep.CANCELLED&&(e.onTouchCancelled&&e.onTouchCancelled(n,i),e._isRegistered()&&e._claimedTouches.splice(a,1))),i.isStopped()?(zp._updateTouchListeners(i),!0):!!(r&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(n,1),!0)}},{key:"_dispatchTouchEvent",value:function(e){this._sortEventListeners(Pp.TOUCH_ONE_BY_ONE),this._sortEventListeners(Pp.TOUCH_ALL_AT_ONCE);var t=this._getListeners(Pp.TOUCH_ONE_BY_ONE),i=this._getListeners(Pp.TOUCH_ALL_AT_ONCE);if(null!==t||null!==i){var n=e.getTouches(),r=cc.js.array.copy(n),a={event:e,needsMutableSet:t&&i,touches:r,selTouch:null};if(t)for(var s=0;s<n.length;++s){var o=n[s];e.touch=o,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,a)}i&&0<r.length&&(this._dispatchEventToListeners(i,this._onTouchesEventCallback,{event:e,touches:r}),e.isStopped())||this._updateTouchListeners(e)}}},{key:"_onTouchesEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=t.touches,r=i.getEventCode();return i.currentTarget=e._getSceneGraphPriority(),r===Ep.BEGAN&&e.onTouchesBegan?e.onTouchesBegan(n,i):r===Ep.MOVED&&e.onTouchesMoved?e.onTouchesMoved(n,i):r===Ep.ENDED&&e.onTouchesEnded?e.onTouchesEnded(n,i):r===Ep.CANCELLED&&e.onTouchesCancelled&&e.onTouchesCancelled(n,i),!!i.isStopped()&&(zp._updateTouchListeners(i),!0)}},{key:"_associateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i||(i=[],this._nodeListenersMap[e.uuid]=i),i.push(t)}},{key:"_dissociateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i&&(cc.js.array.remove(i,t),0===i.length&&delete this._nodeListenersMap[e.uuid])}},{key:"_dispatchEventToListeners",value:function(e,t,i){var n=!1,r=e.getFixedPriorityListeners(),a=e.getSceneGraphPriorityListeners(),s=0;if(r&&0!==r.length)for(;s<e.gt0Index;++s){var o=r[s];if(o.isEnabled()&&!o._isPaused()&&o._isRegistered()&&t(o,i)){n=!0;break}}if(a&&!n)for(var l=0;l<a.length;++l){var u=a[l];if(u.isEnabled()&&!u._isPaused()&&u._isRegistered()&&t(u,i)){n=!0;break}}if(r&&!n)for(;s<r.length;++s){var c=r[s];if(c.isEnabled()&&!c._isPaused()&&c._isRegistered()&&t(c,i)){n=!0;break}}}},{key:"_setDirty",value:function(e,t){var i=this._priorityDirtyFlagMap;null==i[e]?i[e]=t:i[e]=t|i[e]}},{key:"_sortNumberAsc",value:function(e,t){return e-t}},{key:"_removeListenerInCallback",value:function(e,t){if(null==e)return!1;for(var i=e.length-1;0<=i;i--){var n=e[i];if(n._onCustomEvent===t||n.onEvent===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1}},{key:"_removeListenerInVector",value:function(e,t){if(null==e)return!1;for(var i=e.length-1;0<=i;i--){var n=e[i];if(n===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1}}]),e}()));cc.eventManager=zp;var Dp=new Ii,Np=m4("Touch",function(){function n(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;y(this,n),this._point=new Ii,this._prevPoint=new Ii,this._lastModified=0,this._id=null,this._startPoint=new Ii,this._startPointCaptured=!1,this.setTouchInfo(i,e,t)}return l(n,[{key:"getLocation",value:function(e){return(e=e||new Ii).set(this._point.x,this._point.y),e}},{key:"getLocationX",value:function(){return this._point.x}},{key:"getLocationY",value:function(){return this._point.y}},{key:"getUILocation",value:function(e){return(e=e||new Ii).set(this._point.x,this._point.y),cc.view._convertPointWithScale(e),e}},{key:"getUILocationX",value:function(){var e=cc.view.getViewportRect();return(this._point.x-e.x)/cc.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=cc.view.getViewportRect();return(this._point.y-e.y)/cc.view.getScaleY()}},{key:"getPreviousLocation",value:function(e){return(e=e||new Ii).set(this._prevPoint.x,this._prevPoint.y),e}},{key:"getUIPreviousLocation",value:function(e){return(e=e||new Ii).set(this._prevPoint.x,this._prevPoint.y),cc.view._convertPointWithScale(e),e}},{key:"getStartLocation",value:function(e){return(e=e||new Ii).set(this._startPoint.x,this._startPoint.y),e}},{key:"getUIStartLocation",value:function(e){return(e=e||new Ii).set(this._startPoint.x,this._startPoint.y),cc.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return(e=e||new Ii).set(this._point),e.subtract(this._prevPoint),e}},{key:"getUIDelta",value:function(e){return e=e||new Ii,Dp.set(this._point),Dp.subtract(this._prevPoint),e.set(cc.view.getScaleX(),cc.view.getScaleY()),Ii.divide(e,Dp,e),e}},{key:"getLocationInView",value:function(e){return(e=e||new Ii).set(this._point.x,cc.view._designResolutionSize.height-this._point.y),e}},{key:"getPreviousLocationInView",value:function(e){return(e=e||new Ii).set(this._prevPoint.x,cc.view._designResolutionSize.height-this._prevPoint.y),e}},{key:"getStartLocationInView",value:function(e){return(e=e||new Ii).set(this._startPoint.x,cc.view._designResolutionSize.height-this._startPoint.y),e}},{key:"getID",value:function(){return this._id}},{key:"setTouchInfo",value:function(e,t,i){var n=0<arguments.length&&void 0!==e?e:null,r=1<arguments.length?t:void 0,a=2<arguments.length?i:void 0;this._prevPoint=this._point,this._point=new Ii(r||0,a||0),this._id=n,this._startPointCaptured||(this._startPoint=new Ii(this._point),this._startPointCaptured=!0)}},{key:"_setPoint",value:function(e,t){"object"===be(e)?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0)}},{key:"_setPrevPoint",value:function(e,t){"object"===be(e)?this._prevPoint=new Ii(e.x,e.y):this._prevPoint=new Ii(e||0,t||0)}}]),n}());cc.Touch=Np;function Up(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;y(this,Up),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=i,this.timestamp=n}var Vp,Gp,Hp,Wp=Wl.TOUCH_TIMEOUT,qp=new Ii,jp=new Ii,Xp=new(function(){function e(){y(this,e),this._mousePressed=!1,this._isRegisterEvent=!1,this._preTouchPoint=new Ii,this._prevMousePoint=new Ii,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._accelEnabled=!1,this._accelInterval=.2,this._accelMinus=1,this._accelCurTime=0,this._acceleration=null,this._accelDeviceEvent=null,this._glView=null,this._minus=0,this._pointLocked=!1}return l(e,[{key:"handleTouchesBegin",value:function(e){for(var t=[],i=this._touchesIntegerDict,n=fl.now(),r=0;r<e.length;++r){var a=e[r],s=a.getID();if(null!==s)if(void 0===i[s]){var o=this._getUnUsedIndex();if(-1===o){cc.logID(2300,o);continue}var l=new Np(a._point.x,a._point.y,a.getID());(this._touches[o]=l)._lastModified=n,l._setPrevPoint(a._prevPoint),i[s]=o,t.push(l)}}if(0<t.length){var u=new Ep(t);u._eventCode=Ep.BEGAN,zp.dispatchEvent(u)}}},{key:"handleTouchesMove",value:function(e){for(var t=[],i=this._touches,n=fl.now(),r=0;r<e.length;++r){var a=e[r],s=a.getID();if(null!==s){var o=this._touchesIntegerDict[s];void 0!==o&&i[o]&&(i[o]._setPoint(a._point),i[o]._setPrevPoint(a._prevPoint),i[o]._lastModified=n,t.push(i[o]))}}if(0<t.length){var l=new Ep(t);l._eventCode=Ep.MOVED,zp.dispatchEvent(l)}}},{key:"handleTouchesEnd",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(0<t.length){var i=new Ep(t);i._eventCode=Ep.ENDED,zp.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"handleTouchesCancel",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(0<t.length){var i=new Ep(t);i._eventCode=Ep.CANCELLED,zp.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"getSetOfTouchesEndOrCancel",value:function(e){for(var t=[],i=this._touches,n=this._touchesIntegerDict,r=0;r<e.length;++r){var a=e[r],s=a.getID();if(null!==s){var o=n[s];void 0!==o&&i[o]&&(i[o]._setPoint(a._point),i[o]._setPrevPoint(a._prevPoint),t.push(i[o]),this._removeUsedIndexBit(o),delete n[s])}}return t}},{key:"getHTMLElementPosition",value:function(e){if(fl.platform===fl.WECHAT_GAME)return{left:0,top:0,width:window.innerWidth,height:window.innerHeight};var t=document.documentElement,i=window.pageXOffset-t.clientLeft,n=window.pageYOffset-t.clientTop;if(e.getBoundingClientRect){var r=e.getBoundingClientRect();return{left:r.left+i,top:r.top+n,width:r.width,height:r.height}}return e instanceof HTMLCanvasElement?{left:i,top:n,width:e.width,height:e.height}:{left:i,top:n,width:parseInt(e.style.width||"0",void 0),height:parseInt(e.style.height||"0",void 0)}}},{key:"getPreTouch",value:function(e){for(var t=null,i=this._preTouchPool,n=e.getID(),r=i.length-1;0<=r;r--)if(i[r].getID()===n){t=i[r];break}return t=t||e}},{key:"setPreTouch",value:function(e){for(var t=!1,i=this._preTouchPool,n=e.getID(),r=i.length-1;0<=r;r--)if(i[r].getID()===n){i[r]=e,t=!0;break}t||(i.length<=50?i.push(e):(i[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}},{key:"getTouchByXY",value:function(e,t,i,n){var r=this._preTouchPoint,a=this._glView.convertToLocationInView(t,i,n);this._pointLocked&&(a.x=r.x+e.movementX,a.y=r.y-e.movementY);var s=new Np(a.x,a.y,0);return s._setPrevPoint(r.x,r.y),r.x=a.x,r.y=a.y,s}},{key:"getMouseEvent",value:function(e,t,i){var n=this._prevMousePoint,r=new wp(i);return r._setPrevCursor(n.x,n.y),n.x=e.x,n.y=e.y,this._glView._convertMouseToLocation(n,t),r.setLocation(n.x,n.y),r}},{key:"getPointByEvent",value:function(e,t){return null!=e.pageX?{x:e.pageX,y:e.pageY}:(fl.platform===fl.WECHAT_GAME?(t.left=0,t.top=0):(t.left-=document.body.scrollLeft,t.top-=document.body.scrollTop),{x:e.clientX,y:e.clientY})}},{key:"getTouchesByEvent",value:function(e,t){for(var i=[],n=this._glView,r=this._preTouchPoint,a=e.changedTouches.length,s=0;s<a;s++){var o=e.changedTouches[s];if(o){var l=void 0;l=fl.BROWSER_TYPE_FIREFOX===fl.browserType?n.convertToLocationInView(o.pageX,o.pageY,t,qp):n.convertToLocationInView(o.clientX,o.clientY,t,qp);var u=void 0;null!=o.identifier?(u=new Np(l.x,l.y,o.identifier),this.getPreTouch(u).getLocation(jp),u._setPrevPoint(jp.x,jp.y),this.setPreTouch(u)):(u=new Np(l.x,l.y))._setPrevPoint(r.x,r.y),r.x=l.x,r.y=l.y,i.push(u)}}return i}},{key:"registerSystemEvent",value:function(e){if(!this._isRegisterEvent&&e){this._glView=cc.view;var t=fl.isMobile,i="mouse"in fl.capabilities,n="touches"in fl.capabilities;fl.platform===fl.WECHAT_GAME&&(i=!(n=!(t=!1))),i&&this._registerMouseEvents(e,t),window.navigator.msPointerEnabled&&this._registerMousePointerEvents(e),n&&this._registerTouchEvents(e),cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB&&this._registerKeyboardEvent(),this._isRegisterEvent=!0}}},{key:"setAccelerometerEnabled",value:function(e){if(this._accelEnabled!==e){this._accelEnabled=e;var t=cc.director.getScheduler();t.enableForTarget(this),this._accelEnabled?(this._registerAccelerometerEvent(),this._accelCurTime=0,t.scheduleUpdate(this)):(this._unregisterAccelerometerEvent(),this._accelCurTime=0,t.unscheduleUpdate(this))}}},{key:"didAccelerate",value:function(e){if(this._accelEnabled){var t=this._acceleration,i=0,n=0,r=0;if(this._accelDeviceEvent===window.DeviceMotionEvent){var a=e.accelerationIncludingGravity;a&&(i=this._accelMinus*(a.x||0)*.1,n=this._accelMinus*(a.y||0)*.1,r=.1*(a.z||0))}else{var s=e;i=(s.gamma||0)/90*.981,n=-(s.beta||0)/90*.981,r=(s.alpha||0)/90*.981}if(cc.view._isRotated){var o=i;i=-n,n=o}t.x=i,t.y=n,t.z=r,t.timestamp=e.timeStamp||Date.now();var l=t.x;90===window.orientation?(t.x=-t.y,t.y=l):-90===window.orientation?(t.x=t.y,t.y=-l):180===window.orientation&&(t.x=-t.x,t.y=-t.y),cc.sys.os===cc.sys.OS_ANDROID&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_MOBILE_QQ&&(t.x=-t.x,t.y=-t.y)}}},{key:"update",value:function(e){this._accelCurTime>this._accelInterval&&(this._accelCurTime-=this._accelInterval,zp.dispatchEvent(new Ap(this._acceleration))),this._accelCurTime+=e}},{key:"setAccelerometerInterval",value:function(e){this._accelInterval!==e&&(this._accelInterval=e)}},{key:"_getUnUsedIndex",value:function(){for(var e=this._indexBitsUsed,t=cc.sys.now(),i=0;i<this._maxTouches;i++){if(!(1&e))return this._indexBitsUsed|=1<<i,i;var n=this._touches[i];if(t-n._lastModified>Wp){this._removeUsedIndexBit(i);var r=n.getID();return null!==r&&delete this._touchesIntegerDict[r],i}e>>=1}return-1}},{key:"_removeUsedIndexBit",value:function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}}},{key:"_registerMouseEvents",value:function(e,t){this._registerPointerLockEvent(),t||this._registerWindowMouseEvents(e),this._registerElementMouseEvents(e,t)}},{key:"_registerPointerLockEvent",value:function(){function e(){var e=cc.game.canvas;document.pointerLockElement===e||document.mozPointerLockElement===e?t._pointLocked=!0:t._pointLocked=!1}var t=this;"onpointerlockchange"in document?document.addEventListener("pointerlockchange",e,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",e,!1)}},{key:"_registerWindowMouseEvents",value:function(r){var a=this;window.addEventListener("mousedown",function(){a._mousePressed=!0},!1),window.addEventListener("mouseup",function(e){if(a._mousePressed){a._mousePressed=!1;var t=a.getHTMLElementPosition(r),i=a.getPointByEvent(e,t);if(!$n(t.left,t.top,t.width,t.height).contains(new Ii(i.x,i.y))){a.handleTouchesEnd([a.getTouchByXY(e,i.x,i.y,t)]);var n=a.getMouseEvent(i,t,wp.UP);n.setButton(e.button),zp.dispatchEvent(n)}}},!1)}},{key:"_registerElementMouseEvents",value:function(s,e){function t(e,r,a){s.addEventListener(e,function(e){var t=o.getHTMLElementPosition(s),i=o.getPointByEvent(e,t),n=o.getMouseEvent(i,t,r);n.setButton(e.button),a(e,n,i,t),zp.dispatchEvent(n),e.stopPropagation(),e.preventDefault()})}var o=this;e||(t("mousedown",wp.DOWN,function(e,t,i,n){o._mousePressed=!0,o.handleTouchesBegin([o.getTouchByXY(e,i.x,i.y,n)]),s.focus()}),t("mouseup",wp.UP,function(e,t,i,n){o._mousePressed=!1,o.handleTouchesEnd([o.getTouchByXY(e,i.x,i.y,n)])}),t("mousemove",wp.MOVE,function(e,t,i,n){o.handleTouchesMove([o.getTouchByXY(e,i.x,i.y,n)]),o._mousePressed||t.setButton(null),void 0!==e.movementX&&void 0!==e.movementY&&(t.movementX=e.movementX,t.movementY=e.movementY)})),t("mousewheel",wp.SCROLL,function(e,t,i,n){t.setScrollData(0,e.wheelDelta)}),t("DOMMouseScroll",wp.SCROLL,function(e,t,i,n){t.setScrollData(0,-120*e.detail)})}},{key:"_registerMousePointerEvents",value:function(n){function e(e){var i=t[e];n.addEventListener(e,function(e){var t=r.getHTMLElementPosition(n);t.left-=document.documentElement.scrollLeft,t.top-=document.documentElement.scrollTop,i.call(r,[r.getTouchByXY(e,e.clientX,e.clientY,t)]),e.stopPropagation()},!1)}var r=this,t={MSPointerDown:this.handleTouchesBegin,MSPointerMove:this.handleTouchesMove,MSPointerUp:this.handleTouchesEnd,MSPointerCancel:this.handleTouchesCancel};for(var i in t)e(i)}},{key:"_registerTouchEvents",value:function(e){cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?this._registerWXGameTouchEvents(e):this._registerHTMLTouchEvents(e)}},{key:"_registerWXGameTouchEvents",value:function(r){function e(n){return function(e){var t=a.getHTMLElementPosition(r),i=document.body;t.left-=i.scrollLeft||0,t.top-=i.scrollTop||0,n(a.getTouchesByEvent(e,t))}}var a=this;wx.onTouchStart(e(function(e){a.handleTouchesBegin(e)})),wx.onTouchEnd(e(function(e){a.handleTouchesEnd(e)})),wx.onTouchMove(e(function(e){a.handleTouchesMove(e)})),wx.onTouchCancel(e(function(e){a.handleTouchesCancel(e)}))}},{key:"_registerHTMLTouchEvents",value:function(r){function e(n){return function(e){if(e.changedTouches){var t=a.getHTMLElementPosition(r),i=document.body;t.left-=i.scrollLeft||0,t.top-=i.scrollTop||0,n(a.getTouchesByEvent(e,t)),e.stopPropagation(),e.preventDefault()}}}var a=this;r.addEventListener("touchstart",e(function(e){a.handleTouchesBegin(e),fl.platform!==fl.WECHAT_GAME&&r.focus()}),!1),r.addEventListener("touchmove",e(function(e){a.handleTouchesMove(e)}),!1),r.addEventListener("touchend",e(function(e){a.handleTouchesEnd(e)}),!1),r.addEventListener("touchcancel",e(function(e){a.handleTouchesCancel(e)}),!1)}},{key:"_registerKeyboardEvent",value:function(){var e=cc.game.canvas;e.addEventListener("keydown",function(e){zp.dispatchEvent(new Cp(e,!0)),e.stopPropagation(),e.preventDefault()},!1),e.addEventListener("keyup",function(e){zp.dispatchEvent(new Cp(e,!1)),e.stopPropagation(),e.preventDefault()},!1)}},{key:"_registerAccelerometerEvent",value:function(){var e=this;this._acceleration=new Up,this._accelDeviceEvent=window.DeviceMotionEvent||window.DeviceOrientationEvent,cc.sys.browserType===cc.sys.BROWSER_TYPE_MOBILE_QQ&&(this._accelDeviceEvent=window.DeviceOrientationEvent);var t=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation",i=navigator.userAgent;(/Android/.test(i)||/Adr/.test(i)&&cc.sys.browserType===cc.BROWSER_TYPE_UC)&&(this._minus=-1),Vp=function(){return e.didAccelerate.apply(e,arguments)},window.addEventListener(t,Vp,!1)}},{key:"_unregisterAccelerometerEvent",value:function(){var e=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";Vp&&window.removeEventListener(e,Vp,!1)}}]),e}());pp.on(_p.EVENT_ENGINE_INITED,function(){pp.config.registerSystemEvent&&Xp.registerSystemEvent(pp.canvas)}),cc.internal.inputManager=Xp,(Hp=Gp=Gp||m4("SystemEventType",{})).TOUCH_START="touch-start",Hp.TOUCH_MOVE="touch-move",Hp.TOUCH_END="touch-end",Hp.TOUCH_CANCEL="touch-cancel",Hp.MOUSE_DOWN="mouse-down",Hp.MOUSE_MOVE="mouse-move",Hp.MOUSE_UP="mouse-up",Hp.MOUSE_WHEEL="mouse-wheel",Hp.MOUSE_ENTER="mouse-enter",Hp.MOUSE_LEAVE="mouse-leave",Hp.KEY_DOWN="keydown",Hp.KEY_UP="keyup",Hp.DEVICEMOTION="devicemotion",Hp.TRANSFORM_CHANGED="transform-changed",Hp.POSITION_PART="position-part",Hp.ROTATION_PART="rotation-part",Hp.SCALE_PART="scale-part",Hp.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",Hp.SIZE_CHANGED="size-changed",Hp.ANCHOR_CHANGED="anchor-changed",Hp.CHILD_ADDED="child-added",Hp.CHILD_REMOVED="child-removed",Hp.PARENT_CHANGED="parent-changed",mt(Gp),cc.SystemEventType=Gp;var Yp=null,Kp=null,Qp=null,Zp=null,Jp=m4("SystemEvent",function(){function d(){return y(this,d),x(this,g(d).call(this))}return _(d,cl),l(d,[{key:"setAccelerometerEnabled",value:function(e){Xp.setAccelerometerEnabled(e)}},{key:"setAccelerometerInterval",value:function(e){Xp.setAccelerometerInterval(e)}},{key:"on",value:function(e,t,i){return p(g(d.prototype),"on",this).call(this,e,t,i),e!==Gp.KEY_DOWN&&e!==Gp.KEY_UP||Yp||(Yp=kp.create({event:kp.KEYBOARD,onKeyPressed:function(e,t){t.type=Gp.KEY_DOWN,$p.emit(t.type,t)},onKeyReleased:function(e,t){t.type=Gp.KEY_UP,$p.emit(t.type,t)}}),zp.addListener(Yp,256)),e===Gp.DEVICEMOTION&&(Kp||(Kp=kp.create({event:kp.ACCELERATION,callback:function(e,t){t.type=Gp.DEVICEMOTION,cc.systemEvent.emit(t.type,t)}}),zp.addListener(Kp,256))),e!==Gp.TOUCH_START&&e!==Gp.TOUCH_MOVE&&e!==Gp.TOUCH_END&&e!==Gp.TOUCH_CANCEL||Qp||(Qp=kp.create({event:kp.TOUCH_ONE_BY_ONE,onTouchBegan:function(e,t){return t.type=Gp.TOUCH_START,cc.systemEvent.emit(t.type,e,t),!0},onTouchMoved:function(e,t){t.type=Gp.TOUCH_MOVE,cc.systemEvent.emit(t.type,e,t)},onTouchEnded:function(e,t){t.type=Gp.TOUCH_END,cc.systemEvent.emit(t.type,e,t)},onTouchCancelled:function(e,t){t.type=Gp.TOUCH_CANCEL,cc.systemEvent.emit(t.type,e,t)}}),zp.addListener(Qp,256)),e!==Gp.MOUSE_DOWN&&e!==Gp.MOUSE_MOVE&&e!==Gp.MOUSE_UP&&e!==Gp.MOUSE_WHEEL||Zp||(Zp=kp.create({event:kp.MOUSE,onMouseDown:function(e){e.type=Gp.MOUSE_DOWN,cc.systemEvent.emit(e.type,e)},onMouseMove:function(e){e.type=Gp.MOUSE_MOVE,cc.systemEvent.emit(e.type,e)},onMouseUp:function(e){e.type=Gp.MOUSE_UP,cc.systemEvent.emit(e.type,e)},onMouseScroll:function(e){e.type=Gp.MOUSE_WHEEL,cc.systemEvent.emit(e.type,e)}}),zp.addListener(Zp,256)),t}},{key:"off",value:function(e,t,i){if(p(g(d.prototype),"off",this).call(this,e,t,i),Yp&&(e===Gp.KEY_DOWN||e===Gp.KEY_UP)){var n=this.hasEventListener(Gp.KEY_DOWN),r=this.hasEventListener(Gp.KEY_UP);n||r||(zp.removeListener(Yp),Yp=null)}if(Kp&&e===Gp.DEVICEMOTION&&(zp.removeListener(Kp),Kp=null),Qp&&(e===Gp.TOUCH_START||e===Gp.TOUCH_MOVE||e===Gp.TOUCH_END||e===Gp.TOUCH_CANCEL)){var a=this.hasEventListener(Gp.TOUCH_START),s=this.hasEventListener(Gp.TOUCH_MOVE),o=this.hasEventListener(Gp.TOUCH_END),l=this.hasEventListener(Gp.TOUCH_CANCEL);a||s||o||l||(zp.removeListener(Qp),Qp=null)}if(Zp&&(e===Gp.MOUSE_DOWN||e===Gp.MOUSE_MOVE||e===Gp.MOUSE_UP||e===Gp.MOUSE_WHEEL)){var u=this.hasEventListener(Gp.MOUSE_DOWN),c=this.hasEventListener(Gp.MOUSE_MOVE),h=this.hasEventListener(Gp.MOUSE_UP),f=this.hasEventListener(Gp.MOUSE_WHEEL);u||c||h||f||(zp.removeListener(Zp),Zp=null)}}}]),d}());Jp.EventType=Gp,cc.SystemEvent=Jp;var $p=m4("systemEvent",new Jp);cc.systemEvent=$p;var ev=m4("screen",{_supportsFullScreen:!1,_preOnFullScreenChange:null,_touchEvent:"",_fn:null,_fnMap:[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement"]],init:function(){this._fn={};var e,t,i,n,r=this._fnMap;for(e=0,t=r.length;e<t;e++)if((i=r[e])&&void 0!==document[i[1]]){for(e=0,n=i.length;e<n;e++)this._fn[r[0][e]]=i[e];break}this._supportsFullScreen=void 0!==this._fn.requestFullscreen,this._touchEvent="ontouchstart"in window?"touchstart":"mousedown"},fullScreen:function(){return!!this._supportsFullScreen&&(void 0!==document[this._fn.fullscreenElement]&&null!==document[this._fn.fullscreenElement])},requestFullScreen:function(e,t){if(this._supportsFullScreen){if(e=e||document.documentElement,t){var i=this._fn.fullscreenchange;this._preOnFullScreenChange&&document.removeEventListener(i,this._preOnFullScreenChange),this._preOnFullScreenChange=t,document.addEventListener(i,t,!1)}return e[this._fn.requestFullscreen]()}},exitFullScreen:function(){return!this._supportsFullScreen||document[this._fn.exitFullscreen]()},autoFullScreen:function(t,i){t=t||document.body;var n=cc.game.canvas||t,r=this;this.requestFullScreen(t,i),n.addEventListener(this._touchEvent,function e(){n.removeEventListener(r._touchEvent,e),r.requestFullScreen(t,i)})}});ev.init(),cc.screen=ev;function tv(e,t,i,n){y(this,tv),this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=i,this.markedForDeletion=n}var iv=m4("System",function(){function e(){y(this,e),this._id="",this._priority=0,this._executeInEditMode=!1}return l(e,[{key:"init",value:function(){}},{key:"update",value:function(e){}},{key:"postUpdate",value:function(e){}},{key:"priority",set:function(e){this._priority=e},get:function(){return this._priority}},{key:"id",set:function(e){this._id=e},get:function(){return this._id}}],[{key:"sortByPriority",value:function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0}}]),e}()),nv=new pe("Scheduler");tv.get=function(e,t,i,n){var r=tv._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=i,r.markedForDeletion=n):r=new tv(e,t,i,n),r},tv.put=function(e){tv._listEntries.length<20&&(e.target=null,tv._listEntries.push(e))},tv._listEntries=[];function rv(e,t,i,n){y(this,rv),this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=i,this.callback=n}rv.get=function(e,t,i,n){var r=rv._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=i,r.callback=n):r=new rv(e,t,i,n),r},rv.put=function(e){rv._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,rv._hashUpdateEntries.push(e))},rv._hashUpdateEntries=[];function av(e,t,i,n,r,a){y(this,av),this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=i,this.currentTimer=n,this.currentTimerSalvaged=r,this.paused=a}av.get=function(e,t,i,n,r,a){var s=av._hashTimerEntries.pop();return s?(s.timers=e,s.target=t,s.timerIndex=i,s.currentTimer=n,s.currentTimerSalvaged=r,s.paused=a):s=new av(e,t,i,n,r,a),s},av.put=function(e){av._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,av._hashTimerEntries.push(e))},av._hashTimerEntries=[];var sv=function(){function e(){y(this,e),this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}return l(e,[{key:"initWithCallback",value:function(e,t,i,n,r,a){return this._lock=!1,this._scheduler=e,this._target=i,this._callback=t,this._elapsed=-1,this._interval=n,this._delay=a,this._useDelay=0<this._delay,this._repeat=r,this._runForever=this._repeat===cc.macro.REPEAT_FOREVER,!0}},{key:"getInterval",value:function(){return this._interval}},{key:"setInterval",value:function(e){this._interval=e}},{key:"update",value:function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}},{key:"getCallback",value:function(){return this._callback}},{key:"trigger",value:function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}},{key:"cancel",value:function(){this._scheduler.unschedule(this._callback,this._target)}}]),e}();sv._timers=[],sv.get=function(){return sv._timers.pop()||new sv},sv.put=function(e){sv._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,sv._timers.push(e))};var ov,lv,uv=m4("Scheduler",function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=ke(!0),e._hashForTimers=ke(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}return _(t,iv),l(t,null,[{key:"enableForTarget",value:function(e){var t=!1;e.uuid?t=!0:e.id&&(t=!0),t||(e.__instanceId?cc.warnID(1513):e.id=nv.getNewId())}}]),l(t,[{key:"setTimeScale",value:function(e){this._timeScale=e}},{key:"getTimeScale",value:function(){return this._timeScale}},{key:"update",value:function(e){var t,i,n,r,a;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,n=(i=this._updatesNegList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updates0List).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updatesPosList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);var s=this._arrayForTimers;for(t=0;t<s.length;t++){if(a=s[t],this._currentTarget=a,this._currentTargetSalvaged=!1,!a.paused)for(a.timerIndex=0;a.timerIndex<a.timers.length;++a.timerIndex)a.currentTimer=a.timers[a.timerIndex],a.currentTimerSalvaged=!1,a.currentTimer.update(e),a.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,i=this._updatesNegList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updates0List;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updatesPosList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null}},{key:"schedule",value:function(e,t,i,n,r,a){if("function"!=typeof e){var s=e;e=t,t=s}4!==arguments.length&&5!==arguments.length||(a=!!n,n=cc.macro.REPEAT_FOREVER,r=0),cc.assertID(t,1502);var o=t.uuid||t.id;if(o){var l,u,c=this._hashForTimers[o];if(c?c.paused!==a&&cc.warnID(1511):(c=av.get(null,t,0,null,null,a),this._arrayForTimers.push(c),this._hashForTimers[o]=c),null==c.timers)c.timers=[];else for(u=0;u<c.timers.length;++u)if((l=c.timers[u])&&e===l._callback)return cc.logID(1507,l.getInterval(),i),void(l._interval=i);(l=sv.get()).initWithCallback(this,e,t,i,n,r),c.timers.push(l),this._currentTarget===c&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else cc.errorID(1510)}},{key:"scheduleUpdate",value:function(e,t,i){var n=e.uuid||e.id;if(n){var r=this._hashForUpdates[n];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=i);if(this._updateHashLocked)return cc.logID(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=i);this.unscheduleUpdate(e)}var a,s=tv.get(e,t,i,!1);0===t?(a=this._updates0List,this._appendIn(a,s)):(a=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(a,s,t)),this._hashForUpdates[n]=rv.get(a,s,e,null)}else cc.errorID(1510)}},{key:"unschedule",value:function(e,t){if(t&&e){var i=t.uuid||t.id;if(i){var n=this._hashForTimers[i];if(n)for(var r=n.timers,a=0,s=r.length;a<s;a++){var o=r[a];if(e===o._callback)return o!==n.currentTimer||n.currentTimerSalvaged||(n.currentTimerSalvaged=!0),r.splice(a,1),sv.put(o),n.timerIndex>=a&&n.timerIndex--,void(0===r.length&&(this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)))}}else cc.errorID(1510)}}},{key:"unscheduleUpdate",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForUpdates[t];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}else cc.errorID(1510)}}},{key:"unscheduleAllForTarget",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];if(i){var n=i.timers;-1<n.indexOf(i.currentTimer)&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(var r=0,a=n.length;r<a;r++)sv.put(n[r]);n.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(e)}else cc.errorID(1510)}}},{key:"unscheduleAll",value:function(){this.unscheduleAllWithMinPriority(cc.Scheduler.PRIORITY_SYSTEM)}},{key:"unscheduleAllWithMinPriority",value:function(e){var t,i,n,r=this._arrayForTimers;for(t=r.length-1;0<=t;t--)i=r[t],this.unscheduleAllForTarget(i.target);var a=0;if(e<0)for(t=0;t<this._updatesNegList.length;)a=this._updatesNegList.length,(n=this._updatesNegList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),a===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)a=this._updates0List.length,(n=this._updates0List[t])&&this.unscheduleUpdate(n.target),a===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)a=this._updatesPosList.length,(n=this._updatesPosList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),a===this._updatesPosList.length&&t++}},{key:"isScheduled",value:function(e,t){cc.assertID(e,1508),cc.assertID(t,1509);var i=t.uuid||t.id;if(i){var n=this._hashForTimers[i];if(!n)return!1;if(null==n.timers)return!1;for(var r=n.timers,a=0;a<r.length;++a){if(e===r[a]._callback)return!0}return!1}cc.errorID(1510)}},{key:"pauseAllTargets",value:function(){return this.pauseAllTargetsWithMinPriority(cc.Scheduler.PRIORITY_SYSTEM)}},{key:"pauseAllTargetsWithMinPriority",value:function(e){var t,i,n,r,a=[],s=this._arrayForTimers;for(i=0,n=s.length;i<n;i++)(t=s[i])&&(t.paused=!0,a.push(t.target));if(e<0)for(i=0;i<this._updatesNegList.length;i++)(r=this._updatesNegList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));if(e<=0)for(i=0;i<this._updates0List.length;i++)(r=this._updates0List[i])&&(r.paused=!0,a.push(r.target));for(i=0;i<this._updatesPosList.length;i++)(r=this._updatesPosList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));return a}},{key:"resumeTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])}},{key:"pauseTarget",value:function(e){cc.assertID(e,1503);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!0);var n=this._hashForUpdates[t];n&&(n.entry.paused=!0)}else cc.errorID(1510)}},{key:"resumeTarget",value:function(e){cc.assertID(e,1504);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!1);var n=this._hashForUpdates[t];n&&(n.entry.paused=!1)}else cc.errorID(1510)}},{key:"isTargetPaused",value:function(e){cc.assertID(e,1505);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];if(i)return i.paused;var n=this._hashForUpdates[t];return!!n&&n.entry.paused}cc.errorID(1510)}},{key:"_removeHashElement",value:function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var i=this._arrayForTimers,n=0,r=i.length;n<r;n++)if(i[n]===e){i.splice(n,1);break}av.put(e)}},{key:"_removeUpdateFromHash",value:function(e){var t=e.target.uuid||e.target.id,i=this._hashForUpdates[t];if(i){for(var n=i.list,r=i.entry,a=0,s=n.length;a<s;a++)if(n[a]===r){n.splice(a,1);break}delete this._hashForUpdates[t],tv.put(r),rv.put(i)}}},{key:"_priorityIn",value:function(e,t,i){for(var n=0;n<e.length;n++)if(i<e[n].priority)return void e.splice(n,0,t);e.push(t)}},{key:"_appendIn",value:function(e,t){e.push(t)}}]),t}());function cv(e,t){var i=cc.loader.getItem(e);if(i){var n=i.dependKeys;if(n)for(var r=0;r<n.length;r++){var a=n[r];t[a]||(t[a]=!0,cv(a,t))}}}function hv(e,t){if(e._uuid){var i=cc.loader._getReferenceKey(e);t[i]||(t[i]=!0,cv(i,t))}}function fv(e,t){for(var i=Object.getOwnPropertyNames(e),n=0;n<i.length;n++){var r=e[i[n]];if("object"===be(r)&&r)if(Array.isArray(r))for(var a=0;a<r.length;a++){var s=r[a];s instanceof Gc&&hv(s,t)}else if(r.constructor&&r.constructor!==Object)r instanceof Gc&&hv(r,t);else for(var o=Object.getOwnPropertyNames(r),l=0;l<o.length;l++){var u=r[o[l]];u instanceof Gc&&hv(u,t)}}}function dv(e,t){for(var i=0;i<e._components.length;i++)fv(e._components[i],t);for(var n=0;n<e._children.length;n++)dv(e._children[n],t)}function _v(e){var t={};return cv(e,t),Object.keys(t)}uv.PRIORITY_SYSTEM=1<<31,uv.PRIORITY_NON_SYSTEM=uv.PRIORITY_SYSTEM+1,uv.ID="scheduler",cc.Scheduler=uv,(lv=ov=ov||{})[lv.DIRECTIONAL=0]="DIRECTIONAL",lv[lv.SPHERE=1]="SPHERE",lv[lv.SPOT=2]="SPOT",lv[lv.UNKNOWN=3]="UNKNOWN";function pv(e){return 4*Math.PI*Math.PI*e*e}var vv=function(){function n(e,t,i){y(this,n),this._enabled=!0,this._color=new Ni(1,1,1),this._useColorTemp=!1,this._colorTemp=6550,this._colorTempRGB=new Ni(1,1,1),this._scene=void 0,this._node=void 0,this._type=void 0,this._name=void 0,this._scene=e,this._name=t,this._type=ov.UNKNOWN,this._node=i}return l(n,[{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"color",set:function(e){this._color.set(e)},get:function(){return this._color}},{key:"useColorTemperature",set:function(e){this._useColorTemp=e},get:function(){return this._useColorTemp}},{key:"colorTemperature",set:function(e){this._colorTemp=e,function(e,t){t<1e3?t=1e3:15e3<t&&(t=15e3);var i=t*t,n=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),r=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),a=2*n-8*r+4,s=3*n/a,o=2*r/a,l=1/o*s,u=1/o*(1-s-o);e.x=3.2404542*l-1.5371385+-.4985314*u,e.y=-.969266*l+1.8760108+.041556*u,e.z=.0556434*l-.2040259+1.0572252*u}(this._colorTempRGB,this._colorTemp)},get:function(){return this._colorTemp}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name}}]),l(n,[{key:"update",value:function(){}}]),n}();(mv=new ms).accurate=!0;var mv,yv,gv,bv,xv,Sv,Tv,wv,Ev,Av=function(){var o=new Ni,l=new Ni,u=new fn,c=new ms;c.accurate=!0;var h=new Pn,f=new Pn,d=new Ni,_=new Ni;return function(e,t,i,n,r,a){Pn.fromRT(h,i.node.getWorldRotation(u),t.node.getWorldPosition(o)),Pn.invert(f,h),t.getSplitFrustum(c,n,r),c.transform(f),Ni.set(d,c.vertices[0].x,c.vertices[0].y,c.vertices[0].z),Ni.copy(_,d);for(var s=1;s<c.vertices.length;s++)d.x=Math.min(d.x,c.vertices[s].x),d.y=Math.min(d.y,c.vertices[s].y),d.z=Math.min(d.z,c.vertices[s].z),_.x=Math.max(_.x,c.vertices[s].x),_.y=Math.max(_.y,c.vertices[s].y),_.z=Math.max(_.z,c.vertices[s].z);Ni.set(l,(d.x+_.x)/2,(d.y+_.y)/2,_.z),l.z+=a,Ni.transformMat4(o,l,h),Pn.fromRT(h,i.node.getWorldRotation(u),o),ms.createOrtho(e,_.x-d.x,_.y-d.y,0,d.z-a-_.z,h)}}(),Cv=function(){function t(e){y(this,t),this._device=void 0,this._pipeline=void 0,this._name="",this._priority=0,this._stages=[],this._material=new F_,this._device=e.device,this._pipeline=e}return l(t,[{key:"device",get:function(){return this._device}},{key:"pipeline",get:function(){return this._pipeline}},{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"stages",get:function(){return this._stages}},{key:"material",get:function(){return this._material}}]),l(t,[{key:"resize",value:function(e,t){var i=this._stages,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.resize(e,t)}}},{key:"render",value:function(e){var t=this._stages,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.render(e)}}},{key:"createStage",value:function(e,t){var i=new e(this);return i.initialize(t)?(this._stages.push(i),this._stages.sort(function(e,t){return e.priority-t.priority}),i):null}},{key:"destroyStages",value:function(){var e=this._stages,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._stages=[]}}]),t}(),kv=function(){function t(e){if(y(this,t),this._flow=void 0,this._pipeline=void 0,this._device=void 0,this._name="",this._priority=0,this._framebuffer=null,this._cmdBuff=null,this._clearColors=void 0,this._clearDepth=1,this._clearStencil=0,this._renderArea=void 0,this._pass=null,this._pso=null,this._flow=e,this._pipeline=e.pipeline,this._device=e.device,!this._flow.pipeline.root.device)throw new Error("");this._device=this._flow.pipeline.root.device,this._clearColors=[{r:.3,g:.6,b:.9,a:1}],this._renderArea={x:0,y:0,width:0,height:0}}return l(t,[{key:"flow",get:function(){return this._flow}},{key:"pipeline",get:function(){return this._pipeline}},{key:"priority",get:function(){return this._priority}},{key:"framebuffer",get:function(){return this._framebuffer}}]),l(t,[{key:"setClearColor",value:function(e){0<this._clearColors.length?this._clearColors[0]=e:this._clearColors.push(e)}},{key:"setClearColors",value:function(e){this._clearColors=e}},{key:"setClearDepth",value:function(e){this._clearDepth=e}},{key:"setClearStencil",value:function(e){this._clearStencil=e}},{key:"setRenderArea",value:function(e,t){this._renderArea.width=e,this._renderArea.height=t}}]),t}(),Rv=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._hTexSampler=0,t._hBlendTexSampler=0,t._bindingLayout=null,t}return _(i,kv),l(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,void 0!==e.framebuffer&&(this._framebuffer=e.framebuffer),this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:Qu.PRIMARY}),this.rebuild(),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){this._pass=this._flow.material.passes[0],this._hTexSampler=this._pass.getBinding("u_texSampler");var e=this._pipeline.globalBindings.get(Af.BLOCK.name);this._pso=this._pass.createPipelineState(),this._bindingLayout=this._pso.pipelineLayout.layouts[0],this._pass.bindBuffer(Af.BLOCK.binding,e.buffer),this._pass.bindTextureView(this._hTexSampler,this._pipeline.curShadingTexView),this._pipeline.useSMAA&&(this._hBlendTexSampler=this._pass.getBinding("u_blendTexSampler"),this._pass.bindTextureView(this._hBlendTexSampler,this._pipeline.smaaBlendTexView)),this._pass.update(),this._bindingLayout.update()}},{key:"render",value:function(e){var t=e.camera;if(this._cmdBuff){this._renderArea.width=t.width,this._renderArea.height=t.height;var i=e.window.framebuffer;this._cmdBuff.begin(),this._cmdBuff.beginRenderPass(i,this._renderArea,dc.ALL,[{r:0,g:0,b:0,a:1}],1,0),this._cmdBuff.bindPipelineState(this._pso),this._cmdBuff.bindBindingLayout(this._pso.pipelineLayout.layouts[0]),this._cmdBuff.bindInputAssembler(this._pipeline.quadIA),this._cmdBuff.draw(this._pipeline.quadIA),this._cmdBuff.endRenderPass(),this._cmdBuff.end()}this._device.queue.submit([this._cmdBuff])}}]),i}(),Ov=function(){function t(e){return y(this,t),x(this,g(t).call(this,e))}return _(t,Cv),l(t,[{key:"initialize",value:function(e){void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this._material.initialize({effectName:"pipeline/tonemap",defines:{CC_USE_SMAA:this._pipeline.useSMAA}});var t=this._pipeline.root.mainWindow.framebuffer;return this.createStage(Rv,{name:"ToneMapStage",priority:0,framebuffer:t}),!0}},{key:"destroy",value:function(){this._material&&this._material.destroy(),this.destroyStages()}},{key:"rebuild",value:function(){this._material&&(this._material.destroy(),this._material.initialize({effectName:"pipeline/tonemap",defines:{CC_USE_SMAA:this._pipeline.useSMAA}}));var e=this._stages,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.rebuild()}}}]),t}();(gv=yv=yv||{})[gv.ORTHO=0]="ORTHO",gv[gv.PERSPECTIVE=1]="PERSPECTIVE",(xv=bv=bv||{})[xv.F1_8=0]="F1_8",xv[xv.F2_0=1]="F2_0",xv[xv.F2_2=2]="F2_2",xv[xv.F2_5=3]="F2_5",xv[xv.F2_8=4]="F2_8",xv[xv.F3_2=5]="F3_2",xv[xv.F3_5=6]="F3_5",xv[xv.F4_0=7]="F4_0",xv[xv.F4_5=8]="F4_5",xv[xv.F5_0=9]="F5_0",xv[xv.F5_6=10]="F5_6",xv[xv.F6_3=11]="F6_3",xv[xv.F7_1=12]="F7_1",xv[xv.F8_0=13]="F8_0",xv[xv.F9_0=14]="F9_0",xv[xv.F10_0=15]="F10_0",xv[xv.F11_0=16]="F11_0",xv[xv.F13_0=17]="F13_0",xv[xv.F14_0=18]="F14_0",xv[xv.F16_0=19]="F16_0",xv[xv.F18_0=20]="F18_0",xv[xv.F20_0=21]="F20_0",xv[xv.F22_0=22]="F22_0",(Tv=Sv=Sv||{})[Tv.ISO100=0]="ISO100",Tv[Tv.ISO200=1]="ISO200",Tv[Tv.ISO400=2]="ISO400",Tv[Tv.ISO800=3]="ISO800",(Ev=wv=wv||{})[Ev.D1=0]="D1",Ev[Ev.D2=1]="D2",Ev[Ev.D4=2]="D4",Ev[Ev.D8=3]="D8",Ev[Ev.D15=4]="D15",Ev[Ev.D30=5]="D30",Ev[Ev.D60=6]="D60",Ev[Ev.D125=7]="D125",Ev[Ev.D250=8]="D250",Ev[Ev.D500=9]="D500",Ev[Ev.D1000=10]="D1000",Ev[Ev.D2000=11]="D2000",Ev[Ev.D4000=12]="D4000";var Mv=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],Iv=[1,.5,.25,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,25e-5],Bv=[100,200,400,800],Lv=new Ni,Pv=new Ni,Fv=new Pn,zv=new Pn,Dv=dc.STENCIL<<1,Nv=function(){function i(e,t){y(this,i),this._scene=void 0,this._name=void 0,this._enabled=!1,this._proj=void 0,this._isWindowSize=!0,this._width=void 0,this._height=void 0,this._screenScale=void 0,this._aspect=void 0,this._orthoHeight=10,this._fov=yi(45),this._nearClip=1,this._farClip=1e3,this._clearStencil=0,this._clearDepth=1,this._clearFlag=dc.NONE,this._clearColor={r:0,g:0,b:0,a:0},this._viewport=new Jn(0,0,1,1),this._isProjDirty=!0,this._matView=new Pn,this._matProj=new Pn,this._matProjInv=new Pn,this._matViewProj=new Pn,this._matViewProjInv=new Pn,this._frustum=new ms,this._forward=new Ni,this._position=new Ni,this._node=null,this._view=void 0,this._visibility=Pf,this._priority=0,this._aperture=bv.F16_0,this._apertureValue=void 0,this._shutter=wv.D125,this._shutterValue=0,this._iso=Sv.ISO100,this._isoValue=0,this._ec=0,this._exposure=0,this._scene=e,this._name=t.name,this._node=t.node,this._proj=t.projection,this._priority=t.priority||0,this._apertureValue=Mv[this._aperture],this._shutterValue=Iv[this._shutter],this._isoValue=Bv[this._iso],this.updateExposure(),this._aspect=this._width=this._height=this._screenScale=1,this._view=this._scene.root.createView({camera:this,name:this._name,priority:this._priority,flows:t.flows}),this.changeTargetWindow(t.window),console.log("Create Camera: "+this._name+" "+this._width+" x "+this._height)}return l(i,[{key:"destroy",value:function(){this._scene.root.destroyView(this._view)}},{key:"resize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width/this._height,this._isProjDirty=!0}},{key:"setFixedSize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width/this._height,this._isWindowSize=!1}},{key:"update",value:function(e){var t=0<arguments.length&&void 0!==e&&e;if(this._node){if((this._node.hasChangedFlags||t)&&(Pn.invert(this._matView,this.node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position)),this._isProjDirty){if(this._proj===yv.PERSPECTIVE)Pn.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip);else{var i=this._orthoHeight*this._aspect,n=this._orthoHeight;Pn.ortho(this._matProj,-i,i,-n,n,this._nearClip,this._farClip)}Pn.invert(this._matProjInv,this._matProj)}(this._node.hasChangedFlags||this._isProjDirty||t)&&(Pn.multiply(this._matViewProj,this._matProj,this._matView),Pn.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv)),this._isProjDirty=!1}}},{key:"getSplitFrustum",value:function(e,t,i){if(this._node){if(t=Math.max(t,this._nearClip),i=Math.min(i,this._farClip),Pn.invert(this._matView,this.node.worldMatrix),this._proj===yv.PERSPECTIVE)Pn.perspective(Fv,this._fov,this._aspect,t,i);else{var n=this._orthoHeight*this._aspect,r=this._orthoHeight;Pn.ortho(Fv,-n,n,-r,r,t,i)}Pn.multiply(zv,Fv,this._matView),Pn.invert(Fv,zv),e.update(zv,Fv)}}},{key:"changeTargetWindow",value:function(e){var t=0<arguments.length&&void 0!==e?e:null,i=this._scene,n=t||i.root.mainWindow;n&&(this._view.window=n,this.resize(n.width,n.height))}},{key:"screenPointToRay",value:function(e,t,i){var n=this._viewport.x*this._width,r=this._viewport.y*this._height,a=this._viewport.width*this._width,s=this._viewport.height*this._height;return Ni.set(Lv,(t-n)/a*2-1,(i-r)/s*2-1,1),Ni.transformMat4(Lv,Lv,this._matViewProjInv),this._proj===yv.PERSPECTIVE?this._node&&this._node.getWorldPosition(Pv):(Ni.set(Pv,(t-n)/a*2-1,(i-r)/s*2-1,-1),Ni.transformMat4(Pv,Pv,this._matViewProjInv)),$a.fromPoints(e,Pv,Lv)}},{key:"screenToWorld",value:function(e,t){var i=this._viewport.x*this._width,n=this._viewport.y*this._height,r=this._viewport.width*this._width,a=this._viewport.height*this._height;return this._proj===yv.PERSPECTIVE?(Ni.set(e,(t.x-i)/r*2-1,(t.y-n)/a*2-1,1),Ni.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(Lv),Ni.lerp(e,Lv,e,mi(this._nearClip/this._farClip,1,t.z))):(Ni.set(e,(t.x-i)/r*2-1,(t.y-n)/a*2-1,2*t.z-1),Ni.transformMat4(e,e,this.matViewProjInv)),e}},{key:"worldToScreen",value:function(e,t){var i=this._viewport.x*this._width,n=this._viewport.y*this._height,r=this._viewport.width*this._width,a=this._viewport.height*this._height;return Ni.transformMat4(e,t,this.matViewProj),e.x=i+.5*(e.x+1)*r,e.y=n+.5*(e.y+1)*a,e.z=.5*e.z+.5,e}},{key:"updateExposure",value:function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this._exposure=.833333/Math.pow(2,e)}},{key:"screenScale",set:function(e){this._screenScale=e},get:function(){return this._screenScale}},{key:"enabled",set:function(e){this._enabled=e,this._view.enable(e)},get:function(){return this._enabled}},{key:"view",get:function(){return this._view}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"isWindowSize",get:function(){return this._isWindowSize},set:function(e){this._isWindowSize=e}},{key:"orthoHeight",set:function(e){this._orthoHeight=e,this._isProjDirty=!0},get:function(){return this._orthoHeight}},{key:"projectionType",set:function(e){this._proj=e,this._isProjDirty=!0},get:function(){return this._proj}},{key:"viewport",set:function(e){this._viewport=e},get:function(){return this._viewport}},{key:"fov",set:function(e){this._fov=e,this._isProjDirty=!0},get:function(){return this._fov}},{key:"nearClip",set:function(e){this._nearClip=e,this._isProjDirty=!0},get:function(){return this._nearClip}},{key:"farClip",set:function(e){this._farClip=e,this._isProjDirty=!0},get:function(){return this._farClip}},{key:"clearColor",set:function(e){this._clearColor.r=e.r,this._clearColor.g=e.g,this._clearColor.b=e.b,this._clearColor.a=e.a},get:function(){return this._clearColor}},{key:"clearDepth",set:function(e){this._clearDepth=e},get:function(){return this._clearDepth}},{key:"clearStencil",set:function(e){this._clearStencil=e},get:function(){return this._clearStencil}},{key:"clearFlag",set:function(e){this._clearFlag=e},get:function(){return this._clearFlag}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum}},{key:"forward",get:function(){return this._forward}},{key:"position",get:function(){return this._position}},{key:"visibility",set:function(e){this._visibility=e,this._view.visibility=e},get:function(){return this._visibility}},{key:"priority",get:function(){return this._view.priority},set:function(e){this._priority=e,this._view.priority=this._priority}},{key:"aperture",set:function(e){this._aperture=e,this._apertureValue=Mv[this._aperture],this.updateExposure()},get:function(){return this._aperture}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",set:function(e){this._shutter=e,this._shutterValue=Iv[this._shutter],this.updateExposure()},get:function(){return this._shutter}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",set:function(e){this._iso=e,this._isoValue=Bv[this._iso],this.updateExposure()},get:function(){return this._iso}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",set:function(e){this._ec=e},get:function(){return this._ec}},{key:"exposure",get:function(){return this._exposure}}]),i}(),Uv=($e.fastRemove,new Array(16)),Vv=null,Gv=new Ii,Hv=[Gp.TOUCH_START.toString(),Gp.TOUCH_MOVE.toString(),Gp.TOUCH_END.toString(),Gp.TOUCH_CANCEL.toString()],Wv=[Gp.MOUSE_DOWN.toString(),Gp.MOUSE_ENTER.toString(),Gp.MOUSE_MOVE.toString(),Gp.MOUSE_LEAVE.toString(),Gp.MOUSE_UP.toString(),Gp.MOUSE_WHEEL.toString()];function qv(e,t){var i=this.owner;return!(!i||!i.uiTransfromComp)&&(e.getUILocation(Gv),!!i.uiTransfromComp.isHit(Gv,this)&&(t.type=Gp.TOUCH_START.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t),!0))}function jv(e,t){var i=this.owner;if(!i||!i.uiTransfromComp)return!1;t.type=Gp.TOUCH_MOVE.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t)}function Xv(e,t){var i=this.owner;i&&i.uiTransfromComp&&(e.getUILocation(Gv),i.uiTransfromComp.isHit(Gv,this)?t.type=Gp.TOUCH_END.toString():t.type=Gp.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function Yv(e,t){var i=this.owner;i&&i.uiTransfromComp&&(t.type=Gp.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function Kv(e){var t=this.owner;t&&t.uiTransfromComp&&(Gv=e.getUILocation(),t.uiTransfromComp.isHit(Gv,this)&&(e.type=Gp.MOUSE_DOWN.toString(),e.bubbles=!0,t.dispatchEvent(e)))}function Qv(e){var t=this.owner;if(t&&t.uiTransfromComp){if(Gv=e.getUILocation(),t.uiTransfromComp.isHit(Gv,this))this._previousIn||(Vv&&Vv.eventProcessor.mouseListener&&(e.type=Gp.MOUSE_LEAVE,Vv.dispatchEvent(e),Vv.eventProcessor.mouseListener&&(Vv.eventProcessor.mouseListener._previousIn=!1)),Vv=t,e.type=Gp.MOUSE_ENTER.toString(),t.dispatchEvent(e),this._previousIn=!0),e.type=Gp.MOUSE_MOVE.toString(),e.bubbles=!0,t.dispatchEvent(e);else{if(!this._previousIn)return;e.type=Gp.MOUSE_LEAVE.toString(),t.dispatchEvent(e),this._previousIn=!1,Vv=null}e.propagationStopped=!0}}function Zv(e){var t=this.owner;t&&t.uiTransfromComp&&(Gv=e.getUILocation(),t.uiTransfromComp.isHit(Gv,this)&&(e.type=Gp.MOUSE_UP.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function Jv(e){var t=this.owner;t&&t.uiTransfromComp&&(Gv=e.getUILocation(),t.uiTransfromComp.isHit(Gv,this)&&(e.type=Gp.MOUSE_WHEEL.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function $v(e){var t=cc.MaskComponent;if(t)for(var i=0,n=e;n&&cc.Node.isNode(n);n=n.parent,++i)if(n.getComponent(t))return{index:i,node:n};return null}function em(e,t){if(e._persistNode)return!0;var i=0;if(e.eventProcessor.bubblingTargets)for(;i<t.length;++i)if(e.eventProcessor.bubblingTargets.hasEventListener(t[i]))return!0;if(e.eventProcessor.capturingTargets)for(;i<t.length;++i)if(e.eventProcessor.capturingTargets.hasEventListener(t[i]))return!0;return!1}var tm,im,nm,rm=function(){function t(e){y(this,t),this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=e}return l(t,[{key:"node",get:function(){return this._node}}]),l(t,[{key:"reattach",value:function(){if(this.touchListener){var e=this.touchListener.mask=$v(this._node);this.mouseListener&&(this.mouseListener.mask=e)}else this.mouseListener&&(this.mouseListener.mask=$v(this._node))}},{key:"destroy",value:function(){Vv===this._node&&(Vv=null),(this.touchListener||this.mouseListener)&&(zp.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null))}},{key:"on",value:function(e,t,i,n){return this._checknSetupSysEvent(e)?this._onDispatch(e,t,i,n):(this.bubblingTargets||(this.bubblingTargets=new cl),this.bubblingTargets.on(e,t,i))}},{key:"once",value:function(e,t,i,n){(this._checknSetupSysEvent(e)&&n?this.capturingTargets=this.capturingTargets||new cl:this.bubblingTargets=this.bubblingTargets||new cl).once(e,t,i)}},{key:"off",value:function(e,t,i,n){var r=-1!==Hv.indexOf(e),a=!r&&-1!==Wv.indexOf(e);r||a?(this._offDispatch(e,t,i,n),r?this.touchListener&&!em(this._node,Hv)&&(zp.removeListener(this.touchListener),this.touchListener=null):a&&this.mouseListener&&!em(this._node,Wv)&&(zp.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(e,t,i)}},{key:"emit",value:function(e){if(this.bubblingTargets){for(var t,i=arguments.length,n=new Array(1<i?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];(t=this.bubblingTargets).emit.apply(t,[e].concat(n))}}},{key:"dispatchEvent",value:function(e){!function(e,t){var i,n=0;for(t.target=e,Uv.length=0,e.eventProcessor.getCapturingTargets(t.type,Uv),t.eventPhase=1,n=Uv.length-1;0<=n;--n)if((i=Uv[n]).eventProcessor.capturingTargets&&((t.currentTarget=i).eventProcessor.capturingTargets.emit(t.type,t,Uv),t.propagationStopped))return Uv.length=0;if(Uv.length=0,t.eventPhase=2,(t.currentTarget=e).eventProcessor.capturingTargets&&e.eventProcessor.capturingTargets.emit(t.type,t),!t.propagationImmediateStopped&&e.eventProcessor.bubblingTargets&&e.eventProcessor.bubblingTargets.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(e.eventProcessor.getBubblingTargets(t.type,Uv),t.eventPhase=3,n=0;n<Uv.length;++n)if((i=Uv[n]).eventProcessor.bubblingTargets&&((t.currentTarget=i).eventProcessor.bubblingTargets.emit(t.type,t),t.propagationStopped))return Uv.length=0;Uv.length=0}(this._node,e),Uv.length=0}},{key:"hasEventListener",value:function(e){var t=!1;return this.bubblingTargets&&(t=this.bubblingTargets.hasEventListener(e)),!t&&this.capturingTargets&&(t=this.capturingTargets.hasEventListener(e)),t}},{key:"targetOff",value:function(e){this.capturingTargets&&this.capturingTargets.targetOff(e),this.bubblingTargets&&this.bubblingTargets.targetOff(e),this.touchListener&&!em(this.node,Hv)&&(zp.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!em(this.node,Wv)&&(zp.removeListener(this.mouseListener),this.mouseListener=null)}},{key:"getCapturingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.capturingTargets&&i.eventProcessor.capturingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"getBubblingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.bubblingTargets&&i.eventProcessor.bubblingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"_checknSetupSysEvent",value:function(e){var t=this,i=!1,n=!1;return-1!==Hv.indexOf(e)?(this.touchListener||(this.touchListener=cc.EventListener.create({event:cc.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:$v(this._node),onTouchBegan:qv,onTouchMoved:jv,onTouchEnded:Xv,onTouchCancelled:Yv}),zp.addListener(this.touchListener,this._node),i=!0),n=!0):-1!==Wv.indexOf(e)&&(this.mouseListener||(this.mouseListener=cc.EventListener.create({event:cc.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:$v(this._node),onMouseDown:Kv,onMouseMove:Qv,onMouseUp:Zv,onMouseScroll:Jv}),zp.addListener(this.mouseListener,this._node),i=!0),n=!0),i&&!this._node.activeInHierarchy&&cc.director.getScheduler().schedule(function(){t._node.activeInHierarchy||zp.pauseTarget(t._node)},this._node,0,0,0,!1),n}},{key:"_onDispatch",value:function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=null;return(r=n?this.capturingTargets=this.capturingTargets||new cl:this.bubblingTargets=this.bubblingTargets||new cl).hasEventListener(e,t,i)||r.on(e,t,i),t}cc.errorID(6800)}},{key:"_offDispatch",value:function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=n?this.capturingTargets:this.bubblingTargets;r&&r.off(e,t,i)}else this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e)}}]),t}();cc.NodeEventProcessor=rm;var am=m4("Script",fo("cc.Script")(tm=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return _(e,nh),e}())||tm);cc._Script=am;var sm=m4("JavaScript",fo("cc.JavaScript")(im=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return _(e,am),e}())||im);cc._JavaScript=sm;var om,lm,um,cm,hm,fm,dm,_m,pm,vm,mm,ym,gm,bm=m4("TypeScript",fo("cc.TypeScript")(nm=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return _(e,am),e}())||nm);cc._TypeScript=bm;var xm=new pe("Comp"),Sm=(Uo.Flags.IsOnEnableCalled,Uo.Flags.IsOnLoadCalled),Tm=m4("Component",(om=fo("cc.Component"),lm=_o({visible:!1}),um=_o({visible:!1}),cm=_o({displayName:"Script",type:am,tooltip:void 0}),hm=_o({visible:!1}),fm=_o({visible:!1}),dm=_o({visible:!1}),om((gm=ym=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"node",vm,c(t)),v(t,"_enabled",mm,c(t)),t._sceneGetter=null,t._id=xm.getNewId(),t._eventTargets=[],t}return _(a,Uo),l(a,[{key:"_getRenderScene",value:function(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene}},{key:"addComponent",value:function(e){return this.node.addComponent(e)}},{key:"getComponent",value:function(e){return this.node.getComponent(e)}},{key:"getComponents",value:function(e){return this.node.getComponents(e)}},{key:"getComponentInChildren",value:function(e){return this.node.getComponentInChildren(e)}},{key:"getComponentsInChildren",value:function(e){return this.node.getComponentsInChildren(e)}},{key:"destroy",value:function(){p(g(a.prototype),"destroy",this).call(this)&&this._enabled&&this.node.activeInHierarchy&&cc.director._compScheduler.disableComp(this)}},{key:"_onPreDestroy",value:function(){this.unscheduleAllCallbacks();for(var e=this._eventTargets,t=0,i=e.length;t<i;++t){var n=e[t];n&&n.targetOff(this)}e.length=0,cc.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}},{key:"_instantiate",value:function(e){return(e=e||cc.instantiate._clone(this,this)).node=null,e}},{key:"schedule",value:function(e,t,i,n){var r=1<arguments.length&&void 0!==t?t:0,a=2<arguments.length&&void 0!==i?i:cc.macro.REPEAT_FOREVER,s=3<arguments.length&&void 0!==n?n:0;cc.assertID(e,1619),cc.assertID(0<=r,1620),r=r||0,a=isNaN(a)?cc.macro.REPEAT_FOREVER:a,s=s||0;var o=cc.director.getScheduler(),l=o.isTargetPaused(this);o.schedule(e,this,r,a,s,l)}},{key:"scheduleOnce",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:0;this.schedule(e,0,0,i)}},{key:"unschedule",value:function(e){e&&cc.director.getScheduler().unschedule(e,this)}},{key:"unscheduleAllCallbacks",value:function(){cc.director.getScheduler().unscheduleAllForTarget(this)}},{key:"name",get:function(){if(this._name)return this._name;var e=Re(this),t=e.lastIndexOf(".");return 0<=t&&(e=e.slice(t+1)),this.node.name+"<"+e+">"},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=cc.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&Sm}}]),a}(),ym.system=null,m((pm=gm).prototype,"name",[lm],Object.getOwnPropertyDescriptor(pm.prototype,"name"),pm.prototype),m(pm.prototype,"uuid",[um],Object.getOwnPropertyDescriptor(pm.prototype,"uuid"),pm.prototype),m(pm.prototype,"__scriptAsset",[cm],Object.getOwnPropertyDescriptor(pm.prototype,"__scriptAsset"),pm.prototype),m(pm.prototype,"enabled",[hm],Object.getOwnPropertyDescriptor(pm.prototype,"enabled"),pm.prototype),m(pm.prototype,"enabledInHierarchy",[fm],Object.getOwnPropertyDescriptor(pm.prototype,"enabledInHierarchy"),pm.prototype),vm=m(pm.prototype,"node",[dm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mm=m(pm.prototype,"_enabled",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_m=pm))||_m)),wm=Tm.prototype;wm.update=null,wm.lateUpdate=null,wm.__preload=null,wm.onLoad=null,wm.start=null,wm.onEnable=null,wm.onDisable=null,wm.onDestroy=null,wm.onFocusInEditor=null,wm.onLostFocusInEditor=null,wm.resetInEditor=null,wm._getLocalBounds=null,wm.onRestore=null,Tm._requireComponent=null,Tm._executionOrder=0,we(Tm,"_registerEditorProps",function(e,t){var i=t.requireComponent;i&&(e._requireComponent=i);var n=t.executionOrder;n&&"number"==typeof n&&(e._executionOrder=n)}),cc.Component=Tm;var Em,Am,Cm,km,Rm,Om,Mm,Im,Bm;Uo.Flags.Destroying;var Lm=Uo.Flags.Destroying,Pm=Uo.Flags.DontDestroy,Fm=Uo.Flags.Deactivating,zm=new pe("Node");function Dm(e){return e?"string"==typeof e?Qe(e):e:(cc.errorID(3804),null)}var Nm,Um,Vm,Gm,Hm,Wm,qm,jm,Xm,Ym,Km,Qm,Zm,Jm,$m,ey=m4("BaseNode",fo("cc._BaseNode")((Bm=Im=function(){function u(e){var t;return y(this,u),v(t=x(this,g(u).call(this,e)),"_parent",Cm,c(t)),v(t,"_children",km,c(t)),v(t,"_active",Rm,c(t)),v(t,"_components",Om,c(t)),v(t,"_prefab",Mm,c(t)),t._scene=null,t._activeInHierarchy=!1,t._id=zm.getNewId(),t._name=void 0,t.__eventTargets=[],t._siblingIndex=0,t._name=void 0!==e?e:"New Node",t}return _(u,Uo),l(u,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return 0<(this._objFlags&Pm)},set:function(e){e?this._objFlags|=Pm:this._objFlags&=~Pm}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;if(t)t._activeInHierarchy&&cc.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}}],[{key:"_setScene",value:function(e){e instanceof cc.Scene?e._scene=e:null==e._parent?cc.error("Node %s(%s) has not attached to a scene.",e.name,e.uuid):e._scene=e._parent._scene}},{key:"_findComponent",value:function(e,t){var i=t,n=e._components;if(i._sealed)for(var r=0;r<n.length;++r){var a=n[r];if(a.constructor===t)return a}else for(var s=0;s<n.length;++s){var o=n[s];if(o instanceof t)return o}return null}},{key:"_findComponents",value:function(e,t,i){var n=t,r=e._components;if(n._sealed)for(var a=0;a<r.length;++a){var s=r[a];s.constructor===t&&i.push(s)}else for(var o=0;o<r.length;++o){var l=r[o];l instanceof t&&i.push(l)}}},{key:"_findChildComponent",value:function(e,t){for(var i=0;i<e.length;++i){var n=e[i],r=u._findComponent(n,t);if(r)return r;if(0<n._children.length&&(r=u._findChildComponent(n._children,t)))return r}return null}},{key:"_findChildComponents",value:function(e,t,i){for(var n=0;n<e.length;++n){var r=e[n];u._findComponents(r,t,i),0<r._children.length&&u._findChildComponents(r._children,t,i)}}}]),l(u,[{key:"getParent",value:function(){return this._parent}},{key:"setParent",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;if(this._parent!==e){var n=this._parent;if(this._parent=e,this._siblingIndex=0,this._onSetParent(n,i),this.emit&&this.emit(Gp.PARENT_CHANGED,n),e&&(e._children.push(this),this._siblingIndex=e._children.length-1,e.emit&&e.emit(Gp.CHILD_ADDED,this)),n&&!(n._objFlags&Lm)){var r=n._children.indexOf(this);0,n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(Gp.CHILD_REMOVED,this)}this._onHierarchyChanged(n)}}},{key:"attr",value:function(e){Ne(this,e)}},{key:"getChildByUuid",value:function(e){if(!e)return cc.log("Invalid uuid"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._id===e)return t[i];return null}},{key:"getChildByName",value:function(e){if(!e)return cc.log("Invalid name"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._name===e)return t[i];return null}},{key:"getChildByPath",value:function(e){for(var n=e.split("/"),r=this,t=function(e){var t=n[e];if(0===t.length)return"continue";var i=r.children.find(function(e){return e.name===t});if(!i)return{v:null};r=i},i=0;i<n.length;++i){var a=t(i);switch(a){case"continue":continue;default:if("object"===be(a))return a.v}}return r}},{key:"addChild",value:function(e){cc.assertID(e,1606),cc.assertID(null===e._parent,1605),e.setParent(this)}},{key:"insertChild",value:function(e,t){e.parent=this,e.setSiblingIndex(t)}},{key:"getSiblingIndex",value:function(){return this._siblingIndex}},{key:"setSiblingIndex",value:function(e){if(this._parent)if(this._parent._objFlags&Fm)cc.errorID(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var i=t.indexOf(this);e!==i&&(t.splice(i,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}}},{key:"walk",value:function(e,t){var i=1,n=null,r=null,a=0,s=u._stacks[u._stackId];s||(s=[],u._stacks.push(s)),u._stackId++,s.length=0,s[0]=this;for(var o=null,l=!1;i;)if(r=s[--i])if(!l&&e?e(r):l&&t&&t(r),s[i]=null,l){if(l=!1,n)if(n[++a])s[i]=n[a],i++;else if(o&&(s[i]=o,i++,l=!0,o._parent?(a=(n=o._parent._children).indexOf(o),o=o._parent):n=o=null,a<0))break}else 0<r._children.length?(n=(o=r)._children,a=0,s[i]=n[a],i++):(s[i]=r,i++,l=!0);s.length=0,u._stackId--}},{key:"removeFromParent",value:function(){this._parent&&this._parent.removeChild(this)}},{key:"removeChild",value:function(e){-1<this._children.indexOf(e)&&(e.parent=null)}},{key:"removeAllChildren",value:function(){for(var e=this._children,t=e.length-1;0<=t;t--){var i=e[t];i&&(i.parent=null)}this._children.length=0}},{key:"isChildOf",value:function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1}},{key:"getComponent",value:function(e){var t=Dm(e);return t?u._findComponent(this,t):null}},{key:"getComponents",value:function(e){var t=Dm(e),i=[];return t&&u._findComponents(this,t,i),i}},{key:"getComponentInChildren",value:function(e){var t=Dm(e);return t?u._findChildComponent(this._children,t):null}},{key:"getComponentsInChildren",value:function(e){var t=Dm(e),i=[];return t&&(u._findComponents(this,t,i),u._findChildComponents(this._children,t,i)),i}},{key:"addComponent",value:function(e){var t;if("string"==typeof e){if(!(t=Qe(e)))return cc.errorID(3807,e),cc._RF.peek()&&cc.errorID(3808,e),null}else{if(!e)return cc.errorID(3804),null;t=e}if("function"!=typeof t)return cc.errorID(3809),null;if(!Ge(t,cc.Component))return cc.errorID(3810),null;var i=t._requireComponent;if(i&&!this.getComponent(i)&&!this.addComponent(i))return null;var n=new t;return(n.node=this)._components.push(n),this._activeInHierarchy&&cc.director._nodeActivator.activateComp(n),n}},{key:"removeComponent",value:function(e){if(e){var t=null;(t=e instanceof Tm?e:this.getComponent(e))&&t.destroy()}else cc.errorID(3813)}},{key:"destroy",value:function(){return!!p(g(u.prototype),"destroy",this).call(this)&&(this._activeInHierarchy&&this._disableChildComps(),!0)}},{key:"destroyAllChildren",value:function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()}},{key:"_removeComponent",value:function(e){if(e){if(!(this._objFlags&Lm)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&cc.errorID(3815)}}else cc.errorID(3814)}},{key:"_updateSiblingIndex",value:function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e}},{key:"_onSetParent",value:function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(function(e){u._setScene(e)}))}},{key:"_onPostActivated",value:function(e){}},{key:"_onBatchRestored",value:function(){}},{key:"_onBatchCreated",value:function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}},{key:"_onPreDestroy",value:function(){this._onPreDestroyBase()}},{key:"_onHierarchyChanged",value:function(e){return this._onHierarchyChangedBase(e)}},{key:"_instantiate",value:function(e){e=e||cc.instantiate._clone(this,this);var t=this._prefab;t&&this===t.root&&t.sync;return e._parent=null,e._onBatchRestored(),e}},{key:"_onHierarchyChangedBase",value:function(e){var t=this._parent;!this._persistNode||t instanceof cc.Scene||cc.game.removePersistRootNode(this);var i=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==i&&cc.director._nodeActivator.activateNode(this,i)}},{key:"_onPreDestroyBase",value:function(){this._objFlags|=Lm;var e=this._parent,t=null!==e&&0!=(e._objFlags&Lm);for(var i=this._children,n=0;n<i.length;++n)i[n]._destroyImmediate();for(var r=this._components,a=0;a<r.length;++a)r[a]._destroyImmediate();for(var s=this.__eventTargets,o=0;o<s.length;++o){var l=s[o];l&&l.targetOff(this)}if(s.length=0,this._persistNode&&cc.game.removePersistRootNode(this),!t&&e){var u=e._children.indexOf(this);e._children.splice(u,1),this._siblingIndex=0,e.emit&&e.emit("child-removed",this)}return t}},{key:"_disableChildComps",value:function(){for(var e=this._components,t=0;t<e.length;++t){var i=e[t];i._enabled&&cc.director._compScheduler.disableComp(i)}for(var n=this._children,r=0;r<n.length;++r){var a=n[r];a._active&&a._disableChildComps()}}}]),u}(),Im.idGenerator=zm,Im._stacks=[[]],Im._stackId=0,m((Am=Bm).prototype,"_persistNode",[_o],Object.getOwnPropertyDescriptor(Am.prototype,"_persistNode"),Am.prototype),m(Am.prototype,"name",[_o],Object.getOwnPropertyDescriptor(Am.prototype,"name"),Am.prototype),m(Am.prototype,"uuid",[_o],Object.getOwnPropertyDescriptor(Am.prototype,"uuid"),Am.prototype),m(Am.prototype,"children",[_o],Object.getOwnPropertyDescriptor(Am.prototype,"children"),Am.prototype),m(Am.prototype,"active",[_o],Object.getOwnPropertyDescriptor(Am.prototype,"active"),Am.prototype),m(Am.prototype,"activeInHierarchy",[_o],Object.getOwnPropertyDescriptor(Am.prototype,"activeInHierarchy"),Am.prototype),m(Am.prototype,"parent",[_o],Object.getOwnPropertyDescriptor(Am.prototype,"parent"),Am.prototype),Cm=m(Am.prototype,"_parent",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),km=m(Am.prototype,"_children",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rm=m(Am.prototype,"_active",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Om=m(Am.prototype,"_components",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Mm=m(Am.prototype,"_prefab",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Em=Am))||Em);cc._BaseNode=ey,(Um=Nm=Nm||{})[Um.LOCAL=0]="LOCAL",Um[Um.WORLD=1]="WORLD",(Gm=Vm=Vm||{})[Gm.NONE=0]="NONE",Gm[Gm.POSITION=1]="POSITION",Gm[Gm.ROTATION=2]="ROTATION",Gm[Gm.SCALE=4]="SCALE",Gm[Gm.RS=Gm.ROTATION|Gm.SCALE]="RS",Gm[Gm.TRS=Gm.POSITION|Gm.ROTATION|Gm.SCALE]="TRS",Gm[Gm.TRS_MASK=~Gm.TRS]="TRS_MASK";var ty=new Ni,iy=new fn,ny=new fn,ry=new Array(10),ay=new fn,sy=new an,oy=new an,ly=new Pn,uy=new Map,cy=m4("Node",(Hm=fo("cc.Node"),Wm=_o({type:Ni}),Hm(($m=Jm=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._pos=new Ni,t._rot=new fn,t._scale=new Ni(1,1,1),t._mat=new Pn,v(t,"_lpos",Xm,c(t)),v(t,"_lrot",Ym,c(t)),v(t,"_lscale",Km,c(t)),v(t,"_layer",Qm,c(t)),v(t,"_euler",Zm,c(t)),t._dirtyFlags=Vm.NONE,t._eulerDirty=!1,t._eventProcessor=new rm(c(t)),t._eventMask=0,t._uiTransfromComp=null,t._uiComp=null,t}return _(a,ey),l(a,[{key:"setParent",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t;i&&this.updateWorldTransform(),p(g(a.prototype),"setParent",this).call(this,e,i)}},{key:"_onSetParent",value:function(e,t){if(p(g(a.prototype),"_onSetParent",this).call(this,e,t),t){var i=this._parent;i?(i.updateWorldTransform(),Pn.multiply(ly,Pn.invert(ly,i._mat),this._mat),Pn.toRTS(ly,this._lrot,this._lpos,this._lscale)):(Ni.copy(this._lpos,this._pos),fn.copy(this._lrot,this._rot),Ni.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(Vm.TRS)}},{key:"_onBatchCreated",value:function(){p(g(a.prototype),"_onBatchCreated",this).call(this),uy.set(this._id,Vm.TRS),this._dirtyFlags=Vm.TRS;for(var e=this._children.length,t=0;t<e;++t)this._children[t]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"_onBeforeSerialize",value:function(){this.eulerAngles}},{key:"translate",value:function(e,t){var i=t||Nm.LOCAL;if(i===Nm.LOCAL)Ni.transformQuat(ty,e,this._lrot),this._lpos.x+=ty.x,this._lpos.y+=ty.y,this._lpos.z+=ty.z;else if(i===Nm.WORLD)if(this._parent){fn.invert(iy,this.worldRotation),Ni.transformQuat(ty,e,iy);var n=this.worldScale;this._lpos.x+=ty.x/n.x,this._lpos.y+=ty.y/n.y,this._lpos.z+=ty.z/n.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(Vm.POSITION),1&this._eventMask&&this.emit(Gp.TRANSFORM_CHANGED,Gp.POSITION_PART)}},{key:"rotate",value:function(e,t){var i=t||Nm.LOCAL;if(fn.normalize(iy,e),i===Nm.LOCAL)fn.multiply(this._lrot,this._lrot,iy);else if(i===Nm.WORLD){var n=this.worldRotation;fn.multiply(ny,iy,n),fn.invert(iy,n),fn.multiply(ny,iy,ny),fn.multiply(this._lrot,this._lrot,ny)}this._eulerDirty=!0,this.invalidateChildren(Vm.ROTATION),1&this._eventMask&&this.emit(Gp.TRANSFORM_CHANGED,Gp.ROTATION_PART)}},{key:"lookAt",value:function(e,t){this.getWorldPosition(ty),Ni.subtract(ty,ty,e),Ni.normalize(ty,ty),fn.fromViewUp(iy,ty,t),this.setWorldRotation(iy)}},{key:"invalidateChildren",value:function(e){if((this._dirtyFlags&this.hasChangedFlags&e)!==e){this._dirtyFlags|=e,uy.set(this._id,this.hasChangedFlags|e),e|=Vm.POSITION;for(var t=this._children.length,i=0;i<t;++i)this._children[i].invalidateChildren(e)}}},{key:"updateWorldTransform",value:function(){if(this._dirtyFlags){for(var e,t=this,i=0;t&&t._dirtyFlags;)t=(ry[i++]=t)._parent;for(var n=0;i;)n|=(e=ry[--i])._dirtyFlags,t?(n&Vm.POSITION&&(Ni.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&Vm.RS&&(Pn.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),Pn.multiply(e._mat,t._mat,e._mat),n&Vm.ROTATION&&fn.multiply(e._rot,t._rot,e._lrot),an.fromQuat(sy,fn.conjugate(ay,e._rot)),an.multiplyMat4(sy,sy,e._mat),e._scale.x=sy.m00,e._scale.y=sy.m04,e._scale.z=sy.m08)):(n&Vm.POSITION&&(Ni.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&Vm.RS&&(n&Vm.ROTATION?fn.copy(e._rot,e._lrot):Ni.copy(e._scale,e._lscale),Pn.fromRTS(e._mat,e._rot,e._pos,e._scale))),e._dirtyFlags=Vm.NONE,t=e}}},{key:"setPosition",value:function(e,t,i){void 0===t||void 0===i?Ni.copy(this._lpos,e):Ni.set(this._lpos,e,t,i),this.invalidateChildren(Vm.POSITION),1&this._eventMask&&this.emit(Gp.TRANSFORM_CHANGED,Gp.POSITION_PART)}},{key:"getPosition",value:function(e){return e?Ni.set(e,this._lpos.x,this._lpos.y,this._lpos.z):Ni.copy(new Ni,this._lpos)}},{key:"setRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?fn.copy(this._lrot,e):fn.set(this._lrot,e,t,i,n),this._eulerDirty=!0,this.invalidateChildren(Vm.ROTATION),1&this._eventMask&&this.emit(Gp.TRANSFORM_CHANGED,Gp.ROTATION_PART)}},{key:"setRotationFromEuler",value:function(e,t,i){Ni.set(this._euler,e,t,i),fn.fromEuler(this._lrot,e,t,i),this._eulerDirty=!1,this.invalidateChildren(Vm.ROTATION),1&this._eventMask&&this.emit(Gp.TRANSFORM_CHANGED,Gp.ROTATION_PART)}},{key:"getRotation",value:function(e){return e?fn.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):fn.copy(new fn,this._lrot)}},{key:"setScale",value:function(e,t,i){void 0===t||void 0===i?Ni.copy(this._lscale,e):Ni.set(this._lscale,e,t,i),this.invalidateChildren(Vm.SCALE),1&this._eventMask&&this.emit(Gp.TRANSFORM_CHANGED,Gp.SCALE_PART)}},{key:"getScale",value:function(e){return e?Ni.set(e,this._lscale.x,this._lscale.y,this._lscale.z):Ni.copy(new Ni,this._lscale)}},{key:"inverseTransformPoint",value:function(e,t){Ni.copy(e,t);for(var i=this,n=0;i._parent;)i=(ry[n++]=i)._parent;for(;0<=n;)Ni.transformInverseRTS(e,e,i._lrot,i._lpos,i._lscale),i=ry[--n];return e}},{key:"setWorldPosition",value:function(e,t,i){void 0===t||void 0===i?Ni.copy(this._pos,e):Ni.set(this._pos,e,t,i);var n=this._parent,r=this._lpos;n?(n.updateWorldTransform(),Ni.transformMat4(r,this._pos,Pn.invert(ly,n._mat))):Ni.copy(r,this._pos),this.invalidateChildren(Vm.POSITION),1&this._eventMask&&this.emit(Gp.TRANSFORM_CHANGED,Gp.POSITION_PART)}},{key:"getWorldPosition",value:function(e){return this.updateWorldTransform(),e?Ni.copy(e,this._pos):Ni.copy(new Ni,this._pos)}},{key:"setWorldRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?fn.copy(this._rot,e):fn.set(this._rot,e,t,i,n),this._parent?(this._parent.updateWorldTransform(),fn.multiply(this._lrot,fn.conjugate(this._lrot,this._parent._rot),this._rot)):fn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Vm.ROTATION),1&this._eventMask&&this.emit(Gp.TRANSFORM_CHANGED,Gp.ROTATION_PART)}},{key:"setWorldRotationFromEuler",value:function(e,t,i){fn.fromEuler(this._rot,e,t,i),this._parent?(this._parent.updateWorldTransform(),fn.multiply(this._lrot,fn.conjugate(this._lrot,this._parent._rot),this._rot)):fn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Vm.ROTATION),1&this._eventMask&&this.emit(Gp.TRANSFORM_CHANGED,Gp.ROTATION_PART)}},{key:"getWorldRotation",value:function(e){return this.updateWorldTransform(),e?fn.copy(e,this._rot):fn.copy(new fn,this._rot)}},{key:"setWorldScale",value:function(e,t,i){void 0===t||void 0===i?Ni.copy(this._scale,e):Ni.set(this._scale,e,t,i);var n=this._parent;n?(n.updateWorldTransform(),an.fromQuat(sy,fn.conjugate(ay,n._rot)),an.multiplyMat4(sy,sy,n._mat),oy.m00=this._scale.x,oy.m04=this._scale.x,oy.m08=this._scale.z,an.multiply(sy,oy,an.invert(sy,sy)),this._lscale.x=sy.m00,this._lscale.y=sy.m04,this._lscale.z=sy.m08):Ni.copy(this._lscale,this._scale),this.invalidateChildren(Vm.SCALE),1&this._eventMask&&this.emit(Gp.TRANSFORM_CHANGED,Gp.SCALE_PART)}},{key:"getWorldScale",value:function(e){return this.updateWorldTransform(),e?Ni.copy(e,this._scale):Ni.copy(new Ni,this._scale)}},{key:"getWorldMatrix",value:function(e){return this.updateWorldTransform(),e=e||new Pn,Pn.copy(e,this._mat)}},{key:"getWorldRS",value:function(e){return this.updateWorldTransform(),e=e||new Pn,Pn.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}},{key:"getWorldRT",value:function(e){return this.updateWorldTransform(),e=e||new Pn,Pn.fromRT(e,this._rot,this._pos)}},{key:"getAnchorPoint",value:function(e){return(e=e||new Ii).set(this.uiTransfromComp.anchorPoint),e}},{key:"setAnchorPoint",value:function(e,t){this.uiTransfromComp.setAnchorPoint(e,t)}},{key:"getContentSize",value:function(e){return(e=e||new jn).set(this.uiTransfromComp.contentSize),e}},{key:"setContentSize",value:function(e,t){this.uiTransfromComp.setContentSize(e,t)}},{key:"on",value:function(e,t,i,n){switch(e){case Gp.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,i,n)}},{key:"off",value:function(e,t,i,n){if(this._eventProcessor.off(e,t,i,n),!this._eventProcessor.hasEventListener(e))switch(e){case Gp.TRANSFORM_CHANGED:this._eventMask&=-2}}},{key:"once",value:function(e,t,i,n){this._eventProcessor.once(e,t,i,n)}},{key:"emit",value:function(e){for(var t,i=arguments.length,n=new Array(1<i?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];(t=this._eventProcessor).emit.apply(t,[e].concat(n))}},{key:"dispatchEvent",value:function(e){this._eventProcessor.dispatchEvent(e)}},{key:"hasEventListener",value:function(e){return this._eventProcessor.hasEventListener(e)}},{key:"targetOff",value:function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(Gp.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}},{key:"pauseSystemEvents",value:function(e){zp.pauseTarget(this,e)}},{key:"resumeSystemEvents",value:function(e){zp.resumeTarget(this,e)}},{key:"_onPostActivated",value:function(e){e?(zp.resumeTarget(this),this.eventProcessor.reattach()):zp.pauseTarget(this)}},{key:"_onPreDestroy",value:function(){this._eventProcessor.destroy(),p(g(a.prototype),"_onPreDestroy",this).call(this)}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)},get:function(){return this._eulerDirty&&(fn.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){Pn.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(Vm.TRS),this._eulerDirty=!0,1&this._eventMask&&(this.emit(Gp.TRANSFORM_CHANGED,Gp.POSITION_PART),this.emit(Gp.TRANSFORM_CHANGED,Gp.ROTATION_PART),this.emit(Gp.TRANSFORM_CHANGED,Gp.SCALE_PART))}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return this.getWorldRotation(iy),Ni.transformQuat(new Ni,Ni.UNIT_Z,iy)},set:function(e){var t=e.length();Ni.multiplyScalar(ty,e,-1/t),fn.fromViewUp(iy,ty),this.setWorldRotation(iy)}},{key:"layer",set:function(e){this._layer=e},get:function(){return this._layer}},{key:"hasChangedFlags",get:function(){return uy.get(this._id)||0},set:function(e){uy.set(this._id,e)}},{key:"uiTransfromComp",get:function(){return this._uiTransfromComp||(this._uiTransfromComp=this.getComponent("cc.UITransformComponent")),this._uiTransfromComp},set:function(e){this._uiTransfromComp=e}},{key:"width",get:function(){return this.uiTransfromComp.width},set:function(e){this.uiTransfromComp.width=e}},{key:"height",get:function(){return this.uiTransfromComp.height},set:function(e){this.uiTransfromComp.height=e}},{key:"anchorX",get:function(){return this.uiTransfromComp.anchorX},set:function(e){this.uiTransfromComp.anchorX=e}},{key:"anchorY",get:function(){return this.uiTransfromComp.anchorY},set:function(e){this.uiTransfromComp.anchorY=e}},{key:"eventProcessor",get:function(){return this._eventProcessor}}],[{key:"isNode",value:function(e){return e instanceof a&&(e.constructor===a||!(e instanceof cc.Scene))}}]),a}(),Jm.bookOfChange=uy,Jm.EventType=Gp,Jm.NodeSpace=Nm,Jm.TransformDirtyBit=Vm,Xm=m((jm=$m).prototype,"_lpos",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni}}),Ym=m(jm.prototype,"_lrot",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fn}}),Km=m(jm.prototype,"_lscale",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni(1,1,1)}}),Qm=m(jm.prototype,"_layer",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yf.Enum.DEFAULT}}),Zm=m(jm.prototype,"_euler",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni}}),m(jm.prototype,"eulerAngles",[Wm],Object.getOwnPropertyDescriptor(jm.prototype,"eulerAngles"),jm.prototype),m(jm.prototype,"layer",[_o],Object.getOwnPropertyDescriptor(jm.prototype,"layer"),jm.prototype),qm=jm))||qm));cc.Node=cy;var hy,fy,dy,_y,py,vy,my,yy,gy,by,xy,Sy,Ty,wy,Ey,Ay,Cy,ky,Ry,Oy,My,Iy,By,Ly,Py,Fy,zy,Dy,Ny,Uy,Vy,Gy,Hy,Wy,qy,jy,Xy,Yy,Ky,Qy,Zy,Jy=function(){function t(e){y(this,t),this._enabled=!0,this._skyColor=Float32Array.from([.2,.5,.8,1]),this._skyIllum=t.SKY_ILLUM,this._groundAlbedo=Float32Array.from([.2,.2,.2,1]),this._scene=void 0,this._scene=e}return l(t,[{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor=e}},{key:"skyIllum",set:function(e){this._skyIllum=e},get:function(){return this._skyIllum}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo=e}}]),l(t,[{key:"update",value:function(){}}]),t}();Jy.SUN_ILLUM=65e3,Jy.SKY_ILLUM=2e4;var $y=new Ni(0,1,0),eg=new Ni,tg=new fn,ig=(hy=fo("cc.AmbientInfo"),fy=_o({type:ar}),dy=_o({type:kt}),_y=_o({type:ar}),hy((my=m((vy=function(){function e(){y(this,e),v(this,"_skyColor",my,this),v(this,"_skyIllum",yy,this),v(this,"_groundAlbedo",gy,this),this._resource=null}return l(e,[{key:"skyColor",set:function(e){this._skyColor.set(e),this._resource&&ar.toArray(this._resource.skyColor,this.skyColor)},get:function(){return this._skyColor}},{key:"skyIllum",set:function(e){this._skyIllum=e,this._resource&&(this._resource.skyIllum=this.skyIllum)},get:function(){return this._skyIllum}},{key:"groundAlbedo",set:function(e){this._groundAlbedo.set(e),this._resource&&Ni.toArray(this._resource.groundAlbedo,this.groundAlbedo)},get:function(){return this._groundAlbedo}},{key:"renderScene",set:function(e){this._resource=e.ambient,this.skyColor=this._skyColor,this.skyIllum=this._skyIllum,this.groundAlbedo=this._groundAlbedo}}]),e}()).prototype,"_skyColor",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ar(51,128,204,1)}}),yy=m(vy.prototype,"_skyIllum",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Jy.SKY_ILLUM}}),gy=m(vy.prototype,"_groundAlbedo",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ar(51,51,51,255)}}),m(vy.prototype,"skyColor",[fy],Object.getOwnPropertyDescriptor(vy.prototype,"skyColor"),vy.prototype),m(vy.prototype,"skyIllum",[dy],Object.getOwnPropertyDescriptor(vy.prototype,"skyIllum"),vy.prototype),m(vy.prototype,"groundAlbedo",[_y],Object.getOwnPropertyDescriptor(vy.prototype,"groundAlbedo"),vy.prototype),py=vy))||py);cc.AmbientInfo=ig;var ng=(by=fo("cc.SkyboxInfo"),xy=_o($h),Sy=_o({type:Rt}),Ty=_o({type:Rt}),wy=_o({type:$h}),Ey=_o({type:Rt}),by((ky=m((Cy=function(){function e(){y(this,e),v(this,"_envmap",ky,this),v(this,"_isRGBE",Ry,this),v(this,"_enabled",Oy,this),v(this,"_useIBL",My,this),this._resource=null}return l(e,[{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=this._enabled)},get:function(){return this._enabled}},{key:"useIBL",set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)},get:function(){return this._useIBL}},{key:"envmap",set:function(e){this._envmap=e,this._resource&&(this._resource.envmap=this._envmap)},get:function(){return this._envmap}},{key:"isRGBE",set:function(e){this._isRGBE=e,this._resource&&(this._resource.isRGBE=this._isRGBE)},get:function(){return this._isRGBE}},{key:"renderScene",set:function(e){this._resource=e.skybox,this.isRGBE=this._isRGBE,this.envmap=this._envmap,this.enabled=this._enabled,this.useIBL=this._useIBL}}]),e}()).prototype,"_envmap",[xy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ry=m(Cy.prototype,"_isRGBE",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oy=m(Cy.prototype,"_enabled",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),My=m(Cy.prototype,"_useIBL",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),m(Cy.prototype,"enabled",[Sy],Object.getOwnPropertyDescriptor(Cy.prototype,"enabled"),Cy.prototype),m(Cy.prototype,"useIBL",[Ty],Object.getOwnPropertyDescriptor(Cy.prototype,"useIBL"),Cy.prototype),m(Cy.prototype,"envmap",[wy],Object.getOwnPropertyDescriptor(Cy.prototype,"envmap"),Cy.prototype),m(Cy.prototype,"isRGBE",[Ey],Object.getOwnPropertyDescriptor(Cy.prototype,"isRGBE"),Cy.prototype),Ay=Cy))||Ay);cc.SkyboxInfo=ng;var rg=(Iy=fo("cc.PlanarShadowInfo"),By=_o({type:Rt}),Ly=_o({type:Ni}),Py=_o({type:kt}),Fy=_o({type:ar}),Iy((Ny=m((Dy=function(){function e(){y(this,e),v(this,"_enabled",Ny,this),v(this,"_normal",Uy,this),v(this,"_distance",Vy,this),v(this,"_shadowColor",Gy,this),this._resource=null}return l(e,[{key:"setPlaneFromNode",value:function(e){e.getWorldRotation(tg),this.normal=Ni.transformQuat(eg,$y,tg),e.getWorldPosition(eg),this.distance=Ni.dot(this._normal,eg)}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=e)},get:function(){return this._enabled}},{key:"normal",set:function(e){Ni.copy(this._normal,e),this._resource&&(this._resource.normal=e)},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)},get:function(){return this._distance}},{key:"shadowColor",set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)},get:function(){return this._shadowColor}},{key:"renderScene",set:function(e){this._resource=e.planarShadows,this.normal=this._normal,this.distance=this._distance,this.shadowColor=this._shadowColor,this.enabled=this._enabled}}]),e}()).prototype,"_enabled",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Uy=m(Dy.prototype,"_normal",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni(0,1,0)}}),Vy=m(Dy.prototype,"_distance",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Gy=m(Dy.prototype,"_shadowColor",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ar(0,0,0,76)}}),m(Dy.prototype,"enabled",[By],Object.getOwnPropertyDescriptor(Dy.prototype,"enabled"),Dy.prototype),m(Dy.prototype,"normal",[Ly],Object.getOwnPropertyDescriptor(Dy.prototype,"normal"),Dy.prototype),m(Dy.prototype,"distance",[Py],Object.getOwnPropertyDescriptor(Dy.prototype,"distance"),Dy.prototype),m(Dy.prototype,"shadowColor",[Fy],Object.getOwnPropertyDescriptor(Dy.prototype,"shadowColor"),Dy.prototype),zy=Dy))||zy);cc.PlanarShadowInfo=rg;var ag,sg,og,lg,ug=(Hy=fo("cc.SceneGlobals"),Wy=_o({type:ig}),qy=_o({type:ng}),jy=_o({type:rg}),Hy((Ky=m((Yy=function(){function e(){y(this,e),v(this,"ambient",Ky,this),v(this,"skybox",Qy,this),v(this,"planarShadows",Zy,this)}return l(e,[{key:"renderScene",set:function(e){this.ambient.renderScene=e,this.skybox.renderScene=e,this.planarShadows.renderScene=e}}]),e}()).prototype,"ambient",[Wy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ig}}),Qy=m(Yy.prototype,"skybox",[qy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ng}}),Zy=m(Yy.prototype,"planarShadows",[jy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rg}}),Xy=Yy))||Xy);cc.SceneGlobals=ug;var cg,hg=m4("Scene",fo("cc.Scene")((og=m((sg=function(){function i(e){var t;return y(this,i),v(t=x(this,g(i).call(this,e)),"autoReleaseAssets",og,c(t)),v(t,"_globals",lg,c(t)),t._renderScene=null,t.dependAssets=null,t._inited=void 0,t._prefabSyncedInLiveReload=!1,t._activeInHierarchy=!1,cc.director&&cc.director.root&&(t._renderScene=cc.director.root.createScene({})),t._inited=!cc.game||!cc.game._isCloning,t}return _(i,cy),l(i,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}}]),l(i,[{key:"destroy",value:function(){var e=p(g(i.prototype),"destroy",this).call(this);return cc.director.root.destroyScene(this._renderScene),this._activeInHierarchy=!1,e}},{key:"_onHierarchyChanged",value:function(){}},{key:"_instantiate",value:function(){}},{key:"_load",value:function(){this._inited||(this._onBatchCreated(),this._inited=!0),this.walk(ey._setScene)}},{key:"_activate",value:function(e){e=!1!==e,cc.director._nodeActivator.activateNode(this,e),this._globals.renderScene=this._renderScene}}]),i}()).prototype,"autoReleaseAssets",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lg=m(sg.prototype,"_globals",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ug}}),ag=sg))||ag);cc.Scene=hg;var fg=Uo.Flags.HideInHierarchy,dg=m4("PrivateNode",fo("cc.PrivateNode")(cg=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._objFlags|=fg,t}return _(i,cy),i}())||cg);cc.PrivateNode=dg;var _g=$e.fastRemoveAt,pg=Uo.Flags.IsStartCalled,vg=Uo.Flags.IsOnEnableCalled,mg=(Uo.Flags.IsEditorOnEnableCalled,"c.start();c._objFlags|="+pg);function yg(e,t){for(var i=t.constructor._executionOrder,n=t._id,r=0,a=e.length-1,s=a>>>1;r<=a;s=r+a>>>1){var o=e[s],l=o.constructor._executionOrder;if(i<l)a=s-1;else if(l<i)r=s+1;else{var u=o._id;if(n<u)a=s-1;else{if(!(u<n))return s;r=s+1}}}return~r}function gg(e,t){for(var i=e.array,n=e.i+1;n<i.length;){var r=i[n];r._enabled&&r.node._activeInHierarchy?++n:(e.removeAt(n),t&&(r._objFlags&=~t))}}function bg(e){y(this,bg),this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=ce;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e}function xg(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}bg.stableRemoveInactive=gg;var Sg=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return _(e,bg),l(e,[{key:"add",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)}},{key:"cancelInactive",value:function(e){gg(this._zero,e),gg(this._neg,e),gg(this._pos,e)}},{key:"invoke",value:function(){var e=this._neg;0<e.array.length&&(e.array.sort(xg),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;0<t.array.length&&(t.array.sort(xg),this._invoke(t),t.array.length=0)}}]),e}(),Tg=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return _(e,bg),l(e,[{key:"add",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var i=t<0?this._neg.array:this._pos.array,n=yg(i,e);n<0&&i.splice(~n,0,e)}}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var i=t<0?this._neg:this._pos,n=yg(i.array,e);0<=n&&i.removeAt(n)}}},{key:"invoke",value:function(e){0<this._neg.array.length&&this._invoke(this._neg,e),this._invoke(this._zero,e),0<this._pos.array.length&&this._invoke(this._pos,e)}}]),e}();function wg(r,e){if("function"==typeof r)return e?function(e,t){var i=e.array;for(e.i=0;e.i<i.length;++e.i){var n=i[e.i];r(n,t)}}:function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i){var i=t[e.i];r(i)}};var t="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+r+"}";return e?Function("it","dt",t):Function("it",t)}var Eg=function(){function e(){y(this,e),this.startInvoker=void 0,this.updateInvoker=void 0,this.lateUpdateInvoker=void 0,this.scheduleInNextFrame=void 0,this._updating=void 0,this.unscheduleAll()}return l(e,[{key:"unscheduleAll",value:function(){this.startInvoker=new Sg(wg(mg)),this.updateInvoker=new Tg(wg("c.update(dt)",!0)),this.lateUpdateInvoker=new Tg(wg("c.lateUpdate(dt)",!0)),this.scheduleInNextFrame=[],this._updating=!1}},{key:"_onEnabled",value:function(e){cc.director.getScheduler().resumeTarget(e),e._objFlags|=vg,this._updating?this.scheduleInNextFrame.push(e):this._scheduleImmediate(e)}},{key:"_onDisabled",value:function(e){cc.director.getScheduler().pauseTarget(e),e._objFlags&=~vg;var t=this.scheduleInNextFrame.indexOf(e);0<=t?_g(this.scheduleInNextFrame,t):(!e.start||e._objFlags&pg||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))}},{key:"enableComp",value:function(e,t){if(!(e._objFlags&vg)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}}},{key:"disableComp",value:function(e){e._objFlags&vg&&(e.onDisable&&e.onDisable(),this._onDisabled(e))}},{key:"startPhase",value:function(){this._updating=!0,0<this.scheduleInNextFrame.length&&this._deferredSchedule(),this.startInvoker.invoke()}},{key:"updatePhase",value:function(e){this.updateInvoker.invoke(e)}},{key:"lateUpdatePhase",value:function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1}},{key:"_scheduleImmediate",value:function(e){!e.start||e._objFlags&pg||this.startInvoker.add(e),e.update&&this.updateInvoker.add(e),e.lateUpdate&&this.lateUpdateInvoker.add(e)}},{key:"_deferredSchedule",value:function(){for(var e=this.scheduleInNextFrame,t=0,i=e.length;t<i;t++){var n=e[t];this._scheduleImmediate(n)}e.length=0}}]),e}();Eg.LifeCycleInvoker=bg,Eg.OneOffInvoker=Sg,Eg.createInvokeImpl=wg,Eg.invokeOnEnable=function(e){var t=cc.director._compScheduler,i=e.array;for(e.i=0;e.i<i.length;++e.i){var n=i[e.i];if(n._enabled)n.onEnable(),n.node._activeInHierarchy&&t._onEnabled(n)}};var Ag=Uo.Flags.IsPreloadStarted,Cg=Uo.Flags.IsOnLoadStarted,kg=Uo.Flags.IsOnLoadCalled,Rg=Uo.Flags.Deactivating,Og="c.onLoad();c._objFlags|="+kg,Mg=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return _(e,Eg.LifeCycleInvoker),l(e,[{key:"add",value:function(e){this._zero.array.push(e)}},{key:"remove",value:function(e){this._zero.fastRemove(e)}},{key:"cancelInactive",value:function(e){Eg.LifeCycleInvoker.stableRemoveInactive(this._zero,e)}},{key:"invoke",value:function(){this._invoke(this._zero),this._zero.array.length=0}}]),e}(),Ig=Eg.createInvokeImpl("c.__preload();"),Bg=Eg.createInvokeImpl(Og),Lg=new Je(4);Lg.get=function(){var e=this._get()||{preload:new Mg(Ig),onLoad:new Eg.OneOffInvoker(Bg),onEnable:new Eg.OneOffInvoker(Eg.invokeOnEnable)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var Pg=m4("NodeActivator",function(){function e(){y(this,e),this.resetComp=void 0,this._activatingStack=void 0,this.reset()}return l(e,[{key:"reset",value:function(){this._activatingStack=[]}},{key:"activateNode",value:function(e,t){if(t){var i=Lg.get();this._activatingStack.push(i),this._activateNodeRecursively(e,i.preload,i.onLoad,i.onEnable),i.preload.invoke(),i.onLoad.invoke(),i.onEnable.invoke(),this._activatingStack.pop(),Lg.put(i)}else{this._deactivateNodeRecursively(e);var n=this._activatingStack,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.preload.cancelInactive(Ag),o.onLoad.cancelInactive(Cg),o.onEnable.cancelInactive()}}e.emit("active-in-hierarchy-changed",e)}},{key:"activateComp",value:function(e,t,i,n){if(e._objFlags&Ag||(e._objFlags|=Ag,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&Cg||(e._objFlags|=Cg,e.onLoad?i?i.add(e):(e.onLoad(),e._objFlags|=kg):e._objFlags|=kg),e._enabled){if(!e.node._activeInHierarchy)return;cc.director._compScheduler.enableComp(e,n)}}},{key:"destroyComp",value:function(e){cc.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&kg&&e.onDestroy()}},{key:"_activateNodeRecursively",value:function(e,t,i,n){if(e._objFlags&Rg)cc.errorID(3816,e.name);else{e._activeInHierarchy=!0;for(var r,a,s,o=e._components.length,l=0;l<o;++l){var u=e._components[l];u instanceof cc.Component?this.activateComp(u,t,i,n):(r=e,s=l,(a=u)?r._removeComponent(a):$e.removeAt(r._components,s),--l,--o)}e._childArrivalOrder=e._children.length;for(var c=0,h=e._children.length;c<h;++c){var f=e._children[c];f._active&&this._activateNodeRecursively(f,t,i,n)}e._onPostActivated(!0)}}},{key:"_deactivateNodeRecursively",value:function(e){e._objFlags|=Rg,e._activeInHierarchy=!1;for(var t=e._components.length,i=0;i<t;++i){var n=e._components[i];if(n._enabled&&(cc.director._compScheduler.disableComp(n),e._activeInHierarchy))return void(e._objFlags&=~Rg)}for(var r=0,a=e._children.length;r<a;++r){var s=e._children[r];if(s._activeInHierarchy&&(this._deactivateNodeRecursively(s),e._activeInHierarchy))return void(e._objFlags&=~Rg)}e._onPostActivated(!1),e._objFlags&=~Rg}}]),e}());or(ey.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),lr(cy.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),lr(yf,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),or(yf,"Layers",[{name:"Default",newName:"DEFAULT",target:yf.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:yf.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:yf.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:yf.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:yf.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:yf.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:yf.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:yf.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:yf,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:yf,targetName:"Layers"}]),lr(yf.Enum,"Layers.Enum",[{name:"ALWAYS"}]),lr(yf.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var Fg=new Float32Array(4),zg=(new Pn,new Ni),Dg=new Xi(0,0,0,0),Ng=function(){function t(e){y(this,t),this._root=void 0,this._device=void 0,this._name="BasePipeline",this._renderObjects=[],this._renderPasses=new Map,this._flows=[],this._isHDRSupported=!1,this._isHDR=!1,this._lightMeterScale=1e4,this._shadingPass=null,this._fboCount=0,this._msaaShadingTex=null,this._msaaShadingTexView=null,this._msaaDepthStencilTex=null,this._msaaDepthStencilTexView=null,this._msaaShadingFBO=null,this._colorFmt=ru.UNKNOWN,this._depthStencilFmt=ru.UNKNOWN,this._shadingTextures=[],this._shadingTexViews=[],this._depthStencilTex=null,this._depthStencilTexView=null,this._shadingFBOs=[],this._shadingWidth=0,this._shadingHeight=0,this._shadingScale=1,this._curIdx=0,this._prevIdx=1,this._usePostProcess=!1,this._useMSAA=!1,this._useSMAA=!1,this._smaaPass=null,this._smaaEdgeFBO=null,this._smaaEdgeTex=null,this._smaaEdgeTexView=null,this._smaaBlendFBO=null,this._smaaBlendTex=null,this._smaaBlendTexView=null,this._quadVB=null,this._quadIB=null,this._quadIA=null,this._uboGlobal=new Af,this._globalBindings=new Map,this._defaultTex=null,this._defaultTexView=null,this._fpScale=1/1024,this._fpScaleInv=1024,this._macros={},this._useDynamicBatching=!1,this._root=e,this._device=e.device}return l(t,[{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"name",get:function(){return this._name}},{key:"renderObjects",get:function(){return this._renderObjects}},{key:"flows",get:function(){return this._flows}},{key:"usePostProcess",get:function(){return this._usePostProcess}},{key:"isHDRSupported",get:function(){return this._isHDRSupported}},{key:"isHDR",get:function(){return this._isHDR}},{key:"shadingScale",get:function(){return this._shadingScale}},{key:"lightMeterScale",set:function(e){this._lightMeterScale=e},get:function(){return this._lightMeterScale}},{key:"depthStencilTexView",get:function(){return this._depthStencilTexView}},{key:"curShadingTexView",get:function(){return this._shadingTexViews[this._curIdx]}},{key:"prevShadingTexView",get:function(){return this._shadingTexViews[this._prevIdx]}},{key:"curShadingFBO",get:function(){return this._shadingFBOs[this._curIdx]}},{key:"prevShadingFBO",get:function(){return this._shadingFBOs[this._prevIdx]}},{key:"msaaShadingFBO",get:function(){return this._msaaShadingFBO}},{key:"useMSAA",get:function(){return this._useMSAA}},{key:"useSMAA",get:function(){return this._useSMAA}},{key:"smaaEdgeTexView",get:function(){return this._smaaEdgeTexView}},{key:"smaaEdgeFBO",get:function(){return this._smaaEdgeFBO}},{key:"smaaBlendTexView",get:function(){return this._smaaBlendTexView}},{key:"smaaBlendFBO",get:function(){return this._smaaBlendFBO}},{key:"quadIA",get:function(){return this._quadIA}},{key:"globalBindings",get:function(){return this._globalBindings}},{key:"defaultTexture",get:function(){return this._defaultTex}},{key:"fpScale",get:function(){return this._fpScale}},{key:"fpScaleInv",get:function(){return this._fpScaleInv}},{key:"macros",get:function(){return this._macros}},{key:"defaultGlobalUBOData",get:function(){return this._uboGlobal.view}},{key:"useDynamicBatching",get:function(){return this._useDynamicBatching}}]),l(t,[{key:"render",value:function(e){e.camera.update(),this.sceneCulling(e),this.updateUBOs(e);var t=e.flows,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.render(e)}}},{key:"rebuild",value:function(){this.updateMacros()}},{key:"resize",value:function(e,t){var i=Math.floor(e*this._shadingScale),n=Math.floor(t*this._shadingScale);(i>this._shadingWidth||n>this._shadingHeight)&&this.resizeFBOs(i,n);var r=this._flows,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}o.resize(e,t)}}},{key:"swapFBOs",value:function(){var e=this._curIdx;this._curIdx=this._prevIdx,this._prevIdx=e}},{key:"addRenderPass",value:function(e,t){t&&this._renderPasses.set(e,t)}},{key:"getRenderPass",value:function(e){var t=this._renderPasses.get(e);return t||null}},{key:"removeRenderPass",value:function(e){this._renderPasses.delete(e)}},{key:"clearRenderPasses",value:function(){this._renderPasses.clear()}},{key:"createFlow",value:function(e,t){var i=new e(this);return i.initialize(t)?(this._flows.push(i),this._flows.sort(function(e,t){return e.priority-t.priority}),i):null}},{key:"destroyFlows",value:function(){var e=this._flows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._flows=[]}},{key:"getFlow",value:function(e){var t=this._flows,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.name===e)return a}return null}},{key:"updateMacros",value:function(){a_.destroyShaderByDefines(this._macros),this._macros.CC_USE_HDR=this._isHDR;var e=this._root.scenes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.onPipelineChange()}}},{key:"_initialize",value:function(e){if(void 0!==e.enablePostProcess?this._usePostProcess=e.enablePostProcess:this._usePostProcess=!1,this._usePostProcess&&((this._device.hasFeature(kc.FORMAT_R11G11B10F)||this._device.hasFeature(kc.TEXTURE_HALF_FLOAT)||this._device.hasFeature(kc.TEXTURE_FLOAT))&&(this._isHDRSupported=!0),this._fboCount=1,this._shadingTextures=new Array(this._fboCount),this._shadingTexViews=new Array(this._fboCount),this._shadingFBOs=new Array(this._fboCount),this._isHDR=void 0===e.enableHDR||e.enableHDR,this._useSMAA=void 0!==e.enableSMAA&&e.enableSMAA,this._useMSAA=void 0!==e.enableMSAA&&e.enableMSAA,this._useMSAA&&(this._useMSAA=this.device.hasFeature(kc.MSAA))),this._isHDR&&this._isHDRSupported&&(this._device.hasFeature(kc.COLOR_HALF_FLOAT)&&this._device.hasFeature(kc.TEXTURE_HALF_FLOAT_LINEAR)?this._device.hasFeature(kc.FORMAT_R11G11B10F)?(this._colorFmt=ru.R11G11B10F,this._isHDR=!0):this._device.hasFeature(kc.TEXTURE_HALF_FLOAT)&&(this._colorFmt=ru.RGBA16F,this._isHDR=!0):this._device.hasFeature(kc.COLOR_FLOAT)&&this._device.hasFeature(kc.TEXTURE_FLOAT_LINEAR)&&this._device.hasFeature(kc.TEXTURE_FLOAT)&&(this._colorFmt=ru.RGBA32F,this._isHDR=!0),this._isHDR=!1),this._isHDR||(this._colorFmt=ru.RGBA8),24===this._device.depthBits?8===this._device.stencilBits?this._depthStencilFmt=ru.D24S8:this._depthStencilFmt=ru.D24:this._depthStencilFmt=ru.D16,this.updateMacros(),this._shadingScale=1,this._shadingWidth=Math.floor(this._device.nativeWidth),this._shadingHeight=Math.floor(this._device.nativeHeight),console.info("USE_POST_PROCESS: "+this._usePostProcess),this._usePostProcess&&(console.info("USE_MSAA: "+this._useMSAA),console.info("USE_SMAA: "+this._useSMAA),console.info("USE_HDR: "+this._isHDR)),console.info("SHADING_SIZE: "+this._shadingWidth+" x "+this._shadingHeight),console.info("SHADING_SCALE: "+this._shadingScale.toFixed(4)),console.info("SHADING_COLOR_FORMAT: "+xc[this._colorFmt].name),console.info("SHADING_DEPTH_FORMAT: "+xc[this._depthStencilFmt].name),this._shadingPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:Ju.CLEAR,storeOp:ec.STORE,sampleCount:1,beginLayout:ic.COLOR_ATTACHMENT_OPTIMAL,endLayout:ic.COLOR_ATTACHMENT_OPTIMAL}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:Ju.CLEAR,depthStoreOp:ec.STORE,stencilLoadOp:Ju.CLEAR,stencilStoreOp:ec.STORE,sampleCount:1,beginLayout:ic.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:ic.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}}),this._useMSAA&&(this._msaaShadingTex=this._device.createTexture({type:Fu.TEX2D,usage:Du.COLOR_ATTACHMENT|Du.SAMPLED,format:this._colorFmt,width:this._shadingWidth,height:this._shadingHeight}),this._msaaShadingTexView=this._device.createTextureView({texture:this._msaaShadingTex,type:Wu.TV2D,format:this._colorFmt}),this._msaaDepthStencilTex=this._device.createTexture({type:Fu.TEX2D,usage:Du.DEPTH_STENCIL_ATTACHMENT|Du.SAMPLED,format:this._depthStencilFmt,width:this._shadingWidth,height:this._shadingHeight}),this._msaaDepthStencilTexView=this._device.createTextureView({texture:this._msaaDepthStencilTex,type:Wu.TV2D,format:this._depthStencilFmt}),this._msaaShadingFBO=this._device.createFramebuffer({renderPass:this._shadingPass,colorViews:[this._msaaShadingTexView],depthStencilView:this._msaaDepthStencilTexView})),0<this._fboCount){this._depthStencilTex=this._device.createTexture({type:Fu.TEX2D,usage:Du.DEPTH_STENCIL_ATTACHMENT|Du.SAMPLED,format:this._depthStencilFmt,width:this._shadingWidth,height:this._shadingHeight}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:Wu.TV2D,format:this._depthStencilFmt});for(var t=0;t<this._fboCount;++t)this._shadingTextures[t]=this._device.createTexture({type:Fu.TEX2D,usage:Du.COLOR_ATTACHMENT|Du.SAMPLED,format:this._colorFmt,width:this._shadingWidth,height:this._shadingHeight}),this._shadingTexViews[t]=this._device.createTextureView({texture:this._shadingTextures[t],type:Wu.TV2D,format:this._colorFmt}),this._shadingFBOs[t]=this._device.createFramebuffer({renderPass:this._shadingPass,colorViews:[this._shadingTexViews[t]],depthStencilView:this._depthStencilTexView})}if(this._useSMAA){var i=ru.RGBA8;this._smaaPass=this._device.createRenderPass({colorAttachments:[{format:i,loadOp:Ju.CLEAR,storeOp:ec.STORE,sampleCount:1,beginLayout:ic.COLOR_ATTACHMENT_OPTIMAL,endLayout:ic.COLOR_ATTACHMENT_OPTIMAL}]}),this._smaaEdgeTex=this._device.createTexture({type:Fu.TEX2D,usage:Du.COLOR_ATTACHMENT|Du.SAMPLED,format:i,width:this._shadingWidth,height:this._shadingHeight}),this._smaaEdgeTexView=this._device.createTextureView({texture:this._smaaEdgeTex,type:Wu.TV2D,format:i}),this._smaaEdgeFBO=this._device.createFramebuffer({renderPass:this._smaaPass,colorViews:[this._smaaEdgeTexView],depthStencilView:null}),this._smaaBlendTex=this._device.createTexture({type:Fu.TEX2D,usage:Du.COLOR_ATTACHMENT|Du.SAMPLED,format:i,width:this._shadingWidth,height:this._shadingHeight}),this._smaaBlendTexView=this._device.createTextureView({texture:this._smaaBlendTex,type:Wu.TV2D,format:i}),this._smaaBlendFBO=this._device.createFramebuffer({renderPass:this._smaaPass,colorViews:[this._smaaBlendTexView],depthStencilView:null})}return!!this.createQuadInputAssembler()&&!!this.createUBOs()}},{key:"_destroy",value:function(){this.destroyFlows(),this.clearRenderPasses(),this.destroyQuadInputAssembler(),this.destroyUBOs(),this._smaaEdgeTexView&&(this._smaaEdgeTexView.destroy(),this._smaaEdgeTexView=null),this._smaaEdgeTex&&(this._smaaEdgeTex.destroy(),this._smaaEdgeTex=null),this._smaaEdgeFBO&&(this._smaaEdgeFBO.destroy(),this._smaaEdgeFBO=null),this._smaaBlendTexView&&(this._smaaBlendTexView.destroy(),this._smaaBlendTexView=null),this._smaaBlendTex&&(this._smaaBlendTex.destroy(),this._smaaBlendTex=null),this._smaaBlendFBO&&(this._smaaBlendFBO.destroy(),this._smaaBlendFBO=null),this._msaaShadingTexView&&(this._msaaShadingTexView.destroy(),this._msaaShadingTexView=null),this._msaaShadingTex&&(this._msaaShadingTex.destroy(),this._msaaShadingTex=null),this._msaaDepthStencilTexView&&(this._msaaDepthStencilTexView.destroy(),this._msaaDepthStencilTexView=null),this._msaaDepthStencilTex&&(this._msaaDepthStencilTex.destroy(),this._msaaDepthStencilTex=null),this._msaaShadingFBO&&(this._msaaShadingFBO.destroy(),this._msaaShadingFBO=null);for(var e=0;e<this._shadingTexViews.length;++e)this._shadingTexViews[e]&&this._shadingTexViews[e].destroy(),this._shadingTextures[e]&&this._shadingTextures[e].destroy(),this._shadingFBOs[e]&&this._shadingFBOs[e].destroy();this._shadingTexViews.splice(0),this._shadingTextures.splice(0),this._shadingFBOs.splice(0),this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._shadingPass&&(this._shadingPass.destroy(),this._shadingPass=null)}},{key:"resizeFBOs",value:function(e,t){this._shadingWidth=e,this._shadingHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:Wu.TV2D,format:this._depthStencilFmt}));for(var i=0;i<this._fboCount;++i)this._shadingTextures[i].resize(e,t),this._shadingTexViews[i].destroy(),this._shadingTexViews[i].initialize({texture:this._shadingTextures[i],type:Wu.TV2D,format:this._colorFmt}),this._shadingFBOs[i].destroy(),this._shadingFBOs[i].initialize({renderPass:this._shadingPass,colorViews:[this._shadingTexViews[i]],depthStencilView:this._depthStencilTexView});if(this._useMSAA&&(this._msaaShadingTex.resize(e,t),this._msaaShadingTexView.destroy(),this._msaaShadingTexView.initialize({texture:this._msaaShadingTex,type:Wu.TV2D,format:this._colorFmt}),this._msaaDepthStencilTex.resize(e,t),this._msaaDepthStencilTexView.destroy(),this._msaaDepthStencilTexView.initialize({texture:this._msaaDepthStencilTex,type:Wu.TV2D,format:this._depthStencilFmt}),this._msaaShadingFBO.destroy(),this._msaaShadingFBO.initialize({renderPass:this._shadingPass,colorViews:[this._msaaShadingTexView],depthStencilView:this._msaaDepthStencilTexView})),this._useSMAA){var n=this._smaaEdgeTex.format;this._smaaEdgeTex.resize(e,t),this._smaaEdgeTexView.destroy(),this._smaaEdgeTexView.initialize({texture:this._smaaEdgeTex,type:Wu.TV2D,format:n}),this._smaaEdgeFBO.destroy(),this._smaaEdgeFBO.initialize({renderPass:this._smaaPass,colorViews:[this._smaaEdgeTexView],depthStencilView:null}),this._smaaBlendTex.resize(e,t),this._smaaBlendTexView.destroy(),this._smaaBlendTexView.initialize({texture:this._smaaBlendTex,type:Wu.TV2D,format:n}),this._smaaBlendFBO.destroy(),this._smaaBlendFBO.initialize({renderPass:this._smaaPass,colorViews:[this._smaaBlendTexView],depthStencilView:null})}console.info("Resizing shading fbos: "+this._shadingWidth+"x"+this._shadingHeight)}},{key:"createQuadInputAssembler",value:function(){var e=4*Float32Array.BYTES_PER_ELEMENT,t=4*e;if(this._quadVB=this._device.createBuffer({usage:su.VERTEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:t,stride:e}),!this._quadVB)return!1;var i=new Float32Array(16),n=0;i[n++]=-1,i[n++]=-1,i[n++]=0,i[n++]=0,i[n++]=1,i[n++]=-1,i[n++]=1,i[n++]=0,i[n++]=-1,i[n++]=1,i[n++]=0,i[n++]=1,i[n++]=1,i[n++]=1,i[n++]=1,i[n++]=1,this._quadVB.update(i);var r=Uint8Array.BYTES_PER_ELEMENT,a=6*r;if(this._quadIB=this._device.createBuffer({usage:su.INDEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:a,stride:r}),!this._quadIB)return!1;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,this._quadIB.update(s);var o=[{name:"a_position",format:ru.RG32F},{name:"a_texCoord",format:ru.RG32F}];return this._quadIA=this._device.createInputAssembler({attributes:o,vertexBuffers:[this._quadVB],indexBuffer:this._quadIB}),!0}},{key:"destroyQuadInputAssembler",value:function(){this._quadVB&&(this._quadVB.destroy(),this._quadVB=null),this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadIA&&(this._quadIA.destroy(),this._quadIA=null)}},{key:"createUBOs",value:function(){if(!this._globalBindings.get(Af.BLOCK.name)){var e=this._root.device.createBuffer({usage:su.UNIFORM|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:Af.SIZE});this._globalBindings.set(Af.BLOCK.name,{type:Yu.UNIFORM_BUFFER,blockInfo:Af.BLOCK,buffer:e})}if(!this._globalBindings.get(Cf.BLOCK.name)){var t=this._root.device.createBuffer({usage:su.UNIFORM|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:Cf.SIZE});this._globalBindings.set(Cf.BLOCK.name,{type:Yu.UNIFORM_BUFFER,blockInfo:Cf.BLOCK,buffer:t})}return this._globalBindings.get(Rf.name)||this._globalBindings.set(Rf.name,{type:Yu.SAMPLER,samplerInfo:Rf}),!0}},{key:"destroyUBOs",value:function(){var e=this._globalBindings.get(Af.BLOCK.name);e&&(e.buffer.destroy(),this._globalBindings.delete(Af.BLOCK.name));var t=this._globalBindings.get(Cf.BLOCK.name);t&&(t.buffer.destroy(),this._globalBindings.delete(Cf.BLOCK.name))}},{key:"updateUBOs",value:function(e){var t=e.camera,i=t.scene,n=this._root.device,r=i.mainLight,a=i.ambient,s=this._uboGlobal.view;s[Af.TIME_OFFSET]=this._root.cumulativeTime,s[Af.SCREEN_SIZE_OFFSET]=n.width,s[Af.SCREEN_SIZE_OFFSET+1]=n.height,s[Af.SCREEN_SIZE_OFFSET+2]=1/s[Af.SCREEN_SIZE_OFFSET],s[Af.SCREEN_SIZE_OFFSET+3]=1/s[Af.SCREEN_SIZE_OFFSET+1],s[Af.SCREEN_SCALE_OFFSET]=t.width/this._shadingWidth*this._shadingScale,s[Af.SCREEN_SCALE_OFFSET+1]=t.height/this._shadingHeight*this._shadingScale,s[Af.SCREEN_SCALE_OFFSET+2]=1/s[Af.SCREEN_SCALE_OFFSET],s[Af.SCREEN_SCALE_OFFSET+3]=1/s[Af.SCREEN_SCALE_OFFSET+1],s[Af.NATIVE_SIZE_OFFSET]=this._shadingWidth,s[Af.NATIVE_SIZE_OFFSET+1]=this._shadingHeight,s[Af.NATIVE_SIZE_OFFSET+2]=1/s[Af.NATIVE_SIZE_OFFSET],s[Af.NATIVE_SIZE_OFFSET+3]=1/s[Af.NATIVE_SIZE_OFFSET+1],Pn.toArray(s,t.matView,Af.MAT_VIEW_OFFSET),Pn.toArray(s,t.node.worldMatrix,Af.MAT_VIEW_INV_OFFSET),Pn.toArray(s,t.matProj,Af.MAT_PROJ_OFFSET),Pn.toArray(s,t.matProjInv,Af.MAT_PROJ_INV_OFFSET),Pn.toArray(s,t.matViewProj,Af.MAT_VIEW_PROJ_OFFSET),Pn.toArray(s,t.matViewProjInv,Af.MAT_VIEW_PROJ_INV_OFFSET),Ni.toArray(s,t.position,Af.CAMERA_POS_OFFSET);var o=t.exposure;if(s[Af.EXPOSURE_OFFSET]=o,s[Af.EXPOSURE_OFFSET+1]=1/o,s[Af.EXPOSURE_OFFSET+2]=this._isHDR?1:0,s[Af.EXPOSURE_OFFSET+3]=this._fpScale/o,Ni.toArray(s,r.direction,Af.MAIN_LIT_DIR_OFFSET),r.enabled){if(Ni.toArray(s,r.color,Af.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var l=r.colorTemperatureRGB;s[Af.MAIN_LIT_COLOR_OFFSET]*=l.x,s[Af.MAIN_LIT_COLOR_OFFSET+1]*=l.y,s[Af.MAIN_LIT_COLOR_OFFSET+2]*=l.z}this._isHDR?s[Af.MAIN_LIT_COLOR_OFFSET+3]=r.illuminance*this._fpScale:s[Af.MAIN_LIT_COLOR_OFFSET+3]=r.illuminance*o}else Xi.toArray(s,Dg,Af.MAIN_LIT_COLOR_OFFSET);Fg.set(a.skyColor),this._isHDR?Fg[3]=a.skyIllum*this._fpScale:Fg[3]=a.skyIllum*o,this._uboGlobal.view.set(Fg,Af.AMBIENT_SKY_OFFSET),this._uboGlobal.view.set(a.groundAlbedo,Af.AMBIENT_GROUND_OFFSET),this._globalBindings.get(Af.BLOCK.name).buffer.update(this._uboGlobal.view.buffer)}},{key:"sceneCulling",value:function(e){var t=e.camera,i=t.scene;this._renderObjects.splice(0);var n=i.mainLight;n&&n.enabled&&n.update();var r=i.planarShadows;r.enabled&&n.node.hasChangedFlags&&r.updateDirLight(n),i.skybox.enabled&&t.clearFlag&Dv&&this.addVisibleModel(i.skybox,t);var a=i.models,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l;if(u._resetUBOUpdateFlag(),u.enabled)if(e.visibility&yf.BitMask.UI_2D)(u.node&&e.visibility===u.node.layer||e.visibility===u.visFlags)&&(u.updateTransform(),u.updateUBOs(),this.addVisibleModel(u,t));else if(u.node&&e.visibility&u.node.layer||e.visibility&u.visFlags){if(u.updateTransform(),u.worldBounds&&!ja.aabb_frustum(u.worldBounds,t.frustum))continue;u.updateUBOs(),this.addVisibleModel(u,t)}}r.enabled&&r.updateCommandBuffers()}},{key:"addVisibleModel",value:function(e,t){var i=0;e.node&&(e.node.getWorldPosition(zg),Ni.subtract(zg,zg,t.position),i=Ni.dot(zg,t.forward)),this._renderObjects.push({model:e,depth:i})}}]),t}(),Ug=function(){function i(e,t){y(this,i),this.array=void 0,this.length=0,this.cache=void 0,this._compareFn=void 0,this.array=new Array(e),this.cache=this.array,this.length=0,this._compareFn=void 0!==t?t:function(e,t){return e-t}}return l(i,[{key:"push",value:function(e){this.array[this.length++]=e}},{key:"pop",value:function(){return this.array[this.length--]}},{key:"get",value:function(e){return this.array[e]}},{key:"clear",value:function(){this.cache.fill(null),this.length=0}},{key:"sort",value:function(){this.array.length=this.length,this.array.sort(this._compareFn)}},{key:"concat",value:function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e.array[t]}},{key:"append",value:function(e){var t=e,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;this.array[this.length++]=a}}}]),i}();function Vg(e,t){return e.hash===t.hash?e.depth===t.depth?e.shaderId-t.shaderId:e.depth-t.depth:e.hash-t.hash}function Gg(e,t){return e.hash===t.hash?e.depth===t.depth?e.shaderId-t.shaderId:t.depth-e.depth:e.hash-t.hash}var Hg=function(){function t(e){y(this,t),this.queue=void 0,this.cmdBuffs=void 0,this.cmdBuffCount=0,this._passDesc=void 0,this._passDesc=e,this.cmdBuffs=new Ug(64),this.queue=new Ug(64,this._passDesc.sortFunc)}return l(t,[{key:"clear",value:function(){this.queue.clear(),this.cmdBuffCount=0}},{key:"insertRenderPass",value:function(e,t,i){var n=e.model.getSubModel(t),r=n.passes[i],a=n.psos[i];if(a.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var s=0|r.priority<<16|n.priority<<8|i;return this.queue.push({hash:s,depth:e.depth,shaderId:a.shader.id,subModel:n,cmdBuff:n.commandBuffers[i]}),!0}},{key:"sort",value:function(){this.queue.sort(),this.cmdBuffCount=this.queue.length;for(var e=0;e<this.queue.length;++e)this.cmdBuffs.array[e]=this.queue.array[e].cmdBuff}}]),t}(),Wg=[],qg=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._uiQueue=void 0,t._uiQueue=new Hg({isTransparent:!0,phases:n_("default"),sortFunc:Gg}),t}return _(i,kv),l(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,void 0!==e.framebuffer&&(this._framebuffer=e.framebuffer),this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:Qu.PRIMARY}),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){this._uiQueue.clear();var t=this._pipeline.renderObjects,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}for(var a=r,s=0;s<a.model.subModelNum;s++)for(var o=0;o<a.model.getSubModel(s).passes.length;o++)this._uiQueue.insertRenderPass(a,s,o)}this._uiQueue.sort();var l=e.window.framebuffer,u=this._cmdBuff,c=e.camera;this._renderArea.width=this.flow.pipeline.root.device.width,this._renderArea.height=this.flow.pipeline.root.device.height,u.begin(),u.beginRenderPass(l,this._renderArea,c.clearFlag,[c.clearColor],c.clearDepth,c.clearStencil),u.execute(this._uiQueue.cmdBuffs.array,this._uiQueue.cmdBuffCount),u.endRenderPass(),u.end(),Wg[0]=u,this._device.queue.submit(Wg)}}]),i}(),jg=function(){function i(e){return y(this,i),x(this,g(i).call(this,e))}return _(i,Cv),l(i,[{key:"initialize",value:function(e){void 0!==e.name&&(this._name=e.name),this._priority=e.priority;var t=this._pipeline.root.mainWindow;return!(!t||!t.framebuffer)&&(this.createStage(qg,{name:"UIStage",priority:0,framebuffer:t.framebuffer}),!0)}},{key:"destroy",value:function(){this.destroyStages()}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){var t=this.pipeline.defaultGlobalUBOData[Af.EXPOSURE_OFFSET+2];this.pipeline.defaultGlobalUBOData[Af.EXPOSURE_OFFSET+2]=0,this.pipeline.globalBindings.get(Af.BLOCK.name).buffer.update(this.pipeline.defaultGlobalUBOData.buffer),p(g(i.prototype),"render",this).call(this,e),this.pipeline.defaultGlobalUBOData[Af.EXPOSURE_OFFSET+2]=t,this.pipeline.globalBindings.get(Af.BLOCK.name).buffer.update(this.pipeline.defaultGlobalUBOData.buffer)}}]),i}();var Xg,Yg,Kg=function(){function e(){y(this,e),this.queue=new Set}return l(e,[{key:"clear",value:function(){var e=this.queue.values(),t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.clear()}this.queue.clear()}},{key:"recordCommandBuffer",value:function(e){var t=this.queue.values(),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;a.pso&&(e.bindPipelineState(a.pso),e.bindBindingLayout(a.pso.pipelineLayout.layouts[0]));for(var s=0;s<a.batches.length;++s){var o=a.batches[s];a.ubo.update(o.uboLocal.view),e.bindInputAssembler(o.ia),e.draw(o.ia)}}}}]),e}(),Qg=[],Zg=[],Jg=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._opaqueQueue=void 0,t._transparentQueue=void 0,t._opaqueBatchedQueue=void 0,t._opaqueQueue=new Hg({isTransparent:!1,phases:n_("default"),sortFunc:Vg}),t._transparentQueue=new Hg({isTransparent:!0,phases:n_("default")|n_("planarShadow"),sortFunc:Gg}),t._opaqueBatchedQueue=new Kg,t}return _(i,kv),l(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:Qu.PRIMARY}),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){this._opaqueBatchedQueue.clear(),this._opaqueQueue.clear(),this._transparentQueue.clear();for(var t=this._pipeline.renderObjects,i=0;i<t.length;++i){var n=t[i];if(n.model.isDynamicBatching)for(var r=0;r<n.model.subModels.length;++r)for(var a=n.model.subModels[r],s=a.passes,o=0;o<s.length;++o){var l=a.passes[o];if(l.batchedBuffer){var u=a.psos[o];if(u.blendState.targets[0].blend){var c=0|l.priority<<16|a.priority<<8|o;this._transparentQueue.queue.push({hash:c,depth:n.depth,shaderId:u.shader.id,subModel:a,cmdBuff:a.commandBuffers[o]})}else l.batchedBuffer.merge(a,n),this._opaqueBatchedQueue.queue.add(l.batchedBuffer)}}else for(var h=n.model.subModels,f=0;f<h.length;++f)for(var d=h[f],_=d.passes,p=0;p<_.length;++p){var v=d.passes[p],m=d.psos[p],y=m.blendState.targets[0].blend,g=0|v.priority<<16|d.priority<<8|p;y?this._transparentQueue.queue.push({hash:g,depth:n.depth,shaderId:m.shader.id,subModel:d,cmdBuff:d.commandBuffers[p]}):this._opaqueQueue.queue.push({hash:g,depth:n.depth,shaderId:m.shader.id,subModel:d,cmdBuff:d.commandBuffers[p]})}}this._opaqueQueue.sort(),this._transparentQueue.sort();var b=e.camera,x=this._cmdBuff,S=b.viewport;if(this._renderArea.x=S.x*b.width,this._renderArea.y=S.y*b.height,this._renderArea.width=S.width*b.width*this.pipeline.shadingScale,this._renderArea.height=S.height*b.height*this.pipeline.shadingScale,b.clearFlag&dc.COLOR){if(Qg[0]=b.clearColor,this._pipeline.isHDR){Qg[0]=function(e){return{r:Math.pow(e.r,2.2),g:Math.pow(e.g,2.2),b:Math.pow(e.b,2.2),a:1}}(Qg[0]);var T=this._pipeline.fpScale/b.exposure;Qg[0].r*=T,Qg[0].g*=T,Qg[0].b*=T}Qg.length=1}this._pipeline.usePostProcess?this._pipeline.useMSAA?this._framebuffer=this._pipeline.msaaShadingFBO:this._framebuffer=this._pipeline.curShadingFBO:this._framebuffer=e.window.framebuffer;var w=b.scene.planarShadows;x.begin(),x.beginRenderPass(this._framebuffer,this._renderArea,b.clearFlag,Qg,b.clearDepth,b.clearStencil),x.execute(this._opaqueQueue.cmdBuffs.array,this._opaqueQueue.cmdBuffCount),this._opaqueBatchedQueue.recordCommandBuffer(x),x.execute(w.cmdBuffs.array,w.cmdBuffCount),x.execute(this._transparentQueue.cmdBuffs.array,this._transparentQueue.cmdBuffCount),x.endRenderPass(),x.end(),Zg[0]=x,this._device.queue.submit(Zg),this._pipeline.useMSAA&&this._device.blitFramebuffer(this._framebuffer,this._pipeline.curShadingFBO,this._renderArea,this._renderArea,Iu.POINT)}}]),i}();(Yg=Xg=Xg||{})[Yg.FORWARD=0]="FORWARD";var $g,eb,tb=function(){function t(e){return y(this,t),x(this,g(t).call(this,e))}return _(t,Cv),l(t,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this.createStage(Jg,{name:"ForwardStage",priority:Xg.FORWARD}),!0}},{key:"destroy",value:function(){this.destroyStages()}},{key:"rebuild",value:function(){}}]),t}();(eb=$g=$g||{})[eb.FORWARD=0]="FORWARD",eb[eb.UI=10]="UI";var ib,nb,rb=new Float32Array(4),ab=rs.create(0,0,0,1),sb=[],ob=[],lb=new Ni,ub=function(){function f(e){var t;return y(this,f),(t=x(this,g(f).call(this,e)))._uboLights=new Mf,t._lightsUBO=null,t._validLights=void 0,t._lightIndexOffset=void 0,t._lightIndices=void 0,t._validLights=[],t._lightIndexOffset=[],t._lightIndices=[],t}return _(f,Ng),l(f,[{key:"lightsUBO",get:function(){return this._lightsUBO}}]),l(f,[{key:"initialize",value:function(e){if(!this._initialize(e))return!1;if(this._name="ForwardPipeline",!this._globalBindings.get(Mf.BLOCK.name)){var t=this._root.device.createBuffer({usage:su.UNIFORM|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:Mf.SIZE});if(!t)return!1;this._globalBindings.set(Mf.BLOCK.name,{type:Yu.UNIFORM_BUFFER,blockInfo:Mf.BLOCK,buffer:t})}var i=this._root.mainWindow,n=null;return i&&(n=i.renderPass),n?(this.addRenderPass(gf.DEFAULT,n),this.createFlow(tb,{name:"ForwardFlow",priority:$g.FORWARD}),this._usePostProcess&&(this._useSMAA,this.createFlow(Ov,{name:"ToneMapFlow",priority:0})),this.createFlow(jg,{name:"UIFlow",priority:$g.UI}),!0):(console.error("RenderPass of main window is null."),!1)}},{key:"destroy",value:function(){var e=this._globalBindings.get(Mf.BLOCK.name);e&&(e.buffer.destroy(),this._globalBindings.delete(Mf.BLOCK.name)),this._destroy()}},{key:"rebuild",value:function(){p(g(f.prototype),"rebuild",this).call(this);var e=this._flows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.rebuild()}}},{key:"updateUBOs",value:function(e){p(g(f.prototype),"updateUBOs",this).call(this,e);for(var t=e.camera.exposure,i=0;i<this._renderObjects.length;i++){this._uboLights.view.fill(0);var n=i+1<this._renderObjects.length?this._lightIndexOffset[i+1]:this._lightIndices.length;if(this._renderObjects[i].model.localBindings.get(Mf.BLOCK.name)){for(var r=0,a=0,s=this._lightIndexOffset[i];s<n;s++){var o=this._validLights[this._lightIndices[s]];if(o&&o.enabled)switch(o.type){case ov.SPHERE:if(Mf.MAX_SPHERE_LIGHTS<=r)continue;var l=o;if(Ni.toArray(rb,l.position),this._uboLights.view.set(rb,Mf.SPHERE_LIGHT_POS_OFFSET+4*r),rb[0]=l.size,rb[1]=l.range,rb[2]=0,this._uboLights.view.set(rb,Mf.SPHERE_LIGHT_SIZE_RANGE_OFFSET+4*r),Ni.toArray(rb,o.color),o.useColorTemperature){var u=o.colorTemperatureRGB;rb[0]*=u.x,rb[1]*=u.y,rb[2]*=u.z}rb[3]=l.luminance*this._lightMeterScale,this._isHDR?rb[3]=l.luminance*this._fpScale*this._lightMeterScale:rb[3]=l.luminance*t*this._lightMeterScale,this._uboLights.view.set(rb,Mf.SPHERE_LIGHT_COLOR_OFFSET+4*r),r++;break;case ov.SPOT:if(Mf.MAX_SPOT_LIGHTS<=a)continue;var c=o;if(Ni.toArray(rb,c.position),rb[3]=c.size,this._uboLights.view.set(rb,Mf.SPOT_LIGHT_POS_OFFSET+4*a),rb[0]=c.size,rb[1]=c.range,rb[2]=c.spotAngle,this._uboLights.view.set(rb,Mf.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET+4*a),Ni.toArray(rb,c.direction),this._uboLights.view.set(rb,Mf.SPOT_LIGHT_DIR_OFFSET+4*a),Ni.toArray(rb,o.color),o.useColorTemperature){var h=o.colorTemperatureRGB;rb[0]*=h.x,rb[1]*=h.y,rb[2]*=h.z}this._isHDR?rb[3]=c.luminance*this._fpScale*this._lightMeterScale:rb[3]=c.luminance*t*this._lightMeterScale,this._uboLights.view.set(rb,Mf.SPOT_LIGHT_COLOR_OFFSET+4*a),a++}}this._renderObjects[i].model.localBindings.get(Mf.BLOCK.name).buffer.update(this._uboLights.view)}}}},{key:"sceneCulling",value:function(e){p(g(f.prototype),"sceneCulling",this).call(this,e),this._validLights.splice(0);var t=e.camera.scene.sphereLights,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;a.enabled&&(a.update(),rs.set(ab,a.position.x,a.position.y,a.position.z,a.range),ja.sphere_frustum(ab,e.camera.frustum)&&this._validLights.push(a))}var s=e.camera.scene.spotLights,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if(o){if(l>=s.length)break;u=s[l++]}else{if((l=s.next()).done)break;u=l.value}var c=u;c.enabled&&(c.update(),rs.set(ab,c.position.x,c.position.y,c.position.z,c.range),ja.sphere_frustum(ab,e.camera.frustum)&&this._validLights.push(c))}this._lightIndexOffset.splice(0),this._lightIndices.splice(0);for(var h=0;h<this._renderObjects.length;h++)this._lightIndexOffset[h]=this._lightIndices.length,this._renderObjects[h].model.localBindings.get(Mf.BLOCK.name)&&this.cullLightPerModel(this._renderObjects[h].model)}},{key:"cullLightPerModel",value:function(e){var t,i,n,r,a;sb.splice(0);for(var s=0;s<this._validLights.length;s++){var o=!1;switch(this._validLights[s].type){case ov.DIRECTIONAL:this._validLights[s],o=!1;break;case ov.SPHERE:r=this._validLights[s],o=!(!(a=e).worldBounds||ja.aabb_aabb(a.worldBounds,r.aabb));break;case ov.SPOT:i=this._validLights[s],o=!(!(n=e).worldBounds||ja.aabb_aabb(n.worldBounds,i.aabb)&&ja.aabb_frustum(n.worldBounds,i.frustum))}o||(sb.push(s),this._validLights[s].type===ov.DIRECTIONAL?ob[s]=0:ob[s]=Ni.distance(this._validLights[s].position,e.node.getWorldPosition(lb)))}sb.sort(this.sortLight),(t=this._lightIndices).push.apply(t,sb)}},{key:"sortLight",value:function(e,t){return ob[e]-ob[t]}}]),f}();(nb=ib=ib||{})[nb.GENERAL=100]="GENERAL";var cb=function(){function i(e,t){y(this,i),this._root=void 0,this._name="",this._window=null,this._priority=0,this._visibility=Pf,this._camera=void 0,this._isEnable=!0,this._flows=[],this._root=e,this._camera=t}return l(i,[{key:"name",get:function(){return this._name}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"visibility",set:function(e){this._visibility=e},get:function(){return this._visibility}},{key:"camera",get:function(){return this._camera}},{key:"isEnable",get:function(){return this._isEnable}},{key:"flows",get:function(){return this._flows}}],[{key:"registerCreateFunc",value:function(e){e._createViewFun=function(e,t){return new i(e,t)}}}]),l(i,[{key:"initialize",value:function(e){this._name=e.name,this.priority=e.priority,e.flows||(e.flows=["ForwardFlow","ToneMapFlow","SMAAFlow"]);var t=cc.director.root.pipeline.flows,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;-1!==e.flows.indexOf(a.name)&&this.flows.push(a)}return!0}},{key:"destroy",value:function(){this._window=null,this._priority=0}},{key:"enable",value:function(e){this._isEnable=e}}]),i}(),hb=new Ni(0,0,-1),fb=new Ni,db=new fn,_b=function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this,e,t,i)))._dir=new Ni(1,-1,-1),n._illum=65e3,n._type=ov.DIRECTIONAL,n}return _(r,vv),l(r,[{key:"direction",set:function(e){this._dir=e,Ni.normalize(this._dir,this._dir)},get:function(){return this._dir}},{key:"illuminance",set:function(e){this._illum=e},get:function(){return this._illum}}]),l(r,[{key:"update",value:function(){this._node&&(this._dir=Ni.transformQuat(fb,hb,this._node.getWorldRotation(db)),Ni.normalize(this._dir,this._dir))}}]),r}(),pb=new Ni(0,0,-1),vb=new Ni,mb=new fn,yb=function(){function n(e){y(this,n),this._scene=void 0,this._enabled=!1,this._normal=new Ni(0,1,0),this._distance=0,this._matLight=new Pn,this._data=Float32Array.from([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,.3]),this._globalBindings=void 0,this._cmdBuffs=void 0,this._cmdBuffCount=0,this._psoRecord=new Map,this._cbRecord=new Map,this._passNormal=void 0,this._passSkinning=void 0,this._scene=e,this._globalBindings=e.root.pipeline.globalBindings.get(Cf.BLOCK.name),this._cmdBuffs=new Ug(64);var t=P_.get("pipeline/planar-shadow"),i={CC_USE_SKINNING:Ld(e.root.device)};this._passNormal=__.createPasses(t,{techIdx:0,defines:[],states:[]})[0],this._passSkinning=__.createPasses(t,{techIdx:0,defines:[i],states:[]})[0]}return l(n,[{key:"enabled",set:function(e){this._enabled=e,this.updateDirLight(),this._cmdBuffs.clear()},get:function(){return this._enabled}},{key:"normal",set:function(e){Ni.copy(this._normal,e),this.updateDirLight()},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this.updateDirLight()},get:function(){return this._distance}},{key:"shadowColor",set:function(e){ar.toArray(this._data,e,Cf.SHADOW_COLOR_OFFSET),this._globalBindings.buffer.update(this.data)}},{key:"matLight",get:function(){return this._matLight}},{key:"data",get:function(){return this._data}},{key:"cmdBuffs",get:function(){return this._cmdBuffs}},{key:"cmdBuffCount",get:function(){return this._cmdBuffs.length}}]),l(n,[{key:"updateSphereLight",value:function(e){e.node.getWorldPosition(vb);var t=this._normal,i=this._distance,n=Ni.dot(t,vb),r=vb.x,a=vb.y,s=vb.z,o=t.x,l=t.y,u=t.z,c=this._matLight;c.m00=n-i-r*o,c.m01=-a*o,c.m02=-s*o,c.m03=-o,c.m04=-r*l,c.m05=n-i-a*l,c.m06=-s*l,c.m07=-l,c.m08=-r*u,c.m09=-a*u,c.m10=n-i-s*u,c.m11=-u,c.m12=r*i,c.m13=a*i,c.m14=s*i,c.m15=n,Pn.toArray(this.data,this._matLight),this._globalBindings.buffer.update(this.data)}},{key:"updateDirLight",value:function(e){(0<arguments.length&&void 0!==e?e:this._scene.mainLight).node.getWorldRotation(mb),Ni.transformQuat(vb,pb,mb);var t=this._normal,i=this._distance,n=1/Ni.dot(t,vb),r=vb.x*n,a=vb.y*n,s=vb.z*n,o=t.x,l=t.y,u=t.z,c=this._matLight;c.m00=1-o*r,c.m01=-o*a,c.m02=-o*s,c.m03=0,c.m04=-l*r,c.m05=1-l*a,c.m06=-l*s,c.m07=0,c.m08=-u*r,c.m09=-u*a,c.m10=1-u*s,c.m11=0,c.m12=r*i,c.m13=a*i,c.m14=s*i,c.m15=1,Pn.toArray(this.data,this._matLight,Cf.MAT_LIGHT_PLANE_PROJ_OFFSET),this._globalBindings.buffer.update(this.data)}},{key:"updateCommandBuffers",value:function(){if(this._cmdBuffs.clear(),this._scene.mainLight.enabled){var e=this._scene.models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;if(r.enabled&&r.node&&r.castShadow){var a=this._psoRecord.get(r);a||(a=this._createPSO(r),this._psoRecord.set(r,a)),r.UBOUpdated||r.updateUBOs();for(var s=0;s<r.subModelNum;s++){var o=r.getSubModel(s).inputAssembler;if(o){var l=this._cbRecord.get(o);l||((l=this._createCommandBuffer()).begin(),l.bindPipelineState(a),l.bindBindingLayout(a.pipelineLayout.layouts[0]),l.bindInputAssembler(o),l.draw(o),l.end(),this._cbRecord.set(o,l)),this.cmdBuffs.push(l)}}}}}}},{key:"onPipelineChange",value:function(){for(var e=this._cbRecord.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._cbRecord.clear();for(var i=this._psoRecord.keys(),n=i.next();!n.done;){(n.value instanceof Kf?this._passSkinning:this._passNormal).destroyPipelineState(this._psoRecord.get(n.value)),n=i.next()}this._psoRecord.clear()}},{key:"destroy",value:function(){this.onPipelineChange(),this._passNormal.destroy(),this._passSkinning.destroy()}},{key:"_createPSO",value:function(e){var t=e instanceof Kf?this._passSkinning:this._passNormal,i=e._doCreatePSO(t);return i.pipelineLayout.layouts[0].update(),i}},{key:"_createCommandBuffer",value:function(){var e=this._scene.root.device;return e.createCommandBuffer({allocator:e.commandAllocator,type:Qu.SECONDARY})}}]),n}();function gb(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}function bb(e){var t=(e=e||{}).widthSegments||1,i=e.heightSegments||1,n=e.lengthSegments||1,r=(e.width||1)/2,a=(e.height||1)/2,s=(e.length||1)/2,p=[Ni.set(Eb,-r,-a,s),Ni.set(Ab,r,-a,s),Ni.set(Cb,r,a,s),Ni.set(kb,-r,a,s),Ni.set(Rb,r,-a,-s),Ni.set(Ob,-r,-a,-s),Ni.set(Mb,-r,a,-s),Ni.set(Ib,r,a,-s)],v=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],m=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],y=[],g=[],b=[],x=[],o=new Ni(-r,-a,-s),l=new Ni(r,a,s),u=Math.sqrt(r*r+a*a+s*s);function c(e,t,i){var n,r,a,s,o=y.length/3,l=v[e],u=m[e];for(s=0;s<=i;s++)for(a=0;a<=t;a++)if(n=a/t,r=s/i,Ni.lerp(xb,p[l[0]],p[l[1]],n),Ni.lerp(Sb,p[l[0]],p[l[2]],r),Ni.subtract(Tb,Sb,p[l[0]]),Ni.add(wb,xb,Tb),y.push(wb.x,wb.y,wb.z),g.push(u[0],u[1],u[2]),b.push(n,r),a<t&&s<i){var c=t+1,h=a+s*c,f=a+(s+1)*c,d=a+1+(s+1)*c,_=a+1+s*c;x.push(o+h,o+_,o+f),x.push(o+f,o+_,o+d)}}return c(0,t,i),c(4,n,i),c(1,t,i),c(5,n,i),c(3,t,n),c(2,t,n),{positions:y,normals:g,uvs:b,indices:x,minPos:o,maxPos:l,boundingRadius:u}}var xb=new Ni,Sb=new Ni,Tb=new Ni,wb=new Ni,Eb=new Ni,Ab=new Ni,Cb=new Ni,kb=new Ni,Rb=new Ni,Ob=new Ni,Mb=new Ni,Ib=new Ni,Bb=new Ni(0,0,0),Lb=new Ni(0,0,0);function Pb(){var y=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.5,b=2<arguments.length&&void 0!==arguments[2]?arguments[2]:2,e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},x=.5*b,S=e.radialSegments||32,T=e.heightSegments||1,t=void 0===e.capped||e.capped,w=e.arc||2*Math.PI,i=0;t||(0<y&&i++,0<g&&i++);var n=(S+1)*(T+1);t&&(n+=(S+1)*i+S*i);var r=S*T*2*3;t&&(r+=S*i*3);var E=new Array(r),A=new Array(3*n),C=new Array(3*n),k=new Array(2*n),a=Math.max(y,g),s=new Ni(-a,-x,-a),o=new Ni(a,x,a),l=Math.sqrt(a*a+x*x),R=0,O=0;return function(){for(var e=[],t=y-g,i=t*t/b*Math.sign(t),n=0;n<=T;n++){for(var r=[],a=n/T,s=a*t+g,o=0;o<=S;++o){var l=o/S,u=l*w,c=Math.sin(u),h=Math.cos(u);A[3*R]=s*c,A[3*R+1]=a*b-x,A[3*R+2]=s*h,Ni.normalize(Bb,Ni.set(Lb,c,-i,h)),C[3*R]=Bb.x,C[3*R+1]=Bb.y,C[3*R+2]=Bb.z,k[2*R]=2*(1-l)%1,k[2*R+1]=a,r.push(R),++R}e.push(r)}for(var f=0;f<T;++f)for(var d=0;d<S;++d){var _=e[f][d],p=e[f+1][d],v=e[f+1][d+1],m=e[f][d+1];E[O]=_,E[++O]=m,E[++O]=p,E[++O]=m,E[++O]=v,E[++O]=p,++O}}(),t&&(0<g&&u(!1),0<y&&u(!0)),{positions:A,normals:C,uvs:k,indices:E,minPos:s,maxPos:o,boundingRadius:l};function u(e){for(var t=e?y:g,i=e?1:-1,n=R,r=1;r<=S;++r)A[3*R]=0,A[3*R+1]=x*i,A[3*R+2]=0,C[3*R]=0,C[3*R+1]=i,C[3*R+2]=0,k[2*R]=.5,k[2*R+1]=.5,++R;for(var a=R,s=0;s<=S;++s){var o=s/S*w,l=Math.cos(o),u=Math.sin(o);A[3*R]=t*u,A[3*R+1]=x*i,A[3*R+2]=t*l,C[3*R]=0,C[3*R+1]=i,C[3*R+2]=0,k[2*R]=.5-.5*u*i,k[2*R+1]=.5+.5*l,++R}for(var c=0;c<S;++c){var h=n+c,f=a+c;e?(E[O]=f+1,E[++O]=h):(E[O]=h,E[++O]=f+1),E[++O]=f,++O}}}var Fb=new Ni(0,0,0),zb=new Ni(0,0,0),Db=new Ni(0,0,0),Nb=new Ni(0,0,0),Ub=new Ni(0,0,0),Vb=new Ni(0,0,0),Gb=new Ni(0,0,0);var Hb=new Ni(0,0,0),Wb=new Ni(0,0,0);var qb=Object.freeze({box:bb,cone:function(){return Pb(0,0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,2<arguments.length&&void 0!==arguments[2]?arguments[2]:{})},cylinder:Pb,plane:function(e){var t=function(e){return(e=gb(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),i=t.width,n=t.length,r=t.widthSegments,a=t.lengthSegments,s=.5*i,o=.5*n,l=[],u=[],c=[],h=new Ni(-s,0,-o),f=new Ni(s,0,o),d=Math.sqrt(i*i+n*n);Ni.set(Ub,-s,0,o),Ni.set(Vb,s,0,o),Ni.set(Gb,-s,0,-o);for(var _=0;_<=a;_++)for(var p=0;p<=r;p++){var v=p/r,m=_/a;if(Ni.lerp(Fb,Ub,Vb,v),Ni.lerp(zb,Ub,Gb,m),Ni.subtract(Db,zb,Ub),Ni.add(Nb,Fb,Db),l.push(Nb.x,Nb.y,Nb.z),t.includeUV&&u.push(v,m),p<r&&_<a){var y=r+1,g=p+_*y,b=p+(_+1)*y,x=p+1+(_+1)*y,S=p+1+_*y;c.push(g,S,b),c.push(S,x,b)}}var T={positions:l,indices:c,minPos:h,maxPos:f,boundingRadius:d};if(t.includeNormal){var w=(a+1)*(r+1),E=new Array(3*w);T.normals=E;for(var A=0;A<w;++A)E[3*A+0]=0,E[3*A+1]=1,E[3*A+2]=0}return t.includeUV&&(T.uvs=u),T},quad:function(e){var t=gb(e),i={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(i.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(i.uvs=[0,0,0,1,1,1,1,0]),i},sphere:function(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=void 0!==t.segments?t.segments:32,n=[],r=[],a=[],s=[],o=new Ni(-e,-e,-e),l=new Ni(e,e,e),u=e,c=0;c<=i;++c)for(var h=c*Math.PI/i,f=Math.sin(h),d=-Math.cos(h),_=0;_<=i;++_){var p=2*_*Math.PI/i-Math.PI/2,v=Math.sin(p)*f,m=d,y=Math.cos(p)*f,g=_/i,b=c/i;if(n.push(v*e,m*e,y*e),r.push(v,m,y),a.push(g,b),c<i&&_<i){var x=i+1,S=x*c+_,T=x*(c+1)+_,w=x*(c+1)+_+1,E=x*c+_+1;s.push(S,E,T),s.push(E,w,T)}}return{positions:n,indices:s,normals:r,uvs:a,minPos:o,maxPos:l,boundingRadius:u}},torus:function(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.4,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.1,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},n=i.radialSegments||32,r=i.tubularSegments||32,a=i.arc||2*Math.PI,s=[],o=[],l=[],u=[],c=new Ni(-e-t,-t,-e-t),h=new Ni(e+t,t,e+t),f=e+t,d=0;d<=n;d++)for(var _=0;_<=r;_++){var p=_/r,v=d/n,m=p*a,y=v*Math.PI*2,g=(e+t*Math.cos(y))*Math.sin(m),b=t*Math.sin(y),x=(e+t*Math.cos(y))*Math.cos(m),S=Math.sin(m)*Math.cos(y),T=Math.sin(y),w=Math.cos(m)*Math.cos(y);if(s.push(g,b,x),o.push(S,T,w),l.push(p,v),_<r&&d<n){var E=r+1,A=E*d+_,C=E*(d+1)+_,k=E*(d+1)+_+1,R=E*d+_+1;u.push(A,R,C),u.push(R,k,C)}}return{positions:s,normals:o,uvs:l,indices:u,minPos:c,maxPos:h,boundingRadius:f}},capsule:function(){var y=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.5,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:2,t=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},m=e-y-g,b=t.sides||32,x=t.heightSegments||32,S=g/e,T=m/e,w=y/e,E=Math.floor(x*S),A=Math.floor(x*w),C=Math.floor(x*T),k=m+g-e/2,R=g-e/2,O=g-e/2,M=t.arc||2*Math.PI,I=[],B=[],L=[],P=[],i=Math.max(y,g),n=new Ni(-i,-e/2,-i),r=new Ni(i,e/2,i),a=e/2,F=0,z=[];return function(){for(var e=0;e<=E;++e)for(var t=e*Math.PI/E/2,i=Math.sin(t),n=-Math.cos(t),r=0;r<=b;++r){var a=2*r*Math.PI/b-Math.PI/2,s=Math.sin(a),o=Math.cos(a),l=s*i,u=n,c=o*i,h=r/b,f=e/x;if(I.push(l*g,u*g+O,c*g),B.push(l,u,c),L.push(h,f),e<E&&r<b){var d=b+1,_=d*e+r,p=d*(e+1)+r,v=d*(e+1)+r+1,m=d*e+r+1;P.push(_,m,p),P.push(m,v,p)}++F}}(),function(){for(var e=(y-g)/m,t=0;t<=C;t++){for(var i=[],n=t/C,r=n*(y-g)+g,a=0;a<=b;++a){var s=a/b,o=n*T+S,l=s*M-M/4,u=Math.sin(l),c=Math.cos(l);I.push(r*u),I.push(n*m+R),I.push(r*c),Ni.normalize(Hb,Ni.set(Wb,u,-e,c)),B.push(Hb.x),B.push(Hb.y),B.push(Hb.z),L.push(s,o),i.push(F),++F}z.push(i)}for(var h=0;h<C;++h)for(var f=0;f<b;++f){var d=z[h][f],_=z[h+1][f],p=z[h+1][f+1],v=z[h][f+1];P.push(d),P.push(v),P.push(_),P.push(v),P.push(p),P.push(_)}}(),function(){for(var e=0;e<=A;++e)for(var t=e*Math.PI/A/2+Math.PI/2,i=Math.sin(t),n=-Math.cos(t),r=0;r<=b;++r){var a=2*r*Math.PI/b-Math.PI/2,s=Math.sin(a),o=Math.cos(a),l=s*i,u=n,c=o*i,h=r/b,f=e/x+(1-w);if(I.push(l*y,u*y+k,c*y),B.push(l,u,c),L.push(h,f),e<A&&r<b){var d=b+1,_=d*e+r+z[C][b]+1,p=d*(e+1)+r+z[C][b]+1,v=d*(e+1)+r+1+z[C][b]+1,m=d*e+r+1+z[C][b]+1;P.push(_,m,p),P.push(m,v,p)}}}(),{positions:I,normals:B,uvs:L,indices:P,minPos:n,maxPos:r,boundingRadius:a}},circle:function(e){var t=function(e){return(e=gb(e)).segments=64,e}(e).segments,i=new Array(3*(t+1));i[0]=0,i[1]=0,i[2]=0;var n=new Array(1+2*t);n[0]=0;for(var r=2*Math.PI/t,a=0;a<t;++a){var s=r*a,o=Math.cos(s),l=Math.sin(s),u=3*(a+1);i[0+u]=o,i[1+u]=l,i[2+u]=0;var c=2*a;n[1+c]=a+1,n[1+c+1]=a+2}return 0<t&&(n[n.length-1]=1),{positions:i,indices:n,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:_u.TRIANGLE_FAN}},translate:function(e,t){for(var i=t.x||0,n=t.y||0,r=t.z||0,a=Math.floor(e.positions.length/3),s=0;s<a;++s){var o=3*s,l=3*s+1,u=3*s+2;e.positions[o]=e.positions[o]+i,e.positions[l]=e.positions[l]+n,e.positions[u]=e.positions[u]+r}return e.minPos&&(e.minPos.x+=i,e.minPos.y+=n,e.minPos.z+=r),e.maxPos&&(e.maxPos.x+=i,e.maxPos.y+=n,e.maxPos.z+=r),e},scale:function(e,t){for(var i=t.x||0,n=t.y||0,r=t.z||0,a=Math.floor(e.positions.length/3),s=0;s<a;++s){var o=3*s,l=3*s+1,u=3*s+2;e.positions[o]*=i,e.positions[l]*=n,e.positions[u]*=r}return e.minPos&&(e.minPos.x*=i,e.minPos.y*=n,e.minPos.z*=r),e.maxPos&&(e.maxPos.x*=i,e.maxPos.y*=n,e.maxPos.z*=r),e.boundingRadius=Math.max(Math.max(i,n),r),e},wireframed:function(e){var t=e.indices;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==_u.TRIANGLE_LIST)return e;for(var i=[[0,1],[1,2],[2,0]],n=[],r={},a=0;a<t.length;a+=3)for(var s=0;s<3;++s){var o=t[a+i[s][0]],l=t[a+i[s][1]],u=l<o?l<<16|o:o<<16|l;void 0===r[u]&&(r[u]=0,n.push(o,l))}return e.indices=n,e.primitiveMode=_u.LINE_LIST,e},wireframe:function(e){for(var t=[[0,1],[1,2],[2,0]],i=[],n={},r=0;r<e.length;r+=3)for(var a=0;a<3;++a){var s=e[r+t[a][0]],o=e[r+t[a][1]],l=o<s?o<<16|s:s<<16|o;void 0===n[l]&&(n[l]=0,i.push(s,o))}return i},invWinding:function(e){for(var t=[],i=0;i<e.length;i+=3)t.push(e[i],e[i+2],e[i+1]);return t},toWavefrontOBJ:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;if(!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==_u.TRIANGLE_LIST)return"";for(var i=e.positions,n=e.uvs,r=e.normals,a=e.indices,s=function(e){return"".concat(a[e]+1,"/").concat(a[e]+1,"/").concat(a[e]+1)},o="",l=0;l<i.length;l+=3)o+="v ".concat(i[l]*t," ").concat(i[l+1]*t," ").concat(i[l+2]*t,"\n");for(var u=0;u<n.length;u+=2)o+="vt ".concat(n[u]," ").concat(n[u+1],"\n");for(var c=0;c<r.length;c+=3)o+="vn ".concat(r[c]," ").concat(r[c+1]," ").concat(r[c+2],"\n");for(var h=0;h<a.length;h+=3)o+="f ".concat(s(h)," ").concat(s(h+1)," ").concat(s(h+2),"\n");return o},normals:function(e,t){for(var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,n=new Array(2*e.length),r=0;r<e.length/3;++r){var a=3*r,s=6*r;n[0+s]=e[0+a],n[1+s]=e[1+a],n[2+s]=e[2+a],n[3+s]=e[0+a]+t[0+a]*i,n[4+s]=e[1+a]+t[1+a]*i,n[5+s]=e[2+a]+t[2+a]*i}return n},applyDefaultGeometryOptions:gb});m4("primitives",qb);var jb,Xb,Yb=function(){function n(e){var t;y(this,n),(t=x(this,g(n).call(this,e,null)))._default=t_.get("default-cube-texture"),t._envmap=t._default,t._isRGBE=!1,t._useIBL=!1,t._material=new F_,t._globalBinding=void 0,t._scene=e,t._material.initialize({effectName:"pipeline/skybox",defines:{USE_RGBE_CUBEMAP:t._isRGBE}}),t._globalBinding=t._scene.root.pipeline.globalBindings.get(Rf.name);var i=Jf(bb({width:2,height:2,length:2})).renderingMesh.getSubmesh(0);return t.initSubModel(0,i,t._material),t}return _(n,Hf),l(n,[{key:"useIBL",set:function(e){this._useIBL=e,this._updatePipeline()},get:function(){return this._useIBL}},{key:"isRGBE",set:function(e){this._isRGBE=e,this._material.recompileShaders({USE_RGBE_CUBEMAP:this._isRGBE}),this.setSubModelMaterial(0,this._material),this._updateGlobalBinding(),this._updatePipeline()},get:function(){return this._isRGBE}},{key:"envmap",set:function(e){var t=e||this._default;this._envmap=t,this._scene.ambient.groundAlbedo[3]=this._envmap.mipmapLevel,this._updateGlobalBinding()},get:function(){return this._envmap}}]),l(n,[{key:"_updatePipeline",value:function(){var e=this._useIBL?this._isRGBE?2:1:0,t=this._scene.root.pipeline;t.macros.CC_USE_IBL!==e&&(t.macros.CC_USE_IBL=e,this._scene.onPipelineChange())}},{key:"_updateGlobalBinding",value:function(){var e=this._envmap.getGFXTextureView(),t=Rh.getSampler(this._device,this._envmap.getSamplerHash());this._globalBinding.sampler=t,this._globalBinding.textureView=e;var i=this._material;i.passes[0].bindSampler(Rf.binding,t),i.passes[0].bindTextureView(Rf.binding,e);var n=this._matPSORecord.get(i),r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}s.pipelineLayout.layouts[0].update()}}}]),n}(),Kb=function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this,e,t,i)))._size=.15,n._range=1,n._luminance=1700/pv(n._size),n._pos=void 0,n._aabb=void 0,n._type=ov.SPHERE,n._aabb=cs.create(),n._pos=new Ni,n}return _(r,vv),l(r,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"aabb",get:function(){return this._aabb}}]),l(r,[{key:"update",value:function(){this._node&&(this._node.getWorldPosition(this._pos),cs.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range))}}]),r}(),Qb=new Ni(0,0,-1),Zb=new Ni,Jb=new fn,$b=new Pn,ex=new Pn,tx=new Pn,ix=new Pn,nx=function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this,e,t,i)))._dir=new Ni(1,-1,-1),n._size=.15,n._range=5,n._luminance=1700/pv(n._size),n._spotAngle=Math.cos(Math.PI/6),n._pos=void 0,n._aabb=void 0,n._frustum=void 0,n._angle=0,n._type=ov.SPOT,n._aabb=cs.create(),n._frustum=ms.create(),n._pos=new Ni,n}return _(r,vv),l(r,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=.5*e,this._spotAngle=Math.cos(.5*e)}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),l(r,[{key:"update",value:function(){this._node&&(this._node.getWorldPosition(this._pos),this._dir=Ni.transformQuat(Zb,Qb,this._node.getWorldRotation(Jb)),Ni.normalize(this._dir,this._dir),cs.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT($b),Pn.invert($b,$b),Pn.perspective(ex,this._angle,1,.001,this._range),Pn.multiply(tx,ex,$b),Pn.invert(ix,tx),this._frustum.update(tx,ix))}}]),r}(),rx=function(){function t(e){y(this,t),this._root=void 0,this._name="",this._cameras=[],this._ambient=void 0,this._skybox=void 0,this._planarShadows=void 0,this._mainLight=void 0,this._defaultMainLightNode=void 0,this._sphereLights=[],this._spotLights=[],this._models=[],this._modelId=0,this._texturePool=void 0,this._root=e,this._ambient=new Jy(this),this._defaultMainLightNode=new cy("Main Light"),this._mainLight=new _b(this,"Main Light",this._defaultMainLightNode),this._mainLight.illuminance=Jy.SUN_ILLUM,this._mainLight.enabled=!1,this._ambient=new Jy(this),this._skybox=new Yb(this),this._planarShadows=new yb(this),this._texturePool=new Jd(e.device)}return l(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"ambient",get:function(){return this._ambient}},{key:"skybox",get:function(){return this._skybox}},{key:"planarShadows",get:function(){return this._planarShadows}},{key:"defaultMainLightNode",get:function(){return this._defaultMainLightNode}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"texturePool",get:function(){return this._texturePool}}],[{key:"registerCreateFunc",value:function(e){e._createSceneFun=function(e){return new t(e)}}}]),l(t,[{key:"initialize",value:function(e){return this._name=e.name,this._texturePool.initialize(),!0}},{key:"destroy",value:function(){this.destroyCameras(),this.destroyPointLights(),this.destroySpotLights(),this.destroyModels(),this._planarShadows.destroy(),this._texturePool.destroy()}},{key:"createCamera",value:function(e){var t=new Nv(this,e);return this._cameras.push(t),t}},{key:"destroyCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return e.destroy(),void this._cameras.splice(t,1)}},{key:"destroyCameras",value:function(){var e=this._cameras,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._cameras.splice(0)}},{key:"createSphereLight",value:function(e,t){var i=new Kb(this,e,t);return this._sphereLights.push(i),i}},{key:"destroySphereLight",value:function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return void this._sphereLights.splice(t,1)}},{key:"createSpotLight",value:function(e,t){var i=new nx(this,e,t);return this._spotLights.push(i),i}},{key:"destroySpotLight",value:function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return void this._spotLights.splice(t,1)}},{key:"destroyPointLights",value:function(){this._sphereLights=[]}},{key:"destroySpotLights",value:function(){this._spotLights=[]}},{key:"createModel",value:function(e,t){var i=new e(this,t);return this._models.push(i),i}},{key:"destroyModel",value:function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return void this._models.splice(t,1)[0].destroy()}},{key:"destroyModels",value:function(){var e=this._models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._models=[]}},{key:"onPipelineChange",value:function(){var e=this._models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.onPipelineChange()}this._skybox.onPipelineChange(),this._planarShadows.onPipelineChange()}},{key:"generateModelId",value:function(){return this._modelId++}},{key:"raycastModels",value:function(e,t,i){var n=1<arguments.length&&void 0!==t?t:yf.Enum.DEFAULT,r=2<arguments.length&&void 0!==i?i:1/0;cx.reset();var a=this._models,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var u=l,c=u.transform;if(c&&u.enabled&&!(u.node.layer&yf.Enum.IGNORE_RAYCAST)&&u.node.layer&n&&u.modelBounds){Pn.invert(ox,c.getWorldMatrix(ox)),Ni.transformMat4(ax.o,e.o,ox),Ni.normalize(ax.d,Ni.transformMat4Normal(ax.d,e.d,ox));var h=ja.ray_aabb(ax,u.modelBounds);if(!(h<=0||r<h))for(var f=0;f<u.subModelNum;++f){var d=u.getSubModel(f).subMeshData;if(d&&d.geometricInfo){var _=d.geometricInfo,p=_.positions,v=_.indices,m=_.doubleSided;px(p,v,d.primitiveMode,m,r)}if(lx<r){var y=cx.add();y.node=u.node,y.distance=lx*Ni.multiply(sx,ax.d,c.worldScale).length(),hx[cx.length-1]=y}}}}return hx.length=cx.length,hx}},{key:"raycastModel",value:function(e,t,i,n){var r=2<arguments.length&&void 0!==i?i:yf.Enum.DEFAULT,a=3<arguments.length&&void 0!==n?n:1/0;cx.reset(),hx.length=0;var s=t,o=s.transform;if(!o||!s.enabled||s.node.layer&yf.Enum.IGNORE_RAYCAST||!(s.node.layer&r)||!s.modelBounds)return hx;Pn.invert(ox,o.getWorldMatrix(ox)),Ni.transformMat4(ax.o,e.o,ox),Ni.normalize(ax.d,Ni.transformMat4Normal(ax.d,e.d,ox));var l=ja.ray_aabb(ax,s.modelBounds);if(l<=0||a<l)return hx;for(var u=0;u<s.subModelNum;++u){var c=s.getSubModel(u).subMeshData;if(c&&c.geometricInfo){var h=c.geometricInfo,f=h.positions,d=h.indices,_=h.doubleSided;px(f,d,c.primitiveMode,_,a)}if(lx<a){var p=cx.add();p.node=s.node,p.distance=lx*Ni.multiply(sx,ax.d,o.worldScale).length(),hx[cx.length-1]=p}}return hx}},{key:"raycastUI2D",value:function(e,t,i){var n=1<arguments.length&&void 0!==t?t:yf.Enum.UI_2D,r=2<arguments.length&&void 0!==i?i:1/0;dx.reset();var a=cc.director.getScene().getComponentsInChildren(cc.CanvasComponent);if(null!=a&&0<a.length)for(var s=0;s<a.length;s++){var o=a[s].node;null!=o&&o.active&&this._raycastUI2DNodeRecursiveChildren(e,o,n,r)}return _x.length=dx.length,_x}},{key:"raycastUI2DNode",value:function(e,t,i,n){var r=2<arguments.length&&void 0!==i?i:yf.Enum.UI_2D,a=3<arguments.length&&void 0!==n?n:1/0;var s=t.uiTransfromComp;if(!(null==s||t.layer&yf.Enum.IGNORE_RAYCAST)&&t.layer&r){s.getComputeAABB(fx);var o=ja.ray_aabb(e,fx);if(!(o<=0)&&o<a){var l=dx.add();return l.node=t,l.distance=o,l}}}},{key:"_raycastUI2DNodeRecursiveChildren",value:function(e,t,i,n){var r=2<arguments.length&&void 0!==i?i:yf.Enum.UI_2D,a=3<arguments.length&&void 0!==n?n:1/0,s=this.raycastUI2DNode(e,t,r,a);null!=s&&(_x[dx.length-1]=s);var o=t.children,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c;null!=h&&h.active&&this._raycastUI2DNodeRecursiveChildren(e,h,r,a)}}}]),t}(),ax=$a.create(),sx=new Ni,ox=new Pn,lx=1/0,ux=es.create(),cx=new Os(function(){return{node:null,distance:1/0}},8),hx=[],fx=new cs,dx=new Os(function(){return{node:null,distance:1/0}},8),_x=[],px=function(e,t,i,n,r){if(lx=4<arguments.length&&void 0!==r?r:1/0,i===_u.TRIANGLE_LIST)for(var a=t.length,s=0;s<a;s+=3){var o=3*t[s],l=3*t[s+1],u=3*t[s+2];Ni.set(ux.a,e[o],e[1+o],e[2+o]),Ni.set(ux.b,e[l],e[1+l],e[2+l]),Ni.set(ux.c,e[u],e[1+u],e[2+u]);var c=ja.ray_triangle(ax,ux,n);c<=0||lx<c||(lx=c)}else if(i===_u.TRIANGLE_STRIP)for(var h=t.length-2,f=0,d=0;d<h;d+=1){var _=3*t[d-f],p=3*t[d+f+1],v=3*t[d+2];Ni.set(ux.a,e[_],e[1+_],e[2+_]),Ni.set(ux.b,e[p],e[1+p],e[2+p]),Ni.set(ux.c,e[v],e[1+v],e[2+v]),f=~f;var m=ja.ray_triangle(ax,ux,n);m<=0||lx<m||(lx=m)}else if(i===_u.TRIANGLE_FAN){var y=t.length-1,g=3*t[0];Ni.set(ux.a,e[g],e[1+g],e[2+g]);for(var b=1;b<y;b+=1){var x=3*t[b],S=3*t[b+1];Ni.set(ux.b,e[x],e[1+x],e[2+x]),Ni.set(ux.c,e[S],e[1+S],e[2+S]);var T=ja.ray_triangle(ax,ux,n);T<=0||lx<T||(lx=T)}}},vx=m4("MeshBuffer",function(){function t(e){y(this,t),this.batcher=void 0,this.vData=null,this.iData=null,this.vb=null,this.ib=null,this.ia=null,this.byteStart=0,this.byteOffset=0,this.indiceStart=0,this.indiceOffset=0,this.vertexStart=0,this.vertexOffset=0,this.dirty=!1,this._vertexFormatBytes=9*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes,this._initIDataCount=1536,this._outofCallback=null,this.batcher=e}return l(t,[{key:"initialize",value:function(e,t){this._outofCallback=t;var i=9*Float32Array.BYTES_PER_ELEMENT;this.vb=this.vb||this.batcher.device.createBuffer({usage:su.VERTEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:0,stride:i});var n=Uint16Array.BYTES_PER_ELEMENT;this.ib=this.ib||this.batcher.device.createBuffer({usage:su.INDEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:0,stride:n}),this.ia=this.ia||this.batcher.device.createInputAssembler({attributes:e,vertexBuffers:[this.vb],indexBuffer:this.ib}),this._reallocBuffer()}},{key:"request",value:function(e,t){var i=0<arguments.length&&void 0!==e?e:4,n=1<arguments.length&&void 0!==t?t:6,r=this.byteOffset+i*this._vertexFormatBytes,a=this.indiceOffset+n;if(65535<i+this.vertexOffset)return this.batcher.autoMergeBatches(),this._outofCallback&&this._outofCallback.call(this.batcher,i,n),!1;var s=this.vData.byteLength,o=this.iData.length;if(s<r||o<a){for(;s<r||o<a;)this._initVDataCount*=2,this._initIDataCount*=2,s=4*this._initVDataCount,o=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=i,this.indiceOffset+=n,this.byteOffset=r,this.dirty=!0}},{key:"reset",value:function(){this.byteStart=0,this.byteOffset=0,this.indiceStart=0,this.indiceOffset=0,this.vertexStart=0,this.vertexOffset=0,this.dirty=!1}},{key:"destroy",value:function(){this.ib.destroy(),this.vb.destroy(),this.ia.destroy(),this.ib=null,this.vb=null,this.ia=null}},{key:"uploadData",value:function(){if(0!==this.byteOffset&&this.dirty){var e=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),t=new Uint16Array(this.iData.buffer,0,this.indiceOffset);this.byteOffset>this.vb.size&&this.vb.resize(this.byteOffset),this.vb.update(e),2*this.indiceOffset>this.ib.size&&this.ib.resize(2*this.indiceOffset),this.ib.update(t)}}},{key:"_reallocBuffer",value:function(){this._reallocVData(!0),this._reallocIData(!0)}},{key:"_reallocVData",value:function(e){var t;if(this.vData&&(t=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),t&&e)for(var i=new Uint8Array(this.vData.buffer),n=0,r=t.length;n<r;n++)i[n]=t[n]}},{key:"_reallocIData",value:function(e){var t=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),t&&e)for(var i=this.iData,n=0,r=t.length;n<r;n++)i[n]=t[n]}}]),t}());(Xb=jb=jb||{})[Xb.DISABLED=0]="DISABLED",Xb[Xb.CLEAR=1]="CLEAR",Xb[Xb.ENTER_LEVEL=2]="ENTER_LEVEL",Xb[Xb.ENABLED=3]="ENABLED",Xb[Xb.EXIT_LEVEL=4]="EXIT_LEVEL";var mx=m4("StencilManager",function(){function e(){y(this,e),this.stage=jb.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Su.ALWAYS,stencilMask:4294967295,writeMask:4294967295,failOp:wu.KEEP,zFailOp:wu.KEEP,passOp:wu.KEEP,ref:1},this._defaultPipelineState={depthStencilState:{},rasterizerState:{},blendState:{}}}return l(e,[{key:"pushMask",value:function(e){this._maskStack.push(e)}},{key:"clear",value:function(){this.stage=jb.CLEAR}},{key:"enterLevel",value:function(){this.stage=jb.ENTER_LEVEL}},{key:"enableMask",value:function(){this.stage=jb.ENABLED}},{key:"exitMask",value:function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=jb.DISABLED:this.stage=jb.ENABLED)}},{key:"handleMaterial",value:function(e){var t=this._stencilPattern;this.stage===jb.DISABLED?(t.stencilTest=!1,t.func=Su.ALWAYS,t.failOp=wu.KEEP,t.stencilMask=t.writeMask=4294967295,t.ref=1):(t.stencilTest=!0,this.stage===jb.ENABLED?(t.func=Su.EQUAL,t.failOp=wu.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):this.stage===jb.CLEAR?(t.func=Su.NEVER,t.failOp=wu.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):this.stage===jb.ENTER_LEVEL&&(t.func=Su.NEVER,t.failOp=wu.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()));var i=e.passes[0];if(this._changed(i)){var n=this._stencilPattern;return this._defaultPipelineState.depthStencilState={stencilTestFront:n.stencilTest,stencilFuncFront:n.func,stencilReadMaskFront:n.stencilMask,stencilWriteMaskFront:n.writeMask,stencilFailOpFront:n.failOp,stencilZFailOpFront:n.zFailOp,stencilPassOpFront:n.passOp,stencilRefFront:n.ref,stencilTestBack:n.stencilTest,stencilFuncBack:n.func,stencilReadMaskBack:n.stencilMask,stencilWriteMaskBack:n.writeMask,stencilFailOpBack:n.failOp,stencilZFailOpBack:n.zFailOp,stencilPassOpBack:n.passOp,stencilRefBack:n.ref},this._defaultPipelineState.blendState=i.blendState,this._defaultPipelineState.rasterizerState=i.rasterizerState,e.overridePipelineStates(this._defaultPipelineState),!0}return!1}},{key:"getWriteMask",value:function(){return 1<<this._maskStack.length-1}},{key:"getExitWriteMask",value:function(){return 1<<this._maskStack.length}},{key:"getStencilRef",value:function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e}},{key:"getInvertedRef",value:function(){for(var e=0,t=0;t<this._maskStack.length-1;++t)e+=1<<t;return e}},{key:"reset",value:function(){this._maskStack.length=0,this.stage=jb.DISABLED}},{key:"_changed",value:function(e){var t=e.depthStencilState,i=this._stencilPattern;return i.stencilTest!==t.stencilTestFront||i.func!==t.stencilFuncFront||i.failOp!==t.stencilFailOpFront||i.zFailOp!==t.stencilZFailOpFront||i.passOp!==t.stencilPassOpFront||i.stencilMask!==t.stencilReadMaskFront||i.writeMask!==t.stencilWriteMaskFront||i.ref!==t.stencilRefFront}}]),e}());mx.sharedManager=null,mx.sharedManager=new mx;var yx=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e,null)))._subModel=void 0,t._subModel=new gx,t}return _(i,Hf),l(i,[{key:"updateTransform",value:function(){}},{key:"updateUBOs",value:function(){return!1}},{key:"initialize",value:function(e,t){this._subModel.directInitialize(e,t.material,t.pipelineState),this._subModels[0]=this._subModel}},{key:"destroy",value:function(){this._subModel.destroy()}}]),i}(),gx=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this))).psos=[],e}return _(t,Nf),l(t,[{key:"directInitialize",value:function(e,t,i){this._inputAssembler=e,this.psos[0]=i,this.material=t}},{key:"destroy",value:function(){0<this.commandBuffers.length&&this.commandBuffers[0].destroy()}}]),t}(),bx=function(){function e(){y(this,e),this._material=null,this._pass=null,this._psos=void 0,this._refCount=0,this._psos=null}return l(e,[{key:"material",get:function(){return this._material}},{key:"pass",get:function(){return this._pass}}]),l(e,[{key:"initialize",value:function(e){var t=this;return!!e.material&&(this._material=new F_,this._material.copy(e.material),this._pass=this._material.passes[0],this._pass.update(),this._psos=new Rs(function(){return t._pass.createPipelineState()},1),!0)}},{key:"increase",value:function(){return this._refCount++,this._refCount}},{key:"decrease",value:function(){return this._refCount--,0===this._refCount&&this.destroy(),this._refCount}},{key:"getPipelineState",value:function(){return this._psos.alloc()}},{key:"revertPipelineState",value:function(e){this._psos.free(e)}},{key:"destroy",value:function(){var t=this;this._psos&&this._psos.clear(function(e){t._pass.destroyPipelineState(e)}),this._material&&(this._material.destroy(),this._material=null),this._refCount=0}}]),e}(),xx=[{name:eu.ATTR_POSITION,format:ru.RGB32F},{name:eu.ATTR_TEX_COORD,format:ru.RG32F},{name:eu.ATTR_COLOR,format:ru.RGBA32F}],Sx=Object.freeze({vfmt:xx});m4("UIVertexFormat",Sx);var Tx=function(){function e(){y(this,e),this.camera=null,this.bufferBatch=null,this.model=null,this.material=null,this.texView=null,this.firstIdx=0,this.idxCount=0,this.pipelineState=null,this.bindingLayout=null,this.useLocalData=null}return l(e,[{key:"destroy",value:function(e){this.pipelineState&&(e._getUIMaterial(this.material).revertPipelineState(this.pipelineState),this.pipelineState=null),this.bindingLayout&&(this.bindingLayout=null)}},{key:"clear",value:function(e){this.pipelineState&&(e._getUIMaterial(this.material).revertPipelineState(this.pipelineState),this.pipelineState=null),this.camera=null,this.bufferBatch=null,this.material=null,this.texView=null,this.firstIdx=0,this.idxCount=0,this.model=null}}]),e}(),Ex=function(){function i(e){var t=this;y(this,i),this._root=e,this.device=void 0,this._screens=[],this._bufferBatchPool=new Os(function(){return new vx(t)},128),this._drawBatchPool=new Rs(function(){return new Tx},128),this._cmdBuff=null,this._scene=void 0,this._attributes=[],this._meshBuffers=[],this._meshBufferUseCount=0,this._uiMaterials=new Map,this._canvasMaterials=new Map,this._batches=void 0,this._uiModelPool=null,this._modelInUse=void 0,this._emptyMaterial=new F_,this._currMeshBuffer=null,this._currMaterial=this._emptyMaterial,this._currTexView=null,this._currCanvas=-1,this.device=e.device,this._scene=this._root.createScene({name:"GUIScene"}),this._uiModelPool=new Rs(function(){var e=t._scene.createModel(yx,null);return e.visFlags|=yf.Enum.UI_3D,e},2),this._modelInUse=new Ug(10),this._batches=new Ug(64),cc.director.on(cc.Director.EVENT_BEFORE_DRAW,this.update,this)}return l(i,[{key:"renderScene",get:function(){return this._scene}},{key:"currBufferBatch",get:function(){return this._currMeshBuffer}}]),l(i,[{key:"initialize",value:function(){return this._attributes=xx,this._requireBufferBatch(),this._cmdBuff=this.device.createCommandBuffer({allocator:this.device.commandAllocator,type:Qu.PRIMARY}),!0}},{key:"destroy",value:function(){this._destroyUIMaterials();var e=this._batches.array,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy(this)}var r=this._meshBuffers,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}o.destroy()}this._meshBuffers.splice(0);for(var l=this._uiMaterials.values(),u=l.next();!u.done;){u.value.destroy(),u=l.next()}this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"getRenderSceneGetter",value:function(){return Object.getOwnPropertyDescriptor(Object.getPrototypeOf(this),"renderScene").get.bind(this)}},{key:"_getUIMaterial",value:function(e){if(this._uiMaterials.has(e.hash))return this._uiMaterials.get(e.hash);var t=new bx;return t.initialize({material:e}),this._uiMaterials.set(e.hash,t),t}},{key:"_removeUIMaterial",value:function(e){this._uiMaterials.has(e)&&0===this._uiMaterials.get(e).decrease()&&this._uiMaterials.delete(e)}},{key:"addScreen",value:function(e){this._screens.push(e),e.camera&&(e.camera.view.visibility=yf.BitMask.UI_2D|this._screens.length,this._canvasMaterials.set(e.camera.view.visibility,new Map)),this._screens.sort(this._screenSort)}},{key:"getScreen",value:function(e){for(var t=this._screens,i=0;i<t.length;++i){var n=t[i];if(n.camera&&n.camera.view.visibility===e)return n}return null}},{key:"removeScreen",value:function(e){var t=this._screens.indexOf(e);if(-1!==t){if(this._screens.splice(t,1),e.camera)for(var i=this._canvasMaterials.get(e.camera.view.visibility).keys(),n=i.next();!n.done;)this._removeUIMaterial(n.value),n=i.next();for(var r,a=t;a<this._screens.length;a++)if(r=this._screens[a].camera){var s=this._canvasMaterials.get(r.view.visibility);r.view.visibility-=1,this._canvasMaterials.set(r.view.visibility,s)}}}},{key:"update",value:function(e){if(this._renderScreens(),0<this._batches.length)for(var t=this._meshBuffers,i=0;i<t.length;++i){var n=t[i];n.uploadData(),n.reset()}this.render(),this._reset()}},{key:"render",value:function(){for(var e=0,t=0;t<this._modelInUse.length;t++)this._modelInUse.get(t).enabled=!1,this._uiModelPool.free(this._modelInUse.get(t));if(this._modelInUse.clear(),this._batches.length)for(var i=0;i<this._batches.length;++i){var n=this._batches.array[i];if(n.model){if(n.camera){var r=n.camera.view.visibility;n.model.visFlags=r,n.model.node.layer=r}for(var a=0;a<n.model.subModelNum;a++)n.model.getSubModel(a).priority=e++}else{var s=n.bindingLayout;s.bindTextureView(Tf.CUSTOM_SAMPLER_BINDING_START_POINT,n.texView),s.update();var o=n.bufferBatch.ia;o.firstIndex=n.firstIdx,o.indexCount=n.idxCount;var l=this._uiModelPool.alloc();l.initialize(o,n),l.enabled=!0,l.getSubModel(0).priority=e++,n.camera&&(l.visFlags=n.camera.view.visibility,null==this._canvasMaterials.get(n.camera.view.visibility).get(n.material.hash)&&(this._uiMaterials.get(n.material.hash).increase(),this._canvasMaterials.get(n.camera.view.visibility).set(n.material.hash,1))),this._modelInUse.push(l)}}}},{key:"commitComp",value:function(e,t,i){var n=2<arguments.length?i:void 0,r=e,a=1<arguments.length&&void 0!==t?t:null;this._currMaterial.hash===r.material.hash&&this._currTexView===a&&this._currCanvas===r.visibility||(this.autoMergeBatches(),this._currMaterial=r.material,this._currTexView=a,this._currCanvas=r.visibility),n&&n.fillBuffers(r,this)}},{key:"commitModel",value:function(e,t,i){if((this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(),i)&&(mx.sharedManager.handleMaterial(i)&&t))for(var n=0;n<t.subModelNum;n++)t.setSubModelMaterial(n,i);var r=this.getScreen(e.visibility),a=this._drawBatchPool.alloc();a.camera=r&&r.camera,a.model=t,a.bufferBatch=null,a.material=i,a.texView=null,a.firstIdx=0,a.idxCount=0,a.pipelineState=null,a.bindingLayout=null,this._currMaterial=this._emptyMaterial,this._currTexView=null,this._currCanvas=e.visibility,this._batches.push(a)}},{key:"autoMergeBatches",value:function(){var e=this._currMaterial,t=this._currMeshBuffer,i=t.indiceStart,n=t.indiceOffset-i;if(n&&e){var r=this.getScreen(this._currCanvas);mx.sharedManager.handleMaterial(e);var a=this._drawBatchPool.alloc();a.camera=r&&r.camera,a.bufferBatch=this._currMeshBuffer,a.material=e,a.texView=this._currTexView,a.firstIdx=i,a.idxCount=n,a.pipelineState=this._getUIMaterial(e).getPipelineState(),a.bindingLayout=a.pipelineState.pipelineLayout.layouts[0],this._batches.push(a),t.vertexStart=t.vertexOffset,t.indiceStart=t.indiceOffset,t.byteStart=t.byteOffset}}},{key:"forceMergeBatches",value:function(e,t){this._currMaterial=e,this._currTexView=t,this.autoMergeBatches()}},{key:"_deleteUIMaterial",value:function(e){this._uiMaterials.has(e.hash)&&(this._uiMaterials.get(e.hash).destroy(),this._uiMaterials.delete(e.hash))}},{key:"_destroyUIMaterials",value:function(){for(var e=this._uiMaterials.values(),t=e.next();!t.done;){t.value.destroy(),t=e.next()}this._uiMaterials.clear()}},{key:"_walk",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:0,n=e.children.length;if(this._preprocess(e),0<n)for(var r=e.children,a=0;a<r.length;++a){var s=r[a];this._walk(s,i)}this._postprocess(e),i+=1}},{key:"_renderScreens",value:function(){for(var e=this._screens,t=0;t<e.length;++t){var i=e[t];i.enabledInHierarchy&&this._recursiveScreenNode(i.node)}}},{key:"_preprocess",value:function(e){var t=e._uiComp;t&&t.enabledInHierarchy&&t.updateAssembler(this)}},{key:"_postprocess",value:function(e){var t=e._uiComp;t&&t.enabledInHierarchy&&t.postUpdateAssembler(this)}},{key:"_recursiveScreenNode",value:function(e){this._walk(e),this.autoMergeBatches()}},{key:"_reset",value:function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.clear(this),this._drawBatchPool.free(t)}this._batches.clear(),this._currMaterial=this._emptyMaterial,this._currCanvas=-1,this._currTexView=null,this._meshBufferUseCount=0,this._requireBufferBatch(),mx.sharedManager.reset()}},{key:"_createMeshBuffer",value:function(){var e=this._bufferBatchPool.add();return e.initialize(this._attributes,this._requireBufferBatch.bind(this)),this._meshBuffers.push(e),e}},{key:"_requireBufferBatch",value:function(e,t){this._meshBufferUseCount>=this._meshBuffers.length?this._currMeshBuffer=this._createMeshBuffer():this._currMeshBuffer=this._meshBuffers[this._meshBufferUseCount],this._meshBufferUseCount++,2===arguments.length&&this._currMeshBuffer.request(e,t)}},{key:"_screenSort",value:function(e,t){return e.priority-t.priority}}]),i}(),Ax=function(){function t(e){y(this,t),this._createSceneFun=void 0,this._createViewFun=void 0,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._ui=null,this._scenes=[],this._views=[],this._time=0,this._frameTime=0,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._fixedFPSFrameTime=0,this._device=e,rx.registerCreateFunc(this),cb.registerCreateFunc(this)}return l(t,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",set:function(e){this._curWindow=e},get:function(){return this._curWindow}},{key:"tempWindow",set:function(e){this._tempWindow=e},get:function(){return this._tempWindow}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"ui",get:function(){return this._ui}},{key:"scenes",get:function(){return this._scenes}},{key:"views",get:function(){return this._views}},{key:"cumulativeTime",get:function(){return this._time}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",set:function(e){0<e?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0},get:function(){return this._fixedFPS}}]),l(t,[{key:"initialize",value:function(e){var i=this;return!!this._device.mainWindow&&(this._mainWindow=this._device.mainWindow,this._curWindow=this._mainWindow,t_.initBuiltinRes(this._device),this._pipeline=new ub(this),this._pipeline.initialize(e)?(this._ui=new Ex(this),this._ui.initialize()?(cc.view.on("design-resolution-changed",function(){var e=cc.game.canvas.width,t=cc.game.canvas.height;i.resize(e,t)},this),!0):(this.destroy(),!1)):(this.destroy(),!1))}},{key:"destroy",value:function(){this.destroyViews(),this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._ui&&(this._ui.destroy(),this._ui=null),this._curWindow=null,this._mainWindow=null}},{key:"resize",value:function(e,t){this._device.resize(e,t),this._mainWindow.resize(e,t);var i=this._windows,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.isOffscreen||s.resize(e,t)}this._pipeline&&this._pipeline.resize(e,t);var o=this._views,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c;h.camera.isWindowSize&&h.camera.resize(e,t)}}},{key:"activeWindow",value:function(e){this._curWindow=e}},{key:"resetCumulativeTime",value:function(){this._time=0}},{key:"frameMove",value:function(e){this._frameTime=e,++this._frameCount,this._time+=this._frameTime,this._fpsTime+=this._frameTime,1<this._fpsTime&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0),this._views.sort(function(e,t){return e.priority-t.priority});var t=this._views,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;a.isEnable&&a.window&&(a.window.isOffscreen||!a.window.isOffscreen&&a.window===this._curWindow)&&this._pipeline.render(a)}}},{key:"createWindow",value:function(e){if(this._device){var t=this._device.createWindow(e);if(t)return this._windows.push(t),t}return null}},{key:"destroyWindow",value:function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)}},{key:"destroyWindows",value:function(){var e=this._windows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._windows=[]}},{key:"createScene",value:function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t}},{key:"destroyScene",value:function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)}},{key:"destroyScenes",value:function(){var e=this._scenes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._scenes=[]}},{key:"createView",value:function(e){var t=this._createViewFun(this,e.camera);return t.initialize(e),this._views.push(t),t}},{key:"destroyView",value:function(e){for(var t=0;t<this._views.length;++t)if(this._views[t]===e)return this._views.splice(t,1),void e.destroy()}},{key:"destroyViews",value:function(){var e=this._views,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._views=[]}}]),t}(),Cx=m4("Director",function(){function r(){var e;y(this,r),(e=x(this,g(r).call(this)))._compScheduler=void 0,e._nodeActivator=void 0,e.invalid=void 0,e._paused=void 0,e._purgeDirectorInNextLoop=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._lastUpdate=void 0,e._deltaTime=void 0,e._scheduler=void 0,e._systems=void 0,e.invalid=!1,e._paused=!1,e._purgeDirectorInNextLoop=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._lastUpdate=0,e._deltaTime=0,e._scheduler=new uv,e._compScheduler=new Eg,e._nodeActivator=new Pg,e._systems=[];var t=c(e);return cc.game.on(_p.EVENT_SHOW,function(){t._lastUpdate=performance.now()}),cc.game.once(_p.EVENT_RENDERER_INITED,e.initOnRenererInited,c(e)),cc.game.once(_p.EVENT_ENGINE_INITED,e.initOnEngineInited,c(e)),e}return _(r,cl),l(r,[{key:"initOnRenererInited",value:function(){this._root=new Ax(cc.game._gfxDevice);return!!this._root.initialize({})}},{key:"initOnEngineInited",value:function(){this._totalFrames=0,this._lastUpdate=performance.now(),this._paused=!1,this._purgeDirectorInNextLoop=!1,cc.loader.init(this),zp&&zp.setEnabled(!0),this.registerSystem(uv.ID,this._scheduler,200),this.emit(r.EVENT_INIT)}},{key:"calculateDeltaTime",value:function(){var e=performance.now();this._deltaTime=(e-this._lastUpdate)/1e3,this._lastUpdate=e}},{key:"convertToGL",value:function(e){var t=cc.game.container,i=cc.view,n=t.getBoundingClientRect(),r=n.left+window.pageXOffset-t.clientLeft,a=n.top+window.pageYOffset-t.clientTop,s=i._devicePixelRatio*(e.x-r),o=i._devicePixelRatio*(a+n.height-e.y);return i._isRotated?cc.v2(i._viewportRect.width-o,s):cc.v2(s,o)}},{key:"convertToUI",value:function(e){var t=cc.game.container,i=cc.view,n=t.getBoundingClientRect(),r=n.left+window.pageXOffset-t.clientLeft,a=n.top+window.pageYOffset-t.clientTop,s=cc.v2(0,0);return i._isRotated?(s.x=r+e.y/i._devicePixelRatio,s.y=a+n.height-(i._viewportRect.width-e.x)/i._devicePixelRatio):(s.x=r+e.x*i._devicePixelRatio,s.y=a+n.height-e.y*i._devicePixelRatio),s}},{key:"end",value:function(){this._purgeDirectorInNextLoop=!0}},{key:"getWinSize",value:function(){return cc.size(cc.winSize)}},{key:"getWinSizeInPixels",value:function(){return cc.size(cc.winSize)}},{key:"pause",value:function(){this._paused||(this._paused=!0)}},{key:"purgeCachedData",value:function(){cc.loader.releaseAll()}},{key:"purgeDirector",value:function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),zp&&zp.setEnabled(!1),cc.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),null!=this._root&&this._root.destroy(),this._root=null,cc.loader.releaseAll()}},{key:"reset",value:function(){this.purgeDirector(),this.emit(r.EVENT_RESET),zp&&zp.setEnabled(!0),this.startAnimation()}},{key:"runSceneImmediate",value:function(e,t,i){cc.assertID(e instanceof cc.Scene,1216);var n=cc.loader._getReferenceKey(e.uuid);cc.loader.removeItem(n),e._load();for(var r=Object.keys(cc.game._persistRootNodes).map(function(e){return cc.game._persistRootNodes[e]}),a=0;a<r.length;a++){var s=r[a];s.emit(cc.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var o=e.getChildByUuid(s.uuid);if(o){var l=o.getSiblingIndex();o._destroyImmediate(),e.insertChild(s,l)}else s.parent=e}var u=this._scene;!function(e,t,i){var n=cc.loader._autoReleaseSetting,r=ke();if(t)for(var a=0;a<t.length;a++)r[t[a]]=!0;for(var s=0;s<i.length;s++)dv(i[s],r);if(e)for(var o=0;o<e.length;o++){var l=e[o];!1===n[l]||r[l]||cc.loader.release(l)}for(var u=Object.keys(n),c=0;c<u.length;c++){var h=u[c];!0!==n[h]||r[h]||cc.loader.release(h)}}(u&&u.autoReleaseAssets&&u.dependAssets,e.dependAssets,r),cc.isValid(u)&&u.destroy(),this._scene=null,Uo._deferredDestroy(),t&&t(),this.emit(cc.Director.EVENT_BEFORE_SCENE_LAUNCH,e),(this._scene=e)._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,e),this.emit(cc.Director.EVENT_AFTER_SCENE_LAUNCH,e)}},{key:"runScene",value:function(e,t,i){var n=this;cc.assertID(e,1205),cc.assertID(e instanceof cc.Scene,1216),e._load(),this.once(cc.Director.EVENT_AFTER_UPDATE,function(){n.runSceneImmediate(e,t,i)})}},{key:"_getSceneUuid",value:function(e){var t=cc.game._sceneInfos;if("string"==typeof e){e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e);for(var i=0;i<t.length;i++){var n=t[i];if(n.url.endsWith(e))return n}}else if("number"==typeof e){if(0<=e&&e<t.length)return t[e];cc.errorID(1206,e)}else cc.errorID(1207,e);return null}},{key:"loadScene",value:function(e,t,i){if(this._loadingScene)return cc.errorID(1208,e,this._loadingScene),!1;var n=this._getSceneUuid(e);if(n){var r=n.uuid;return this.emit(cc.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,this._loadSceneByUuid(r,t,i),!0}return cc.errorID(1209,e),!1}},{key:"preloadScene",value:function(i,e,n){void 0===n&&(n=e,e=null);var t=this._getSceneUuid(i);if(t)this.emit(cc.Director.EVENT_BEFORE_SCENE_LOADING,i),cc.loader.load({uuid:t.uuid,type:"uuid"},e,function(e,t){e&&cc.errorID(1210,i,e.message),n&&n(e,t)});else{var r='Can not preload the scene "'+i+'" because it is not in the build settings.';n(new Error(r)),cc.error("preloadScene: "+r)}}},{key:"_loadSceneByUuid",value:function(r,e,t,i){var a=1<arguments.length&&void 0!==e?e:null,s=2<arguments.length&&void 0!==t?t:null;console.time("LoadScene "+r),cc.AssetLibrary.loadAsset(r,function(e,t){console.timeEnd("LoadScene "+r);var i=kx;if(i._loadingScene="",e)e="Failed to load scene: "+e,cc.error(e);else{if(t instanceof cc.SceneAsset){var n=t.scene;return n._id=t._uuid,n._name=t._name,void i.runSceneImmediate(n,s,a)}e="The asset "+r+" is not a scene",cc.error(e)}a&&a(e)})}},{key:"resume",value:function(){this._paused&&(this._lastUpdate=performance.now(),this._lastUpdate||cc.logID(1200),this._paused=!1,this._deltaTime=0)}},{key:"setDepthTest",value:function(e){cc.Camera.main&&(cc.Camera.main.depth=!!e)}},{key:"setClearColor",value:function(e){cc.Camera.main&&(cc.Camera.main.backgroundColor=e)}},{key:"getRunningScene",value:function(){return this._scene}},{key:"getScene",value:function(){return this._scene}},{key:"getAnimationInterval",value:function(){return 1e3/cc.game.getFrameRate()}},{key:"setAnimationInterval",value:function(e){cc.game.setFrameRate(Math.round(1e3/e))}},{key:"getDeltaTime",value:function(){return this._deltaTime}},{key:"getCurrentTime",value:function(){return this._lastUpdate}},{key:"getTotalFrames",value:function(){return this._totalFrames}},{key:"isPaused",value:function(){return this._paused}},{key:"getScheduler",value:function(){return this._scheduler}},{key:"setScheduler",value:function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(uv.ID,e,200))}},{key:"registerSystem",value:function(e,t,i){t.id=e,t.priority=i,t.init(),this._systems.push(t),this._systems.sort(iv.sortByPriority)}},{key:"unregisterSystem",value:function(e){$e.fastRemove(this._systems,e),this._systems.sort(iv.sortByPriority)}},{key:"getSystem",value:function(t){return this._systems.find(function(e){return e.id===t})}},{key:"getAnimationManager",value:function(){return this.getSystem(cc.AnimationManager.ID)}},{key:"startAnimation",value:function(){this.invalid=!1,this._lastUpdate=performance.now()}},{key:"stopAnimation",value:function(){this.invalid=!0}},{key:"mainLoop",value:function(e){if(this._purgeDirectorInNextLoop)this._purgeDirectorInNextLoop=!1,this.purgeDirector();else if(!this.invalid){this.calculateDeltaTime();var t=this._deltaTime;if(!this._paused){this.emit(r.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(t);for(var i=0;i<this._systems.length;++i)this._systems[i].update(t);this._compScheduler.lateUpdatePhase(t),this.emit(r.EVENT_AFTER_UPDATE),Uo._deferredDestroy();for(var n=0;n<this._systems.length;++n)this._systems[n].postUpdate(t)}this.emit(r.EVENT_BEFORE_DRAW),this._root.frameMove(this._deltaTime),this._root.device.present(),this.emit(r.EVENT_AFTER_DRAW),zp.frameUpdateListeners(),cy.bookOfChange.clear(),this._totalFrames++}}},{key:"root",get:function(){return this._root}}]),r}());Cx.EVENT_INIT="director_init",Cx.EVENT_RESET="director_reset",Cx.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",Cx.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",Cx.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",Cx.EVENT_BEFORE_UPDATE="director_before_update",Cx.EVENT_AFTER_UPDATE="director_after_update",Cx.EVENT_BEFORE_DRAW="director_before_draw",Cx.EVENT_AFTER_DRAW="director_after_draw",Cx.EVENT_BEFORE_PHYSICS="director_before_physics",Cx.EVENT_AFTER_PHYSICS="director_after_physics",Cx.instance=void 0,cc.Director=Cx;var kx=m4("director",Cx.instance=cc.director=new Cx);function Rx(e){var t=[];return function e(t,i){var n=i,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;Array.isArray(o)?e(t,o):t.push(o)}}(t,e),t.join("")}cc.RenderPassStage=gf;var Ox=Uo.Flags.Destroyed,Mx=Uo.Flags.PersistentMask,Ix=gt+"default",Bx=si.IDENTIFIER_RE,Lx="var ",Px="o",Fx={"cc.Node":"cc.Node","cc.Sprite":"cc.Sprite","cc.Label":"cc.Label","cc.Button":"cc.Button","cc.Widget":"cc.Widget","cc.Animation":"cc.Animation","cc.ClickEvent":!1,"cc.PrefabInfo":!1},zx=si.escapeForJS,Dx=function(){function i(e,t){y(this,i),this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return l(i,[{key:"toString",value:function(){return Lx+this.varName+"="+this.expression+";"}}]),i}();function Nx(e,t){return t instanceof Dx?new Dx(t.varName,e+t.expression):e+t}function Ux(e,t,i){Array.isArray(i)?(i[0]=Nx(t,i[0]),e.push(i)):e.push(Nx(t,i)+";")}var Vx=function(){function t(e){y(this,t),this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}return l(t,[{key:"append",value:function(e,t){this._exps.push([e,t])}},{key:"writeCode",value:function(e){var t;if(1<this._exps.length)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var i=0;i<this._exps.length;i++){var n=this._exps[i];Ux(e,t+Gx(n[0])+"=",n[1])}}}]),t}();function Gx(e){return Bx.test(e)?"."+e:"["+zx(e)+"]"}Vx.pool=void 0,Vx.pool=new Je(function(e){e._exps.length=0,e._targetExp=null},1),Vx.pool.get=function(e){var t=this._get()||new Vx;return t._targetExp=e,t};var Hx,Wx,qx,jx,Xx,Yx,Kx,Qx=function(){function s(e,t){var i;y(this,s),this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=ke(),Ne(this.funcModuleCache,Fx),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),0<this.globalVariables.length&&(i=Lx+this.globalVariables.join(",")+";");var n=Rx(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",n)(this.objs,this.funcs);for(var r=0,a=this.objsToClear_iN$t.length;r<a;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}return l(s,[{key:"getFuncModule",value:function(e,t){var i=Re(e);if(i){var n=this.funcModuleCache[i];if(n)return n;if(void 0===n){var r=-1!==i.indexOf(".");if(r)try{if(r=e===Function("return "+i)())return this.funcModuleCache[i]=i}catch(e){}}}var a=this.funcs.indexOf(e);a<0&&(a=this.funcs.length,this.funcs.push(e));var s="F["+a+"]";return t&&(s="("+s+")"),this.funcModuleCache[i]=s}},{key:"getObjRef",value:function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"}},{key:"setValueType",value:function(e,t,i,n){var r=Vx.pool.get(n),a=t.constructor.__props__;a=a||Object.keys(t);for(var s=0;s<a.length;s++){var o=a[s],l=i[o];if(t[o]!==l){var u=this.enumerateField(i,o,l);r.append(o,u)}}r.writeCode(e),Vx.pool.put(r)}},{key:"enumerateCCClass",value:function(e,t,i){for(var n=i.__values__,r=Tt(i),a=0;a<n.length;a++){var s=n[a],o=t[s],l=r[s+Ix];if(!Zx(l,o))if("object"===be(o)&&o instanceof cc.ValueType&&(l=si.getDefault(l))&&l.constructor===o.constructor){var u=Px+Gx(s);this.setValueType(e,l,o,u)}else this.setObjProp(e,t,s,o)}}},{key:"instantiateArray",value:function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,i=[new Dx(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var n=0;n<e.length;++n){Ux(i,t+"["+n+"]=",this.enumerateField(e,n,e[n]))}return i}},{key:"enumerateField",value:function(e,t,i){if("object"===be(i)&&i){var n=i._iN$t;if(n){var r=n.globalVar;if(!r){r=n.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var a=n.source[0];n.source[0]=Nx(r+"=",a)}return r}return Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?zx(i):("_objFlags"===t&&e instanceof Uo&&(i&=Mx),i)}},{key:"setObjProp",value:function(e,t,i,n){Ux(e,Px+Gx(i)+"=",this.enumerateField(t,i,n))}},{key:"enumerateObject",value:function(e,t){var i=t.constructor;if(cc.Class._isCCClass(i))this.enumerateCCClass(e,t,i);else for(var n in t)if(t.hasOwnProperty(n)&&(95!==n.charCodeAt(0)||95!==n.charCodeAt(1)||"__type__"===n)){var r=t[n];"object"===be(r)&&r&&r===t._iN$t||this.setObjProp(e,t,n,r)}}},{key:"instantiateObj",value:function(e){if(e instanceof cc.ValueType)return si.getNewValueTypeCode(e);if(e instanceof cc.Asset)return this.getObjRef(e);if(e._objFlags&Ox)return null;var t,i=e.constructor;if(cc.Class._isCCClass(i)){if(this.parent)if(this.parent instanceof cc.Component){if(e instanceof cc._BaseNode||e instanceof cc.Component)return this.getObjRef(e)}else if(this.parent instanceof cc._BaseNode)if(e instanceof cc._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof cc.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new Dx(Px,"new "+this.getFuncModule(i,!0)+"()")}else if(i===Object)t=new Dx(Px,"{}");else{if(i)return this.getObjRef(e);t=new Dx(Px,"Object.create(null)")}var n=[t];return e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e),this.enumerateObject(n,e),["(function(){",n,"return o;})();"]}}]),s}();function Zx(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t){if(e instanceof cc.ValueType&&e.equals(t))return!0;if(Array.isArray(e)&&Array.isArray(t)||e.constructor===Object&&t.constructor===Object)try{return Array.isArray(e)&&Array.isArray(t)&&0===e.length&&0===t.length}catch(e){}}return!1}function Jx(e){var t=e instanceof cc._BaseNode&&e;return new Qx(e,t).result}var $x,eS,tS,iS,nS=vt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),rS=m4("Prefab",fo("cc.Prefab")((Kx=Yx=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"data",qx,c(e)),v(e,"optimizationPolicy",jx,c(e)),v(e,"asyncLoadAssets",Xx,c(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}return _(t,nh),l(t,[{key:"createNode",value:function(e){var t=cc.instantiate(this);t.name=this.name,e(null,t)}},{key:"compileCreateFunction",value:function(){this._createFunction=Jx(this.data)}},{key:"_doInstantiate",value:function(e){return this.data._prefab?this.data._prefab._synced=!0:cc.warnID(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)}},{key:"_instantiate",value:function(){var e;return this.optimizationPolicy!==nS.SINGLE_INSTANCE&&(this.optimizationPolicy===nS.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):(this.data._prefab._synced=!0,e=this.data._instantiate()),++this._instantiatedTimes,e}}]),t}(),Yx.OptimizationPolicy=nS,Yx.OptimizationPolicyThreshold=3,qx=m((Wx=Kx).prototype,"data",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jx=m(Wx.prototype,"optimizationPolicy",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nS.AUTO}}),Xx=m(Wx.prototype,"asyncLoadAssets",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Hx=Wx))||Hx);cc.Prefab=rS,Oe(cc,"cc._Prefab","Prefab");var aS,sS,oS,lS=m4("SceneAsset",fo("cc.SceneAsset")((tS=m((eS=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"scene",tS,c(t)),v(t,"asyncLoadAssets",iS,c(t)),t}return _(a,nh),a}()).prototype,"scene",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iS=m(eS.prototype,"asyncLoadAssets",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$x=eS))||$x);cc.SceneAsset=lS;var uS,cS,hS,fS=m4("SpriteAtlas",fo("cc.SpriteAtlas")((oS=m((sS=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"spriteFrames",oS,c(t)),t}return _(a,nh),l(a,[{key:"getTexture",value:function(){var e=Object.keys(this.spriteFrames);if(0<e.length){var t=this.spriteFrames[e[0]];return t&&t._image}return null}},{key:"getSpriteFrame",value:function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null}},{key:"getSpriteFrames",value:function(){for(var e=[],t=this.spriteFrames,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i];e.push(t[r])}return e}},{key:"_serialize",value:function(e){for(var t=[],i=0,n=Object.keys(this.spriteFrames);i<n.length;i++){var r=n[i],a=this.spriteFrames[r],s=a?a._uuid:"";s&&e&&(s=Editor.Utils.UuidUtils.compressUuid(s,!0)),t.push(r),t.push(s)}return{name:this._name,spriteFrames:t}}},{key:"_deserialize",value:function(e,t){var i=e;this._name=i.name;var n=i.spriteFrames;this.spriteFrames=ke();for(var r=0;r<n.length;r+=2)t.result.push(this.spriteFrames,n[r],n[r+1])}}]),a}()).prototype,"spriteFrames",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ke()}}),aS=sS))||aS);cc.SpriteAtlas=fS;var dS,_S,pS,vS=m4("TextAsset",fo("cc.TextAsset")((hS=m((cS=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"text",hS,c(t)),t}return _(a,nh),l(a,[{key:"toString",value:function(){return this.text}}]),a}()).prototype,"text",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),uS=cS))||uS);cc.TextAsset=vS;var mS=m4("JsonAsset",fo("cc.JsonAsset")((pS=m((_S=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"json",pS,c(t)),t}return _(a,nh),a}()).prototype,"json",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dS=_S))||dS);cc.JsonAsset=mS;var yS="0123456789abcdef".split(""),gS=["","","",""],bS=gS.concat(gS,"-",gS,"-",gS,"-",gS,"-",gS,gS,gS),xS=bS.map(function(e,t){return"-"===e?NaN:t}).filter(isFinite);function SS(e){var t=e.split("@")[0];if(22!==t.length)return e;bS[0]=e[0],bS[1]=e[1];for(var i=2,n=2;i<22;i+=2){var r=at[e.charCodeAt(i)],a=at[e.charCodeAt(i+1)];bS[xS[n++]]=yS[r>>2],bS[xS[n++]]=yS[(3&r)<<2|a>>4],bS[xS[n++]]=yS[15&a]}return e.replace(t,bS.join(""))}var TS={_rawAssets:"",normalize:function(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e},raw:function(e){if((e=this.normalize(e)).startsWith("resources/")){var t=cc.loader._getResUuid(e.slice(10),cc.Asset,null,!0);if(t)return cc.AssetLibrary.getLibUrlNoExt(t,!0)+cc.path.extname(e)}else cc.errorID(7002,e);return this._rawAssets+e},_init:function(e){this._rawAssets=cc.path.stripSep(e)+"/"}};cc.url=TS,m4("url",TS);function wS(e,t){y(this,wS),this.uuid=void 0,this.type=void 0,this.uuid=e,this.type=t}var ES,AS,CS=function(){function e(){y(this,e),this._pathToUuid=void 0,this._pathToUuid=ke(!0)}return l(e,[{key:"getUuid",value:function(e,t){e=TS.normalize(e);var i=this._pathToUuid[e];if(i)if(Array.isArray(i)){if(!t)return i[0].uuid;for(var n=0;n<i.length;n++){var r=i[n];if(Ge(r.type,t))return r.uuid}}else{if(!t||Ge(i.type,t))return i.uuid}return""}},{key:"getUuidArray",value:function(e,t,i){"/"===(e=TS.normalize(e))[e.length-1]&&(e=e.slice(0,-1));var n,r,a=this._pathToUuid,s=[];for(var o in a)if(o.startsWith(e)&&(r=e,!((n=o).length>r.length)||47===n.charCodeAt(r.length))||!e){var l=a[o];if(Array.isArray(l))for(var u=0;u<l.length;u++){var c=l[u];(!t||Ge(c.type,t))&&(s.push(c.uuid),i&&i.push(o))}else(!t||Ge(l.type,t))&&(s.push(l.uuid),i&&i.push(o))}return s}},{key:"add",value:function(e,t,i,n){n&&(e=e.substring(0,e.length-Q(e).length));var r=new wS(t,i);lt(this._pathToUuid,e,r,n)}},{key:"_getInfo_DEBUG",value:function(e,t){for(var i=this._pathToUuid,n=Object.keys(i),r=0;r<n.length;++r){var a=n[r],s=i[a];if(Array.isArray(s))for(var o=0;o<s.length;o++){var l=s[o];if(l.uuid===e)return t.path=a,t.type=l.type,!0}else if(s.uuid===e)return t.path=a,t.type=s.type,!0}return!1}},{key:"reset",value:function(){this._pathToUuid=ke(!0)}}]),e}(),kS=0|998*Math.random(),RS=ke(!0),OS=[];(AS=ES=ES||{})[AS.WORKING=0]="WORKING",AS[AS.COMPLETE=1]="COMPLETE",AS[AS.ERROR=2]="ERROR";var MS=ke(!0);function IS(t,e){var i="object"===be(t)?t.url:t,n={queueId:e,id:i,url:i,rawUrl:void 0,urlParam:function(e){if(e){var t=e.split("?");if(t&&t[0]&&t[1]){var i={};return t[1].split("&").forEach(function(e){var t=e.split("=");i[t[0]]=t[1]}),i}}}(i),type:"",error:null,content:null,complete:!1,states:{},deps:null,isScene:t.uuid&&cc.game._sceneInfos.find(function(e){return e.uuid===t.uuid})};if("object"===be(t)&&(Ne(n,t),t.skips))for(var r=0;r<t.skips.length;r++){var a=t.skips[r];n.states[a]=ES.COMPLETE}return n.rawUrl=n.url,i&&!n.type&&(n.type=Q(i).toLowerCase().substr(1)),n}var BS=[];function LS(e,t,i){if(!e||!t)return!1;var n=!1;if(BS.push(t.id),t.deps){var r,a,s=t.deps;for(r=0;r<s.length;r++){if((a=s[r]).id===e.id){n=!0;break}if(!(0<=BS.indexOf(a.id))&&(a.deps&&LS(e,a,!0))){n=!0;break}}}return i||(BS.length=0),n}var PS=m4("LoadingItems",function(){function u(e,t,i,n){var r;return y(this,u),(r=x(this,g(u).call(this))).onProgress=void 0,r.onComplete=void 0,r.map=ke(!0),r.completed={},r.totalCount=0,r.completedCount=0,r.active=void 0,r._id=void 0,r._pipeline=void 0,r._errorUrls=[],r._appending=!1,r._ownerQueue=null,r._id=++kS,RS[r._id]=c(r),r._pipeline=e,r.onProgress=i,r.onComplete=n,r._pipeline?r.active=!0:r.active=!1,t&&(0<t.length?r.append(t):r.allComplete()),r}return _(u,ll),l(u,[{key:"append",value:function(e,i){var n=this;if(!this.active)return[];i&&!i.deps&&(i.deps=[]),this._appending=!0;var t,r,a,s,o=[];for(t=0;t<e.length;++t){if((r=e[t]).queueId&&!this.map[r.id]){if(this.map[r.id]=r,i&&i.deps.push(r),r.complete||LS(i,r)){this.totalCount++,this.itemComplete(r.id);continue}if("continue"===function(){var t=n,e=RS[r.queueId];return e&&(n.totalCount++,u.registerQueueDep(i||n._id,r.id),e.addListener(r.id,function(e){t.itemComplete(e.id)})),"continue"}())continue}if("string"==typeof((s=r).url||s)){var l=(a=IS(r,this._id)).id;this.map[l]||(this.map[l]=a,this.totalCount++,i&&i.deps.push(a),u.registerQueueDep(i||this._id,l),o.push(a))}}return this._appending=!1,this.completedCount===this.totalCount?this.allComplete():this._pipeline.flowIn(o),o}},{key:"_childOnProgress",value:function(e){if(this.onProgress){var t=MS[this._id];this.onProgress(t?t.completed.length:this.completedCount,t?t.deps.length:this.totalCount,e)}}},{key:"allComplete",value:function(){var e=0===this._errorUrls.length?null:this._errorUrls;this.onComplete&&this.onComplete(e,this)}},{key:"isCompleted",value:function(){return this.completedCount>=this.totalCount}},{key:"isItemCompleted",value:function(e){return!!this.completed[e]}},{key:"exists",value:function(e){return!!this.map[e]}},{key:"getContent",value:function(e){var t=this.map[e],i=null;return t&&(t.content?i=t.content:t.alias&&(i=t.alias.content)),i}},{key:"getError",value:function(e){var t=this.map[e],i=null;return t&&(t.error?i=t.error:t.alias&&(i=t.alias.error)),i}},{key:"removeItem",value:function(e){var t=this.map[e];t&&this.completed[t.alias||e]&&(delete this.completed[e],delete this.map[e],t.alias&&(delete this.completed[t.alias.id],delete this.map[t.alias.id]),this.completedCount--,this.totalCount--)}},{key:"itemComplete",value:function(e){var t=this.map[e];if(t){var i=this._errorUrls.indexOf(e);if(t.error&&-1===i?this._errorUrls.push(e):t.error||-1===i||this._errorUrls.splice(i,1),this.completed[e]=t,this.completedCount++,u.finishDep(t.id),this.onProgress){var n=MS[this._id];this.onProgress(n?n.completed.length:this.completedCount,n?n.deps.length:this.totalCount,t)}this.emit(e,t),this.removeAll(e),!this._appending&&this.completedCount>=this.totalCount&&this.allComplete()}}},{key:"destroy",value:function(){this.active=!1,this._appending=!1,this._pipeline=null,this._ownerQueue=null,this._errorUrls.length=0,this.onProgress=void 0,this.onComplete=void 0,this.map=ke(!0),this.completed={},this.totalCount=0,this.completedCount=0,ll.call(this),RS[this._id]=null,MS[this._id]&&(MS[this._id].completed.length=0,MS[this._id].deps.length=0),-1===OS.indexOf(this)&&OS.length<10&&OS.push(this)}},{key:"addListener",value:function(e,t,i){return p(g(u.prototype),"on",this).call(this,e,t,i)}},{key:"hasListener",value:function(e,t,i){return p(g(u.prototype),"hasEventListener",this).call(this,e,t,i)}},{key:"removeListener",value:function(e,t,i){return p(g(u.prototype),"off",this).call(this,e,t,i)}},{key:"removeAllListeners",value:function(e){p(g(u.prototype),"removeAll",this).call(this,e)}}],[{key:"create",value:function(e,t,i,n){void 0===i?"function"==typeof t&&(n=t,t=i=null):void 0===n&&("function"==typeof t?(n=i,i=t,t=null):(n=i,i=null));var r=OS.pop();return r?(r._pipeline=e,r.onProgress=i,r.onComplete=n,(RS[r._id]=r)._pipeline&&(r.active=!0),t&&r.append(t)):r=new u(e,t,i,n),r}},{key:"getQueue",value:function(e){return e.queueId?RS[e.queueId]:null}},{key:"itemComplete",value:function(e){var t=RS[e.queueId];t&&t.itemComplete(e.id)}},{key:"initQueueDeps",value:function(e){var t=MS[e._id];t?(t.completed.length=0,t.deps.length=0):t=MS[e._id]={completed:[],deps:[]}}},{key:"registerQueueDep",value:function(e,t){var i=e.queueId||e;if(!i)return!1;var n=MS[i];if(n)-1===n.deps.indexOf(t)&&n.deps.push(t);else if(e.id)for(var r in MS){var a=MS[r];-1!==a.deps.indexOf(e.id)&&-1===a.deps.indexOf(t)&&a.deps.push(t)}}},{key:"finishDep",value:function(e){for(var t in MS){var i=MS[t];-1!==i.deps.indexOf(e)&&-1===i.completed.indexOf(e)&&i.completed.push(e)}}}]),u}());PS.ItemState=new cc.Enum(ES);var FS=(cc.LoadingItems=PS).ItemState;function zS(e,i){var n=e.id,t=i.states[n],r=e.next,a=e.pipeline;if(!i.error&&t!==FS.WORKING&&t!==FS.ERROR)if(t===FS.COMPLETE)r?zS(r,i):a.flowOut(i);else{i.states[n]=FS.WORKING;var s=e.handle(i,function(e,t){e?(i.error=e,i.states[n]=FS.ERROR,a.flowOut(i)):(t&&(i.content=t),i.states[n]=FS.COMPLETE,r?zS(r,i):a.flowOut(i))});s instanceof Error?(i.error=s,i.states[n]=FS.ERROR,a.flowOut(i)):void 0!==s&&(null!==s&&(i.content=s),i.states[n]=FS.COMPLETE,r?zS(r,i):a.flowOut(i))}}var DS=m4("Pipeline",function(){function n(e){y(this,n),this._pipes=void 0,this._cache=ke(!0),this._pipes=e;for(var t=0;t<e.length;++t){var i=e[t];i.handle&&i.id&&(i.pipeline=this,i.next=t<e.length-1?e[t+1]:null)}}return l(n,[{key:"insertPipe",value:function(e,t){if(!e.handle||!e.id||t>this._pipes.length)cc.warnID(4921);else if(0<this._pipes.indexOf(e))cc.warnID(4922);else{var i=null;t<(e.pipeline=this)._pipes.length&&(i=this._pipes[t]);var n=null;0<t&&(n=this._pipes[t-1]),n&&(n.next=e),e.next=i,this._pipes.splice(t,0,e)}}},{key:"insertPipeAfter",value:function(e,t){var i=this._pipes.indexOf(e);i<0||this.insertPipe(t,i+1)}},{key:"appendPipe",value:function(e){e.handle&&e.id&&(e.pipeline=this,e.next=null,0<this._pipes.length&&(this._pipes[this._pipes.length-1].next=e),this._pipes.push(e))}},{key:"flowIn",value:function(e){var t,i,n=this._pipes[0];if(n){for(t=0;t<e.length;t++)(i=e[t]).isScene||(this._cache[i.id]=i);for(t=0;t<e.length;t++)zS(n,i=e[t])}else for(t=0;t<e.length;t++)this.flowOut(e[t])}},{key:"flowInDeps",value:function(e,t,i){return PS.create(this,function(e,t){i(e,t),t.destroy()}).append(t,e)}},{key:"flowOut",value:function(e){e.error?delete this._cache[e.id]:this._cache[e.id]||e.isScene||(this._cache[e.id]=e),e.complete=!0,PS.itemComplete(e)}},{key:"copyItemStates",value:function(e,t){if(t instanceof Array)for(var i=0;i<t.length;++i)t[i].states=e.states;else t.states=e.states}},{key:"getItem",value:function(e){var t=this._cache[e];return t&&t.alias&&(t=t.alias),t}},{key:"removeItem",value:function(e){var t=this._cache[e];t&&t.complete&&delete this._cache[e];return t}},{key:"clear",value:function(){for(var e in this._cache){var t=this._cache[e];delete this._cache[e],t.complete||(t.error=new Error("Canceled manually"),this.flowOut(t))}}}]),n}());DS.ItemState=FS,cc.Pipeline=DS;var NS="MD5Pipe",US=/(\.[^.\n\\/]*)$/,VS=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;var GS=function(){function n(e,t,i){y(this,n),this.id=NS,this.async=!1,this.pipeline=null,this.md5AssetsMap=void 0,this.md5NativeAssetsMap=void 0,this.libraryBase=void 0,this.id=NS,this.async=!1,this.pipeline=null,this.md5AssetsMap=e,this.md5NativeAssetsMap=t,this.libraryBase=i}return l(n,[{key:"handle",value:function(e){var t=!1;return"ttf"===e.type&&(t=!0),e.url=this.transformURL(e.url,t),e}},{key:"transformURL",value:function(e,t){var i=function(e){var t=e.match(VS);return t?t[1]:""}(e);if(i){var n=(!e.match(this.libraryBase)?this.md5NativeAssetsMap:this.md5AssetsMap)[i];if(n)if(t){var r=cc.path.dirname(e),a=cc.path.basename(e);e="".concat(r,".").concat(n,"/").concat(a)}else{var s=!1;e=e.replace(US,function(e,t){return s=!0,"."+n+t}),s||(e=e+"."+n)}}return e}}]),n}();GS.ID=NS,DS.MD5Pipe=GS;var HS,WS,qS=function(){function e(){y(this,e),this.jsons={}}return l(e,[{key:"load",value:function(e,t){t.length!==e.length&&cc.errorID(4915);for(var i=0;i<e.length;i++){var n=e[i],r=t[i];this.jsons[n]=r}}},{key:"retrieve",value:function(e){return this.jsons[e]||null}}]),e}(),jS=function(){function e(){y(this,e),this.contents={}}return l(e,[{key:"load",value:function(e,t){var i=t.data;i.length!==e.length&&cc.errorID(4915);for(var n=0;n<e.length;n++)this.contents[e[n]]={base:i[n][0],mipmaps:i[n][1]}}},{key:"retrieve",value:function(e){var t=this.contents[e];return t?{__type__:cc.js._getClassId(cc.Texture2D),content:t}:null}}]),e}(),XS=/\?/;function YS(e){return cc.game.config.noCache&&"string"==typeof e&&(XS.test(e)?e+="&_t="+(new Date-0):e+="?_t="+(new Date-0)),e}function KS(e,t){if(Array.isArray(e))for(var i=0,n=e.length;i<n;i++)KS(e[i],t);else if("object"===be(e))for(var r in e)KS(e[r],t),Number.isNaN(Number(r))||(e[t[r]]=e[r],delete e[r]);return null}(WS=HS=HS||{})[WS.Invalid=0]="Invalid",WS[WS.Removed=1]="Removed",WS[WS.Downloading=2]="Downloading",WS[WS.Loaded=3]="Loaded";var QS=function e(){y(this,e),this.unpacker=void 0,this.state=void 0,this.unpacker=null,this.state=HS.Invalid},ZS={},JS={},$S={};function eT(e,t){return new Error("Can not retrieve "+e+" from packer "+t)}function tT(e){for(var t in JS=e)for(var i=e[t],n=0;n<i.length;n++){var r=i[n],a=1===i.length;lt(ZS,r,t,a)}}function iT(n,r,a){var e=cc.AssetLibrary.getLibUrlNoExt(r)+".json";cc.loader.load({url:e,ignoreMaxConcurrency:!0},function(e,t){if(e)return z(4916,n),a(e);var i=rT(n,r,t);i?a(null,i):a(eT(n,r))})}function nT(e,t){var i=$S[e];i||((i=$S[e]=new QS).state=HS.Downloading),i.state!==HS.Loaded&&(i.unpacker=new qS,i.unpacker.load(JS[e],t),i.state=HS.Loaded)}function rT(e,t,i){var n=$S[t];if(n.state!==HS.Loaded){if("string"==typeof i&&(i=JSON.parse(i)),i.keys&&i.data){var r=i.keys;KS(i=i.data,r)}Array.isArray(i)?n.unpacker=new qS:i.type===Ze(Hh)&&(n.unpacker=new jS),n.unpacker.load(JS[t],i),n.state=HS.Loaded}return n.unpacker.retrieve(e)}function aT(e){for(var t=HS.Invalid,i="",n=0;n<e.length;n++){var r=e[n],a=$S[r];if(a){var s=a.state;if(s===HS.Loaded)return r;t<s&&(t=s,i=r)}}return t!==HS.Invalid?i:e[0]}function sT(e,t){var i=e.uuid,n=ZS[i];if(n){Array.isArray(n)&&(n=aT(n));var r=$S[n];if(r&&r.state===HS.Loaded){var a=r.unpacker.retrieve(i);return a||eT(i,n)}return r||(console.log("Create unpacker %s for %s",n,i),(r=$S[n]=new QS).state=HS.Downloading),iT(i,n,t),null}}var oT=Object.freeze({initPacks:tT,_loadNewPack:iT,_doPreload:nT,_doLoadNewPack:rT,_selectLoadedPack:aT,load:sT}),lT="SubPackPipe",uT=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;var cT=Object.create(null),hT=function(){function n(t){y(this,n),this.id=lT,this.async=!1,this.pipeline=null;function e(e){var i=t[e];i.uuids&&i.uuids.forEach(function(e){var t=SS(e);t=t.split("@").map(function(e){return encodeURIComponent(e)}).join("@"),cT[t]=i.path})}for(var i in t)e(i)}return l(n,[{key:"handle",value:function(e){return e.url=this.transformURL(e.url),null}},{key:"transformURL",value:function(e){var t=function(e){var t=e.match(uT);return t?t[1]:""}(e);if(t){var i=cT[t];if(i)return e.replace("res/raw-assets/",i+"raw-assets/")}return e}}]),n}();hT.ID=lT,DS.SubPackPipe=hT;var fT="",dT="",_T=ke(!0);function pT(e,t){this.url=e,this.type=t}var vT,mT={_uuidToAsset:{},loadAsset:function(n,r,e){if("string"!=typeof n)return ht(r,new Error("[AssetLibrary] uuid must be string"),null);var t={uuid:n,type:"uuid"};e&&e.existingAsset&&(t.existingAsset=e.existingAsset),cc.loader.load(t,function(e,t){if(e||!t)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+(e?e.message:"Unknown error"));else if(t.constructor===cc.SceneAsset){var i=cc.loader._getReferenceKey(n);t.scene.dependAssets=_v(i)}r&&r(e,t)})},getLibUrlNoExt:function(e,t){return e=(e=SS(e)).split("@").map(function(e){return encodeURIComponent(e)}).join("@"),(t?dT+"assets/":fT)+e.slice(0,2)+"/"+e},_queryAssetInfoInEditor:function(e,t){t(new Error("Unable to load resource: EditorExtends is not defined."))},_getAssetInfoInRuntime:function(e,t){t=t||{url:null,raw:!1};var i=_T[e];return i&&!Ge(i.type,cc.Asset)?(t.url=dT+i.url,t.raw=!0):(t.url=this.getLibUrlNoExt(e)+".json",t.raw=!1),t},_uuidInSettings:function(e){return e in _T},queryAssetInfo:function(e,t){var i=this._getAssetInfoInRuntime(e);t(null,i.url,i.raw)},parseUuidInEditor:function(e){},loadJson:function(e,r){var a=""+((new Date).getTime()+Math.random()),t={uuid:a,type:"uuid",content:e,skips:[cc.loader.assetLoader.id,cc.loader.downloader.id]};cc.loader.load(t,function(e,t){if(e)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+e.message);else{if(t.constructor===cc.SceneAsset){var i=cc.loader._getReferenceKey(a);t.scene.dependAssets=_v(i)}if(function(e){return e&&(e.constructor===cc.SceneAsset||e instanceof cc.Scene)}(t)){var n=cc.loader._getReferenceKey(a);cc.loader.removeItem(n)}}t._uuid="",r&&r(e,t)})},getAssetByUuid:function(e){return mT._uuidToAsset[e]||null},init:function(e){var t=e.libraryPath;t=t.replace(/\\/g,"/"),fT=cc.path.stripSep(t)+"/",dT=e.rawAssetsBase;var i=e.md5AssetsMap;if(i&&i.import){var n=0,r=ke(!0),a=i.import;for(n=0;n<a.length;n+=2){r[SS(a[n]).split("@").map(function(e){return encodeURIComponent(e)}).join("@")]=a[n+1]}var s=ke(!0);for(a=i["raw-assets"],n=0;n<a.length;n+=2){s[SS(a[n]).split("@").map(function(e){return encodeURIComponent(e)}).join("@")]=a[n+1]}var o=new GS(r,s,fT);cc.loader.insertPipeAfter(cc.loader.assetLoader,o),cc.loader.md5Pipe=o}if(e.subpackages){var l=new hT(e.subpackages);cc.loader.insertPipeAfter(cc.loader.assetLoader,l),cc.loader.subPackPipe=l}var u=cc.loader._assetTables;for(var c in u)u[c].reset();var h=e.rawAssets;if(h)for(var f in h){var d=h[f];for(var _ in d){var p=d[_],v=p[0],m=p[1],y=Ke(m);if(y){_T[_]=new pT(f+"/"+v,y);var g=1===p[2];u[f]||(u[f]=new CS),u[f].add(v,_,y,!g)}else cc.error("Cannot get",m)}}e.packedAssets&&tT(e.packedAssets),cc.url._init(e.mountPaths&&e.mountPaths.assets||dT+"assets")}};cc.AssetLibrary=mT,m4("AssetLibrary",mT);var yT,gT,bT,xT,ST,TT=m4("Font",fo("cc.Font")(vT=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return _(e,nh),e}())||vT);cc.Font=TT;var wT,ET,AT,CT,kT,RT,OT,MT,IT=m4("TTFFont",(yT=fo("cc.TTFFont"),gT=_o({type:cc.String,override:!0}),yT((ST=m((xT=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_fontFamily",ST,c(t)),t}return _(a,TT),l(a,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}}]),a}()).prototype,"_fontFamily",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m(xT.prototype,"_nativeAsset",[gT],Object.getOwnPropertyDescriptor(xT.prototype,"_nativeAsset"),xT.prototype),bT=xT))||bT));cc.TTFFont=IT;var BT,LT=m4("BitmapFont",(wT=fo("cc.BitmapFont"),ET=_o({type:Jh}),wT((kT=m((CT=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"fntDataStr",kT,c(t)),v(t,"spriteFrame",RT,c(t)),v(t,"fontSize",OT,c(t)),v(t,"fntConfig",MT,c(t)),t}return _(a,TT),a}()).prototype,"fntDataStr",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),RT=m(CT.prototype,"spriteFrame",[ET],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),OT=m(CT.prototype,"fontSize",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),MT=m(CT.prototype,"fntConfig",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),AT=CT))||AT));cc.BitmapFont=LT;var PT=m4("LabelAtlas",fo("cc.LabelAtlas")(BT=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return _(e,LT),e}())||BT);cc.LabelAtlas=PT;var FT="AssetLoader",zT=[],DT=function(){function e(){y(this,e),this.id=FT,this.async=!0,this.pipeline=null}return l(e,[{key:"handle",value:function(a,s){var o=a.uuid;if(!o)return a.content||null;cc.AssetLibrary.queryAssetInfo(o,function(e,t,i){if(e)s(e);else if(a.url=a.rawUrl=t,a.isRawAsset=i){var n=Q(t).toLowerCase();if(!n)return void s(new Error(G(4931,o,t)));n=n.substr(1);var r=PS.getQueue(a);zT[0]={queueId:a.queueId,id:t,url:t,type:n,error:null,alias:a,complete:!0},r.append(zT),a.type=n,s(null,a.content)}else a.type="uuid",s(null,a.content)})}}]),e}();function NT(e,t){var i=e.url,n=cc.loader.getXMLHttpRequest(),r="Load binary data failed: "+i;n.open("GET",i,!0),n.responseType="arraybuffer",n.onload=function(){var e=n.response;e?t(null,e):t({status:n.status,errorMessage:r+"(no response)"})},n.onerror=function(){t({status:n.status,errorMessage:r+"(error)"})},n.ontimeout=function(){t({status:n.status,errorMessage:r+"(time out)"})},n.send(null)}function UT(e,t){var i=e.url;i=YS(i);var n=cc.loader.getXMLHttpRequest(),r="Load text file failed: "+i;n.open("GET",i,!0),n.overrideMimeType&&n.overrideMimeType("text/plain; charset=utf-8"),n.onload=function(){4===n.readyState?200===n.status||0===n.status?t(null,n.responseText):t({status:n.status,errorMessage:r+"(wrong status)"}):t({status:n.status,errorMessage:r+"(wrong readyState)"})},n.onerror=function(){t({status:n.status,errorMessage:r+"(error)"})},n.ontimeout=function(){t({status:n.status,errorMessage:r+"(time out)"})},n.send(null)}function VT(){return null}function GT(e,t,i){var n=e.url,r=document,a=document.createElement("script");function s(){a.parentNode&&a.parentNode.removeChild(a),a.removeEventListener("load",s,!1),a.removeEventListener("error",o,!1),t(null,n)}function o(){a.parentNode&&a.parentNode.removeChild(a),a.removeEventListener("load",s,!1),a.removeEventListener("error",o,!1),t(new Error(G(4928,n)))}a.async=!!i,a.src=YS(n),a.addEventListener("load",s,!1),a.addEventListener("error",o,!1),r.body.appendChild(a)}function HT(e,t,i,n){void 0===i&&(i=!0);var r=YS(e.url);function a(){n.removeEventListener("load",a),n.removeEventListener("error",s),n.id=e.id,t(null,n)}function s(){n.removeEventListener("load",a),n.removeEventListener("error",s),"https:"!==window.location.protocol&&n.crossOrigin&&"anonymous"===n.crossOrigin.toLowerCase()?HT(e,t,!1,n):t(new Error(G(4930,r)))}if(n=n||new Image,i&&"file:"!==window.location.protocol?n.crossOrigin="anonymous":n.crossOrigin=null,n.complete&&0<n.naturalWidth&&n.src===r)return n;n.addEventListener("load",a),n.addEventListener("error",s),n.src=r}DT.ID=FT,DS.AssetLoader=DT;var WT={js:GT,png:HT,jpg:HT,bmp:HT,jpeg:HT,gif:HT,ico:HT,tiff:HT,webp:function(e,t,i,n){return cc.sys.capabilities.webp?HT(e,t,i,n):new Error(G(4929,e.url))},image:HT,pvr:NT,pkm:NT,txt:UT,xml:UT,vsh:UT,fsh:UT,atlas:UT,tmx:UT,tsx:UT,json:UT,ExportJson:UT,plist:UT,fnt:UT,font:VT,eot:VT,ttf:VT,woff:VT,svg:VT,ttc:VT,uuid:function(e,t){var i=sT(e,t);return void 0===i?this.extMap.json(e,t):i||void 0},binary:NT,bin:NT,default:UT},qT="Downloader",jT=m4("Downloader",function(){function t(e){y(this,t),this.id=qT,this.async=!0,this.pipeline=null,this.extMap=void 0,this._curConcurrent=0,this._loadQueue=[],this._subpackages={},this.extMap=Ne(e,WT)}return l(t,[{key:"addHandlers",value:function(e){Ne(this.extMap,e)}},{key:"_handleLoadQueue",value:function(){for(;this._curConcurrent<cc.macro.DOWNLOAD_MAX_CONCURRENT;){var e=this._loadQueue.shift();if(!e)break;var t=this.handle(e.item,e.callback);void 0!==t&&(t instanceof Error?e.callback(t):e.callback(null,t))}}},{key:"handle",value:function(e,i){var n=this,t=this.extMap[e.type]||this.extMap.default,r=void 0;if(this._curConcurrent<cc.macro.DOWNLOAD_MAX_CONCURRENT){if(this._curConcurrent++,void 0!==(r=t.call(this,e,function(e,t){n._curConcurrent=Math.max(0,n._curConcurrent-1),n._handleLoadQueue(),i&&i(e,t)})))return this._curConcurrent=Math.max(0,this._curConcurrent-1),this._handleLoadQueue(),r}else if(e.ignoreMaxConcurrency){if(void 0!==(r=t.call(this,e,i)))return r}else this._loadQueue.push({item:e,callback:i})}},{key:"loadSubpackage",value:function(e,t){var i=this._subpackages[e];i?i.loaded?t&&t():GT({url:i.path},function(e){e||(i.loaded=!0),t&&t(e)}):t&&t(new Error("Can't find subpackage ".concat(e)))}}]),t}());jT.ID=qT,jT.PackDownloader=oT,DS.Downloader=jT;var XT=function(){function e(){y(this,e),this._isSupportDOMParser=void 0,this._parser=void 0,window.DOMParser?(this._isSupportDOMParser=!0,this._parser=new DOMParser):(this._isSupportDOMParser=!1,this._parser=null)}return l(e,[{key:"parse",value:function(e){return this._parseXML(e)}},{key:"_parseXML",value:function(e){var t;return this._isSupportDOMParser?t=this._parser.parseFromString(e,"text/xml"):((t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e)),t}}]),e}(),YT=new(function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return _(e,XT),l(e,[{key:"parse",value:function(e){var t=this._parseXML(e),i=t.documentElement;if("plist"!==i.tagName)return cc.warnID(5100),{};for(var n=null,r=0,a=i.childNodes.length;r<a&&1!==(n=i.childNodes[r]).nodeType;r++);return t=null,this._parseNode(n)}},{key:"_parseNode",value:function(e){var t=null,i=e.tagName;if("dict"===i)t=this._parseDict(e);else if("array"===i)t=this._parseArray(e);else if("string"===i)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var n=0;n<e.childNodes.length;n++)t+=e.childNodes[n].nodeValue}else"false"===i?t=!1:"true"===i?t=!0:"real"===i?t=parseFloat(e.firstChild.nodeValue):"integer"===i&&(t=parseInt(e.firstChild.nodeValue,10));return t}},{key:"_parseArray",value:function(e){for(var t=[],i=0,n=e.childNodes.length;i<n;i++){var r=e.childNodes[i];1===r.nodeType&&t.push(this._parseNode(r))}return t}},{key:"_parseDict",value:function(e){for(var t={},i=null,n=0,r=e.childNodes.length;n<r;n++){var a=e.childNodes[n];1===a.nodeType&&("key"===a.tagName?i=a.firstChild.nodeValue:t[i]=this._parseNode(a))}return t}}]),e}());function KT(e){return e&&(e[0]&&"cc.Scene"===e[0].__type__||e[1]&&"cc.Scene"===e[1].__type__||e[0]&&"cc.Prefab"===e[0].__type__)}function QT(t,i){var e,n;if("string"==typeof t.content)try{if((e=JSON.parse(t.content)).keys&&e.data){var r=e.keys;KS(e=e.data,r)}}catch(e){return new Error(G(4923,t.id,e.stack))}else{if("object"!==be(t.content))return new Error(G(4924));e=t.content}if(null==e)return new Error(G(4923,t.id));var a=KT(e);n=a?cc._MissingScript.safeFindClass:function(e){var t=Ke(e);return t||(cc.warnID(4903,e),Object)};var s,o=cc.deserialize.Details.pool.get();try{s=cc.deserialize(e,o,{classFinder:n,target:t.existingAsset,customEnv:t})}catch(e){return cc.deserialize.Details.pool.put(o),console.error(e),new Error("Failed to load asset ".concat(t.id,", exception occurs during deserialization: ").concat(e.stack,"."))}s._uuid=t.uuid;var l=function(e,t,i){var n=t.deferredLoadRaw;return n?e instanceof cc.Asset&&e.constructor.preventDeferredLoadDependents&&(n=!1):i&&(e instanceof cc.SceneAsset||e instanceof cc.Prefab)&&(n=e.asyncLoadAssets),n}(s,t,a),u=function(e,t,i,n){var r,a,s,o=i.uuidList,l=i.uuidObjList,u=i.uuidPropList,c=i._stillUseUrl,h=e.dependKeys=[];if(n)for(r=[],a=0;a<o.length;a++){s=o[a];var f=l[a],d=u[a],_=cc.AssetLibrary._getAssetInfoInRuntime(s);if(_.raw){var p=_.url;f[d]=p,h.push(p)}else r.push({type:"uuid",uuid:s,deferredLoadRaw:!0,_owner:f,_ownerProp:d,_stillUseUrl:c[a]})}else{for(r=new Array(o.length),a=0;a<o.length;a++)s=o[a],r[a]={type:"uuid",uuid:s,_owner:l[a],_ownerProp:u[a],_stillUseUrl:c[a]};t._native&&!t.constructor.preventPreloadNativeObject&&r.push({url:t.nativeUrl,_owner:t,_ownerProp:"_nativeAsset"})}return r}(t,s,o,l);cc.deserialize.Details.pool.put(o);function c(t,e){if(!t&&e.onLoaded)try{e.onLoaded()}catch(e){t=e}i(t,e)}if(0===u.length)return c(null,s);!function(e,t,d,_,p){t.content=d;var v=t.dependKeys;e.flowInDeps(t,_,function(e,t){var i,n=t.map;for(var r in n)(i=n[r]).uuid&&i.content&&(i.content._uuid=i.uuid);for(var a=0;a<_.length;a++){var s=function(e){var t=e.content;this._stillUseUrl&&(t=t?t.nativeUrl:e.rawUrl),this._owner[this._ownerProp]=t,e.uuid!==d._uuid&&v.indexOf(e.id)<0&&v.push(e.id)},o=_[a],l=o.uuid,u=o.url;o._owner,o._ownerProp;if(i=n[u]){var c=o;if(i.complete||i.content){if(i.error)cc._throw(i.error);else s.call(c,i)}else{var h=PS.getQueue(i),f=h._callbackTable[l];f?f.unshift(s,c):h.addListener(l,s,c)}}}p(e,d)})}(this.pipeline,t,s,u,c)}QT.isSceneObj=KT;var ZT=null,JT="BES bswy:->@",$T={},ew=-1,tw=[],iw=6e4;function nw(){for(var e=!0,t=Date.now(),i=tw.length-1;0<=i;i--){var n=tw[i],r=n.fontFamilyName;if(t-n.startTime>iw)cc.warnID(4933,r),n.callback(null,r),tw.splice(i,1);else{var a=n.refWidth;ZT.font="40px "+r,a!==Qs(ZT,JT)?(tw.splice(i,1),n.callback(null,r)):e=!1}}e&&(clearInterval(ew),ew=-1)}function rw(e,t){var i=e.url,n=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var i,n=e.lastIndexOf("/");i=-1===n?e.substring(0,t)+"_LABEL":e.substring(n+1,t)+"_LABEL";-1!==i.indexOf(" ")&&(i='"'+i+'"');return i}(i);if($T[n])return n;if(!ZT){var r=document.createElement("canvas");r.width=100,r.height=100,ZT=r.getContext("2d")}var a="40px "+n;ZT.font=a;var s=Qs(ZT,JT),o=document.createElement("style");o.type="text/css";var l="";isNaN(n-0)?l+="@font-face { font-family:"+n+"; src:":l+="@font-face { font-family:'"+n+"'; src:",l+="url('"+i+"');",o.textContent=l+"}",document.body.appendChild(o);var u=document.createElement("div"),c=u.style;c.fontFamily=n,u.innerHTML=".",c.position="absolute",c.left="-100px",c.top="-100px",document.body.appendChild(u);var h={fontFamilyName:n,refWidth:s,callback:t,startTime:Date.now()};tw.push(h),$T[n]=o,-1===ew&&(ew=setInterval(nw,100))}function aw(t){if("string"!=typeof t.content)return new Error("JSON Loader: Input item doesn't contain string content");try{return JSON.parse(t.content)}catch(e){return new Error("JSON Loader: Parse json ["+t.id+"] failed : "+e)}}function sw(e){if(e._owner instanceof cc.Asset)return null;var t=e.content;if(!(t instanceof Image))return new Error("Image Loader: Input item doesn't contain Image content");var i=e.rawUrl,n=e.imageAsset||new sh;return n._uuid=e.uuid,n._url=i,n._setRawAsset(i,!1),n._nativeAsset=t,n}function ow(e,t){if(e._owner instanceof cc.Asset)return null;var i=new cc.AudioClip;return i._setRawAsset(e.rawUrl,!1),i._nativeAsset=e.content,i}function lw(e){return e.load?e.load(e.content):e.content}function uw(e,t){return e[t]<<8|e[t+1]}var cw={png:sw,jpg:sw,bmp:sw,jpeg:sw,gif:sw,ico:sw,tiff:sw,webp:sw,image:sw,pvr:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Int32Array(t,0,13);if(55727696===i[0]){var n=i[7],r=i[6],a=i[12]+52;return t=t.slice(a,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:n,height:r}}if(559044176!==i[11])return new Error("Invalid magic number in PVR header");var s=i[0],o=i[1],l=i[2];return t=t.slice(s,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:l,height:o}},pkm:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Uint8Array(t),n=uw(i,6);if(0!==n&&1!==n&&3!==n)return new Error("Invalid magic number in ETC header");var r=uw(i,12),a=uw(i,14);return uw(i,8),uw(i,10),t=t.slice(16,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:r,height:a}},mp3:ow,ogg:ow,wav:ow,m4a:ow,json:aw,ExportJson:aw,plist:function(e){if("string"!=typeof e.content)return new Error("Plist Loader: Input item doesn't contain string content");var t=YT.parse(e.content);return t||new Error("Plist Loader: Parse ["+e.id+"] failed")},uuid:QT,prefab:QT,fire:QT,scene:QT,binary:lw,bin:lw,font:rw,eot:rw,ttf:rw,woff:rw,svg:rw,ttc:rw,default:function(){return null}},hw=m4("Loader",function(){function t(e){y(this,t),this.id="Loader",this.async=!0,this.pipeline=null,this.extMap=void 0,this.extMap=Ne(e,cw)}return l(t,[{key:"addHandlers",value:function(e){this.extMap=Ne(this.extMap,e)}},{key:"handle",value:function(e,t){return(this.extMap[e.type]||this.extMap.default).call(this,e,t)}}]),t}());hw.ID="Loader",DS.Loader=hw;var fw=Object.create(null);function dw(){return window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")}fw.assets=new CS,fw.internal=new CS;var _w={url:null,raw:!1};function pw(e){var t,i,n;if("object"===be(e)){if((i=e).url)return i;t=e.uuid}else i={},t=e;return n=i.type?"uuid"===i.type:cc.AssetLibrary._uuidInSettings(t),cc.AssetLibrary._getAssetInfoInRuntime(t,_w),i.url=n?_w.url:t,_w.url&&"uuid"===i.type&&_w.raw?(i.type=null,i.isRawAsset=!0):n||(i.isRawAsset=!0),i}var vw=[],mw=[],yw=function(){function r(){var e;y(this,r);var t=new DT,i=new jT,n=new hw;return(e=x(this,g(r).call(this,[t,i,n]))).getXMLHttpRequest=void 0,e.assetLoader=void 0,e.md5Pipe=void 0,e.downloader=void 0,e.loader=void 0,e.onProgress=void 0,e._assetTables=void 0,e._autoReleaseSetting=void 0,e._releasedAssetChecker_DEBUG=void 0,e.getXMLHttpRequest=dw,e.assetLoader=t,e.md5Pipe=null,e.downloader=i,e.loader=n,e.onProgress=null,e._assetTables=fw,e._autoReleaseSetting=ke(!0),e}return _(r,DS),l(r,[{key:"init",value:function(e){}},{key:"addDownloadHandlers",value:function(e){this.downloader.addHandlers(e)}},{key:"addLoadHandlers",value:function(e){this.loader.addHandlers(e)}},{key:"load",value:function(e,t,n){void 0===n&&(n=t,t=this.onProgress||null);var r,a=this,s=!1;e instanceof Array||(e=e?(s=!0,[e]):[]);for(var i=vw.length=0;i<e.length;++i){var o=e[i];if(o&&o.id&&(cc.warnID(4920,o.id),o.uuid||o.url||(o.url=o.id)),(r=pw(o)).url||r.uuid){var l=this._cache[r.url];vw.push(l||r)}}var u=PS.create(this,t,function(t,i){ht(function(){if(n){if(s){var e=r.url;n.call(a,i.getError(e),i.getContent(e))}else n.call(a,t,i);n=null}i.destroy()})});PS.initQueueDeps(u),u.append(vw),vw.length=0}},{key:"flowInDeps",value:function(i,e,n){for(var t=mw.length=0;t<e.length;++t){var r=pw(e[t]);if(r.url||r.uuid){var a=this._cache[r.url];a?mw.push(a):mw.push(r)}}var s=PS.create(this,i?function(e,t,i){s._ownerQueue&&s._ownerQueue.onProgress&&s._ownerQueue._childOnProgress(i)}:null,function(e,t){n(e,t),i&&i.deps&&(i.deps.length=0),t.destroy()});if(i){var o=PS.getQueue(i);s._ownerQueue=o._ownerQueue||o}var l=s.append(mw,i);return mw.length=0,l}},{key:"loadRes",value:function(e,t,i,n,r){5!==arguments.length&&(r=n,n=i,i="assets");var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;var s=this,o=s._getResUuid(e,t,i,!0);o?this.load({type:"uuid",uuid:o},n,function(e,t){t&&s.setAutoReleaseRecursively(o,!1),r&&r(e,t)}):s._urlNotFound(e,t,r)}},{key:"loadResDir",value:function(e,t,i,n,l){if(5!==arguments.length&&(l=n,n=i,i="assets"),fw[i]){var r=this._parseLoadResArgs(t,n,l);t=r.type,n=r.onProgress,l=r.onComplete;var a=[],s=fw[i].getUuidArray(e,t,a);this._loadResUuids(s,n,function(e,t,i){for(var n=t.length,r=0;r<n;++r)if(t[r]instanceof cc.SpriteAtlas){var a=t[r].getSpriteFrames();for(var s in a){var o=a[s];t.push(o),i&&i.push("".concat(i[r],"/").concat(o.name))}}l&&l(e,t,i)},a)}}},{key:"loadResArray",value:function(e,t,i,n,r){5!==arguments.length&&(r=n,n=i,i="assets");var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;for(var s=[],o=0;o<e.length;o++){var l=e[o],u=this._getResUuid(l,t,i,!0);if(!u)return void this._urlNotFound(l,t,r);s.push(u)}this._loadResUuids(s,n,r)}},{key:"getRes",value:function(e,t){var i=this._cache[e];if(!i){var n=this._getResUuid(e,t,null,!0);if(!n)return null;var r=this._getReferenceKey(n);i=this._cache[r]}return i&&i.alias&&(i=i.alias),i&&i.complete?i.content:null}},{key:"getResCount",value:function(){return Object.keys(this._cache).length}},{key:"getDependsRecursively",value:function(e){if(e){var t=this._getReferenceKey(e),i=_v(t);return i.push(t),i}return[]}},{key:"release",value:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t];this.release(i)}else if(e){var n=this._getReferenceKey(e),r=this.getItem(n);if(r){this.removeItem(n);if((e=r.content)instanceof cc.Asset){var a=e.nativeUrl;a&&this.release(a),e.destroy()}0}}}},{key:"releaseAsset",value:function(e){var t=e._uuid;t&&this.release(t)}},{key:"releaseRes",value:function(e,t,i){var n=this._getResUuid(e,t,i,!0);n?this.release(n):cc.errorID(4914,e)}},{key:"releaseResDir",value:function(e,t,i){if(fw[i=i||"assets"])for(var n=fw[i].getUuidArray(e,t),r=0;r<n.length;r++){var a=n[r];this.release(a)}}},{key:"releaseAll",value:function(){for(var e in this._cache)this.release(e)}},{key:"removeItem",value:function(e){var t=DS.prototype.removeItem.call(this,e);return delete this._autoReleaseSetting[e],t}},{key:"setAutoRelease",value:function(e,t){var i=this._getReferenceKey(e);i&&(this._autoReleaseSetting[i]=!!t)}},{key:"setAutoReleaseRecursively",value:function(e,t){t=!!t;var i=this._getReferenceKey(e);if(i){this._autoReleaseSetting[i]=t;for(var n=_v(i),r=0;r<n.length;r++){var a=n[r];this._autoReleaseSetting[a]=t}}else 0}},{key:"isAutoRelease",value:function(e){var t=this._getReferenceKey(e);return!!t&&!!this._autoReleaseSetting[t]}},{key:"_getResUuid",value:function(e,t,i,n){var r="",a=fw[i=i||"assets"];if(e&&a){var s=e.indexOf("?");if(-1!==s&&(e=e.substr(0,s)),!(r=a.getUuid(e,t))){var o=cc.path.extname(e);o&&(e=e.slice(0,-o.length),(r=a.getUuid(e,t))&&!n&&cc.warnID(4901,e,o))}}return!r&&t&&(Ge(t,Jh)||Ge(t,Hh)||Ge(t,$h))&&cc.warnID(4934),r}},{key:"_getReferenceKey",value:function(e){var t;return"object"===be(e)?t=e._uuid||null:"string"==typeof e&&(t=this._getResUuid(e,null,null,!0)||e),t?(cc.AssetLibrary._getAssetInfoInRuntime(t,_w),this._cache[_w.url]?_w.url:t):(cc.warnID(4800,e),t)}},{key:"_urlNotFound",value:function(t,i,n){ht(function(){t=cc.url.normalize(t);var e="".concat(i?Re(i):"Asset",' in "resources/').concat(t,'" does not exist.');n&&n(new Error(e),[])})}},{key:"_parseLoadResArgs",value:function(e,t,i){if(void 0===i){var n=Ge(e,cc.RawAsset);t?(i=t,n&&(t=this.onProgress||null)):void 0!==t||n||(i=e,t=this.onProgress||null,e=null),void 0===t||n||(t=e,e=null)}return{type:e,onProgress:t,onComplete:i}}},{key:"_loadResUuids",value:function(e,t,l,u){if(0<e.length){var c=this,h=e.map(function(e){return{type:"uuid",uuid:e}});this.load(h,t,function(e,t){if(l){for(var i=[],n=u&&[],r=0;r<h.length;++r){var a=h[r].uuid,s=c._getReferenceKey(a),o=t.getContent(s);o&&(c.setAutoReleaseRecursively(a,!1),i.push(o),n&&n.push(u[r]))}u?l(e,i,n):l(e,i)}})}else l&&ht(function(){u?l(null,[],[]):l(null,[])})}}]),r}(),gw=m4("loader",cc.loader=new yw);var bw,xw,Sw,Tw,ww,Ew,Aw,Cw=Object.freeze({loadImage:function(e,i,n){V(!!e,3103);var r=gw.getRes(e);return r?r.loaded?i&&i.call(n,null,r):r.once("load",function(){i&&i.call(n,null,r)},n):(r=new sh,gw.load({url:e,imageAsset:r},function(e,t){if(e)return i&&i.call(n,e||new Error("Unknown error")),r;i&&i.call(n,null,t)})),r},cacheImage:function(e,t){if(e&&t){var i=new sh(t),n={id:e,url:e,error:null,content:i,complete:!1};return gw.flowOut(n),i}},postLoadImage:function(i,n){i.loaded?n&&n():i.nativeUrl?gw.load({url:i.nativeUrl,skips:i.isCompressed?void 0:["Loader"]},function(e,t){t&&(i.loaded||(i._nativeAsset=t)),n&&n(e)}):n&&n()}});m4("textureUtil",Cw);var kw,Rw,Ow,Mw,Iw,Bw,Lw,Pw,Fw,zw=m4("Skeleton",(bw=fo("cc.Skeleton"),xw=_o([Ot]),Sw=_o([Pn]),bw((Ew=m((ww=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_joints",Ew,c(t)),v(t,"_bindposes",Aw,c(t)),t._bindTRS=[],t._hash=0,t}return _(a,nh),l(a,[{key:"onLoaded",value:function(){this.bindposes=this._bindposes}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e,this._bindTRS=e.map(function(e){var t=new Ni,i=new fn,n=new Ni;return Pn.toRTS(e,i,t,n),{position:t,rotation:i,scale:n}}),this._hash=Mc(this.bindposes.reduce(function(e,t){return e+t.m00.toPrecision(2)+" "+t.m01.toPrecision(2)+" "+t.m02.toPrecision(2)+" "+t.m03.toPrecision(2)+" "+t.m04.toPrecision(2)+" "+t.m05.toPrecision(2)+" "+t.m06.toPrecision(2)+" "+t.m07.toPrecision(2)+" "+t.m08.toPrecision(2)+" "+t.m09.toPrecision(2)+" "+t.m10.toPrecision(2)+" "+t.m11.toPrecision(2)+" "+t.m12.toPrecision(2)+" "+t.m13.toPrecision(2)+" "+t.m14.toPrecision(2)+" "+t.m15.toPrecision(2)+"\n"},""),666)}},{key:"bindTRS",get:function(){return this._bindTRS}},{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"hash",get:function(){return this._hash}}]),a}()).prototype,"_joints",[xw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Aw=m(ww.prototype,"_bindposes",[Sw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Tw=ww))||Tw));cc.Skeleton=zw,cc.textureUtil=Cw;var Dw,Nw,Uw,Vw,Gw,Hw,Ww,qw,jw,Xw,Yw,Kw,Qw,Zw=m4("EventHandler",(kw=fo("cc.ClickEvent"),Rw=_o(cc.Node),kw((m((Mw=function(){function o(){y(this,o),v(this,"target",Iw,this),v(this,"component",Bw,this),v(this,"_componentId",Lw,this),v(this,"handler",Pw,this),v(this,"customEventData",Fw,this)}return l(o,[{key:"emit",value:function(e){var t=this.target;if(cc.isValid(t)){this._genCompIdIfNeeded();var i=cc.js._getClassById(this._componentId),n=t.getComponent(i);if(cc.isValid(n)){var r=n[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(n,e))}}}},{key:"_compName2Id",value:function(e){var t=cc.js.getClassByName(e);return cc.js._getClassId(t)}},{key:"_compId2Name",value:function(e){var t=cc.js._getClassById(e);return cc.js.getClassName(t)}},{key:"_genCompIdIfNeeded",value:function(){this._componentId||(this._componentName=this.component,this.component="")}},{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}],[{key:"emitEvents",value:function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=e.length;r<a;r++){var s=e[r];s instanceof o&&s.emit(i)}}}]),o}()).prototype,"_componentName",[_o],Object.getOwnPropertyDescriptor(Mw.prototype,"_componentName"),Mw.prototype),Iw=m(Mw.prototype,"target",[Rw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bw=m(Mw.prototype,"component",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Lw=m(Mw.prototype,"_componentId",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Pw=m(Mw.prototype,"handler",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Fw=m(Mw.prototype,"customEventData",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ow=Mw))||Ow));cc.Component.EventHandler=Zw;var Jw,$w=(Dw=fo("cc.MissingClass"),Nw=_o({visible:!1,editorOnly:!0}),Dw((Gw=m((Vw=function e(){y(this,e),v(this,"_$erialized",Gw,this)}).prototype,"_$erialized",[Nw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Uw=Vw))||Uw),eE=m4("MissingScript",(Hw=fo("cc.MissingScript"),Ww=To("packages://inspector/inspectors/comps/missing-script.js"),qw=_o({serializable:!1}),jw=_o({visible:!1,editorOnly:!0}),Hw(Xw=Ww((Kw=m((Yw=function(){function n(){var e;return y(this,n),v(e=x(this,g(n).call(this)),"compiled",Kw,c(e)),v(e,"_$erialized",Qw,c(e)),e}return _(n,Tm),l(n,null,[{key:"safeFindClass",value:function(e,t){var i=Ke(e);return i||(e?(cc.deserialize.reportMissingClass(e),n.getMissingWrapper(e,t)):null)}},{key:"getMissingWrapper",value:function(e,t){return t.node&&(/^[0-9a-zA-Z+/]{23}$/.test(e)||tt.test(e))?n:$w}}]),l(n,[{key:"onLoad",value:function(){cc.warnID(4600,this.node.name)}}]),n}()).prototype,"compiled",[qw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qw=m(Yw.prototype,"_$erialized",[jw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xw=Yw))||Xw)||Xw));cc._MissingScript=eE;var tE=[Gp.TOUCH_START,Gp.TOUCH_END,Gp.TOUCH_MOVE,Gp.MOUSE_DOWN,Gp.MOUSE_MOVE,Gp.MOUSE_UP,Gp.MOUSE_ENTER,Gp.MOUSE_LEAVE,Gp.MOUSE_WHEEL];function iE(e){e.propagationStopped=!0}var nE,rE,aE,sE,oE,lE,uE,cE,hE,fE,dE,_E=m4("BlockInputEventsComponent",fo("cc.BlockInputEventsComponent")(Jw=go("Components/BlockInputEvents")(Jw=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return _(e,Tm),l(e,[{key:"onEnable",value:function(){for(var e=0;e<tE.length;e++)this.node.on(tE[e],iE,this)}},{key:"onDisable",value:function(){for(var e=0;e<tE.length;e++)this.node.off(tE[e],iE,this)}}]),e}())||Jw)||Jw);cc.BlockInputEventsComponent=_E;var pE,vE,mE,yE,gE,bE,xE,SE,TE,wE,EE,AE,CE,kE,RE,OE,ME,IE,BE,LE,PE,FE,zE,DE,NE,UE=new Ii,VE=new Ii,GE=new Pn,HE=new Pn,WE=new Pn,qE=m4("UITransformComponent",(nE=fo("cc.UITransformComponent"),rE=bo(110),aE=go("UI/UITransform"),sE=_o({displayOrder:0}),oE=_o({displayOrder:1}),nE(lE=rE(lE=aE(lE=mo((dE=fE=function(){function h(){var e,t;y(this,h);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(h)).call.apply(e,[this].concat(n))),"_contentSize",cE,c(t)),v(t,"_anchorPoint",hE,c(t)),t}return _(h,Tm),l(h,[{key:"__preload",value:function(){this.node.uiTransfromComp=this}},{key:"onDestroy",value:function(){this.node.uiTransfromComp=null}},{key:"setContentSize",value:function(e,t){var i=this._contentSize;if(void 0===t){if((e=e).width===i.width&&e.height===i.height)return;0,i.width=e.width,i.height=e.height}else{if(e===i.width&&t===i.height)return;0,i.width=e,i.height=t}this.node.emit(Gp.SIZE_CHANGED)}},{key:"setAnchorPoint",value:function(e,t){var i=this._anchorPoint;if(void 0===t){if((e=e).x===i.x&&e.y===i.y)return;i.x=e.x,i.y=e.y}else{if(e===i.x&&t===i.y)return;i.x=e,i.y=t}this.node.emit(Gp.ANCHOR_CHANGED,this._anchorPoint)}},{key:"isHit",value:function(e,t){var i=this._contentSize.width,n=this._contentSize.height,r=UE,a=VE,s=-1,o=this.node.getComponent(cc.UIRenderComponent);s=o?o.visibility:this._getVisibility();var l=kx.root.ui.getScreen(s);if(l){l.node.getWorldRT(GE);var u=GE.m12,c=GE.m13,h=cc.visibleRect.center;if(GE.m12=h.x-(GE.m00*u+GE.m04*c),GE.m13=h.y-(GE.m01*u+GE.m05*c),Pn.invert(GE,GE),Ii.transformMat4(r,e,GE),this.node.getWorldMatrix(WE),Pn.invert(GE,WE),Ii.transformMat4(a,r,GE),a.x+=this._anchorPoint.x*i,a.y+=this._anchorPoint.y*n,0<=a.x&&0<=a.y&&a.x<=i&&a.y<=n){if(t&&t.mask){for(var f=t.mask,d=this.node,_=0;d&&_<f.index;++_,d=d.parent);if(d!==f.node)return!(t.mask=null);var p=d.getComponent(cc.MaskComponent);return!p||!p.enabledInHierarchy||p.isHit(r)}return!0}return!1}}},{key:"convertToNodeSpaceAR",value:function(e,t){return this.node.getWorldMatrix(WE),Pn.invert(GE,WE),t=t||new Ni,Ni.transformMat4(t,e,GE)}},{key:"convertToWorldSpaceAR",value:function(e,t){return this.node.getWorldMatrix(WE),t=t||new Ni,Ni.transformMat4(t,e,WE)}},{key:"getBoundingBox",value:function(){Pn.fromRTS(HE,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,i=new Jn(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return i.transformMat4(HE),i}},{key:"getBoundingBoxToWorld",value:function(){return this.node.parent?(this.node.parent.getWorldMatrix(WE),this.getBoundingBoxTo(WE)):this.getBoundingBox()}},{key:"getBoundingBoxTo",value:function(e){Pn.fromRTS(HE,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var t=this._contentSize.width,i=this._contentSize.height,n=new Jn(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i);if(Pn.multiply(WE,e,HE),n.transformMat4(WE),!this.node.children)return n;var r=this.node.children,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;if(l&&l.active){var u=l.getComponent(h);if(u){var c=u.getBoundingBoxTo(e);c&&Jn.union(n,n,c)}}}return n}},{key:"getComputeAABB",value:function(e){var t=this.getBoundingBoxToWorld(),i=t.center.x,n=t.center.y,r=this.node.worldPosition.z,a=t.width/2,s=t.height/2;if(null==e)return new cs(i,n,r,a,s,.01);cs.set(e,i,n,r,a,s,.01)}},{key:"_getVisibility",value:function(){for(var e=-1,t=this.node;t;){if(t){var i=t.getComponent("cc.CanvasComponent");if(i){e=i.visibility;break}}t=t.parent}return e}},{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(Gp.SIZE_CHANGED))}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(Gp.SIZE_CHANGED))}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(Gp.SIZE_CHANGED))}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(Gp.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(Gp.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(Gp.ANCHOR_CHANGED,this._anchorPoint))}}]),h}(),fE.EventType=Gp,m((uE=dE).prototype,"contentSize",[sE],Object.getOwnPropertyDescriptor(uE.prototype,"contentSize"),uE.prototype),m(uE.prototype,"anchorPoint",[oE],Object.getOwnPropertyDescriptor(uE.prototype,"anchorPoint"),uE.prototype),cE=m(uE.prototype,"_contentSize",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jn(100,100)}}),hE=m(uE.prototype,"_anchorPoint",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii(.5,.5)}}),lE=uE))||lE)||lE)||lE)||lE));cc.UITransformComponent=qE;var jE,XE,YE,KE,QE,ZE,JE,$E,eA,tA,iA,nA,rA,aA,sA,oA,lA,uA,cA,hA,fA=vt({ORTHO:0,PERSPECTIVE:1}),dA=vt({SKYBOX:Dv|dc.DEPTH_STENCIL,SOLID_COLOR:dc.ALL,DEPTH_ONLY:dc.DEPTH_STENCIL,DONT_CLEAR:dc.NONE}),_A=m4("CameraComponent",(pE=fo("cc.CameraComponent"),vE=go("Components/Camera"),mE=_o({type:fA}),yE=_o({type:dA}),gE=_o({visible:!1}),bE=_o({type:yf.BitMask}),xE=_o({type:Bh}),pE(SE=vE(SE=mo((NE=DE=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_projection",wE,c(t)),v(t,"_priority",EE,c(t)),v(t,"_fov",AE,c(t)),v(t,"_orthoHeight",CE,c(t)),v(t,"_near",kE,c(t)),v(t,"_far",RE,c(t)),v(t,"_color",OE,c(t)),v(t,"_depth",ME,c(t)),v(t,"_stencil",IE,c(t)),v(t,"_clearFlags",BE,c(t)),v(t,"_rect",LE,c(t)),v(t,"_screenScale",PE,c(t)),v(t,"_visibility",FE,c(t)),v(t,"_targetTexture",zE,c(t)),t._camera=null,t._inEditorMode=!1,t}return _(a,Tm),l(a,[{key:"onLoad",value:function(){cc.director.on(cc.Director.EVENT_AFTER_SCENE_LAUNCH,this.onSceneChanged,this)}},{key:"onEnable",value:function(){this._camera||this._createCamera(),this._camera.enabled=!0}},{key:"onDisable",value:function(){this._camera&&(this._camera.enabled=!1)}},{key:"onDestroy",value:function(){this._camera&&(this._getRenderScene().destroyCamera(this._camera),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}},{key:"screenPointToRay",value:function(e,t,i){return i=i||$a.create(),this._camera&&this._camera.screenPointToRay(i,e,t),i}},{key:"worldToScreen",value:function(e,t){return t=t||new Ni,this._camera&&this._camera.worldToScreen(t,e),t}},{key:"screenToWorld",value:function(e,t){return t=t||this.node.getWorldPosition(),this._camera&&this._camera.screenToWorld(t,e),t}},{key:"_createCamera",value:function(){var t=this;if(this.node.scene){var e=this._getRenderScene();if(!this._camera||!e.cameras.find(function(e){return e===t._camera})){if(this._camera=e.createCamera({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?cc.director.root&&cc.director.root.mainWindow:cc.director.root&&cc.director.root.tempWindow,priority:this._priority}),this._camera){this._camera.viewport=this._rect,this._camera.fov=yi(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far;var i=this._color.x,n=this._color.y,r=this._color.z,a=this._color.w;this._camera.clearColor={r:i,g:n,b:r,a:a},this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility}this._updateTargetTexture()}}}},{key:"onSceneChanged",value:function(e){this._camera&&this._camera.scene!==e.renderScene&&(this._createCamera(),this._camera.enabled=!0)}},{key:"_chechTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)},this)}},{key:"_updateTargetTexture",value:function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=yi(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor.r=e.x,this._camera.clearColor.g=e.y,this._camera.clearColor.b=e.z,this._camera.clearColor.a=e.w)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"stencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&(this._camera.viewport=e)}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._chechTargetTextureEvent(t),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0)}}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?cc.director.root&&cc.director.root.mainWindow:cc.director.root&&cc.director.root.tempWindow)}}]),a}(),DE.ProjectionType=fA,DE.CameraClearFlag=dA,wE=m((TE=NE).prototype,"_projection",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fA.PERSPECTIVE}}),EE=m(TE.prototype,"_priority",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),AE=m(TE.prototype,"_fov",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),CE=m(TE.prototype,"_orthoHeight",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),kE=m(TE.prototype,"_near",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),RE=m(TE.prototype,"_far",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),OE=m(TE.prototype,"_color",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ar("#334C78")}}),ME=m(TE.prototype,"_depth",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),IE=m(TE.prototype,"_stencil",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BE=m(TE.prototype,"_clearFlags",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dA.SOLID_COLOR}}),LE=m(TE.prototype,"_rect",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Jn(0,0,1,1)}}),PE=m(TE.prototype,"_screenScale",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),FE=m(TE.prototype,"_visibility",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pf}}),zE=m(TE.prototype,"_targetTexture",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m(TE.prototype,"projection",[mE],Object.getOwnPropertyDescriptor(TE.prototype,"projection"),TE.prototype),m(TE.prototype,"priority",[_o],Object.getOwnPropertyDescriptor(TE.prototype,"priority"),TE.prototype),m(TE.prototype,"fov",[_o],Object.getOwnPropertyDescriptor(TE.prototype,"fov"),TE.prototype),m(TE.prototype,"orthoHeight",[_o],Object.getOwnPropertyDescriptor(TE.prototype,"orthoHeight"),TE.prototype),m(TE.prototype,"near",[_o],Object.getOwnPropertyDescriptor(TE.prototype,"near"),TE.prototype),m(TE.prototype,"far",[_o],Object.getOwnPropertyDescriptor(TE.prototype,"far"),TE.prototype),m(TE.prototype,"color",[_o],Object.getOwnPropertyDescriptor(TE.prototype,"color"),TE.prototype),m(TE.prototype,"depth",[_o],Object.getOwnPropertyDescriptor(TE.prototype,"depth"),TE.prototype),m(TE.prototype,"stencil",[_o],Object.getOwnPropertyDescriptor(TE.prototype,"stencil"),TE.prototype),m(TE.prototype,"clearFlags",[yE],Object.getOwnPropertyDescriptor(TE.prototype,"clearFlags"),TE.prototype),m(TE.prototype,"rect",[_o],Object.getOwnPropertyDescriptor(TE.prototype,"rect"),TE.prototype),m(TE.prototype,"screenScale",[gE],Object.getOwnPropertyDescriptor(TE.prototype,"screenScale"),TE.prototype),m(TE.prototype,"visibility",[bE],Object.getOwnPropertyDescriptor(TE.prototype,"visibility"),TE.prototype),m(TE.prototype,"targetTexture",[xE],Object.getOwnPropertyDescriptor(TE.prototype,"targetTexture"),TE.prototype),SE=TE))||SE)||SE)||SE)),pA=new Ni,vA=vt({SOLID_COLOR:dc.ALL,DEPTH_STENCIL:dc.DEPTH_STENCIL,NONE:dc.NONE}),mA=vt({OVERLAY:0,INTERSPERSE:1}),yA=m4("CanvasComponent",(jE=fo("cc.CanvasComponent"),XE=bo(100),YE=yo(qE),KE=go("UI/Canvas"),QE=_o({type:vA}),ZE=_o({type:mA}),JE=_o(),$E=_o({type:Bh}),eA=_o({type:vA}),tA=_o({type:mA}),jE(iA=XE(iA=YE(iA=KE(iA=mo(iA=xo((m((nA=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"_priority",rA,c(e)),v(e,"_targetTexture",aA,c(e)),v(e,"_clearFlag",sA,c(e)),v(e,"_color",oA,c(e)),v(e,"_renderMode",lA,c(e)),e._thisOnResized=void 0,e._camera=null,e._pos=new Ni,e._thisOnResized=e.alignWithScreen.bind(c(e)),e}return _(t,Tm),l(t,[{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e,this._camera&&(this._camera.clearFlag=this._clearFlag)}},{key:"color",get:function(){return this._color},set:function(e){ar.copy(this._color,e),this._camera&&(this._camera.clearColor.r=e.r/255,this._camera.clearColor.g=e.g/255,this._camera.clearColor.b=e.b/255,this._camera.clearColor.a=e.a/255)}},{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._camera&&(this._camera.priority=this._getViewPriority())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=this._getViewPriority())}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._chechTargetTextureEvent(t),this._updateTargetTexture()}}},{key:"visibility",get:function(){return this._camera?this._camera.view.visibility:-1}},{key:"camera",get:function(){return this._camera}}]),l(t,[{key:"__preload",value:function(){var e=new cy("UICamera_"+this.node.name);e.setPosition(0,0,1e3),this._camera=kx.root.ui.renderScene.createCamera({name:"ui_"+this.node.name,node:e,projection:_A.ProjectionType.ORTHO,priority:this._getViewPriority(),flows:["UIFlow"]}),this._camera.fov=45,this._camera.clearFlag=this.clearFlag,this._camera.farClip=2e3,this.color=this._color;var t=kx.root.device;if(this._camera.resize(t.width,t.height),this._targetTexture){var i=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(i),this._camera.setFixedSize(i.width,i.height)}Tp.on("design-resolution-changed",this._thisOnResized),this.alignWithScreen(),kx.root.ui.addScreen(this)}},{key:"onDestroy",value:function(){this._camera&&kx.root.ui.renderScene.destroyCamera(this._camera),this._targetTexture&&this._targetTexture.off("resize"),Tp.off("design-resolution-changed",this._thisOnResized),kx.root.ui.removeScreen(this)}},{key:"alignWithScreen",value:function(){var e,t;this.node.getPosition(this._pos);var i=ql;e=i,t=Tp.getDesignResolutionSize();var n=0,r=0;if(Tp.getResolutionPolicy()===Sp.NO_BORDER&&(n=.5*(t.width-i.width),r=.5*(t.height-i.height)),Ni.set(pA,.5*i.width+n,.5*i.height+r,0),this._pos.equals(pA)||this.node.setPosition(pA),this.node.width!==e.width&&(this.node.width=e.width),this.node.height!==e.height&&(this.node.height=e.height),this.node.getWorldPosition(pA),this._camera){var a=pp.canvas;this._camera.resize(a.width,a.height),this._camera.orthoHeight=pp.canvas.height/Tp.getScaleY()/2,this._camera.node.setPosition(pA.x,pA.y,1e3),this._camera.update()}}},{key:"_chechTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)},this)}},{key:"_updateTargetTexture",value:function(){if(this._camera)if(this._targetTexture){var e=this._targetTexture.getGFXWindow();this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}else this._camera.changeTargetWindow(),this._camera.isWindowSize=!0}},{key:"_getViewPriority",value:function(){return this._renderMode===mA.OVERLAY?this._priority|1<<30:this._priority}}]),t}()).prototype,"clearFlag",[QE],Object.getOwnPropertyDescriptor(nA.prototype,"clearFlag"),nA.prototype),m(nA.prototype,"color",[_o],Object.getOwnPropertyDescriptor(nA.prototype,"color"),nA.prototype),m(nA.prototype,"renderMode",[ZE],Object.getOwnPropertyDescriptor(nA.prototype,"renderMode"),nA.prototype),m(nA.prototype,"priority",[JE],Object.getOwnPropertyDescriptor(nA.prototype,"priority"),nA.prototype),m(nA.prototype,"targetTexture",[$E],Object.getOwnPropertyDescriptor(nA.prototype,"targetTexture"),nA.prototype),rA=m(nA.prototype,"_priority",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aA=m(nA.prototype,"_targetTexture",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sA=m(nA.prototype,"_clearFlag",[eA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vA.NONE}}),oA=m(nA.prototype,"_color",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ar(0,0,0,0)}}),lA=m(nA.prototype,"_renderMode",[tA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mA.OVERLAY}}),iA=nA))||iA)||iA)||iA)||iA)||iA)||iA));cc.CanvasComponent=yA;function gA(){y(this,gA),this.material=null,this.vertexCount=0,this.indiceCount=0}var bA,xA,SA,TA,wA,EA,AA,CA,kA,RA,OA,MA,IA,BA,LA,PA,FA,zA,DA,NA,UA,VA,GA,HA,WA,qA=m4("UIComponent",fo("cc.UIComponent")(uA=bo(110)(uA=xo(uA=mo((m((cA=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_priority",hA,c(t)),t._followScreen=null,t._lastParent=null,t}return _(a,Tm),l(a,[{key:"__preload",value:function(){this.node._uiComp=this}},{key:"onEnable",value:function(){this._lastParent=this.node.parent,this._updateVisibility(),this._lastParent&&this.node.on(Gp.CHILD_REMOVED,this._parentChanged,this),this._sortSiblings()}},{key:"onDisable",value:function(){this._cancelEventFromParent()}},{key:"onDestroy",value:function(){this.node._uiComp===this&&(this.node._uiComp=null)}},{key:"updateAssembler",value:function(e){}},{key:"postUpdateAssembler",value:function(e){}},{key:"_setScreen",value:function(e){this._followScreen=e}},{key:"_parentChanged",value:function(e){return e===this.node&&(this._updateVisibility(),this._cancelEventFromParent(),this._lastParent=this.node.parent,this._sortSiblings(),!0)}},{key:"_sortSiblings",value:function(){var e=this.node.parent&&this.node.parent.children;e&&e.sort(function(e,t){var i=e._uiComp,n=t._uiComp;return(i?i.priority:0)-(n?n.priority:0)})}},{key:"_updateVisibility",value:function(){for(var e=this.node;e;){if(e){var t=e.getComponent(yA);if(t){this._followScreen=t;break}}e=e.parent}}},{key:"_cancelEventFromParent",value:function(){this._lastParent&&(this._lastParent.off(Gp.CHILD_REMOVED,this._parentChanged,this),this._lastParent=null),this._followScreen=null}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this._priority=e,this._sortSiblings())}},{key:"visibility",get:function(){return this._screen?this._screen.visibility:-1}},{key:"_screen",get:function(){return this._followScreen}}]),a}()).prototype,"priority",[_o],Object.getOwnPropertyDescriptor(cA.prototype,"priority"),cA.prototype),hA=m(cA.prototype,"_priority",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),uA=cA))||uA)||uA)||uA)||uA),jA=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).vData=null,t.uvDirty=!0,t.vertDirty=!0,t._datas=[],t._indices=[],t._pivotX=0,t._pivotY=0,t._width=0,t._height=0,t}return _(a,gA),l(a,[{key:"updateSizeNPivot",value:function(e,t,i,n){e===this._width&&t===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=e,this._height=t,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)}},{key:"clear",value:function(){this._datas.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indiceCount=0}},{key:"dataLength",get:function(){return this._datas.length},set:function(e){var t=this._datas;if(t.length!==e){var i=t.length,n=0;for(n=e;n<i;n++)YA.free(t[n]);for(n=i;n<e;n++)t[n]=YA.alloc();t.length=e}}},{key:"datas",get:function(){return this._datas}}],[{key:"add",value:function(){return KA.add()}},{key:"remove",value:function(e){var t=KA.data.indexOf(e);-1!==t&&(KA.data[t].clear(),KA.removeAt(t))}}]),a}(),XA=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).vData=new Float32Array(2304*Float32Array.BYTES_PER_ELEMENT),t.iData=new Uint16Array(1536),t.vertexStart=0,t.indiceStart=0,t.byteStart=0,t.byteCount=0,t._formatByte=9*Float32Array.BYTES_PER_ELEMENT,t}return _(a,gA),l(a,[{key:"request",value:function(e,t){var i=this.byteCount+e*this._formatByte,n=this.indiceCount+t;if(65535<e+this.vertexCount)return!1;var r=this.vData.byteLength,a=this.iData.length,s=this.vData.length,o=this.iData.length;if(r<i||a<n){for(;r<i||a<n;)r=4*(s*=2),a=o*=2;var l=new Float32Array(this.vData.buffer);this.vData=new Float32Array(s),this.vData.set(l,0);var u=new Uint16Array(this.iData.buffer);this.iData=new Uint16Array(o),this.iData.set(u,0)}return this.vertexCount+=e,this.indiceCount+=t,this.byteCount=i,!0}},{key:"reset",value:function(){this.vertexCount=0,this.indiceCount=0,this.byteCount=0,this.vertexStart=0,this.indiceStart=0,this.byteStart=0}}]),a}(),YA=new Rs(function(){return{x:0,y:0,z:0,u:0,v:0,color:ar.WHITE.clone()}},128),KA=new Os(function(){return new jA},32),QA=_o,ZA=m4("RenderableComponent",(bA=fo("cc.RenderableComponent"),xA=QA({type:[F_]}),SA=QA({type:F_,displayName:"Materials"}),TA=QA({visible:!1}),bA((AA=m((EA=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"_materials",AA,c(e)),v(e,"_visFlags",CA,c(e)),e}return _(t,Tm),l(t,[{key:"getMaterial",value:function(e,t,i){var n=1<arguments.length&&void 0!==t&&t,r=2<arguments.length&&void 0!==i&&i,a=this._materials[e];if(!a)return null;var s=F_.getInstantiatedMaterial(a,this,n);return s!==this._materials[e]&&this.setMaterial(s,e,r||!n),this._materials[e]}},{key:"getSharedMaterial",value:function(e){return e<0||e>=this._materials.length?null:this._materials[e]}},{key:"setMaterial",value:function(e,t,i){var n=!(2<arguments.length&&void 0!==i)||i;this._materials[t]=e,n&&this._onMaterialModified(t,e)}},{key:"_getModel",value:function(){return null}},{key:"recreateModel",value:function(){}},{key:"_onMaterialModified",value:function(e,t){}},{key:"_onRebuildPSO",value:function(e,t){}},{key:"_clearMaterials",value:function(){}},{key:"_onVisiblityChange",value:function(e){}},{key:"sharedMaterials",get:function(){return this._materials.slice()},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var i=e.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materials[e]=this.getMaterial(e);return this._materials},set:function(e){var t=e.length-this._materials.length;if(0<t)this._materials=this._materials.concat(new Array(t).fill(null));else if(t<0){for(var i=-t;i<this._materials.length;++i)this.setMaterial(null,i);this._materials=this._materials.splice(-t)}}},{key:"material",get:function(){return this.getMaterial(0)},set:function(e){1===this._materials.length&&this._materials[0]===e||this.setMaterial(e,0)}},{key:"sharedMaterial",get:function(){return this.getSharedMaterial(0)}},{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisiblityChange(e)}}]),t}()).prototype,"_materials",[xA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CA=m(EA.prototype,"_visFlags",[QA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yf.Enum.NONE}}),m(EA.prototype,"sharedMaterials",[SA],Object.getOwnPropertyDescriptor(EA.prototype,"sharedMaterials"),EA.prototype),m(EA.prototype,"visibility",[TA],Object.getOwnPropertyDescriptor(EA.prototype,"visibility"),EA.prototype),wA=EA))||wA));mt(ku),(WA=HA=HA||m4("InstanceMaterialType",{}))[WA.ADDCOLOR=0]="ADDCOLOR",WA[WA.ADDCOLORANDTEXTURE=1]="ADDCOLORANDTEXTURE";var JA,$A,eC,tC,iC,nC,rC,aC,sC,oC,lC,uC,cC,hC=m4("UIRenderComponent",(kA=fo("cc.UIRenderComponent"),RA=bo(110),OA=yo(qE),MA=_o({type:ku,displayOrder:0}),IA=_o({type:ku,displayOrder:1}),BA=_o({displayOrder:2}),LA=_o({type:F_,displayOrder:3}),kA(PA=RA(PA=OA(PA=mo((GA=VA=function(){function s(){var e,t;y(this,s);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(s)).call.apply(e,[this].concat(n))),"_srcBlendFactor",zA,c(t)),v(t,"_dstBlendFactor",DA,c(t)),v(t,"_color",NA,c(t)),v(t,"_sharedMaterial",UA,c(t)),t._assembler=null,t._postAssembler=null,t._renderData=null,t._renderDataFlag=!0,t._renderFlag=!0,t._material=null,t._instanceMaterialType=HA.ADDCOLORANDTEXTURE,t._blendTemplate={blendState:{targets:[{blendSrc:ku.SRC_ALPHA,blendDst:ku.ONE_MINUS_SRC_ALPHA}]},depthStencilState:{},rasterizerState:{}},t._simulate=!1,t}return _(s,qA),l(s,[{key:"__preload",value:function(){p(g(s.prototype),"__preload",this).call(this),this._instanceMaterial(),this._flushAssembler&&this._flushAssembler()}},{key:"onEnable",value:function(){p(g(s.prototype),"onEnable",this).call(this),this.node.on(Gp.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(Gp.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=this._canRender()}},{key:"onDisable",value:function(){p(g(s.prototype),"onDisable",this).call(this),this.node.off(Gp.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(Gp.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1}},{key:"onDestroy",value:function(){p(g(s.prototype),"onDestroy",this).call(this),this.destroyRenderData(),this._material&&this._material.destroy(),this._updateMaterial(null),this._renderData=null}},{key:"markForUpdateRenderData",value:function(e){var t=!(0<arguments.length&&void 0!==e)||e;if(this._renderFlag=this._canRender(),t&&this._renderFlag){var i=this._renderData;i&&(i.vertDirty=!0),this._renderDataFlag=t}else t||(this._renderDataFlag=t)}},{key:"requestRenderData",value:function(){var e=jA.add();return this._renderData=e}},{key:"destroyRenderData",value:function(){this._renderData&&(jA.remove(this._renderData),this._renderData=null)}},{key:"updateAssembler",value:function(e){p(g(s.prototype),"updateAssembler",this).call(this,e),this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(e))}},{key:"postUpdateAssembler",value:function(e){p(g(s.prototype),"postUpdateAssembler",this).call(this,e),this._renderFlag&&this._postRender(e)}},{key:"_render",value:function(e){}},{key:"_postRender",value:function(e){}},{key:"_checkAndUpdateRenderData",value:function(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)}},{key:"_canRender",value:function(){return null!==this.material&&this.enabled&&(!!this._simulate||this.enabledInHierarchy)}},{key:"_postCanRender",value:function(){}},{key:"_updateColor",value:function(){this._assembler&&this._assembler.updateColor&&this._assembler.updateColor(this)}},{key:"_updateMaterial",value:function(e){this._material=e,this._updateBlendFunc()}},{key:"_updateBlendFunc",value:function(){if(this._material){var e=this._blendTemplate.blendState.targets[0];e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this._blendTemplate.depthStencilState=this._material.passes[0].depthStencilState,this._blendTemplate.rasterizerState=this._material.passes[0].rasterizerState,this._material.overridePipelineStates(this._blendTemplate,0))}}},{key:"_nodeStateChange",value:function(e){this._renderData&&this.markForUpdateRenderData();var t=this.node.children,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r.getComponent(s);a&&a.markForUpdateRenderData()}}},{key:"_instanceMaterial",value:function(){var e=null;if(this._sharedMaterial)e=F_.getInstantiatedMaterial(this._sharedMaterial,new ZA,!1);else switch(this._instanceMaterialType){case HA.ADDCOLOR:e=F_.getInstantiatedMaterial(cc.builtinResMgr.get("ui-base-material"),new ZA,!1);break;case HA.ADDCOLORANDTEXTURE:e=F_.getInstantiatedMaterial(cc.builtinResMgr.get("ui-sprite-material"),new ZA,!1)}this._updateMaterial(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}},{key:"sharedMaterial",get:function(){return this._sharedMaterial},set:function(e){this._sharedMaterial!==e&&(this._sharedMaterial=e,this._instanceMaterial&&this._instanceMaterial())}},{key:"material",get:function(){return this._material||this._instanceMaterial&&this._instanceMaterial(),this._material}},{key:"renderData",get:function(){return this._renderData}},{key:"simulate",set:function(e){this._simulate=e}}]),s}(),VA.BlendState=ku,VA.Assembler=null,VA.PostAssembler=null,m((FA=GA).prototype,"srcBlendFactor",[MA],Object.getOwnPropertyDescriptor(FA.prototype,"srcBlendFactor"),FA.prototype),m(FA.prototype,"dstBlendFactor",[IA],Object.getOwnPropertyDescriptor(FA.prototype,"dstBlendFactor"),FA.prototype),m(FA.prototype,"color",[BA],Object.getOwnPropertyDescriptor(FA.prototype,"color"),FA.prototype),m(FA.prototype,"sharedMaterial",[LA],Object.getOwnPropertyDescriptor(FA.prototype,"sharedMaterial"),FA.prototype),zA=m(FA.prototype,"_srcBlendFactor",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ku.SRC_ALPHA}}),DA=m(FA.prototype,"_dstBlendFactor",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ku.ONE_MINUS_SRC_ALPHA}}),NA=m(FA.prototype,"_color",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ar.WHITE.clone()}}),UA=m(FA.prototype,"_sharedMaterial",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PA=FA))||PA)||PA)||PA)||PA));cc.UIRenderComponent=hC,lr(qA.prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]);var fC,dC,_C,pC,vC,mC,yC,gC,bC,xC,SC,TC,wC,EC,AC,CC,kC,RC,OC,MC,IC,BC,LC,PC,FC,zC,DC,NC,UC,VC,GC,HC,WC,qC,jC,XC,YC,KC,QC,ZC,JC,$C,ek,tk,ik,nk,rk,ak,sk,ok,lk,uk,ck,hk,fk,dk,_k,pk,vk,mk,yk,gk,bk,xk,Sk,Tk,wk,Ek,Ak,Ck,kk,Rk,Ok,Mk,Ik,Bk=vt({OFF:0,ON:1}),Lk=m4("ModelComponent",(JA=fo("cc.ModelComponent"),$A=bo(100),eC=go("Components/Model"),tC=_o({type:ff}),iC=_o({type:Bk}),JA(nC=$A(nC=eC(nC=mo((cC=uC=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._model=null,v(t,"_enableDynamicBatching",aC,c(t)),v(t,"_mesh",sC,c(t)),v(t,"_shadowCastingMode",oC,c(t)),v(t,"_receiveShadows",lC,c(t)),t}return _(a,ZA),l(a,[{key:"onLoad",value:function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"onEnable",value:function(){this._model&&(this._model.inited||this._updateModels(),this._model.enabled=!0)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}},{key:"onDestroy",value:function(){this._model&&(this._model.scene.destroyModel(this._model),this._model=null)}},{key:"_getModel",value:function(){return this._model}},{key:"recreateModel",value:function(){this.isValid&&(this._model&&(this._model.destroy(),this._model.scene.destroyModel(this._model),this._model=null),this._updateModels())}},{key:"_updateModels",value:function(){if(this.enabledInHierarchy&&this._mesh&&(this._model&&this._model.inited?this._model.destroy():this._createModel(),this._model.createBoundingShape(this._mesh.minPosition,this._mesh.maxPosition),this._updateModelParams(),this._model&&(this._model.enabled=!0,this._model.isDynamicBatching=this._enableDynamicBatching,this._enableDynamicBatching))){this._mesh.hasFlatBuffers||this._mesh.createFlatBuffers();for(var e=0;e<this._model.subModels.length;++e)for(var t=this._model.subModels[e],i=0;i<t.passes.length;++i){var n=t.passes[i];n.batchedBuffer||n.createBatchedBuffer()}}}},{key:"_createModel",value:function(){if(this.node.scene){var e=this._getRenderScene();this._model=e.createModel(this._getModelConstructor(),this.node),this._model.visFlags=this.visibility}}},{key:"_getModelConstructor",value:function(){return Hf}},{key:"_updateModelParams",value:function(){if(this._mesh&&this._model){this.node.hasChangedFlags=this._model.transform.hasChangedFlags=Vm.POSITION;for(var e=this._mesh?this._mesh.subMeshCount:0,t=0;t<e;++t){var i=this.getSharedMaterial(t),n=this._mesh.renderingMesh;if(n){var r=n.getSubmesh(t);r&&this._model.initSubModel(t,r,i||this._getBuiltinMaterial())}}}}},{key:"_onMaterialModified",value:function(e,t){if(null!=this._model&&(this._onRebuildPSO(e,t||this._getBuiltinMaterial()),this._enableDynamicBatching&&t))for(var i=0;i<t.passes.length;++i){var n=t.passes[i];n.batchedBuffer||n.createBatchedBuffer()}}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.setSubModelMaterial(e,t)}},{key:"_onMeshChanged",value:function(e){}},{key:"_clearMaterials",value:function(){if(null!=this._model)for(var e=0;e<this._model.subModelNum;++e)this._onMaterialModified(e,null)}},{key:"_getBuiltinMaterial",value:function(){return t_.get("missing-material")}},{key:"_onVisiblityChange",value:function(e){this._model&&(this._model.visFlags=e)}},{key:"_updateCastShadow",value:function(){this._model&&(this._shadowCastingMode===Bk.OFF?this._model.castShadow=!1:this._shadowCastingMode===Bk.ON?this._model.castShadow=!0:console.warn("ShadowCastingMode ".concat(this._shadowCastingMode," is not supported.")))}},{key:"_updateReceiveShadow",value:function(){this.enabledInHierarchy&&this._model}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh;this._mesh=e,this._onMeshChanged(t),this._updateModels()}},{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadows",get:function(){return this._receiveShadows},set:function(e){this._receiveShadows=e,this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableDynamicBatching",set:function(e){if(this._enableDynamicBatching=e,this._mesh&&(e?this._mesh.createFlatBuffers():this._mesh.destroyFlatBuffers()),this._model)if(this._model.isDynamicBatching=e,this._model.isDynamicBatching)for(var t=0;t<this._model.subModels.length;++t)for(var i=this._model.subModels[t],n=0;n<i.passes.length;++n){var r=i.passes[n];r.batchedBuffer||r.createBatchedBuffer()}else for(var a=0;a<this._model.subModels.length;++a)for(var s=this._model.subModels[a],o=0;o<s.passes.length;++o){var l=s.passes[o];l.batchedBuffer&&l.clearBatchedBuffer()}},get:function(){return this._enableDynamicBatching}}]),a}(),uC.ShadowCastingMode=Bk,m((rC=cC).prototype,"mesh",[tC],Object.getOwnPropertyDescriptor(rC.prototype,"mesh"),rC.prototype),m(rC.prototype,"shadowCastingMode",[iC],Object.getOwnPropertyDescriptor(rC.prototype,"shadowCastingMode"),rC.prototype),m(rC.prototype,"enableDynamicBatching",[_o],Object.getOwnPropertyDescriptor(rC.prototype,"enableDynamicBatching"),rC.prototype),aC=m(rC.prototype,"_enableDynamicBatching",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sC=m(rC.prototype,"_mesh",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oC=m(rC.prototype,"_shadowCastingMode",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bk.OFF}}),lC=m(rC.prototype,"_receiveShadows",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),nC=rC))||nC)||nC)||nC)||nC)),Pk=m4("SkinningModelComponent",(fC=fo("cc.SkinningModelComponent"),dC=bo(100),_C=go("Components/SkinningModel"),pC=_o(zw),vC=_o(cy),mC=_o({type:zw}),yC=_o({type:cy}),fC(gC=dC(gC=mo(gC=_C((xC=m((bC=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_skeleton",xC,c(t)),v(t,"_skinningRoot",SC,c(t)),t}return _(a,Lk),l(a,[{key:"uploadAnimation",value:function(e){this._model&&this._model.uploadAnimation(e)}},{key:"_updateModelParams",value:function(){this._update(),p(g(a.prototype),"_updateModelParams",this).call(this)}},{key:"_onMaterialModified",value:function(e,t){var i=Ld(kx.root.device),n=this.getMaterial(e)||this._getBuiltinMaterial();n.recompileShaders({CC_USE_SKINNING:i}),p(g(a.prototype),"_onMaterialModified",this).call(this,e,n)}},{key:"_getModelConstructor",value:function(){return Kf}},{key:"_getBuiltinMaterial",value:function(){return t_.get("missing-skinning-material")}},{key:"_update",value:function(){var i=this;this._model&&this._model.bindSkeleton(this._skeleton,this._skinningRoot),this._materials.forEach(function(e,t){return e&&i._onMaterialModified(t,e)})}},{key:"skeleton",get:function(){return this._skeleton},set:function(e){this._skeleton=e,this._update()}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){this._skinningRoot=e,this._update()}},{key:"model",get:function(){return this._model}}]),a}()).prototype,"_skeleton",[pC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SC=m(bC.prototype,"_skinningRoot",[vC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m(bC.prototype,"skeleton",[mC],Object.getOwnPropertyDescriptor(bC.prototype,"skeleton"),bC.prototype),m(bC.prototype,"skinningRoot",[yC],Object.getOwnPropertyDescriptor(bC.prototype,"skinningRoot"),bC.prototype),gC=bC))||gC)||gC)||gC)||gC)),Fk={name:eu.ATTR_BATCH_ID,format:ru.R32F,isNormalized:!1},zk={name:eu.ATTR_BATCH_UV,format:ru.RG32F,isNormalized:!1},Dk=xc[Fk.format].size+xc[zk.format].size,Nk=m4("SkinningModelUnit",(TC=fo("cc.SkinningModelUnit"),wC=_o(ff),EC=_o(zw),AC=_o(F_),CC=_o({type:Pk}),TC((OC=m((RC=function(){function e(){y(this,e),v(this,"mesh",OC,this),v(this,"skeleton",MC,this),v(this,"material",IC,this),v(this,"_offset",BC,this),v(this,"_size",LC,this)}return l(e,[{key:"offset",set:function(e){Ii.copy(this._offset,e)},get:function(){return this._offset}},{key:"size",set:function(e){Ii.copy(this._size,e)},get:function(){return this._size}},{key:"copyFrom",set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getSharedMaterial(0))},get:function(){return null}}]),e}()).prototype,"mesh",[wC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),MC=m(RC.prototype,"skeleton",[EC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),IC=m(RC.prototype,"material",[AC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BC=m(RC.prototype,"_offset",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii(0,0)}}),LC=m(RC.prototype,"_size",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii(1,1)}}),m(RC.prototype,"offset",[_o],Object.getOwnPropertyDescriptor(RC.prototype,"offset"),RC.prototype),m(RC.prototype,"size",[_o],Object.getOwnPropertyDescriptor(RC.prototype,"size"),RC.prototype),m(RC.prototype,"copyFrom",[CC],Object.getOwnPropertyDescriptor(RC.prototype,"copyFrom"),RC.prototype),kC=RC))||kC)),Uk=m4("BatchedSkinningModelComponent",(PC=fo("cc.BatchedSkinningModelComponent"),FC=bo(100),zC=go("Components/BatchedSkinningModel"),DC=_o({type:[Ot]}),NC=_o({type:[Nk]}),UC=_o({override:!0,visible:!1}),VC=_o({override:!0,visible:!1}),PC(GC=FC(GC=mo(GC=zC((WC=m((HC=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"atlasSize",WC,c(t)),v(t,"batchableTextureNames",qC,c(t)),v(t,"units",jC,c(t)),t._textures={},t._batchMaterial=null,t}return _(a,Pk),l(a,[{key:"onLoad",value:function(){p(g(a.prototype),"onLoad",this).call(this),this.cook()}},{key:"onDestroy",value:function(){for(var e=0,t=Object.keys(this._textures);e<t.length;e++){var i=t[e];this._textures[i].destroy()}this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),p(g(a.prototype),"onDestroy",this).call(this)}},{key:"cook",value:function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()}},{key:"cookMaterials",value:function(){var f=this;this._batchMaterial||(this._batchMaterial=this.getSharedMaterial(0));var d=this.getMaterial(0);if(d&&this._batchMaterial&&this._batchMaterial.effectAsset){d.copy(this._batchMaterial),this.resizeAtlases();for(var t=d.effectAsset.techniques[d.technique],e=function(l){var u=t.passes[l];if(!u.properties)return"continue";for(var e=function(){var t=h[c];if(u.properties[t].type>=iu.SAMPLER1D){var i=null;f.batchableTextureNames.find(function(e){return e===t})?(i=(i=f._textures[t])||f.createTexture(t),f.cookTextures(i,t,l)):f.units.some(function(e){return i=e.material&&e.material.getProperty(t,l)}),i&&d.setProperty(t,i,l)}else{var e=[],n=f.units,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.material&&e.push(o.material.getProperty(t.slice(0,-3),l))}d.setProperty(t,e,l)}},c=0,h=Object.keys(u.properties);c<h.length;c++)e()},i=0;i<t.passes.length;i++)e(i)}else console.warn("incomplete batch material!")}},{key:"cookSkeletons",value:function(){if(this._skinningRoot){var i=new zw,n=[],e=this.units,t=Array.isArray(e),r=0;for(e=t?e:e[Symbol.iterator]();;){var a;if(t){if(r>=e.length)break;a=e[r++]}else{if((r=e.next()).done)break;a=r.value}var s=a;if(s&&s.skeleton)for(var o=s.skeleton,l=function(e){var t=o.joints[e];if(0<=i.joints.findIndex(function(e){return e===t}))return"continue";i.joints.push(t),n.push(o.bindposes[e]||new Pn)},u=0;u<o.joints.length;u++)l(u)}var c=Array.from(Array(i.joints.length).keys()).sort(function(e,t){return i.joints[e]>i.joints[t]?1:i.joints[e]<i.joints[t]?-1:0});i.joints=i.joints.map(function(e,t,i){return i[c[t]]}),i.bindposes=n.map(function(e,t,i){return i[c[t]]}),this._skeleton&&this._skeleton.destroy(),this.skeleton=i}else console.warn("no skinning root specified!")}},{key:"cookMeshes",value:function(){var W=this,e=!1,t=this.units,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}if(r.mesh){e=!0;break}}if(this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new ff,e&&this._skinningRoot){for(var q,j=0,X=ru.UNKNOWN,Y=0,K=ru.UNKNOWN,Q=new Array(this.units.length),a=this.units.length,s=0;s<a;s++){var o=this.units[s];o&&o.skeleton&&(Q[s]=o.skeleton.joints.map(function(t){return W._skeleton.joints.findIndex(function(e){return t===e})}))}for(var l=function(f){var e=W.units[f];if(!e||!e.mesh||!e.mesh.data)return"continue";var t=JSON.parse(JSON.stringify(e.mesh.struct)),i=0,n=t.vertexBundles,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.attributes.push(Fk),o.attributes.push(zk),o.view.offset=i,o.view.length+=o.view.count*Dk,o.view.stride+=Dk,i+=o.view.length}var l=t.primitives,u=Array.isArray(l),c=0;for(l=u?l:l[Symbol.iterator]();;){var h;if(u){if(c>=l.length)break;h=l[c++]}else{if((c=l.next()).done)break;h=c.value}var d=h;d.indexView&&(d.indexView.offset=i,i+=d.indexView.length),d.geometricInfo&&(i=4*Math.ceil(i/4),d.geometricInfo.view.offset=i,i+=d.geometricInfo.view.length)}var _=e.mesh.data,p=0,v=new Uint8Array(i);q=new DataView(v.buffer);for(var m=0;m<t.vertexBundles.length;m++){var y=e.mesh.readAttribute(m,eu.ATTR_TEX_COORD),g=e.mesh.struct.vertexBundles[m].view,b=t.vertexBundles[m].view,x=g.stride,S=b.stride;p=g.offset,i=b.offset;for(var T=0;T<b.count;T++){var w=_.subarray(p,p+x);v.set(w,i),q.setFloat32(i+x,f,cc.sys.isLittleEndian),q.setFloat32(i+x+4,y[2*T],cc.sys.isLittleEndian),q.setFloat32(i+x+8,y[2*T+1],cc.sys.isLittleEndian),i+=S,p+=x}}for(var E=0;E<t.primitives.length;E++){var A=e.mesh.struct.primitives[E],C=t.primitives[E];if(A.indexView&&C.indexView){var k=A.indexView.stride,R=C.indexView.stride;p=A.indexView.offset,i=C.indexView.offset;for(var O=0;O<C.indexView.count;O++){var M=_.subarray(p,p+k);v.set(M,i),i+=R,p+=k}}if(A.geometricInfo&&C.geometricInfo){var I=A.geometricInfo.view.stride,B=C.geometricInfo.view.stride;p=A.geometricInfo.view.offset,i=C.geometricInfo.view.offset;for(var L=0;L<C.geometricInfo.view.count;L++){var P=_.subarray(p,p+I);v.set(P,i),i+=B,p+=I}}}var F=new ff;F.reset({struct:t,data:v});function z(){if(V){if(G>=U.length)return"break";H=U[G++]}else{if((G=U.next()).done)return"break";H=G.value}var e=H;j=e.view.offset,X=ru.UNKNOWN;var t=e.attributes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.name===eu.ATTR_BATCH_UV){X=a.format;break}j+=xc[a.format].size}X&&rd(q,function(e,t){var i=0===t?"x":"y";return(e=function(e){return e-Math.floor(e)}(e))*N[i]+D[i]},X,j,e.view.length,e.view.stride,q);var s=Q[f];if(!s)return"continue";Y=e.view.offset,K=ru.UNKNOWN;var o=e.attributes,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c;if(h.name===eu.ATTR_JOINTS){K=h.format;break}Y+=xc[h.format].size}K&&rd(q,function(e){return s[e]},K,Y,e.view.length,e.view.stride,q)}var D=e.offset,N=e.size;var U=t.vertexBundles,V=Array.isArray(U),G=0;e:for(U=V?U:U[Symbol.iterator]();;){var H;switch(z()){case"break":break e;case"continue":continue}}W._mesh.merge(F)},u=0;u<a;u++)l(u);this._onMeshChanged(this._mesh),this._updateModels()}}},{key:"cookTextures",value:function(e,t,i){var n=[],r=[],a=[],s=[],o=this.units,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c;if(h.material){var f=h.material.getProperty(t,i);if(f&&f.image&&f.image.data){var d=new bc;d.texOffset.x=h.offset.x*this.atlasSize,d.texOffset.y=h.offset.y*this.atlasSize,d.texExtent.width=h.size.x*this.atlasSize,d.texExtent.height=h.size.y*this.atlasSize;var _=f.image.data;_ instanceof HTMLCanvasElement||_ instanceof HTMLImageElement?(n.push(_),r.push(d)):(a.push(_.buffer),s.push(d))}}}var p=e.getGFXTexture(),v=cc.director.root.device;0<a.length&&v.copyBuffersToTexture(a,p,s),0<n.length&&v.copyTexImagesToTexture(n,p,r)}},{key:"createTexture",value:function(e){var t=new Hh;return t.setFilters(Xc.LINEAR,Xc.LINEAR),t.reset({width:this.atlasSize,height:this.atlasSize,format:Hc.RGBA8888}),t.loaded=!0,this._textures[e]=t}},{key:"resizeAtlases",value:function(){for(var e=0,t=Object.keys(this._textures);e<t.length;e++){var i=t[e];this._textures[i].reset({width:this.atlasSize,height:this.atlasSize,format:Hc.RGBA8888})}}},{key:"mesh",get:function(){return this._mesh},set:function(e){r(g(a.prototype),"mesh",e,this,!0)}},{key:"skeleton",get:function(){return this._skeleton},set:function(e){r(g(a.prototype),"skeleton",e,this,!0)}}]),a}()).prototype,"atlasSize",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),qC=m(HC.prototype,"batchableTextureNames",[DC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jC=m(HC.prototype,"units",[NC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),m(HC.prototype,"mesh",[UC],Object.getOwnPropertyDescriptor(HC.prototype,"mesh"),HC.prototype),m(HC.prototype,"skeleton",[VC],Object.getOwnPropertyDescriptor(HC.prototype,"skeleton"),HC.prototype),GC=HC))||GC)||GC)||GC)||GC)),Vk=vt({LUMINOUS_POWER:0,LUMINANCE:1}),Gk=m4("LightComponent",(XC=fo("cc.LightComponent"),YC=_o({slide:!0,range:[1e3,15e3,1]}),XC((tk=ek=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_color",ZC,c(t)),v(t,"_useColorTemperature",JC,c(t)),v(t,"_colorTemperature",$C,c(t)),t._type=ov.UNKNOWN,t._light=null,t}return _(a,Tm),l(a,[{key:"onEnable",value:function(){this._light?this._light.enabled=!0:this._createLight()}},{key:"onDisable",value:function(){this._light&&(this._light.enabled=!1)}},{key:"onDestroy",value:function(){this._destroyLight()}},{key:"_createLight",value:function(e){this._light&&(this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.enabled=this.enabledInHierarchy)}},{key:"_destroyLight",value:function(e){this._light=null}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(this._light.color.x=e.r/255,this._light.color.y=e.g/255,this._light.color.z=e.b/255)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"type",get:function(){return this._type}}]),a}(),ek.Type=ov,ek.PhotometricTerm=Vk,ZC=m((QC=tk).prototype,"_color",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ar.WHITE.clone()}}),JC=m(QC.prototype,"_useColorTemperature",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$C=m(QC.prototype,"_colorTemperature",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),m(QC.prototype,"color",[_o],Object.getOwnPropertyDescriptor(QC.prototype,"color"),QC.prototype),m(QC.prototype,"useColorTemperature",[_o],Object.getOwnPropertyDescriptor(QC.prototype,"useColorTemperature"),QC.prototype),m(QC.prototype,"colorTemperature",[YC],Object.getOwnPropertyDescriptor(QC.prototype,"colorTemperature"),QC.prototype),KC=QC))||KC)),Hk=m4("DirectionalLightComponent",(ik=fo("cc.DirectionalLightComponent"),nk=go("Components/DirectionalLight"),rk=_o({unit:"lx"}),ik(ak=nk(ak=mo((ok=m((sk=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_illuminance",ok,c(t)),t._type=ov.DIRECTIONAL,t._light=null,t}return _(a,Gk),l(a,[{key:"_createLight",value:function(e){this.node.scene&&((e=e||this._getRenderScene()).mainLight.node.activeInHierarchy?console.warn("there can be only one directional(main) light."):(this._light=e.mainLight,this.illuminance=this._illuminance,p(g(a.prototype),"_createLight",this).call(this,e)))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&(this._light.enabled=!1,e=e||this._getRenderScene(),this._light.node=e.defaultMainLightNode,p(g(a.prototype),"_destroyLight",this).call(this,e))}},{key:"illuminance",get:function(){return this._illuminance},set:function(e){this._illuminance=e,this._light&&(this._light.illuminance=this._illuminance)}}]),a}()).prototype,"_illuminance",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),m(sk.prototype,"illuminance",[rk],Object.getOwnPropertyDescriptor(sk.prototype,"illuminance"),sk.prototype),ak=sk))||ak)||ak)||ak)),Wk=fo("cc.EditorCameraComponent")(lk=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._uiEditorCamera=null,t}return _(a,_A),l(a,[{key:"onLoad",value:function(){p(g(a.prototype),"onLoad",this).call(this),this._inEditorMode=!0}},{key:"onEnable",value:function(){p(g(a.prototype),"onEnable",this).call(this)}},{key:"onDisable",value:function(){p(g(a.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){p(g(a.prototype),"onDestroy",this).call(this),this._uiEditorCamera&&(cc.director.root.ui.renderScene.destroyCamera(this._uiEditorCamera),this._uiEditorCamera=null)}},{key:"_createCamera",value:function(){var e=this._camera;p(g(a.prototype),"_createCamera",this).call(this),this._camera!==e&&this._camera&&(this._uiEditorCamera&&(cc.director.root.ui.renderScene.destroyCamera(this._uiEditorCamera),this._uiEditorCamera=null),this._uiEditorCamera=cc.director.root.ui.renderScene.createCamera({name:"Editor UICamera",node:this._camera.node,projection:this._projection,window:cc.director.root.mainWindow,priority:this._priority+1,flows:["UIFlow"]}),this._uiEditorCamera.visibility=Ff,this._uiEditorCamera.viewport=this._camera.viewport,this._uiEditorCamera.fov=this._camera.fov,this._uiEditorCamera.nearClip=this._camera.nearClip,this._uiEditorCamera.farClip=this._camera.farClip,this._uiEditorCamera.clearColor=this._camera.clearColor,this._uiEditorCamera.clearDepth=this._camera.clearDepth,this._uiEditorCamera.clearStencil=this._camera.clearStencil,this._uiEditorCamera.clearFlag=dc.DEPTH_STENCIL)}},{key:"projection",set:function(e){r(g(a.prototype),"projection",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.projectionType=e)}},{key:"fov",set:function(e){r(g(a.prototype),"fov",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.fov=yi(e))}},{key:"orthoHeight",set:function(e){r(g(a.prototype),"orthoHeight",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.orthoHeight=e)}},{key:"near",set:function(e){r(g(a.prototype),"near",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.nearClip=e)}},{key:"far",set:function(e){r(g(a.prototype),"far",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.farClip=e)}},{key:"color",set:function(e){r(g(a.prototype),"color",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearColor=e)}},{key:"depth",set:function(e){r(g(a.prototype),"depth",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearDepth=e)}},{key:"stencil",set:function(e){r(g(a.prototype),"stencil",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearStencil=e)}},{key:"clearFlags",set:function(e){r(g(a.prototype),"clearFlags",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearFlag=e)}},{key:"rect",set:function(e){r(g(a.prototype),"rect",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.viewport=e)}},{key:"screenScale",set:function(e){r(g(a.prototype),"screenScale",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.screenScale=e)}}]),a}())||lk,qk=m4("SphereLightComponent",(uk=fo("cc.SphereLightComponent"),ck=go("Components/SphereLight"),hk=_o({unit:"lm"}),fk=_o({unit:"cd/m"}),dk=_o({type:Vk}),uk(_k=ck(_k=mo((vk=m((pk=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_size",vk,c(t)),v(t,"_luminance",mk,c(t)),v(t,"_term",yk,c(t)),v(t,"_range",gk,c(t)),t._type=ov.SPHERE,t._light=null,t}return _(a,Gk),l(a,[{key:"_createLight",value:function(e){var t=this;this.node.scene&&(e=e||this._getRenderScene(),this._light&&e.sphereLights.find(function(e){return e===t._light})||(this._light=e.createSphereLight(this.name,this.node),this._light?(this._light.luminance=this._luminance,this.size=this._size,this.range=this._range,p(g(a.prototype),"_createLight",this).call(this,e)):console.warn("we don't support this many lights in forward pipeline.")))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&((e=e||this._getRenderScene()).destroySphereLight(this._light),p(g(a.prototype),"_destroyLight",this).call(this,e))}},{key:"luminousPower",get:function(){return this._luminance*pv(this._size)},set:function(e){this._luminance=e/pv(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),a}()).prototype,"_size",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),mk=m(pk.prototype,"_luminance",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/pv(.15)}}),yk=m(pk.prototype,"_term",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vk.LUMINOUS_POWER}}),gk=m(pk.prototype,"_range",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),m(pk.prototype,"luminousPower",[hk],Object.getOwnPropertyDescriptor(pk.prototype,"luminousPower"),pk.prototype),m(pk.prototype,"luminance",[fk],Object.getOwnPropertyDescriptor(pk.prototype,"luminance"),pk.prototype),m(pk.prototype,"term",[dk],Object.getOwnPropertyDescriptor(pk.prototype,"term"),pk.prototype),m(pk.prototype,"size",[_o],Object.getOwnPropertyDescriptor(pk.prototype,"size"),pk.prototype),m(pk.prototype,"range",[_o],Object.getOwnPropertyDescriptor(pk.prototype,"range"),pk.prototype),_k=pk))||_k)||_k)||_k)),jk=m4("SpotLightComponent",(bk=fo("cc.SpotLightComponent"),xk=go("Components/SpotLight"),Sk=_o({unit:"lm"}),Tk=_o({unit:"cd/m"}),wk=_o({type:Vk}),Ek=_o({slide:!0,range:[2,180,1]}),bk(Ak=xk(Ak=mo((kk=m((Ck=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_size",kk,c(t)),v(t,"_luminance",Rk,c(t)),v(t,"_term",Ok,c(t)),v(t,"_range",Mk,c(t)),v(t,"_spotAngle",Ik,c(t)),t._type=ov.SPOT,t._light=null,t}return _(a,Gk),l(a,[{key:"_createLight",value:function(e){var t=this;this.node.scene&&(e=e||this._getRenderScene(),this._light&&e.spotLights.find(function(e){return e===t._light})||(this._light=e.createSpotLight(this.name,this.node),this._light?(this._light.luminance=this._luminance,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,p(g(a.prototype),"_createLight",this).call(this,e)):console.warn("we don't support this many lights in forward pipeline.")))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&((e=e||this._getRenderScene()).destroySpotLight(this._light),p(g(a.prototype),"_destroyLight",this).call(this,e))}},{key:"luminousPower",get:function(){return this._luminance*pv(this._size)},set:function(e){this._luminance=e/pv(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=yi(e))}}]),a}()).prototype,"_size",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),Rk=m(Ck.prototype,"_luminance",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/pv(.15)}}),Ok=m(Ck.prototype,"_term",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vk.LUMINOUS_POWER}}),Mk=m(Ck.prototype,"_range",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ik=m(Ck.prototype,"_spotAngle",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),m(Ck.prototype,"luminousPower",[Sk],Object.getOwnPropertyDescriptor(Ck.prototype,"luminousPower"),Ck.prototype),m(Ck.prototype,"luminance",[Tk],Object.getOwnPropertyDescriptor(Ck.prototype,"luminance"),Ck.prototype),m(Ck.prototype,"term",[wk],Object.getOwnPropertyDescriptor(Ck.prototype,"term"),Ck.prototype),m(Ck.prototype,"size",[_o],Object.getOwnPropertyDescriptor(Ck.prototype,"size"),Ck.prototype),m(Ck.prototype,"range",[_o],Object.getOwnPropertyDescriptor(Ck.prototype,"range"),Ck.prototype),m(Ck.prototype,"spotAngle",[Ek],Object.getOwnPropertyDescriptor(Ck.prototype,"spotAngle"),Ck.prototype),Ak=Ck))||Ak)||Ak)||Ak));function Xk(e,t,i,n,r){var a=1-r;return e*a*a*a+3*t*a*a*r+3*i*a*r*r+n*r*r*r}cc.CameraComponent=_A,cc.EditorComponent=Wk,cc.RenderableComponent=ZA,cc.ModelComponent=Lk,cc.SkinningModelComponent=Pk,cc.BatchedSkinningModelComponent=Uk,cc.SkinningModelUnit=Nk,cc.LightComponent=Gk,cc.DirectionalLightComponent=Hk,cc.SphereLightComponent=qk,cc.SpotLightComponent=jk,cc.utils=dd,cc.bezier=Xk;var Yk=Math.cos,Kk=Math.acos,Qk=Math.max,Zk=2*Math.PI,Jk=Math.sqrt;function $k(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function eR(e,t){var i=function(e,t){var i,n,r,a,s=t-0,o=t-e[0],l=3*s,u=3*o,c=3*(t-e[2]),h=1/(u-s-c+(t-1)),f=(l-6*o+c)*h,d=1/3*f,_=(u-l)*h,p=1/3*(3*_-f*f),v=1/3*p,m=(2*f*f*f-9*f*_+27*(s*h))/27,y=m/2,g=y*y+v*v*v;if(g<0){var b=1/3*-p,x=Jk(b*b*b),S=-m/(2*x),T=Kk(S<-1?-1:1<S?1:S),w=2*$k(x);return n=w*Yk(T*(1/3))-d,r=w*Yk((T+Zk)*(1/3))-d,a=w*Yk((T+2*Zk)*(1/3))-d,0<=n&&n<=1?0<=r&&r<=1?0<=a&&a<=1?Qk(n,r,a):Qk(n,r):0<=a&&a<=1?Qk(n,a):n:0<=r&&r<=1?0<=a&&a<=1?Qk(r,a):r:a}if(0==g)return r=-(i=y<0?$k(-y):-$k(y))-d,0<=(n=2*i-d)&&n<=1?0<=r&&r<=1?Qk(n,r):n:r;var E=Jk(g);return n=(i=$k(-y+E))-$k(y+E)-d}(e,t),n=1-i;return 0*n*n*n+3*e[1]*i*n*n+3*e[3]*i*i*n+1*i*i*i}cc.bezierByTime=eR;var tR,iR,nR,rR,aR=1e-6;function sR(e,t){for(var i=0,n=e.length-1,r=n>>>1;i<=n;r=i+n>>>1){var a=e[r];if(t+aR<a)n=r-1;else{if(!(a<t-aR))return r;i=r+1}}return~i}(iR=tR=tR||{})[iR.Loop=2]="Loop",iR[iR.ShouldWrap=4]="ShouldWrap",iR[iR.PingPong=22]="PingPong",iR[iR.Reverse=36]="Reverse",(rR=nR=nR||{})[rR.Default=0]="Default",rR[rR.Normal=1]="Normal",rR[rR.Reverse=tR.Reverse]="Reverse",rR[rR.Loop=tR.Loop]="Loop",rR[rR.LoopReverse=tR.Loop|tR.Reverse]="LoopReverse",rR[rR.PingPong=tR.PingPong]="PingPong",rR[rR.PingPongReverse=tR.PingPong|tR.Reverse]="PingPongReverse",mt(nR);var oR,lR=function(){function t(e){y(this,t),this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return l(t,[{key:"set",value:function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex}}]),t}();var uR=m4("RatioSampler",function(){function s(e){var t,i;y(this,s),this.ratios=void 0;for(var n=!(this._findRatio=void 0),r=1,a=(this.ratios=e).length;r<a;r++)if(t=e[r]-e[r-1],1===r)i=t;else if(1e-6<Math.abs(t-i)){n=!1;break}this._findRatio=n?_R:sR}return l(s,[{key:"sample",value:function(e){return this._findRatio(this.ratios,e)}}]),s}());cc.RatioSampler=uR;var cR=m4("AnimCurve",function(){function r(e,t){y(this,r),this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._stepfiedValues=void 0,this._duration=void 0,this._duration=t,this._values=e.values;function i(e){return"string"==typeof e?e:Array.isArray(e)?e[0]===e[1]&&e[2]===e[3]?r.Linear:r.Bezier(e):r.Linear}void 0!==e.easingMethod?this.type=i(e.easingMethod):void 0!==e.easingMethods?this.types=e.easingMethods.map(i):this.type=null;var n=e.values[0];void 0!==e.interpolate&&!e.interpolate||(this._lerp=pR(n))}return l(r,null,[{key:"Bezier",value:function(e){return e}}]),l(r,[{key:"hasLerp",value:function(){return!!this._lerp}},{key:"valueAt",value:function(e){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}},{key:"valueBetween",value:function(e,t,i,n,r){if(this._lerp){var a=this.types?this.types[t]:this.type,s=r-i,o=(e-i)/s;a&&(o=dR(o,a));var l=this._values[t],u=this._values[n];return this._lerp(l,u,o,s*this._duration)}return this.valueAt(t)}},{key:"empty",value:function(){return 0===this._values.length}}]),r}());cR.Linear=null,cc.AnimCurve=cR;m4("EventInfo",function(){function e(){y(this,e),this.events=[]}return l(e,[{key:"add",value:function(e,t){this.events.push({func:e||"",params:t||[]})}}]),e}());var hR=m4("CurveValueAdapter",fo("cc.CurveValueAdapter")(oR=function(){function e(){y(this,e)}return l(e,[{key:"forTarget",value:function(e){return{set:function(e){}}}}]),e}())||oR);function fR(e,t,i){var n=t.sample(i);if(n<0)if((n=~n)<=0)n=0;else{if(!(n>=t.ratios.length))return e.valueBetween(i,n-1,t.ratios[n-1],n,t.ratios[n]);n=t.ratios.length-1}return e.valueAt(n)}function dR(e,t){if("string"==typeof t){var i=hp[t];i?e=i(e):z(3906,t)}else Array.isArray(t)&&(e=eR(t,e));return e}function _R(e,t){var i=e.length-1;if(0==i)return 0;var n=e[0];if(t<n)return 0;var r=e[i];if(r<t)return i;var a=(t=(t-n)/(r-n))/(1/i),s=0|a;return a-s<1e-6?s:1+s-a<1e-6?1+s:~(1+s)}cc.CurveValueAdapter=hR,cc.sampleAnimationCurve=fR;var pR=function(e){if(null!==e){if("number"==typeof e)return mi;if("object"===be(e)&&e.constructor){if(e instanceof fn)return function(){var r=new fn;return function(e,t,i,n){return fn.slerp(r,e,t,i)}}();if(e instanceof yt)return function(n){var r=new n;return function(e,t,i){return n.lerp(r,e,t,i),r}}(e.constructor);if(e.constructor===Number)return mi;if(function(e){return"function"==typeof e.lerp}(e))return vR}}};function vR(e,t,i,n){return e.lerp(t,i,n)}var mR,yR,gR,bR,xR,SR;function TR(e){return"string"==typeof e}function wR(e){return"number"==typeof e}function ER(e,t){return e instanceof t}cc.isPropertyModifier=TR,cc.isElementModifier=wR,cc.isCustomTargetModifier=ER;var AR=m4("HierachyModifier",fo("cc.HierachyModifier")((gR=m((yR=function(){function t(e){y(this,t),v(this,"path",gR,this),this.path=e||""}return l(t,[{key:"get",value:function(e){if(!(e instanceof cy))throw new Error("Target of hierachy modifier shall be Node.");var t=e.getChildByPath(this.path);if(!t)throw new Error('Node "'.concat(e.name,'" has no path "').concat(this.path,'"'));return t}}]),t}()).prototype,"path",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),mR=yR))||mR);cc.HierachyModifier=AR;var CR=m4("ComponentModifier",fo("cc.ComponentModifier")((SR=m((xR=function(){function t(e){y(this,t),v(this,"component",SR,this),this.component=e||""}return l(t,[{key:"get",value:function(e){if(!(e instanceof cy))throw new Error("Target of hierachy modifier shall be Node.");var t=e.getComponent(this.component);if(!t)throw new Error('Node "'.concat(e.name,'" has no component "').concat(this.component,'"'));return t}}]),t}()).prototype,"component",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),bR=xR))||bR);cc.ComponentModifier=CR;var kR,RR,OR,MR,IR,BR,LR,PR,FR,zR,DR,NR,UR,VR,GR,HR=function(){function s(e,t,i){var n;y(this,s),this._isProxy=void 0,this._assignmentOrProxy=void 0;for(var r=0;r<t.length;++r){var a=t[r];if(wR(a)||TR(a))if(r!==t.length-1||i){if(!(a in e))throw new Error('Target object has no property "'.concat(a,'"'));e=e[a]}else n=a;else e=a.get(e)}if(void 0!==n)this._assignmentOrProxy={object:e,propertyOrElement:n},this._isProxy=!1;else{if(!i)throw new Error("Bad animation curve.");this._assignmentOrProxy=i.forTarget(e),this._isProxy=!0}}return l(s,[{key:"setValue",value:function(e){this._isProxy?this._assignmentOrProxy.set(e):this._assignmentOrProxy.object[this._assignmentOrProxy.propertyOrElement]=e}}]),s}(),WR=m4("AnimationClip",(kR=fo("cc.AnimationClip"),RR=_o({visible:!1}),kR((GR=VR=function(){function o(){var e,t;y(this,o);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(o)).call.apply(e,[this].concat(n))),"sample",IR,c(t)),v(t,"speed",BR,c(t)),v(t,"wrapMode",LR,c(t)),v(t,"curveDatas",PR,c(t)),v(t,"_curves",FR,c(t)),v(t,"events",zR,c(t)),v(t,"_duration",DR,c(t)),v(t,"_keys",NR,c(t)),t._ratioSamplers=[],t._runtimeCurves=void 0,t._runtimeEvents=void 0,t.frameRate=0,v(t,"_stepness",UR,c(t)),t._hash=0,t}return _(o,nh),l(o,[{key:"onLoaded",value:function(){this.frameRate=this.sample,this._migrateCurveDatas()}},{key:"getPropertyCurves",value:function(e){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}},{key:"updateCurveDatas",value:function(){this._migrateCurveDatas(),delete this._runtimeCurves}},{key:"updateEventDatas",value:function(){delete this._runtimeEvents}},{key:"getEventGroupIndexAtRatio",value:function(e){return this._runtimeEvents||this._createRuntimeEvents(),function(e,t){for(var i=0,n=e.length-1,r=n>>>1;i<=n;r=i+n>>>1){var a=e[r];if(t+1e-6<a)n=r-1;else{if(!(a<t-1e-6))return r;i=r+1}}return~i}(this._runtimeEvents.ratios,e)}},{key:"hasEvents",value:function(){return 0!==this.events.length}},{key:"_createPropertyCurves",value:function(){var t=this;this._ratioSamplers=this._keys.map(function(e){return new uR(e.map(function(e){return e/t._duration}))}),this._runtimeCurves=this._curves.map(function(e){return{curve:new cR(e.data,t._duration),modifiers:e.modifiers,valueAdapter:e.valueAdapter,sampler:t._ratioSamplers[e.data.keys]}}),this._applyStepness()}},{key:"_createRuntimeEvents",value:function(){var n=this;var r=[],a=[],e=function(){if(o){if(l>=s.length)return"break";u=s[l++]}else{if((l=s.next()).done)return"break";u=l.value}var e=u,t=e.frame/n._duration,i=r.findIndex(function(e){return e===t});i<0&&(i=r.length,r.push(t),a.push({events:[]})),a[i].events.push({functionName:e.func,parameters:e.params})},s=this.events.sort(function(e,t){return e.frame-t.frame}),o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if("break"===e())break}this._runtimeEvents={ratios:r,eventGroups:a}}},{key:"_applyStepness",value:function(){this._runtimeCurves}},{key:"_migrateCurveDatas",value:function(){if(this.curveDatas){for(var e=0,t=Object.keys(this.curveDatas);e<t.length;e++){var i=t[e],n=new AR;n.path=i;var r=this.curveDatas[i];if(r.props)for(var a=0,s=Object.keys(r.props);a<s.length;a++){var o=s[a],l=r.props[o];this._curves.push({modifiers:[n,o],data:l})}if(r.comps)for(var u=0,c=Object.keys(r.comps);u<c.length;u++){var h=c[u],f=new CR;f.component=h;for(var d=r.comps[h],_=0,p=Object.keys(d);_<p.length;_++){var v=p[_],m=d[v];this._curves.push({modifiers:[n,f,v],data:m})}}}delete this.curveDatas}}},{key:"_getDeprecatedCurveDatas",value:function(){var e={},t=this._curves,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(0!==a.modifiers.length&&ER(a.modifiers[0],AR)){var s=null,o=void 0;if(2===a.modifiers.length&&TR(a.modifiers[1]))o=a.modifiers[1];else{if(3!==a.modifiers.length||!ER(a.modifiers[1],CR)||!TR(a.modifiers[2]))continue;s=a.modifiers[1].component,o=a.modifiers[2]}var l=a.modifiers[0].path;l in e||(e[l]={});var u=e[l],c=void 0;if(s){"comps"in u||(u.comps={});var h=u.comps;s in h||(h[s]={}),c=h[s]}else"props"in u||(u.props={}),c=u.props;c[o]=a.data}}return e}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"eventGroups",get:function(){return this._runtimeEvents||this._createRuntimeEvents(),this._runtimeEvents.eventGroups}},{key:"stepness",get:function(){return this._stepness},set:function(e){this._stepness=e,this._applyStepness()}},{key:"hash",get:function(){return this._hash||(this._hash=Mc(JSON.stringify(this._getDeprecatedCurveDatas()),666)),this._hash}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}}],[{key:"createWithSpriteFrames",value:function(e,t){if(!Array.isArray(e))return z(3905),null;var i=new o;i.sample=t||i.sample,i.duration=e.length/i.sample;for(var n=1/i.sample,r=new Array(e.length),a=new Array(r.length),s=0;s<e.length;s++)r[s]=s*n,a[s]=e[s];return i.keys=[r],i.curves=[{modifiers:[new CR("cc.SpriteComponent"),"spriteFrame"],data:{keys:0,values:a}}],i}}]),o}(),VR.WrapMode=nR,IR=m((MR=GR).prototype,"sample",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),BR=m(MR.prototype,"speed",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),LR=m(MR.prototype,"wrapMode",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nR.Normal}}),PR=m(MR.prototype,"curveDatas",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),FR=m(MR.prototype,"_curves",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zR=m(MR.prototype,"events",[RR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),DR=m(MR.prototype,"_duration",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NR=m(MR.prototype,"_keys",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),UR=m(MR.prototype,"_stepness",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OR=MR))||OR));cc.AnimationClip=WR;var qR,jR,XR,YR=function(){function e(){y(this,e),this._blendTargets=[]}return l(e,[{key:"refPropertyBlendTarget",value:function(t,i){var e=this._blendTargets.find(function(e){return e.target===t});e||(e={target:t,properties:[]},this._blendTargets.push(e));var n=e.properties,r=n.find(function(e){return e.name===i});return r||(r={name:i,weight:0,value:void 0,refCount:0},n.push(r)),++r.refCount,r}},{key:"derefPropertyBlendTarget",value:function(t,i){var e=this._blendTargets.findIndex(function(e){return e.target===t});if(!(e<0)){var n=this._blendTargets[e].properties,r=n.findIndex(function(e){return e.name===i});if(!(r<0)){var a=n[r];--a.refCount,0<a.refCount||(2<=n.length?n.splice(r,1):this._blendTargets.splice(e,1))}}}},{key:"apply",value:function(){var e=this._blendTargets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=r.target,s=r.properties,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if(o){if(l>=s.length)break;u=s[l++]}else{if((l=s.next()).done)break;u=l.value}var c=u;0!==c.weight&&(a instanceof cy?"position"===c.name?a.setPosition(c.value):"rotation"===c.name?a.setRotation(c.value):a.setScale(c.value):a[c.name]=c.value)}}}},{key:"clear",value:function(){var e=this._blendTargets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n.properties,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}o.weight=0}}}}]),e}(),KR=m4("AnimationManager",fo((XR=jR=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._anims=new ce([]),t._delayEvents=[],t._blendState=new YR,t._crossFades=[],t}return _(a,iv),l(a,[{key:"addCrossFade",value:function(e){this._crossFades.push(e)}},{key:"removeCrossFade",value:function(e){fe(this._crossFades,e)}},{key:"update",value:function(e){var t=this._crossFades,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.update(e)}this._blendState.clear();var a=this._anims,s=a.array;for(a.i=0;a.i<s.length;++a.i){var o=s[a.i];o.isPlaying&&!o.isPaused&&o.update(e)}this._blendState.apply();for(var l=this._delayEvents,u=0,c=l.length;u<c;u++){var h=l[u];h.target[h.func].apply(h.target,h.args)}l.length=0}},{key:"destruct",value:function(){}},{key:"addAnimation",value:function(e){-1===this._anims.array.indexOf(e)&&(e.attachToBlendState(this._blendState),this._anims.push(e))}},{key:"removeAnimation",value:function(e){var t=this._anims.array.indexOf(e);0<=t?(e.detachFromBlendState(this._blendState),this._anims.fastRemoveAt(t)):z(3907)}},{key:"pushDelayEvent",value:function(e,t,i){this._delayEvents.push({target:e,func:t,args:i})}},{key:"blendState",get:function(){return this._blendState}}]),a}(),jR.ID="animation",qR=XR))||qR);kx.on(Cx.EVENT_INIT,function(){var e=new KR;kx.registerSystem(KR.ID,e,uv.PRIORITY_SYSTEM)}),cc.AnimationManager=KR;var QR,ZR,JR=function(){function e(){y(this,e),this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}return l(e,[{key:"play",value:function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(G(3912)):(this._isPlaying=!0,this.onPlay())}},{key:"stop",value:function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}},{key:"pause",value:function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}},{key:"resume",value:function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}},{key:"step",value:function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}},{key:"update",value:function(e){}},{key:"onPlay",value:function(){}},{key:"onPause",value:function(){}},{key:"onResume",value:function(){}},{key:"onStop",value:function(){}},{key:"onError",value:function(e){}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}}]),e}();function $R(e,t,i){return i.value||(i.value=new Ni),0===i.weight&&Ni.zero(i.value),0===t?i.value:1===t?Ni.copy(i.value,e):Ni.scaleAndAdd(i.value,i.value,e,t)}function eO(e,t,i){if(i.value||(i.value=new fn),0===i.weight&&fn.identity(i.value),0===t)return i.value;if(1===t)return fn.copy(i.value,e);var n=t/(i.weight+t);return fn.slerp(i.value,i.value,e,n)}(ZR=QR=QR||{})[ZR.NodePosition=0]="NodePosition",ZR[ZR.NodeScale=1]="NodeScale",ZR[ZR.NodeRotation=2]="NodeRotation",ZR[ZR.None=3]="None";var tO=function(){function n(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(y(this,n),this._curve=void 0,this._boundTarget=void 0,this._curveValueProxy=void 0,this._rootTarget=void 0,this._rootTargetProperty=void 0,this._isNodeTarget=void 0,this._propertySpecialization=void 0,this._blendTarget=void 0,this._blendFunction=void 0,this._cached=void 0,this._curveDetail=void 0,this._curve=e.curve,this._curveDetail=e,this._boundTarget=new HR(t,e.modifiers,e.valueAdapter),this._rootTarget=t,this._isNodeTarget=t instanceof cy,this._propertySpecialization=QR.None,this._blendFunction=null,this._isNodeTarget&&1===e.modifiers.length)switch(e.modifiers[0]){case"position":this._propertySpecialization=QR.NodePosition,this._blendFunction=$R;break;case"rotation":this._propertySpecialization=QR.NodeRotation,this._blendFunction=eO;break;case"scale":this._propertySpecialization=QR.NodeScale,this._blendFunction=$R}this._blendTarget=i}return l(n,[{key:"attachToBlendState",value:function(e){this._rootTargetProperty&&(this._blendTarget=e.refPropertyBlendTarget(this._rootTarget,this._rootTargetProperty))}},{key:"dettachFromBlendState",value:function(e){this._rootTargetProperty&&(this._blendTarget=null,e.derefPropertyBlendTarget(this._rootTarget,this._rootTargetProperty))}},{key:"applySample",value:function(e,t,i,n,r){var a;this._curve.empty()||(a=i?this._curve.valueBetween(e,n.from,n.fromRatio,n.to,n.toRatio):this._curve.valueAt(t),this._setValue(a,r))}},{key:"_setValue",value:function(e,t){if(!this._blendFunction||!this._blendTarget||this._blendTarget.refCount<=1)switch(this._propertySpecialization){case QR.NodePosition:this._rootTarget.setPosition(e);break;case QR.NodeRotation:this._rootTarget.setRotation(e);break;case QR.NodeScale:this._rootTarget.setScale(e);break;default:this._boundTarget.setValue(e)}else this._blendTarget.value=this._blendFunction(e,t,this._blendTarget),this._blendTarget.weight+=t}},{key:"propertyName",get:function(){return this._rootTargetProperty||""}},{key:"curveDetail",get:function(){return this._curveDetail}}]),n}();var iO,nO,rO,aO,sO,oO=m4("AnimationState",function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this))).duration=1,i.speed=1,i.time=0,i.weight=0,i.frameRate=0,i._lastframeEventOn=!1,i._wrapMode=nR.Normal,i._repeatCount=1,i._currentFramePlayed=!1,i._delay=0,i._delayTime=0,i._wrappedInfo=new lR,i._lastWrapInfo=null,i._lastWrapInfoEvent=null,i._process=i.process,i._target=null,i._targetNode=null,i._clip=void 0,i._name=void 0,i._lastIterations=void 0,i._samplerSharedGroups=[],i._curveLoaded=!1,i._ignoreIndex=-1,i._clip=e,i._name=t||e&&e.name,i}return _(n,JR),l(n,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){this._wrapMode=e,this.time=0,e&tR.Loop?this.repeatCount=1/0:this.repeatCount=1}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&tR.ShouldWrap,i=(this.wrapMode&tR.Reverse)===tR.Reverse;this._process=e!==1/0||t||i?this.process:this.simpleProcess}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}}]),l(n,[{key:"initialize",value:function(n){var r=this;if(!this._curveLoaded){this._curveLoaded=!0,this._samplerSharedGroups.length=0,this._targetNode=n;var e=this._clip;this.duration=e.duration,this.speed=e.speed,this.wrapMode=e.wrapMode,this.frameRate=e.sample,(this.wrapMode&tR.Loop)===tR.Loop?this.repeatCount=1/0:this.repeatCount=1;for(var a=e.getPropertyCurves(n),t=function(e){var t=a[e],i=r._samplerSharedGroups.find(function(e){return e.sampler===t.sampler});i||(i=function(e){return{sampler:e,curves:[],samplerResultCache:{from:0,fromRatio:0,to:0,toRatio:0}}}(t.sampler),r._samplerSharedGroups.push(i));try{i.curves.push(new tO(t,n))}catch(e){}},i=0;i<a.length;++i)t(i)}}},{key:"_emit",value:function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)}},{key:"emit",value:function(){for(var e=new Array(arguments.length),t=0,i=e.length;t<i;t++)e[t]=t<0||arguments.length<=t?void 0:arguments[t];kx.getAnimationManager().pushDelayEvent(this,"_emit",e)}},{key:"on",value:function(e,t,i){return this._target&&this._target.isValid?("lastframe"===e&&(this._lastframeEventOn=!0),this._target.on(e,t,i)):null}},{key:"once",value:function(e,t,i){var n=this;return this._target&&this._target.isValid?("lastframe"===e&&(this._lastframeEventOn=!0),this._target.once(e,function(e){t.call(i,e),n._lastframeEventOn=!1})):null}},{key:"off",value:function(e,t,i){this._target&&this._target.isValid&&("lastframe"===e&&(this._target.hasEventListener(e)||(this._lastframeEventOn=!1)),this._target.off(e,t,i))}},{key:"_setEventTarget",value:function(e){this._target=e}},{key:"setTime",value:function(e){this._currentFramePlayed=!1,this.time=e||0,this._lastWrapInfoEvent=null,this._ignoreIndex=-1;var t=this.getWrappedInfo(e,this._wrappedInfo),i=t.direction,n=this._clip.getEventGroupIndexAtRatio(t.ratio);n<0&&(n=~n-1,i<0&&(n+=1),this._ignoreIndex=n)}},{key:"update",value:function(e){0<this._delayTime&&(this._delayTime-=e,0<this._delayTime)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())}},{key:"_needReverse",value:function(e){var t=this.wrapMode,i=!1;(t&tR.PingPong)===tR.PingPong&&(e-(0|e)==0&&0<e&&(e-=1),1&e&&(i=!i));return(t&tR.Reverse)===tR.Reverse&&(i=!i),i}},{key:"getWrappedInfo",value:function(e,t){t=t||new lR;var i=!1,n=this.duration,r=this.repeatCount,a=0<e?e/n:-e/n;if(r<=a){i=!0;var s=(a=r)-(0|r);0===s&&(s=1),e=s*n*(0<e?1:-1)}if(n<e){var o=e%n;e=0==o?n:o}else e<0&&0!==(e%=n)&&(e+=n);var l=!1,u=this._wrapMode&tR.ShouldWrap;u&&(l=this._needReverse(a));var c=l?-1:1;return this.speed<0&&(c*=-1),u&&l&&(e=n-e),t.ratio=e/n,t.time=e,t.direction=c,t.stopped=i,t.iterations=a,t}},{key:"sample",value:function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.ratio),this._sampleEvents(e),e}},{key:"process",value:function(){var e,t=this.sample();this._lastframeEventOn&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new lR(t),1<this.repeatCount&&(0|t.iterations)>(0|e.iterations)&&this.emit("lastframe",this),e.set(t));t.stopped&&(this.stop(),this.emit("finished",this))}},{key:"simpleProcess",value:function(){var e=this.time,t=this.duration;t<e?0===(e%=t)&&(e=t):e<0&&0!==(e%=t)&&(e+=t);var i=e/t;this._sampleCurves(i),this._clip.hasEvents()&&this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._lastframeEventOn&&(void 0===this._lastIterations&&(this._lastIterations=i),(0<this.time&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit("lastframe",this),this._lastIterations=i)}},{key:"attachToBlendState",value:function(e){var t=this._samplerSharedGroups,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r.curves,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.attachToBlendState(e)}}}},{key:"detachFromBlendState",value:function(e){var t=this._samplerSharedGroups,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r.curves,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.dettachFromBlendState(e)}}}},{key:"cache",value:function(e){}},{key:"onPlay",value:function(){this.setTime(0),this._delayTime=this._delay,kx.getAnimationManager().addAnimation(this),this.emit("play",this)}},{key:"onStop",value:function(){this.isPaused||kx.getAnimationManager().removeAnimation(this),this.emit("stop",this)}},{key:"onResume",value:function(){kx.getAnimationManager().addAnimation(this),this.emit("resume",this)}},{key:"onPause",value:function(){kx.getAnimationManager().removeAnimation(this),this.emit("pause",this)}},{key:"_sampleCurves",value:function(e){for(var t=0,i=this._samplerSharedGroups.length;t<i;++t){var n=this._samplerSharedGroups[t],r=n.sampler,a=n.samplerResultCache,s=0,o=!1;r?(s=r.sample(e))<0&&((s=~s)<=0?s=0:s>=r.ratios.length?s=r.ratios.length-1:(o=!0,a.from=s-1,a.fromRatio=r.ratios[a.from],a.to=s,a.toRatio=r.ratios[a.to])):s=0;for(var l=0,u=n.curves.length;l<u;++l){n.curves[l].applySample(e,s,o,a,this.weight)}}}},{key:"_sampleEvents",value:function(e){var t=this._clip.eventGroups.length,i=e.direction,n=this._clip.getEventGroupIndexAtRatio(e.ratio);if(n<0&&(n=~n-1,i<0&&(n+=1)),this._ignoreIndex!==n&&(this._ignoreIndex=-1),e.frameIndex=n,!this._lastWrapInfoEvent)return this._fireEvent(n),void(this._lastWrapInfoEvent=new lR(e));var r=this.wrapMode,a=lO(e.iterations),s=this._lastWrapInfoEvent,o=lO(s.iterations),l=s.frameIndex,u=s.direction,c=-1!==o&&a!==o;if(l===n&&c&&1===t)this._fireEvent(0);else if(l!==n||c){i=u;do{if(l!==n){if(-1===i&&0===l&&0<n?((r&tR.PingPong)===tR.PingPong?i*=-1:l=t,o++):1===i&&l===t-1&&n<t-1&&((r&tR.PingPong)===tR.PingPong?i*=-1:l=-1,o++),l===n)break;if(a<o)break}l+=i,kx.getAnimationManager().pushDelayEvent(this,"_fireEvent",[l])}while(l!==n&&-1<l&&l<t)}this._lastWrapInfoEvent.set(e)}},{key:"_fireEvent",value:function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._clip.eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e)){var i=t[e],n=this._targetNode.components,r=i.events,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,u=l.functionName,c=n,h=Array.isArray(c),f=0;for(c=h?c:c[Symbol.iterator]();;){var d;if(h){if(f>=c.length)break;d=c[f++]}else{if((f=c.next()).done)break;d=f.value}var _=d,p=_[u];"function"==typeof p&&p.apply(_,l.parameters)}}}}}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),n}());function lO(e){return e-(0|e)==0&&(e-=1),0|e}function uO(e,r,c,h){var t,i,a,s,o,f=new r,d=new r,_=new r;return fo(e)((a=m((i=function(){function n(e,t,i){y(this,n),v(this,"dataPoint",a,this),v(this,"inTangent",s,this),v(this,"outTangent",o,this),this.dataPoint=e||new r,this.inTangent=t||new r,this.outTangent=i||new r}return l(n,[{key:"lerp",value:function(e,t,i){var n=this.dataPoint,r=e.dataPoint;d=c(d,this.outTangent,i),_=c(_,e.inTangent,i);var a=t*t*t,s=t*t,o=a-2*s+t,l=-2*a+3*s,u=a-s;return f=c(f,n,2*a-3*s+1),f=h(f,f,d,o),f=h(f,f,r,l),f=h(f,f,_,u)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),n}()).prototype,"dataPoint",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),s=m(i.prototype,"inTangent",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),o=m(i.prototype,"outTangent",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),t=i))||t}cc.AnimationState=oO;var cO=m4("CubicSplineVec2Value",uO("cc.CubicSplineVec2Value",Ii,Ii.multiplyScalar,Ii.scaleAndAdd));cc.CubicSplineVec2Value=cO;var hO=m4("CubicSplineVec3Value",uO("cc.CubicSplineVec3Value",Ni,Ni.multiplyScalar,Ni.scaleAndAdd));cc.CubicSplineVec3Value=hO;var fO=m4("CubicSplineVec4Value",uO("cc.CubicSplineVec4Value",Xi,Xi.multiplyScalar,Xi.scaleAndAdd));cc.CubicSplineVec4Value=fO;var dO=m4("CubicSplineQuatValue",uO("cc.CubicSplineQuatValue",fn,fn.multiplyScalar,fn.scaleAndAdd));cc.CubicSplineQuatValue=dO;var _O=m4("CubicSplineNumberValue",fo("cc.CubicSplineNumberValue")((rO=m((nO=function(){function n(e,t,i){y(this,n),v(this,"dataPoint",rO,this),v(this,"inTangent",aO,this),v(this,"outTangent",sO,this),this.dataPoint=e,this.inTangent=t,this.outTangent=i}return l(n,[{key:"lerp",value:function(e,t,i){var n=this.dataPoint,r=e.dataPoint,a=t*t*t,s=t*t;return n*(2*a-3*s+1)+this.outTangent*i*(a-2*s+t)+r*(-2*a+3*s)+e.inTangent*i*(a-s)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),n}()).prototype,"dataPoint",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aO=m(nO.prototype,"inTangent",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sO=m(nO.prototype,"outTangent",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iO=nO))||iO);cc.CubicSplineNumberValue=_O;var pO,vO,mO,yO,gO,bO,xO,SO,TO,wO,EO,AO,CO,kO,RO,OO=function(){function i(){var e;return y(this,i),(e=x(this,g(i).call(this)))._managedStates=[],e._fadings=[],e}return _(i,JR),l(i,[{key:"update",value:function(e){if(this.isPlaying&&!this.isPaused){for(var t=0;t<this._managedStates.length;++t){var i=this._managedStates[t].state;i&&(i.weight=0)}for(var n=1,r=this._fadings.length,a=0;a<this._fadings.length;++a){if(0===n){r=a;break}var s=this._fadings[a];s.easeTime+=e;var o=vi(s.easeTime/s.easeDuration),l=o*n;n*=1-o,s.target.state&&(s.target.state.weight+=l)}if(r!==this._fadings.length){for(var u=r;u<this._fadings.length;++u){var c=this._fadings[u];--c.target.reference,c.target.reference<=0&&(c.target.state&&c.target.state.stop(),fe(this._managedStates,c.target))}this._fadings.splice(r)}}}},{key:"crossFade",value:function(t,e){0===e&&this.clear();var i=this._managedStates.find(function(e){return e.state===t});i||(i={state:t,reference:0},t&&t.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:i})}},{key:"onPlay",value:function(){p(g(i.prototype),"onPlay",this).call(this),kx.getAnimationManager().addCrossFade(this)}},{key:"onPause",value:function(){p(g(i.prototype),"onPause",this).call(this),kx.getAnimationManager().removeCrossFade(this);for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.pause()}}},{key:"onResume",value:function(){p(g(i.prototype),"onResume",this).call(this),kx.getAnimationManager().addCrossFade(this);for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.resume()}}},{key:"onStop",value:function(){p(g(i.prototype),"onStop",this).call(this),kx.getAnimationManager().removeCrossFade(this),this.clear()}},{key:"clear",value:function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0}}]),i}();(RO=kO=kO||m4("EventType",{})).PLAY="play",RO.STOP="stop",RO.PAUSE="pause",RO.RESUME="resume",RO.LASTFRAME="lastframe",RO.FINISHED="finished",mt(kO);var MO,IO=m4("AnimationComponent",(pO=fo("cc.AnimationComponent"),vO=bo(99),mO=go("Components/Animation"),yO=_o({type:[WR]}),gO=_o({type:WR}),bO=_o({type:[WR]}),pO(xO=vO(xO=mo(xO=mO((CO=AO=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"playOnLoad",TO,c(t)),t._callbackTable=ke(!0),t._crossFade=new OO,t._nameToState=ke(!0),v(t,"_clips",wO,c(t)),v(t,"_defaultClip",EO,c(t)),t}return _(a,Tm),l(a,[{key:"onLoad",value:function(){this.clips=this._clips;for(var e=0,t=Object.keys(this._nameToState);e<t.length;e++){var i=t[e];this._nameToState[i].initialize(this.node)}}},{key:"start",value:function(){this.playOnLoad&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}},{key:"onEnable",value:function(){this._crossFade.resume()}},{key:"onDisable",value:function(){this._crossFade.pause()}},{key:"onDestroy",value:function(){this._crossFade.stop();for(var e=0,t=Object.keys(this._nameToState);e<t.length;e++){var i=t[e];this._nameToState[i].stop()}this._nameToState=ke(!0)}},{key:"play",value:function(e){if(!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)}},{key:"crossFade",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:.3,n=this._nameToState[e];n&&(this._crossFade.play(),this._crossFade.crossFade(n,i))}},{key:"pause",value:function(){this._crossFade.pause()}},{key:"resume",value:function(){this._crossFade.resume()}},{key:"stop",value:function(){this._crossFade.stop()}},{key:"getAnimationState",value:function(e){return this.getState(e)}},{key:"getState",value:function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null}},{key:"createState",value:function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)}},{key:"removeState",value:function(e){var t=this._nameToState[e];t&&(t.stop(),delete this._nameToState[e])}},{key:"addClip",value:function(e,t){return de(this._clips,e)||this._clips.push(e),this.createState(e,t)}},{key:"removeClip",value:function(t,e){for(var i,n=0,r=Object.keys(this._nameToState);n<r.length;n++){var a=r[n];if((i=this._nameToState[a]).clip===t)break}if(t===this._defaultClip){if(!e)return void P(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!e)return void P(3903);i.stop()}this._clips=this._clips.filter(function(e){return e!==t}),i&&delete this._nameToState[i.name]}},{key:"on",value:function(e,t,i){var n=cl.prototype.on.call(this,e,t,i);if("lastframe"===e)for(var r=0,a=Object.keys(this._nameToState);r<a.length;r++){var s=a[r];this._nameToState[s]._lastframeEventOn=!0}return n}},{key:"off",value:function(e,t,i){if("lastframe"===e)for(var n=this._nameToState,r=0,a=Object.keys(n);r<a.length;r++){n[a[r]]._lastframeEventOn=!1}cl.prototype.off.call(this,e,t,i)}},{key:"targetOff",value:function(e){}},{key:"once",value:function(e,t,i){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"_createState",value:function(e,t){return new oO(e,t)}},{key:"_doCreateState",value:function(e,t){var i=this._createState(e,t);return i._setEventTarget(this),this.node&&i.initialize(this.node),this._nameToState[i.name]=i}},{key:"_getStateByNameOrDefaultClip",value:function(e){if(!e){if(!this._defaultClip)return null;e=this._defaultClip.name}var t=this._nameToState[e];return t||null}},{key:"_removeStateOfAutomaticClip",value:function(e){for(var t in this._nameToState){var i=this._nameToState[t];FO(e,i.clip)&&(i.stop(),delete this._nameToState[t])}}},{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();var i=this._clips,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s&&this._removeStateOfAutomaticClip(s)}var o=e,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c;h&&this.createState(h)}var f=e.find(function(e){return FO(e,t._defaultClip)});this._defaultClip=f||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(t){(this._defaultClip=t)&&(0<=this._clips.findIndex(function(e){return FO(e,t)})||(this._clips.push(t),this.createState(t)))}}]),a}(),AO.EventType=kO,m((SO=CO).prototype,"clips",[yO],Object.getOwnPropertyDescriptor(SO.prototype,"clips"),SO.prototype),m(SO.prototype,"defaultClip",[gO],Object.getOwnPropertyDescriptor(SO.prototype,"defaultClip"),SO.prototype),TO=m(SO.prototype,"playOnLoad",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wO=m(SO.prototype,"_clips",[bO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),EO=m(SO.prototype,"_defaultClip",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xO=SO))||xO)||xO)||xO)||xO)),BO=IO.prototype,LO=BO.on,PO=BO.off;function FO(e,t){return e===t||!(!e||!t||e.name!==t.name&&e._uuid!==t._uuid)}Lc(IO,[ll,cl]),IO.prototype.on=LO,IO.prototype.off=PO,cc.AnimationComponent=IO;var zO=m4("SkeletalAnimationClip",fo("cc.SkeletalAnimationClip")(MO=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n)))).originalKeys=[],t.convertedData={},t._converted=!1,t}return _(a,WR),l(a,[{key:"getPropertyCurves",value:function(e){return this.hash,e.getComponent(cc.SkeletalAnimationComponent)?this._convertToSkeletalCurves(e):console.warn("skeletal clip in non-skeletal component"),p(g(a.prototype),"getPropertyCurves",this).call(this,e)}},{key:"_convertToSkeletalCurves",value:function(e){var a=this;if(!this._converted){var s={};this.curves.forEach(function(e){if(!e.valueAdapter&&ER(e.modifiers[0],AR)&&TR(e.modifiers[1])){var t=e.modifiers[0].path,i=s[t];i=i||(s[t]={props:{}});var n=e.modifiers[1];i.props[n]=e.data}}),this.convertedData=s,this.curves=[];for(var t=function(){var n=o[i],r=s[n]&&s[n].props;if(!r)return"continue";Object.defineProperty(r,"worldMatrix",{get:function(){if(!r._worldMatrix){var e=r.position,t=r.rotation,i=r.scale;a._convertToUniformSample(e),a._convertToUniformSample(t),a._convertToUniformSample(i),a._convertToWorldSpace(n,r)}return r._worldMatrix}})},i=0,o=Object.keys(s);i<o.length;i++)t();for(var n=new Array(Math.ceil(this.sample*this._duration/this.speed)+1),r=0;r<n.length;r++)n[r]=r;var l=[{modifiers:[new AR(""),new CR("cc.SkeletalAnimationComponent"),"frameID"],data:{keys:0,values:n,interpolate:!1}}];if(this.curves=l,this.originalKeys=this._keys,this._keys=[n.map(function(e,t){return t*a.speed/a.sample})],this._duration=this._keys[0][n.length-1],this._converted=!0,e)for(var u=e.getComponentsInChildren(Pk),c=0;c<u.length;++c){var h=u[c];if(h.skinningRoot===e&&h.skeleton){var f=h.skeleton.joints,d=Array.isArray(f),_=0;for(f=d?f:f[Symbol.iterator]();;){var p;if(d){if(_>=f.length)break;p=f[_++]}else{if((_=f.next()).done)break;p=_.value}var v=s[p];v&&v.props&&v.props.worldMatrix}}}}}},{key:"_convertToUniformSample",value:function(e){var t=this.originalKeys[e.keys];e.keys=0;var i=this._keys[0].length,n=[];if(t&&1!==t.length)for(var r=0,a=0;r<i;r++){for(var s=r*this.speed/this.sample;t[a]<=s;)a++;a>t.length-1?s=t[a=t.length-1]:0===a&&(a=1);var o=e.values[a-1].clone();o.lerp(e.values[a],(s-t[a-1])/(t[a]-t[a-1])),n[r]=o}else for(var l=0;l<i;l++)n[l]=e.values[0].clone();e.values=n}},{key:"_convertToWorldSpace",value:function(e,t){var i=t.position.values,n=t.rotation.values,r=t.scale.values,a=i.map(function(){return new Pn}),s=e.lastIndexOf("/"),o=null;if(0<s){var l=e.substring(0,s),u=this.convertedData[l];if(!u||!u.props)return void console.warn("no data for parent bone?");o=u.props.worldMatrix.values}for(var c=0;c<i.length;c++){var h=i[c],f=n[c],d=r[c],_=a[c];Pn.fromRTS(_,f,h,d),o&&Pn.multiply(_,o[c],_)}Object.keys(t).forEach(function(e){return delete t[e]}),t._worldMatrix={keys:0,interpolate:!1,values:a}}}]),a}())||MO);cc.SkeletalAnimationClip=zO;var DO=new Pn;function NO(e,t){for(var i=e,n="";null!==i&&i!==t;)n="".concat(i.name,"/").concat(n),i=i.parent;return n.slice(0,-1)}function UO(e,t,i){for(Pn.identity(i);e!==t;)Pn.fromRTS(DO,e.rotation,e.position,e.scale),Pn.multiply(i,DO,i),e=e.parent}var VO=new Pn;var GO,HO,WO,qO,jO,XO,YO,KO,QO,ZO,JO,$O,eM,tM,iM,nM,rM=m4("SkeletalAnimationState",function(){function n(){return y(this,n),x(this,g(n).apply(this,arguments))}return _(n,oO),l(n,[{key:"onPlay",value:function(){p(g(n.prototype),"onPlay",this).call(this);for(var e=this._targetNode.getComponentsInChildren(Pk),t=0;t<e.length;++t){var i=e[t];i.skinningRoot===this._targetNode&&i.uploadAnimation(this.clip)}}},{key:"rebuildSocketCurves",value:function(e){if(this._samplerSharedGroups.length){for(var t,i=this._samplerSharedGroups[0].curves,n=0;n<i.length;n++){var r=i[n].curveDetail;3===(t=r.modifiers).length&&t[0]instanceof AR&&t[1]instanceof CR&&"frameID"===t[2]||i.splice(n--,1)}for(var a=0;a<e.length;++a){var s=this._buildSocketData(e[a]);s&&i.push(s)}}}},{key:"_buildSocketData",value:function(e){if(!this._targetNode)return null;var t=this._targetNode,i=t.getChildByPath(e.path);if(!i||!e.target)return null;for(var n=e.path,r=this.clip.convertedData,a=n,s=r[a],o=i;!s||!s.props;){var l=a.lastIndexOf("/");if(s=r[a=a.substring(0,l)],o=o.parent,l<0)return null}var u={matrix:{keys:0,interpolate:!1,values:s.props.worldMatrix.values.map(function(e){return e.clone()})}},c=u.matrix.values;UO(i,o,VO);for(var h=0;h<c.length;h++){var f=c[h];Pn.multiply(f,f,VO)}var d=this.clip.duration,_=new AR;return new tO({curve:new cR(u.matrix,d),modifiers:[_,"matrix"]},e.target)}}]),n}());cc.SkeletalAnimationState=rM;var aM=m4("Socket",(GO=fo("cc.SkeletalAnimationComponent.Socket"),HO=_o(cy),GO((jO=m((qO=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;y(this,e),v(this,"path",jO,this),v(this,"target",XO,this),this.path=t,this.target=i}).prototype,"path",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),XO=m(qO.prototype,"target",[HO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WO=qO))||WO)),sM=new Pn;function oM(e,t,i){for(var n=1<arguments.length&&void 0!==t?t:"",r=2<arguments.length&&void 0!==i?i:[],a=0;a<e.children.length;a++){var s=e.children[a];if(s){var o=n?"".concat(n,"/").concat(s.name):s.name;r.push(o),oM(s,o,r)}}return r}var lM,uM,cM,hM,fM=m4("SkeletalAnimationComponent",(YO=fo("cc.SkeletalAnimationComponent"),KO=bo(99),QO=go("Components/SkeletalAnimation"),ZO=_o({type:[aM]}),JO=_o({type:[aM]}),YO($O=KO($O=mo($O=QO((nM=iM=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_sockets",tM,c(t)),t._animInfo=null,t}return _(a,IO),l(a,[{key:"onLoad",value:function(){p(g(a.prototype),"onLoad",this).call(this),this._animInfo=Wf.create(this.node.uuid)}},{key:"onDestroy",value:function(){this._animInfo&&(Wf.destroy(this.node.uuid),this._animInfo=null),p(g(a.prototype),"onDestroy",this).call(this)}},{key:"start",value:function(){p(g(a.prototype),"start",this).call(this),this.sockets=this._sockets}},{key:"querySockets",value:function(){var e=this._defaultClip&&Object.keys(this._defaultClip.convertedData).sort().reduce(function(e,t){return t.startsWith(e[e.length-1])||e.push(t),e},[])||[];if(!e.length)return["default animation clip missing/invalid"];for(var t=[],i=0;i<e.length;i++){var n=e[i],r=this.node.getChildByPath(n);r&&(t.push(n),oM(r,n,t))}return t}},{key:"rebuildSocketAnimations",value:function(){var e=this._sockets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=this.node.getChildByPath(r.path),s=r.target;a&&s&&(s.name="".concat(r.path.substring(r.path.lastIndexOf("/")+1)," Socket"),s.parent=this.node,UO(a,this.node,sM),s.matrix=sM)}for(var o=0,l=Object.keys(this._nameToState);o<l.length;o++){var u=l[o];this._nameToState[u].rebuildSocketCurves(this._sockets)}}},{key:"createSocket",value:function(t){var e=this._sockets.find(function(e){return e.path===t});if(e)return e.target;if(!this.node.getChildByPath(t))return console.warn("illegal socket path"),null;var i=new cy;return i.parent=this.node,this._sockets.push(new aM(t,i)),this.rebuildSocketAnimations(),i}},{key:"_createState",value:function(e,t){return new rM(e,t)}},{key:"_doCreateState",value:function(e,t){e instanceof zO||console.warn("non-skeletal clip in skeletal component");var i=p(g(a.prototype),"_doCreateState",this).call(this,e,t);return i.rebuildSocketCurves(this._sockets),i}},{key:"sockets",get:function(){return this._sockets},set:function(e){this._sockets=e,this.rebuildSocketAnimations()}},{key:"frameID",set:function(e){if(this._animInfo){var t=this._animInfo,i=t.data,n=t.buffer;i[1]=e,n.update(i)}},get:function(){return this._animInfo&&this._animInfo.data[1]||0}}]),a}(),iM.Socket=aM,tM=m((eM=nM).prototype,"_sockets",[ZO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),m(eM.prototype,"sockets",[JO],Object.getOwnPropertyDescriptor(eM.prototype,"sockets"),eM.prototype),$O=eM))||$O)||$O)||$O)||$O));cc.SkeletalAnimationComponent=fM;var dM,_M=m4("UniformCurveValueAdapter",fo("cc.UniformCurveValueAdapter")((cM=m((uM=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"passIndex",cM,c(t)),v(t,"uniformName",hM,c(t)),t}return _(a,hR),l(a,[{key:"forTarget",value:function(e){var i=e.passes[this.passIndex],t=i.getHandle(this.uniformName);if(void 0===t)throw new Error('Material "'.concat(e.name,'" has no uniform "').concat(this.uniformName,'"'));var n=__.getBindingTypeFromHandle(t);if(n===Yu.UNIFORM_BUFFER)return function(e,t){var i=e.shaderInfo.blocks,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a.members,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if(o){if(l>=s.length)break;u=s[l++]}else{if((l=s.next()).done)break;u=l.value}var c=u;if(c.name===t)return 1<c.count}}return!1}(i,this.uniformName)?{set:function(e){i.setUniformArray(t,e)}}:{set:function(e){i.setUniform(t,e)}};if(n!==Yu.SAMPLER)throw new Error("Animations are not avaiable for uniforms with binding type ".concat(n,"."));var r=__.getBindingFromHandle(t),a=i.properties[this.uniformName],s=a&&a.value?a.value+"-texture":h_[a.type],o=t_.get(s);return o||(console.warn("illegal texture default value: "+s),o=t_.get("default-texture")),{set:function(e){var t=(e=e||o).getGFXTextureView();t&&t.texture.width&&t.texture.height&&(i.bindTextureView(r,t),e instanceof Mh&&i.bindSampler(r,Rh.getSampler(cc.game._gfxDevice,e.getSamplerHash())))}}}}]),a}()).prototype,"passIndex",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hM=m(uM.prototype,"uniformName",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),lM=uM))||lM);cc.UniformCurveValueAdapter=_M,or(IO.prototype,"AnimationComponent",[{name:"getAnimationState",newName:"getState"},{name:"removeClip",newName:"removeState",customFunction:function(e){var t=arguments.length<=0?void 0:e;return IO.prototype.removeState.call(this,t.name)}}]),cc.easing=hp;var pM,vM=fo("cc.Counter")(dM=function(){function n(e,t,i){y(this,n),this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=e,this._opts=t,this._accumStart=i}return l(n,[{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),l(n,[{key:"sample",value:function(e){this._average(this._value,e)}},{key:"human",value:function(e){var t=!(0<arguments.length&&void 0!==e)||e,i=this._opts.average?this._averageValue:this._value;return t?Math.round(100*i)/100:Math.round(i)}},{key:"alarm",value:function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over}},{key:"_average",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:0;if(this._opts.average){this._accumValue+=e,++this._accumSamples;var n=i;n-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=n,this._accumSamples=0)}}}]),n}())||dM,mM=fo("cc.PerfCounter")(pM=function(){function r(e,t,i){var n;return y(this,r),(n=x(this,g(r).call(this,e,t,i)))._time=void 0,n._time=i,n}return _(r,vM),l(r,[{key:"start",value:function(e){var t=0<arguments.length&&void 0!==e?e:0;this._time=t}},{key:"end",value:function(e){var t=0<arguments.length&&void 0!==e?e:0;this._value=t-this._time,this._average(this._value)}},{key:"tick",value:function(){this.end(),this.start()}},{key:"frame",value:function(e){var t=e,i=t-this._time;this._total++,(this._opts.average||1e3)<i&&(this._value=1e3*this._total/i,this._total=0,this._time=t,this._average(this._value))}}]),r}())||pM,yM=m4("Profiler",function(){function e(){y(this,e),this._stats=null,this._showFPS=!1,this._fontSize=22,this._lineHeight=this._fontSize+2,this._left=10,this._right=10,this._top=10,this._bottom=10,this._rootNode=null,this._device=null,this._canvas=null,this._ctx=null,this._texture=null,this._textureView=null,this._region=new bc,this._canvasArr=[],this._regionArr=[this._region],this._canvasDone=!1,this._statsDone=!1,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._region=new bc,this._canvasArr.push(this._canvas)}return l(e,[{key:"isShowingStats",value:function(){return this._showFPS}},{key:"hideStats",value:function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),kx.off(Cx.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),kx.off(Cx.EVENT_AFTER_UPDATE,this.afterUpdate,this),kx.off(Cx.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),kx.off(Cx.EVENT_AFTER_PHYSICS,this.afterPhysics,this),kx.off(Cx.EVENT_BEFORE_DRAW,this.beforeDraw,this),kx.off(Cx.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1)}},{key:"showStats",value:function(){this._showFPS||(this.initDevice(),this.generateCanvas(),this.generateStats(),this._rootNode&&(this._rootNode.active=!0),kx.on(Cx.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),kx.on(Cx.EVENT_AFTER_UPDATE,this.afterUpdate,this),kx.on(Cx.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),kx.on(Cx.EVENT_AFTER_PHYSICS,this.afterPhysics,this),kx.on(Cx.EVENT_BEFORE_DRAW,this.beforeDraw,this),kx.on(Cx.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0)}},{key:"initDevice",value:function(){this._device||(this._device=kx.root.device)}},{key:"generateCanvas",value:function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=350,this._canvas.height=200,this._canvas.style.width="".concat(this._canvas.width),this._canvas.style.height="".concat(this._canvas.height),this._ctx.font="".concat(this._fontSize,"px Arial"),this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture({type:Fu.TEX2D,usage:Du.SAMPLED,format:ru.RGBA8,width:350,height:200,mipLevel:1}),this._textureView=this._device.createTextureView({texture:this._texture,type:Wu.TV2D,format:ru.RGBA8}),this._region.texExtent.width=350,this._region.texExtent.height=200)}}},{key:"generateStats",value:function(){if(!this._statsDone&&this._ctx){this._stats=null;var e=performance.now(),t={frame:{desc:"Frame time (ms)",min:0,max:50,average:500},fps:{desc:"Framerate (FPS)",below:30,average:500},draws:{desc:"Draw call"},tricount:{desc:"Triangle"},logic:{desc:"Game Logic (ms)",min:0,max:50,average:500,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:500},render:{desc:"Renderer (ms)",min:0,max:50,average:500,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}};this._ctx.textAlign="left";for(var i=0,n=0,r=Object.keys(t);n<r.length;n++){var a=r[n];this._ctx.fillText(t[a].desc,this._left,this._top+i*this._lineHeight),t[a].counter=new mM(a,t[a],e),i++}this._ctx.textAlign="end",this._stats=t}}},{key:"generateNode",value:function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new cy("PROFILER_NODE"),cc.game.addPersistRootNode(this._rootNode);var e=new cy("Profiler_Camera");e.setPosition(0,0,1),e.parent=this._rootNode;var t=e.addComponent("cc.CameraComponent");t.projection=_A.ProjectionType.ORTHO,t.near=0,t.far=0,t.orthoHeight=this._device.height,t.visibility=yf.BitMask.PROFILER,t.clearFlags=dc.DEPTH|dc.STENCIL,t.priority=1073741928;var i=new cy("Profiler_Root");i.parent=this._rootNode;var n=i.addComponent("cc.ModelComponent");n.mesh=Jf({positions:[-.35,-.2,0,-.35,.2,0,.35,.2,0,.35,-.2,0],indices:[0,2,1,0,3,2],uvs:[0,1,0,0,1,0,1,1]});var r=new F_;r.initialize({effectName:"util/profiler"}),r.setProperty("offset",new Xi(-.9,-.9,0,0));var a=r.passes[0],s=a.getBinding("mainTexture");a.bindTextureView(s,this._textureView),n.material=r,n.node.layer=yf.Enum.PROFILER}}},{key:"beforeUpdate",value:function(){if(this._stats){this.generateNode();var e=performance.now();this.getCounter("frame").end(e),this.getCounter("frame").start(e),this.getCounter("logic").start(e)}}},{key:"afterUpdate",value:function(){if(this._stats){var e=performance.now();kx.isPaused()?this.getCounter("frame").start(e):this.getCounter("logic").end(e)}}},{key:"beforePhysics",value:function(){if(this._stats){var e=performance.now();this.getCounter("physics").start(e)}}},{key:"afterPhysics",value:function(){if(this._stats){var e=performance.now();this.getCounter("physics").end(e)}}},{key:"beforeDraw",value:function(){if(this._stats){var e=performance.now();this.getCounter("render").start(e)}}},{key:"afterDraw",value:function(){if(this._stats&&this._ctx&&this._canvas){var e=performance.now();this.getCounter("fps").frame(e),this.getCounter("draws").value=this._device.numDrawCalls,this.getCounter("bufferMemory").value=this._device.memoryStatus.bufferSize/1048576,this.getCounter("textureMemory").value=this._device.memoryStatus.textureSize/1048576,this.getCounter("tricount").value=this._device.numTris,this.getCounter("render").end(e);var t=this._left+this._ctx.measureText("GFX Texture Mem(M)").width;this._ctx.clearRect(t,0,this._canvas.width-t,this._canvas.height);for(var i=0,n=0,r=Object.keys(this._stats);n<r.length;n++){var a=r[n],s=this._stats[a];s.counter.sample(e),this._ctx.fillText(s.counter.human(!("Framerate (FPS)"===s.desc)),this._canvas.width-this._right,this._top+i*this._lineHeight),i++}this._canvasArr[0]=this._canvas,this.updateTexture()}}},{key:"getCounter",value:function(e){return this._stats[e].counter}},{key:"updateTexture",value:function(){kx.root.device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}}]),e}()),gM=m4("profiler",new yM);cc.profiler=gM;var bM={};or(bM,"vmath",[{name:"vec2",newName:"Vec2",target:pr,targetName:"math"},{name:"vec3",newName:"Vec3",target:pr,targetName:"math"},{name:"vec4",newName:"Vec4",target:pr,targetName:"math"},{name:"quat",newName:"Quat",target:pr,targetName:"math"},{name:"mat3",newName:"Mat3",target:pr,targetName:"math"},{name:"mat4",newName:"Mat4",target:pr,targetName:"math"},{name:"color4",newName:"Color",target:pr,targetName:"math"},{name:"rect",newName:"Rect",target:pr,targetName:"math"},{name:"approx",newName:"approx",target:pr,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:pr,targetName:"math"},{name:"equals",newName:"equals",target:pr,targetName:"math"},{name:"clamp",newName:"clamp",target:pr,targetName:"math"},{name:"clamp01",newName:"clamp01",target:pr,targetName:"math"},{name:"lerp",newName:"lerp",target:pr,targetName:"math"},{name:"toRadian",newName:"toRadian",target:pr,targetName:"math"},{name:"toDegree",newName:"toDegree",target:pr,targetName:"math"},{name:"random",newName:"random",target:pr,targetName:"math"},{name:"randomRange",newName:"randomRange",target:pr,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:pr,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:pr,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:pr,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:pr,targetName:"math"},{name:"repeat",newName:"repeat",target:pr,targetName:"math"},{name:"pingPong",newName:"pingPong",target:pr,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:pr,targetName:"math"}]),cc.vmath=bM,or(uv.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:uv,targetName:"Scheduler"}]),cc.math=pr,cc.geometry=Gs;var xM,SM,TM,wM,EM=0,AM={},CM=function(e){if(void 0===AM[e]){var t=1<<EM;AM[e]=t,EM+=1}};(SM=xM=xM||{})[SM.OPAQUE=0]="OPAQUE",SM[SM.TRANSPARENT=1]="TRANSPARENT",SM[SM.OVERLAY=2]="OVERLAY",(wM=TM=TM||{})[wM.DEFAULT=1]="DEFAULT",wM[wM.FORWARD=2]="FORWARD",wM[wM.SHADOWCAST=4]="SHADOWCAST",or(rx.prototype,"RenderScene.prototype",[{name:"raycastUI",newName:"raycastUI2D"},{name:"raycastUINode",newName:"raycastUI2DNode"},{name:"raycast",newName:"raycastModels"}]);var kM={};lr(kM,"CameraVisFlags",[{name:"GENERAL"}]),or(kM,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:yf.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:yf.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:yf.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:yf.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:yf.BitMask,targetName:"UI_2D"}]),cc.CameraVisFlags=kM;var RM={};lr(RM,"VisibilityFlags",[{name:"GENERAL"}]),or(RM,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:yf.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:yf.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:yf.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:yf.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:yf.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:yf.Enum,targetName:"UI_2D"}]),cc.VisibilityFlags=RM;var OM=CM;cc.samplerLib=Rh;var MM=Object.freeze({addStage:OM,samplerLib:Rh,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var i=[],n=t.positions.length/3,r=0;r<n;++r)i.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&i.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&i.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&i.push(t.colors[3*r],t.uvs[3*r+1],t.colors[3*r+2]);var a=[];a.push({name:eu.ATTR_POSITION,format:ru.RGB32F}),t.normals&&a.push({name:eu.ATTR_NORMAL,format:ru.RGB32F}),t.uvs&&a.push({name:eu.ATTR_TEX_COORD,format:ru.RG32F}),t.colors&&a.push({name:eu.ATTR_COLOR,format:ru.RGB32F});var s=e.createBuffer({usage:su.VERTEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:4*i.length,stride:4*i.length/n});s.update(new Float32Array(i));var o=e.createBuffer({usage:su.INDEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:2*t.indices.length,stride:2});return o.update(new Uint16Array(t.indices)),e.createInputAssembler({attributes:a,vertexBuffers:[s],indexBuffer:o})},get RenderQueue(){return xM},get PassStage(){return TM},Pass:__,programLib:a_,Light:vv,Camera:Nv,Model:Hf,SkinningModel:Kf,TextureBufferPool:Id,get JointsMediumType(){return Od},selectJointsMediumType:Ld,JointsTexturePool:Jd});m4("renderer",MM);var IM,BM,LM,PM,FM,zM,DM,NM,UM=m4("NodePool",function(){function t(e){y(this,t),this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}return l(t,[{key:"size",value:function(){return this._pool.length}},{key:"clear",value:function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0}},{key:"put",value:function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}}},{key:"get",value:function(){var e=this._pool.length-1;if(e<0)return null;var t=this._pool[e];this._pool.length=e;var i=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;if(i&&i.reuse){for(var n,r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];(n=i.reuse).apply.apply(n,[i].concat(a))}return t}}]),t}());cc.NodePool=UM,(NM=DM=DM||{})[NM.BOX=0]="BOX",NM[NM.SPHERE=1]="SPHERE",NM[NM.CYLINDER=2]="CYLINDER",NM[NM.CONE=3]="CONE",NM[NM.CAPSULE=4]="CAPSULE",NM[NM.TORUS=5]="TORUS",NM[NM.PLANE=6]="PLANE",NM[NM.QUAD=7]="QUAD",mt(DM);var VM=m4("Primitive",(IM=fo("cc.Primitive"),BM=_o({type:DM}),IM((FM=m((PM=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"type",FM,c(t)),v(t,"info",zM,c(t)),t}return _(a,ff),l(a,[{key:"onLoaded",value:function(){Jf(qb[DM[this.type]](this.info),this)}}]),a}()).prototype,"type",[BM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return DM.BOX}}),zM=m(PM.prototype,"info",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),LM=PM))||LM));cc.Primitive=VM,cc.renderer=MM;m4("cclegacy",cc);cc.primitives=qb;var GM,HM,WM=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,jl.BINDING_LAYOUT)))._device=void 0,t._bindingUnits=[],t._isDirty=!1,t._device=e,t}return _(i,pc),l(i,[{key:"bindBuffer",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===Yu.UNIFORM_BUFFER?s.buffer!==t&&(s.buffer=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.UNIFORM_BUFFER."))}}},{key:"bindSampler",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===Yu.SAMPLER?s.sampler!==t&&(s.sampler=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.SAMPLER."))}}},{key:"bindTextureView",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===Yu.SAMPLER?s.texView!==t&&(s.texView=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.SAMPLER."))}}},{key:"getBindingUnit",value:function(e){var t=this._bindingUnits,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.binding===e)return a}return null}}]),i}(),qM=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuBindingLayout=null,t}return _(i,WM),l(i,[{key:"gpuBindingLayout",get:function(){return this._gpuBindingLayout}}]),l(i,[{key:"initialize",value:function(e){this._bindingUnits=new Array(e.bindings.length);for(var t=0;t<e.bindings.length;++t){var i=e.bindings[t];this._bindingUnits[t]={binding:i.binding,type:i.type,name:i.name,buffer:null,texView:null,sampler:null}}this._gpuBindingLayout={gpuBindings:new Array(e.bindings.length)};for(var n=0;n<e.bindings.length;++n){var r=e.bindings[n];this._gpuBindingLayout.gpuBindings[n]={binding:r.binding,type:r.type,name:r.name,gpuBuffer:null,gpuTexView:null,gpuSampler:null}}return this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBindingLayout=null,this._status=Yl.UNREADY}},{key:"update",value:function(){if(this._isDirty&&this._gpuBindingLayout){for(var e=0;e<this._bindingUnits.length;++e){var t=this._bindingUnits[e];switch(t.type){case Yu.UNIFORM_BUFFER:t.buffer&&(this._gpuBindingLayout.gpuBindings[e].gpuBuffer=t.buffer.gpuBuffer);break;case Yu.SAMPLER:t.texView&&(this._gpuBindingLayout.gpuBindings[e].gpuTexView=t.texView.gpuTextureView),t.sampler&&(this._gpuBindingLayout.gpuBindings[e].gpuSampler=t.sampler.gpuSampler)}}this._isDirty=!1}}}]),i}();function jM(e,t){switch(e){case ru.R8:return t.UNSIGNED_BYTE;case ru.R8SN:return t.BYTE;case ru.R8UI:return t.UNSIGNED_BYTE;case ru.R8I:return t.BYTE;case ru.R16F:return GM.HALF_FLOAT_OES;case ru.R16UI:return t.UNSIGNED_SHORT;case ru.R16I:return t.SHORT;case ru.R32F:return t.FLOAT;case ru.R32UI:return t.UNSIGNED_INT;case ru.R32I:return t.INT;case ru.RG8:return t.UNSIGNED_BYTE;case ru.RG8SN:return t.BYTE;case ru.RG8UI:return t.UNSIGNED_BYTE;case ru.RG8I:return t.BYTE;case ru.RG16F:return GM.HALF_FLOAT_OES;case ru.RG16UI:return t.UNSIGNED_SHORT;case ru.RG16I:return t.SHORT;case ru.RG32F:return t.FLOAT;case ru.RG32UI:return t.UNSIGNED_INT;case ru.RG32I:return t.INT;case ru.RGB8:case ru.SRGB8:return t.UNSIGNED_BYTE;case ru.RGB8SN:return t.BYTE;case ru.RGB8UI:return t.UNSIGNED_BYTE;case ru.RGB8I:return t.BYTE;case ru.RGB16F:return GM.HALF_FLOAT_OES;case ru.RGB16UI:return t.UNSIGNED_SHORT;case ru.RGB16I:return t.SHORT;case ru.RGB32F:return t.FLOAT;case ru.RGB32UI:return t.UNSIGNED_INT;case ru.RGB32I:return t.INT;case ru.RGBA8:case ru.SRGB8_A8:return t.UNSIGNED_BYTE;case ru.RGBA8SN:return t.BYTE;case ru.RGBA8UI:return t.UNSIGNED_BYTE;case ru.RGBA8I:return t.BYTE;case ru.RGBA16F:return GM.HALF_FLOAT_OES;case ru.RGBA16UI:return t.UNSIGNED_SHORT;case ru.RGBA16I:return t.SHORT;case ru.RGBA32F:return t.FLOAT;case ru.RGBA32UI:return t.UNSIGNED_INT;case ru.RGBA32I:return t.INT;case ru.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case ru.R11G11B10F:return t.FLOAT;case ru.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case ru.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case ru.RGB10A2:return t.UNSIGNED_BYTE;case ru.RGB10A2UI:return t.UNSIGNED_INT;case ru.RGB9E5:return t.UNSIGNED_BYTE;case ru.D16:case ru.D16S8:return t.UNSIGNED_SHORT;case ru.D24:return t.UNSIGNED_INT;case ru.D24S8:return GM.UNSIGNED_INT_24_8_WEBGL;case ru.D32F:case ru.D32F_S8:return t.FLOAT;case ru.BC1:case ru.BC1_SRGB:case ru.BC2:case ru.BC2_SRGB:case ru.BC3:case ru.BC3_SRGB:case ru.BC4:return t.UNSIGNED_BYTE;case ru.BC4_SNORM:return t.BYTE;case ru.BC5:return t.UNSIGNED_BYTE;case ru.BC5_SNORM:return t.BYTE;case ru.BC6H_SF16:case ru.BC6H_UF16:return t.FLOAT;case ru.BC7:case ru.BC7_SRGB:case ru.ETC_RGB8:case ru.ETC2_RGB8:case ru.ETC2_SRGB8:case ru.ETC2_RGB8_A1:case ru.ETC2_SRGB8_A1:case ru.ETC2_RGB8:case ru.ETC2_SRGB8:case ru.EAC_R11:return t.UNSIGNED_BYTE;case ru.EAC_R11SN:return t.BYTE;case ru.EAC_RG11:return t.UNSIGNED_BYTE;case ru.EAC_RG11SN:return t.BYTE;case ru.PVRTC_RGB2:case ru.PVRTC_RGBA2:case ru.PVRTC_RGB4:case ru.PVRTC_RGBA4:case ru.PVRTC2_2BPP:case ru.PVRTC2_4BPP:default:return t.UNSIGNED_BYTE}}function XM(e,t){switch(e){case ru.A8:return t.ALPHA;case ru.L8:return t.LUMINANCE;case ru.LA8:return t.LUMINANCE_ALPHA;case ru.RGB8:case ru.RGB16F:case ru.RGB32F:return t.RGB;case ru.RGBA8:case ru.RGBA16F:case ru.RGBA32F:return t.RGBA;case ru.R5G6B5:return t.RGB565;case ru.RGB5A1:return t.RGB5_A1;case ru.RGBA4:return t.RGBA4;case ru.D16:return t.DEPTH_COMPONENT;case ru.D16S8:return t.DEPTH_STENCIL;case ru.D24:return t.DEPTH_COMPONENT;case ru.D24S8:return t.DEPTH_STENCIL;case ru.D32F:return t.DEPTH_COMPONENT;case ru.D32F_S8:return t.DEPTH_STENCIL;case ru.BC1:return GM.COMPRESSED_RGB_S3TC_DXT1_EXT;case ru.BC1_ALPHA:return GM.COMPRESSED_RGBA_S3TC_DXT1_EXT;case ru.BC1_SRGB:return GM.COMPRESSED_SRGB_S3TC_DXT1_EXT;case ru.BC1_SRGB_ALPHA:return GM.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case ru.BC2:return GM.COMPRESSED_RGBA_S3TC_DXT3_EXT;case ru.BC2_SRGB:return GM.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case ru.BC3:return GM.COMPRESSED_RGBA_S3TC_DXT5_EXT;case ru.BC3_SRGB:return GM.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case ru.ETC_RGB8:return GM.COMPRESSED_RGB_ETC1_WEBGL;case ru.PVRTC_RGB2:return GM.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case ru.PVRTC_RGBA2:return GM.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case ru.PVRTC_RGB4:return GM.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case ru.PVRTC_RGBA4:return GM.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL internal format failed."),t.RGBA}}function YM(e,t){switch(e){case ru.A8:return t.ALPHA;case ru.L8:return t.LUMINANCE;case ru.LA8:return t.LUMINANCE_ALPHA;case ru.RGB8:case ru.RGB16F:case ru.RGB32F:return t.RGB;case ru.RGBA8:case ru.RGBA16F:case ru.RGBA32F:return t.RGBA;case ru.R5G6B5:return t.RGB;case ru.RGB5A1:case ru.RGBA4:return t.RGBA;case ru.D16:return t.DEPTH_COMPONENT;case ru.D16S8:return t.DEPTH_STENCIL;case ru.D24:return t.DEPTH_COMPONENT;case ru.D24S8:return t.DEPTH_STENCIL;case ru.D32F:return t.DEPTH_COMPONENT;case ru.D32F_S8:return t.DEPTH_STENCIL;case ru.BC1:return GM.COMPRESSED_RGB_S3TC_DXT1_EXT;case ru.BC1_ALPHA:return GM.COMPRESSED_RGBA_S3TC_DXT1_EXT;case ru.BC1_SRGB:return GM.COMPRESSED_SRGB_S3TC_DXT1_EXT;case ru.BC1_SRGB_ALPHA:return GM.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case ru.BC2:return GM.COMPRESSED_RGBA_S3TC_DXT3_EXT;case ru.BC2_SRGB:return GM.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case ru.BC3:return GM.COMPRESSED_RGBA_S3TC_DXT5_EXT;case ru.BC3_SRGB:return GM.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case ru.ETC_RGB8:return GM.COMPRESSED_RGB_ETC1_WEBGL;case ru.ETC2_RGB8:return GM.COMPRESSED_RGB8_ETC2;case ru.ETC2_SRGB8:return GM.COMPRESSED_SRGB8_ETC2;case ru.ETC2_RGB8_A1:return GM.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ru.ETC2_SRGB8_A1:return GM.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ru.ETC2_RGBA8:return GM.COMPRESSED_RGBA8_ETC2_EAC;case ru.ETC2_SRGB8_A8:return GM.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case ru.EAC_R11:return GM.COMPRESSED_R11_EAC;case ru.EAC_R11SN:return GM.COMPRESSED_SIGNED_R11_EAC;case ru.EAC_RG11:return GM.COMPRESSED_RG11_EAC;case ru.EAC_RG11SN:return GM.COMPRESSED_SIGNED_RG11_EAC;case ru.PVRTC_RGB2:return GM.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case ru.PVRTC_RGBA2:return GM.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case ru.PVRTC_RGB4:return GM.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case ru.PVRTC_RGBA4:return GM.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL format failed."),t.RGBA}}function KM(e,t){switch(e){case iu.BOOL:return t.BOOL;case iu.BOOL2:return t.BOOL_VEC2;case iu.BOOL3:return t.BOOL_VEC3;case iu.BOOL4:return t.BOOL_VEC4;case iu.INT:return t.INT;case iu.INT2:return t.INT_VEC2;case iu.INT3:return t.INT_VEC3;case iu.INT4:return t.INT_VEC4;case iu.UINT:return t.UNSIGNED_INT;case iu.FLOAT:return t.FLOAT;case iu.FLOAT2:return t.FLOAT_VEC2;case iu.FLOAT3:return t.FLOAT_VEC3;case iu.FLOAT4:return t.FLOAT_VEC4;case iu.MAT2:return t.FLOAT_MAT2;case iu.MAT3:return t.FLOAT_MAT3;case iu.MAT4:return t.FLOAT_MAT4;case iu.SAMPLER2D:return t.SAMPLER_2D;case iu.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),iu.UNKNOWN}}function QM(e,t){switch(e){case t.BOOL:return iu.BOOL;case t.BOOL_VEC2:return iu.BOOL2;case t.BOOL_VEC3:return iu.BOOL3;case t.BOOL_VEC4:return iu.BOOL4;case t.INT:return iu.INT;case t.INT_VEC2:return iu.INT2;case t.INT_VEC3:return iu.INT3;case t.INT_VEC4:return iu.INT4;case t.UNSIGNED_INT:return iu.UINT;case t.FLOAT:return iu.FLOAT;case t.FLOAT_VEC2:return iu.FLOAT2;case t.FLOAT_VEC3:return iu.FLOAT3;case t.FLOAT_VEC4:return iu.FLOAT4;case t.FLOAT_MAT2:return iu.MAT2;case t.FLOAT_MAT3:return iu.MAT3;case t.FLOAT_MAT4:return iu.MAT4;case t.SAMPLER_2D:return iu.SAMPLER2D;case t.SAMPLER_CUBE:return iu.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GFXType failed."),iu.UNKNOWN}}function ZM(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function JM(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}(HM=GM=GM||{})[HM.RGBA16F_EXT=34842]="RGBA16F_EXT",HM[HM.RGB16F_EXT=34843]="RGB16F_EXT",HM[HM.RGBA32F_EXT=34836]="RGBA32F_EXT",HM[HM.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",HM[HM.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",HM[HM.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",HM[HM.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",HM[HM.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",HM[HM.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",HM[HM.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",HM[HM.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",HM[HM.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",HM[HM.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",HM[HM.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",HM[HM.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",HM[HM.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",HM[HM.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",HM[HM.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",HM[HM.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",HM[HM.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",HM[HM.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",HM[HM.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",HM[HM.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",HM[HM.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",HM[HM.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",HM[HM.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",HM[HM.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",HM[HM.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",HM[HM.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",HM[HM.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC";var $M,eI,tI=[512,513,514,515,516,517,518,519],iI=[0,7680,7681,7682,7683,5386,34055,34056],nI=[32774,32778,32779,32774,32774],rI=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];(eI=$M=$M||{})[eI.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",eI[eI.END_RENDER_PASS=1]="END_RENDER_PASS",eI[eI.BIND_STATES=2]="BIND_STATES",eI[eI.DRAW=3]="DRAW",eI[eI.UPDATE_BUFFER=4]="UPDATE_BUFFER",eI[eI.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",eI[eI.COUNT=6]="COUNT";function aI(e){y(this,aI),this.cmdType=void 0,this.refCount=0,this.cmdType=e}var sI=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,$M.BEGIN_RENDER_PASS))).gpuFramebuffer=null,e.renderArea={x:0,y:0,width:0,height:0},e.clearFlag=dc.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return _(t,aI),l(t,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors=[]}}]),t}(),oI=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,$M.BIND_STATES))).gpuPipelineState=null,e.gpuBindingLayout=null,e.gpuInputAssembler=null,e.viewport=null,e.scissor=null,e.lineWidth=null,e.depthBias=null,e.blendConstants=null,e.depthBounds=null,e.stencilWriteMask=null,e.stencilCompareMask=null,e}return _(t,aI),l(t,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuBindingLayout=null,this.gpuInputAssembler=null,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants=null,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}]),t}(),lI=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,$M.DRAW))).drawInfo={vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0},e}return _(t,aI),l(t,[{key:"clear",value:function(){}}]),t}(),uI=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,$M.UPDATE_BUFFER))).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return _(t,aI),l(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),t}(),cI=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,$M.COPY_BUFFER_TO_TEXTURE))).gpuBuffer=null,e.gpuTexture=null,e.dstLayout=null,e.regions=[],e}return _(t,aI),l(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.gpuTexture=null,this.dstLayout=null,this.regions=[]}}]),t}(),hI=function(){function e(){y(this,e),this.cmds=new Ug(1),this.beginRenderPassCmds=new Ug(1),this.bindStatesCmds=new Ug(1),this.drawCmds=new Ug(1),this.updateBufferCmds=new Ug(1),this.copyBufferToTextureCmds=new Ug(1)}return l(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}]),e}();function fI(e,t,i,n,r){if(t.usage&su.UNIFORM)i instanceof Float32Array?t.vf32.set(i,n/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(i),n/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&su.INDIRECT)t.indirects=i.drawInfos;else{var a=i,s=e.gl,o=e.stateCache;switch(t.glTarget){case s.ARRAY_BUFFER:e.useVAO&&o.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case s.ELEMENT_ARRAY_BUFFER:e.useVAO&&o.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported GFXBufferType, update buffer failed.")}r===a.byteLength?s.bufferSubData(t.glTarget,n,a):s.bufferSubData(t.glTarget,n,a.slice(0,r))}}var dI=new Array($M.COUNT);function _I(e,t){for(var i=e.gl,n=e.stateCache,r=0;r<$M.COUNT;++r)dI[r]=0;for(var a,s,o,l=null,u=null,c=!1,h=null,f=i.TRIANGLES,d=0;d<t.cmds.length;++d){var _=t.cmds.array[d],p=dI[_]++;switch(_){case $M.BEGIN_RENDER_PASS:var v=t.beginRenderPassCmds.array[p],m=0;if(v.gpuFramebuffer){n.glFramebuffer!==v.gpuFramebuffer.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,v.gpuFramebuffer.glFramebuffer),n.glFramebuffer=v.gpuFramebuffer.glFramebuffer),n.viewport.left===v.renderArea.x&&n.viewport.top===v.renderArea.y&&n.viewport.width===v.renderArea.width&&n.viewport.height===v.renderArea.height||(i.viewport(v.renderArea.x,v.renderArea.y,v.renderArea.width,v.renderArea.height),n.viewport.left=v.renderArea.x,n.viewport.top=v.renderArea.y,n.viewport.width=v.renderArea.width,n.viewport.height=v.renderArea.height),n.scissorRect.x===v.renderArea.x&&n.scissorRect.y===v.renderArea.y&&n.scissorRect.width===v.renderArea.width&&n.scissorRect.height===v.renderArea.height||(i.scissor(v.renderArea.x,v.renderArea.y,v.renderArea.width,v.renderArea.height),n.scissorRect.x=v.renderArea.x,n.scissorRect.y=v.renderArea.y,n.scissorRect.width=v.renderArea.width,n.scissorRect.height=v.renderArea.height);var y=v.gpuFramebuffer.gpuRenderPass,g=v.clearColors.length;e.WEBGL_draw_buffers||(g=1);for(var b=0;b<g;++b){var x=y.colorAttachments[b];if(x.format!==ru.UNKNOWN)switch(x.loadOp){case Ju.LOAD:break;case Ju.CLEAR:if(v.clearFlag&dc.COLOR){n.bs.targets[0].blendColorMask!==Ou.ALL&&i.colorMask(!0,!0,!0,!0);var S=v.clearColors[0];i.clearColor(S.r,S.g,S.b,S.a),m|=i.COLOR_BUFFER_BIT}break;case Ju.DISCARD:}}if(y.depthStencilAttachment&&y.depthStencilAttachment.format!==ru.UNKNOWN){switch(y.depthStencilAttachment.depthLoadOp){case Ju.LOAD:break;case Ju.CLEAR:v.clearFlag&dc.DEPTH&&(n.dss.depthWrite||i.depthMask(!0),i.clearDepth(v.clearDepth),m|=i.DEPTH_BUFFER_BIT);break;case Ju.DISCARD:}if(xc[y.depthStencilAttachment.format].hasStencil)switch(y.depthStencilAttachment.stencilLoadOp){case Ju.LOAD:break;case Ju.CLEAR:v.clearFlag&dc.STENCIL&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,4294967295),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,4294967295),i.clearStencil(v.clearStencil),m|=i.STENCIL_BUFFER_BIT);break;case Ju.DISCARD:}}if(m&&i.clear(m),m&i.COLOR_BUFFER_BIT){var T=n.bs.targets[0].blendColorMask;if(T!==Ou.ALL){var w=(T&Ou.R)!==Ou.NONE,E=(T&Ou.G)!==Ou.NONE,A=(T&Ou.B)!==Ou.NONE,C=(T&Ou.A)!==Ou.NONE;i.colorMask(w,E,A,C)}}m&i.DEPTH_BUFFER_BIT&&!n.dss.depthWrite&&i.depthMask(!1),m&i.STENCIL_BUFFER_BIT&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,0),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,0))}break;case $M.BIND_STATES:var k=t.bindStatesCmds.array[p];if(c=!1,k.gpuPipelineState){if(l=k.gpuPipelineState,f=k.gpuPipelineState.glPrimitive,k.gpuPipelineState.gpuShader){var R=k.gpuPipelineState.gpuShader.glProgram;n.glProgram!==R&&(i.useProgram(R),n.glProgram=R,c=!0),u=k.gpuPipelineState.gpuShader}var O=k.gpuPipelineState.rs;if(O){if(n.rs.cullMode!==O.cullMode){switch(O.cullMode){case bu.NONE:i.disable(i.CULL_FACE);break;case bu.FRONT:i.enable(i.CULL_FACE),i.cullFace(i.FRONT);break;case bu.BACK:i.enable(i.CULL_FACE),i.cullFace(i.BACK)}n.rs.cullMode=O.cullMode}n.rs.isFrontFaceCCW!==O.isFrontFaceCCW&&(i.frontFace(O.isFrontFaceCCW?i.CCW:i.CW),n.rs.isFrontFaceCCW=O.isFrontFaceCCW),n.rs.depthBias===O.depthBias&&n.rs.depthBiasSlop===O.depthBiasSlop||(i.polygonOffset(O.depthBias,O.depthBiasSlop),n.rs.depthBias=O.depthBias,n.rs.depthBiasSlop=O.depthBiasSlop),n.rs.lineWidth!==O.lineWidth&&(i.lineWidth(O.lineWidth),n.rs.lineWidth=O.lineWidth)}var M=k.gpuPipelineState.dss;M&&(n.dss.depthTest!==M.depthTest&&(M.depthTest?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),n.dss.depthTest=M.depthTest),n.dss.depthWrite!==M.depthWrite&&(i.depthMask(M.depthWrite),n.dss.depthWrite=M.depthWrite),n.dss.depthFunc!==M.depthFunc&&(i.depthFunc(tI[M.depthFunc]),n.dss.depthFunc=M.depthFunc),n.dss.stencilTestFront===M.stencilTestFront&&n.dss.stencilTestBack===M.stencilTestBack||(M.stencilTestFront||M.stencilTestBack?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST),n.dss.stencilTestFront=M.stencilTestFront,n.dss.stencilTestBack=M.stencilTestBack),n.dss.stencilFuncFront===M.stencilFuncFront&&n.dss.stencilRefFront===M.stencilRefFront&&n.dss.stencilReadMaskFront===M.stencilReadMaskFront||(i.stencilFuncSeparate(i.FRONT,tI[M.stencilFuncFront],M.stencilRefFront,M.stencilReadMaskFront),n.dss.stencilFuncFront=M.stencilFuncFront,n.dss.stencilRefFront=M.stencilRefFront,n.dss.stencilReadMaskFront=M.stencilReadMaskFront),n.dss.stencilFailOpFront===M.stencilFailOpFront&&n.dss.stencilZFailOpFront===M.stencilZFailOpFront&&n.dss.stencilPassOpFront===M.stencilPassOpFront||(i.stencilOpSeparate(i.FRONT,iI[M.stencilFailOpFront],iI[M.stencilZFailOpFront],iI[M.stencilPassOpFront]),n.dss.stencilFailOpFront=M.stencilFailOpFront,n.dss.stencilZFailOpFront=M.stencilZFailOpFront,n.dss.stencilPassOpFront=M.stencilPassOpFront),n.dss.stencilWriteMaskFront!==M.stencilWriteMaskFront&&(i.stencilMaskSeparate(i.FRONT,M.stencilWriteMaskFront),n.dss.stencilWriteMaskFront=M.stencilWriteMaskFront),n.dss.stencilFuncBack===M.stencilFuncBack&&n.dss.stencilRefBack===M.stencilRefBack&&n.dss.stencilReadMaskBack===M.stencilReadMaskBack||(i.stencilFuncSeparate(i.BACK,tI[M.stencilFuncBack],M.stencilRefBack,M.stencilReadMaskBack),n.dss.stencilFuncBack=M.stencilFuncBack,n.dss.stencilRefBack=M.stencilRefBack,n.dss.stencilReadMaskBack=M.stencilReadMaskBack),n.dss.stencilFailOpBack===M.stencilFailOpBack&&n.dss.stencilZFailOpBack===M.stencilZFailOpBack&&n.dss.stencilPassOpBack===M.stencilPassOpBack||(i.stencilOpSeparate(i.BACK,iI[M.stencilFailOpBack],iI[M.stencilZFailOpBack],iI[M.stencilPassOpBack]),n.dss.stencilFailOpBack=M.stencilFailOpBack,n.dss.stencilZFailOpBack=M.stencilZFailOpBack,n.dss.stencilPassOpBack=M.stencilPassOpBack),n.dss.stencilWriteMaskBack!==M.stencilWriteMaskBack&&(i.stencilMaskSeparate(i.BACK,M.stencilWriteMaskBack),n.dss.stencilWriteMaskBack=M.stencilWriteMaskBack));var I=k.gpuPipelineState.bs;if(I){n.bs.isA2C!==I.isA2C&&(I.isA2C?i.enable(i.SAMPLE_ALPHA_TO_COVERAGE):i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),n.bs.isA2C=I.isA2C),n.bs.blendColor[0]===I.blendColor[0]&&n.bs.blendColor[1]===I.blendColor[1]&&n.bs.blendColor[2]===I.blendColor[2]&&n.bs.blendColor[3]===I.blendColor[3]||(i.blendColor(I.blendColor[0],I.blendColor[1],I.blendColor[2],I.blendColor[3]),n.bs.blendColor[0]=I.blendColor[0],n.bs.blendColor[1]=I.blendColor[1],n.bs.blendColor[2]=I.blendColor[2],n.bs.blendColor[3]=I.blendColor[3]);var B=I.targets[0],L=n.bs.targets[0];L.blend!==B.blend&&(B.blend?i.enable(i.BLEND):i.disable(i.BLEND),L.blend=B.blend),L.blendEq===B.blendEq&&L.blendAlphaEq===B.blendAlphaEq||(i.blendEquationSeparate(nI[B.blendEq],nI[B.blendAlphaEq]),L.blendEq=B.blendEq,L.blendAlphaEq=B.blendAlphaEq),L.blendSrc===B.blendSrc&&L.blendDst===B.blendDst&&L.blendSrcAlpha===B.blendSrcAlpha&&L.blendDstAlpha===B.blendDstAlpha||(i.blendFuncSeparate(rI[B.blendSrc],rI[B.blendDst],rI[B.blendSrcAlpha],rI[B.blendDstAlpha]),L.blendSrc=B.blendSrc,L.blendDst=B.blendDst,L.blendSrcAlpha=B.blendSrcAlpha,L.blendDstAlpha=B.blendDstAlpha),L.blendColorMask!==B.blendColorMask&&(i.colorMask((B.blendColorMask&Ou.R)!==Ou.NONE,(B.blendColorMask&Ou.G)!==Ou.NONE,(B.blendColorMask&Ou.B)!==Ou.NONE,(B.blendColorMask&Ou.A)!==Ou.NONE),L.blendColorMask=B.blendColorMask)}}if(k.gpuBindingLayout&&u)for(var P=k.gpuBindingLayout.gpuBindings.length,F=0;F<P;F++){var z=k.gpuBindingLayout.gpuBindings[F];switch(z.type){case Yu.UNIFORM_BUFFER:if(z.gpuBuffer&&z.gpuBuffer.buffer){for(var D=null,N=u.glBlocks.length,U=0;U<N;U++){var V=u.glBlocks[U];if(V.binding===z.binding){D=V;break}}if(D&&z.gpuBuffer.vf32)for(var G=D.glActiveUniforms.length,H=0;H<G;H++){var W=D.glActiveUniforms[H];switch(W.glType){case i.BOOL:case i.INT:for(var q=0;q<W.array.length;++q){var j=W.begin+q;if(z.gpuBuffer.vf32[j]!==W.array[q]){for(var X=q,Y=W.begin+q;X<W.array.length;++X,++Y)W.array[X]=z.gpuBuffer.vf32[Y];i.uniform1iv(W.glLoc,W.array);break}}break;case i.BOOL_VEC2:case i.INT_VEC2:for(var K=0;K<W.array.length;++K){var Q=W.begin+K;if(z.gpuBuffer.vf32[Q]!==W.array[K]){for(var Z=K,J=W.begin+K;Z<W.array.length;++Z,++J)W.array[Z]=z.gpuBuffer.vf32[J];i.uniform2iv(W.glLoc,W.array);break}}break;case i.BOOL_VEC3:case i.INT_VEC3:for(var $=0;$<W.array.length;++$){var ee=W.begin+$;if(z.gpuBuffer.vf32[ee]!==W.array[$]){for(var te=$,ie=W.begin+$;te<W.array.length;++te,++ie)W.array[te]=z.gpuBuffer.vf32[ie];i.uniform3iv(W.glLoc,W.array);break}}break;case i.BOOL_VEC4:case i.INT_VEC4:for(var ne=0;ne<W.array.length;++ne){var re=W.begin+ne;if(z.gpuBuffer.vf32[re]!==W.array[ne]){for(var ae=ne,se=W.begin+ne;ae<W.array.length;++ae,++se)W.array[ae]=z.gpuBuffer.vf32[se];i.uniform4iv(W.glLoc,W.array);break}}break;case i.FLOAT:for(var oe=0;oe<W.array.length;++oe){var le=W.begin+oe;if(z.gpuBuffer.vf32[le]!==W.array[oe]){for(var ue=oe,ce=W.begin+oe;ue<W.array.length;++ue,++ce)W.array[ue]=z.gpuBuffer.vf32[ce];i.uniform1fv(W.glLoc,W.array);break}}break;case i.FLOAT_VEC2:for(var he=0;he<W.array.length;++he){var fe=W.begin+he;if(z.gpuBuffer.vf32[fe]!==W.array[he]){for(var de=he,_e=W.begin+he;de<W.array.length;++de,++_e)W.array[de]=z.gpuBuffer.vf32[_e];i.uniform2fv(W.glLoc,W.array);break}}break;case i.FLOAT_VEC3:for(var pe=0;pe<W.array.length;++pe){var ve=W.begin+pe;if(z.gpuBuffer.vf32[ve]!==W.array[pe]){for(var me=pe,ye=W.begin+pe;me<W.array.length;++me,++ye)W.array[me]=z.gpuBuffer.vf32[ye];i.uniform3fv(W.glLoc,W.array);break}}break;case i.FLOAT_VEC4:for(var ge=0;ge<W.array.length;++ge){var be=W.begin+ge;if(z.gpuBuffer.vf32[be]!==W.array[ge]){for(var xe=ge,Se=W.begin+ge;xe<W.array.length;++xe,++Se)W.array[xe]=z.gpuBuffer.vf32[Se];i.uniform4fv(W.glLoc,W.array);break}}break;case i.FLOAT_MAT2:for(var Te=0;Te<W.array.length;++Te){var we=W.begin+Te;if(z.gpuBuffer.vf32[we]!==W.array[Te]){for(var Ee=Te,Ae=W.begin+Te;Ee<W.array.length;++Ee,++Ae)W.array[Ee]=z.gpuBuffer.vf32[Ae];i.uniformMatrix2fv(W.glLoc,!1,W.array);break}}break;case i.FLOAT_MAT3:for(var Ce=0;Ce<W.array.length;++Ce){var ke=W.begin+Ce;if(z.gpuBuffer.vf32[ke]!==W.array[Ce]){for(var Re=Ce,Oe=W.begin+Ce;Re<W.array.length;++Re,++Oe)W.array[Re]=z.gpuBuffer.vf32[Oe];i.uniformMatrix3fv(W.glLoc,!1,W.array);break}}break;case i.FLOAT_MAT4:for(var Me=0;Me<W.array.length;++Me){var Ie=W.begin+Me;if(z.gpuBuffer.vf32[Ie]!==W.array[Me]){for(var Be=Me,Le=W.begin+Me;Be<W.array.length;++Be,++Le)W.array[Be]=z.gpuBuffer.vf32[Le];i.uniformMatrix4fv(W.glLoc,!1,W.array);break}}}}}break;case Yu.SAMPLER:if(z.gpuSampler){for(var Pe=null,Fe=u.glSamplers.length,ze=0;ze<Fe;ze++){var De=u.glSamplers[ze];if(De.binding===z.binding){Pe=De;break}}if(Pe)for(var Ne=Pe.units.length,Ue=0;Ue<Ne;Ue++){var Ve=Pe.units[Ue];if(z.gpuTexView&&0<z.gpuTexView.gpuTexture.size){var Ge=z.gpuTexView.gpuTexture,He=n.glTexUnits[Ve];He.glTexture!==Ge.glTexture&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),Ge.glTexture?i.bindTexture(Ge.glTarget,Ge.glTexture):i.bindTexture(Ge.glTarget,e.nullTex2D.gpuTexture.glTexture),He.glTexture=Ge.glTexture);var We=z.gpuSampler;s=Ge.isPowerOf2?(a=We.glWrapS,We.glWrapT):(a=i.CLAMP_TO_EDGE,i.CLAMP_TO_EDGE),o=Ge.isPowerOf2?Ge.mipLevel<=1&&(We.glMinFilter===i.LINEAR_MIPMAP_NEAREST||We.glMinFilter===i.LINEAR_MIPMAP_LINEAR)?i.LINEAR:We.glMinFilter:We.glMinFilter===i.LINEAR||We.glMinFilter===i.LINEAR_MIPMAP_NEAREST||We.glMinFilter===i.LINEAR_MIPMAP_LINEAR?i.LINEAR:i.NEAREST,Ge.glWrapS!==a&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),i.texParameteri(Ge.glTarget,i.TEXTURE_WRAP_S,a),Ge.glWrapS=a),Ge.glWrapT!==s&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),i.texParameteri(Ge.glTarget,i.TEXTURE_WRAP_T,s),Ge.glWrapT=s),Ge.glMinFilter!==o&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),i.texParameteri(Ge.glTarget,i.TEXTURE_MIN_FILTER,o),Ge.glMinFilter=o),Ge.glMagFilter!==We.glMagFilter&&(n.texUnit!==Ve&&(i.activeTexture(i.TEXTURE0+Ve),n.texUnit=Ve),i.texParameteri(Ge.glTarget,i.TEXTURE_MAG_FILTER,We.glMagFilter),Ge.glMagFilter=We.glMagFilter)}}}else console.error("Not found sampler on binding unit "+z.binding)}}if(k.gpuInputAssembler&&u&&(c||h!==k.gpuInputAssembler))if(h=k.gpuInputAssembler,e.useVAO){var qe=e.OES_vertex_array_object,je=h.glVAOs.get(u.glProgram);if(!je){je=qe.createVertexArrayOES(),h.glVAOs.set(u.glProgram,je),qe.bindVertexArrayOES(je),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);for(var Xe=void 0,Ye=u.glInputs.length,Ke=0;Ke<Ye;Ke++){var Qe=u.glInputs[Ke];Xe=null;for(var Ze=h.glAttribs.length,Je=0;Je<Ze;Je++){var $e=h.glAttribs[Je];if($e.name===Qe.name){Xe=$e;break}}if(Xe){i.bindBuffer(i.ARRAY_BUFFER,Xe.glBuffer);for(var et=0;et<Xe.componentCount;++et){var tt=Qe.glLoc+et,it=Xe.offset+Xe.size*et;i.enableVertexAttribArray(tt),n.glCurrentAttribLocs[tt]=!0,i.vertexAttribPointer(tt,Xe.count,Xe.glType,Xe.isNormalized,Xe.stride,it)}}}var nt=h.gpuIndexBuffer;nt&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,nt.glBuffer),qe.bindVertexArrayOES(null),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),n.glArrayBuffer=null,n.glElementArrayBuffer=null}n.glVAO!==je&&(qe.bindVertexArrayOES(je),n.glVAO=je)}else{for(var rt=0;rt<e.maxVertexAttributes;++rt)n.glCurrentAttribLocs[rt]=!1;for(var at=u.glInputs.length,st=0;st<at;st++){for(var ot=u.glInputs[st],lt=null,ut=h.glAttribs.length,ct=0;ct<ut;ct++){var ht=h.glAttribs[ct];if(ht.name===ot.name){lt=ht;break}}if(lt){n.glArrayBuffer!==lt.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,lt.glBuffer),n.glArrayBuffer=lt.glBuffer);for(var ft=0;ft<lt.componentCount;++ft){var dt=ot.glLoc+ft,_t=lt.offset+lt.size*ft;!n.glEnabledAttribLocs[dt]&&0<=dt&&(i.enableVertexAttribArray(dt),n.glEnabledAttribLocs[dt]=!0),n.glCurrentAttribLocs[dt]=!0,i.vertexAttribPointer(dt,lt.count,lt.glType,lt.isNormalized,lt.stride,_t)}}}var pt=h.gpuIndexBuffer;pt&&n.glElementArrayBuffer!==pt.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,pt.glBuffer),n.glElementArrayBuffer=pt.glBuffer);for(var vt=0;vt<e.maxVertexAttributes;++vt)n.glEnabledAttribLocs[vt]!==n.glCurrentAttribLocs[vt]&&(i.disableVertexAttribArray(vt),n.glEnabledAttribLocs[vt]=!1)}if(l)for(var mt=l.dynamicStates.length,yt=0;yt<mt;yt++){switch(l.dynamicStates[yt]){case sc.VIEWPORT:k.viewport&&(n.viewport.left===k.viewport.left&&n.viewport.top===k.viewport.top&&n.viewport.width===k.viewport.width&&n.viewport.height===k.viewport.height||(i.viewport(k.viewport.left,k.viewport.top,k.viewport.width,k.viewport.height),n.viewport.left=k.viewport.left,n.viewport.top=k.viewport.top,n.viewport.width=k.viewport.width,n.viewport.height=k.viewport.height));break;case sc.SCISSOR:k.scissor&&(n.scissorRect.x===k.scissor.x&&n.scissorRect.y===k.scissor.y&&n.scissorRect.width===k.scissor.width&&n.scissorRect.height===k.scissor.height||(i.scissor(k.scissor.x,k.scissor.y,k.scissor.width,k.scissor.height),n.scissorRect.x=k.scissor.x,n.scissorRect.y=k.scissor.y,n.scissorRect.width=k.scissor.width,n.scissorRect.height=k.scissor.height));break;case sc.LINE_WIDTH:k.lineWidth&&n.rs.lineWidth!==k.lineWidth&&(i.lineWidth(k.lineWidth),n.rs.lineWidth=k.lineWidth);break;case sc.DEPTH_BIAS:k.depthBias&&(n.rs.depthBias===k.depthBias.constantFactor&&n.rs.depthBiasSlop===k.depthBias.slopeFactor||(i.polygonOffset(k.depthBias.constantFactor,k.depthBias.slopeFactor),n.rs.depthBias=k.depthBias.constantFactor,n.rs.depthBiasSlop=k.depthBias.slopeFactor));break;case sc.BLEND_CONSTANTS:k.blendConstants&&(n.bs.blendColor[0]===k.blendConstants[0]&&n.bs.blendColor[1]===k.blendConstants[1]&&n.bs.blendColor[2]===k.blendConstants[2]&&n.bs.blendColor[3]===k.blendConstants[3]||(i.blendColor(k.blendConstants[0],k.blendConstants[1],k.blendConstants[2],k.blendConstants[3]),n.bs.blendColor[0]=k.blendConstants[0],n.bs.blendColor[1]=k.blendConstants[1],n.bs.blendColor[2]=k.blendConstants[2],n.bs.blendColor[3]=k.blendConstants[3]));break;case sc.STENCIL_WRITE_MASK:if(k.stencilWriteMask)switch(k.stencilWriteMask.face){case lc.FRONT:n.dss.stencilWriteMaskFront!==k.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.FRONT,k.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=k.stencilWriteMask.writeMask);break;case lc.BACK:n.dss.stencilWriteMaskBack!==k.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.BACK,k.stencilWriteMask.writeMask),n.dss.stencilWriteMaskBack=k.stencilWriteMask.writeMask);break;case lc.ALL:n.dss.stencilWriteMaskFront===k.stencilWriteMask.writeMask&&n.dss.stencilWriteMaskBack===k.stencilWriteMask.writeMask||(i.stencilMask(k.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=k.stencilWriteMask.writeMask,n.dss.stencilWriteMaskBack=k.stencilWriteMask.writeMask)}break;case sc.STENCIL_COMPARE_MASK:if(k.stencilCompareMask)switch(k.stencilCompareMask.face){case lc.FRONT:n.dss.stencilRefFront===k.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===k.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.FRONT,tI[n.dss.stencilFuncFront],k.stencilCompareMask.reference,k.stencilCompareMask.compareMask),n.dss.stencilRefFront=k.stencilCompareMask.reference,n.dss.stencilReadMaskFront=k.stencilCompareMask.compareMask);break;case lc.BACK:n.dss.stencilRefBack===k.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===k.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.BACK,tI[n.dss.stencilFuncBack],k.stencilCompareMask.reference,k.stencilCompareMask.compareMask),n.dss.stencilRefBack=k.stencilCompareMask.reference,n.dss.stencilReadMaskBack=k.stencilCompareMask.compareMask);break;case lc.ALL:n.dss.stencilRefFront===k.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===k.stencilCompareMask.compareMask&&n.dss.stencilRefBack===k.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===k.stencilCompareMask.compareMask||(i.stencilFunc(tI[n.dss.stencilFuncBack],k.stencilCompareMask.reference,k.stencilCompareMask.compareMask),n.dss.stencilRefFront=k.stencilCompareMask.reference,n.dss.stencilReadMaskFront=k.stencilCompareMask.compareMask,n.dss.stencilRefBack=k.stencilCompareMask.reference,n.dss.stencilReadMaskBack=k.stencilCompareMask.compareMask)}}}break;case $M.DRAW:var gt=t.drawCmds.array[p];if(h&&u)if(h.gpuIndirectBuffer){if(h.gpuIndirectBuffer)for(var bt=h.gpuIndirectBuffer.indirects.length,xt=0;xt<bt;xt++){var St=h.gpuIndirectBuffer.indirects[xt],Tt=h.gpuIndexBuffer;if(Tt&&-1<St.indexCount){var wt=St.firstIndex*Tt.stride;i.drawElements(f,St.indexCount,h.glIndexType,wt)}else i.drawArrays(f,St.firstVertex,St.vertexCount)}}else{var Et=h.gpuIndexBuffer;if(Et&&-1<gt.drawInfo.indexCount){var At=gt.drawInfo.firstIndex*Et.stride;i.drawElements(f,gt.drawInfo.indexCount,h.glIndexType,At)}else i.drawArrays(f,gt.drawInfo.firstVertex,gt.drawInfo.vertexCount)}break;case $M.UPDATE_BUFFER:var Ct=t.updateBufferCmds.array[p];fI(e,Ct.gpuBuffer,Ct.buffer,Ct.offset,Ct.size);break;case $M.COPY_BUFFER_TO_TEXTURE:var kt=t.copyBufferToTextureCmds.array[p];pI(e,[kt.gpuBuffer.buffer],kt.gpuTexture,kt.regions)}}}function pI(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var s=0,o=0,l=1,u=1,c=0,h=xc[i.format],f=h.isCompressed;switch(i.glTarget){case r.TEXTURE_2D:var d=n,_=Array.isArray(d),p=0;for(d=_?d:d[Symbol.iterator]();;){var v;if(_){if(p>=d.length)break;v=d[p++]}else{if((p=d.next()).done)break;v=p.value}var m=v;for(l=m.texExtent.width,u=m.texExtent.height,s=m.texSubres.baseMipLevel;s<m.texSubres.levelCount;++s){var y=h.type!==vc.FLOAT||f?new Uint8Array(t[o++]):new Float32Array(t[o++]);f?i.glInternelFmt!==GM.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,s,m.texOffset.x,m.texOffset.y,l,u,i.glFormat,y):r.compressedTexImage2D(r.TEXTURE_2D,s,i.glInternelFmt,l,u,0,y):r.texSubImage2D(r.TEXTURE_2D,s,m.texOffset.x,m.texOffset.y,l,u,i.glFormat,i.glType,y),l=Math.max(1,l>>1),u=Math.max(1,l>>1)}}break;case r.TEXTURE_CUBE_MAP:var g=n,b=Array.isArray(g),x=0;for(g=b?g:g[Symbol.iterator]();;){var S;if(b){if(x>=g.length)break;S=g[x++]}else{if((x=g.next()).done)break;S=x.value}var T=S;o=0;var w=T.texSubres.baseArrayLayer+T.texSubres.layerCount;for(c=T.texSubres.baseArrayLayer;c<w;++c){l=T.texExtent.width,u=T.texExtent.height;var E=T.texSubres.baseMipLevel+T.texSubres.levelCount;for(s=T.texSubres.baseMipLevel;s<E;++s){var A=h.type!==vc.FLOAT||f?new Uint8Array(t[o++]):new Float32Array(t[o++]);f?i.glInternelFmt!==GM.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,T.texOffset.x,T.texOffset.y,l,u,i.glFormat,A):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,i.glInternelFmt,l,u,0,A):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,T.texOffset.x,T.texOffset.y,l,u,i.glFormat,i.glType,A),l=Math.max(1,l>>1),u=Math.max(1,l>>1)}}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Gu.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}function vI(){y(this,vI),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=void 0,this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=void 0,this.scissorRect=void 0,this.rs=void 0,this.dss=void 0,this.bs=void 0,this.glProgram=null,this.glEnabledAttribLocs=void 0,this.glCurrentAttribLocs=void 0,this.glTexUnits=new Array(Zl),this.viewport={left:0,top:0,width:0,height:0,minDepth:0,maxDepth:0},this.scissorRect={x:0,y:0,width:0,height:0},this.rs=new yd,this.dss=new gd,this.bs=new _d,this.glEnabledAttribLocs=new Array(Ql),this.glCurrentAttribLocs=new Array(Ql),this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.fill(!1);for(var e=0;e<Zl;++e)this.glTexUnits[e]={glTexture:null}}var mI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuBuffer=null,t._uniformBuffer=null,t._indirectBuffer=null,t}return _(i,tf),l(i,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),l(i,[{key:"initialize",value:function(e){return this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=void 0!==e.flags?e.flags:cu.NONE,this._usage&su.INDIRECT?this._indirectBuffer={drawInfos:[]}:this._usage&su.UNIFORM&&0<this._size&&(this._uniformBuffer=new ArrayBuffer(this._size)),this._flags&cu.BAKUP_BUFFER&&(this._bufferView=new Uint8Array(this._size)),this._gpuBuffer={usage:e.usage,memUsage:e.memUsage,size:e.size,stride:this._stride,buffer:null,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&su.INDIRECT?this._gpuBuffer.indirects=this._indirectBuffer.drawInfos:this._usage&su.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&lu.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&su.VERTEX){t.glTarget=i.ARRAY_BUFFER;var a=i.createBuffer();a&&(t.glBuffer=a,0<t.size&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&su.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;var s=i.createBuffer();s&&(t.glBuffer=s,0<t.size&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&su.UNIFORM?(t.glTarget=i.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer))):(t.usage&su.INDIRECT||t.usage&su.TRANSFER_DST||t.usage&su.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size,this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBuffer&&(function(e,t){t.glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._bufferView=null,this._status=Yl.UNREADY}},{key:"resize",value:function(e){var t=this._size;if(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new ArrayBuffer(this._size)),this._bufferView&&t!==e){var i=this._bufferView;this._bufferView=new Uint8Array(this._size),this._bufferView.set(i),this._gpuBuffer&&(this._gpuBuffer.buffer=this._bufferView.buffer)}this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=this._size,0<this._size&&(function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&lu.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;t.usage&su.VERTEX?(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ARRAY_BUFFER,t.buffer,r):i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&su.INDEX?(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.buffer,r):i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&su.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer)):(t.usage&su.INDIRECT||t.usage&su.TRANSFER_DST||t.usage&su.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=this._size,this._bufferView&&(this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=this._size)))}},{key:"update",value:function(e,t,i){var n;if(n=void 0!==i?i:this._usage&su.INDIRECT?0:e.byteLength,this._bufferView){var r=new Uint8Array(e,0,i);this._bufferView.set(r,t)}fI(this._device,this._gpuBuffer,e,t||0,n)}}]),i}(),yI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,jl.COMMAND_ALLOCATOR)))._device=void 0,t._device=e,t}return _(i,pc),i}(),gI=function(){function n(e,t){y(this,n),this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new Ug(t);for(var i=0;i<t;++i)this._frees[i]=new e;this._freeIdx=t-1}return l(n,[{key:"alloc",value:function(e){if(this._freeIdx<0){var t=2*this._frees.length,i=this._frees;this._frees=new Array(t);for(var n=t-i.length,r=0;r<n;++r)this._frees[r]=new e;for(var a=n,s=0;a<t;++a,++s)this._frees[a]=i[s];this._freeIdx+=n}var o=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++o.refCount,o}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),n}(),bI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e))).beginRenderPassCmdPool=void 0,t.bindStatesCmdPool=void 0,t.drawCmdPool=void 0,t.updateBufferCmdPool=void 0,t.copyBufferToTextureCmdPool=void 0,t.beginRenderPassCmdPool=new gI(sI,1),t.bindStatesCmdPool=new gI(oI,1),t.drawCmdPool=new gI(lI,1),t.updateBufferCmdPool=new gI(uI,1),t.copyBufferToTextureCmdPool=new gI(cI,1),t}return _(i,yI),l(i,[{key:"initialize",value:function(e){return this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Yl.UNREADY}},{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}]),i}(),xI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e))).cmdPackage=new hI,t._webGLAllocator=null,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUBindingLayout=null,t._curGPUInputAssembler=null,t._curViewport=null,t._curScissor=null,t._curLineWidth=null,t._curDepthBias=null,t._curBlendConstants=[],t._curDepthBounds=null,t._curStencilWriteMask=null,t._curStencilCompareMask=null,t._isStateInvalied=!1,t}return _(i,nf),l(i,[{key:"initialize",value:function(e){return!!e.allocator&&(this._allocator=e.allocator,this._webGLAllocator=this._allocator,this._type=e.type,this._status=Yl.SUCCESS,!0)}},{key:"destroy",value:function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._allocator=null,this._webGLAllocator=null),this._status=Yl.UNREADY}},{key:"begin",value:function(){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUBindingLayout=null,this._curGPUInputAssembler=null,this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants=[],this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,i,n,r,a){var s=this._webGLAllocator.beginRenderPassCmdPool.alloc(sI);s.gpuFramebuffer=e.gpuFramebuffer,s.renderArea=t,s.clearFlag=i,s.clearColors.length=n.length;for(var o=0;o<n.length;++o)s.clearColors[o]=n[o];s.clearDepth=r,s.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(s),this.cmdPackage.cmds.push($M.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;this._curGPUPipelineState=t,this._isStateInvalied=!0}},{key:"bindBindingLayout",value:function(e){var t=e.gpuBindingLayout;this._curGPUBindingLayout=t,this._isStateInvalied=!0}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport={left:e.left,top:e.top,width:e.width,height:e.height,minDepth:e.minDepth,maxDepth:e.maxDepth},this._curViewport!==e&&(this._curViewport=e,this._isStateInvalied=!0)}},{key:"setScissor",value:function(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor={x:e.x,y:e.y,width:e.width,height:e.height}}},{key:"setLineWidth",value:function(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,i){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===i||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=i,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:i},this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){(this._curBlendConstants||4!==e.length)&&(4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3])||(this._curBlendConstants=[e[0],e[1],e[2],e[3]],this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,i){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===i||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=i,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:i},this._isStateInvalied=!0)}},{key:"draw",value:function(e){if(this._type===Qu.PRIMARY&&this._isInRenderPass||this._type===Qu.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._allocator.drawCmdPool.alloc(lI);if(e.extractCmdDraw(t),this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push($M.DRAW),++this._numDrawCalls,this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=e.indexCount/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(e.indexCount-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i,n){if(this._type===Qu.PRIMARY&&!this._isInRenderPass||this._type===Qu.SECONDARY){var r=e.gpuBuffer;if(r){var a=this._webGLAllocator.updateBufferCmdPool.alloc(uI);if(a){var s;s=void 0!==n?n:e.usage&su.INDIRECT?0:t.byteLength;var o=t;a.gpuBuffer=r,a.buffer=o,a.offset=void 0!==i?i:0,a.size=s,this.cmdPackage.updateBufferCmds.push(a),this.cmdPackage.cmds.push($M.UPDATE_BUFFER)}}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBufferToTexture",value:function(e,t,i,n){if(this._type===Qu.PRIMARY&&!this._isInRenderPass||this._type===Qu.SECONDARY){var r=e.gpuBuffer,a=t.gpuTexture;if(r&&a){var s=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(cI);s&&(s.gpuBuffer=r,s.gpuTexture=a,s.dstLayout=i,s.regions=n,this.cmdPackage.copyBufferToTextureCmds.push(s),this.cmdPackage.cmds.push($M.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){for(var n=e[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var a=n.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var s=0;s<n.cmdPackage.bindStatesCmds.length;++s){var o=n.cmdPackage.bindStatesCmds.array[s];++o.refCount,this.cmdPackage.bindStatesCmds.push(o)}for(var l=0;l<n.cmdPackage.drawCmds.length;++l){var u=n.cmdPackage.drawCmds.array[l];++u.refCount,this.cmdPackage.drawCmds.push(u)}for(var c=0;c<n.cmdPackage.updateBufferCmds.length;++c){var h=n.cmdPackage.updateBufferCmds.array[c];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var f=0;f<n.cmdPackage.copyBufferToTextureCmds.length;++f){var d=n.cmdPackage.copyBufferToTextureCmds.array[f];++d.refCount,this.cmdPackage.copyBufferToTextureCmds.push(d)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds),this._numDrawCalls+=n._numDrawCalls,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(oI);e&&(e.gpuPipelineState=this._curGPUPipelineState,e.gpuBindingLayout=this._curGPUBindingLayout,e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,e.blendConstants=this._curBlendConstants,e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push($M.BIND_STATES),this._isStateInvalied=!1)}},{key:"webGLDevice",get:function(){return this._device}}]),i}(),SI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuFramebuffer=null,t}return _(i,rf),l(i,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),l(i,[{key:"initialize",value:function(e){if(this._renderPass=e.renderPass,this._colorViews=e.colorViews||[],this._depthStencilView=e.depthStencilView||null,this._isOffscreen=void 0===e.isOffscreen||e.isOffscreen,this._isOffscreen){var t=[];if(void 0!==e.colorViews){var i=e.colorViews,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t.push(s.gpuTextureView)}}var o=null;e.depthStencilView&&(o=e.depthStencilView.gpuTextureView),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:t,gpuDepthStencilView:o,isOffscreen:this._isOffscreen,glFramebuffer:null},function(e,t){if(t.isOffscreen){var i=e.gl,n=[],r=i.createFramebuffer();if(r){t.glFramebuffer=r,e.stateCache.glFramebuffer!==t.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer),e.stateCache.glFramebuffer=t.glFramebuffer);for(var a=0;a<t.gpuColorViews.length;++a){var s=t.gpuColorViews[a];s&&(s.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.gpuTexture.glTarget,s.gpuTexture.glTexture,s.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.gpuTexture.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+a))}var o=t.gpuDepthStencilView;if(o){var l=xc[o.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;o.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,o.gpuTexture.glTarget,o.gpuTexture.glTexture,o.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,o.gpuTexture.glRenderbuffer)}e.WEBGL_draw_buffers&&e.WEBGL_draw_buffers.drawBuffersWEBGL(n);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}}}}(this._device,this._gpuFramebuffer)}else this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:[],gpuDepthStencilView:null,isOffscreen:!1,glFramebuffer:null};return this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._isOffscreen&&this._gpuFramebuffer&&function(e,t){t.glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null)}(this._device,this._gpuFramebuffer),this._gpuFramebuffer=null,this._status=Yl.UNREADY}}]),i}(),TI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuInputAssembler=null,t}return _(i,vd),l(i,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),l(i,[{key:"initialize",value:function(e){if(0===e.vertexBuffers.length)return console.error("GFXInputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._vertexBuffers=e.vertexBuffers,void 0!==e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride}this._indirectBuffer=e.indirectBuffer||null;for(var i=new Array(e.vertexBuffers.length),n=0;n<e.vertexBuffers.length;++n){var r=e.vertexBuffers[n];r.gpuBuffer&&(i[n]=r.gpuBuffer)}var a=null,s=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:s=5121;break;case 2:s=5123;break;case 4:s=5125;break;default:console.error("Error index buffer stride.")}var o=null;return void 0!==e.indirectBuffer&&(o=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:i,gpuIndexBuffer:a,gpuIndirectBuffer:o,glAttribs:[],glIndexType:s,glVAOs:new Map},function(e,t){var i=e.gl;t.glAttribs=new Array(t.attributes.length);for(var n=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],s=void 0!==a.stream?a.stream:0,o=t.gpuVertexBuffers[s],l=jM(a.format,i),u=xc[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:o.glBuffer,glType:l,size:u,count:xc[a.format].count,stride:o.stride,componentCount:JM(l,i),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:n[s]},n[s]+=u}}(this._device,this._gpuInputAssembler),this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){var i=t.glVAOs,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;e.OES_vertex_array_object.deleteVertexArrayOES(s[1])}t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null,this._status=Yl.UNREADY}},{key:"extractCmdDraw",value:function(e){e.drawInfo.vertexCount=this._vertexCount,e.drawInfo.firstVertex=this._firstVertex,e.drawInfo.indexCount=this._indexCount,e.drawInfo.firstIndex=this._firstIndex,e.drawInfo.vertexOffset=this._vertexOffset,e.drawInfo.instanceCount=this._instanceCount,e.drawInfo.firstInstance=this._firstInstance}}]),i}(),wI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuPipelineLayout=null,t}return _(i,md),l(i,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),l(i,[{key:"initialize",value:function(e){return this._layouts=e.layouts,this._pushConstantsRanges=e.pushConstantsRanges||[],this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Yl.UNREADY}}]),i}(),EI=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],AI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuPipelineState=null,t}return _(i,xd),l(i,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),l(i,[{key:"initialize",value:function(e){return this._primitive=e.primitive,this._shader=e.shader,this._is=e.is,this._rs=e.rs,this._dss=e.dss,this._bs=e.bs,this._dynamicStates=e.dynamicStates||[],this._layout=e.layout,this._renderPass=e.renderPass,this._gpuPipelineState={glPrimitive:EI[e.primitive],gpuShader:e.shader.gpuShader,rs:e.rs,dss:e.dss,bs:e.bs,dynamicStates:void 0!==e.dynamicStates?e.dynamicStates:[],gpuLayout:e.layout.gpuPipelineLayout,gpuRenderPass:e.renderPass.gpuRenderPass},this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuPipelineState=null,this._status=Yl.UNREADY}}]),i}(),CI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e))).numDrawCalls=0,t.numTris=0,t._isAsync=!1,t}return _(i,Sd),l(i,[{key:"initialize",value:function(e){return this._type=e.type,this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Yl.UNREADY}},{key:"submit",value:function(e,t){if(!this._isAsync)for(var i=e.length,n=0;n<i;n++){var r=e[n];_I(this._device,r.cmdPackage),this.numDrawCalls+=r.numDrawCalls,this.numTris+=r.numTris}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numTris=0}}]),i}(),kI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuRenderPass=null,t}return _(i,Td),l(i,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),l(i,[{key:"initialize",value:function(e){return this._colorInfos=e.colorAttachments||[],this._depthStencilInfo=e.depthStencilAttachment||null,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuRenderPass=null,this._status=Yl.UNREADY}}]),i}(),RI=[10497,33648,33071,33071],OI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuSampler=null,t._state=new wd,t}return _(i,Ed),l(i,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),l(i,[{key:"initialize",value:function(e){void 0!==e.name&&(this._state.name=e.name),void 0!==e.minFilter&&(this._state.minFilter=e.minFilter),void 0!==e.magFilter&&(this._state.magFilter=e.magFilter),void 0!==e.mipFilter&&(this._state.mipFilter=e.mipFilter),void 0!==e.addressU&&(this._state.addressU=e.addressU),void 0!==e.addressV&&(this._state.addressV=e.addressV),void 0!==e.addressW&&(this._state.addressW=e.addressW),void 0!==e.maxAnisotropy&&(this._state.maxAnisotropy=e.maxAnisotropy),void 0!==e.cmpFunc&&(this._state.cmpFunc=e.cmpFunc),void 0!==e.borderColor&&(this._state.borderColor=e.borderColor),void 0!==e.minLOD&&(this._state.minLOD=e.minLOD),void 0!==e.maxLOD&&(this._state.maxLOD=e.maxLOD),void 0!==e.mipLODBias&&(this._state.mipLODBias=e.mipLODBias);var t=0,i=0,n=this._state.minFilter,r=this._state.magFilter,a=this._state.mipFilter;t=n===Iu.LINEAR||n===Iu.ANISOTROPIC?a===Iu.LINEAR||a===Iu.ANISOTROPIC?9987:a===Iu.POINT?9985:9729:a===Iu.LINEAR||a===Iu.ANISOTROPIC?9986:a===Iu.POINT?9984:9728,i=r===Iu.LINEAR||r===Iu.ANISOTROPIC?9729:9728;var s=RI[this._state.addressU],o=RI[this._state.addressV],l=RI[this._state.addressW];return this._gpuSampler={glMinFilter:t,glMagFilter:i,glWrapS:s,glWrapT:o,glWrapR:l},this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuSampler=null,this._status=Yl.UNREADY}}]),i}(),MI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuShader=null,t}return _(i,Ad),l(i,[{key:"gpuShader",get:function(){return this._gpuShader}}]),l(i,[{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,void 0!==e.blocks&&(this._blocks=e.blocks),void 0!==e.samplers&&(this._samplers=e.samplers),this._gpuShader={name:e.name?e.name:"",blocks:void 0!==e.blocks?e.blocks:[],samplers:void 0!==e.samplers?e.samplers:[],gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(var t=0;t<e.stages.length;++t){var i=e.stages[t];this._gpuShader.gpuStages[t]={type:i.type,source:i.source,macros:i.macros?i.macros:[],glShader:null}}return function(e,a){function t(){if(l){if(u>=o.length)return"break";c=o[u++]}else{if((u=o.next()).done)return"break";c=u.value}var e=c,t=0,i="",n=1;switch(e.type){case ju.VERTEX:i="VertexShader",t=s.VERTEX_SHADER;break;case ju.FRAGMENT:i="FragmentShader",t=s.FRAGMENT_SHADER;break;default:return console.error("Unsupported GFXShaderType."),{v:void 0}}var r=s.createShader(t);if(r&&(e.glShader=r,s.shaderSource(e.glShader,e.source),s.compileShader(e.glShader),!s.getShaderParameter(e.glShader,s.COMPILE_STATUS)))return console.error(i+" in '"+a.name+"' compilation failed."),console.error("Shader source dump:",e.source.replace(/^|\n/g,function(){return"\n".concat(n++," ")})),console.error(s.getShaderInfoLog(e.glShader)),s.deleteShader(e.glShader),e.glShader=null,{v:void 0}}var s=e.gl,o=a.gpuStages,l=Array.isArray(o),u=0;e:for(o=l?o:o[Symbol.iterator]();;){var c,i=t();switch(i){case"break":break e;default:if("object"===be(i))return i.v}}var n=s.createProgram();if(n){a.glProgram=n;var r=a.gpuStages,h=Array.isArray(r),f=0;for(r=h?r:r[Symbol.iterator]();;){var d;if(h){if(f>=r.length)break;d=r[f++]}else{if((f=r.next()).done)break;d=f.value}var _=d;s.attachShader(a.glProgram,_.glShader)}if(s.linkProgram(a.glProgram),s.getProgramParameter(a.glProgram,s.LINK_STATUS)){console.info("Shader '"+a.name+"' compilation successed.");var p=s.getProgramParameter(a.glProgram,s.ACTIVE_ATTRIBUTES);a.glInputs=new Array(p);for(var v=0;v<p;++v){var m=s.getActiveAttrib(a.glProgram,v);if(m){var y=void 0,g=m.name.indexOf("[");y=-1!==g?m.name.substr(0,g):m.name;var b=s.getAttribLocation(a.glProgram,y),x=QM(m.type,s),S=ZM(m.type,s);a.glInputs[v]={binding:b,name:y,type:x,stride:S,count:m.size,size:S*m.size,glType:m.type,glLoc:b}}}if(0<a.blocks.length){a.glBlocks=new Array(a.blocks.length);for(var T=0;T<a.blocks.length;++T){var w=a.blocks[T],E={binding:w.binding,name:w.name,size:0,glUniforms:new Array(w.members.length),glActiveUniforms:[],isUniformPackage:!0};a.glBlocks[T]=E;for(var A=0;A<w.members.length;++A){var C=w.members[A],k=KM(C.type,s),R=ZM(k,s),O=R*C.count,M=E.size/4,I=new Array(O/4);I.fill(0),E.glUniforms[A]={binding:-1,name:C.name,type:C.type,stride:R,count:C.count,size:O,offset:E.size,glType:k,glLoc:-1,array:I,begin:M},E.size+=O}}}if(0<a.samplers.length){a.glSamplers=new Array(a.samplers.length);for(var B=0;B<a.samplers.length;++B){var L=a.samplers[B];a.glSamplers[B]={binding:L.binding,name:L.name,type:L.type,units:[],glType:KM(L.type,s),glLoc:-1}}}for(var P=s.getProgramParameter(a.glProgram,s.ACTIVE_UNIFORMS),F=0,z=[],D=0;D<P;++D){var N=s.getActiveUniform(a.glProgram,D);if(N){var U=s.getUniformLocation(a.glProgram,N.name);if(U){var V=void 0,G=N.name.indexOf("[");if(V=-1!==G?N.name.substr(0,G):N.name,N.type===s.SAMPLER_2D||N.type===s.SAMPLER_CUBE){var H=a.glSamplers,W=Array.isArray(H),q=0;for(H=W?H:H[Symbol.iterator]();;){var j;if(W){if(q>=H.length)break;j=H[q++]}else{if((q=H.next()).done)break;j=q.value}var X=j;if(X.name===V){for(var Y=0;Y<N.size;++Y)X.units.push(F+Y);X.glLoc=U,F+=N.size,z.push(X);break}}}else{var K=a.glBlocks,Q=Array.isArray(K),Z=0;for(K=Q?K:K[Symbol.iterator]();;){var J;if(Q){if(Z>=K.length)break;J=K[Z++]}else{if((Z=K.next()).done)break;J=Z.value}var $=J,ee=$.glUniforms,te=Array.isArray(ee),ie=0;for(ee=te?ee:ee[Symbol.iterator]();;){var ne;if(te){if(ie>=ee.length)break;ne=ee[ie++]}else{if((ie=ee.next()).done)break;ne=ie.value}var re=ne;if(re.name===V){re.glLoc=U,$.glActiveUniforms.push(re);break}}}}}}}if(z.length){e.stateCache.glProgram!==a.glProgram&&(s.useProgram(a.glProgram),e.stateCache.glProgram=a.glProgram);var ae=z,se=Array.isArray(ae),oe=0;for(ae=se?ae:ae[Symbol.iterator]();;){var le;if(se){if(oe>=ae.length)break;le=ae[oe++]}else{if((oe=ae.next()).done)break;le=oe.value}var ue=le;s.uniform1iv(ue.glLoc,ue.units)}}}else{console.error("Failed to link shader '"+a.name+"'."),console.error(s.getProgramInfoLog(a.glProgram));var ce=a.gpuStages,he=Array.isArray(ce),fe=0;for(ce=he?ce:ce[Symbol.iterator]();;){var de;if(he){if(fe>=ce.length)break;de=ce[fe++]}else{if((fe=ce.next()).done)break;de=fe.value}var _e=de;_e.glShader&&(s.deleteShader(_e.glShader),_e.glShader=null)}}}}(this._device,this._gpuShader),this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuShader&&(function(e,t){var i=t.gpuStages,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.glShader&&(e.gl.deleteShader(s.glShader),s.glShader=null)}t.glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null)}(this._device,this._gpuShader),this._gpuShader=null),this._status=Yl.UNREADY}}]),i}();function II(e){return 0<e&&0==(e&e-1)}var BI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuTexture=null,t}return _(i,Cd),l(i,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),l(i,[{key:"initialize",value:function(e){var t;switch(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,void 0!==e.depth&&(this._depth=e.depth),void 0!==e.arrayLayer&&(this._arrayLayer=e.arrayLayer),void 0!==e.mipLevel&&(this._mipLevel=e.mipLevel),void 0!==e.samples&&(this._samples=e.samples),void 0!==e.flags&&(this._flags=e.flags),this._isPowerOf2=II(this._width)&&II(this._height),this._size=Tc(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._flags&Gu.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),e.type){case Fu.TEX1D:t=e.arrayLayer?e.arrayLayer<=1?Wu.TV1D:Wu.TV1D_ARRAY:Wu.TV1D;break;case Fu.TEX2D:var i=Gu.NONE;e.flags&&(i=e.flags),t=e.arrayLayer?e.arrayLayer<=1?Wu.TV2D:i&Gu.CUBEMAP?Wu.CUBE:Wu.TV2D_ARRAY:Wu.TV2D;break;case Fu.TEX3D:t=Wu.TV3D;break;default:t=Wu.TV2D}return this._gpuTexture={type:this._type,viewType:t,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._arrayLayer,mipLevel:this._mipLevel,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternelFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var i=e.gl;t.glInternelFmt=XM(t.format,i),t.glFormat=YM(t.format,i),t.glType=jM(t.format,i);var n=t.width,r=t.height;switch(t.viewType){case Wu.TV2D:t.viewType=Wu.TV2D,t.glTarget=i.TEXTURE_2D;var a=Math.max(n,r);if(a>e.maxTextureSize&&z(9100,a,e.maxTextureSize),t.samples===Uu.X1){var s=i.createTexture();if(s&&0<t.size){t.glTexture=s;var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),xc[t.format].isCompressed)if(t.glInternelFmt!==GM.COMPRESSED_RGB_ETC1_WEBGL)for(var l=0;l<t.mipLevel;++l){var u=Sc(t.format,n,r,1),c=new Uint8Array(u);i.compressedTexImage2D(i.TEXTURE_2D,l,t.glInternelFmt,n,r,0,c),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else{var h=Sc(t.format,2,2,1),f=new Uint8Array(h);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternelFmt,2,2,0,f)}else for(var d=0;d<t.mipLevel;++d)i.texImage2D(i.TEXTURE_2D,d,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}}break;case Wu.CUBE:t.viewType=Wu.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var _=Math.max(n,r);_>e.maxCubeMapTextureSize&&z(9100,_,e.maxTextureSize);var p=i.createTexture();if(p&&0<t.size){t.glTexture=p;var v=e.stateCache.glTexUnits[e.stateCache.texUnit];if(v.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),v.glTexture=t.glTexture),xc[t.format].isCompressed)if(t.glInternelFmt!==GM.COMPRESSED_RGB_ETC1_WEBGL)for(var m=0;m<6;++m){n=t.width,r=t.height;for(var y=0;y<t.mipLevel;++y){var g=Sc(t.format,n,r,1),b=new Uint8Array(g);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+m,y,t.glInternelFmt,n,r,0,b),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var x=0;x<6;++x){var S=Sc(t.format,2,2,1),T=new Uint8Array(S);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+x,0,t.glInternelFmt,2,2,0,T)}else for(var w=0;w<6;++w){n=t.width,r=t.height;for(var E=0;E<t.mipLevel;++E)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+w,E,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=Wu.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTexture&&(function(e,t){t.glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null)}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null),this._status=Yl.UNREADY,this._buffer=null}},{key:"resize",value:function(e,t){var i=this._size;this._width=e,this._height=t,this._size=Tc(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._gpuTexture&&(this._gpuTexture.width=this._width,this._gpuTexture.height=this._height,this._gpuTexture.size=this._size,function(e,t){var i=e.gl;t.glInternelFmt=XM(t.format,i),t.glFormat=YM(t.format,i),t.glType=jM(t.format,i);var n=t.width,r=t.height;switch(t.viewType){case Wu.TV2D:t.viewType=Wu.TV2D,t.glTarget=i.TEXTURE_2D;var a=Math.max(n,r);if(a>e.maxTextureSize&&z(9100,a,e.maxTextureSize),t.samples===Uu.X1){var s=e.stateCache.glTexUnits[e.stateCache.texUnit];if(s.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),s.glTexture=t.glTexture),xc[t.format].isCompressed){if(t.glInternelFmt!==GM.COMPRESSED_RGB_ETC1_WEBGL)for(var o=0;o<t.mipLevel;++o){var l=Sc(t.format,n,r,1),u=new Uint8Array(l);i.compressedTexImage2D(i.TEXTURE_2D,o,t.glInternelFmt,n,r,0,u),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var c=0;c<t.mipLevel;++c)i.texImage2D(i.TEXTURE_2D,c,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;case Wu.CUBE:t.viewType=Wu.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var h=Math.max(n,r);h>e.maxCubeMapTextureSize&&z(9100,h,e.maxTextureSize);var f=e.stateCache.glTexUnits[e.stateCache.texUnit];if(f.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),f.glTexture=t.glTexture),xc[t.format].isCompressed){if(t.glInternelFmt!==GM.COMPRESSED_RGB_ETC1_WEBGL)for(var d=0;d<6;++d){n=t.width,r=t.height;for(var _=0;_<t.mipLevel;++_){var p=Sc(t.format,n,r,1),v=new Uint8Array(p);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+d,_,t.glInternelFmt,n,r,0,v),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}}else for(var m=0;m<6;++m){n=t.width,r=t.height;for(var y=0;y<t.mipLevel;++y)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+m,y,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=Wu.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size),this._status=Yl.UNREADY}}]),i}(),LI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuTextureView=null,t}return _(i,kd),l(i,[{key:"gpuTextureView",get:function(){return this._gpuTextureView}}]),l(i,[{key:"initialize",value:function(e){return this._texture=e.texture,this._type=e.type,this._format=e.format,this._format=e.format,void 0!==e.baseLevel&&(this._baseLevel=e.baseLevel),void 0!==e.levelCount&&(this._levelCount=e.levelCount),void 0!==e.baseLayer&&(this._baseLayer=e.baseLayer),void 0!==e.layerCount&&(this._layerCount=e.layerCount),this._gpuTextureView={gpuTexture:e.texture.gpuTexture,type:e.type,format:e.format,baseLevel:e.baseLevel?e.baseLevel:0,levelCount:e.levelCount?e.levelCount:1},this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTextureView=null,this._texture=null,this._status=Yl.UNREADY}}]),i}(),PI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,jl.WINDOW)))._device=void 0,t._title="",t._left=0,t._top=0,t._width=0,t._height=0,t._nativeWidth=0,t._nativeHeight=0,t._colorFmt=ru.UNKNOWN,t._depthStencilFmt=ru.UNKNOWN,t._isOffscreen=!1,t._renderPass=null,t._colorTex=null,t._colorTexView=null,t._depthStencilTex=null,t._depthStencilTexView=null,t._framebuffer=null,t._device=e,t}return _(i,pc),l(i,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"detphStencilFormat",get:function(){return this._depthStencilFmt}},{key:"isOffscreen",get:function(){return this._isOffscreen}},{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTexView",get:function(){return this._colorTexView}},{key:"depthStencilTexView",get:function(){return this._depthStencilTexView}},{key:"framebuffer",get:function(){return this._framebuffer}}]),i}(),FI=function(){function t(e){return y(this,t),x(this,g(t).call(this,e))}return _(t,PI),l(t,[{key:"initialize",value:function(e){void 0!==e.title&&(this._title=e.title),void 0!==e.left&&(this._left=e.left),void 0!==e.top&&(this._top=e.top),void 0!==e.isOffscreen&&(this._isOffscreen=e.isOffscreen),this._width=e.width,this._height=e.height,this._nativeWidth=this._width,this._nativeHeight=this._height,this._colorFmt=e.colorFmt,this._depthStencilFmt=e.depthStencilFmt,this._renderPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:Ju.CLEAR,storeOp:ec.STORE,sampleCount:1,beginLayout:ic.COLOR_ATTACHMENT_OPTIMAL,endLayout:ic.COLOR_ATTACHMENT_OPTIMAL}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:Ju.CLEAR,depthStoreOp:ec.STORE,stencilLoadOp:Ju.CLEAR,stencilStoreOp:ec.STORE,sampleCount:1,beginLayout:ic.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:ic.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}});var t=[];return this._isOffscreen&&(this._colorFmt!==ru.UNKNOWN&&(this._colorTex=this._device.createTexture({type:Fu.TEX2D,usage:Du.COLOR_ATTACHMENT|Du.SAMPLED,format:this._colorFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:Gu.NONE}),this._colorTexView=this._device.createTextureView({texture:this._colorTex,type:Wu.TV2D,format:this._colorFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}),t.push(this._colorTexView)),this._depthStencilFmt!==ru.UNKNOWN&&(this._depthStencilTex=this._device.createTexture({type:Fu.TEX2D,usage:Du.DEPTH_STENCIL_ATTACHMENT,format:this._depthStencilFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:Gu.NONE}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:Wu.TV2D,format:this._depthStencilFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}))),this._framebuffer=this._device.createFramebuffer({renderPass:this._renderPass,colorViews:t,depthStencilView:this._depthStencilTexView,isOffscreen:this._isOffscreen}),this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._colorTexView&&(this._colorTexView.destroy(),this._colorTexView=null),this._colorTex&&(this._colorTex.destroy(),this._colorTex=null),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._renderPass&&(this._renderPass.destroy(),this._renderPass=null),this._status=Yl.UNREADY}},{key:"resize",value:function(e,t){this._width=e,this._height=t,(e>this._nativeWidth||t>this._nativeHeight)&&(this._nativeWidth=e,this._nativeHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:Wu.TV2D,format:this._depthStencilFmt})),this._colorTex&&(this._colorTex.resize(e,t),this._colorTexView.destroy(),this._colorTexView.initialize({texture:this._colorTex,type:Wu.TV2D,format:this._colorFmt})),this._framebuffer&&this._framebuffer.isOffscreen&&(this._framebuffer.destroy(),this._framebuffer.initialize({renderPass:this._renderPass,colorViews:[this._colorTexView],depthStencilView:this._depthStencilTexView})))}}]),t}(),zI=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this))).stateCache=new vI,e.nullTex2D=null,e.nullTexCube=null,e._webGLRC=null,e._isAntialias=!0,e._isPremultipliedAlpha=!0,e._useVAO=!1,e._extensions=null,e._EXT_texture_filter_anisotropic=null,e._EXT_frag_depth=null,e._EXT_shader_texture_lod=null,e._EXT_sRGB=null,e._OES_vertex_array_object=null,e._EXT_color_buffer_half_float=null,e._WEBGL_color_buffer_float=null,e._WEBGL_compressed_texture_etc1=null,e._WEBGL_compressed_texture_etc=null,e._WEBGL_compressed_texture_pvrtc=null,e._WEBGL_compressed_texture_astc=null,e._WEBGL_compressed_texture_s3tc=null,e._WEBGL_compressed_texture_s3tc_srgb=null,e._WEBGL_debug_shaders=null,e._WEBGL_draw_buffers=null,e._WEBGL_lose_context=null,e._WEBGL_depth_texture=null,e._WEBGL_debug_renderer_info=null,e._OES_texture_half_float=null,e._OES_texture_half_float_linear=null,e._OES_texture_float=null,e._OES_texture_float_linear=null,e._OES_standard_derivatives=null,e._OES_element_index_uint=null,e._ANGLE_instanced_arrays=null,e}return _(t,Bc),l(t,[{key:"gl",get:function(){return this._webGLRC}},{key:"webGLQueue",get:function(){return this._queue}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"EXT_frag_depth",get:function(){return this._EXT_frag_depth}},{key:"EXT_shader_texture_lod",get:function(){return this._EXT_shader_texture_lod}},{key:"EXT_sRGB",get:function(){return this._EXT_sRGB}},{key:"OES_vertex_array_object",get:function(){return this._OES_vertex_array_object}},{key:"WEBGL_color_buffer_float",get:function(){return this._WEBGL_color_buffer_float}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_astc",get:function(){return this._WEBGL_compressed_texture_astc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}},{key:"WEBGL_debug_shaders",get:function(){return this._WEBGL_debug_shaders}},{key:"WEBGL_draw_buffers",get:function(){return this._WEBGL_draw_buffers}},{key:"WEBGL_lose_context",get:function(){return this._WEBGL_lose_context}},{key:"WEBGL_depth_texture",get:function(){return this._WEBGL_depth_texture}},{key:"WEBGL_debug_renderer_info",get:function(){return this._WEBGL_debug_renderer_info}},{key:"OES_texture_half_float",get:function(){return this._OES_texture_half_float}},{key:"OES_texture_half_float_linear",get:function(){return this._OES_texture_half_float_linear}},{key:"OES_texture_float",get:function(){return this._OES_texture_float}},{key:"OES_standard_derivatives",get:function(){return this._OES_standard_derivatives}},{key:"OES_element_index_uint",get:function(){return this._OES_element_index_uint}},{key:"ANGLE_instanced_arrays",get:function(){return this._ANGLE_instanced_arrays}}]),l(t,[{key:"initialize",value:function(e){this._canvas=e.canvasElm,this._isAntialias=void 0===e.isAntialias||e.isAntialias,this._isPremultipliedAlpha=void 0===e.isPremultipliedAlpha||e.isPremultipliedAlpha;try{var t={alpha:!1,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",t)}catch(e){return console.error(e),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=Ac.WEBGL,this._deviceName="WebGL";var i=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=i.getParameter(i.RENDERER),this._vendor=i.getParameter(i.VENDOR)),this._version=i.getParameter(i.VERSION),this._maxVertexAttributes=i.getParameter(i.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),this._maxCubeMapTextureSize=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE),this._depthBits=i.getParameter(i.DEPTH_BITS),this._stencilBits=i.getParameter(i.STENCIL_BITS),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=ru.RGBA8,24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=ru.D24S8:this._depthStencilFmt=ru.D24:8===this._stencilBits?this._depthStencilFmt=ru.D16S8:this._depthStencilFmt=ru.D16,this._extensions=i.getSupportedExtensions();var n="";if(this._extensions){var r=this._extensions,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}n+=o+" "}console.debug("EXTENSIONS: "+n)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),this._features.fill(!1),this._WEBGL_color_buffer_float&&(this._features[kc.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[kc.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[kc.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[kc.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[kc.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[kc.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._WEBGL_depth_texture&&(this._features[kc.FORMAT_D24S8]=!0);var l="";this._WEBGL_compressed_texture_etc1&&(this._features[kc.FORMAT_ETC1]=!0,l+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[kc.FORMAT_ETC2]=!0,l+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[kc.FORMAT_DXT]=!0,l+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[kc.FORMAT_PVRTC]=!0,l+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[kc.FORMAT_ASTC]=!0,l+="astc "),this._features[kc.MSAA]=!1,this._OES_vertex_array_object&&(this._useVAO=!0),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+l),this.initStates(i),this._queue=this.createQueue({type:hc.GRAPHICS});var u=this._webGLRC.canvas;this._mainWindow=this.createWindow({title:u.title||"",left:u.offsetLeft||0,top:u.offsetTop||0,width:this._webGLRC.drawingBufferWidth,height:this._webGLRC.drawingBufferHeight,colorFmt:this._colorFmt,depthStencilFmt:this._depthStencilFmt}),this._cmdAllocator=this.createCommandAllocator({}),this.nullTex2D=new BI(this),this.nullTex2D.initialize({type:Fu.TEX2D,usage:Du.SAMPLED,format:ru.RGBA8,width:2,height:2,flags:Gu.GEN_MIPMAP}),this.nullTexCube=new BI(this),this.nullTexCube.initialize({type:Fu.TEX2D,usage:Du.SAMPLED,format:ru.RGBA8,width:2,height:2,arrayLayer:6,flags:Gu.CUBEMAP|Gu.GEN_MIPMAP});var c={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:2,height:2,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}},h=new Uint8Array(this.nullTex2D.size);return h.fill(0),this.copyBuffersToTexture([h],this.nullTex2D,[c]),c.texSubres.layerCount=6,this.copyBuffersToTexture([h,h,h,h,h,h],this.nullTexCube,[c]),!0}},{key:"destroy",value:function(){this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._mainWindow&&(this._mainWindow.destroy(),this._mainWindow=null),this._cmdAllocator&&(this._cmdAllocator.destroy(),this._cmdAllocator=null),this._queue&&(this._queue.destroy(),this._queue=null),this._webGLRC=null}},{key:"resize",value:function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}},{key:"createBuffer",value:function(e){var t=new mI(this);return t.initialize(e),t}},{key:"createTexture",value:function(e){var t=new BI(this);return t.initialize(e),t}},{key:"createTextureView",value:function(e){var t=new LI(this);return t.initialize(e),t}},{key:"createSampler",value:function(e){var t=new OI(this);return t.initialize(e),t}},{key:"createBindingLayout",value:function(e){var t=new qM(this);return t.initialize(e),t}},{key:"createShader",value:function(e){var t=new MI(this);return t.initialize(e),t}},{key:"createInputAssembler",value:function(e){var t=new TI(this);return t.initialize(e),t}},{key:"createRenderPass",value:function(e){var t=new kI(this);return t.initialize(e),t}},{key:"createFramebuffer",value:function(e){var t=new SI(this);return t.initialize(e),t}},{key:"createPipelineLayout",value:function(e){var t=new wI(this);return t.initialize(e),t}},{key:"createPipelineState",value:function(e){var t=new AI(this);return t.initialize(e),t}},{key:"createCommandAllocator",value:function(e){var t=new bI(this);return t.initialize(e),t}},{key:"createCommandBuffer",value:function(e){var t=new xI(this);return t.initialize(e),t}},{key:"createQueue",value:function(e){var t=new CI(this);return t.initialize(e),t}},{key:"createWindow",value:function(e){var t=new FI(this);return t.initialize(e),t}},{key:"present",value:function(){this._cmdAllocator.releaseCmds();var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numTris=e.numTris,e.clear()}},{key:"copyBuffersToTexture",value:function(e,t,i){pI(this,e,t.gpuTexture,i)}},{key:"copyTexImagesToTexture",value:function(e,t,i){!function(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var s=0,o=0,l=0;switch(i.glTarget){case r.TEXTURE_2D:var u=n,c=Array.isArray(u),h=0;for(u=c?u:u[Symbol.iterator]();;){var f;if(c){if(h>=u.length)break;f=u[h++]}else{if((h=u.next()).done)break;f=h.value}var d=f;for(s=d.texSubres.baseMipLevel;s<d.texSubres.levelCount;++s)r.texSubImage2D(r.TEXTURE_2D,s,d.texOffset.x,d.texOffset.y,i.glFormat,i.glType,t[o++])}break;case r.TEXTURE_CUBE_MAP:var _=n,p=Array.isArray(_),v=0;for(_=p?_:_[Symbol.iterator]();;){var m;if(p){if(v>=_.length)break;m=_[v++]}else{if((v=_.next()).done)break;m=v.value}var y=m,g=y.texSubres.baseArrayLayer+y.texSubres.layerCount;for(l=y.texSubres.baseArrayLayer;l<g;++l){var b=y.texSubres.baseMipLevel+y.texSubres.levelCount;for(s=y.texSubres.baseMipLevel;s<b;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,s,y.texOffset.x,y.texOffset.y,i.glFormat,i.glType,t[o++])}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Gu.GEN_MIPMAP&&i.isPowerOf2&&r.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}},{key:"copyFramebufferToBuffer",value:function(e,t,i){var n=this._webGLRC,r=e.gpuFramebuffer,a=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==r.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,r.glFramebuffer),this.stateCache.glFramebuffer=r.glFramebuffer);var s=new Uint8Array(t),o=i,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c,f=h.buffOffset+h.buffTexHeight*h.buffStride,d=h.texExtent.width,_=h.texExtent.height,p=Sc(ru.RGBA8,d,_,1),v=s.subarray(f,f+p);n.readPixels(h.texOffset.x,h.texOffset.y,d,_,n.RGBA,n.UNSIGNED_BYTE,v)}this.stateCache.glFramebuffer!==a&&(n.bindFramebuffer(n.FRAMEBUFFER,a),this.stateCache.glFramebuffer=a)}},{key:"blitFramebuffer",value:function(e,t,i,n,r){}},{key:"getExtension",value:function(e){for(var t=["","WEBKIT_","MOZ_"],i=0;i<t.length;++i){var n=this._webGLRC.getExtension(t[i]+e);if(n)return n}return null}},{key:"initStates",value:function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.disable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,4294967295),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,4294967295),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,4294967295),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,4294967295),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}}]),t}();cc.WebGLGFXDevice=zI;var DI=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuBindingLayout=null,t}return _(i,WM),l(i,[{key:"gpuBindingLayout",get:function(){return this._gpuBindingLayout}}]),l(i,[{key:"initialize",value:function(e){this._bindingUnits=new Array(e.bindings.length);for(var t=0;t<e.bindings.length;++t){var i=e.bindings[t];this._bindingUnits[t]={binding:i.binding,type:i.type,name:i.name,buffer:null,texView:null,sampler:null}}this._gpuBindingLayout={gpuBindings:new Array(e.bindings.length)};for(var n=0;n<e.bindings.length;++n){var r=e.bindings[n];this._gpuBindingLayout.gpuBindings[n]={binding:r.binding,type:r.type,name:r.name,gpuBuffer:null,gpuTexView:null,gpuSampler:null}}return this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBindingLayout=null,this._status=Yl.UNREADY}},{key:"update",value:function(){if(this._isDirty&&this._gpuBindingLayout){for(var e=0;e<this._bindingUnits.length;++e){var t=this._bindingUnits[e];switch(t.type){case Yu.UNIFORM_BUFFER:t.buffer&&(this._gpuBindingLayout.gpuBindings[e].gpuBuffer=t.buffer.gpuBuffer);break;case Yu.SAMPLER:t.texView&&(this._gpuBindingLayout.gpuBindings[e].gpuTexView=t.texView.gpuTextureView),t.sampler&&(this._gpuBindingLayout.gpuBindings[e].gpuSampler=t.sampler.gpuSampler)}}this._isDirty=!1}}}]),i}(),NI=[WebGLRenderingContext.REPEAT,WebGLRenderingContext.MIRRORED_REPEAT,WebGLRenderingContext.CLAMP_TO_EDGE,WebGLRenderingContext.CLAMP_TO_EDGE],UI=[1,2,4,8,16,32,64],VI=new Float32Array(4);function GI(e,t){switch(e){case ru.R8:return t.UNSIGNED_BYTE;case ru.R8SN:return t.BYTE;case ru.R8UI:return t.UNSIGNED_BYTE;case ru.R8I:return t.BYTE;case ru.R16F:return t.HALF_FLOAT;case ru.R16UI:return t.UNSIGNED_SHORT;case ru.R16I:return t.SHORT;case ru.R32F:return t.FLOAT;case ru.R32UI:return t.UNSIGNED_INT;case ru.R32I:return t.INT;case ru.RG8:return t.UNSIGNED_BYTE;case ru.RG8SN:return t.BYTE;case ru.RG8UI:return t.UNSIGNED_BYTE;case ru.RG8I:return t.BYTE;case ru.RG16F:return t.HALF_FLOAT;case ru.RG16UI:return t.UNSIGNED_SHORT;case ru.RG16I:return t.SHORT;case ru.RG32F:return t.FLOAT;case ru.RG32UI:return t.UNSIGNED_INT;case ru.RG32I:return t.INT;case ru.RGB8:case ru.SRGB8:return t.UNSIGNED_BYTE;case ru.RGB8SN:return t.BYTE;case ru.RGB8UI:return t.UNSIGNED_BYTE;case ru.RGB8I:return t.BYTE;case ru.RGB16F:return t.HALF_FLOAT;case ru.RGB16UI:return t.UNSIGNED_SHORT;case ru.RGB16I:return t.SHORT;case ru.RGB32F:return t.FLOAT;case ru.RGB32UI:return t.UNSIGNED_INT;case ru.RGB32I:return t.INT;case ru.RGBA8:case ru.SRGB8_A8:return t.UNSIGNED_BYTE;case ru.RGBA8SN:return t.BYTE;case ru.RGBA8UI:return t.UNSIGNED_BYTE;case ru.RGBA8I:return t.BYTE;case ru.RGBA16F:return t.HALF_FLOAT;case ru.RGBA16UI:return t.UNSIGNED_SHORT;case ru.RGBA16I:return t.SHORT;case ru.RGBA32F:return t.FLOAT;case ru.RGBA32UI:return t.UNSIGNED_INT;case ru.RGBA32I:return t.INT;case ru.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case ru.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case ru.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case ru.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case ru.RGB10A2:case ru.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case ru.RGB9E5:return t.FLOAT;case ru.D16:case ru.D16S8:return t.UNSIGNED_SHORT;case ru.D24:return t.UNSIGNED_INT;case ru.D24S8:return t.UNSIGNED_INT_24_8;case ru.D32F:return t.FLOAT;case ru.D32F_S8:return t.FLOAT_32_UNSIGNED_INT_24_8_REV;case ru.BC1:case ru.BC1_SRGB:case ru.BC2:case ru.BC2_SRGB:case ru.BC3:case ru.BC3_SRGB:case ru.BC4:return t.UNSIGNED_BYTE;case ru.BC4_SNORM:return t.BYTE;case ru.BC5:return t.UNSIGNED_BYTE;case ru.BC5_SNORM:return t.BYTE;case ru.BC6H_SF16:case ru.BC6H_UF16:return t.FLOAT;case ru.BC7:case ru.BC7_SRGB:case ru.ETC_RGB8:case ru.ETC2_RGB8:case ru.ETC2_SRGB8:case ru.ETC2_RGB8_A1:case ru.ETC2_SRGB8_A1:case ru.ETC2_RGB8:case ru.ETC2_SRGB8:case ru.EAC_R11:return t.UNSIGNED_BYTE;case ru.EAC_R11SN:return t.BYTE;case ru.EAC_RG11:return t.UNSIGNED_BYTE;case ru.EAC_RG11SN:return t.BYTE;case ru.PVRTC_RGB2:case ru.PVRTC_RGBA2:case ru.PVRTC_RGB4:case ru.PVRTC_RGBA4:case ru.PVRTC2_2BPP:case ru.PVRTC2_4BPP:default:return t.UNSIGNED_BYTE}}function HI(e,t){switch(e){case ru.A8:return t.ALPHA;case ru.L8:return t.LUMINANCE;case ru.LA8:return t.LUMINANCE_ALPHA;case ru.R8:return t.R8;case ru.R8SN:return t.R8_SNORM;case ru.R8UI:return t.R8UI;case ru.R8I:return t.R8I;case ru.RG8:return t.RG8;case ru.RG8SN:return t.RG8_SNORM;case ru.RG8UI:return t.RG8UI;case ru.RG8I:return t.RG8I;case ru.RGB8:return t.RGB8;case ru.RGB8SN:return t.RGB8_SNORM;case ru.RGB8UI:return t.RGB8UI;case ru.RGB8I:return t.RGB8I;case ru.RGBA8:return t.RGBA8;case ru.RGBA8SN:return t.RGBA8_SNORM;case ru.RGBA8UI:return t.RGBA8UI;case ru.RGBA8I:return t.RGBA8I;case ru.R16I:return t.R16I;case ru.R16UI:return t.R16UI;case ru.R16F:return t.R16F;case ru.RG16I:return t.RG16I;case ru.RG16UI:return t.RG16UI;case ru.RG16F:return t.RG16F;case ru.RGB16I:return t.RGB16I;case ru.RGB16UI:return t.RGB16UI;case ru.RGB16F:return t.RGB16F;case ru.RGBA16I:return t.RGBA16I;case ru.RGBA16UI:return t.RGBA16UI;case ru.RGBA16F:return t.RGBA16F;case ru.R32I:return t.R32I;case ru.R32UI:return t.R32UI;case ru.R32F:return t.R32F;case ru.RG32I:return t.RG32I;case ru.RG32UI:return t.RG32UI;case ru.RG32F:return t.RG32F;case ru.RGB32I:return t.RGB32I;case ru.RGB32UI:return t.RGB32UI;case ru.RGB32F:return t.RGB32F;case ru.RGBA32I:return t.RGBA32I;case ru.RGBA32UI:return t.RGBA32UI;case ru.RGBA32F:return t.RGBA32F;case ru.R5G6B5:return t.RGB565;case ru.RGB5A1:return t.RGB5_A1;case ru.RGBA4:return t.RGBA4;case ru.RGB10A2:return t.RGB10_A2;case ru.RGB10A2UI:return t.RGB10_A2UI;case ru.R11G11B10F:return t.R11F_G11F_B10F;case ru.D16:return t.DEPTH_COMPONENT16;case ru.D16S8:return t.DEPTH_STENCIL;case ru.D24:return t.DEPTH_COMPONENT24;case ru.D24S8:return t.DEPTH24_STENCIL8;case ru.D32F:return t.DEPTH_COMPONENT32F;case ru.D32F_S8:return t.DEPTH32F_STENCIL8;case ru.BC1:return GM.COMPRESSED_RGB_S3TC_DXT1_EXT;case ru.BC1_ALPHA:return GM.COMPRESSED_RGBA_S3TC_DXT1_EXT;case ru.BC1_SRGB:return GM.COMPRESSED_SRGB_S3TC_DXT1_EXT;case ru.BC1_SRGB_ALPHA:return GM.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case ru.BC2:return GM.COMPRESSED_RGBA_S3TC_DXT3_EXT;case ru.BC2_SRGB:return GM.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case ru.BC3:return GM.COMPRESSED_RGBA_S3TC_DXT5_EXT;case ru.BC3_SRGB:return GM.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case ru.ETC_RGB8:return GM.COMPRESSED_RGB_ETC1_WEBGL;case ru.ETC2_RGB8:return GM.COMPRESSED_RGB8_ETC2;case ru.ETC2_SRGB8:return GM.COMPRESSED_SRGB8_ETC2;case ru.ETC2_RGB8_A1:return GM.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ru.ETC2_SRGB8_A1:return GM.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ru.ETC2_RGBA8:return GM.COMPRESSED_RGBA8_ETC2_EAC;case ru.ETC2_SRGB8_A8:return GM.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case ru.EAC_R11:return GM.COMPRESSED_R11_EAC;case ru.EAC_R11SN:return GM.COMPRESSED_SIGNED_R11_EAC;case ru.EAC_RG11:return GM.COMPRESSED_RG11_EAC;case ru.EAC_RG11SN:return GM.COMPRESSED_SIGNED_RG11_EAC;case ru.PVRTC_RGB2:return GM.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case ru.PVRTC_RGBA2:return GM.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case ru.PVRTC_RGB4:return GM.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case ru.PVRTC_RGBA4:return GM.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL internal format failed."),t.RGBA}}function WI(e,t){switch(e){case ru.A8:return t.ALPHA;case ru.L8:return t.LUMINANCE;case ru.LA8:return t.LUMINANCE_ALPHA;case ru.R8:case ru.R8SN:return t.RED;case ru.R8UI:case ru.R8I:return t.RED;case ru.RG8:case ru.RG8SN:case ru.RG8UI:case ru.RG8I:return t.RG;case ru.RGB8:case ru.RGB8SN:case ru.RGB8UI:case ru.RGB8I:return t.RGB;case ru.RGBA8:case ru.RGBA8SN:case ru.RGBA8UI:case ru.RGBA8I:return t.RGBA;case ru.R16UI:case ru.R16I:case ru.R16F:return t.RED;case ru.RG16UI:case ru.RG16I:case ru.RG16F:return t.RG;case ru.RGB16UI:case ru.RGB16I:case ru.RGB16F:return t.RGB;case ru.RGBA16UI:case ru.RGBA16I:case ru.RGBA16F:return t.RGBA;case ru.R32UI:case ru.R32I:case ru.R32F:return t.RED;case ru.RG32UI:case ru.RG32I:case ru.RG32F:return t.RG;case ru.RGB32UI:case ru.RGB32I:case ru.RGB32F:return t.RGB;case ru.RGBA32UI:case ru.RGBA32I:case ru.RGBA32F:case ru.RGB10A2:return t.RGBA;case ru.R11G11B10F:case ru.R5G6B5:return t.RGB;case ru.RGB5A1:case ru.RGBA4:return t.RGBA;case ru.D16:return t.DEPTH_COMPONENT;case ru.D16S8:return t.DEPTH_STENCIL;case ru.D24:return t.DEPTH_COMPONENT;case ru.D24S8:return t.DEPTH_STENCIL;case ru.D32F:return t.DEPTH_COMPONENT;case ru.D32F_S8:return t.DEPTH_STENCIL;case ru.BC1:return GM.COMPRESSED_RGB_S3TC_DXT1_EXT;case ru.BC1_ALPHA:return GM.COMPRESSED_RGBA_S3TC_DXT1_EXT;case ru.BC1_SRGB:return GM.COMPRESSED_SRGB_S3TC_DXT1_EXT;case ru.BC1_SRGB_ALPHA:return GM.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case ru.BC2:return GM.COMPRESSED_RGBA_S3TC_DXT3_EXT;case ru.BC2_SRGB:return GM.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case ru.BC3:return GM.COMPRESSED_RGBA_S3TC_DXT5_EXT;case ru.BC3_SRGB:return GM.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case ru.ETC_RGB8:return GM.COMPRESSED_RGB_ETC1_WEBGL;case ru.PVRTC_RGB2:return GM.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case ru.PVRTC_RGBA2:return GM.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case ru.PVRTC_RGB4:return GM.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case ru.PVRTC_RGBA4:return GM.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL format failed."),t.RGBA}}function qI(e,t){switch(e){case iu.BOOL:return t.BOOL;case iu.BOOL2:return t.BOOL_VEC2;case iu.BOOL3:return t.BOOL_VEC3;case iu.BOOL4:return t.BOOL_VEC4;case iu.INT:return t.INT;case iu.INT2:return t.INT_VEC2;case iu.INT3:return t.INT_VEC3;case iu.INT4:return t.INT_VEC4;case iu.UINT:return t.UNSIGNED_INT;case iu.FLOAT:return t.FLOAT;case iu.FLOAT2:return t.FLOAT_VEC2;case iu.FLOAT3:return t.FLOAT_VEC3;case iu.FLOAT4:return t.FLOAT_VEC4;case iu.MAT2:return t.FLOAT_MAT2;case iu.MAT2X3:return t.FLOAT_MAT2x3;case iu.MAT2X4:return t.FLOAT_MAT2x4;case iu.MAT3X2:return t.FLOAT_MAT3x2;case iu.MAT3:return t.FLOAT_MAT3;case iu.MAT3X4:return t.FLOAT_MAT3x4;case iu.MAT4X2:return t.FLOAT_MAT4x2;case iu.MAT4X3:return t.FLOAT_MAT4x3;case iu.MAT4:return t.FLOAT_MAT4;case iu.SAMPLER2D:return t.SAMPLER_2D;case iu.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case iu.SAMPLER3D:return t.SAMPLER_3D;case iu.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),iu.UNKNOWN}}function jI(e,t){switch(e){case t.BOOL:return iu.BOOL;case t.BOOL_VEC2:return iu.BOOL2;case t.BOOL_VEC3:return iu.BOOL3;case t.BOOL_VEC4:return iu.BOOL4;case t.INT:return iu.INT;case t.INT_VEC2:return iu.INT2;case t.INT_VEC3:return iu.INT3;case t.INT_VEC4:return iu.INT4;case t.UNSIGNED_INT:return iu.UINT;case t.UNSIGNED_INT_VEC2:return iu.UINT2;case t.UNSIGNED_INT_VEC3:return iu.UINT3;case t.UNSIGNED_INT_VEC4:return iu.UINT4;case t.UNSIGNED_INT:return iu.UINT;case t.FLOAT:return iu.FLOAT;case t.FLOAT_VEC2:return iu.FLOAT2;case t.FLOAT_VEC3:return iu.FLOAT3;case t.FLOAT_VEC4:return iu.FLOAT4;case t.FLOAT_MAT2:return iu.MAT2;case t.FLOAT_MAT2x3:return iu.MAT2X3;case t.FLOAT_MAT2x4:return iu.MAT2X4;case t.FLOAT_MAT3x2:return iu.MAT3X2;case t.FLOAT_MAT3:return iu.MAT3;case t.FLOAT_MAT3x4:return iu.MAT3X4;case t.FLOAT_MAT4x2:return iu.MAT4X2;case t.FLOAT_MAT4x3:return iu.MAT4X3;case t.FLOAT_MAT4:return iu.MAT4;case t.SAMPLER_2D:return iu.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return iu.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return iu.SAMPLER3D;case t.SAMPLER_CUBE:return iu.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GFXType failed."),iu.UNKNOWN}}function XI(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function YI(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var KI,QI,ZI=[512,513,514,515,516,517,518,519],JI=[0,7680,7681,7682,7683,5386,34055,34056],$I=[32774,32778,32779,32774,32774],eB=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];(QI=KI=KI||{})[QI.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",QI[QI.END_RENDER_PASS=1]="END_RENDER_PASS",QI[QI.BIND_STATES=2]="BIND_STATES",QI[QI.DRAW=3]="DRAW",QI[QI.UPDATE_BUFFER=4]="UPDATE_BUFFER",QI[QI.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",QI[QI.COUNT=6]="COUNT";function tB(e){y(this,tB),this.cmdType=void 0,this.refCount=0,this.cmdType=e}var iB=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,KI.BEGIN_RENDER_PASS))).gpuFramebuffer=null,e.renderArea={x:0,y:0,width:0,height:0},e.clearFlag=dc.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return _(t,tB),l(t,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors=[]}}]),t}(),nB=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,KI.BIND_STATES))).gpuPipelineState=null,e.gpuBindingLayout=null,e.gpuInputAssembler=null,e.viewport=null,e.scissor=null,e.lineWidth=null,e.depthBias=null,e.blendConstants=null,e.depthBounds=null,e.stencilWriteMask=null,e.stencilCompareMask=null,e}return _(t,tB),l(t,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuBindingLayout=null,this.gpuInputAssembler=null,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants=null,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}]),t}(),rB=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,KI.DRAW))).drawInfo={vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0},e}return _(t,tB),l(t,[{key:"clear",value:function(){}}]),t}(),aB=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,KI.UPDATE_BUFFER))).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return _(t,tB),l(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),t}(),sB=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this,KI.COPY_BUFFER_TO_TEXTURE))).gpuBuffer=null,e.gpuTexture=null,e.dstLayout=null,e.regions=[],e}return _(t,tB),l(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.gpuTexture=null,this.dstLayout=null,this.regions=[]}}]),t}(),oB=function(){function e(){y(this,e),this.cmds=new Ug(1),this.beginRenderPassCmds=new Ug(1),this.bindStatesCmds=new Ug(1),this.drawCmds=new Ug(1),this.updateBufferCmds=new Ug(1),this.copyBufferToTextureCmds=new Ug(1)}return l(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}]),e}();function lB(e,t,i,n,r){if(t.usage&su.INDIRECT)t.indirects=i.drawInfos;else{var a=i,s=e.gl,o=e.stateCache;switch(t.glTarget){case s.ARRAY_BUFFER:o.glVAO&&(s.bindVertexArray(null),o.glVAO=null),o.glArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ARRAY_BUFFER,t.glBuffer),o.glArrayBuffer=t.glBuffer),r===a.byteLength?s.bufferSubData(t.glTarget,n,a):s.bufferSubData(t.glTarget,n,a.slice(0,r));break;case s.ELEMENT_ARRAY_BUFFER:o.glVAO&&(s.bindVertexArray(null),o.glVAO=null),o.glElementArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,t.glBuffer),o.glElementArrayBuffer=t.glBuffer),r===a.byteLength?s.bufferSubData(t.glTarget,n,a):s.bufferSubData(t.glTarget,n,a.slice(0,r));break;case s.UNIFORM_BUFFER:var l;o.glUniformBuffer!==t.glBuffer&&(s.bindBuffer(s.UNIFORM_BUFFER,t.glBuffer),o.glUniformBuffer=t.glBuffer),r===(l=i instanceof Float32Array?i:new Float32Array(a,0,r/4)).byteLength?s.bufferSubData(t.glTarget,n,l):s.bufferSubData(t.glTarget,n,new Float32Array(l.buffer,0,r/4));break;default:return void console.error("Unsupported GFXBufferType, update buffer failed.")}}}var uB=new Array(KI.COUNT);function cB(e,t){for(var i=e.gl,n=e.stateCache,r=0;r<KI.COUNT;++r)uB[r]=0;for(var a=null,s=null,o=!1,l=null,u=i.TRIANGLES,c=0;c<t.cmds.length;++c){var h=t.cmds.array[c],f=uB[h]++;switch(h){case KI.BEGIN_RENDER_PASS:var d=t.beginRenderPassCmds.array[f],_=0;if(d.gpuFramebuffer){n.glFramebuffer!==d.gpuFramebuffer.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,d.gpuFramebuffer.glFramebuffer),n.glFramebuffer=d.gpuFramebuffer.glFramebuffer),n.viewport.left===d.renderArea.x&&n.viewport.top===d.renderArea.y&&n.viewport.width===d.renderArea.width&&n.viewport.height===d.renderArea.height||(i.viewport(d.renderArea.x,d.renderArea.y,d.renderArea.width,d.renderArea.height),n.viewport.left=d.renderArea.x,n.viewport.top=d.renderArea.y,n.viewport.width=d.renderArea.width,n.viewport.height=d.renderArea.height),n.scissorRect.x===d.renderArea.x&&n.scissorRect.y===d.renderArea.y&&n.scissorRect.width===d.renderArea.width&&n.scissorRect.height===d.renderArea.height||(i.scissor(d.renderArea.x,d.renderArea.y,d.renderArea.width,d.renderArea.height),n.scissorRect.x=d.renderArea.x,n.scissorRect.y=d.renderArea.y,n.scissorRect.width=d.renderArea.width,n.scissorRect.height=d.renderArea.height);for(var p=d.gpuFramebuffer.gpuRenderPass,v=[],m=0;m<d.clearColors.length;++m){var y=p.colorAttachments[m];if(y.format!==ru.UNKNOWN)switch(y.loadOp){case Ju.LOAD:break;case Ju.CLEAR:if(d.clearFlag&dc.COLOR)if(n.bs.targets[0].blendColorMask!==Ou.ALL&&i.colorMask(!0,!0,!0,!0),d.gpuFramebuffer.isOffscreen)VI[0]=d.clearColors[m].r,VI[1]=d.clearColors[m].g,VI[2]=d.clearColors[m].b,VI[3]=d.clearColors[m].a,i.clearBufferfv(i.COLOR,m,VI);else{var g=d.clearColors[0];i.clearColor(g.r,g.g,g.b,g.a),_|=i.COLOR_BUFFER_BIT}break;case Ju.DISCARD:v.push(i.COLOR_ATTACHMENT0+m)}}if(p.depthStencilAttachment&&p.depthStencilAttachment.format!==ru.UNKNOWN){switch(p.depthStencilAttachment.depthLoadOp){case Ju.LOAD:break;case Ju.CLEAR:d.clearFlag&dc.DEPTH&&(n.dss.depthWrite||i.depthMask(!0),i.clearDepth(d.clearDepth),_|=i.DEPTH_BUFFER_BIT);break;case Ju.DISCARD:v.push(i.DEPTH_ATTACHMENT)}if(xc[p.depthStencilAttachment.format].hasStencil)switch(p.depthStencilAttachment.stencilLoadOp){case Ju.LOAD:break;case Ju.CLEAR:d.clearFlag&dc.STENCIL&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,4294967295),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,4294967295),i.clearStencil(d.clearStencil),_|=i.STENCIL_BUFFER_BIT);break;case Ju.DISCARD:v.push(i.STENCIL_ATTACHMENT)}}if(v.length&&i.invalidateFramebuffer(i.FRAMEBUFFER,v),_&&i.clear(_),_&i.COLOR_BUFFER_BIT){var b=n.bs.targets[0].blendColorMask;if(b!==Ou.ALL){var x=(b&Ou.R)!==Ou.NONE,S=(b&Ou.G)!==Ou.NONE,T=(b&Ou.B)!==Ou.NONE,w=(b&Ou.A)!==Ou.NONE;i.colorMask(x,S,T,w)}}_&i.DEPTH_BUFFER_BIT&&!n.dss.depthWrite&&i.depthMask(!1),_&i.STENCIL_BUFFER_BIT&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,0),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,0))}break;case KI.END_RENDER_PASS:break;case KI.BIND_STATES:var E=t.bindStatesCmds.array[f];if(o=!1,E.gpuPipelineState){if(a=E.gpuPipelineState,u=E.gpuPipelineState.glPrimitive,E.gpuPipelineState.gpuShader){var A=E.gpuPipelineState.gpuShader.glProgram;n.glProgram!==A&&(i.useProgram(A),n.glProgram=A,o=!0),s=E.gpuPipelineState.gpuShader}var C=E.gpuPipelineState.rs;if(C){if(n.rs.cullMode!==C.cullMode){switch(C.cullMode){case bu.NONE:i.disable(i.CULL_FACE);break;case bu.FRONT:i.enable(i.CULL_FACE),i.cullFace(i.FRONT);break;case bu.BACK:i.enable(i.CULL_FACE),i.cullFace(i.BACK)}e.stateCache.rs.cullMode=C.cullMode}e.stateCache.rs.isFrontFaceCCW!==C.isFrontFaceCCW&&(i.frontFace(C.isFrontFaceCCW?i.CCW:i.CW),e.stateCache.rs.isFrontFaceCCW=C.isFrontFaceCCW),e.stateCache.rs.depthBias===C.depthBias&&e.stateCache.rs.depthBiasSlop===C.depthBiasSlop||(i.polygonOffset(C.depthBias,C.depthBiasSlop),e.stateCache.rs.depthBias=C.depthBias,e.stateCache.rs.depthBiasSlop=C.depthBiasSlop),e.stateCache.rs.lineWidth!==C.lineWidth&&(i.lineWidth(C.lineWidth),e.stateCache.rs.lineWidth=C.lineWidth)}var k=E.gpuPipelineState.dss;k&&(n.dss.depthTest!==k.depthTest&&(k.depthTest?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),n.dss.depthTest=k.depthTest),n.dss.depthWrite!==k.depthWrite&&(i.depthMask(k.depthWrite),n.dss.depthWrite=k.depthWrite),n.dss.depthFunc!==k.depthFunc&&(i.depthFunc(ZI[k.depthFunc]),n.dss.depthFunc=k.depthFunc),n.dss.stencilTestFront===k.stencilTestFront&&n.dss.stencilTestBack===k.stencilTestBack||(k.stencilTestFront||k.stencilTestBack?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST),n.dss.stencilTestFront=k.stencilTestFront,n.dss.stencilTestBack=k.stencilTestBack),n.dss.stencilFuncFront===k.stencilFuncFront&&n.dss.stencilRefFront===k.stencilRefFront&&n.dss.stencilReadMaskFront===k.stencilReadMaskFront||(i.stencilFuncSeparate(i.FRONT,ZI[k.stencilFuncFront],k.stencilRefFront,k.stencilReadMaskFront),n.dss.stencilFuncFront=k.stencilFuncFront,n.dss.stencilRefFront=k.stencilRefFront,n.dss.stencilReadMaskFront=k.stencilReadMaskFront),n.dss.stencilFailOpFront===k.stencilFailOpFront&&n.dss.stencilZFailOpFront===k.stencilZFailOpFront&&n.dss.stencilPassOpFront===k.stencilPassOpFront||(i.stencilOpSeparate(i.FRONT,JI[k.stencilFailOpFront],JI[k.stencilZFailOpFront],JI[k.stencilPassOpFront]),n.dss.stencilFailOpFront=k.stencilFailOpFront,n.dss.stencilZFailOpFront=k.stencilZFailOpFront,n.dss.stencilPassOpFront=k.stencilPassOpFront),n.dss.stencilWriteMaskFront!==k.stencilWriteMaskFront&&(i.stencilMaskSeparate(i.FRONT,k.stencilWriteMaskFront),n.dss.stencilWriteMaskFront=k.stencilWriteMaskFront),n.dss.stencilFuncBack===k.stencilFuncBack&&n.dss.stencilRefBack===k.stencilRefBack&&n.dss.stencilReadMaskBack===k.stencilReadMaskBack||(i.stencilFuncSeparate(i.BACK,ZI[k.stencilFuncBack],k.stencilRefBack,k.stencilReadMaskBack),n.dss.stencilFuncBack=k.stencilFuncBack,n.dss.stencilRefBack=k.stencilRefBack,n.dss.stencilReadMaskBack=k.stencilReadMaskBack),n.dss.stencilFailOpBack===k.stencilFailOpBack&&n.dss.stencilZFailOpBack===k.stencilZFailOpBack&&n.dss.stencilPassOpBack===k.stencilPassOpBack||(i.stencilOpSeparate(i.BACK,JI[k.stencilFailOpBack],JI[k.stencilZFailOpBack],JI[k.stencilPassOpBack]),n.dss.stencilFailOpBack=k.stencilFailOpBack,n.dss.stencilZFailOpBack=k.stencilZFailOpBack,n.dss.stencilPassOpBack=k.stencilPassOpBack),n.dss.stencilWriteMaskBack!==k.stencilWriteMaskBack&&(i.stencilMaskSeparate(i.BACK,k.stencilWriteMaskBack),n.dss.stencilWriteMaskBack=k.stencilWriteMaskBack));var R=E.gpuPipelineState.bs;if(R){n.bs.isA2C!==R.isA2C&&(R.isA2C?i.enable(i.SAMPLE_ALPHA_TO_COVERAGE):i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),n.bs.isA2C=R.isA2C),n.bs.blendColor[0]===R.blendColor[0]&&n.bs.blendColor[1]===R.blendColor[1]&&n.bs.blendColor[2]===R.blendColor[2]&&n.bs.blendColor[3]===R.blendColor[3]||(i.blendColor(R.blendColor[0],R.blendColor[1],R.blendColor[2],R.blendColor[3]),n.bs.blendColor[0]=R.blendColor[0],n.bs.blendColor[1]=R.blendColor[1],n.bs.blendColor[2]=R.blendColor[2],n.bs.blendColor[3]=R.blendColor[3]);var O=R.targets[0],M=n.bs.targets[0];M.blend!==O.blend&&(O.blend?i.enable(i.BLEND):i.disable(i.BLEND),M.blend=O.blend),M.blendEq===O.blendEq&&M.blendAlphaEq===O.blendAlphaEq||(i.blendEquationSeparate($I[O.blendEq],$I[O.blendAlphaEq]),M.blendEq=O.blendEq,M.blendAlphaEq=O.blendAlphaEq),M.blendSrc===O.blendSrc&&M.blendDst===O.blendDst&&M.blendSrcAlpha===O.blendSrcAlpha&&M.blendDstAlpha===O.blendDstAlpha||(i.blendFuncSeparate(eB[O.blendSrc],eB[O.blendDst],eB[O.blendSrcAlpha],eB[O.blendDstAlpha]),M.blendSrc=O.blendSrc,M.blendDst=O.blendDst,M.blendSrcAlpha=O.blendSrcAlpha,M.blendDstAlpha=O.blendDstAlpha),M.blendColorMask!==O.blendColorMask&&(i.colorMask((O.blendColorMask&Ou.R)!==Ou.NONE,(O.blendColorMask&Ou.G)!==Ou.NONE,(O.blendColorMask&Ou.B)!==Ou.NONE,(O.blendColorMask&Ou.A)!==Ou.NONE),M.blendColorMask=O.blendColorMask)}}if(E.gpuBindingLayout&&s){var I=E.gpuBindingLayout.gpuBindings,B=Array.isArray(I),L=0;for(I=B?I:I[Symbol.iterator]();;){var P;if(B){if(L>=I.length)break;P=I[L++]}else{if((L=I.next()).done)break;P=L.value}var F=P;switch(F.type){case Yu.UNIFORM_BUFFER:if(F.gpuBuffer){var z=s.glBlocks,D=Array.isArray(z),N=0;for(z=D?z:z[Symbol.iterator]();;){var U;if(D){if(N>=z.length)break;U=z[N++]}else{if((N=z.next()).done)break;U=N.value}var V=U;if(V.binding===F.binding){n.glBindUBOs[V.binding]!==F.gpuBuffer.glBuffer&&(i.bindBufferBase(i.UNIFORM_BUFFER,V.binding,F.gpuBuffer.glBuffer),n.glBindUBOs[V.binding]=F.gpuBuffer.glBuffer,n.glUniformBuffer=F.gpuBuffer.glBuffer);break}}}break;case Yu.SAMPLER:if(F.gpuSampler){var G=null,H=s.glSamplers,W=Array.isArray(H),q=0;for(H=W?H:H[Symbol.iterator]();;){var j;if(W){if(q>=H.length)break;j=H[q++]}else{if((q=H.next()).done)break;j=q.value}var X=j;if(X.binding===F.binding){G=X;break}}if(G){var Y=G.units,K=Array.isArray(Y),Q=0;for(Y=K?Y:Y[Symbol.iterator]();;){var Z;if(K){if(Q>=Y.length)break;Z=Y[Q++]}else{if((Q=Y.next()).done)break;Z=Q.value}var J=Z,$=n.glTexUnits[J];if(F.gpuTexView&&0<F.gpuTexView.gpuTexture.size){var ee=F.gpuTexView.gpuTexture;$.glTexture!==ee.glTexture&&(n.texUnit!==J&&(i.activeTexture(i.TEXTURE0+J),n.texUnit=J),ee.glTexture?i.bindTexture(ee.glTarget,ee.glTexture):i.bindTexture(ee.glTarget,e.nullTex2D.gpuTexture.glTexture),$.glTexture=ee.glTexture);var te=F.gpuSampler;n.glSamplerUnits[J]!==te.glSampler&&(i.bindSampler(J,te.glSampler),n.glSamplerUnits[J]=te.glSampler)}}}}else console.error("Not found sampler on binding unit "+F.binding)}}}if(E.gpuInputAssembler&&s&&(o||l!==E.gpuInputAssembler))if(l=E.gpuInputAssembler,e.useVAO){var ie=l.glVAOs.get(s.glProgram);if(!ie){ie=i.createVertexArray(),l.glVAOs.set(s.glProgram,ie),i.bindVertexArray(ie),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);var ne=void 0,re=s.glInputs,ae=Array.isArray(re),se=0;for(re=ae?re:re[Symbol.iterator]();;){var oe;if(ae){if(se>=re.length)break;oe=re[se++]}else{if((se=re.next()).done)break;oe=se.value}var le=oe;ne=null;var ue=l.glAttribs,ce=Array.isArray(ue),he=0;for(ue=ce?ue:ue[Symbol.iterator]();;){var fe;if(ce){if(he>=ue.length)break;fe=ue[he++]}else{if((he=ue.next()).done)break;fe=he.value}var de=fe;if(de.name===le.name){ne=de;break}}if(ne){i.bindBuffer(i.ARRAY_BUFFER,ne.glBuffer);for(var _e=0;_e<ne.componentCount;++_e){var pe=le.glLoc+_e,ve=ne.offset+ne.size*_e;i.enableVertexAttribArray(pe),n.glCurrentAttribLocs[pe]=!0,i.vertexAttribPointer(pe,ne.count,ne.glType,ne.isNormalized,ne.stride,ve),i.vertexAttribDivisor(pe,ne.isInstanced?1:0)}}}var me=l.gpuIndexBuffer;me&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,me.glBuffer),i.bindVertexArray(null),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),n.glArrayBuffer=null,n.glElementArrayBuffer=null}n.glVAO!==ie&&(i.bindVertexArray(ie),n.glVAO=ie)}else{for(var ye=0;ye<e.maxVertexAttributes;++ye)n.glCurrentAttribLocs[ye]=!1;var ge=s.glInputs,be=Array.isArray(ge),xe=0;for(ge=be?ge:ge[Symbol.iterator]();;){var Se;if(be){if(xe>=ge.length)break;Se=ge[xe++]}else{if((xe=ge.next()).done)break;Se=xe.value}var Te=Se,we=null,Ee=l.glAttribs,Ae=Array.isArray(Ee),Ce=0;for(Ee=Ae?Ee:Ee[Symbol.iterator]();;){var ke;if(Ae){if(Ce>=Ee.length)break;ke=Ee[Ce++]}else{if((Ce=Ee.next()).done)break;ke=Ce.value}var Re=ke;if(Re.name===Te.name){we=Re;break}}if(we){n.glArrayBuffer!==we.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,we.glBuffer),n.glArrayBuffer=we.glBuffer);for(var Oe=0;Oe<we.componentCount;++Oe){var Me=Te.glLoc+Oe,Ie=we.offset+we.size*Oe;!n.glEnabledAttribLocs[Me]&&0<=Me&&(i.enableVertexAttribArray(Me),n.glEnabledAttribLocs[Me]=!0),n.glCurrentAttribLocs[Me]=!0,i.vertexAttribPointer(Me,we.count,we.glType,we.isNormalized,we.stride,Ie)}}}var Be=l.gpuIndexBuffer;Be&&n.glElementArrayBuffer!==Be.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,Be.glBuffer),n.glElementArrayBuffer=Be.glBuffer);for(var Le=0;Le<e.maxVertexAttributes;++Le)n.glEnabledAttribLocs[Le]!==n.glCurrentAttribLocs[Le]&&(i.disableVertexAttribArray(Le),n.glEnabledAttribLocs[Le]=!1)}if(a){var Pe=a.dynamicStates,Fe=Array.isArray(Pe),ze=0;for(Pe=Fe?Pe:Pe[Symbol.iterator]();;){var De;if(Fe){if(ze>=Pe.length)break;De=Pe[ze++]}else{if((ze=Pe.next()).done)break;De=ze.value}switch(De){case sc.VIEWPORT:E.viewport&&(n.viewport.left===E.viewport.left&&n.viewport.top===E.viewport.top&&n.viewport.width===E.viewport.width&&n.viewport.height===E.viewport.height||(i.viewport(E.viewport.left,E.viewport.top,E.viewport.width,E.viewport.height),n.viewport.left=E.viewport.left,n.viewport.top=E.viewport.top,n.viewport.width=E.viewport.width,n.viewport.height=E.viewport.height));break;case sc.SCISSOR:E.scissor&&(n.scissorRect.x===E.scissor.x&&n.scissorRect.y===E.scissor.y&&n.scissorRect.width===E.scissor.width&&n.scissorRect.height===E.scissor.height||(i.scissor(E.scissor.x,E.scissor.y,E.scissor.width,E.scissor.height),n.scissorRect.x=E.scissor.x,n.scissorRect.y=E.scissor.y,n.scissorRect.width=E.scissor.width,n.scissorRect.height=E.scissor.height));break;case sc.LINE_WIDTH:E.lineWidth&&n.rs.lineWidth!==E.lineWidth&&(i.lineWidth(E.lineWidth),n.rs.lineWidth=E.lineWidth);break;case sc.DEPTH_BIAS:E.depthBias&&(n.rs.depthBias===E.depthBias.constantFactor&&n.rs.depthBiasSlop===E.depthBias.slopeFactor||(i.polygonOffset(E.depthBias.constantFactor,E.depthBias.slopeFactor),n.rs.depthBias=E.depthBias.constantFactor,n.rs.depthBiasSlop=E.depthBias.slopeFactor));break;case sc.BLEND_CONSTANTS:E.blendConstants&&(n.bs.blendColor[0]===E.blendConstants[0]&&n.bs.blendColor[1]===E.blendConstants[1]&&n.bs.blendColor[2]===E.blendConstants[2]&&n.bs.blendColor[3]===E.blendConstants[3]||(i.blendColor(E.blendConstants[0],E.blendConstants[1],E.blendConstants[2],E.blendConstants[3]),n.bs.blendColor[0]=E.blendConstants[0],n.bs.blendColor[1]=E.blendConstants[1],n.bs.blendColor[2]=E.blendConstants[2],n.bs.blendColor[3]=E.blendConstants[3]));break;case sc.STENCIL_WRITE_MASK:if(E.stencilWriteMask)switch(E.stencilWriteMask.face){case lc.FRONT:n.dss.stencilWriteMaskFront!==E.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.FRONT,E.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=E.stencilWriteMask.writeMask);break;case lc.BACK:n.dss.stencilWriteMaskBack!==E.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.BACK,E.stencilWriteMask.writeMask),n.dss.stencilWriteMaskBack=E.stencilWriteMask.writeMask);break;case lc.ALL:n.dss.stencilWriteMaskFront===E.stencilWriteMask.writeMask&&n.dss.stencilWriteMaskBack===E.stencilWriteMask.writeMask||(i.stencilMask(E.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=E.stencilWriteMask.writeMask,n.dss.stencilWriteMaskBack=E.stencilWriteMask.writeMask)}break;case sc.STENCIL_COMPARE_MASK:if(E.stencilCompareMask)switch(E.stencilCompareMask.face){case lc.FRONT:n.dss.stencilRefFront===E.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===E.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.FRONT,ZI[n.dss.stencilFuncFront],E.stencilCompareMask.reference,E.stencilCompareMask.compareMask),n.dss.stencilRefFront=E.stencilCompareMask.reference,n.dss.stencilReadMaskFront=E.stencilCompareMask.compareMask);break;case lc.BACK:n.dss.stencilRefBack===E.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===E.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.BACK,ZI[n.dss.stencilFuncBack],E.stencilCompareMask.reference,E.stencilCompareMask.compareMask),n.dss.stencilRefBack=E.stencilCompareMask.reference,n.dss.stencilReadMaskBack=E.stencilCompareMask.compareMask);break;case lc.ALL:n.dss.stencilRefFront===E.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===E.stencilCompareMask.compareMask&&n.dss.stencilRefBack===E.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===E.stencilCompareMask.compareMask||(i.stencilFunc(ZI[n.dss.stencilFuncBack],E.stencilCompareMask.reference,E.stencilCompareMask.compareMask),n.dss.stencilRefFront=E.stencilCompareMask.reference,n.dss.stencilReadMaskFront=E.stencilCompareMask.compareMask,n.dss.stencilRefBack=E.stencilCompareMask.reference,n.dss.stencilReadMaskBack=E.stencilCompareMask.compareMask)}}}}break;case KI.DRAW:var Ne=t.drawCmds.array[f];if(l&&s)if(l.gpuIndirectBuffer){if(l.gpuIndirectBuffer){var Ue=l.gpuIndirectBuffer.indirects,Ve=Array.isArray(Ue),Ge=0;for(Ue=Ve?Ue:Ue[Symbol.iterator]();;){var He;if(Ve){if(Ge>=Ue.length)break;He=Ue[Ge++]}else{if((Ge=Ue.next()).done)break;He=Ge.value}var We=He,qe=l.gpuIndexBuffer;if(qe&&-1<We.indexCount){var je=We.firstIndex*qe.stride;i.drawElements(u,We.indexCount,l.glIndexType,je)}else i.drawArrays(u,We.firstVertex,We.vertexCount)}}}else if(l.gpuIndexBuffer&&-1<Ne.drawInfo.indexCount){var Xe=Ne.drawInfo.firstIndex*l.gpuIndexBuffer.stride;i.drawElements(u,Ne.drawInfo.indexCount,l.glIndexType,Xe)}else i.drawArrays(u,Ne.drawInfo.firstVertex,Ne.drawInfo.vertexCount);break;case KI.UPDATE_BUFFER:var Ye=t.updateBufferCmds.array[f];lB(e,Ye.gpuBuffer,Ye.buffer,Ye.offset,Ye.size);break;case KI.COPY_BUFFER_TO_TEXTURE:var Ke=t.copyBufferToTextureCmds.array[f];hB(e,[Ke.gpuBuffer.buffer],Ke.gpuTexture,Ke.regions)}}}function hB(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var s=0,o=0,l=1,u=1,c=0,h=xc[i.format],f=h.isCompressed;switch(i.glTarget){case r.TEXTURE_2D:var d=n,_=Array.isArray(d),p=0;for(d=_?d:d[Symbol.iterator]();;){var v;if(_){if(p>=d.length)break;v=d[p++]}else{if((p=d.next()).done)break;v=p.value}var m=v;for(l=m.texExtent.width,u=m.texExtent.height,s=m.texSubres.baseMipLevel;s<m.texSubres.levelCount;++s){var y=h.type!==vc.FLOAT||f?new Uint8Array(t[o++]):new Float32Array(t[o++]);f?i.glInternelFmt!==GM.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,s,m.texOffset.x,m.texOffset.y,l,u,i.glFormat,y):r.compressedTexImage2D(r.TEXTURE_2D,s,i.glInternelFmt,l,u,0,y):r.texSubImage2D(r.TEXTURE_2D,s,m.texOffset.x,m.texOffset.y,l,u,i.glFormat,i.glType,y),l=Math.max(1,l>>1),u=Math.max(1,l>>1)}}break;case r.TEXTURE_CUBE_MAP:var g=n,b=Array.isArray(g),x=0;for(g=b?g:g[Symbol.iterator]();;){var S;if(b){if(x>=g.length)break;S=g[x++]}else{if((x=g.next()).done)break;S=x.value}var T=S;o=0;var w=T.texSubres.baseArrayLayer+T.texSubres.layerCount;for(c=T.texSubres.baseArrayLayer;c<w;++c){l=T.texExtent.width,u=T.texExtent.height;var E=T.texSubres.baseMipLevel+T.texSubres.levelCount;for(s=T.texSubres.baseMipLevel;s<E;++s){var A=h.type!==vc.FLOAT||f?new Uint8Array(t[o++]):new Float32Array(t[o++]);f?i.glInternelFmt!==GM.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,T.texOffset.x,T.texOffset.y,l,u,i.glFormat,A):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,i.glInternelFmt,l,u,0,A):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,T.texOffset.x,T.texOffset.y,l,u,i.glFormat,i.glType,A),l=Math.max(1,l>>1),u=Math.max(1,l>>1)}}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Gu.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}function fB(){y(this,fB),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=void 0,this.glVAO=null,this.texUnit=0,this.glTexUnits=void 0,this.glSamplerUnits=void 0,this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=void 0,this.scissorRect=void 0,this.rs=void 0,this.dss=void 0,this.bs=void 0,this.glProgram=null,this.glEnabledAttribLocs=void 0,this.glCurrentAttribLocs=void 0,this.glBindUBOs=new Array($l),this.glBindUBOs.fill(null),this.glTexUnits=new Array(Zl),this.glSamplerUnits=new Array(Zl),this.glSamplerUnits.fill(null),this.viewport={left:0,top:0,width:0,height:0,minDepth:0,maxDepth:0},this.scissorRect={x:0,y:0,width:0,height:0},this.rs=new yd,this.dss=new gd,this.bs=new _d,this.glEnabledAttribLocs=new Array(Ql),this.glCurrentAttribLocs=new Array(Ql),this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.fill(!1);for(var e=0;e<Zl;++e)this.glTexUnits[e]={glTexture:null}}var dB=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuBuffer=null,t._indirectBuffer=null,t}return _(i,tf),l(i,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),l(i,[{key:"initialize",value:function(e){return this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=void 0!==e.flags?e.flags:cu.NONE,this._usage&su.INDIRECT&&(this._indirectBuffer={drawInfos:[]}),this._flags&cu.BAKUP_BUFFER&&(this._bufferView=new Uint8Array(this._size)),this._gpuBuffer={usage:e.usage,memUsage:e.memUsage,size:e.size,stride:this._stride,buffer:null,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&su.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&lu.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&su.VERTEX){t.glTarget=i.ARRAY_BUFFER;var a=i.createBuffer();a&&(t.glBuffer=a,0<t.size&&(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&su.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;var s=i.createBuffer();s&&(t.glBuffer=s,0<t.size&&(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&su.UNIFORM){t.glTarget=i.UNIFORM_BUFFER;var o=i.createBuffer();o&&0<t.size&&(t.glBuffer=o,e.stateCache.glUniformBuffer!==t.glBuffer&&(i.bindBuffer(i.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),i.bufferData(i.UNIFORM_BUFFER,t.size,r),i.bindBuffer(i.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&su.INDIRECT||t.usage&su.TRANSFER_DST||t.usage&su.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size,this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBuffer&&(function(e,t){t.glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._bufferView=null,this._status=Yl.UNREADY}},{key:"resize",value:function(e){var t=this._size;if(this._size=e,this._count=this._size/this._stride,this._bufferView&&t!==e){var i=this._bufferView;this._bufferView=new Uint8Array(this._size),this._bufferView.set(i),this._gpuBuffer&&(this._gpuBuffer.buffer=this._bufferView.buffer)}this._gpuBuffer&&(this._gpuBuffer.size=this._size,0<this._size&&(function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&lu.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;t.usage&su.VERTEX?(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),n.glArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ARRAY_BUFFER,t.buffer,r):i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),n.glArrayBuffer=null):t.usage&su.INDEX?(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.buffer,r):i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&su.UNIFORM?(e.stateCache.glUniformBuffer!==t.glBuffer&&i.bindBuffer(i.UNIFORM_BUFFER,t.glBuffer),i.bufferData(i.UNIFORM_BUFFER,t.size,r),i.bindBuffer(i.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null):(t.usage&su.INDIRECT||t.usage&su.TRANSFER_DST||t.usage&su.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=this._size,this._bufferView&&(this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=this._size)))}},{key:"update",value:function(e,t,i){var n;if(n=void 0!==i?i:this._usage&su.INDIRECT?0:e.byteLength,this._bufferView){var r=new Uint8Array(e,0,i);this._bufferView.set(r,t)}lB(this._device,this._gpuBuffer,e,t||0,n)}}]),i}(),_B=function(){function n(e,t){y(this,n),this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new Ug(t);for(var i=0;i<t;++i)this._frees[i]=new e;this._freeIdx=t-1}return l(n,[{key:"alloc",value:function(e){if(this._freeIdx<0){var t=2*this._frees.length,i=this._frees;this._frees=new Array(t);for(var n=t-i.length,r=0;r<n;++r)this._frees[r]=new e;for(var a=n,s=0;a<t;++a,++s)this._frees[a]=i[s];this._freeIdx+=n}var o=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++o.refCount,o}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),n}(),pB=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e))).beginRenderPassCmdPool=void 0,t.bindStatesCmdPool=void 0,t.drawCmdPool=void 0,t.updateBufferCmdPool=void 0,t.copyBufferToTextureCmdPool=void 0,t.beginRenderPassCmdPool=new _B(iB,1),t.bindStatesCmdPool=new _B(nB,1),t.drawCmdPool=new _B(rB,1),t.updateBufferCmdPool=new _B(aB,1),t.copyBufferToTextureCmdPool=new _B(sB,1),t}return _(i,yI),l(i,[{key:"initialize",value:function(e){return this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Yl.UNREADY}},{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}]),i}(),vB=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e))).cmdPackage=new oB,t._webGLAllocator=null,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUBindingLayout=null,t._curGPUInputAssembler=null,t._curViewport=null,t._curScissor=null,t._curLineWidth=null,t._curDepthBias=null,t._curBlendConstants=[],t._curDepthBounds=null,t._curStencilWriteMask=null,t._curStencilCompareMask=null,t._isStateInvalied=!1,t}return _(i,nf),l(i,[{key:"initialize",value:function(e){return!!e.allocator&&(this._allocator=e.allocator,this._webGLAllocator=this._allocator,this._type=e.type,this._status=Yl.SUCCESS,!0)}},{key:"destroy",value:function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._allocator=null,this._webGLAllocator=null),this._status=Yl.UNREADY}},{key:"begin",value:function(){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUBindingLayout=null,this._curGPUInputAssembler=null,this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants=[],this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,i,n,r,a){var s=this._webGLAllocator.beginRenderPassCmdPool.alloc(iB);s.gpuFramebuffer=e.gpuFramebuffer,s.renderArea=t,s.clearFlag=i;for(var o=0;o<n.length;++o)s.clearColors[o]=n[o];s.clearDepth=r,s.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(s),this.cmdPackage.cmds.push(KI.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;this._curGPUPipelineState=t,this._isStateInvalied=!0}},{key:"bindBindingLayout",value:function(e){var t=e.gpuBindingLayout;this._curGPUBindingLayout=t,this._isStateInvalied=!0}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport={left:e.left,top:e.top,width:e.width,height:e.height,minDepth:e.minDepth,maxDepth:e.maxDepth},this._curViewport!==e&&(this._curViewport=e,this._isStateInvalied=!0)}},{key:"setScissor",value:function(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor={x:e.x,y:e.y,width:e.width,height:e.height}}},{key:"setLineWidth",value:function(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,i){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===i||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=i,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:i},this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){(this._curBlendConstants||4!==e.length)&&(4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3])||(this._curBlendConstants=[e[0],e[1],e[2],e[3]],this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,i){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===i||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=i,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:i},this._isStateInvalied=!0)}},{key:"draw",value:function(e){if(this._type===Qu.PRIMARY&&this._isInRenderPass||this._type===Qu.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._allocator.drawCmdPool.alloc(rB);if(e.extractCmdDraw(t),this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(KI.DRAW),++this._numDrawCalls,this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case WebGL2RenderingContext.TRIANGLES:this._numTris+=e.indexCount/3*Math.max(e.instanceCount,1);break;case WebGL2RenderingContext.TRIANGLE_STRIP:case WebGL2RenderingContext.TRIANGLE_FAN:this._numTris+=(e.indexCount-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i,n){if(this._type===Qu.PRIMARY&&!this._isInRenderPass||this._type===Qu.SECONDARY){var r=e.gpuBuffer;if(r){var a,s=this._webGLAllocator.updateBufferCmdPool.alloc(aB);a=void 0!==n?n:e.usage&su.INDIRECT?0:t.byteLength;var o=t;s.gpuBuffer=r,s.buffer=o,s.offset=void 0!==i?i:0,s.size=a,this.cmdPackage.updateBufferCmds.push(s),this.cmdPackage.cmds.push(KI.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBufferToTexture",value:function(e,t,i,n){if(this._type===Qu.PRIMARY&&!this._isInRenderPass||this._type===Qu.SECONDARY){var r=e.gpuBuffer,a=t.gpuTexture;if(r&&a){var s=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(sB);s.gpuBuffer=r,s.gpuTexture=a,s.dstLayout=i,s.regions=n,this.cmdPackage.copyBufferToTextureCmds.push(s),this.cmdPackage.cmds.push(KI.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){for(var n=e[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var a=n.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var s=0;s<n.cmdPackage.bindStatesCmds.length;++s){var o=n.cmdPackage.bindStatesCmds.array[s];++o.refCount,this.cmdPackage.bindStatesCmds.push(o)}for(var l=0;l<n.cmdPackage.drawCmds.length;++l){var u=n.cmdPackage.drawCmds.array[l];++u.refCount,this.cmdPackage.drawCmds.push(u)}for(var c=0;c<n.cmdPackage.updateBufferCmds.length;++c){var h=n.cmdPackage.updateBufferCmds.array[c];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var f=0;f<n.cmdPackage.copyBufferToTextureCmds.length;++f){var d=n.cmdPackage.copyBufferToTextureCmds.array[f];++d.refCount,this.cmdPackage.copyBufferToTextureCmds.push(d)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds),this._numDrawCalls+=n._numDrawCalls,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(nB);e.gpuPipelineState=this._curGPUPipelineState,e.gpuBindingLayout=this._curGPUBindingLayout,e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,e.blendConstants=this._curBlendConstants,e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(KI.BIND_STATES),this._isStateInvalied=!1}},{key:"webGLDevice",get:function(){return this._device}}]),i}(),mB=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuFramebuffer=null,t}return _(i,rf),l(i,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),l(i,[{key:"initialize",value:function(e){if(this._renderPass=e.renderPass,this._colorViews=e.colorViews||[],this._depthStencilView=e.depthStencilView||null,this._isOffscreen=void 0===e.isOffscreen||e.isOffscreen,this._isOffscreen){var t=[];if(void 0!==e.colorViews){var i=e.colorViews,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t.push(s.gpuTextureView)}}var o=null;e.depthStencilView&&(o=e.depthStencilView.gpuTextureView),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:t,gpuDepthStencilView:o,isOffscreen:this._isOffscreen,glFramebuffer:null},function(e,t){if(t.isOffscreen){var i=e.gl,n=[],r=i.createFramebuffer();if(r){t.glFramebuffer=r,e.stateCache.glFramebuffer!==t.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer),e.stateCache.glFramebuffer=t.glFramebuffer);for(var a=0;a<t.gpuColorViews.length;++a){var s=t.gpuColorViews[a];s&&(s.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.gpuTexture.glTarget,s.gpuTexture.glTexture,s.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.gpuTexture.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+a))}var o=t.gpuDepthStencilView;if(o){var l=xc[o.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;o.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,o.gpuTexture.glTarget,o.gpuTexture.glTexture,o.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,o.gpuTexture.glRenderbuffer)}i.drawBuffers(n);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}}}}(this._device,this._gpuFramebuffer)}else this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:[],gpuDepthStencilView:null,isOffscreen:e.isOffscreen,glFramebuffer:null};return this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._isOffscreen&&this._gpuFramebuffer&&function(e,t){t.glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null)}(this._device,this._gpuFramebuffer),this._gpuFramebuffer=null,this._status=Yl.UNREADY}}]),i}(),yB=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuInputAssembler=null,t}return _(i,vd),l(i,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),l(i,[{key:"initialize",value:function(e){if(0===e.vertexBuffers.length)return console.error("GFXInputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._vertexBuffers=e.vertexBuffers,void 0!==e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride}this._indirectBuffer=e.indirectBuffer||null;for(var i=new Array(e.vertexBuffers.length),n=0;n<e.vertexBuffers.length;++n){var r=e.vertexBuffers[n];r.gpuBuffer&&(i[n]=r.gpuBuffer)}var a=null,s=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:s=5121;break;case 2:s=5123;break;case 4:s=5125;break;default:console.error("Illegal index buffer stride.")}var o=null;return void 0!==e.indirectBuffer&&(o=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:i,gpuIndexBuffer:a,gpuIndirectBuffer:o,glAttribs:[],glIndexType:s,glVAOs:new Map},function(e,t){var i=e.gl;t.glAttribs=new Array(t.attributes.length);for(var n=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],s=void 0!==a.stream?a.stream:0,o=t.gpuVertexBuffers[s],l=GI(a.format,i),u=xc[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:o.glBuffer,glType:l,size:u,count:xc[a.format].count,stride:o.stride,componentCount:YI(l,i),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:n[s]},n[s]+=u}}(this._device,this._gpuInputAssembler),this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){var i=t.glVAOs,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;e.gl.deleteVertexArray(s[1])}t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null,this._status=Yl.UNREADY}},{key:"extractCmdDraw",value:function(e){e.drawInfo.vertexCount=this._vertexCount,e.drawInfo.firstVertex=this._firstVertex,e.drawInfo.indexCount=this._indexCount,e.drawInfo.firstIndex=this._firstIndex,e.drawInfo.vertexOffset=this._vertexOffset,e.drawInfo.instanceCount=this._instanceCount,e.drawInfo.firstInstance=this._firstInstance}}]),i}(),gB=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuPipelineLayout=null,t}return _(i,md),l(i,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),l(i,[{key:"initialize",value:function(e){return this._layouts=e.layouts,this._pushConstantsRanges=e.pushConstantsRanges||[],this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Yl.UNREADY}}]),i}(),bB=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],xB=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuPipelineState=null,t}return _(i,xd),l(i,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),l(i,[{key:"initialize",value:function(e){return this._primitive=e.primitive,this._shader=e.shader,this._is=e.is,this._rs=e.rs,this._dss=e.dss,this._bs=e.bs,this._dynamicStates=e.dynamicStates||[],this._layout=e.layout,this._renderPass=e.renderPass,this._gpuPipelineState={glPrimitive:bB[e.primitive],gpuShader:e.shader.gpuShader,rs:e.rs,dss:e.dss,bs:e.bs,dynamicStates:void 0!==e.dynamicStates?e.dynamicStates:[],gpuLayout:e.layout.gpuPipelineLayout,gpuRenderPass:e.renderPass.gpuRenderPass},this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuPipelineState=null,this._status=Yl.UNREADY}}]),i}(),SB=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e))).numDrawCalls=0,t.numTris=0,t._isAsync=!1,t}return _(i,Sd),l(i,[{key:"initialize",value:function(e){return this._type=e.type,this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._status=Yl.UNREADY}},{key:"submit",value:function(e,t){if(!this._isAsync){var i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;cB(this._device,s.cmdPackage),this.numDrawCalls+=s.numDrawCalls,this.numTris+=s.numTris}}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numTris=0}}]),i}(),TB=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuRenderPass=null,t}return _(i,Td),l(i,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),l(i,[{key:"initialize",value:function(e){return this._colorInfos=e.colorAttachments||[],this._depthStencilInfo=e.depthStencilAttachment||null,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuRenderPass=null,this._status=Yl.UNREADY}}]),i}(),wB=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuSampler=null,t._state=new wd,t}return _(i,Ed),l(i,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),l(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._state.name=e.name),void 0!==e.minFilter&&(this._state.minFilter=e.minFilter),void 0!==e.magFilter&&(this._state.magFilter=e.magFilter),void 0!==e.mipFilter&&(this._state.mipFilter=e.mipFilter),void 0!==e.addressU&&(this._state.addressU=e.addressU),void 0!==e.addressV&&(this._state.addressV=e.addressV),void 0!==e.addressW&&(this._state.addressW=e.addressW),void 0!==e.maxAnisotropy&&(this._state.maxAnisotropy=e.maxAnisotropy),void 0!==e.cmpFunc&&(this._state.cmpFunc=e.cmpFunc),void 0!==e.borderColor&&(this._state.borderColor=e.borderColor),void 0!==e.minLOD&&(this._state.minLOD=e.minLOD),void 0!==e.maxLOD&&(this._state.maxLOD=e.maxLOD),void 0!==e.mipLODBias&&(this._state.mipLODBias=e.mipLODBias),this._gpuSampler={glSampler:null,minFilter:this._state.minFilter,magFilter:this._state.magFilter,mipFilter:this._state.mipFilter,addressU:this._state.addressU,addressV:this._state.addressV,addressW:this._state.addressW,minLOD:this._state.minLOD,maxLOD:this._state.maxLOD,glMinFilter:WebGL2RenderingContext.NONE,glMagFilter:WebGL2RenderingContext.NONE,glWrapS:WebGL2RenderingContext.NONE,glWrapT:WebGL2RenderingContext.NONE,glWrapR:WebGL2RenderingContext.NONE},function(e,t){var i=e.gl,n=i.createSampler();n&&(t.minFilter===Iu.LINEAR||t.minFilter===Iu.ANISOTROPIC?t.mipFilter===Iu.LINEAR||t.mipFilter===Iu.ANISOTROPIC?t.glMinFilter=i.LINEAR_MIPMAP_LINEAR:t.mipFilter===Iu.POINT?t.glMinFilter=i.LINEAR_MIPMAP_NEAREST:t.glMinFilter=i.LINEAR:t.mipFilter===Iu.LINEAR||t.mipFilter===Iu.ANISOTROPIC?t.glMinFilter=i.NEAREST_MIPMAP_LINEAR:t.mipFilter===Iu.POINT?t.glMinFilter=i.NEAREST_MIPMAP_NEAREST:t.glMinFilter=i.NEAREST,t.magFilter===Iu.LINEAR||t.magFilter===Iu.ANISOTROPIC?t.glMagFilter=WebGLRenderingContext.LINEAR:t.glMagFilter=WebGLRenderingContext.NEAREST,t.glWrapS=NI[t.addressU],t.glWrapT=NI[t.addressV],t.glWrapR=NI[t.addressW],t.glSampler=n,i.samplerParameteri(n,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.samplerParameteri(n,i.TEXTURE_MAG_FILTER,t.glMagFilter),i.samplerParameteri(n,i.TEXTURE_WRAP_S,t.glWrapS),i.samplerParameteri(n,i.TEXTURE_WRAP_T,t.glWrapT),i.samplerParameteri(n,i.TEXTURE_WRAP_R,t.glWrapR),i.samplerParameterf(n,i.TEXTURE_MIN_LOD,t.minLOD),i.samplerParameterf(n,i.TEXTURE_MAX_LOD,t.maxLOD))}(this._device,this._gpuSampler),this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuSampler&&(function(e,t){t.glSampler&&(e.gl.deleteSampler(t.glSampler),t.glSampler=null)}(this._device,this._gpuSampler),this._gpuSampler=null),this._status=Yl.UNREADY}}]),i}(),EB=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuShader=null,t}return _(i,Ad),l(i,[{key:"gpuShader",get:function(){return this._gpuShader}}]),l(i,[{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,void 0!==e.blocks&&(this._blocks=e.blocks),void 0!==e.samplers&&(this._samplers=e.samplers),this._gpuShader={name:e.name?e.name:"",blocks:void 0!==e.blocks?e.blocks:[],samplers:void 0!==e.samplers?e.samplers:[],gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(var t=0;t<e.stages.length;++t){var i=e.stages[t];this._gpuShader.gpuStages[t]={type:i.type,source:i.source,macros:i.macros?i.macros:[],glShader:null}}return function(e,a){function t(){if(l){if(u>=o.length)return"break";c=o[u++]}else{if((u=o.next()).done)return"break";c=u.value}var e=c,t=0,i="",n=1;switch(e.type){case ju.VERTEX:i="VertexShader",t=s.VERTEX_SHADER;break;case ju.FRAGMENT:i="FragmentShader",t=s.FRAGMENT_SHADER;break;default:return console.error("Unsupported GFXShaderType."),{v:void 0}}var r=s.createShader(t);if(r&&(e.glShader=r,s.shaderSource(e.glShader,e.source),s.compileShader(e.glShader),!s.getShaderParameter(e.glShader,s.COMPILE_STATUS)))return console.error(i+" in '"+a.name+"' compilation failed."),console.error("Shader source dump:",e.source.replace(/^|\n/g,function(){return"\n".concat(n++," ")})),console.error(s.getShaderInfoLog(e.glShader)),s.deleteShader(e.glShader),e.glShader=null,{v:void 0}}var s=e.gl,o=a.gpuStages,l=Array.isArray(o),u=0;e:for(o=l?o:o[Symbol.iterator]();;){var c,i=t();switch(i){case"break":break e;default:if("object"===be(i))return i.v}}var n=s.createProgram();if(n){a.glProgram=n;var r=a.gpuStages,h=Array.isArray(r),f=0;for(r=h?r:r[Symbol.iterator]();;){var d;if(h){if(f>=r.length)break;d=r[f++]}else{if((f=r.next()).done)break;d=f.value}var _=d;s.attachShader(a.glProgram,_.glShader)}if(s.linkProgram(a.glProgram),s.getProgramParameter(a.glProgram,s.LINK_STATUS)){console.info("Shader '"+a.name+"' compilation successed.");var p=s.getProgramParameter(a.glProgram,s.ACTIVE_ATTRIBUTES);a.glInputs=new Array(p);for(var v=0;v<p;++v){var m=s.getActiveAttrib(a.glProgram,v);if(m){var y=void 0,g=m.name.indexOf("[");y=-1!==g?m.name.substr(0,g):m.name;var b=s.getAttribLocation(a.glProgram,y),x=jI(m.type,s),S=XI(m.type,s);a.glInputs[v]={binding:b,name:y,type:x,stride:S,count:m.size,size:S*m.size,glType:m.type,glLoc:b}}}var T,w,E,A,C,k,R,O,M,I,B=s.getProgramParameter(a.glProgram,s.ACTIVE_UNIFORM_BLOCKS);if(B){a.glBlocks=new Array(B);for(var L=0;L<B;++L){var P=(T=s.getActiveUniformBlockName(a.glProgram,L)).indexOf("[");-1!==P&&(T=T.substr(0,P)),A=-1;var F=a.blocks,z=Array.isArray(F),D=0;for(F=z?F:F[Symbol.iterator]();;){var N;if(z){if(D>=F.length)break;N=F[D++]}else{if((D=F.next()).done)break;N=D.value}var U=N;if(U.name===T){A=U.binding;break}}if(0<=A){w=L,E=s.getActiveUniformBlockParameter(a.glProgram,w,s.UNIFORM_BLOCK_DATA_SIZE),C=s.getActiveUniformBlockParameter(a.glProgram,w,s.UNIFORM_BLOCK_ACTIVE_UNIFORMS),s.uniformBlockBinding(a.glProgram,w,A);var V={binding:A,idx:w,name:T,size:E,glUniforms:new Array(C),glActiveUniforms:[],isUniformPackage:!1};a.glBlocks[L]=V,k=s.getActiveUniformBlockParameter(a.glProgram,w,s.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES),R=new Array(k.length);for(var G=0;G<k.length;++G)R[G]=k[G];O=s.getActiveUniforms(a.glProgram,R,s.UNIFORM_SIZE),M=s.getActiveUniforms(a.glProgram,R,s.UNIFORM_OFFSET);for(var H=0;H<C;++H)if(I=s.getActiveUniform(a.glProgram,k[H])){var W=XI(I.type,s),q=O[H]*W,j=M[H]/4,X=new Array(q/4);X.fill(0),V.glUniforms[H]={binding:-1,name:I.name,type:jI(I.type,s),stride:W,count:I.size,size:q,offset:M[H],glType:I.type,glLoc:-1,array:X,begin:j}}}}}if(0<a.samplers.length){a.glSamplers=new Array(a.samplers.length);for(var Y=0;Y<a.samplers.length;++Y){var K=a.samplers[Y];a.glSamplers[Y]={binding:K.binding,name:K.name,type:K.type,units:[],glType:qI(K.type,s),glLoc:-1}}}for(var Q=s.getProgramParameter(a.glProgram,s.ACTIVE_UNIFORMS),Z=0,J=[],$=0;$<Q;++$){var ee=s.getActiveUniform(a.glProgram,$);if(ee){var te=s.getUniformLocation(a.glProgram,ee.name);if(te){var ie=void 0,ne=ee.name.indexOf("[");if(ie=-1!==ne?ee.name.substr(0,ne):ee.name,ee.type===s.SAMPLER_2D||ee.type===s.SAMPLER_CUBE){var re=a.glSamplers,ae=Array.isArray(re),se=0;for(re=ae?re:re[Symbol.iterator]();;){var oe;if(ae){if(se>=re.length)break;oe=re[se++]}else{if((se=re.next()).done)break;oe=se.value}var le=oe;if(le.name===ie){for(var ue=0;ue<ee.size;++ue)le.units.push(Z+ue);le.glLoc=te,Z+=ee.size,J.push(le);break}}}}}}if(J.length){e.stateCache.glProgram!==a.glProgram&&(s.useProgram(a.glProgram),e.stateCache.glProgram=a.glProgram);var ce=J,he=Array.isArray(ce),fe=0;for(ce=he?ce:ce[Symbol.iterator]();;){var de;if(he){if(fe>=ce.length)break;de=ce[fe++]}else{if((fe=ce.next()).done)break;de=fe.value}var _e=de;s.uniform1iv(_e.glLoc,_e.units)}}}else{console.error("Failed to link shader '"+a.name+"'."),console.error(s.getProgramInfoLog(a.glProgram));var pe=a.gpuStages,ve=Array.isArray(pe),me=0;for(pe=ve?pe:pe[Symbol.iterator]();;){var ye;if(ve){if(me>=pe.length)break;ye=pe[me++]}else{if((me=pe.next()).done)break;ye=me.value}var ge=ye;ge.glShader&&(s.deleteShader(ge.glShader),ge.glShader=null)}}}}(this._device,this._gpuShader),this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuShader&&(function(e,t){var i=t.gpuStages,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.glShader&&(e.gl.deleteShader(s.glShader),s.glShader=null)}t.glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null)}(this._device,this._gpuShader),this._gpuShader=null),this._status=Yl.UNREADY}}]),i}();function AB(e){return 0<e&&0==(e&e-1)}var CB=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuTexture=null,t}return _(i,Cd),l(i,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),l(i,[{key:"initialize",value:function(e){var t;switch(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,void 0!==e.depth&&(this._depth=e.depth),void 0!==e.arrayLayer&&(this._arrayLayer=e.arrayLayer),void 0!==e.mipLevel&&(this._mipLevel=e.mipLevel),void 0!==e.samples&&(this._samples=e.samples),void 0!==e.flags&&(this._flags=e.flags),this._isPowerOf2=AB(this._width)&&AB(this._height),this._size=Tc(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._flags&Gu.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),e.type){case Fu.TEX1D:t=e.arrayLayer?e.arrayLayer<=1?Wu.TV1D:Wu.TV1D_ARRAY:Wu.TV1D;break;case Fu.TEX2D:var i=Gu.NONE;e.flags&&(i=e.flags),t=e.arrayLayer?e.arrayLayer<=1?Wu.TV2D:i&Gu.CUBEMAP?Wu.CUBE:Wu.TV2D_ARRAY:Wu.TV2D;break;case Fu.TEX3D:t=Wu.TV3D;break;default:t=Wu.TV2D}return this._gpuTexture={type:this._type,viewType:t,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._arrayLayer,mipLevel:this._mipLevel,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternelFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var i=e.gl;t.glInternelFmt=HI(t.format,i),t.glFormat=WI(t.format,i),t.glType=GI(t.format,i);var n=t.width,r=t.height;switch(t.viewType){case Wu.TV2D:t.viewType=Wu.TV2D,t.glTarget=i.TEXTURE_2D;var a=Math.max(n,r);if(a>e.maxTextureSize&&z(9100,a,e.maxTextureSize),t.samples===Uu.X1){var s=i.createTexture();if(s&&0<t.size){t.glTexture=s;var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),xc[t.format].isCompressed)if(t.glInternelFmt!==GM.COMPRESSED_RGB_ETC1_WEBGL)for(var l=0;l<t.mipLevel;++l){var u=Sc(t.format,n,r,1),c=new Uint8Array(u);i.compressedTexImage2D(i.TEXTURE_2D,l,t.glInternelFmt,n,r,0,c),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else{var h=Sc(t.format,2,2,1),f=new Uint8Array(h);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternelFmt,2,2,0,f)}else for(var d=0;d<t.mipLevel;++d)i.texImage2D(i.TEXTURE_2D,d,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else{var _=i.createRenderbuffer();_&&0<t.size&&(t.glRenderbuffer=_,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,UI[t.samples],t.glInternelFmt,t.width,t.height))}break;case Wu.CUBE:t.viewType=Wu.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var p=Math.max(n,r);p>e.maxCubeMapTextureSize&&z(9100,p,e.maxTextureSize);var v=i.createTexture();if(v&&0<t.size){t.glTexture=v;var m=e.stateCache.glTexUnits[e.stateCache.texUnit];if(m.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),m.glTexture=t.glTexture),xc[t.format].isCompressed)if(t.glInternelFmt!==GM.COMPRESSED_RGB_ETC1_WEBGL)for(var y=0;y<6;++y){n=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g){var b=Sc(t.format,n,r,1),x=new Uint8Array(b);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+y,g,t.glInternelFmt,n,r,0,x),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var S=0;S<6;++S){var T=Sc(t.format,2,2,1),w=new Uint8Array(T);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+S,0,t.glInternelFmt,2,2,0,w)}else for(var E=0;E<6;++E){n=t.width,r=t.height;for(var A=0;A<t.mipLevel;++A)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+E,A,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=Wu.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTexture&&(function(e,t){t.glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null)}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null),this._status=Yl.UNREADY,this._buffer=null}},{key:"resize",value:function(e,t){var i=this._size;this._width=e,this._height=t,this._size=Tc(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._gpuTexture&&(this._gpuTexture.width=this._width,this._gpuTexture.height=this._height,this._gpuTexture.size=this._size,function(e,t){var i=e.gl;t.glInternelFmt=HI(t.format,i),t.glFormat=WI(t.format,i),t.glType=GI(t.format,i);var n=t.width,r=t.height;switch(t.viewType){case Wu.TV2D:t.viewType=Wu.TV2D,t.glTarget=i.TEXTURE_2D;var a=Math.max(n,r);if(a>e.maxTextureSize&&z(9100,a,e.maxTextureSize),t.samples===Uu.X1){var s=e.stateCache.glTexUnits[e.stateCache.texUnit];if(s.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),s.glTexture=t.glTexture),xc[t.format].isCompressed){if(t.glInternelFmt!==GM.COMPRESSED_RGB_ETC1_WEBGL)for(var o=0;o<t.mipLevel;++o){var l=Sc(t.format,n,r,1),u=new Uint8Array(l);i.compressedTexImage2D(i.TEXTURE_2D,o,t.glInternelFmt,n,r,0,u),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var c=0;c<t.mipLevel;++c)i.texImage2D(i.TEXTURE_2D,c,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else{var h=i.createRenderbuffer();h&&0<t.size&&(t.glRenderbuffer=h,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,UI[t.samples],t.glInternelFmt,t.width,t.height))}break;case Wu.CUBE:t.viewType=Wu.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var f=Math.max(n,r);f>e.maxCubeMapTextureSize&&z(9100,f,e.maxTextureSize);var d=e.stateCache.glTexUnits[e.stateCache.texUnit];if(d.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),d.glTexture=t.glTexture),xc[t.format].isCompressed){if(t.glInternelFmt!==GM.COMPRESSED_RGB_ETC1_WEBGL)for(var _=0;_<6;++_){n=t.width,r=t.height;for(var p=0;p<t.mipLevel;++p){var v=Sc(t.format,n,r,1),m=new Uint8Array(v);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+_,p,t.glInternelFmt,n,r,0,m),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}}else for(var y=0;y<6;++y){n=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+y,g,t.glInternelFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=Wu.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size),this._status=Yl.UNREADY}}]),i}(),kB=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._gpuTextureView=null,t}return _(i,kd),l(i,[{key:"gpuTextureView",get:function(){return this._gpuTextureView}}]),l(i,[{key:"initialize",value:function(e){return this._texture=e.texture,this._type=e.type,this._format=e.format,this._format=e.format,void 0!==e.baseLevel&&(this._baseLevel=e.baseLevel),void 0!==e.levelCount&&(this._levelCount=e.levelCount),void 0!==e.baseLayer&&(this._baseLayer=e.baseLayer),void 0!==e.layerCount&&(this._layerCount=e.layerCount),this._gpuTextureView={gpuTexture:e.texture.gpuTexture,type:e.type,format:e.format,baseLevel:e.baseLevel?e.baseLevel:0,levelCount:e.levelCount?e.levelCount:1},this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTextureView=null,this._texture=null,this._status=Yl.UNREADY}}]),i}(),RB=function(){function t(e){return y(this,t),x(this,g(t).call(this,e))}return _(t,PI),l(t,[{key:"initialize",value:function(e){void 0!==e.title&&(this._title=e.title),void 0!==e.left&&(this._left=e.left),void 0!==e.top&&(this._top=e.top),void 0!==e.isOffscreen&&(this._isOffscreen=e.isOffscreen),this._width=e.width,this._height=e.height,this._nativeWidth=this._width,this._nativeHeight=this._height,this._colorFmt=e.colorFmt,this._depthStencilFmt=e.depthStencilFmt,this._renderPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:Ju.CLEAR,storeOp:ec.STORE,sampleCount:1,beginLayout:ic.COLOR_ATTACHMENT_OPTIMAL,endLayout:ic.COLOR_ATTACHMENT_OPTIMAL}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:Ju.CLEAR,depthStoreOp:ec.STORE,stencilLoadOp:Ju.CLEAR,stencilStoreOp:ec.STORE,sampleCount:1,beginLayout:ic.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:ic.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}});var t=[];return this._isOffscreen&&(this._colorFmt!==ru.UNKNOWN&&(this._colorTex=this._device.createTexture({type:Fu.TEX2D,usage:Du.COLOR_ATTACHMENT|Du.SAMPLED,format:this._colorFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:Gu.NONE}),this._colorTexView=this._device.createTextureView({texture:this._colorTex,type:Wu.TV2D,format:this._colorFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}),t.push(this._colorTexView)),this._depthStencilFmt!==ru.UNKNOWN&&(this._depthStencilTex=this._device.createTexture({type:Fu.TEX2D,usage:Du.DEPTH_STENCIL_ATTACHMENT,format:this._depthStencilFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:Gu.NONE}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:Wu.TV2D,format:this._depthStencilFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}))),this._framebuffer=this._device.createFramebuffer({renderPass:this._renderPass,colorViews:t,depthStencilView:this._depthStencilTexView,isOffscreen:this._isOffscreen}),this._status=Yl.SUCCESS,!0}},{key:"destroy",value:function(){this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._colorTexView&&(this._colorTexView.destroy(),this._colorTexView=null),this._colorTex&&(this._colorTex.destroy(),this._colorTex=null),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._renderPass&&(this._renderPass.destroy(),this._renderPass=null),this._status=Yl.UNREADY}},{key:"resize",value:function(e,t){this._width=e,this._height=t,(e>this._nativeWidth||t>this._nativeHeight)&&(this._nativeWidth=e,this._nativeHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:Wu.TV2D,format:this._depthStencilFmt})),this._colorTex&&(this._colorTex.resize(e,t),this._colorTexView.destroy(),this._colorTexView.initialize({texture:this._colorTex,type:Wu.TV2D,format:this._colorFmt})),this._framebuffer&&this._framebuffer.isOffscreen&&(this._framebuffer.destroy(),this._framebuffer.initialize({renderPass:this._renderPass,colorViews:[this._colorTexView],depthStencilView:this._depthStencilTexView})))}}]),t}(),OB=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this))).stateCache=new fB,e.nullTex2D=null,e.nullTexCube=null,e._webGL2RC=null,e._isAntialias=!0,e._isPremultipliedAlpha=!0,e._useVAO=!0,e._extensions=null,e._EXT_texture_filter_anisotropic=null,e._OES_texture_float_linear=null,e._OES_texture_half_float_linear=null,e._EXT_color_buffer_float=null,e._EXT_disjoint_timer_query_webgl2=null,e._WEBGL_compressed_texture_etc1=null,e._WEBGL_compressed_texture_etc=null,e._WEBGL_compressed_texture_pvrtc=null,e._WEBGL_compressed_texture_astc=null,e._WEBGL_compressed_texture_s3tc=null,e._WEBGL_compressed_texture_s3tc_srgb=null,e._WEBGL_debug_renderer_info=null,e._WEBGL_texture_storage_multisample=null,e._WEBGL_debug_shaders=null,e._WEBGL_lose_context=null,e}return _(t,Bc),l(t,[{key:"gl",get:function(){return this._webGL2RC}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"OES_texture_float_linear",get:function(){return this._OES_texture_float_linear}},{key:"EXT_color_buffer_float",get:function(){return this._EXT_color_buffer_float}},{key:"EXT_disjoint_timer_query_webgl2",get:function(){return this._EXT_disjoint_timer_query_webgl2}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_etc",get:function(){return this._WEBGL_compressed_texture_etc}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}}]),l(t,[{key:"initialize",value:function(e){this._canvas=e.canvasElm,this._isAntialias=void 0===e.isAntialias||e.isAntialias,this._isPremultipliedAlpha=void 0===e.isPremultipliedAlpha||e.isPremultipliedAlpha;try{var t={alpha:!1,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGL2RC=this._canvas.getContext("webgl2",t)}catch(e){return console.error(e),!1}if(!this._webGL2RC)return console.error("This device does not support WebGL2."),!1;this._canvas2D=document.createElement("canvas"),console.info("WebGL2 device initialized."),this._gfxAPI=Ac.WEBGL2,this._deviceName="WebGL2";var i=this._webGL2RC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=i.getParameter(i.RENDERER),this._vendor=i.getParameter(i.VENDOR)),this._version=i.getParameter(i.VERSION),this._maxVertexAttributes=i.getParameter(i.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxUniformBufferBindings=i.getParameter(i.MAX_UNIFORM_BUFFER_BINDINGS),this._maxUniformBlockSize=i.getParameter(i.MAX_UNIFORM_BLOCK_SIZE),this._maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),this._maxCubeMapTextureSize=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE),this._depthBits=i.getParameter(i.DEPTH_BITS),this._stencilBits=i.getParameter(i.STENCIL_BITS),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=ru.RGBA8,32===this._depthBits?8===this._stencilBits?this._depthStencilFmt=ru.D32F_S8:this._depthStencilFmt=ru.D32F:24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=ru.D24S8:this._depthStencilFmt=ru.D24:8===this._stencilBits?this._depthStencilFmt=ru.D16S8:this._depthStencilFmt=ru.D16,this._extensions=i.getSupportedExtensions();var n="";if(this._extensions){var r=this._extensions,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}n+=o+" "}console.debug("EXTENSIONS: "+n)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_color_buffer_float=this.getExtension("EXT_color_buffer_float"),this._EXT_disjoint_timer_query_webgl2=this.getExtension("EXT_disjoint_timer_query_webgl2"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_texture_storage_multisample=this.getExtension("WEBGL_texture_storage_multisample"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._features.fill(!1),this._features[kc.TEXTURE_FLOAT]=!0,this._features[kc.TEXTURE_HALF_FLOAT]=!0,this._features[kc.FORMAT_R11G11B10F]=!0,this._features[kc.FORMAT_D24S8]=!0,this._features[kc.FORMAT_ETC2]=!0,this._features[kc.MSAA]=!0,this._EXT_color_buffer_float&&(this._features[kc.COLOR_FLOAT]=!0,this._features[kc.COLOR_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[kc.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[kc.TEXTURE_HALF_FLOAT_LINEAR]=!0);var l="";this._WEBGL_compressed_texture_etc1&&(this._features[kc.FORMAT_ETC1]=!0,l+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[kc.FORMAT_ETC2]=!0,l+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[kc.FORMAT_DXT]=!0,l+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[kc.FORMAT_PVRTC]=!0,l+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[kc.FORMAT_ASTC]=!0,l+="astc "),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("MAX_UNIFORM_BUFFER_BINDINGS: "+this._maxUniformBufferBindings),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+l),this.initStates(i),this._queue=this.createQueue({type:hc.GRAPHICS});var u=this._webGL2RC.canvas;this._mainWindow=this.createWindow({title:u.title||"",left:u.offsetLeft||0,top:u.offsetTop||0,width:this._webGL2RC.drawingBufferWidth,height:this._webGL2RC.drawingBufferHeight,colorFmt:this._colorFmt,depthStencilFmt:this._depthStencilFmt}),this._cmdAllocator=this.createCommandAllocator({}),this.nullTex2D=new CB(this),this.nullTex2D.initialize({type:Fu.TEX2D,usage:Du.SAMPLED,format:ru.RGBA8,width:2,height:2,flags:Gu.GEN_MIPMAP}),this.nullTexCube=new CB(this),this.nullTexCube.initialize({type:Fu.TEX2D,usage:Du.SAMPLED,format:ru.RGBA8,width:2,height:2,arrayLayer:6,flags:Gu.CUBEMAP|Gu.GEN_MIPMAP});var c={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:2,height:2,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}},h=new Uint8Array(this.nullTex2D.size);return h.fill(0),this.copyBuffersToTexture([h],this.nullTex2D,[c]),c.texSubres.layerCount=6,this.copyBuffersToTexture([h,h,h,h,h,h],this.nullTexCube,[c]),!0}},{key:"destroy",value:function(){this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._mainWindow&&(this._mainWindow.destroy(),this._mainWindow=null),this._cmdAllocator&&(this._cmdAllocator.destroy(),this._cmdAllocator=null),this._queue&&(this._queue.destroy(),this._queue=null),this._webGL2RC=null}},{key:"resize",value:function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}},{key:"createBuffer",value:function(e){var t=new dB(this);return t.initialize(e),t}},{key:"createTexture",value:function(e){var t=new CB(this);return t.initialize(e),t}},{key:"createTextureView",value:function(e){var t=new kB(this);return t.initialize(e),t}},{key:"createSampler",value:function(e){var t=new wB(this);return t.initialize(e),t}},{key:"createBindingLayout",value:function(e){var t=new DI(this);return t.initialize(e),t}},{key:"createShader",value:function(e){var t=new EB(this);return t.initialize(e),t}},{key:"createInputAssembler",value:function(e){var t=new yB(this);return t.initialize(e),t}},{key:"createRenderPass",value:function(e){var t=new TB(this);return t.initialize(e),t}},{key:"createFramebuffer",value:function(e){var t=new mB(this);return t.initialize(e),t}},{key:"createPipelineLayout",value:function(e){var t=new gB(this);return t.initialize(e),t}},{key:"createPipelineState",value:function(e){var t=new xB(this);return t.initialize(e),t}},{key:"createCommandAllocator",value:function(e){var t=new pB(this);return t.initialize(e),t}},{key:"createCommandBuffer",value:function(e){var t=new vB(this);return t.initialize(e),t}},{key:"createQueue",value:function(e){var t=new SB(this);return t.initialize(e),t}},{key:"createWindow",value:function(e){var t=new RB(this);return t.initialize(e),t}},{key:"present",value:function(){this._cmdAllocator.releaseCmds();var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numTris=e.numTris,e.clear()}},{key:"copyBuffersToTexture",value:function(e,t,i){hB(this,e,t.gpuTexture,i)}},{key:"copyTexImagesToTexture",value:function(e,t,i){!function(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var s=0,o=0,l=0;switch(i.glTarget){case r.TEXTURE_2D:var u=n,c=Array.isArray(u),h=0;for(u=c?u:u[Symbol.iterator]();;){var f;if(c){if(h>=u.length)break;f=u[h++]}else{if((h=u.next()).done)break;f=h.value}var d=f;for(s=d.texSubres.baseMipLevel;s<d.texSubres.levelCount;++s)r.texSubImage2D(r.TEXTURE_2D,s,d.texOffset.x,d.texOffset.y,i.glFormat,i.glType,t[o++])}break;case r.TEXTURE_CUBE_MAP:var _=n,p=Array.isArray(_),v=0;for(_=p?_:_[Symbol.iterator]();;){var m;if(p){if(v>=_.length)break;m=_[v++]}else{if((v=_.next()).done)break;m=v.value}var y=m,g=y.texSubres.baseArrayLayer+y.texSubres.layerCount;for(l=y.texSubres.baseArrayLayer;l<g;++l){var b=y.texSubres.baseMipLevel+y.texSubres.levelCount;for(s=y.texSubres.baseMipLevel;s<b;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,s,y.texOffset.x,y.texOffset.y,i.glFormat,i.glType,t[o++])}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Gu.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}},{key:"copyFramebufferToBuffer",value:function(e,t,i){var n=this._webGL2RC,r=e.gpuFramebuffer,a=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==r.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,r.glFramebuffer),this.stateCache.glFramebuffer=r.glFramebuffer);var s=new Uint8Array(t),o=i,l=Array.isArray(o),u=0;for(o=l?o:o[Symbol.iterator]();;){var c;if(l){if(u>=o.length)break;c=o[u++]}else{if((u=o.next()).done)break;c=u.value}var h=c,f=h.buffOffset+h.buffTexHeight*h.buffStride,d=h.texExtent.width,_=h.texExtent.height,p=Sc(ru.RGBA8,d,_,1),v=s.subarray(f,f+p);n.readPixels(h.texOffset.x,h.texOffset.y,d,_,n.RGBA,n.UNSIGNED_BYTE,v)}this.stateCache.glFramebuffer!==a&&(n.bindFramebuffer(n.FRAMEBUFFER,a),this.stateCache.glFramebuffer=a)}},{key:"blitFramebuffer",value:function(e,t,i,n,r){!function(e,t,i,n,r,a){var s=e.gl;e.stateCache.glReadFramebuffer!==t.glFramebuffer&&(s.bindFramebuffer(s.READ_FRAMEBUFFER,t.glFramebuffer),e.stateCache.glReadFramebuffer=t.glFramebuffer);var o=i.glFramebuffer!==e.stateCache.glFramebuffer;o&&s.bindFramebuffer(s.DRAW_FRAMEBUFFER,i.glFramebuffer);var l=0;0<t.gpuColorViews.length&&(l|=s.COLOR_BUFFER_BIT),t.gpuDepthStencilView&&(l|=s.DEPTH_BUFFER_BIT,xc[t.gpuDepthStencilView.format].hasStencil&&(l|=s.STENCIL_BUFFER_BIT));var u=a===Iu.LINEAR||a===Iu.ANISOTROPIC?s.LINEAR:s.NEAREST;s.blitFramebuffer(n.x,n.y,n.x+n.width,n.y+n.height,r.x,r.y,r.x+r.width,r.y+r.height,l,u),o&&s.bindFramebuffer(s.FRAMEBUFFER,e.stateCache.glFramebuffer)}(this,e.gpuFramebuffer,t.gpuFramebuffer,i,n,r)}},{key:"getExtension",value:function(e){for(var t=["","WEBKIT_","MOZ_"],i=0;i<t.length;++i){var n=this._webGL2RC.getExtension(t[i]+e);if(n)return n}return null}},{key:"initStates",value:function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,4294967295),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,4294967295),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,4294967295),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,4294967295),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}}]),t}();cc.WebGL2GFXDevice=OB;var MB,IB,BB,LB,PB,FB,zB,DB,NB,UB,VB,GB,HB,WB,qB,jB,XB,YB,KB,QB,ZB,JB,$B,eL,tL,iL,nL,rL,aL,sL,oL=new Ni,lL=new Pn;function uL(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,u=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,u=l=o=0);var c=a.vData,h=a.iData;e.getWorldMatrix(lL);for(var f=0;f<o;f++){var d=r[f];Ni.set(oL,d.x,d.y,0),Ni.transformMat4(oL,oL,lL),c[s++]=oL.x,c[s++]=oL.y,c[s++]=oL.z,c[s++]=d.u,c[s++]=d.v,ar.toArray(c,n,s),s+=4}for(var _=0,p=o/4;_<p;_++){var v=u+4*_;h[l++]=v,h[l++]=v+1,h[l++]=v+2,h[l++]=v+1,h[l++]=v+3,h[l++]=v+2}}(iL=tL=tL||{})[iL.SIMPLE=0]="SIMPLE",iL[iL.SLICED=1]="SLICED",iL[iL.FILLED=3]="FILLED",mt(tL),(rL=nL=nL||{})[rL.HORIZONTAL=0]="HORIZONTAL",rL[rL.VERTICAL=1]="VERTICAL",rL[rL.RADIAL=2]="RADIAL",mt(nL),(sL=aL=aL||{})[sL.CUSTOM=0]="CUSTOM",sL[sL.TRIMMED=1]="TRIMMED",sL[sL.RAW=2]="RAW",mt(aL);var cL,hL,fL,dL,_L,pL,vL,mL,yL,gL,bL,xL,SL,TL,wL,EL,AL,CL,kL,RL,OL,ML,IL,BL,LL,PL,FL,zL,DL,NL,UL,VL,GL,HL,WL=m4("SpriteComponent",(MB=fo("cc.SpriteComponent"),IB=bo(110),BB=go("UI/Render/Sprite"),LB=_o({type:fS,displayOrder:4}),PB=_o({type:Jh,displayOrder:5}),FB=_o({type:tL,displayOrder:6}),zB=_o({type:nL}),DB=_o({range:[0,1,.1]}),NB=_o({range:[0,1,.1]}),UB=_o({displayOrder:8}),VB=_o({type:aL,displayOrder:7}),MB(GB=IB(GB=BB((eL=$B=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_spriteFrame",WB,c(t)),v(t,"_type",qB,c(t)),v(t,"_fillType",jB,c(t)),v(t,"_sizeMode",XB,c(t)),v(t,"_fillCenter",YB,c(t)),v(t,"_fillStart",KB,c(t)),v(t,"_fillRange",QB,c(t)),v(t,"_isTrimmedMode",ZB,c(t)),v(t,"_atlas",JB,c(t)),t}return _(a,hC),l(a,[{key:"__preload",value:function(){p(g(a.prototype),"__preload",this)&&p(g(a.prototype),"__preload",this).call(this),this._spriteFrame&&(this._spriteFrame.on("load",this._markForUpdateUvDirty,this),this._markForUpdateUvDirty())}},{key:"onEnable",value:function(){p(g(a.prototype),"onEnable",this).call(this),this._activateMaterial()}},{key:"onDestroy",value:function(){p(g(a.prototype),"onDestroy",this).call(this),this.destroyRenderData(),this._spriteFrame&&this._spriteFrame.off("load")}},{key:"_render",value:function(e){e.commitComp(this,this._spriteFrame.getGFXTextureView(),this._assembler)}},{key:"_canRender",value:function(){if(!p(g(a.prototype),"_canRender",this).call(this))return!1;var e=this._spriteFrame;return!(!e||!e.textureLoaded())}},{key:"_flushAssembler",value:function(){var e=a.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this._material,this.markForUpdateRenderData(),this._updateColor())}},{key:"_applySpriteSize",value:function(){if(this._spriteFrame){if(aL.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node.setContentSize(e)}else if(aL.TRIMMED===this._sizeMode){var t=this._spriteFrame.getRect();this.node.setContentSize(t.width,t.height)}this._activateMaterial()}}},{key:"_resized",value:function(){}},{key:"_activateMaterial",value:function(){var e=this._spriteFrame,t=this._material;cc.game.renderType!==cc.game.RENDER_TYPE_CANVAS?(e&&t&&(t.setProperty("mainTexture",e),this.markForUpdateRenderData()),this._renderData&&(this._renderData.material=t)):this.markForUpdateRenderData()}},{key:"_applyAtlas",value:function(e){}},{key:"_onTextureLoaded",value:function(){this.isValid&&this._applySpriteSize()}},{key:"_applySpriteFrame",value:function(e){var t=this._spriteFrame;this._renderData&&(e&&e.off("load",this._markForUpdateUvDirty),t&&t.on("load",this._markForUpdateUvDirty,this),this._renderData.uvDirty||(this._renderData.uvDirty=!e||!t||e.uvHash!==t.uvHash),this._renderDataFlag=this._renderData.uvDirty),t&&(e&&t===e||(t.loaded?this._onTextureLoaded():t.once("load",this._onTextureLoaded,this)))}},{key:"_markForUpdateUvDirty",value:function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)}},{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e,this.spriteFrame=null)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===nL.RADIAL||this._fillType===nL.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===tL.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=pi(e,-1,1),this._type===tL.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=pi(e,0,1),this._type===tL.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===tL.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e)!==aL.CUSTOM&&this._applySpriteSize()}}]),a}(),$B.FillType=nL,$B.Type=tL,$B.SizeMode=aL,m((HB=eL).prototype,"spriteAtlas",[LB],Object.getOwnPropertyDescriptor(HB.prototype,"spriteAtlas"),HB.prototype),m(HB.prototype,"spriteFrame",[PB],Object.getOwnPropertyDescriptor(HB.prototype,"spriteFrame"),HB.prototype),m(HB.prototype,"type",[FB],Object.getOwnPropertyDescriptor(HB.prototype,"type"),HB.prototype),m(HB.prototype,"fillType",[zB],Object.getOwnPropertyDescriptor(HB.prototype,"fillType"),HB.prototype),m(HB.prototype,"fillCenter",[_o],Object.getOwnPropertyDescriptor(HB.prototype,"fillCenter"),HB.prototype),m(HB.prototype,"fillStart",[DB],Object.getOwnPropertyDescriptor(HB.prototype,"fillStart"),HB.prototype),m(HB.prototype,"fillRange",[NB],Object.getOwnPropertyDescriptor(HB.prototype,"fillRange"),HB.prototype),m(HB.prototype,"trim",[UB],Object.getOwnPropertyDescriptor(HB.prototype,"trim"),HB.prototype),m(HB.prototype,"sizeMode",[VB],Object.getOwnPropertyDescriptor(HB.prototype,"sizeMode"),HB.prototype),WB=m(HB.prototype,"_spriteFrame",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qB=m(HB.prototype,"_type",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tL.SIMPLE}}),jB=m(HB.prototype,"_fillType",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nL.HORIZONTAL}}),XB=m(HB.prototype,"_sizeMode",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return aL.TRIMMED}}),YB=m(HB.prototype,"_fillCenter",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii(0,0)}}),KB=m(HB.prototype,"_fillStart",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QB=m(HB.prototype,"_fillRange",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ZB=m(HB.prototype,"_isTrimmedMode",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),JB=m(HB.prototype,"_atlas",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GB=HB))||GB)||GB)||GB));cc.SpriteComponent=WL,(VL=UL=UL||{})[VL.NONE=0]="NONE",VL[VL.COLOR=1]="COLOR",VL[VL.SPRITE=2]="SPRITE",VL[VL.SCALE=3]="SCALE",mt(UL),(HL=GL=GL||{}).NORMAL="normal",HL.HOVER="hover",HL.PRESSED="pressed",HL.DISABLED="disabled";var qL=m4("ButtonComponent",(cL=fo("cc.ButtonComponent"),hL=bo(110),fL=go("UI/Button"),dL=_o({displayOrder:1}),_L=_o({type:UL,displayOrder:2}),pL=_o({min:0,max:10}),vL=_o({type:Jh}),mL=_o({type:Jh}),yL=_o({type:Jh}),gL=_o({type:Jh}),bL=_o({type:cy,displayOrder:0}),xL=_o({type:[Zw],displayOrder:3}),cL(SL=hL(SL=fL((NL=DL=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"clickEvents",wL,c(t)),v(t,"_interactable",EL,c(t)),v(t,"_transition",AL,c(t)),v(t,"_normalColor",CL,c(t)),v(t,"_hoverColor",kL,c(t)),v(t,"_pressColor",RL,c(t)),v(t,"_disabledColor",OL,c(t)),v(t,"_normalSprite",ML,c(t)),v(t,"_hoverSprite",IL,c(t)),v(t,"_pressedSprite",BL,c(t)),v(t,"_disabledSprite",LL,c(t)),v(t,"_duration",PL,c(t)),v(t,"_zoomScale",FL,c(t)),v(t,"_target",zL,c(t)),t._pressed=!1,t._hovered=!1,t._fromColor=new ar,t._toColor=new ar,t._time=0,t._transitionFinished=!0,t._fromScale=new Ni,t._toScale=new Ni,t._originalScale=new Ni,t._sprite=null,t._targetScale=new Ni,t}return _(a,Tm),l(a,[{key:"__preload",value:function(){this.target||(this.target=this.node);var e=this.node.getComponent(WL);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._updateState()}},{key:"onEnable",value:function(){this._registerEvent()}},{key:"onDisable",value:function(){this._resetState(),this.node.off(Gp.TOUCH_START,this._onTouchBegan,this),this.node.off(Gp.TOUCH_MOVE,this._onTouchMove,this),this.node.off(Gp.TOUCH_END,this._onTouchEnded,this),this.node.off(Gp.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(Gp.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(Gp.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"update",value:function(e){var t=this._target?this._target:this.node;if(!this._transitionFinished&&(this._transition===UL.COLOR||this._transition===UL.SCALE)){this._time+=e;var i=1;0<this._duration&&(i=this._time/this._duration),1<=i&&(i=1,this._transitionFinished=!0);var n=t.getComponent(hC);n&&(this._transition===UL.COLOR?ar.lerp(n.color,this._fromColor,this._toColor,i):this.transition===UL.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=mi(this._fromScale.x,this._toScale.x,i),this._targetScale.y=mi(this._fromScale.y,this._toScale.y,i),t.setScale(this._targetScale)))}}},{key:"_resizeNodeToTargetNode",value:function(){0}},{key:"_resetState",value:function(){this._pressed=!1,this._hovered=!1;var e=this._target;if(e){var t=e.getComponent(hC);if(t){var i=this._transition;i===UL.COLOR&&this._interactable?t.color=this._normalColor:i===UL.SCALE&&e.setScale(this._originalScale),this._transitionFinished=!0}}}},{key:"_registerEvent",value:function(){this.node.on(Gp.TOUCH_START,this._onTouchBegan,this),this.node.on(Gp.TOUCH_MOVE,this._onTouchMove,this),this.node.on(Gp.TOUCH_END,this._onTouchEnded,this),this.node.on(Gp.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(Gp.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(Gp.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"_getTargetSprite",value:function(e){var t=null;return e&&(t=e.getComponent(WL)),t}},{key:"_applyTarget",value:function(){this._sprite=this._getTargetSprite(this._target),this._target&&Ni.copy(this._originalScale,this._target.getScale())}},{key:"_onTouchBegan",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchMove",value:function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed){if(!e)return!1;var t=e.touch;if(!t)return!1;var i,n=this.node.uiTransfromComp.isHit(t.getUILocation());if(this._transition===UL.SCALE&&this._target)n?(Ni.copy(this._fromScale,this._originalScale),Ni.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this._target&&this._target.setScale(this._originalScale));else i=n?GL.PRESSED:GL.NORMAL,this._applyTransition(i);e&&(e.propagationStopped=!0)}}},{key:"_onTouchEnded",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(Zw.emitEvents(this.clickEvents,e),this.node.emit("click",this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchCancel",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}},{key:"_onMouseMoveIn",value:function(e){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition===UL.SPRITE&&!this._hoverSprite||this._hovered||(this._hovered=!0,this._updateState()))}},{key:"_onMouseMoveOut",value:function(e){this._hovered&&(this._hovered=!1,this._updateState())}},{key:"_updateState",value:function(){var e=this._getButtonState();this._applyTransition(e)}},{key:"_getButtonState",value:function(){var e=GL.NORMAL;return this._interactable?this._pressed?e=GL.PRESSED:this._hovered&&(e=GL.HOVER):e=GL.DISABLED,e.toString()}},{key:"_updateColorTransition",value:function(e){var t=this[e+"Color"],i=this._target;if(i){var n=i.getComponent(hC);n&&(e===GL.DISABLED?n.color=t:(this._fromColor=n.color.clone(),this._toColor=t,this._time=0,this._transitionFinished=!1))}}},{key:"_updateSpriteTransition",value:function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)}},{key:"_updateScaleTransition",value:function(e){this._interactable&&(e===GL.PRESSED?this._zoomUp():this._zoomBack())}},{key:"_zoomUp",value:function(){Ni.copy(this._fromScale,this._originalScale),Ni.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1}},{key:"_zoomBack",value:function(){this._target&&(Ni.copy(this._fromScale,this._target.getScale()),Ni.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}},{key:"_applyTransition",value:function(e){var t=this._transition;t===UL.COLOR?this._updateColorTransition(e):t===UL.SPRITE?this._updateSpriteTransition(e):t===UL.SCALE&&this._updateScaleTransition(e)}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition=e)}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressColor},set:function(e){this._pressColor!==e&&this._pressColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(WL);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._applyTarget())}}]),a}(),DL.Transition=UL,m((TL=NL).prototype,"interactable",[dL],Object.getOwnPropertyDescriptor(TL.prototype,"interactable"),TL.prototype),m(TL.prototype,"transition",[_L],Object.getOwnPropertyDescriptor(TL.prototype,"transition"),TL.prototype),m(TL.prototype,"normalColor",[_o],Object.getOwnPropertyDescriptor(TL.prototype,"normalColor"),TL.prototype),m(TL.prototype,"pressedColor",[_o],Object.getOwnPropertyDescriptor(TL.prototype,"pressedColor"),TL.prototype),m(TL.prototype,"hoverColor",[_o],Object.getOwnPropertyDescriptor(TL.prototype,"hoverColor"),TL.prototype),m(TL.prototype,"disabledColor",[_o],Object.getOwnPropertyDescriptor(TL.prototype,"disabledColor"),TL.prototype),m(TL.prototype,"duration",[pL],Object.getOwnPropertyDescriptor(TL.prototype,"duration"),TL.prototype),m(TL.prototype,"zoomScale",[_o],Object.getOwnPropertyDescriptor(TL.prototype,"zoomScale"),TL.prototype),m(TL.prototype,"normalSprite",[vL],Object.getOwnPropertyDescriptor(TL.prototype,"normalSprite"),TL.prototype),m(TL.prototype,"pressedSprite",[mL],Object.getOwnPropertyDescriptor(TL.prototype,"pressedSprite"),TL.prototype),m(TL.prototype,"hoverSprite",[yL],Object.getOwnPropertyDescriptor(TL.prototype,"hoverSprite"),TL.prototype),m(TL.prototype,"disabledSprite",[gL],Object.getOwnPropertyDescriptor(TL.prototype,"disabledSprite"),TL.prototype),m(TL.prototype,"target",[bL],Object.getOwnPropertyDescriptor(TL.prototype,"target"),TL.prototype),wL=m(TL.prototype,"clickEvents",[xL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),EL=m(TL.prototype,"_interactable",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),AL=m(TL.prototype,"_transition",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return UL.NONE}}),CL=m(TL.prototype,"_normalColor",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ar(214,214,214,255)}}),kL=m(TL.prototype,"_hoverColor",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ar(211,211,211,255)}}),RL=m(TL.prototype,"_pressColor",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ar.WHITE.clone()}}),OL=m(TL.prototype,"_disabledColor",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ar(124,124,124,255)}}),ML=m(TL.prototype,"_normalSprite",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),IL=m(TL.prototype,"_hoverSprite",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BL=m(TL.prototype,"_pressedSprite",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LL=m(TL.prototype,"_disabledSprite",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PL=m(TL.prototype,"_duration",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),FL=m(TL.prototype,"_zoomScale",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),zL=m(TL.prototype,"_target",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SL=TL))||SL)||SL)||SL));cc.ButtonComponent=qL;var jL,XL,YL,KL,QL,ZL,JL,$L,eP,tP,iP,nP,rP,aP,sP,oP,lP,uP,cP,hP,fP,dP,_P,pP,vP,mP,yP,gP,bP,xP,SP,TP,wP,EP,AP,CP,kP,RP,OP,MP,IP,BP,LP,PP,FP,zP,DP=m4("CanvasPool",function(){function e(){y(this,e),this.pool=[]}return l(e,[{key:"get",value:function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),i=t.getContext("2d");e={canvas:t,context:i}}return e}},{key:"put",value:function(e){32<=this.pool.length||this.pool.push(e)}}]),e}());(MP=OP=OP||m4("HorizontalTextAlignment",{}))[MP.LEFT=0]="LEFT",MP[MP.CENTER=1]="CENTER",MP[MP.RIGHT=2]="RIGHT",mt(OP),(BP=IP=IP||m4("VerticalTextAlignment",{}))[BP.TOP=0]="TOP",BP[BP.CENTER=1]="CENTER",BP[BP.BOTTOM=2]="BOTTOM",mt(IP),(PP=LP=LP||m4("Overflow",{}))[PP.NONE=0]="NONE",PP[PP.CLAMP=1]="CLAMP",PP[PP.SHRINK=2]="SHRINK",PP[PP.RESIZE_HEIGHT=3]="RESIZE_HEIGHT",mt(LP),(zP=FP=FP||{})[zP.NONE=0]="NONE",zP[zP.BITMAP=1]="BITMAP",zP[zP.CHAR=2]="CHAR",mt(FP);var NP,UP,VP,GP,HP,WP,qP,jP=m4("LabelComponent",(jL=fo("cc.LabelComponent"),XL=bo(110),YL=go("UI/Render/Label"),KL=_o({displayOrder:4,multiline:!0}),QL=_o({type:OP,displayOrder:5}),ZL=_o({type:IP,displayOrder:6}),JL=_o({readonly:!0,displayName:"Actual Font Size",visible:!1}),$L=_o({displayOrder:7}),eP=_o({displayOrder:8}),tP=_o({displayOrder:8}),iP=_o({type:LP,displayOrder:9}),nP=_o({displayOrder:10}),rP=_o({type:TT,displayOrder:11}),aP=_o({displayOrder:12}),sP=_o({type:FP,displayOrder:13}),oP=_o({displayOrder:15}),lP=_o({displayOrder:16}),uP=_o({displayOrder:17}),jL(cP=XL(cP=YL((RP=kP=function(){function i(){var e;return y(this,i),v(e=x(this,g(i).call(this)),"_useOriginalSize",fP,c(e)),v(e,"_string",dP,c(e)),v(e,"_horizontalAlign",_P,c(e)),v(e,"_verticalAlign",pP,c(e)),v(e,"_actualFontSize",vP,c(e)),v(e,"_fontSize",mP,c(e)),v(e,"_fontFamily",yP,c(e)),v(e,"_lineHeight",gP,c(e)),v(e,"_overflow",bP,c(e)),v(e,"_enableWrapText",xP,c(e)),v(e,"_font",SP,c(e)),v(e,"_isSystemFontUsed",TP,c(e)),e._spacingX=0,v(e,"_isItalic",wP,c(e)),v(e,"_isBold",EP,c(e)),v(e,"_isUnderline",AP,c(e)),v(e,"_cacheMode",CP,c(e)),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfSpriteFrame=null,e}return _(i,hC),l(i,[{key:"string",get:function(){return this._string},set:function(e){e=e.toString(),this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,"string"==typeof(this._font=e)&&P(4e3),this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null,this._flushAssembler(),this.updateRenderData()))}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode===FP.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"spriteFrame",get:function(){return this._texture}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof LT?this._font.fontSize:-1}}]),l(i,[{key:"onEnable",value:function(){p(g(i.prototype),"onEnable",this).call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this.updateRenderData(!0)}},{key:"onDisable",value:function(){p(g(i.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){var e=this._ttfSpriteFrame.texture;if(e){var t=e;t.image&&t.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture&&(this._letterTexture.destroy(),this._letterTexture=null),p(g(i.prototype),"onDestroy",this).call(this)}},{key:"updateRenderData",value:function(e){var t=0<arguments.length&&void 0!==e&&e;this.markForUpdateRenderData(),t&&(this._flushAssembler(),this._applyFontTexture(t))}},{key:"_render",value:function(e){e.commitComp(this,this._texture.getGFXTextureView(),this._assembler)}},{key:"_updateColor",value:function(){this._font instanceof LT?p(g(i.prototype),"_updateColor",this).call(this):this.updateRenderData(!1)}},{key:"_canRender",value:function(){if(!p(g(i.prototype),"_canRender",this).call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof LT){var t=e.spriteFrame;if(!t||!t.textureLoaded())return!1}return!0}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this._material)}},{key:"_flushMaterial",value:function(){var e=this._material;e&&e.setProperty("mainTexture",this._texture),this._updateMaterial(e)}},{key:"_applyFontTexture",value:function(e){var t=this,i=this._font;if(i instanceof LT){var n=i.spriteFrame,r=this;n&&n.loaded&&(r._texture=n,r._flushMaterial(),e&&t._renderFlag&&t._assembler&&t._renderData&&t._assembler.updateRenderData(t))}else{if(this.cacheMode===FP.CHAR&&fl.browserType!==fl.BROWSER_TYPE_WECHAT_GAME_SUB)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new Jh,this._assemblerData=this._assembler.getAssemblerData();var a=new sh(this._assemblerData.canvas)._texture;this._ttfSpriteFrame.texture=a}this.cacheMode!==FP.CHAR&&(this._texture=this._ttfSpriteFrame),this._flushMaterial()}e&&this._renderFlag&&this._assembler&&this._renderData&&this._assembler.updateRenderData(this)}}]),i}(),kP.HorizontalAlign=OP,kP.VerticalAlign=IP,kP.Overflow=LP,kP.CacheMode=FP,kP.CanvasPool=new DP,m((hP=RP).prototype,"string",[KL],Object.getOwnPropertyDescriptor(hP.prototype,"string"),hP.prototype),m(hP.prototype,"horizontalAlign",[QL],Object.getOwnPropertyDescriptor(hP.prototype,"horizontalAlign"),hP.prototype),m(hP.prototype,"verticalAlign",[ZL],Object.getOwnPropertyDescriptor(hP.prototype,"verticalAlign"),hP.prototype),m(hP.prototype,"actualFontSize",[JL],Object.getOwnPropertyDescriptor(hP.prototype,"actualFontSize"),hP.prototype),m(hP.prototype,"fontSize",[$L],Object.getOwnPropertyDescriptor(hP.prototype,"fontSize"),hP.prototype),m(hP.prototype,"fontFamily",[eP],Object.getOwnPropertyDescriptor(hP.prototype,"fontFamily"),hP.prototype),m(hP.prototype,"lineHeight",[tP],Object.getOwnPropertyDescriptor(hP.prototype,"lineHeight"),hP.prototype),m(hP.prototype,"overflow",[iP],Object.getOwnPropertyDescriptor(hP.prototype,"overflow"),hP.prototype),m(hP.prototype,"enableWrapText",[nP],Object.getOwnPropertyDescriptor(hP.prototype,"enableWrapText"),hP.prototype),m(hP.prototype,"font",[rP],Object.getOwnPropertyDescriptor(hP.prototype,"font"),hP.prototype),m(hP.prototype,"useSystemFont",[aP],Object.getOwnPropertyDescriptor(hP.prototype,"useSystemFont"),hP.prototype),m(hP.prototype,"cacheMode",[sP],Object.getOwnPropertyDescriptor(hP.prototype,"cacheMode"),hP.prototype),m(hP.prototype,"isBold",[oP],Object.getOwnPropertyDescriptor(hP.prototype,"isBold"),hP.prototype),m(hP.prototype,"isItalic",[lP],Object.getOwnPropertyDescriptor(hP.prototype,"isItalic"),hP.prototype),m(hP.prototype,"isUnderline",[uP],Object.getOwnPropertyDescriptor(hP.prototype,"isUnderline"),hP.prototype),fP=m(hP.prototype,"_useOriginalSize",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),dP=m(hP.prototype,"_string",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),_P=m(hP.prototype,"_horizontalAlign",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OP.CENTER}}),pP=m(hP.prototype,"_verticalAlign",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return IP.CENTER}}),vP=m(hP.prototype,"_actualFontSize",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mP=m(hP.prototype,"_fontSize",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),yP=m(hP.prototype,"_fontFamily",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),gP=m(hP.prototype,"_lineHeight",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),bP=m(hP.prototype,"_overflow",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LP.NONE}}),xP=m(hP.prototype,"_enableWrapText",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),SP=m(hP.prototype,"_font",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TP=m(hP.prototype,"_isSystemFontUsed",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wP=m(hP.prototype,"_isItalic",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),EP=m(hP.prototype,"_isBold",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),AP=m(hP.prototype,"_isUnderline",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),CP=m(hP.prototype,"_cacheMode",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FP.NONE}}),cP=hP))||cP)||cP)||cP));cc.LabelComponent=jP,(UP=NP=NP||{})[UP.DEFAULT=0]="DEFAULT",UP[UP.DONE=1]="DONE",UP[UP.SEND=2]="SEND",UP[UP.SEARCH=3]="SEARCH",UP[UP.GO=4]="GO",UP[UP.NEXT=5]="NEXT",vt(NP),(GP=VP=VP||{})[GP.ANY=0]="ANY",GP[GP.EMAIL_ADDR=1]="EMAIL_ADDR",GP[GP.NUMERIC=2]="NUMERIC",GP[GP.PHONE_NUMBER=3]="PHONE_NUMBER",GP[GP.URL=4]="URL",GP[GP.DECIMAL=5]="DECIMAL",GP[GP.SINGLE_LINE=6]="SINGLE_LINE",vt(VP),(WP=HP=HP||{})[WP.PASSWORD=0]="PASSWORD",WP[WP.SENSITIVE=1]="SENSITIVE",WP[WP.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",WP[WP.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",WP[WP.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",WP[WP.DEFAULT=5]="DEFAULT",vt(HP);var XP=new Pn,YP=new Pn,KP=new Ni,QP=null,ZP={zoomInvalid:!1};fl.OS_ANDROID!==fl.os||fl.browserType!==fl.BROWSER_TYPE_SOUGOU&&fl.browserType!==fl.BROWSER_TYPE_360||(ZP.zoomInvalid=!0);var JP,$P,eF,tF,iF,nF,rF,aF,sF,oF,lF,uF,cF,hF,fF,dF,_F,pF,vF,mF,yF,gF,bF,xF,SF,TF,wF,EF,AF,CF,kF,RF,OF,MF,IF,BF=fo(qP=function(){function e(){y(this,e),this._delegate=null,this._inputMode=-1,this._inputFlag=-1,this._returnType=NP.DEFAULT,this._maxLength=50,this._text="",this._placeholderText="",this._alwaysOnTop=!1,this._size=new jn,this._node=null,this._editing=!1,this.__eventListeners={},this.__fullscreen=!1,this.__autoResize=!1,this.__rotateScreen=!1,this.__orientationChanged=void 0,this._edTxt=null,this._textColor=ar.WHITE.clone(),this._edFontSize=14,this._isTextArea=!1}return l(e,[{key:"onEnable",value:function(){this._edTxt&&(this._alwaysOnTop?this._edTxt.style.display="":this._edTxt.style.display="none")}},{key:"onDisable",value:function(){this._edTxt&&(this._edTxt.style.display="none")}},{key:"setTabIndex",value:function(e){this._edTxt&&(this._edTxt.tabIndex=e)}},{key:"setFocus",value:function(){this._beginEditing()}},{key:"isFocused",value:function(){return this._edTxt?document.activeElement===this._edTxt:(P(4700),!1)}},{key:"stayOnTop",value:function(e){this._alwaysOnTop!==e&&this._edTxt&&(this._alwaysOnTop=e,this._edTxt.style.display=e?"":"none")}},{key:"setMaxLength",value:function(e){isNaN(e)||(e<0&&(e=65535),this._maxLength=e,this._edTxt&&(this._edTxt.maxLength=e))}},{key:"setString",value:function(e){this._text=e,this._edTxt&&(this._edTxt.value=e)}},{key:"getString",value:function(){return this._text}},{key:"setPlaceholderText",value:function(e){this._placeholderText=e}},{key:"getPlaceholderText",value:function(){return this._placeholderText}},{key:"setDelegate",value:function(e){this._delegate=e}},{key:"setInputMode",value:function(e){this._inputMode!==e&&(this._inputMode=e,this.createInput(),this._updateDomInputType(),this._updateSize(this._size.width,this._size.height))}},{key:"setInputFlag",value:function(e){if(this._inputFlag!==e){this._inputFlag=e,this._updateDomInputType();var t="none";e===HP.INITIAL_CAPS_ALL_CHARACTERS?t="uppercase":e===HP.INITIAL_CAPS_WORD&&(t="capitalize"),this._edTxt&&(this._edTxt.style.textTransform=t,this._edTxt.value=this._text)}}},{key:"setReturnType",value:function(e){this._returnType=e,this._updateDomInputType()}},{key:"setFontSize",value:function(e){this._edFontSize=e||this._edFontSize,this._edTxt&&(this._edTxt.style.fontSize=this._edFontSize+"px")}},{key:"setFontColor",value:function(e){this._textColor=e,this._edTxt&&(this._edTxt.style.color=e.toCSS("rgba"))}},{key:"setSize",value:function(e,t){this._size.width=e,this._size.height=t,this._updateSize(e,t)}},{key:"setNode",value:function(e){this._node=e}},{key:"update",value:function(){this._updateMatrix()}},{key:"clear",value:function(){this._node=null,this.setDelegate(null),this.removeDom()}},{key:"_onTouchBegan",value:function(e){}},{key:"_onTouchEnded",value:function(){this._beginEditing()}},{key:"_beginEditing",value:function(){fl.isMobile&&!this._editing&&this._beginEditingOnMobile();var e=this;function t(){e._edTxt&&e._edTxt.focus()}this._edTxt&&(this._edTxt.style.display="",fl.browserType===fl.BROWSER_TYPE_UC?setTimeout(t,400):fl.browserType===fl.BROWSER_TYPE_FIREFOX?setTimeout(t,0):t()),this._editing=!0}},{key:"_endEditing",value:function(){function e(){!t._alwaysOnTop&&t._edTxt&&(t._edTxt.style.display="none"),t._delegate&&t._delegate.editBoxEditingDidEnded&&t._delegate.editBoxEditingDidEnded()}var t=this;this._editing&&(fl.isMobile?setTimeout(function(){t._endEditingOnMobile(),e()},400):e()),this._editing=!1}},{key:"_updateDomInputType",value:function(){var e=this._inputMode,t=this._edTxt;if(t){if(this._isTextArea){t=t;var i="none";return this._inputFlag===HP.INITIAL_CAPS_ALL_CHARACTERS?i="uppercase":this._inputFlag===HP.INITIAL_CAPS_WORD&&(i="capitalize"),void(t.style.textTransform=i)}if(t=t,this._inputFlag!==HP.PASSWORD){var n=t.type;e===VP.EMAIL_ADDR?n="email":e===VP.NUMERIC||e===VP.DECIMAL?n="number":e===VP.PHONE_NUMBER?(n="number",t.pattern="[0-9]*"):e===VP.URL?n="url":(n="text",this._returnType===NP.SEARCH&&(n="search")),t.type=n}else t.type="password"}}},{key:"_updateSize",value:function(e,t){var i=this._edTxt;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"_updateMatrix",value:function(){if(this._edTxt){var e=this._node,t=Tp.getScaleX(),i=Tp.getScaleY(),n=Tp.getViewportRect(),r=Tp.getDevicePixelRatio();e.getWorldMatrix(XP);var a=e.uiTransfromComp;a&&Ni.set(KP,-a.anchorX*a.width,-a.anchorY*a.height,KP.z),Pn.transform(XP,XP,KP);var s=e.getComponent(hC);if(!s)return!1;var o=kx.root.ui.getScreen(s.visibility);if(o){o.node.getWorldRT(YP);var l=YP.m12,u=YP.m13,c=ql.center;YP.m12=c.x-(YP.m00*l+YP.m04*u),YP.m13=c.y-(YP.m01*l+YP.m05*u),Pn.multiply(YP,YP,XP),t/=r,i/=r;var h=pp.container,f=YP.m00*t,d=XP.m01,_=XP.m04,p=YP.m05*i,v=parseInt(h&&h.style.paddingLeft||"0");v+=n.x/r;var m=parseInt(h&&h.style.paddingBottom||"0");m+=n.y/r;var y=YP.m12*t+v,g=YP.m13*i+m;ZP.zoomInvalid&&(this._updateSize(this._size.width*f,this._size.height*p),p=f=1);var b="matrix("+f+","+-d+","+-_+","+p+","+y+","+-g+")";this._edTxt.style.transform=b,this._edTxt.style["-webkit-transform"]=b,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},{key:"_adjustEditBoxPosition",value:function(){this._node.getWorldMatrix(XP);var t=XP.m13,i=ql.height,e=ql.width,n=.5;i<e&&(n=.7),setTimeout(function(){if(window.scrollY<40&&t<i*n){var e=i*n-t-window.scrollY;e<35&&(e=35),320<e&&(e=320),window.scrollTo(0,e)}},400)}},{key:"createInput",value:function(){this._isTextArea=!1,this._inputMode===VP.ANY?(this._isTextArea=!0,this._createDomTextArea()):this._createDomInput()}},{key:"_beginEditingOnMobile",value:function(){var e=this;this.__orientationChanged=function(){e._adjustEditBoxPosition()},window.addEventListener("orientationchange",this.__orientationChanged),Tp.isAutoFullScreenEnabled()?(this.__fullscreen=!0,Tp.enableAutoFullScreen(!1),ev.exitFullScreen()):this.__fullscreen=!1,this.__autoResize=Tp._resizeWithBrowserSize,Tp.resizeWithBrowserSize(!1),QP=this}},{key:"_endEditingOnMobile",value:function(){if(this.__rotateScreen){pp.container&&(pp.container.style["-webkit-transform"]="rotate(90deg)",pp.container.style.transform="rotate(90deg)");var e=Tp._originalDesignResolutionSize.width,t=Tp._originalDesignResolutionSize.height;0<e&&Tp.setDesignResolutionSize(e,t,Tp.getResolutionPolicy()),this.__rotateScreen=!1}this.__orientationChanged&&window.removeEventListener("orientationchange",this.__orientationChanged),this.__fullscreen&&Tp.enableAutoFullScreen(!0),this.__autoResize&&QP===this&&Tp.resizeWithBrowserSize(!0)}},{key:"_createDomInput",value:function(){this.removeDom();var e=this._edTxt=document.createElement("input");return e.type="text",e.style.fontSize=this._edFontSize+"px",e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="uppercase",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.style["-moz-appearance"]="textfield",e.className="cocosEditBox",e.style.fontFamily="Arial",PF(e,this),e}},{key:"_createDomTextArea",value:function(){this.removeDom();var e=this._edTxt=document.createElement("textarea");return e.style.fontSize=this._edFontSize+"px",e.style.color="#000000",e.style.border="0",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.resize="none",e.style.textTransform="uppercase",e.style.overflowY="scroll",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",PF(e,this,!0),e}},{key:"_addDomToGameContainer",value:function(){pp.container&&this._edTxt&&pp.container.appendChild(this._edTxt)}},{key:"removeDom",value:function(){var e=this._edTxt;if(e){var t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionstart),e.removeEventListener("compositionend",t.compositionend),e.removeEventListener("input",t.input),e.removeEventListener("focus",t.focus),e.removeEventListener("keypress",t.keypress),e.removeEventListener("blur",t.blur),t.compositionstart=null,t.compositionend=null,t.input=null,t.focus=null,t.keypress=null,t.blur=null,ut(pp.container,e)&&pp.container&&pp.container.removeChild(e)}this._edTxt=null}},{key:"text",get:function(){return this._text},set:function(e){this._text=e}},{key:"textColor",get:function(){return this._textColor}},{key:"fontSize",get:function(){return this._edFontSize}},{key:"returnType",set:function(e){this._returnType=e}},{key:"alwayOnTop",get:function(){return this._alwaysOnTop}},{key:"editing",get:function(){return this._editing},set:function(e){this._editing=e}},{key:"delegate",get:function(){return this._delegate}},{key:"eventListeners",get:function(){return this.__eventListeners}}]),e}())||qP;function LF(e,t){e.value.length>t._maxLength&&(e.value=e.value.slice(0,t._maxLength)),t._delegate&&t._delegate.editBoxTextChanged&&t._text!==e.value&&(t._text=e.value,t._delegate.editBoxTextChanged(t._text))}function PF(e,t,i){var n=2<arguments.length&&void 0!==i&&i,r=!1,a=t.eventListeners;a.compositionstart=function(){r=!0},e.addEventListener("compositionstart",a.compositionstart),a.compositionend=function(){r=!1,LF(this,t)},e.addEventListener("compositionend",a.compositionend),a.input=function(){r||LF(this,t)},e.addEventListener("input",a.input),a.focus=function(){this.style.fontSize=t.fontSize+"px",this.style.color=t.textColor.toCSS("rgba"),t.alwayOnTop&&(t.editing=!0),fl.isMobile&&t._beginEditingOnMobile(),t.delegate&&t.delegate.editBoxEditingDidBegan&&t.delegate.editBoxEditingDidBegan()},e.addEventListener("focus",a.focus),a.keypress=function(e){e.keyCode===Wl.KEY.enter&&(e.propagationStopped=!0,t.delegate&&t.delegate.editBoxEditingReturn&&t.delegate.editBoxEditingReturn(),n||(t.text=this.value,t._endEditing(),pp.canvas&&pp.canvas.focus()))},e.addEventListener("keypress",a.keypress),a.blur=function(){t.text=this.value,t._endEditing()},e.addEventListener("blur",a.blur),t._addDomToGameContainer()}var FF,zF,DF,NF,UF,VF,GF,HF,WF,qF,jF,XF,YF,KF,QF,ZF,JF,$F,ez,tz,iz,nz,rz,az,sz,oz,lz=m4("EditBoxComponent",(JP=fo("cc.EditBoxComponent"),$P=bo(100),eF=go("UI/EditBox"),tF=_o({type:Jh}),iF=_o({type:NP}),nF=_o({type:HP}),rF=_o({type:VP}),aF=_o({type:ar}),sF=_o({type:[Zw]}),oF=_o({type:[Zw]}),lF=_o({type:[Zw]}),uF=_o({type:[Zw]}),JP(cF=$P(cF=eF(cF=mo((IF=MF=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"editingDidBegan",fF,c(t)),v(t,"textChanged",dF,c(t)),v(t,"editingDidEnded",_F,c(t)),v(t,"editingReturn",pF,c(t)),t._impl=null,t._textLabel=null,t._placeholderLabel=null,t._background=null,v(t,"_returnType",vF,c(t)),v(t,"_useOriginalSize",mF,c(t)),v(t,"_string",yF,c(t)),v(t,"_tabIndex",gF,c(t)),v(t,"_backgroundImage",bF,c(t)),v(t,"_inputFlag",xF,c(t)),v(t,"_inputMode",SF,c(t)),v(t,"_fontSize",TF,c(t)),v(t,"_lineHeight",wF,c(t)),v(t,"_maxLength",EF,c(t)),v(t,"_fontColor",AF,c(t)),v(t,"_placeholder",CF,c(t)),v(t,"_placeholderFontSize",kF,c(t)),v(t,"_placeholderFontColor",RF,c(t)),v(t,"_stayOnTop",OF,c(t)),t}return _(a,Tm),l(a,[{key:"onEnable",value:function(){this._impl&&this._impl.onEnable()}},{key:"onDisable",value:function(){this._impl&&this._impl.onDisable()}},{key:"onDestroy",value:function(){this._impl&&this._impl.clear()}},{key:"_init",value:function(){this._createBackgroundSprite(),this._createLabels(),this.node.on(Gp.SIZE_CHANGED,this._resizeChildNodes,this);var e=this._impl=new BF;e.setDelegate(this),e.setNode(this.node),e.setInputMode(this._inputMode),e.setMaxLength(this._maxLength),e.setInputFlag(this._inputFlag),e.setReturnType(this._returnType),e.setTabIndex(this._tabIndex),e.setFontColor(this._fontColor),e.setFontSize(this._fontSize),e.setPlaceholderText(this._placeholder),this._updateStayOnTop(),this._updateString(this._string),this._syncSize()}},{key:"__preload",value:function(){this._registerEvent(),this._init()}},{key:"_registerEvent",value:function(){this.node.on(Gp.TOUCH_START,this._onTouchBegan,this),this.node.on(Gp.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateStayOnTop",value:function(){this.stayOnTop?this._hideLabels():this._showLabels(),this._impl&&this._impl.stayOnTop(this.stayOnTop)}},{key:"_syncSize",value:function(){var e=this.node.getContentSize();this._background&&(this._background.node.setAnchorPoint(this.node.getAnchorPoint()),this._background.node.setContentSize(e)),this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)}},{key:"_updateLabelPosition",value:function(e){var t=this.node,i=-t.anchorX*t.width,n=-t.anchorY*t.height,r=this._placeholderLabel,a=this._textLabel;a&&(a.node.setContentSize(e.width-2,e.height),a.node.setPosition(2+i,n+e.height,a.node.getPosition().z),a.verticalAlign=this._inputMode===VP.ANY?IP.TOP:IP.CENTER,a.enableWrapText=this._inputMode===VP.ANY),r&&(r.node.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.setPosition(2+i,n+e.height,r.node.getPosition().z),r.verticalAlign=this._inputMode===VP.ANY?IP.TOP:IP.CENTER,r.enableWrapText=this._inputMode===VP.ANY)}},{key:"_createBackgroundSprite",value:function(){this._background||(this._background=this.node.getComponent(WL),this._background||(this._background=this.node.addComponent(WL))),this._background.type=WL.Type.SLICED,this._background.spriteFrame=this._backgroundImage}},{key:"_createLabels",value:function(){if(!this._textLabel){var e=this.node.getChildByName("TEXT_LABEL"),t=(e=e||new cy("TEXT_LABEL")).getComponent(jP);e.parent=this.node,t=t||e.addComponent(jP),e.getComponent(qE).setAnchorPoint(0,1),t.color=this._fontColor,t.overflow=jP.Overflow.CLAMP,t.fontSize=this._fontSize,t.lineHeight=this.lineHeight,this._textLabel=t}if(!this._placeholderLabel){var i=this.node.getChildByName("PLACEHOLDER_LABEL"),n=(i=i||new cy("PLACEHOLDER_LABEL")).getComponent(jP);n=n||i.addComponent(jP);var r=i.getComponent(qE);i.parent=this.node,n.color=this._placeholderFontColor,r.setAnchorPoint(0,1),n.overflow=jP.Overflow.CLAMP,n.fontSize=this._placeholderFontSize,n.string=this._placeholder,this._placeholderLabel=n}}},{key:"_resizeChildNodes",value:function(){var e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-this.node.width/2,this.node.height/2,e.getPosition().z),e.width=this.node.width,e.height=this.node.height);var t=this._placeholderLabel&&this._placeholderLabel.node;t&&(t.setPosition(-this.node.width/2,this.node.height/2,t.getPosition().z),t.width=this.node.width,t.height=this.node.height);var i=this._background&&this._background.node;i&&(i.width=this.node.width,i.height=this.node.height)}},{key:"_showLabels",value:function(){if(this._textLabel){var e=this._textLabel.string;this._textLabel.node.active=""!==e,this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}}},{key:"_hideLabels",value:function(){this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}},{key:"_updateString",value:function(e){var t=this._textLabel;if(t){var i=e;i=i&&this._updateLabelStringStyle(i),t.string=i,this._impl&&(this._impl.setString(e),this._impl.editing||this.stayOnTop||this._showLabels())}}},{key:"_updateLabelStringStyle",value:function(e,t){var i=1<arguments.length&&void 0!==t&&t,n=this._inputFlag;if(i||n!==HP.PASSWORD)n===HP.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():n===HP.INITIAL_CAPS_WORD?e=function(e){return e.replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})}(e):n===HP.INITIAL_CAPS_SENTENCE&&(e=function(e){return e.charAt(0).toUpperCase()+e.slice(1)}(e));else{for(var r="",a=e.length,s=0;s<a;++s)r+="";e=r}return e}},{key:"editBoxEditingDidBegan",value:function(){this._hideLabels(),Zw.emitEvents(this.editingDidBegan,this),this.node.emit("editing-did-began",this)}},{key:"editBoxEditingDidEnded",value:function(){this.stayOnTop||this._showLabels(),Zw.emitEvents(this.editingDidEnded,this),this.node.emit("editing-did-ended",this)}},{key:"editBoxTextChanged",value:function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,Zw.emitEvents(this.textChanged,e,this),this.node.emit("text-changed",this)}},{key:"editBoxEditingReturn",value:function(){Zw.emitEvents(this.editingReturn,this),this.node.emit("editing-return",this)}},{key:"_onTouchBegan",value:function(e){this._impl&&this._impl._onTouchBegan(e.touch),e.propagationStopped=!0}},{key:"_onTouchEnded",value:function(e){this._impl&&this._impl._onTouchEnded(),e.propagationStopped=!0}},{key:"setFocus",value:function(){this._impl&&this._impl.setFocus()}},{key:"isFocused",value:function(){var e=!1;return this._impl&&(e=this._impl.isFocused()),e}},{key:"update",value:function(){this._impl&&this._impl.update()}},{key:"string",get:function(){return this._string},set:function(e){0<=this._maxLength&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._impl&&this._updateString(e)}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._createBackgroundSprite())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e,this._impl&&(this._impl.returnType=this._returnType)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag=e,this._impl&&(this._impl.setInputFlag(this._inputFlag),this._updateString(this._string))}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode=e,this._impl&&this._impl.setInputMode(this._inputMode)}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._textLabel&&(this._textLabel.fontSize=this._fontSize),this._impl&&this._impl.setFontSize(this._fontSize))}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._textLabel&&(this._textLabel.lineHeight=this._lineHeight))}},{key:"fontColor",get:function(){return this._fontColor},set:function(e){if(this._fontColor!==e){if(this._fontColor.set(e),this._textLabel){var t=this._textLabel.node.getComponent(hC);t&&(t.color=this._fontColor)}this._impl&&this._impl.setFontColor(this._fontColor)}}},{key:"placeholder",get:function(){return this._placeholder},set:function(e){this._placeholder!==e&&(this._placeholder=e,this._placeholderLabel&&(this._placeholderLabel.string=this._placeholder),this._impl&&this._impl.setPlaceholderText(this._placeholder))}},{key:"placeholderFontSize",get:function(){return this._placeholderFontSize},set:function(e){this._placeholderFontSize!==e&&(this._placeholderFontSize=e,this._placeholderLabel&&(this._placeholderLabel.fontSize=this._placeholderFontSize))}},{key:"placeholderFontColor",get:function(){return this._placeholderFontColor},set:function(e){if(this._placeholderFontColor!==e&&(this._placeholderFontColor=e,this._placeholderLabel)){var t=this._placeholderLabel.node.getComponent(hC);t&&(t.color=this._placeholderFontColor)}}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength!==e&&(this._maxLength=e,this._impl&&this._impl.setMaxLength(this._maxLength))}},{key:"stayOnTop",get:function(){return this._stayOnTop},set:function(e){this._stayOnTop=e,this._impl&&this._updateStayOnTop()}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex=e,this._impl&&this._impl.setTabIndex(e)}}]),a}(),MF._EditBoxImpl=BF,MF.KeyboardReturnType=NP,MF.InputFlag=HP,MF.InputMode=VP,m((hF=IF).prototype,"string",[_o],Object.getOwnPropertyDescriptor(hF.prototype,"string"),hF.prototype),m(hF.prototype,"backgroundImage",[tF],Object.getOwnPropertyDescriptor(hF.prototype,"backgroundImage"),hF.prototype),m(hF.prototype,"returnType",[iF],Object.getOwnPropertyDescriptor(hF.prototype,"returnType"),hF.prototype),m(hF.prototype,"inputFlag",[nF],Object.getOwnPropertyDescriptor(hF.prototype,"inputFlag"),hF.prototype),m(hF.prototype,"inputMode",[rF],Object.getOwnPropertyDescriptor(hF.prototype,"inputMode"),hF.prototype),m(hF.prototype,"fontSize",[_o],Object.getOwnPropertyDescriptor(hF.prototype,"fontSize"),hF.prototype),m(hF.prototype,"lineHeight",[_o],Object.getOwnPropertyDescriptor(hF.prototype,"lineHeight"),hF.prototype),m(hF.prototype,"fontColor",[aF],Object.getOwnPropertyDescriptor(hF.prototype,"fontColor"),hF.prototype),m(hF.prototype,"placeholder",[_o],Object.getOwnPropertyDescriptor(hF.prototype,"placeholder"),hF.prototype),m(hF.prototype,"placeholderFontSize",[_o],Object.getOwnPropertyDescriptor(hF.prototype,"placeholderFontSize"),hF.prototype),m(hF.prototype,"placeholderFontColor",[_o],Object.getOwnPropertyDescriptor(hF.prototype,"placeholderFontColor"),hF.prototype),m(hF.prototype,"maxLength",[_o],Object.getOwnPropertyDescriptor(hF.prototype,"maxLength"),hF.prototype),m(hF.prototype,"stayOnTop",[_o],Object.getOwnPropertyDescriptor(hF.prototype,"stayOnTop"),hF.prototype),m(hF.prototype,"tabIndex",[_o],Object.getOwnPropertyDescriptor(hF.prototype,"tabIndex"),hF.prototype),fF=m(hF.prototype,"editingDidBegan",[sF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dF=m(hF.prototype,"textChanged",[oF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_F=m(hF.prototype,"editingDidEnded",[lF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pF=m(hF.prototype,"editingReturn",[uF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vF=m(hF.prototype,"_returnType",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NP.DEFAULT}}),mF=m(hF.prototype,"_useOriginalSize",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),yF=m(hF.prototype,"_string",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),gF=m(hF.prototype,"_tabIndex",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bF=m(hF.prototype,"_backgroundImage",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xF=m(hF.prototype,"_inputFlag",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HP.DEFAULT}}),SF=m(hF.prototype,"_inputMode",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VP.ANY}}),TF=m(hF.prototype,"_fontSize",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),wF=m(hF.prototype,"_lineHeight",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),EF=m(hF.prototype,"_maxLength",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),AF=m(hF.prototype,"_fontColor",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ar.WHITE.clone()}}),CF=m(hF.prototype,"_placeholder",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Enter text here..."}}),kF=m(hF.prototype,"_placeholderFontSize",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),RF=m(hF.prototype,"_placeholderFontColor",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ar.GRAY.clone()}}),OF=m(hF.prototype,"_stayOnTop",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cF=hF))||cF)||cF)||cF)||cF));cc.EditBoxComponent=lz;var uz,cz,hz,fz,dz,_z,pz,vz,mz,yz,gz=Gp;(cz=uz=uz||{})[cz.NONE=0]="NONE",cz[cz.HORIZONTAL=1]="HORIZONTAL",cz[cz.VERTICAL=2]="VERTICAL",cz[cz.GRID=3]="GRID",mt(uz),(fz=hz=hz||{})[fz.NONE=0]="NONE",fz[fz.CONTAINER=1]="CONTAINER",fz[fz.CHILDREN=2]="CHILDREN",mt(hz),(_z=dz=dz||{})[_z.HORIZONTAL=0]="HORIZONTAL",_z[_z.VERTICAL=1]="VERTICAL",mt(dz),(vz=pz=pz||{})[vz.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",vz[vz.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM",mt(pz),(yz=mz=mz||{})[yz.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",yz[yz.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT",mt(mz);var bz,xz,Sz,Tz,wz,Ez,Az,Cz,kz,Rz,Oz,Mz,Iz,Bz,Lz,Pz,Fz,zz,Dz,Nz,Uz,Vz,Gz=new Ni,Hz=new Ni,Wz=m4("LayoutComponent",(FF=fo("cc.LayoutComponent"),zF=bo(110),DF=go("UI/Layout"),NF=_o({type:uz}),UF=_o({type:hz}),VF=_o({type:dz}),GF=_o({type:pz}),HF=_o({type:mz}),FF(WF=zF(WF=DF(WF=mo((oz=sz=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._layoutDirty=!0,v(t,"_resizeMode",jF,c(t)),v(t,"_N$layoutType",XF,c(t)),v(t,"_N$padding",YF,c(t)),v(t,"_cellSize",KF,c(t)),v(t,"_startAxis",QF,c(t)),v(t,"_paddingLeft",ZF,c(t)),v(t,"_paddingRight",JF,c(t)),v(t,"_paddingTop",$F,c(t)),v(t,"_paddingBottom",ez,c(t)),v(t,"_spacingX",tz,c(t)),v(t,"_spacingY",iz,c(t)),t._layoutSize=new jn(300,200),v(t,"_verticalDirection",nz,c(t)),v(t,"_horizontalDirection",rz,c(t)),v(t,"_affectedByScale",az,c(t)),t}return _(a,Tm),l(a,[{key:"updateLayout",value:function(){this._layoutDirty&&0<this.node.children.length&&(this._doLayout(),this._layoutDirty=!1)}},{key:"onEnable",value:function(){this._addEventListeners(),this.node.getContentSize().equals(new jn)&&this.node.setContentSize(this._layoutSize),0!==this._N$padding&&this._migratePaddingData(),this._doLayoutDirty()}},{key:"onDisable",value:function(){this._removeEventListeners()}},{key:"_migratePaddingData",value:function(){this._paddingLeft=this._N$padding,this._paddingRight=this._N$padding,this._paddingTop=this._N$padding,this._paddingBottom=this._N$padding,this._N$padding=0}},{key:"_addEventListeners",value:function(){kx.on(Cx.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(gz.SIZE_CHANGED,this._resized,this),this.node.on(gz.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(gz.CHILD_ADDED,this._childAdded,this),this.node.on(gz.CHILD_REMOVED,this._childRemoved,this),this._addChildrenEventListeners()}},{key:"_removeEventListeners",value:function(){kx.off(Cx.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(gz.SIZE_CHANGED,this._resized,this),this.node.off(gz.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(gz.CHILD_ADDED,this._childAdded,this),this.node.off(gz.CHILD_REMOVED,this._childRemoved,this),this._removeChildrenEventListeners()}},{key:"_addChildrenEventListeners",value:function(){var e=this.node.children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.on(gz.SCALE_PART,this._doScaleDirty,this),r.on(gz.SIZE_CHANGED,this._doLayoutDirty,this),r.on(gz.TRANSFORM_CHANGED,this._transformDirty,this),r.on(gz.ANCHOR_CHANGED,this._doLayoutDirty,this),r.on("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_removeChildrenEventListeners",value:function(){var e=this.node.children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.off(gz.SCALE_PART,this._doScaleDirty,this),r.off(gz.SIZE_CHANGED,this._doLayoutDirty,this),r.off(gz.TRANSFORM_CHANGED,this._transformDirty,this),r.off(gz.ANCHOR_CHANGED,this._doLayoutDirty,this),r.off("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_childAdded",value:function(e){e.on(gz.SCALE_PART,this._doScaleDirty,this),e.on(gz.SIZE_CHANGED,this._doLayoutDirty,this),e.on(gz.TRANSFORM_CHANGED,this._transformDirty,this),e.on(gz.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_childRemoved",value:function(e){e.off(gz.SCALE_PART,this._doScaleDirty,this),e.off(gz.SIZE_CHANGED,this._doLayoutDirty,this),e.off(gz.TRANSFORM_CHANGED,this._transformDirty,this),e.off(gz.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_resized",value:function(){this._layoutSize=this.node.getContentSize(),this._doLayoutDirty()}},{key:"_doLayoutHorizontally",value:function(e,t,i,n){var r=this.node.getAnchorPoint(),a=this.node.children,s=1,o=this._paddingLeft,l=-r.x*e;this._horizontalDirection===mz.RIGHT_TO_LEFT&&(s=-1,l=(1-r.x)*e,o=this._paddingRight);var u=l+s*o-s*this._spacingX,c=0,h=0,f=0,d=0,_=0,p=0,v=0,m=a,y=Array.isArray(m),g=0;for(m=y?m:m[Symbol.iterator]();;){var b;if(y){if(g>=m.length)break;b=m[g++]}else{if((g=m.next()).done)break;b=g.value}b.activeInHierarchy&&v++}var x=this._cellSize.width;this._N$layoutType!==uz.GRID&&this._resizeMode===hz.CHILDREN&&(x=(e-(this._paddingLeft+this._paddingRight)-(v-1)*this._spacingX)/v);var S=a,T=Array.isArray(S),w=0;for(S=T?S:S[Symbol.iterator]();;){var E;if(T){if(w>=S.length)break;E=S[w++]}else{if((w=S.next()).done)break;E=w.value}var A=E;if(A.activeInHierarchy){A.getScale(Hz);var C=this._getUsedScaleValue(Hz.x),k=this._getUsedScaleValue(Hz.y);this._resizeMode===hz.CHILDREN&&(A.width=x/C,this._N$layoutType===uz.GRID&&(A.height=this._cellSize.height/k));var R=A.anchorX,O=A.width*C,M=A.height*k;h<f&&(h=f),h<=M&&(f=h,h=M,p=A.getAnchorPoint().y),this._horizontalDirection===mz.RIGHT_TO_LEFT&&(R=1-A.anchorX),u=u+s*R*O+s*this._spacingX;var I=s*(1-R)*O;if(t){var B=u+I+s*(0<s?this._paddingRight:this._paddingLeft),L=!1;this._horizontalDirection===mz.LEFT_TO_RIGHT&&B>(1-r.x)*e&&(L=!0);var P=!1;this._horizontalDirection===mz.RIGHT_TO_LEFT&&B<-r.x*e&&(P=!0),(L||P)&&(h<=M?(0===f&&(f=h),c+=f,f=h):(c+=h,f=M,h=0),u=l+s*(o+R*O),d++)}var F=i(A,c,d);e>=O+this._paddingLeft+this._paddingRight&&n&&(A.getPosition(Gz),A.setPosition(u,F,Gz.z));var z=1,D=void 0,N=0===h?M:h;this._verticalDirection===pz.TOP_TO_BOTTOM?(_=_||this.node.getContentSize().height,(D=F+(z=-1)*(N*p+this._paddingBottom))<_&&(_=D)):(_=_||-this.node.getContentSize().height)<(D=F+z*(N*p+this._paddingTop))&&(_=D),u+=I}}return _}},{key:"_doLayoutVertically",value:function(e,t,i,n){var r=this.node.getAnchorPoint(),a=this.node.children,s=1,o=this._paddingBottom,l=-r.y*e;this._verticalDirection===pz.TOP_TO_BOTTOM&&(s=-1,l=(1-r.y)*e,o=this._paddingTop);var u=l+s*o-s*this._spacingY,c=0,h=0,f=0,d=0,_=0,p=0,v=0,m=a,y=Array.isArray(m),g=0;for(m=y?m:m[Symbol.iterator]();;){var b;if(y){if(g>=m.length)break;b=m[g++]}else{if((g=m.next()).done)break;b=g.value}b.activeInHierarchy&&v++}var x=this._cellSize.height;this._N$layoutType!==uz.GRID&&this._resizeMode===hz.CHILDREN&&(x=(e-(this._paddingTop+this._paddingBottom)-(v-1)*this._spacingY)/v);var S=a,T=Array.isArray(S),w=0;for(S=T?S:S[Symbol.iterator]();;){var E;if(T){if(w>=S.length)break;E=S[w++]}else{if((w=S.next()).done)break;E=w.value}var A=E;if(A){var C=A.getScale(),k=this._getUsedScaleValue(C.x),R=this._getUsedScaleValue(C.y);if(A.activeInHierarchy){this._resizeMode===hz.CHILDREN&&(A.height=x/R,this._N$layoutType===uz.GRID&&(A.width=this._cellSize.width/k));var O=A.anchorY,M=A.width*k,I=A.height*R;h<f&&(h=f),h<=M&&(f=h,h=M,p=A.getAnchorPoint().x),this._verticalDirection===pz.TOP_TO_BOTTOM&&(O=1-A.anchorY),u=u+s*O*I+s*this._spacingY;var B=s*(1-O)*I;if(t){var L=u+B+s*(0<s?this._paddingTop:this._paddingBottom),P=!1;this._verticalDirection===pz.BOTTOM_TO_TOP&&L>(1-r.y)*e&&(P=!0);var F=!1;this._verticalDirection===pz.TOP_TO_BOTTOM&&L<-r.y*e&&(F=!0),(P||F)&&(h<=M?(0===f&&(f=h),c+=f,f=h):(c+=h,f=M,h=0),u=l+s*(o+O*I),d++)}var z=i(A,c,d);e>=I+(this._paddingTop+this._paddingBottom)&&n&&(A.getPosition(Gz),A.setPosition(z,u,Gz.z));var D=1,N=void 0,U=0===h?M:h;this._horizontalDirection===mz.RIGHT_TO_LEFT?(D=-1,_=_||this.node.getContentSize().width,(N=z+D*(U*p+this._paddingLeft))<_&&(_=N)):(_=_||-this.node.getContentSize().width)<(N=z+D*(U*p+this._paddingRight))&&(_=N),u+=B}}}return _}},{key:"_doLayoutBasic",value:function(){var e=null,t=this.node.children,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r,s=a.getComponent(qE);s&&a.activeInHierarchy&&(e?Jn.union(e,e,s.getBoundingBoxToWorld()):e=s.getBoundingBoxToWorld())}if(e){var o=this.node.parent.getComponent(qE);if(!o)return;Ni.set(Gz,e.x,e.y,0);var l=new Ni;o.convertToNodeSpaceAR(Gz,l),Ni.set(l,l.x-this._paddingLeft,l.y-this._paddingBottom,l.z),Ni.set(Gz,e.x+e.width,e.y+e.height,0);var u=new Ni;o.convertToNodeSpaceAR(Gz,u),Ni.set(u,u.x+this._paddingRight,u.y+this._paddingTop,u.z);var c=cc.size(parseFloat((u.x-l.x).toFixed(2)),parseFloat((u.y-l.y).toFixed(2)));if(this.node.getPosition(Gz),0!==c.width){var h=(Gz.x-l.x)/c.width;this.node.anchorX=parseFloat(h.toFixed(2))}if(0!==c.height){var f=(Gz.y-l.y)/c.height;this.node.anchorY=parseFloat(f.toFixed(2))}this.node.setContentSize(c)}}},{key:"_doLayoutGridAxisHorizontal",value:function(e,t){var n=this,i=t.width,r=1,a=-e.y*t.height,s=this._paddingBottom;this._verticalDirection===pz.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*t.height,s=this._paddingTop);function o(e,t,i){return a+r*(t+e.anchorY*e.height*l._getUsedScaleValue(e.getScale().y)+s+i*n._spacingY)}var l=this,u=0;if(this._resizeMode===hz.CONTAINER){var c=this._doLayoutHorizontally(i,!0,o,!1);(u=a-c)<0&&(u*=-1),a=-e.y*u,this._verticalDirection===pz.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*u)}this._doLayoutHorizontally(i,!0,o,!0),this._resizeMode===hz.CONTAINER&&this.node.setContentSize(i,u)}},{key:"_doLayoutGridAxisVertical",value:function(e,t){var n=this,i=t.height,r=1,a=-e.x*t.width,s=this._paddingLeft;this._horizontalDirection===mz.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*t.width,s=this._paddingRight);function o(e,t,i){return a+r*(t+e.anchorX*e.width*l._getUsedScaleValue(e.getScale().x)+s+i*n._spacingX)}var l=this,u=0;if(this._resizeMode===hz.CONTAINER){var c=this._doLayoutVertically(i,!0,o,!1);(u=a-c)<0&&(u*=-1),a=-e.x*u,this._horizontalDirection===mz.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*u)}this._doLayoutVertically(i,!0,o,!0),this._resizeMode===hz.CONTAINER&&this.node.setContentSize(u,i)}},{key:"_doLayoutGrid",value:function(){var e=this.node.getAnchorPoint(),t=this.node.getContentSize();this.startAxis===dz.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,t):this.startAxis===dz.VERTICAL&&this._doLayoutGridAxisVertical(e,t)}},{key:"_getHorizontalBaseWidth",value:function(e){var t=0,i=0;if(this._resizeMode===hz.CONTAINER){var n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.getScale(Hz),o.activeInHierarchy&&(i++,t+=o.width*this._getUsedScaleValue(Hz.x))}t+=(i-1)*this._spacingX+this._paddingLeft+this._paddingRight}else t=this.node.getContentSize().width;return t}},{key:"_getVerticalBaseHeight",value:function(e){var t=0,i=0;if(this._resizeMode===hz.CONTAINER){var n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.getScale(Hz),o.activeInHierarchy&&(i++,t+=o.height*this._getUsedScaleValue(Hz.y))}t+=(i-1)*this._spacingY+this._paddingBottom+this._paddingTop}else t=this.node.getContentSize().height;return t}},{key:"_doLayout",value:function(){if(this._N$layoutType===uz.HORIZONTAL){var e=this._getHorizontalBaseWidth(this.node.children);this._doLayoutHorizontally(e,!1,function(e){return e.getPosition(Gz),Gz.y},!0),this.node.width=e}else if(this._N$layoutType===uz.VERTICAL){var t=this._getVerticalBaseHeight(this.node.children);this._doLayoutVertically(t,!1,function(e){return e.getPosition(Gz),Gz.x},!0),this.node.height=t}else this._N$layoutType===uz.NONE?this._resizeMode===hz.CONTAINER&&this._doLayoutBasic():this._N$layoutType===uz.GRID&&this._doLayoutGrid()}},{key:"_getUsedScaleValue",value:function(e){return this._affectedByScale?Math.abs(e):1}},{key:"_transformDirty",value:function(e){e===Gp.POSITION_PART&&this._doLayoutDirty()}},{key:"_doLayoutDirty",value:function(){this._layoutDirty=!0}},{key:"_doScaleDirty",value:function(){this._layoutDirty=this._layoutDirty||this._affectedByScale}},{key:"type",get:function(){return this._N$layoutType},set:function(e){this._N$layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._N$layoutType===uz.NONE&&e===hz.CHILDREN||(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this._N$padding=e,this._migratePaddingData(),this._doLayoutDirty()}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),a}(),sz.Type=uz,sz.VerticalDirection=pz,sz.HorizontalDirection=mz,sz.ResizeMode=hz,sz.AxisDirection=dz,m((qF=oz).prototype,"type",[NF],Object.getOwnPropertyDescriptor(qF.prototype,"type"),qF.prototype),m(qF.prototype,"resizeMode",[UF],Object.getOwnPropertyDescriptor(qF.prototype,"resizeMode"),qF.prototype),m(qF.prototype,"cellSize",[_o],Object.getOwnPropertyDescriptor(qF.prototype,"cellSize"),qF.prototype),m(qF.prototype,"startAxis",[VF],Object.getOwnPropertyDescriptor(qF.prototype,"startAxis"),qF.prototype),m(qF.prototype,"paddingLeft",[_o],Object.getOwnPropertyDescriptor(qF.prototype,"paddingLeft"),qF.prototype),m(qF.prototype,"paddingRight",[_o],Object.getOwnPropertyDescriptor(qF.prototype,"paddingRight"),qF.prototype),m(qF.prototype,"paddingTop",[_o],Object.getOwnPropertyDescriptor(qF.prototype,"paddingTop"),qF.prototype),m(qF.prototype,"paddingBottom",[_o],Object.getOwnPropertyDescriptor(qF.prototype,"paddingBottom"),qF.prototype),m(qF.prototype,"spacingX",[_o],Object.getOwnPropertyDescriptor(qF.prototype,"spacingX"),qF.prototype),m(qF.prototype,"spacingY",[_o],Object.getOwnPropertyDescriptor(qF.prototype,"spacingY"),qF.prototype),m(qF.prototype,"verticalDirection",[GF],Object.getOwnPropertyDescriptor(qF.prototype,"verticalDirection"),qF.prototype),m(qF.prototype,"horizontalDirection",[HF],Object.getOwnPropertyDescriptor(qF.prototype,"horizontalDirection"),qF.prototype),m(qF.prototype,"padding",[_o],Object.getOwnPropertyDescriptor(qF.prototype,"padding"),qF.prototype),m(qF.prototype,"affectedByScale",[_o],Object.getOwnPropertyDescriptor(qF.prototype,"affectedByScale"),qF.prototype),jF=m(qF.prototype,"_resizeMode",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hz.NONE}}),XF=m(qF.prototype,"_N$layoutType",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uz.NONE}}),YF=m(qF.prototype,"_N$padding",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KF=m(qF.prototype,"_cellSize",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jn(40,40)}}),QF=m(qF.prototype,"_startAxis",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dz.HORIZONTAL}}),ZF=m(qF.prototype,"_paddingLeft",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),JF=m(qF.prototype,"_paddingRight",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$F=m(qF.prototype,"_paddingTop",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ez=m(qF.prototype,"_paddingBottom",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tz=m(qF.prototype,"_spacingX",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iz=m(qF.prototype,"_spacingY",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nz=m(qF.prototype,"_verticalDirection",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pz.TOP_TO_BOTTOM}}),rz=m(qF.prototype,"_horizontalDirection",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mz.LEFT_TO_RIGHT}}),az=m(qF.prototype,"_affectedByScale",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),WF=qF))||WF)||WF)||WF)||WF));cc.LayoutComponent=Wz,(xz=bz=bz||{})[xz.BUTT=0]="BUTT",xz[xz.ROUND=1]="ROUND",xz[xz.SQUARE=2]="SQUARE",mt(bz),(Tz=Sz=Sz||{})[Tz.BEVEL=0]="BEVEL",Tz[Tz.ROUND=1]="ROUND",Tz[Tz.MITER=2]="MITER",mt(Sz),(Ez=wz=wz||{})[Ez.PT_CORNER=1]="PT_CORNER",Ez[Ez.PT_LEFT=2]="PT_LEFT",Ez[Ez.PT_BEVEL=4]="PT_BEVEL",Ez[Ez.PT_INNERBEVEL=8]="PT_INNERBEVEL",mt(wz);var qz,jz,Xz,Yz,Kz,Qz,Zz,Jz,$z,eD,tD,iD,nD,rD=m4("GraphicsComponent",(Az=fo("cc.GraphicsComponent"),Cz=bo(110),kz=go("UI/Render/Graphics"),Rz=_o({type:Sz}),Oz=_o({type:bz}),Mz=_o({override:!0,visible:!1}),Az(Iz=Cz(Iz=kz((Vz=Uz=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this))).impl=null,e.model=null,v(e,"_lineWidth",Lz,c(e)),v(e,"_strokeColor",Pz,c(e)),v(e,"_lineJoin",Fz,c(e)),v(e,"_lineCap",zz,c(e)),v(e,"_fillColor",Dz,c(e)),v(e,"_miterLimit",Nz,c(e)),e._instanceMaterialType=HA.ADDCOLOR,e}return _(t,hC),l(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color}}]),l(t,[{key:"onRestore",value:function(){this.impl||this._flushAssembler()}},{key:"__preload",value:function(){p(g(t.prototype),"__preload",this)&&p(g(t.prototype),"__preload",this).call(this),this.impl=this._assembler&&this._assembler.createImpl(this)}},{key:"onLoad",value:function(){this._sceneGetter=kx.root.ui.getRenderSceneGetter()}},{key:"onEnable",value:function(){p(g(t.prototype),"onEnable",this).call(this),this.model&&(this.model.enabled=!0),this._activateMaterial()}},{key:"onDisable",value:function(){this.model&&(this.model.enabled=!1)}},{key:"onDestroy",value:function(){p(g(t.prototype),"onDestroy",this).call(this),this._sceneGetter=null,this.model&&(this._getRenderScene().destroyModel(this.model),this.model=null),this.impl&&(this.impl.clear(),this.impl=null)}},{key:"_activateMaterial",value:function(){this._material&&this._updateMaterial(this._material)}},{key:"moveTo",value:function(e,t){this.impl&&this.impl.moveTo(e,t)}},{key:"lineTo",value:function(e,t){this.impl&&this.impl.lineTo(e,t)}},{key:"bezierCurveTo",value:function(e,t,i,n,r,a){this.impl&&this.impl.bezierCurveTo(e,t,i,n,r,a)}},{key:"quadraticCurveTo",value:function(e,t,i,n){this.impl&&this.impl.quadraticCurveTo(e,t,i,n)}},{key:"arc",value:function(e,t,i,n,r,a){this.impl&&this.impl.arc(e,t,i,n,r,a)}},{key:"ellipse",value:function(e,t,i,n){this.impl&&this.impl.ellipse(e,t,i,n)}},{key:"circle",value:function(e,t,i){this.impl&&this.impl.circle(e,t,i)}},{key:"rect",value:function(e,t,i,n){this.impl&&this.impl.rect(e,t,i,n)}},{key:"roundRect",value:function(e,t,i,n,r){this.impl&&this.impl.roundRect(e,t,i,n,r)}},{key:"fillRect",value:function(e,t,i,n){this.rect(e,t,i,n),this.fill()}},{key:"clear",value:function(e){var t=0<arguments.length&&void 0!==e&&e;this.impl&&(this.impl.clear(t),this.model&&(this.model.scene.destroyModel(this.model),this.model=null),this.markForUpdateRenderData())}},{key:"close",value:function(){this.impl&&this.impl.close()}},{key:"stroke",value:function(){this._assembler.stroke(this)}},{key:"fill",value:function(){this._assembler.fill(this)}},{key:"helpInstanceMaterial",value:function(){var e=null;this._sharedMaterial?e=F_.getInstantiatedMaterial(this._sharedMaterial,new ZA,!1):((e=F_.getInstantiatedMaterial(t_.get("ui-base-material"),new ZA,!1)).recompileShaders({USE_LOCAL:!0}),e.onLoaded()),this._updateMaterial(e),this.impl||(this._flushAssembler(),this.impl=this._assembler&&this._assembler.createImpl(this))}},{key:"_render",value:function(e){e.commitModel(this,this.model,this._material)}},{key:"_instanceMaterial",value:function(){this.helpInstanceMaterial()}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}},{key:"_canRender",value:function(){return!!p(g(t.prototype),"_canRender",this).call(this)&&!!this.model}}]),t}(),Uz.LineJoin=Sz,Uz.LineCap=bz,m((Bz=Vz).prototype,"lineJoin",[Rz],Object.getOwnPropertyDescriptor(Bz.prototype,"lineJoin"),Bz.prototype),m(Bz.prototype,"lineCap",[Oz],Object.getOwnPropertyDescriptor(Bz.prototype,"lineCap"),Bz.prototype),m(Bz.prototype,"strokeColor",[_o],Object.getOwnPropertyDescriptor(Bz.prototype,"strokeColor"),Bz.prototype),m(Bz.prototype,"fillColor",[_o],Object.getOwnPropertyDescriptor(Bz.prototype,"fillColor"),Bz.prototype),m(Bz.prototype,"miterLimit",[_o],Object.getOwnPropertyDescriptor(Bz.prototype,"miterLimit"),Bz.prototype),m(Bz.prototype,"color",[Mz],Object.getOwnPropertyDescriptor(Bz.prototype,"color"),Bz.prototype),Lz=m(Bz.prototype,"_lineWidth",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Pz=m(Bz.prototype,"_strokeColor",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ar.BLACK.clone()}}),Fz=m(Bz.prototype,"_lineJoin",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sz.MITER}}),zz=m(Bz.prototype,"_lineCap",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bz.BUTT}}),Dz=m(Bz.prototype,"_fillColor",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ar.WHITE.clone()}}),Nz=m(Bz.prototype,"_miterLimit",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),Iz=Bz))||Iz)||Iz)||Iz));cc.GraphicsComponent=rD;var aD,sD,oD=new Pn,lD=new Ii,uD=new Pn,cD=[];(sD=aD=aD||{})[sD.RECT=0]="RECT",sD[sD.ELLIPSE=1]="ELLIPSE",mt(aD);var hD,fD,dD,_D,pD,vD,mD,yD,gD,bD,xD,SD,TD,wD,ED,AD,CD,kD=m4("MaskComponent",(qz=fo("cc.MaskComponent"),jz=bo(110),Xz=go("UI/Render/Mask"),Yz=_o({type:aD,displayOrder:4}),Kz=_o({visible:!1,override:!0}),Qz=_o({visible:!1,override:!0}),Zz=_o({visible:!1,override:!0}),qz(Jz=jz(Jz=Xz((nD=iD=function(){function i(){var e;return y(this,i),v(e=x(this,g(i).call(this)),"_type",eD,c(e)),v(e,"_segments",tD,c(e)),e._graphics=null,e._clearGraphics=null,e._instanceMaterialType=HA.ADDCOLOR,e}return _(i,hC),l(i,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null),this._activateMaterial())}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments=pi(e,3,1e4),this._updateGraphics()}},{key:"graphics",get:function(){return this._graphics}},{key:"clearGraphics",get:function(){return this._clearGraphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}}]),l(i,[{key:"onLoad",value:function(){this._createGraphics()}},{key:"onRestore",value:function(){this._createGraphics(),this._updateGraphics()}},{key:"onEnable",value:function(){p(g(i.prototype),"onEnable",this).call(this),this._flushVisibility(),this._clearGraphics&&this._clearGraphics.onEnable(),this._updateGraphics(),this._activateMaterial(),this.node.on(Gp.TRANSFORM_CHANGED,this._nodeStateChange,this),Tp.on("design-resolution-changed",this._updateClearGraphics,this)}},{key:"onDisable",value:function(){p(g(i.prototype),"onDisable",this).call(this),this._disableGraphics(),this.node.off(Gp.TRANSFORM_CHANGED,this._nodeStateChange),Tp.off("design-resolution-changed",this._updateClearGraphics)}},{key:"onDestroy",value:function(){p(g(i.prototype),"onDestroy",this).call(this),this._removeGraphics()}},{key:"isHit",value:function(e){var t=this.node,i=t.getContentSize(),n=i.width,r=i.height,a=lD;this.node.getWorldMatrix(oD),Pn.invert(uD,oD),Ii.transformMat4(a,e,uD);var s=t.getAnchorPoint();a.x+=s.x*n,a.y+=s.y*r;var o=!1;if(this.type===aD.RECT)o=0<=a.x&&0<=a.y&&a.x<=n&&a.y<=r;else if(this.type===aD.ELLIPSE){var l=n/2,u=r/2,c=a.x-.5*n,h=a.y-.5*r;o=c*c/(l*l)+h*h/(u*u)<1}return o}},{key:"_resizeNodeToTargetNode",value:function(){}},{key:"_render",value:function(e){e.commitComp(this,null,this._assembler)}},{key:"_postRender",value:function(e){this._postAssembler&&e.commitComp(this,null,this._postAssembler)}},{key:"_nodeStateChange",value:function(e){e!==Gp.POSITION_PART&&(p(g(i.prototype),"_nodeStateChange",this).call(this,e),this._updateGraphics())}},{key:"_resolutionChanged",value:function(){this._updateClearGraphics()}},{key:"_canRender",value:function(){return!!p(g(i.prototype),"_canRender",this).call(this)&&(null!==this._clearGraphics&&null!==this._graphics)}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this),t=i.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==t&&(this._postAssembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.sharedMaterial,this.markForUpdateRenderData())}},{key:"_parentChanged",value:function(e){return!!p(g(i.prototype),"_parentChanged",this).call(this,e)&&(this._flushVisibility(),!0)}},{key:"_onTextureLoaded",value:function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderData.vertDirty=!0),this.enabledInHierarchy&&this._activateMaterial()}},{key:"_applySpriteFrame",value:function(e){}},{key:"_createGraphics",value:function(){if(!this._clearGraphics){var e=this._clearGraphics=new rD;e.node=new cy("clear-graphics"),e.helpInstanceMaterial(),e._activateMaterial(),e.lineWidth=0;var t=ar.WHITE.clone();t.a=0,e.fillColor=t,e.simulate=!0,this._updateClearGraphics()}if(!this._graphics){var i=this._graphics=new rD;i.node=this.node,i.node.getWorldMatrix(),i.helpInstanceMaterial(),i.lineWidth=0;var n=ar.WHITE.clone();n.a=0,i.fillColor=n}}},{key:"_updateClearGraphics",value:function(){if(this._clearGraphics){var e=ql;this._clearGraphics.node.setWorldPosition(e.width/2,e.height/2,0),this._clearGraphics.clear(),this._clearGraphics.rect(-e.width/2,-e.height/2,e.width,e.height),this._clearGraphics.fill()}}},{key:"_updateGraphics",value:function(){if(this._graphics){var e=this.node,t=this._graphics;t.clear();var i=e.getContentSize(),n=i.width,r=i.height,a=e.getAnchorPoint(),s=-n*a.x,o=-r*a.y;if(this._type===aD.RECT)t.rect(s,o,n,r);else if(this._type===aD.ELLIPSE){for(var l=function(e,t,i){cD.length=0;for(var n=2*Math.PI/i,r=0;r<i;++r)cD.push(new Ni(t.x*Math.cos(n*r)+e.x,t.y*Math.sin(n*r)+e.y,0));return cD}(new Ni(s+n/2,o+r/2,0),new Ni(n/2,r/2,0),this._segments),u=0;u<l.length;++u){var c=l[u];0===u?t.moveTo(c.x,c.y):t.lineTo(c.x,c.y)}t.close()}t.fill()}}},{key:"_disableGraphics",value:function(){this._graphics&&this._graphics.onDisable(),this._clearGraphics&&this._clearGraphics.onDisable()}},{key:"_removeGraphics",value:function(){this._graphics&&this._graphics.destroy(),this._clearGraphics&&this._clearGraphics.destroy()}},{key:"_flushVisibility",value:function(){this._clearGraphics&&this._clearGraphics._setScreen(this._screen),this._graphics&&this._graphics._setScreen(this._screen)}},{key:"_activateMaterial",value:function(){}}]),i}(),iD.Type=aD,m(($z=nD).prototype,"type",[Yz],Object.getOwnPropertyDescriptor($z.prototype,"type"),$z.prototype),m($z.prototype,"segments",[_o],Object.getOwnPropertyDescriptor($z.prototype,"segments"),$z.prototype),m($z.prototype,"dstBlendFactor",[Kz],Object.getOwnPropertyDescriptor($z.prototype,"dstBlendFactor"),$z.prototype),m($z.prototype,"srcBlendFactor",[Qz],Object.getOwnPropertyDescriptor($z.prototype,"srcBlendFactor"),$z.prototype),m($z.prototype,"color",[Zz],Object.getOwnPropertyDescriptor($z.prototype,"color"),$z.prototype),eD=m($z.prototype,"_type",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return aD.RECT}}),tD=m($z.prototype,"_segments",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),Jz=$z))||Jz)||Jz)||Jz));cc.MaskComponent=kD,(CD=AD=AD||{})[CD.HORIZONTAL=0]="HORIZONTAL",CD[CD.VERTICAL=1]="VERTICAL",CD[CD.FILLED=2]="FILLED",vt(AD);var RD,OD,MD,ID,BD=m4("ProgressBarComponent",(hD=fo("cc.ProgressBarComponent"),fD=bo(110),dD=go("UI/ProgressBar"),_D=_o({type:WL}),pD=_o({type:AD}),vD=_o({range:[0,1,.1],slide:!0}),hD(mD=fD(mD=dD((ED=wD=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_barSprite",gD,c(t)),v(t,"_mode",bD,c(t)),v(t,"_totalLength",xD,c(t)),v(t,"_progress",SD,c(t)),v(t,"_reverse",TD,c(t)),t}return _(a,Tm),l(a,[{key:"_initBarSprite",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node.getContentSize(),i=this.node.getAnchorPoint(),n=e.getContentSize();if(this._barSprite.fillType===WL.FillType.RADIAL&&(this._mode=AD.FILLED),this._mode===AD.HORIZONTAL?this.totalLength=n.width:this._mode===AD.VERTICAL?this.totalLength=n.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var r=-t.width*i.x;e.setPosition(r,0,0)}}}},{key:"_updateBarStatus",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e.getAnchorPoint(),i=e.getContentSize(),n=e.getPosition(),r=new Ii(0,.5),a=vi(this._progress),s=this._totalLength*a,o=i,l=0,u=0;switch(this._mode){case AD.HORIZONTAL:this._reverse&&(r=new Ii(1,.5)),o=new jn(s,i.height),l=this._totalLength,u=i.height;break;case AD.VERTICAL:r=this._reverse?new Ii(.5,1):new Ii(.5,0),o=new jn(i.width,s),l=i.width,u=this._totalLength}if(this._mode===AD.FILLED)this._barSprite.type!==WL.Type.FILLED?A("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==WL.Type.FILLED){var c=r.x-t.x,h=r.y-t.y,f=new Ni(l*c,u*h,0);e.setPosition(n.x+f.x,n.y+f.y,n.z),e.setAnchorPoint(r),e.setContentSize(o)}else A("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var i=t.getContentSize();this._mode===AD.HORIZONTAL?this.totalLength=i.width:this._mode===AD.VERTICAL?this.totalLength=i.height:this._mode===AD.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===AD.FILLED&&(e=vi(e)),this._totalLength=e,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),a}(),wD.Mode=AD,m((yD=ED).prototype,"barSprite",[_D],Object.getOwnPropertyDescriptor(yD.prototype,"barSprite"),yD.prototype),m(yD.prototype,"mode",[pD],Object.getOwnPropertyDescriptor(yD.prototype,"mode"),yD.prototype),m(yD.prototype,"totalLength",[_o],Object.getOwnPropertyDescriptor(yD.prototype,"totalLength"),yD.prototype),m(yD.prototype,"progress",[vD],Object.getOwnPropertyDescriptor(yD.prototype,"progress"),yD.prototype),m(yD.prototype,"reverse",[_o],Object.getOwnPropertyDescriptor(yD.prototype,"reverse"),yD.prototype),gD=m(yD.prototype,"_barSprite",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bD=m(yD.prototype,"_mode",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AD.HORIZONTAL}}),xD=m(yD.prototype,"_totalLength",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),SD=m(yD.prototype,"_progress",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),TD=m(yD.prototype,"_reverse",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mD=yD))||mD)||mD)||mD));cc.ProgressBarComponent=BD;var LD,PD,FD,zD,DD,ND,UD,VD,GD,HD,WD,qD,jD,XD,YD,KD,QD,ZD,JD,$D=m4("LabelOutlineComponent",fo("cc.LabelOutlineComponent")(RD=bo(110)(RD=go("UI/Render/LabelOutline")((MD=m((OD=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_color",MD,c(t)),v(t,"_width",ID,c(t)),t}return _(a,Tm),l(a,[{key:"_updateRenderData",value:function(){var e=this.node.getComponent(jP);e&&e.updateRenderData(!0)}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),a}()).prototype,"_color",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ar(255,255,255,255)}}),ID=m(OD.prototype,"_width",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),m(OD.prototype,"color",[_o],Object.getOwnPropertyDescriptor(OD.prototype,"color"),OD.prototype),m(OD.prototype,"width",[_o],Object.getOwnPropertyDescriptor(OD.prototype,"width"),OD.prototype),RD=OD))||RD)||RD)||RD);cc.LabelOutlineComponent=$D;var eN=new eo,tN="RICHTEXT_CHILD",iN="RICHTEXT_Image_CHILD";var nN=new Je(function(e){return!!cc.isValid(e.node)&&!e.node.getComponent($D)},20);nN.get=function(e,t){var i=this._get(),n=(i=i||{node:new dg(tN),comp:null,lineCount:0,styleIndex:0,clickHandler:""}).node,r=(n=n||new dg(tN)).getComponent(jP);return r=r=r||n.addComponent(jP),n.setPosition(0,0,0),n.setAnchorPoint(.5,.5),n.setContentSize(128,128),"string"!=typeof e&&(e=""+e),t.font instanceof TT?r.font=t.font:r.fontFamily="Arial",r.string=e,r.horizontalAlign=OP.LEFT,r.verticalAlign=IP.TOP,r.fontSize=t.fontSize||40,r.overflow=0,r.enableWrapText=!0,r.lineHeight=40,r.isBold=!1,r.isItalic=!1,r.isUnderline=!1,{node:n,comp:r,lineCount:0,clickHandler:"",styleIndex:0}};var rN,aN,sN,oN,lN,uN,cN,hN,fN,dN,_N,pN,vN,mN,yN=m4("RichTextComponent",(LD=fo("cc.RichTextComponent"),PD=bo(110),FD=go("UI/Render/RichText"),zD=_o({multiline:!0}),DD=_o({type:OP}),ND=_o({type:IT}),UD=_o({type:fS}),LD(VD=PD(VD=FD(VD=mo((JD=ZD=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"_lineHeight",HD,c(e)),v(e,"_string",WD,c(e)),v(e,"_horizontalAlign",qD,c(e)),v(e,"_fontSize",jD,c(e)),v(e,"_maxWidth",XD,c(e)),v(e,"_font",YD,c(e)),v(e,"_imageAtlas",KD,c(e)),v(e,"_handleTouchEvent",QD,c(e)),e._textArray=[],e._labelSegments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._updateRichTextStatus=e._updateRichText,e}return _(t,qA),l(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font&&this._onTTFLoaded(),this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),l(t,[{key:"onEnable",value:function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}},{key:"onDisable",value:function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}},{key:"start",value:function(){this._onTTFLoaded()}},{key:"onRestore",value:function(){}},{key:"onDestroy",value:function(){var e=this._labelSegments,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.node.removeFromParent(),nN.put(r)}}},{key:"_addEventListeners",value:function(){this.node.on(cy.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_removeEventListeners",value:function(){this.node.off(cy.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateLabelSegmentTextAttributes",value:function(){var t=this;this._labelSegments.forEach(function(e){t._applyTextAttribute(e)})}},{key:"_createFontLabel",value:function(e){return nN.get(e,this)}},{key:"_onTTFLoaded",value:function(){if(this._font instanceof IT)if(this._font._nativeAsset)this._layoutDirty=!0,this._updateRichText();else{var i=this;gw.load(this._font.nativeUrl,function(e,t){i._layoutDirty=!0,i._updateRichText()})}else this._layoutDirty=!0,this._updateRichText()}},{key:"_measureText",value:function(i,e){function t(e){var t;return 0===n._labelSegmentsCache.length?(t=n._createFontLabel(e),n._labelSegmentsCache.push(t)):(t=n._labelSegmentsCache[0]).node.getComponent(jP).string=e,t.styleIndex=i,n._applyTextAttribute(t),t.node.getContentSize().width}var n=this;return e?t(e):t}},{key:"_onTouchEnded",value:function(n){var t=this,r=this.node.getComponents(qA),a=this,e=function(){if(o){if(l>=s.length)return"break";u=s[l++]}else{if((l=s.next()).done)return"break";u=l.value}var e=u,i=e.clickHandler;i&&t._containsTouchLocation(e,n.touch.getUILocation())&&(r.forEach(function(e){var t=e[i];e.enabledInHierarchy&&t&&t.call(a,n)}),n.propagationStopped=!0)},s=this._labelSegments,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if("break"===e())break}}},{key:"_containsTouchLocation",value:function(e,t){var i=e.node.getComponent(qE);return!!i&&i.getBoundingBoxToWorld().contains(t)}},{key:"_resetState",value:function(){for(var n=this,r=this.node.children,e=function(e){var t=r[e];if((t.name===tN||t.name===iN)&&(t.parent===n.node?t.parent=null:r.splice(e,1),t.name===tN)){var i=n._labelSegments.findIndex(function(e){return e.node===t});-1!==i&&nN.put(n._labelSegments[i])}},t=r.length-1;0<=t;t--)e(t);this._labelSegments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}},{key:"_activateChildren",value:function(e){for(var t=this.node.children.length-1;0<=t;t--){var i=this.node.children[t];i.name!==tN&&i.name!==iN||(i.active=e)}}},{key:"_addLabelSegment",value:function(e,t){var i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(e);else{var n=(i=this._labelSegmentsCache.pop()).node.getComponent(jP);n&&(n.string=e)}return i.styleIndex=t,i.lineCount=this._lineCount,i.node.setAnchorPoint(0,0),this._applyTextAttribute(i),this.node.addChild(i.node),this._labelSegments.push(i),i}},{key:"_updateRichTextWithMaxWidth",value:function(e,t,i){var n=t;if(0<this._lineOffsetX&&n+this._lineOffsetX>this.maxWidth)for(var r=0;this._lineOffsetX<=this.maxWidth;){var a=this._getFirstWordLen(e,r,e.length),s=e.substr(r,a),o=this._measureText(i,s);if(!(this._lineOffsetX+o<=this.maxWidth)){if(0<r){var l=e.substr(0,r);this._addLabelSegment(l,i),e=e.substr(r,e.length),n=this._measureText(i,e)}this._updateLineInfo();break}this._lineOffsetX+=o,r+=a}if(n>this.maxWidth)for(var u=Zs(e,n,this.maxWidth,this._measureText(i)),c=0;c<u.length;++c){var h=u[c],f=this._addLabelSegment(h,i).node.getContentSize();this._lineOffsetX+=f.width,1<u.length&&c<u.length-1&&this._updateLineInfo()}else this._lineOffsetX+=n,this._addLabelSegment(e,i)}},{key:"_isLastComponentCR",value:function(e){return e.length-1===e.lastIndexOf("\n")}},{key:"_updateLineInfo",value:function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}},{key:"_needsUpdateTextLayout",value:function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var i=this._textArray[t],n=e[t];if(i.text!==n.text)return!0;if(i.style){if(n.style){if(!!n.style.outline!=!!i.style.outline)return!0;if(i.style.size!==n.style.size||i.style.italic!==n.style.italic||i.style.isImage!==n.style.isImage)return!0;if(i.style.isImage===n.style.isImage&&i.style.src!==n.style.src)return!0}else if(i.style.size||i.style.italic||i.style.isImage||i.style.outline)return!0}else if(n.style&&(n.style.size||n.style.italic||n.style.isImage||n.style.outline))return!0}return!1}},{key:"_addRichTextImageElement",value:function(e){if(e.style){var t=e.style.src,i=this._imageAtlas&&t&&this._imageAtlas.getSpriteFrame(t);if(i){var n=new dg(iN),r=n.addComponent(WL);n.setAnchorPoint(0,0),r.type=WL.Type.SLICED,r.sizeMode=WL.SizeMode.CUSTOM,this.node.addChild(n);var a={node:n,comp:r,lineCount:0,clickHandler:"",styleIndex:0};this._labelSegments.push(a);var s=i.getRect(),o=1,l=s.width,u=s.height,c=e.style.imageWidth,h=e.style.imageHeight;if(void 0!==h&&0<h&&h<this.lineHeight?l*=o=h/u:l*=o=this.lineHeight/u,u*=o,void 0!==c&&0<c&&(l=c),0<this.maxWidth?(this._lineOffsetX+l>this.maxWidth&&this._updateLineInfo(),this._lineOffsetX+=l):(this._lineOffsetX+=l,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.spriteFrame=i,n.setContentSize(l,u),a.lineCount=this._lineCount,e.style.event){e.style.event.click&&(a.clickHandler=e.style.event.click)}}else P(4400)}}},{key:"_updateRichText",value:function(){if(this.enabled){var e=eN.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,i=!1,n=0;n<this._textArray.length;++n){var r=this._textArray[n],a=r.text;if(void 0!==a){if(""===a){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this.imageAtlas){this._addRichTextImageElement(r);continue}}for(var s=a.split("\n"),o=0;o<s.length;++o){var l=s[o];if(""!==l)if(i=!1,0<this.maxWidth){var u=this._measureText(n,l);this._updateRichTextWithMaxWidth(l,u,n),1<s.length&&o<s.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(l,n).node.getContentSize(),this._lineOffsetX+=t.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),1<s.length&&o<s.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(a)&&o===s.length-1)continue;this._updateLineInfo(),i=!0}}}}i||this._linesWidth.push(this._lineOffsetX),0<this.maxWidth&&(this._labelWidth=this.maxWidth),this._labelHeight=this._lineCount*this.lineHeight,this.node.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}}},{key:"_getFirstWordLen",value:function(e,t,i){var n=e.charAt(t);if(Ys(n)||Ks(n))return 1;for(var r=1,a=t+1;a<i&&(!Ks(n=e.charAt(a))&&!Ys(n));++a)r++;return r}},{key:"_updateRichTextPosition",value:function(){var e=0,t=1,i=this._lineCount,n=this._labelSegments,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.lineCount;t<l&&(e=0,t=l);var u=0;switch(this.horizontalAlign){case OP.LEFT:u=-this._labelWidth/2;break;case OP.CENTER:u=-this._linesWidth[l-1]/2;break;case OP.RIGHT:u=this._labelWidth/2-this._linesWidth[l-1]}var c=o.node.getContentSize(),h=o.node.getPosition();o.node.setPosition(e+u,this.lineHeight*(i-l)-this._labelHeight/2,h.z),l===t&&(e+=c.width)}}},{key:"_convertLiteralColorValue",value:function(e){var t=e.toUpperCase();return ar[t]?ar[t]:(new ar).fromHEX(e)}},{key:"_applyTextAttribute",value:function(e){var t=e.node.getComponent(jP);if(t){var i,n=e.styleIndex;t.lineHeight=this.lineHeight,t.horizontalAlign=OP.LEFT,t.verticalAlign=IP.CENTER,this._textArray[n]&&(i=this._textArray[n].style);var r=e.node.getComponent(jP);if(r&&(i&&i.color?r.color=this._convertLiteralColorValue(i.color):r.color=this._convertLiteralColorValue("white")),t.isBold=!(!i||!i.bold),t.isItalic=!(!i||!i.italic),t.isUnderline=!(!i||!i.underline),i&&i.outline){var a=e.node.getComponent($D);(a=a||e.node.addComponent($D)).color=this._convertLiteralColorValue(i.outline.color),a.width=i.outline.width}if(i&&i.size?t.fontSize=i.size:t.fontSize=this._fontSize,t.updateRenderData(!0),i&&i.event){i.event.click&&(e.clickHandler=i.event.click)}}}}]),t}(),ZD.HorizontalAlign=OP,ZD.VerticalAlign=IP,m((GD=JD).prototype,"string",[zD],Object.getOwnPropertyDescriptor(GD.prototype,"string"),GD.prototype),m(GD.prototype,"horizontalAlign",[DD],Object.getOwnPropertyDescriptor(GD.prototype,"horizontalAlign"),GD.prototype),m(GD.prototype,"fontSize",[_o],Object.getOwnPropertyDescriptor(GD.prototype,"fontSize"),GD.prototype),m(GD.prototype,"font",[ND],Object.getOwnPropertyDescriptor(GD.prototype,"font"),GD.prototype),m(GD.prototype,"maxWidth",[_o],Object.getOwnPropertyDescriptor(GD.prototype,"maxWidth"),GD.prototype),m(GD.prototype,"lineHeight",[_o],Object.getOwnPropertyDescriptor(GD.prototype,"lineHeight"),GD.prototype),m(GD.prototype,"imageAtlas",[UD],Object.getOwnPropertyDescriptor(GD.prototype,"imageAtlas"),GD.prototype),m(GD.prototype,"handleTouchEvent",[_o],Object.getOwnPropertyDescriptor(GD.prototype,"handleTouchEvent"),GD.prototype),HD=m(GD.prototype,"_lineHeight",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),WD=m(GD.prototype,"_string",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</c><color=#0fffff>Text</color>"}}),qD=m(GD.prototype,"_horizontalAlign",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OP.LEFT}}),jD=m(GD.prototype,"_fontSize",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),XD=m(GD.prototype,"_maxWidth",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YD=m(GD.prototype,"_font",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),KD=m(GD.prototype,"_imageAtlas",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QD=m(GD.prototype,"_handleTouchEvent",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),VD=GD))||VD)||VD)||VD)||VD));cc.RichTextComponent=yN;var gN,bN,xN=new Ni,SN=new Ni,TN=new Ni,wN=new Ii,EN=new ar;(bN=gN=gN||{})[bN.HORIZONTAL=0]="HORIZONTAL",bN[bN.VERTICAL=1]="VERTICAL",mt(gN);var AN,CN=m4("ScrollBarComponent",(rN=fo("cc.ScrollBarComponent"),aN=bo(110),sN=go("UI/ScrollBar"),oN=_o({type:WL}),lN=_o({type:gN}),rN(uN=aN(uN=sN((mN=vN=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_scrollView",hN,c(t)),v(t,"_handle",fN,c(t)),v(t,"_direction",dN,c(t)),v(t,"_enableAutoHide",_N,c(t)),v(t,"_autoHideTime",pN,c(t)),t._touching=!1,t._opacity=255,t._autoHideRemainingTime=0,t}return _(a,Tm),l(a,[{key:"hide",value:function(){this._autoHideRemainingTime=0,this._setOpacity(0)}},{key:"show",value:function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}},{key:"onScroll",value:function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var i=t.getContentSize(),n=this._scrollView.node.getContentSize(),r=this.node.getContentSize();if(!this._conditionalDisableScrollBar(i,n)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var a=0,s=0,o=0,l=0,u=0;this._direction===gN.HORIZONTAL?(a=i.width,s=n.width,u=r.width,o=e.x,l=-this._convertToScrollViewSpace(t).x):this._direction===gN.VERTICAL&&(a=i.height,s=n.height,u=r.height,o=e.y,l=-this._convertToScrollViewSpace(t).y);var c=this._calculateLength(a,s,u,o),h=this._calculatePosition(a,s,u,l,o,c);this._updateLength(c),this._updateHanlderPosition(h)}}}}},{key:"setScrollView",value:function(e){this._scrollView=e}},{key:"onTouchBegan",value:function(){this._enableAutoHide&&(this._touching=!0)}},{key:"onTouchEnded",value:function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e.getContentSize(),i=this._scrollView.node.getContentSize();if(this._conditionalDisableScrollBar(t,i))return}}this._autoHideRemainingTime=this._autoHideTime}}},{key:"onEnable",value:function(){var e=this.node.getComponent(WL);e&&(this._opacity=e.color.a)}},{key:"start",value:function(){this._enableAutoHide&&this._setOpacity(0)}},{key:"update",value:function(e){this._processAutoHide(e)}},{key:"_convertToScrollViewSpace",value:function(e){if(!this._scrollView)return xN;var t=e.getAnchorPoint(),i=e.getContentSize(),n=new Ni(-t.x*i.width,-t.y*i.height,0);return e.uiTransfromComp.convertToWorldSpaceAR(n,n),t=this._scrollView.node.getAnchorPoint(),i=this._scrollView.node.getContentSize(),n.x+=t.x*i.width,n.y+=t.y*i.height,this._scrollView.node.uiTransfromComp.convertToNodeSpaceAR(n,n),n}},{key:"_setOpacity",value:function(e){if(this._handle){var t=this.node.getComponent(WL);t&&(EN.set(t.color),EN.a=e,t.color=EN),(t=this._handle.getComponent(WL))&&(EN.set(t.color),EN.a=e,t.color=EN)}}},{key:"_updateHanlderPosition",value:function(e){if(this._handle){var t=this._fixupHandlerPosition();this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}}},{key:"_fixupHandlerPosition",value:function(){var e=this.node.getContentSize(),t=this.node.getAnchorPoint(),i=this.handle.node.getContentSize(),n=this.handle.node.parent;Ni.set(SN,-e.width*t.x,-e.height*t.y,0);var r=this.node.uiTransfromComp.convertToWorldSpaceAR(SN,TN),a=new Ni;return n.uiTransfromComp.convertToNodeSpaceAR(r,a),this.direction===gN.HORIZONTAL?a=new Ni(a.x,a.y+(e.height-i.height)/2,0):this.direction===gN.VERTICAL&&(a=new Ni(a.x+(e.width-i.width)/2,a.y,0)),this.handle.node.setPosition(a),a}},{key:"_conditionalDisableScrollBar",value:function(e,t){return e.width<=t.width&&this._direction===gN.HORIZONTAL||e.height<=t.height&&this._direction===gN.VERTICAL}},{key:"_calculateLength",value:function(e,t,i,n){var r=e;return n&&(r+=20*(0<n?n:-n)),i*(t/r)}},{key:"_calculatePosition",value:function(e,t,i,n,r,a){var s=e-t;r&&(s+=Math.abs(r));var o=0;s&&(o=vi(o=n/s));var l=(i-a)*o;return this._direction===gN.VERTICAL?new Ni(0,l,0):new Ni(l,0,0)}},{key:"_updateLength",value:function(e){if(this._handle){var t=this._handle.node,i=t.getContentSize(),n=t.getAnchorPoint();n.x===wN.x&&n.y===wN.y||t.setAnchorPoint(wN),this._direction===gN.HORIZONTAL?t.setContentSize(e,i.height):t.setContentSize(i.width,e)}}},{key:"_processAutoHide",value:function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(new Ni(0,0,0)))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(new Ni))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),a}(),vN.Direction=gN,m((cN=mN).prototype,"handle",[oN],Object.getOwnPropertyDescriptor(cN.prototype,"handle"),cN.prototype),m(cN.prototype,"direction",[lN],Object.getOwnPropertyDescriptor(cN.prototype,"direction"),cN.prototype),m(cN.prototype,"enableAutoHide",[_o],Object.getOwnPropertyDescriptor(cN.prototype,"enableAutoHide"),cN.prototype),m(cN.prototype,"autoHideTime",[_o],Object.getOwnPropertyDescriptor(cN.prototype,"autoHideTime"),cN.prototype),hN=m(cN.prototype,"_scrollView",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fN=m(cN.prototype,"_handle",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dN=m(cN.prototype,"_direction",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gN.HORIZONTAL}}),_N=m(cN.prototype,"_enableAutoHide",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),pN=m(cN.prototype,"_autoHideTime",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),uN=cN))||uN)||uN)||uN));cc.ScrollBarComponent=CN;var kN,RN,ON,MN,IN,BN,LN,PN,FN,zN,DN,NN,UN,VN,GN,HN,WN,qN,jN,XN,YN,KN,QN,ZN,JN=m4("ViewGroupComponent",fo("cc.ViewGroupComponent")(AN=bo(110)(AN=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return _(e,Tm),e}())||AN)||AN);cc.ViewGroupComponent=JN;function $N(){return(new Date).getMilliseconds()}var eU,tU,iU=Gp,nU=1e-4,rU=new Ni,aU=new Ni;(tU=eU=eU||{})[tU.SCROLL_TO_TOP=0]="SCROLL_TO_TOP",tU[tU.SCROLL_TO_BOTTOM=1]="SCROLL_TO_BOTTOM",tU[tU.SCROLL_TO_LEFT=2]="SCROLL_TO_LEFT",tU[tU.SCROLL_TO_RIGHT=3]="SCROLL_TO_RIGHT",tU[tU.SCROLLING=4]="SCROLLING",tU[tU.BOUNCE_TOP=5]="BOUNCE_TOP",tU[tU.BOUNCE_BOTTOM=6]="BOUNCE_BOTTOM",tU[tU.BOUNCE_LEFT=7]="BOUNCE_LEFT",tU[tU.BOUNCE_RIGHT=8]="BOUNCE_RIGHT",tU[tU.SCROLL_ENDED=9]="SCROLL_ENDED",tU[tU.TOUCH_UP=10]="TOUCH_UP",tU[tU.AUTOSCROLL_ENDED_WITH_THRESHOLD=11]="AUTOSCROLL_ENDED_WITH_THRESHOLD",tU[tU.SCROLL_BEGAN=12]="SCROLL_BEGAN",mt(eU);var sU,oU,lU,uU,cU,hU,fU,dU,_U,pU,vU,mU,yU,gU,bU,xU={"scroll-to-top":eU.SCROLL_TO_TOP,"scroll-to-bottom":eU.SCROLL_TO_BOTTOM,"scroll-to-left":eU.SCROLL_TO_LEFT,"scroll-to-right":eU.SCROLL_TO_RIGHT,scrolling:eU.SCROLLING,"bounce-bottom":eU.BOUNCE_BOTTOM,"bounce-left":eU.BOUNCE_LEFT,"bounce-right":eU.BOUNCE_RIGHT,"bounce-top":eU.BOUNCE_TOP,"scroll-ended":eU.SCROLL_ENDED,"touch-up":eU.TOUCH_UP,"scroll-ended-with-threshold":eU.AUTOSCROLL_ENDED_WITH_THRESHOLD,"scroll-began":eU.SCROLL_BEGAN},SU=m4("ScrollViewComponent",(kN=fo("cc.ScrollViewComponent"),RN=bo(110),ON=go("UI/ScrollView"),MN=_o({type:cy}),IN=_o({type:CN}),BN=_o({type:CN}),LN=_o({range:[0,1,.1]}),PN=_o({range:[0,10]}),FN=_o({type:[Zw]}),kN(zN=RN(zN=ON((ZN=QN=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"horizontal",NN,c(t)),v(t,"vertical",UN,c(t)),v(t,"inertia",VN,c(t)),v(t,"brake",GN,c(t)),v(t,"elastic",HN,c(t)),v(t,"bounceDuration",WN,c(t)),v(t,"scrollEvents",qN,c(t)),v(t,"cancelInnerEvents",jN,c(t)),t._autoScrolling=!1,t._scrolling=!1,v(t,"_content",XN,c(t)),v(t,"_horizontalScrollBar",YN,c(t)),v(t,"_verticalScrollBar",KN,c(t)),t._topBoundary=0,t._bottomBoundary=0,t._leftBoundary=0,t._rightBoundary=0,t._touchMoveDisplacements=[],t._touchMoveTimeDeltas=[],t._touchMovePreviousTimestamp=0,t._touchMoved=!1,t._autoScrollAttenuate=!1,t._autoScrollStartPosition=new Ni,t._autoScrollTargetDelta=new Ni,t._autoScrollTotalTime=0,t._autoScrollAccumulatedTime=0,t._autoScrollCurrentlyOutOfBoundary=!1,t._autoScrollBraking=!1,t._autoScrollBrakingStartPosition=new Ni,t._outOfBoundaryAmount=new Ni,t._outOfBoundaryAmountDirty=!0,t._stopMouseWheel=!1,t._mouseWheelEventElapsedTime=0,t._isScrollEndedWithThresholdEventFired=!1,t._scrollEventEmitMask=0,t._isBouncing=!1,t._contentPos=new Ni,t._deltaPos=new Ni,t}return _(a,JN),l(a,[{key:"scrollToBottom",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Ii(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i,!0)}},{key:"scrollToTop",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Ii(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Ii(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Ii(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Ii(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Ii(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Ii(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Ii(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToOffset",value:function(e,t,i){var n=this.getMaxScrollOffset(),r=new Ii(0,0);0===n.x?r.x=0:r.x=e.x/n.x,0===n.y?r.y=1:r.y=(n.y-e.y)/n.y,this.scrollTo(r,t,i)}},{key:"getScrollOffset",value:function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new Ni(t,e,0)}},{key:"getMaxScrollOffset",value:function(){var e=this.node.getContentSize(),t=this._content.getContentSize(),i=t.width-e.width,n=t.height-e.height;return new Ni(i=0<=i?i:0,n=0<=n?n:0,0)}},{key:"scrollToPercentHorizontal",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Ii(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==i):this._moveContent(n)}},{key:"scrollTo",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Ii(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"scrollToPercentVertical",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Ii(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"stopAutoScroll",value:function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}},{key:"setContentPosition",value:function(e){e.equals(this.getContentPosition(),nU)||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},{key:"getContentPosition",value:function(){return this._content?(this._content.getPosition(this._contentPos),this._contentPos):rU}},{key:"isScrolling",value:function(){return this._scrolling}},{key:"isAutoScrolling",value:function(){return this._autoScrolling}},{key:"getScrollEndedEventTiming",value:function(){return nU}},{key:"start",value:function(){this._calculateBoundary(),this._content&&kx.once(Cx.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}},{key:"onEnable",value:function(){this._registerEvent(),this.content&&(this.content.on(iU.SIZE_CHANGED,this._calculateBoundary,this),this.content.on(iU.SCALE_PART,this._calculateBoundary,this),this.view&&(this.view.on(iU.POSITION_PART,this._calculateBoundary,this),this.view.on(iU.SCALE_PART,this._calculateBoundary,this),this.view.on(iU.SIZE_CHANGED,this._calculateBoundary,this))),this._showScrollbar()}},{key:"update",value:function(e){this._autoScrolling&&this._processAutoScrolling(e)}},{key:"onDisable",value:function(){this._unregisterEvent(),this.content&&(this.content.off(iU.SIZE_CHANGED,this._calculateBoundary,this),this.content.off(iU.SCALE_PART,this._calculateBoundary,this),this.view&&(this.view.off(iU.POSITION_PART,this._calculateBoundary,this),this.view.off(iU.SCALE_PART,this._calculateBoundary,this),this.view.off(iU.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollbar(),this.stopAutoScroll()}},{key:"_registerEvent",value:function(){this.node.on(iU.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(iU.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(iU.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(iU.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(iU.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_unregisterEvent",value:function(){this.node.off(iU.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(iU.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(iU.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(iU.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(iU.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_onMouseWheel",value:function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var i=new Ni;this.vertical?i=new Ni(0,-.1*e.getScrollY(),0):this.horizontal&&(i=new Ni(-.1*e.getScrollY(),0,0)),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(i),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchBegan",value:function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._content&&this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))}},{key:"_onTouchMoved",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)&&e&&e.touch){var i=e.touch;if(this._content&&this._handleMoveLogic(i),this.cancelInnerEvents){var n=new Ii(i.getUILocation());if(n.subtract(i.getUIStartLocation()),7<n.length()&&!this._touchMoved&&e.target!==this.node){var r=new Ep(e.getTouches(),e.bubbles);r.type=iU.TOUCH_CANCEL,r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}}},{key:"_onTouchEnded",value:function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent("touch-up");var i=e.touch;this._content&&this._handleReleaseLogic(i),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchCancelled",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var i=e.touch;this._content&&this._handleReleaseLogic(i)}this._stopPropagationIfTargetIsMe(e)}}},{key:"_calculateBoundary",value:function(){if(this.content){var e=this.content.getComponent(Wz);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view.getContentSize(),i=t.width*this.view.anchorX,n=t.height*this.view.anchorY;this._leftBoundary=-i,this._bottomBoundary=-n,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t)}}},{key:"_hasNestedViewGroup",value:function(e,t){if(e&&e.eventPhase===tl.CAPTURING_PHASE){if(t){var i=t,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(this.node===s)return!(!e.target||!e.target.getComponent(JN));if(s.getComponent(JN))return!0}}return!1}}},{key:"_handleReleaseLogic",value:function(e){var t=e.getUIDelta();Ni.set(this._deltaPos,t.x,t.y,0),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent("scroll-ended"))}},{key:"_startInertiaScroll",value:function(e){var t=new Ni(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)}},{key:"_calculateAttenuatedFactor",value:function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))}},{key:"_startAttenuatingAutoScroll",value:function(e,t){var i=this._calculateAutoScrollTimeByInitalSpeed(t.length()),n=new Ni(e);n.normalize();var r=this._content.getContentSize(),a=this.node.getContentSize(),s=r.width-a.width,o=r.height-a.height,l=this._calculateAttenuatedFactor(s),u=this._calculateAttenuatedFactor(o);n.x=n.x*s*(1-this.brake)*l,n.y=n.y*o*u*(1-this.brake),n.z=0;var c=e.length(),h=n.length()/c;if(n.add(e),0<this.brake&&7<h){h=Math.sqrt(h);var f=new Ni(e);f.multiplyScalar(h),n.set(f),n.add(e)}0<this.brake&&3<h&&(i*=h=3),0===this.brake&&1<h&&(i*=h),this._startAutoScroll(n,i,!0)}},{key:"_calculateAutoScrollTimeByInitalSpeed",value:function(e){return Math.sqrt(Math.sqrt(e/5))}},{key:"_startAutoScroll",value:function(e,t,i){var n=2<arguments.length&&void 0!==i&&i,r=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=r,this._autoScrollAttenuate=n,Ni.copy(this._autoScrollStartPosition,this.getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition=new Ni,this._getHowMuchOutOfBoundary().equals(rU,nU)||(this._autoScrollCurrentlyOutOfBoundary=!0)}},{key:"_calculateTouchMoveVelocity",value:function(){var e=0;if((e=this._touchMoveTimeDeltas.reduce(function(e,t){return e+t},e))<=0||.5<=e)return new Ni;var t=new Ni;return t=this._touchMoveDisplacements.reduce(function(e,t){return e.add(t),e},t),new Ni(t.x*(1-this.brake)/e,t.y*(1-this.brake)/e,0)}},{key:"_flattenVectorByDirection",value:function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t}},{key:"_moveContent",value:function(e,t){var i=this._flattenVectorByDirection(e);aU.set(this.getContentPosition()),aU.add(i),this.setContentPosition(aU);var n=this._getHowMuchOutOfBoundary();this._updateScrollBar(n),this.elastic&&t&&this._startBounceBackIfNeeded()}},{key:"_getContentLeftBoundary",value:function(){return this.getContentPosition().x-this._content.getAnchorPoint().x*this._content.getContentSize().width}},{key:"_getContentRightBoundary",value:function(){var e=this._content.getContentSize();return this._getContentLeftBoundary()+e.width}},{key:"_getContentTopBoundary",value:function(){var e=this._content.getContentSize();return this._getContentBottomBoundary()+e.height}},{key:"_getContentBottomBoundary",value:function(){return this.getContentPosition().y-this._content.getAnchorPoint().y*this._content.getContentSize().height}},{key:"_getHowMuchOutOfBoundary",value:function(e){if((e=e||new Ni).equals(rU,nU)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new Ni;return this._getContentLeftBoundary()+e.x>this._leftBoundary?t.x=this._leftBoundary-(this._getContentLeftBoundary()+e.x):this._getContentRightBoundary()+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(this._getContentRightBoundary()+e.x)),this._getContentTopBoundary()+e.y<this._topBoundary?t.y=this._topBoundary-(this._getContentTopBoundary()+e.y):this._getContentBottomBoundary()+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(this._getContentBottomBoundary()+e.y)),e.equals(rU,nU)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),t=this._clampDelta(t)}},{key:"_updateScrollBar",value:function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)}},{key:"_onScrollBarTouchBegan",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}},{key:"_onScrollBarTouchEnded",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}},{key:"_dispatchEvent",value:function(e){if("scroll-ended"===e)this._scrollEventEmitMask=0;else if("scroll-to-top"===e||"scroll-to-bottom"===e||"scroll-to-left"===e||"scroll-to-right"===e){var t=1<<xU[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}Zw.emitEvents(this.scrollEvents,this,xU[e]),this.node.emit(e,this)}},{key:"_adjustContentOutOfBoundary",value:function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary(new Ni),t=new Ni(this.getContentPosition());t.add(e),this._content&&(this._content.setPosition(t),this._updateScrollBar(rU))}}},{key:"_hideScrollbar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this.verticalScrollBar&&this.verticalScrollBar.hide()}},{key:"_showScrollbar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.show(),this.verticalScrollBar&&this.verticalScrollBar.show()}},{key:"_stopPropagationIfTargetIsMe",value:function(e){e&&e.eventPhase===tl.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)}},{key:"_processDeltaMove",value:function(e){this._scrollChildren(e),this._gatherTouchMove(e)}},{key:"_handleMoveLogic",value:function(e){var t=e.getUIDelta();Ni.set(this._deltaPos,t.x,t.y,0),this._processDeltaMove(this._deltaPos)}},{key:"_scrollChildren",value:function(e){var t,i=e=this._clampDelta(e);this.elastic&&(t=this._getHowMuchOutOfBoundary(),i.x*=0===t.x?1:.5,i.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(i),i.add(t));var n="",r=new Ni;if(this._content.getPosition(r),0<i.y)r.y-this._content.anchorY*this._content.height+i.y>this._bottomBoundary&&(n="scroll-to-bottom");else if(i.y<0){r.y-this._content.anchorY*this._content.height+this._content.height+i.y<=this._topBoundary&&(n="scroll-to-top")}else if(i.x<0){r.x-this._content.anchorX*this._content.width+this._content.width+i.x<=this._rightBoundary&&(n="scroll-to-right")}else if(0<i.x){r.x-this._content.anchorX*this._content.width+i.x>=this._leftBoundary&&(n="scroll-to-left")}this._moveContent(i,!1),0===i.x&&0===i.y||(this._scrolling||(this._scrolling=!0,this._dispatchEvent("scroll-began")),this._dispatchEvent("scrolling")),0<n.length&&this._dispatchEvent(n)}},{key:"_handlePressLogic",value:function(){this._autoScrolling&&this._dispatchEvent("scroll-ended"),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=$N(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}},{key:"_clampDelta",value:function(e){var t=this._content.getContentSize(),i=this.node.getContentSize();return t.width<i.width&&(e.x=0),t.height<i.height&&(e.y=0),e}},{key:"_gatherTouchMove",value:function(e){for(e=this._clampDelta(e);5<=this._touchMoveDisplacements.length;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(e);var t=$N();this._touchMoveTimeDeltas.push((t-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=t}},{key:"_startBounceBackIfNeeded",value:function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if((e=this._clampDelta(e)).equals(rU,nU))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(0<e.y&&this._dispatchEvent("bounce-top"),e.y<0&&this._dispatchEvent("bounce-bottom"),0<e.x&&this._dispatchEvent("bounce-right"),e.x<0&&this._dispatchEvent("bounce-left"),this._isBouncing=!0),!0}},{key:"_processInertiaScroll",value:function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(aU,nU)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()}},{key:"_isOutOfBoundary",value:function(){return!this._getHowMuchOutOfBoundary().equals(rU,nU)}},{key:"_isNecessaryAutoScrollBrake",value:function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this.getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}},{key:"_processAutoScrolling",value:function(e){var t=this._isNecessaryAutoScrollBrake(),i=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/i);var n=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(n=function(e){return(e-=1)*e*e*e*e+1}(n));var r=new Ni(this._autoScrollTargetDelta);r.multiplyScalar(n);var a=new Ni(this._autoScrollStartPosition);a.add(r);var s=Math.abs(n-1)<=nU;if(Math.abs(n-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent("scroll-ended-with-threshold"),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var o=new Ni(a);o.subtract(this._autoScrollBrakingStartPosition),t&&o.multiplyScalar(i),a.set(this._autoScrollBrakingStartPosition),a.add(o)}else{var l=new Ni(a);l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(rU,nU)||(a.add(u),s=!0)}s&&(this._autoScrolling=!1);var c=new Ni(a);c.subtract(this.getContentPosition()),this._moveContent(this._clampDelta(c),s),this._dispatchEvent("scrolling"),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent("scroll-ended"))}},{key:"_checkMouseWheel",value:function(e){if(!this._getHowMuchOutOfBoundary().equals(rU,nU))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,.1<this._mouseWheelEventElapsedTime&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._stopMouseWheel=!1)}},{key:"_calculateMovePercentDelta",value:function(e){var t=e.anchor,i=e.applyToHorizontal,n=e.applyToVertical;this._calculateBoundary(),t.clampf(new Ii(0,0),new Ii(1,1));var r=this.node.getContentSize(),a=this._content.getContentSize(),s=this._getContentBottomBoundary()-this._bottomBoundary;s=-s;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var l=new Ni,u=0;return i&&(u=a.width-r.width,l.x=o-u*t.x),n&&(u=a.height-r.height,l.y=s-u*t.y),l}},{key:"_moveContentToTopLeft",value:function(e){var t=this._content.getContentSize(),i=this._getContentBottomBoundary()-this._bottomBoundary;i=-i;var n=new Ni,r=0,a=this._getContentLeftBoundary()-this._leftBoundary;a=-a,t.height<e.height?(r=t.height-e.height,n.y=i-r,this.verticalScrollBar&&this.verticalScrollBar.hide()):this.verticalScrollBar&&this.verticalScrollBar.show(),t.width<e.width?(r=t.width-e.width,n.x=a,this._horizontalScrollBar&&this._horizontalScrollBar.hide()):this._horizontalScrollBar&&this._horizontalScrollBar.show(),this._moveContent(n),this._adjustContentOutOfBoundary()}},{key:"content",get:function(){return this._content},set:function(e){this._content!==e&&(this._content=e,this._calculateBoundary())}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(rU)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(rU)))}},{key:"view",get:function(){return this._content?this._content.parent:null}}]),a}(),QN.EventType=eU,m((DN=ZN).prototype,"content",[MN],Object.getOwnPropertyDescriptor(DN.prototype,"content"),DN.prototype),m(DN.prototype,"horizontalScrollBar",[IN],Object.getOwnPropertyDescriptor(DN.prototype,"horizontalScrollBar"),DN.prototype),m(DN.prototype,"verticalScrollBar",[BN],Object.getOwnPropertyDescriptor(DN.prototype,"verticalScrollBar"),DN.prototype),NN=m(DN.prototype,"horizontal",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),UN=m(DN.prototype,"vertical",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),VN=m(DN.prototype,"inertia",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),GN=m(DN.prototype,"brake",[LN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),HN=m(DN.prototype,"elastic",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),WN=m(DN.prototype,"bounceDuration",[PN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qN=m(DN.prototype,"scrollEvents",[FN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jN=m(DN.prototype,"cancelInnerEvents",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),XN=m(DN.prototype,"_content",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YN=m(DN.prototype,"_horizontalScrollBar",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),KN=m(DN.prototype,"_verticalScrollBar",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zN=DN))||zN)||zN)||zN));cc.ScrollViewComponent=SU;var TU,wU,EU=new Ni;(wU=TU=TU||{})[wU.Horizontal=0]="Horizontal",wU[wU.Vertical=1]="Vertical",mt(TU);var AU,CU,kU,RU,OU,MU,IU,BU,LU=m4("SliderComponent",(sU=fo("cc.SliderComponent"),oU=bo(110),lU=go("UI/Slider"),uU=_o({type:WL}),cU=_o({type:TU}),hU=_o({slide:!0,range:[0,1,.01]}),fU=_o({type:Zw}),sU(dU=oU(dU=lU((bU=gU=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"slideEvents",pU,c(t)),v(t,"_handle",vU,c(t)),v(t,"_direction",mU,c(t)),v(t,"_progress",yU,c(t)),t._offset=new Ni,t._dragging=!1,t._touchHandle=!1,t._handlelocalPos=new Ni,t._touchPos=new Ni,t}return _(a,Tm),l(a,[{key:"__preload",value:function(){this._updateHandlePosition()}},{key:"onEnable",value:function(){this._updateHandlePosition(),this.node.on(Gp.TOUCH_START,this._onTouchBegan,this),this.node.on(Gp.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(Gp.TOUCH_END,this._onTouchEnded,this),this.node.on(Gp.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(Gp.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(Gp.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(Gp.TOUCH_END,this._onTouchEnded,this))}},{key:"onDisable",value:function(){this.node.off(Gp.TOUCH_START,this._onTouchBegan,this),this.node.off(Gp.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(Gp.TOUCH_END,this._onTouchEnded,this),this.node.off(Gp.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(Gp.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(Gp.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(Gp.TOUCH_END,this._onTouchEnded,this))}},{key:"_onHandleDragStart",value:function(e){if(e&&this._handle&&this._handle.node.uiTransfromComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();Ni.set(this._touchPos,t.x,t.y,0),this._handle.node.uiTransfromComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}}},{key:"_onTouchBegan",value:function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchMoved",value:function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchEnded",value:function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new Ni,e&&(e.propagationStopped=!0)}},{key:"_onTouchCancelled",value:function(e){this._dragging=!1,e&&(e.propagationStopped=!0)}},{key:"_handleSliderLogic",value:function(e){this._updateProgress(e),this._emitSlideEvent()}},{key:"_emitSlideEvent",value:function(){Zw.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}},{key:"_updateProgress",value:function(e){if(this._handle&&e){var t=e.getUILocation();Ni.set(this._touchPos,t.x,t.y,0);var i=this.node.uiTransfromComp.convertToNodeSpaceAR(this._touchPos,EU);this.direction===TU.Horizontal?this.progress=vi(.5+(i.x-this._offset.x)/this.node.width):this.progress=vi(.5+(i.y-this._offset.y)/this.node.height)}}},{key:"_updateHandlePosition",value:function(){this._handle&&(this._handlelocalPos.set(this._handle.node.getPosition()),this._direction===TU.Horizontal?this._handlelocalPos.x=-this.node.width*this.node.anchorX+this.progress*this.node.width:this._handlelocalPos.y=-this.node.height*this.node.anchorY+this.progress*this.node.height,this._handle.node.setPosition(this._handlelocalPos))}},{key:"_changeLayout",value:function(){var e=this.node.getContentSize();if(this.node.setContentSize(e.height,e.width),this._handle){var t=this._handle.node.position;this._direction===TU.Horizontal?this._handle.node.setPosition(t.x,0,t.z):this._handle.node.setPosition(0,t.y,t.z),this._updateHandlePosition()}}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),a}(),gU.Direction=TU,m((_U=bU).prototype,"handle",[uU],Object.getOwnPropertyDescriptor(_U.prototype,"handle"),_U.prototype),m(_U.prototype,"direction",[cU],Object.getOwnPropertyDescriptor(_U.prototype,"direction"),_U.prototype),m(_U.prototype,"progress",[hU],Object.getOwnPropertyDescriptor(_U.prototype,"progress"),_U.prototype),pU=m(_U.prototype,"slideEvents",[fU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vU=m(_U.prototype,"_handle",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mU=m(_U.prototype,"_direction",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TU.Horizontal}}),yU=m(_U.prototype,"_progress",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),dU=_U))||dU)||dU)||dU));cc.SliderComponent=LU;var PU,FU,zU,DU,NU,UU,VU,GU,HU,WU,qU,jU,XU=m4("ToggleContainerComponent",(AU=fo("cc.ToggleContainerComponent"),CU=bo(110),kU=go("UI/ToggleContainer"),RU=_o({type:[Zw]}),AU(OU=CU(OU=kU(OU=mo((IU=m((MU=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"checkEvents",IU,c(t)),v(t,"_allowSwitchOff",BU,c(t)),t._toggleItems=[],t}return _(a,Tm),l(a,[{key:"start",value:function(){this._makeAtLeastOneToggleChecked()}},{key:"updateToggles",value:function(t){this.enabledInHierarchy&&t.isChecked&&(this.toggleItems.forEach(function(e){e!==t&&e.isChecked&&e.enabled&&(e.isChecked=!1)}),this.checkEvents&&Zw.emitEvents(this.checkEvents,t))}},{key:"addToggle",value:function(e){-1===this._toggleItems.indexOf(e)&&this._toggleItems.push(e),this._allowOnlyOneToggleChecked()}},{key:"removeToggle",value:function(e){var t=this._toggleItems.indexOf(e);-1<t&&this._toggleItems.splice(t,1),this._makeAtLeastOneToggleChecked()}},{key:"_allowOnlyOneToggleChecked",value:function(){var t=!1;return this._toggleItems.forEach(function(e){t&&e.enabled&&(e.isChecked=!1),e.isChecked&&e.enabled&&(t=!0)}),t}},{key:"_makeAtLeastOneToggleChecked",value:function(){this._allowOnlyOneToggleChecked()||this._allowSwitchOff||0<this._toggleItems.length&&(this._toggleItems[0].isChecked=!0)}},{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this._toggleItems}}]),a}()).prototype,"checkEvents",[RU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),BU=m(MU.prototype,"_allowSwitchOff",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),m(MU.prototype,"allowSwitchOff",[_o],Object.getOwnPropertyDescriptor(MU.prototype,"allowSwitchOff"),MU.prototype),OU=MU))||OU)||OU)||OU)||OU));cc.ToggleContainerComponent=XU;var YU,KU=m4("ToggleComponent",(PU=fo("cc.ToggleComponent"),FU=bo(110),zU=go("UI/Toggle"),DU=_o({type:XU}),NU=_o({type:WL}),UU=_o({type:[Zw]}),PU(VU=FU(VU=zU(VU=mo((m((GU=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"checkEvents",HU,c(t)),v(t,"_isChecked",WU,c(t)),v(t,"_toggleGroup",qU,c(t)),v(t,"_checkMark",jU,c(t)),t}return _(a,qL),l(a,[{key:"onEnable",value:function(){p(g(a.prototype),"onEnable",this).call(this),this._registerToggleEvent(),this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.addToggle(this)}},{key:"onDisable",value:function(){p(g(a.prototype),"onDisable",this).call(this),this._unregisterToggleEvent(),this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.removeToggle(this)}},{key:"toggle",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!this.isChecked,e&&e.enabled&&e.updateToggles(this),this._emitToggleEvents())}},{key:"check",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!0,e&&e.enabled&&e.updateToggles(this),this._emitToggleEvents())}},{key:"uncheck",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!1,this._emitToggleEvents())}},{key:"_updateCheckMark",value:function(){this._checkMark&&(this._checkMark.node.active=!!this.isChecked)}},{key:"_registerToggleEvent",value:function(){this.node.on("click",this.toggle,this)}},{key:"_unregisterToggleEvent",value:function(){this.node.off("click",this.toggle,this)}},{key:"_emitToggleEvents",value:function(){this.node.emit("toggle",this),this.checkEvents&&Zw.emitEvents(this.checkEvents,this)}},{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._isChecked!==e&&(this._isChecked=e,this._updateCheckMark())}},{key:"toggleGroup",get:function(){return this._toggleGroup},set:function(e){this._toggleGroup!==e&&(this._toggleGroup&&this._toggleGroup.removeToggle(this),this._toggleGroup=e,this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.addToggle(this))}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){this.node.parent;return null}}]),a}()).prototype,"isChecked",[_o],Object.getOwnPropertyDescriptor(GU.prototype,"isChecked"),GU.prototype),m(GU.prototype,"toggleGroup",[DU],Object.getOwnPropertyDescriptor(GU.prototype,"toggleGroup"),GU.prototype),m(GU.prototype,"checkMark",[NU],Object.getOwnPropertyDescriptor(GU.prototype,"checkMark"),GU.prototype),HU=m(GU.prototype,"checkEvents",[UU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),WU=m(GU.prototype,"_isChecked",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qU=m(GU.prototype,"_toggleGroup",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jU=m(GU.prototype,"_checkMark",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VU=GU))||VU)||VU)||VU)||VU));cc.ToggleComponent=KU;var QU,ZU,JU,$U=m4("UIModelComponent",fo("cc.UIModelComponent")(YU=bo(110)(YU=go("UI/Model")(YU=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._modelComponent=null,t}return _(a,qA),l(a,[{key:"onLoad",value:function(){this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?(this._modelComponent._sceneGetter=kx.root.ui.getRenderSceneGetter(),this._modelComponent.recreateModel()):console.warn("Use this component on a node".concat(this.node&&this.node.name," that has a model component"))}},{key:"onDestroy",value:function(){this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,cc.isValid(this.node,!0)&&this._modelComponent.recreateModel())}},{key:"updateAssembler",value:function(e){return!!this._modelComponent&&(e.commitModel.call(e,this,this._modelComponent._getModel(),this._modelComponent.material),!0)}},{key:"update",value:function(){this._fitUIRenderQueue()}},{key:"_fitUIRenderQueue",value:function(){if(this._modelComponent){for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var i=this._modelComponent.getMaterial(t);if(null!=i){for(var n=i.passes,r=i.effectAsset,a=i.technique,s=n.length,o=!1,l=0;l<s;l++){if(!n[l].blendState.targets[0].blend)o=!0,n[l].blendState.targets[0].blend=!0,n[l].overridePipelineStates(r.techniques[a].passes[l],{blendState:n[l].blendState})}o&&i._onPassesChange()}}for(var u=0;u<e;u++){var c=this._modelComponent.getMaterial(u);if(null!=c){var h=c.passes,f=Array.isArray(h),d=0;for(h=f?h:h[Symbol.iterator]();;){var _;if(f){if(d>=h.length)break;_=h[d++]}else{if((d=h.next()).done)break;_=d.value}_._priority=xf.MAX-11}}}}}},{key:"modelComponent",get:function(){return this._modelComponent}}]),a}())||YU)||YU)||YU);cc.UIModelComponent=$U;var eV,tV,iV=new Pn;(tV=eV=eV||{})[tV.LOADING=0]="LOADING",tV[tV.LOADED=1]="LOADED",tV[tV.ERROR=2]="ERROR";var nV={devicePixelRatio:!(tV[tV.JS_EVALUATED=3]="JS_EVALUATED"),enableDiv:!1};fl.os===fl.OS_IOS&&(nV.enableDiv=!0),fl.isMobile?fl.browserType===fl.BROWSER_TYPE_FIREFOX&&(nV.enableBG=!0):fl.browserType===fl.BROWSER_TYPE_IE&&(nV.closeHistory=!0);var rV,aV,sV,oV,lV,uV,cV,hV,fV,dV,_V=fo("cc.WebviewImpl")((JU=ZU=function(){function n(){y(this,n),this._EventList=new Map,this._visible=!1,this._div=null,this._iframe=null,this._forceUpdate=!0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._w=0,this._h=0,this._eventListeners={load:function(){},error:function(){}}}return l(n,[{key:"createDomElementIfNeeded",value:function(e,t){this._div?this._updateSize(e,t):this._createNativeControl(e,t)}},{key:"removeDom",value:function(){var e=this._div;e&&(ut(cc.game.container,e)&&cc.game.container.removeChild(e),this._div=null);var t=this._iframe;if(t){var i=this._eventListeners;t.removeEventListener("load",i.load),t.removeEventListener("error",i.error),i.load=null,i.error=null,this._iframe=null}}},{key:"loadURL",value:function(e){var t=this._iframe;if(t){t.src=e;var i=this;t.addEventListener("load",function e(){i._updateVisibility(),t.removeEventListener("load",e)}),this._dispatchEvent(n.EventType.LOADING)}}},{key:"stopLoading",value:function(){B(7800)}},{key:"reload",value:function(){var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.location.reload()}}},{key:"canGoBack",value:function(){return B(7801),!0}},{key:"canGoForward",value:function(){return B(7802),!0}},{key:"goBack",value:function(){try{if(n.Polyfill.closeHistory)return B(7803);var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.history.back.call(t)}}catch(e){E(e)}}},{key:"goForward",value:function(){try{if(n.Polyfill.closeHistory)return B(7804);var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.history.forward.call(t)}}catch(e){E(e)}}},{key:"evaluateJS",value:function(e){var t=this._iframe;if(t)t.contentWindow}},{key:"setScalesPageToFit",value:function(){B(7805)}},{key:"setEventListener",value:function(e,t){this._EventList[e]=t}},{key:"removeEventListener",value:function(e){this._EventList[e]=null}},{key:"_dispatchEvent",value:function(e){var t=this._EventList[e];t&&this._iframe&&t.call(this,this,this._iframe.src)}},{key:"destroy",value:function(){this.removeDom()}},{key:"setVisible",value:function(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}},{key:"updateMatrix",value:function(e){if(this._div&&this._visible){e.getWorldMatrix(iV);var t=e.getContentSize();if(this._forceUpdate||this._m00!==iV.m00||this._m01!==iV.m01||this._m04!==iV.m04||this._m05!==iV.m05||this._m12!==iV.m12||this._m13!==iV.m13||this._w!==t.width||this._h!==t.height){this._m00=iV.m00,this._m01=iV.m01,this._m04=iV.m04,this._m05=iV.m05,this._m12=iV.m12,this._m13=iV.m13,this._w=t.width,this._h=t.height;var i=Tp.getScaleX(),n=Tp.getScaleY(),r=Tp.getDevicePixelRatio();i/=r,n/=r;var a=cc.game.container,s=iV.m00*i,o=iV.m01,l=iV.m04,u=iV.m05*n,c=a&&a.style.paddingLeft?parseInt(a.style.paddingLeft):0,h=a&&a.style.paddingBottom?parseInt(a.style.paddingBottom):0;this._updateSize(this._w,this._h);var f=this._div.clientWidth*i,d=this._div.clientHeight*n,_=e.getAnchorPoint(),p=f*iV.m00*_.x,v=d*iV.m05*_.y,m="matrix("+s+","+-o+","+-l+","+u+","+(iV.m12*i-p+c)+","+-(iV.m13*n-v+h)+")";this._div.style.transform=m,this._div.style["-webkit-transform"]=m,this._div.style["transform-origin"]="0px 100% 0px",this._div.style["-webkit-transform-origin"]="0px 100% 0px";var y=e.getComponent(hC);y&&this._setOpacity(y.color.a)}}}},{key:"setOnJSCallback",value:function(e){}},{key:"setJavascriptInterfaceScheme",value:function(e){}},{key:"loadData",value:function(e,t,i,n){}},{key:"loadHTMLString",value:function(e,t){}},{key:"_updateVisibility",value:function(){if(this._div){var e=this._div;this._visible?e.style.visibility="visible":e.style.visibility="hidden",this._forceUpdate=!0}}},{key:"_updateSize",value:function(e,t){var i=this._div;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"_initEvent",value:function(){var e=this._iframe;if(e){var t=this._eventListeners,i=this;t.load=function(){i._dispatchEvent(n.EventType.LOADED)},t.error=function(){i._dispatchEvent(n.EventType.ERROR)},e.addEventListener("load",t.load),e.addEventListener("error",t.error)}}},{key:"_initStyle",value:function(){if(this._div){var e=this._div;e.style.position="absolute",e.style.bottom="0px",e.style.left="0px"}}},{key:"_setOpacity",value:function(e){var t=this._iframe;t&&t.style&&(t.style.opacity=(e/255).toString())}},{key:"_createDom",value:function(e,t){n.Polyfill.enableDiv?(this._div=document.createElement("div"),this._div.style["-webkit-overflow"]="auto",this._div.style["-webkit-overflow-scrolling"]="touch",this._iframe=document.createElement("iframe"),this._div.appendChild(this._iframe),this._iframe.style.width="100%",this._iframe.style.height="100%"):this._div=this._iframe=document.createElement("iframe"),n.Polyfill.enableBG&&(this._div.style.background="#FFF"),this._div.style.background="#FFF",this._div.style.height=t+"px",this._div.style.width=e+"px",this._div.style.overflow="scroll",this._iframe.style.border="none",cc.game.container.appendChild(this._div),this._updateVisibility()}},{key:"_createNativeControl",value:function(e,t){this._createDom(e,t),this._initStyle(),this._initEvent()}}]),n}(),ZU.Polyfill=nV,ZU.EventType=eV,QU=JU))||QU,pV=eV;function vV(){}var mV,yV,gV,bV,xV,SV,TV,wV,EV,AV,CV,kV,RV,OV,MV,IV,BV,LV,PV,FV,zV,DV,NV,UV,VV,GV,HV,WV,qV,jV=m4("WebviewComponent",(rV=fo("cc.WebviewComponent"),aV=go("UI/WebView"),sV=bo(100),oV=_o({type:Zw}),rV(lV=aV(lV=sV((dV=fV=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"webviewEvents",cV,c(e)),v(e,"_url",hV,c(e)),e._impl=null,e._impl=new _V,e}return _(t,qA),l(t,[{key:"url",get:function(){return this._url},set:function(e){this._url=e;var t=this._impl;t&&t.loadURL(e)}}]),l(t,[{key:"onRestore",value:function(){this._impl||(this._impl=new _V)}},{key:"onEnable",value:function(){if(this._impl){var e=this._impl;e.createDomElementIfNeeded(this.node.width,this.node.height),e.loadURL(this._url),e.setVisible(!0),e.setEventListener(pV.LOADED,this._onWebViewLoaded.bind(this)),e.setEventListener(pV.LOADING,this._onWebViewLoading.bind(this)),e.setEventListener(pV.ERROR,this._onWebViewLoadError.bind(this))}}},{key:"onDisable",value:function(){if(this._impl){var e=this._impl;e.setVisible(!1),e.setEventListener(pV.LOADED,vV),e.setEventListener(pV.LOADING,vV),e.setEventListener(pV.ERROR,vV)}}},{key:"onDestroy",value:function(){this._impl&&(this._impl.destroy(),this._impl=null)}},{key:"update",value:function(e){this._impl&&this._impl.updateMatrix(this.node)}},{key:"setJavascriptInterfaceScheme",value:function(e){this._impl&&this._impl.setJavascriptInterfaceScheme(e)}},{key:"setOnJSCallback",value:function(e){this._impl&&this._impl.setOnJSCallback(e)}},{key:"evaluateJS",value:function(e){this._impl&&this._impl.evaluateJS(e)}},{key:"_onWebViewLoaded",value:function(){Zw.emitEvents(this.webviewEvents,this,pV.LOADED),this.node.emit("loaded",this)}},{key:"_onWebViewLoading",value:function(){return Zw.emitEvents(this.webviewEvents,this,pV.LOADING),this.node.emit("loading",this),!0}},{key:"_onWebViewLoadError",value:function(){Zw.emitEvents(this.webviewEvents,this,pV.ERROR),this.node.emit("error",this)}}]),t}(),fV.EventType=pV,m((uV=dV).prototype,"url",[_o],Object.getOwnPropertyDescriptor(uV.prototype,"url"),uV.prototype),cV=m(uV.prototype,"webviewEvents",[oV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hV=m(uV.prototype,"_url",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),lV=uV))||lV)||lV)||lV));cc.WebviewComponent=jV;var XV,YV,KV,QV,ZV=new Ni;function JV(e){return e instanceof hg?ql:e.getContentSize()}function $V(e,t,i,n){for(var r=e.parent?e.parent.getScale():ZV,a=r.x,s=r.y,o=0,l=0,u=e.parent;;){if(!u)return i.x=i.y=0,void(n.x=n.y=1);var c=u.getPosition();if(o+=c.x,l+=c.y,(u=u.parent)===t)break;var h=(r=u?u.getScale():ZV).x,f=r.y;o*=h,l*=f,a*=h,s*=f}n.x=0!==a?1/a:1,n.y=0!==s?1/s:1,i.x=-o,i.y=-l}(YV=XV=XV||{})[YV.ONCE=0]="ONCE",YV[YV.ALWAYS=1]="ALWAYS",mt(XV),(QV=KV=KV||{})[QV.TOP=1]="TOP",QV[QV.MID=2]="MID",QV[QV.BOT=4]="BOT",QV[QV.LEFT=8]="LEFT",QV[QV.CENTER=16]="CENTER",QV[QV.RIGHT=32]="RIGHT",QV[QV.HORIZONTAL=56]="HORIZONTAL",QV[QV.VERTICAL=7]="VERTICAL";var eG,tG=KV.TOP|KV.BOT,iG=KV.LEFT|KV.RIGHT,nG=m4("WidgetComponent",(mV=fo("cc.WidgetComponent"),yV=bo(110),gV=go("UI/Widget"),bV=yo(qE),xV=_o({type:cy}),SV=_o({visible:!1}),TV=_o({visible:!1}),wV=_o({type:XV}),mV(EV=yV(EV=gV(EV=bV(EV=mo((qV=WV=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._lastPos=new Ni,t._lastSize=new jn,t._dirty=!0,v(t,"_alignFlags",CV,c(t)),v(t,"_target",kV,c(t)),v(t,"_left",RV,c(t)),v(t,"_right",OV,c(t)),v(t,"_top",MV,c(t)),v(t,"_bottom",IV,c(t)),v(t,"_horizontalCenter",BV,c(t)),v(t,"_verticalCenter",LV,c(t)),v(t,"_isAbsLeft",PV,c(t)),v(t,"_isAbsRight",FV,c(t)),v(t,"_isAbsTop",zV,c(t)),v(t,"_isAbsBottom",DV,c(t)),v(t,"_isAbsHorizontalCenter",NV,c(t)),v(t,"_isAbsVerticalCenter",UV,c(t)),v(t,"_originalWidth",VV,c(t)),v(t,"_originalHeight",GV,c(t)),v(t,"_alignMode",HV,c(t)),t}return _(a,Tm),l(a,[{key:"updateAlignment",value:function(){cc._widgetManager.updateAlignment(this.node)}},{key:"_validateTargetInDEV",value:function(){}},{key:"setDirty",value:function(){this._recursiveDirty()}},{key:"onEnable",value:function(){this.node.getPosition(this._lastPos),this.node.getContentSize(this._lastSize),cc._widgetManager.add(this),this._registerEvent(),this._registerTargetEvents()}},{key:"onDisable",value:function(){cc._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}},{key:"onDestroy",value:function(){this._removeParentEvent()}},{key:"_adjustWidgetToAllowMovingInEditor",value:function(e){if(e===Gp.POSITION_PART&&!cc._widgetManager.isAligning){var t=this,i=t.node.getPosition(),n=this._lastPos,r=new Ni(i);r.subtract(n);var a=t.node.parent,s=new Ni(1,1,1);if(t.target&&(a=t.target,$V(t.node,a,new Ni,s)),a){var o=JV(a),l=new Ni;0!==o.width&&0!==o.height&&Ni.set(l,r.x/o.width*100,r.y/o.height*100,l.z),t.isAlignTop&&(t.top-=(t.isAbsoluteTop?r.y:l.y)*s.y),t.isAlignBottom&&(t.bottom+=(t.isAbsoluteBottom?r.y:l.y)*s.y),t.isAlignLeft&&(t.left+=(t.isAbsoluteLeft?r.x:l.x)*s.x),t.isAlignRight&&(t.right-=(t.isAbsoluteRight?r.x:l.x)*s.x),t.isAlignHorizontalCenter&&(t.horizontalCenter+=(t.isAbsoluteHorizontalCenter?r.x:l.x)*s.x),t.isAlignVerticalCenter&&(t.verticalCenter+=(t.isAbsoluteVerticalCenter?r.y:l.y)*s.y)}}}},{key:"_adjustWidgetToAllowResizingInEditor",value:function(){if(!cc._widgetManager.isAligning){this.setDirty();var e=this,t=e.node.getContentSize(),i=this._lastSize,n=new Ni(t.width-i.width,t.height-i.height,0),r=e.node.parent,a=new Ni(1,1,1);if(e.target&&(r=e.target,$V(e.node,r,new Ni,a)),r){var s=JV(r),o=new Ni;0!==s.width&&0!==s.height&&Ni.set(o,n.x/s.width*100,n.y/s.height*100,o.z);var l=e.node.getAnchorPoint();e.isAlignTop&&(e.top-=(e.isAbsoluteTop?n.y:o.y)*(1-l.y)*a.y),e.isAlignBottom&&(e.bottom-=(e.isAbsoluteBottom?n.y:o.y)*l.y*a.y),e.isAlignLeft&&(e.left-=(e.isAbsoluteLeft?n.x:o.x)*l.x*a.x),e.isAlignRight&&(e.right-=(e.isAbsoluteRight?n.x:o.x)*(1-l.x)*a.x)}}}},{key:"_adjustWidgetToAnchorChanged",value:function(){this.setDirty()}},{key:"_adjustTargetToParentChanged",value:function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents()}},{key:"_registerEvent",value:function(){this.node.on(Gp.TRANSFORM_CHANGED,this._adjustWidgetToAllowMovingInEditor,this),this.node.on(Gp.SIZE_CHANGED,this._adjustWidgetToAllowResizingInEditor,this),this.node.on(Gp.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(Gp.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_unregisterEvent",value:function(){this.node.off(Gp.TRANSFORM_CHANGED,this._adjustWidgetToAllowMovingInEditor,this),this.node.off(Gp.SIZE_CHANGED,this._adjustWidgetToAllowResizingInEditor,this),this.node.off(Gp.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)}},{key:"_removeParentEvent",value:function(){this.node.off(Gp.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_autoChangedValue",value:function(e,t){if(0<(this._alignFlags&e)&&this.node.parent&&this.node.parent.uiTransfromComp){var i=this.node.parent.getContentSize();this.isAlignLeft&&e===KV.LEFT?this._left=t?this._left/100*i.width:100*this._left/i.width:this.isAlignRight&&e===KV.RIGHT?this._right=t?this._right/100*i.width:100*this._right/i.width:this.isAlignHorizontalCenter&&e===KV.CENTER?this._horizontalCenter=t?this._horizontalCenter/100*i.width:100*this._horizontalCenter/i.width:this.isAlignTop&&e===KV.TOP?this._top=t?this._top/100*i.height:100*this._top/i.height:this.isAlignBottom&&e===KV.BOT?this._bottom=t?this._bottom/100*i.height:100*this._bottom/i.height:this.isAbsoluteVerticalCenter&&e===KV.MID&&(this._verticalCenter=t?this._verticalCenter/100*i.height:100*this._verticalCenter/i.height),this._recursiveDirty()}}},{key:"_registerTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.getComponent(qE)?(e.on(Gp.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.on(Gp.SIZE_CHANGED,this._targetChangedOperation,this)):cc.warnID(6501,this.node.name))}},{key:"_unregisterTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.off(Gp.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.off(Gp.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_unregisterOldParentEvents",value:function(e){var t=this._target||e;t&&(t.off(Gp.TRANSFORM_CHANGED,this._targetChangedOperation,this),t.off(Gp.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_targetChangedOperation",value:function(){this._recursiveDirty()}},{key:"_setAlign",value:function(e,t){if(t!==0<(this._alignFlags&e)){var i=0<(e&iG);t?(this._alignFlags|=e,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=this.node.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=this.node.height))):(i?this.isStretchWidth&&(this.node.width=this._originalWidth):this.isStretchHeight&&(this.node.height=this._originalHeight),this._alignFlags&=~e)}}},{key:"_recursiveDirty",value:function(){this._dirty||(this._dirty=!0)}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return 0<(this._alignFlags&KV.TOP)},set:function(e){this._setAlign(KV.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return 0<(this._alignFlags&KV.BOT)},set:function(e){this._setAlign(KV.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return 0<(this._alignFlags&KV.LEFT)},set:function(e){this._setAlign(KV.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return 0<(this._alignFlags&KV.RIGHT)},set:function(e){this._setAlign(KV.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return 0<(this._alignFlags&KV.MID)},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=KV.MID):this._alignFlags&=~KV.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return 0<(this._alignFlags&KV.CENTER)},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=KV.CENTER):this._alignFlags&=~KV.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&iG)==iG}},{key:"isStretchHeight",get:function(){return(this._alignFlags&tG)==tG}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(KV.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(KV.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(KV.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(KV.RIGHT,this._isAbsRight))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(KV.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(KV.MID,this._isAbsVerticalCenter))}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),a}(),WV.AlignMode=XV,m((AV=qV).prototype,"target",[xV],Object.getOwnPropertyDescriptor(AV.prototype,"target"),AV.prototype),m(AV.prototype,"isAlignTop",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"isAlignTop"),AV.prototype),m(AV.prototype,"isAlignBottom",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"isAlignBottom"),AV.prototype),m(AV.prototype,"isAlignLeft",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"isAlignLeft"),AV.prototype),m(AV.prototype,"isAlignRight",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"isAlignRight"),AV.prototype),m(AV.prototype,"isAlignVerticalCenter",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"isAlignVerticalCenter"),AV.prototype),m(AV.prototype,"isAlignHorizontalCenter",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"isAlignHorizontalCenter"),AV.prototype),m(AV.prototype,"isStretchWidth",[SV],Object.getOwnPropertyDescriptor(AV.prototype,"isStretchWidth"),AV.prototype),m(AV.prototype,"isStretchHeight",[TV],Object.getOwnPropertyDescriptor(AV.prototype,"isStretchHeight"),AV.prototype),m(AV.prototype,"top",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"top"),AV.prototype),m(AV.prototype,"bottom",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"bottom"),AV.prototype),m(AV.prototype,"left",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"left"),AV.prototype),m(AV.prototype,"right",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"right"),AV.prototype),m(AV.prototype,"horizontalCenter",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"horizontalCenter"),AV.prototype),m(AV.prototype,"verticalCenter",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"verticalCenter"),AV.prototype),m(AV.prototype,"isAbsoluteTop",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"isAbsoluteTop"),AV.prototype),m(AV.prototype,"isAbsoluteBottom",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"isAbsoluteBottom"),AV.prototype),m(AV.prototype,"isAbsoluteLeft",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"isAbsoluteLeft"),AV.prototype),m(AV.prototype,"isAbsoluteRight",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"isAbsoluteRight"),AV.prototype),m(AV.prototype,"alignMode",[wV],Object.getOwnPropertyDescriptor(AV.prototype,"alignMode"),AV.prototype),m(AV.prototype,"isAbsoluteHorizontalCenter",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"isAbsoluteHorizontalCenter"),AV.prototype),m(AV.prototype,"isAbsoluteVerticalCenter",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"isAbsoluteVerticalCenter"),AV.prototype),m(AV.prototype,"alignFlags",[_o],Object.getOwnPropertyDescriptor(AV.prototype,"alignFlags"),AV.prototype),CV=m(AV.prototype,"_alignFlags",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kV=m(AV.prototype,"_target",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RV=m(AV.prototype,"_left",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OV=m(AV.prototype,"_right",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MV=m(AV.prototype,"_top",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),IV=m(AV.prototype,"_bottom",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BV=m(AV.prototype,"_horizontalCenter",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),LV=m(AV.prototype,"_verticalCenter",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PV=m(AV.prototype,"_isAbsLeft",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),FV=m(AV.prototype,"_isAbsRight",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zV=m(AV.prototype,"_isAbsTop",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),DV=m(AV.prototype,"_isAbsBottom",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),NV=m(AV.prototype,"_isAbsHorizontalCenter",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),UV=m(AV.prototype,"_isAbsVerticalCenter",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),VV=m(AV.prototype,"_originalWidth",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GV=m(AV.prototype,"_originalHeight",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HV=m(AV.prototype,"_alignMode",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XV.ALWAYS}}),EV=AV))||EV)||EV)||EV)||EV)||EV));cc.WidgetComponent=nG;var rG,aG,sG,oG,lG,uG,cG,hG,fG,dG,_G,pG,vG,mG,yG=m4("UIReorderComponent",fo("cc.UIReorderComponent")(eG=go("UI/Reorder")(eG=bo(110)(eG=xo(eG=mo(eG=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return _(e,qA),e}())||eG)||eG)||eG)||eG)||eG);cc.UIReorderComponent=yG;var gG,bG,xG=new ar;(bG=gG=gG||{})[bG.HORIZONTAL=0]="HORIZONTAL",bG[bG.VERTICAL=1]="VERTICAL",mt(gG);var SG,TG,wG,EG,AG,CG,kG,RG,OG,MG,IG,BG,LG,PG,FG,zG,DG,NG,UG,VG,GG,HG,WG,qG,jG,XG,YG,KG,QG,ZG,JG,$G=m4("PageViewIndicatorComponent",(rG=fo("cc.PageViewIndicatorComponent"),aG=bo(110),sG=go("UI/PageViewIndicator"),oG=_o({type:Jh}),lG=_o({type:gG}),uG=_o({type:jn}),rG(cG=aG(cG=sG((mG=vG=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"spacing",fG,c(t)),v(t,"_spriteFrame",dG,c(t)),v(t,"_direction",_G,c(t)),v(t,"_cellSize",pG,c(t)),t._layout=null,t._pageView=null,t._indicators=[],t}return _(a,Tm),l(a,[{key:"onLoad",value:function(){this._updateLayout()}},{key:"setPageView",value:function(e){this._pageView=e,this._refresh()}},{key:"_updateLayout",value:function(){this._layout=this.getComponent(Wz),this._layout||(this._layout=this.addComponent(Wz));var e=this._layout;this.direction===gG.HORIZONTAL?(e.type=Wz.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===gG.VERTICAL&&(e.type=Wz.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=Wz.ResizeMode.CONTAINER}},{key:"_createIndicator",value:function(){var e=new cy;return e.addComponent(WL).spriteFrame=this.spriteFrame,e.parent=this.node,e.width=this.cellSize.width,e.height=this.cellSize.height,e}},{key:"_changedState",value:function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var i=0;i<e.length;++i){var n=e[i];if(n._uiComp){var r=n._uiComp;xG.set(r.color),xG.a=127.5,r.color=xG}}if(e[t]._uiComp){var a=e[t]._uiComp;xG.set(a.color),xG.a=255,a.color=xG}}}}},{key:"_refresh",value:function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var i=0;if(t.length>e.length)for(i=0;i<t.length;++i)e[i]||(e[i]=this._createIndicator());else for(i=e.length-t.length;0<i;--i){var n=e[i-1];this.node.removeChild(n),e.splice(i-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),a}(),vG.Direction=gG,m((hG=mG).prototype,"spriteFrame",[oG],Object.getOwnPropertyDescriptor(hG.prototype,"spriteFrame"),hG.prototype),m(hG.prototype,"direction",[lG],Object.getOwnPropertyDescriptor(hG.prototype,"direction"),hG.prototype),m(hG.prototype,"cellSize",[uG],Object.getOwnPropertyDescriptor(hG.prototype,"cellSize"),hG.prototype),fG=m(hG.prototype,"spacing",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dG=m(hG.prototype,"_spriteFrame",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_G=m(hG.prototype,"_direction",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gG.HORIZONTAL}}),pG=m(hG.prototype,"_cellSize",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jn(20,20)}}),cG=hG))||cG)||cG)||cG));cc.PageViewIndicatorComponent=$G;var eH,tH,iH,nH,rH,aH,sH=new Ii;(tH=eH=eH||{})[tH.Unified=0]="Unified",tH[tH.Free=1]="Free",mt(eH),(nH=iH=iH||{})[nH.Horizontal=0]="Horizontal",nH[nH.Vertical=1]="Vertical",mt(iH),(aH=rH=rH||{})[aH.PAGE_TURNING=0]="PAGE_TURNING",mt(rH);var oH=m4("PageViewComponent",(SG=fo("cc.PageViewComponent"),TG=bo(110),wG=go("UI/PageView"),EG=_o({type:eH}),AG=_o({type:iH}),CG=_o({slide:!0,range:[0,1,.01]}),kG=_o({slide:!0,range:[0,1,.01]}),RG=_o({type:$G}),OG=_o({type:CN,visible:!1,override:!0}),MG=_o({type:CN,visible:!1,override:!0}),IG=_o({visible:!1,override:!0}),BG=_o({visible:!1,override:!0}),LG=_o({visible:!1,override:!0}),PG=_o({visible:!1,override:!0,type:[Zw]}),FG=_o({type:[Zw]}),SG(zG=TG(zG=wG((JG=ZG=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"autoPageTurningThreshold",NG,c(t)),v(t,"horizontal",UG,c(t)),v(t,"vertical",VG,c(t)),v(t,"cancelInnerEvents",GG,c(t)),v(t,"scrollEvents",HG,c(t)),v(t,"pageTurningSpeed",WG,c(t)),v(t,"pageEvents",qG,c(t)),v(t,"_sizeMode",jG,c(t)),v(t,"_direction",XG,c(t)),v(t,"_scrollThreshold",YG,c(t)),v(t,"_pageTurningEventTiming",KG,c(t)),v(t,"_indicator",QG,c(t)),t._curPageIdx=0,t._lastPageIdx=0,t._pages=[],t._initContentPos=new Ni,t._scrollCenterOffsetX=[],t._scrollCenterOffsetY=[],t._touchBeganPosition=new Ni,t._touchEndPosition=new Ni,t}return _(a,SU),l(a,[{key:"__preload",value:function(){this.node.on(Gp.SIZE_CHANGED,this._updateAllPagesSize,this)}},{key:"onEnable",value:function(){p(g(a.prototype),"onEnable",this).call(this),this.node.on("scroll-ended-with-threshold",this._dispatchPageTurningEvent,this)}},{key:"onDisable",value:function(){p(g(a.prototype),"onDisable",this).call(this),this.node.off("scroll-ended-with-threshold",this._dispatchPageTurningEvent,this)}},{key:"onLoad",value:function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}},{key:"onDestroy",value:function(){this.node.off(Gp.SIZE_CHANGED,this._updateAllPagesSize,this)}},{key:"getCurrentPageIndex",value:function(){return this._curPageIdx}},{key:"setCurrentPageIndex",value:function(e){this.scrollToPage(e,1)}},{key:"getPages",value:function(){return this._pages}},{key:"addPage",value:function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(this.content.addChild(e),this._pages.push(e),this._updatePageView())}},{key:"insertPage",value:function(e,t){t<0||!e||-1!==this._pages.indexOf(e)||!this.content||(this._pages.length<=t?this.addPage(e):(this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()))}},{key:"removePage",value:function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):P(4300,e.name)}}},{key:"removePageAtIndex",value:function(e){var t=this._pages;if(!(e<0||e>=t.length)){var i=t[e];i&&this.content&&(this.content.removeChild(i),t.splice(e,1),this._updatePageView())}}},{key:"removeAllPages",value:function(){if(this.content){for(var e=this._pages,t=0,i=e.length;t<i;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}}},{key:"scrollToPage",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:0;e<0||e>=this._pages.length||(i=void 0!==i?i:.3,this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),i,!0),this.indicator&&this.indicator._changedState())}},{key:"getScrollEndedEventTiming",value:function(){return this.pageTurningEventTiming}},{key:"_updatePageView",value:function(){var e=this.content.getComponent(Wz);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var i=this._initContentPos,n=0;n<t;++n){var r=this._pages[n].position;this.direction===iH.Horizontal?this._scrollCenterOffsetX[n]=Math.abs(i.x+r.x):this._scrollCenterOffsetY[n]=Math.abs(i.y+r.y)}this.indicator&&this.indicator._refresh()}},{key:"_updateAllPagesSize",value:function(){if(this.content&&this.view&&this._sizeMode===eH.Unified)for(var e=this._pages,t=this.view.getContentSize(),i=0,n=e.length;i<n;i++)e[i].setContentSize(t)}},{key:"_handleReleaseLogic",value:function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent("scroll-ended"))}},{key:"_onTouchBegan",value:function(e,t){e.touch.getUILocation(sH),Ni.set(this._touchBeganPosition,sH.x,sH.y,0),p(g(a.prototype),"_onTouchBegan",this).call(this,e,t)}},{key:"_onTouchMoved",value:function(e,t){p(g(a.prototype),"_onTouchMoved",this).call(this,e,t)}},{key:"_onTouchEnded",value:function(e,t){e.touch.getUILocation(sH),Ni.set(this._touchEndPosition,sH.x,sH.y,0),p(g(a.prototype),"_onTouchEnded",this).call(this,e,t)}},{key:"_onTouchCancelled",value:function(e,t){e.touch.getUILocation(sH),Ni.set(this._touchEndPosition,sH.x,sH.y,0),p(g(a.prototype),"_onTouchCancelled",this).call(this,e,t)}},{key:"_onMouseWheel",value:function(){}},{key:"_syncScrollDirection",value:function(){this.horizontal=this.direction===iH.Horizontal,this.vertical=this.direction===iH.Vertical}},{key:"_syncSizeMode",value:function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(Wz);if(t){if(this._sizeMode===eH.Free&&0<this._pages.length){var i=this._pages[this._pages.length-1];this.direction===iH.Horizontal?(t.paddingLeft=(e.width-this._pages[0].width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===iH.Vertical&&(t.paddingTop=(e.height-this._pages[0].height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}}},{key:"_initPages",value:function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var i=e[t];0<=this._pages.indexOf(i)||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}}},{key:"_dispatchPageTurningEvent",value:function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,Zw.emitEvents(this.pageEvents,this,rH.PAGE_TURNING),this.node.emit("page-turning",this))}},{key:"_isQuicklyScrollable",value:function(e){if(this.direction===iH.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===iH.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1}},{key:"_moveOffsetValue",value:function(e){var t=new Ni;if(this._sizeMode===eH.Free)this.direction===iH.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===iH.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var i=this.view;if(!i)return t;this.direction===iH.Horizontal?t.x=e*i.width:this.direction===iH.Vertical&&(t.y=e*i.height)}return t}},{key:"_getDragDirection",value:function(e){return this._direction===iH.Horizontal?0===e.x?0:0<e.x?1:-1:0===e.y?0:e.y<0?1:-1}},{key:"_isScrollable",value:function(e,t,i){if(this._sizeMode===eH.Free){var n=0,r=0;if(this.direction===iH.Horizontal)return n=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[i],Math.abs(e.x)>=Math.abs(n-r)*this.scrollThreshold;if(this.direction===iH.Vertical)return n=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[i],Math.abs(e.y)>=Math.abs(n-r)*this.scrollThreshold}else{var a=this.view;if(!a)return;if(this.direction===iH.Horizontal)return Math.abs(e.x)>=a.width*this.scrollThreshold;if(this.direction===iH.Vertical)return Math.abs(e.y)>=a.height*this.scrollThreshold}}},{key:"_autoScrollToPage",value:function(){var e=this._startBounceBackIfNeeded(),t=new Ni;if(Ni.subtract(t,this._touchBeganPosition,this._touchEndPosition),e){var i=this._getDragDirection(t);if(0===i)return;this._curPageIdx=0<i?this._pages.length-1:0,this.indicator&&this.indicator._changedState()}else{var n=this._curPageIdx,r=n+this._getDragDirection(t),a=this.pageTurningSpeed*Math.abs(n-r);if(r<this._pages.length){if(this._isScrollable(t,n,r))return void this.scrollToPage(r,a);var s=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(s))return void this.scrollToPage(r,a)}this.scrollToPage(n,a)}}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar}}]),a}(),ZG.SizeMode=eH,ZG.Direction=iH,ZG.EventType=rH,m((DG=JG).prototype,"sizeMode",[EG],Object.getOwnPropertyDescriptor(DG.prototype,"sizeMode"),DG.prototype),m(DG.prototype,"direction",[AG],Object.getOwnPropertyDescriptor(DG.prototype,"direction"),DG.prototype),m(DG.prototype,"scrollThreshold",[CG],Object.getOwnPropertyDescriptor(DG.prototype,"scrollThreshold"),DG.prototype),m(DG.prototype,"pageTurningEventTiming",[kG],Object.getOwnPropertyDescriptor(DG.prototype,"pageTurningEventTiming"),DG.prototype),m(DG.prototype,"indicator",[RG],Object.getOwnPropertyDescriptor(DG.prototype,"indicator"),DG.prototype),NG=m(DG.prototype,"autoPageTurningThreshold",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),m(DG.prototype,"verticalScrollBar",[OG],Object.getOwnPropertyDescriptor(DG.prototype,"verticalScrollBar"),DG.prototype),m(DG.prototype,"horizontalScrollBar",[MG],Object.getOwnPropertyDescriptor(DG.prototype,"horizontalScrollBar"),DG.prototype),UG=m(DG.prototype,"horizontal",[IG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),VG=m(DG.prototype,"vertical",[BG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),GG=m(DG.prototype,"cancelInnerEvents",[LG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),HG=m(DG.prototype,"scrollEvents",[PG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),WG=m(DG.prototype,"pageTurningSpeed",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),qG=m(DG.prototype,"pageEvents",[FG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jG=m(DG.prototype,"_sizeMode",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eH.Unified}}),XG=m(DG.prototype,"_direction",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iH.Horizontal}}),YG=m(DG.prototype,"_scrollThreshold",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),KG=m(DG.prototype,"_pageTurningEventTiming",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),QG=m(DG.prototype,"_indicator",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zG=DG))||zG)||zG)||zG));cc.PageViewComponent=oH;var lH=new Ni,uH=new Ii,cH=new Ni,hH=new Ni(1,1,1);function fH(e,t){var i,n=t.target,r=cH,a=hH;if(n?$V(e,i=n,r,a):i=e.parent,i.getComponent(qE)){var s=JV(i),o=i instanceof hg,l=o?uH:i.getAnchorPoint(),u=o;e.getPosition(lH);var c=lH.x,h=lH.y,f=e.getAnchorPoint(),d=e.getScale();if(t.alignFlags&KV.HORIZONTAL){var _=0,p=0,v=s.width;p=u?(_=ql.left.x,ql.right.x):(_=-l.x*v)+v,_+=t.isAbsoluteLeft?t.left:t.left/100*v,p-=t.isAbsoluteRight?t.right:t.right/100*v,n&&(_+=r.x,_*=a.x,p+=r.x,p*=a.x);var m=0,y=f.x,g=d.x;if(g<0&&(y=1-y,g=-g),t.isStretchWidth)m=p-_,0!==g&&(e.width=m/g),c=_+y*m;else if(m=e.width*g,t.isAlignHorizontalCenter){var b=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter/100*v,x=(.5-l.x)*s.width;n&&(b*=a.x,x+=r.x,x*=a.x),c=x+(y-.5)*m+b}else c=t.isAlignLeft?_+y*m:p+(y-1)*m;t._lastSize.width=m}if(t.alignFlags&KV.VERTICAL){var S=0,T=0,w=s.height;S=u?(T=ql.bottom.y,ql.top.y):(T=-l.y*w)+w,T+=t.isAbsoluteBottom?t.bottom:t.bottom/100*w,S-=t.isAbsoluteTop?t.top:t.top/100*w,n&&(T+=r.y,T*=a.y,S+=r.y,S*=a.y);var E=0,A=f.y,C=d.y;if(C<0&&(A=1-A,C=-C),t.isStretchHeight)E=S-T,0!==C&&(e.height=E/C),h=T+A*E;else if(E=e.height*C,t.isAlignVerticalCenter){var k=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter/100*w,R=(.5-l.y)*s.height;n&&(k*=a.y,R+=r.y,R*=a.y),h=R+(A-.5)*E+k}else h=t.isAlignBottom?T+A*E:S+(A-1)*E;t._lastSize.height=E}e.setPosition(c,h,lH.z),Ni.set(t._lastPos,c,h,lH.z)}}function dH(){var e=kx.getScene();if(e){if(vH.isAligning=!0,vH._nodesOrderDirty)_H.length=0,function e(t){var i=t.getComponent(nG);i&&(fH(t,i),i.alignMode!==XV.ALWAYS?i.enabled=!1:_H.push(i));var n=t.children,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.active&&e(o)}}(e),vH._nodesOrderDirty=!1;else{var t=null,i=vH._activeWidgetsIterator;for(i.i=0;i.i<_H.length;++i.i)(t=_H[i.i])._dirty&&(fH(t.node,t),t._dirty=!1)}vH.isAligning=!1}}var _H=[];var pH=[],vH=m4("widgetManager",cc._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new $e.MutableForwardIterator(_H),animationState:null,init:function(e){e.on(Cx.EVENT_AFTER_UPDATE,dH),fl.isMobile?window.addEventListener("resize",this.onResized.bind(this)):gp.instance.on("design-resolution-changed",this.onResized,this)},add:function(e){this._nodesOrderDirty=!0;var t=e.node.getComponent(hC);if(t){var i=kx.root.ui.getScreen(t.visibility);i&&-1===pH.indexOf(i)&&(pH.push(i),i.node.on("design-resolution-changed",this.onResized,this))}},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=kx.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){if(cy.isNode(e)){var t=e.getComponent(nG);if(t&&t.alignFlags===XV.ALWAYS)return}var i=e.children,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;this.refreshWidgetOnResized(s)}},updateOffsetsToStayPut:function(e,t){function i(e,t){return 1e-10<Math.abs(e-t)?t:e}var n=e.node,r=n.parent;if(r){var a=new Ni,s=new Ni(1,1,1);if(e.target&&$V(n,r=e.target,a,s),!t)return;if(!r.getComponent(qE))return void cc.warnID(6501,e.node.name);var o=r.getAnchorPoint(),l=JV(r),u=n.getAnchorPoint(),c=n.getPosition(),h=KV,f=n.getScale(),d=0;if(t&h.LEFT){var _=-o.x*l.width;_+=a.x,_*=s.x,d=c.x-u.x*n.width*f.x-_,e.isAbsoluteLeft||(d/=l.width),d/=s.x,e.left=i(e.left,d)}if(t&h.RIGHT){var p=(1-o.x)*l.width;p+=a.x,d=(p*=s.x)-(c.x+(1-u.x)*n.width*f.x),e.isAbsoluteRight||(d/=l.width),d/=s.x,e.right=i(e.right,d)}if(t&h.TOP){var v=(1-o.y)*l.height;v+=a.y,d=(v*=s.y)-(c.y+(1-u.y)*n.height*f.y),e.isAbsoluteTop||(d/=l.height),d/=s.y,e.top=i(e.top,d)}if(t&h.BOT){var m=-o.y*l.height;m+=a.y,m*=s.y,d=c.y-u.y*n.height*f.y-m,e.isAbsoluteBottom||(d/=l.height),d/=s.y,e.bottom=i(e.bottom,d)}}},updateAlignment:function e(t){var i=t.parent;i&&cy.isNode(i)&&e(i);var n=t.getComponent(nG);n&&i&&fH(t,n)},AlignMode:XV,AlignFlags:KV});kx.on(Cx.EVENT_INIT,function(){vH.init(kx)});var mH=function e(t,i,n){y(this,e),this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=i,this.y=n};function yH(e,t,i,n,r){var a=0,s=null;if(r===0<function(e,t,i,n){for(var r=0,a=t,s=i-n;a<i;a+=n)r+=(e[s]-e[a])*(e[a+1]+e[s+1]),s=a;return r}(e,t,i,n))for(a=t;a<i;a+=n)s=PH(a,e[a],e[a+1],s);else for(a=i-n;t<=a;a-=n)s=PH(a,e[a],e[a+1],s);return s&&MH(s,s.next)&&(FH(s),s=s.next),s}function gH(e,t){var i=1<arguments.length&&void 0!==t?t:null;if(!e)return e;i=i||e;var n=e,r=!1;do{if(r=!1,n.steiner||!MH(n,n.next)&&0!==OH(n.prev,n,n.next))n=n.next;else{if(FH(n),(n=i=n.prev)===n.next)return null;r=!0}}while(r||n!==i);return i}function bH(e,t,i,n,r,a,s){var o=6<arguments.length&&void 0!==s?s:0;if(e){!o&&a&&function(e,t,i,n){var r=e;for(;null===r.z&&(r.z=CH(r.x,r.y,t,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next,r!==e;);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,i=null,n=null,r=null,a=null,s=0,o=0,l=0,u=1;do{for(i=e,a=e=null,s=0;i;){for(s++,n=i,t=o=0;t<u&&(o++,n=n.nextZ);t++);for(l=u;0<o||0<l&&n;)0===o?(n=(r=n).nextZ,l--):0!==l&&n?i.z<=n.z?(i=(r=i).nextZ,o--):(n=(r=n).nextZ,l--):(i=(r=i).nextZ,o--),a?a.nextZ=r:e=r,r.prevZ=a,a=r;i=n}a.nextZ=null,u*=2}while(1<s)}(r)}(e,n,r,a);for(var l=e,u=null,c=null;e.prev!==e.next;)if(u=e.prev,c=e.next,a?SH(e,n,r,a):xH(e))t.push(u.i/i),t.push(e.i/i),t.push(c.i/i),FH(e),e=c.next,l=c.next;else if((e=c)===l){o?1===o?bH(e=TH(e,t,i),t,i,n,r,a,2):2===o&&wH(e,t,i,n,r,a):bH(gH(e),t,i,n,r,a,1);break}}}function xH(e){var t=e.prev,i=e,n=e.next;if(0<=OH(t,i,n))return!1;for(var r=e.next.next;r!==e.prev;){if(RH(t.x,t.y,i.x,i.y,n.x,n.y,r.x,r.y)&&0<=OH(r.prev,r,r.next))return!1;r=r.next}return!0}function SH(e,t,i,n){var r=e.prev,a=e,s=e.next;if(0<=OH(r,a,s))return!1;for(var o=r.x<a.x?r.x<s.x?r.x:s.x:a.x<s.x?a.x:s.x,l=r.y<a.y?r.y<s.y?r.y:s.y:a.y<s.y?a.y:s.y,u=r.x>a.x?r.x>s.x?r.x:s.x:a.x>s.x?a.x:s.x,c=r.y>a.y?r.y>s.y?r.y:s.y:a.y>s.y?a.y:s.y,h=CH(o,l,t,i,n),f=CH(u,c,t,i,n),d=e.nextZ;d&&d.z<=f;){if(d!==e.prev&&d!==e.next&&RH(r.x,r.y,a.x,a.y,s.x,s.y,d.x,d.y)&&0<=OH(d.prev,d,d.next))return!1;d=d.nextZ}for(d=e.prevZ;d&&d.z>=h;){if(d!==e.prev&&d!==e.next&&RH(r.x,r.y,a.x,a.y,s.x,s.y,d.x,d.y)&&0<=OH(d.prev,d,d.next))return!1;d=d.prevZ}return!0}function TH(e,t,i){var n=e;do{var r=n.prev,a=n.next.next;!MH(r,a)&&IH(r,n,n.next,a)&&BH(r,a)&&BH(a,r)&&(t.push(r.i/i),t.push(n.i/i),t.push(a.i/i),FH(n),FH(n.next),n=e=a),n=n.next}while(n!==e);return n}function wH(e,t,i,n,r,a){var s,o,l=e;do{for(var u=l.next.next;u!==l.prev;){if(l.i!==u.i&&(o=u,(s=l).next.i!==o.i&&s.prev.i!==o.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&IH(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(s,o)&&BH(s,o)&&BH(o,s)&&function(e,t){var i=e,n=!1,r=(e.x+t.x)/2,a=(e.y+t.y)/2;for(;i.y>a!=i.next.y>a&&r<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next,i!==e;);return n}(s,o))){var c=LH(l,u);return l=gH(l,l.next),c=gH(c,c.next),bH(l,t,i,n,r,a),void bH(c,t,i,n,r,a)}u=u.next}l=l.next}while(l!==e)}function EH(e,t){return e.x-t.x}function AH(e,t){if(t=function(e,t){var i=t,n=e.x,r=e.y,a=-1/0,s=null;do{if(r<=i.y&&r>=i.next.y){var o=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(o<=n&&a<o){if((a=o)===n){if(r===i.y)return i;if(r===i.next.y)return i.next}s=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!s)return null;if(n===a)return s.prev;var l,u=s,c=s.x,h=s.y,f=1/0;i=s.next;for(;i!==u;)n>=i.x&&i.x>=c&&RH(r<h?n:a,r,c,h,r<h?a:n,r,i.x,i.y)&&((l=Math.abs(r-i.y)/(n-i.x))<f||l===f&&i.x>s.x)&&BH(i,e)&&(s=i,f=l),i=i.next;return s}(e,t)){var i=LH(t,e);gH(i,i.next)}}function CH(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function kH(e){for(var t=e,i=e;t.x<i.x&&(i=t),(t=t.next)!==e;);return i}function RH(e,t,i,n,r,a,s,o){return 0<=(r-s)*(t-o)-(e-s)*(a-o)&&0<=(e-s)*(n-o)-(i-s)*(t-o)&&0<=(i-s)*(a-o)-(r-s)*(n-o)}function OH(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function MH(e,t){return e.x===t.x&&e.y===t.y}function IH(e,t,i,n){return!!(MH(e,t)&&MH(i,n)||MH(e,n)&&MH(i,t))||0<OH(e,t,i)!=0<OH(e,t,n)&&0<OH(i,n,e)!=0<OH(i,n,t)}function BH(e,t){return OH(e.prev,e,e.next)<0?0<=OH(e,t,e.next)&&0<=OH(e,e.prev,t):OH(e,t,e.prev)<0||OH(e,e.next,t)<0}function LH(e,t){var i=new mH(e.i,e.x,e.y),n=new mH(t.i,t.x,t.y),r=e.next,a=t.prev;return(e.next=t).prev=e,(i.next=r).prev=i,(n.next=i).prev=n,(a.next=n).prev=a,n}function PH(e,t,i,n){var r=new mH(e,t,i);return n?(r.next=n.next,(r.prev=n).next.prev=r,n.next=r):(r.prev=r).next=r,r}function FH(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function zH(e,t,i){i=i||3;var n=t?t.length:0,r=n?t[0]*i:e.length,a=yH(e,0,r,i,!0),s=[];if(!a)return s;var o=0,l=0,u=0,c=0,h=0,f=0,d=0;if(n&&(a=function(e,t,i,n){var r,a=[],s=0,o=null;for(s=0,r=t.length;s<r;s++)(o=yH(e,t[s]*n,s<r-1?t[s+1]*n:e.length,n,!1))&&(o===o.next&&(o.steiner=!0),a.push(kH(o)));if(a.sort(EH),!i)return i;for(s=0;s<a.length;s++)AH(a[s],i),i=gH(i,i.next);return i}(e,t,a,i)),e.length>80*i){o=u=e[0],l=c=e[1];for(var _=i;_<r;_+=i)(h=e[_])<o&&(o=h),(f=e[_+1])<l&&(l=f),u<h&&(u=h),c<f&&(c=f);d=Math.max(u-o,c-l)}return bH(a,s,i,o,l,d),s}var DH=Math.PI,NH=Math.min,UH=Math.max,VH=Math.cos,GH=Math.sin,HH=Math.abs,WH=Math.sign,qH=.5522847493;function jH(e,t,i,n,r){e.moveTo(t-n,i),e.bezierCurveTo(t-n,i+r*qH,t-n*qH,i+r,t,i+r),e.bezierCurveTo(t+n*qH,i+r,t+n,i+r*qH,t+n,i),e.bezierCurveTo(t+n,i-r*qH,t+n*qH,i-r,t,i-r),e.bezierCurveTo(t-n*qH,i-r,t-n,i-r*qH,t-n,i),e.close()}for(var XH=function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,e,t))).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return _(n,Ii),l(n,[{key:"reset",value:function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}]),n}(),YH=function(){function e(){y(this,e),this.closed=!1,this.nbevel=0,this.complex=!0,this.points=[],this.reset()}return l(e,[{key:"reset",value:function(){this.closed=!1,this.nbevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}]),e}(),KH=function(){function e(){y(this,e),this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=ar.WHITE.clone(),this.lineCap=bz.BUTT,this.strokeColor=ar.BLACK.clone(),this.lineJoin=Sz.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandx=0,this._commandy=0,this._points=[],this._renderDatasPool=new Os(function(){return new XA},16),this._renderDatas=[],this._curPath=null}return l(e,[{key:"moveTo",value:function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,wz.PT_CORNER),this._commandx=e,this._commandy=t}},{key:"lineTo",value:function(e,t){this.addPoint(e,t,wz.PT_CORNER),this._commandx=e,this._commandy=t}},{key:"bezierCurveTo",value:function(e,t,i,n,r,a){var s=this._curPath,o=s.points[s.points.length-1];o&&(o.x!==e||o.y!==t||i!==r||n!==a?(function e(t,i,n,r,a,s,o,l,u,c,h){var f,d,_,p,v,m,y,g,b,x,S,T,w,E,A,C;10<c||(v=.5*(s+l),m=.5*(o+u),y=.5*((f=.5*(i+r))+(_=.5*(r+s))),g=.5*((d=.5*(n+a))+(p=.5*(a+o))),((A=HH((r-l)*(E=u-n)-(a-u)*(w=l-i)))+(C=HH((s-l)*E-(o-u)*w)))*(A+C)<t.tessTol*(w*w+E*E)?t.addPoint(l,u,0===h?h|wz.PT_BEVEL:h):(e(t,i,n,f,d,y,g,S=.5*(y+(b=.5*(_+v))),T=.5*(g+(x=.5*(p+m))),c+1,0),e(t,S,T,b,x,v,m,l,u,c+1,h)))}(this,o.x,o.y,e,t,i,n,r,a,0,wz.PT_CORNER),this._commandx=r,this._commandy=a):this.lineTo(r,a))}},{key:"quadraticCurveTo",value:function(e,t,i,n){var r=this._commandx,a=this._commandy;this.bezierCurveTo(r+2/3*(e-r),a+2/3*(t-a),i+2/3*(e-i),n+2/3*(t-n),i,n)}},{key:"arc",value:function(e,t,i,n,r,a){!function(e,t,i,n,r,a,s){var o,l,u=0,c=0,h=0,f=0,d=0,_=0,p=0,v=0,m=0,y=0,g=0,b=0,x=0,S=0;if(c=a-r,s=s||!1)if(HH(c)>=2*DH)c=2*DH;else for(;c<0;)c+=2*DH;else if(HH(c)>=2*DH)c=2*-DH;else for(;0<c;)c-=2*DH;for(l=0|UH(1,NH(HH(c)/(.5*DH)+.5,5)),h=HH(4/3*(1-VH(o=c/l/2))/GH(o)),s||(h=-h),S=0;S<=l;S++)_=t+(f=VH(u=r+c*(S/l)))*n,p=i+(d=GH(u))*n,v=-d*n*h,m=f*n*h,0===S?e.moveTo(_,p):e.bezierCurveTo(y+b,g+x,_-v,p-m,_,p),y=_,g=p,b=v,x=m}(this,e,t,i,n,r,a)}},{key:"ellipse",value:function(e,t,i,n){jH(this,e,t,i,n),this._curPath.complex=!1}},{key:"circle",value:function(e,t,i){jH(this,e,t,i,i),this._curPath.complex=!1}},{key:"rect",value:function(e,t,i,n){this.moveTo(e,t),this.lineTo(e+i,t),this.lineTo(e+i,t+n),this.lineTo(e,t+n),this.close(),this._curPath.complex=!1}},{key:"roundRect",value:function(e,t,i,n,r){!function(e,t,i,n,r,a){if(a<.1)e.rect(t,i,n,r);else{var s=NH(a,.5*HH(n))*WH(n),o=NH(a,.5*HH(r))*WH(r);e.moveTo(t,i+o),e.lineTo(t,i+r-o),e.bezierCurveTo(t,i+r-o*(1-qH),t+s*(1-qH),i+r,t+s,i+r),e.lineTo(t+n-s,i+r),e.bezierCurveTo(t+n-s*(1-qH),i+r,t+n,i+r-o*(1-qH),t+n,i+r-o),e.lineTo(t+n,i+o),e.bezierCurveTo(t+n,i+o*(1-qH),t+n-s*(1-qH),i,t+n-s,i),e.lineTo(t+s,i),e.bezierCurveTo(t+s*(1-qH),i,t,i+o*(1-qH),t,i+o),e.close()}}(this,e,t,i,n,r),this._curPath.complex=!1}},{key:"clear",value:function(e){var t=0<arguments.length&&void 0!==e&&e;this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var i=this._renderDatas,n=0,r=i.length;n<r;n++){var a=i[n];a&&a.reset()}this._renderDatas.length=0,t&&this._renderDatasPool.reset()}},{key:"close",value:function(){this._curPath.closed=!0}},{key:"requestRenderData",value:function(){var e=this._renderDatasPool.add();return this._renderDatas.push(e),e}},{key:"getRenderDatas",value:function(){return 0===this._renderDatas.length&&this.requestRenderData(),this._renderDatas}},{key:"addPoint",value:function(e,t,i){var n=this._curPath;if(n){var r=this._points,a=n.points,s=r[this.pointsOffset++];s?(s.x=e,s.y=t):(s=new XH(e,t),r.push(s)),s.flags=i,a.push(s)}}},{key:"_addPath",value:function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new YH,this.paths.push(t)),this.pathLength++,this._curPath=t}}]),e}(),QH=Math.PI,ZH=Math.min,JH=Math.max,$H=Math.ceil,eW=Math.acos,tW=Math.cos,iW=Math.sin,nW=Math.atan2,rW=xx,aW=[],sW=[],oW=[],lW=[],uW=null,cW=null,hW=new ar,fW=[],dW=0;dW<4;dW++)fW.push(new Ni);function _W(e,t,i){return e<t?t:i<e?i:e}var pW=m4("graphics",{useModel:!0,createImpl:function(e){return new KH},updateRenderData:function(e){for(var t=e.impl?e.impl.getRenderDatas():[],i=0,n=t.length;i<n;i++)t[i].material=e.material},fillBuffers:function(e,t){},renderIA:function(e,t){},getRenderData:function(e,t){if(!cW)return null;var i=cW.getRenderDatas(),n=i[cW.dataOffset];if(!n)return null;var r=n,a=r?r.vertexCount+t:0;return(65535<a||131070<3*a)&&(++cW.dataOffset,cW.dataOffset<i.length?n=i[cW.dataOffset]:(n=cW.requestRenderData(),i[cW.dataOffset]=n),n.material=e.material,r=n),r&&r.vertexCount<a&&r.request(t,3*t),n},stroke:function(e){ar.copy(hW,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){ar.copy(hW,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){var t=kx.root.ui.renderScene;e.model&&(e.model.destroy(),t.destroyModel(e.model),e.model=null);var i=e.impl,n=_u.TRIANGLE_LIST,r=i&&i.getRenderDatas();if(r){var a=0;aW.length=0,sW.length=0,oW.length=0,lW.length=0;var s=r,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var u;if(o){if(l>=s.length)break;u=s[l++]}else{if((l=s.next()).done)break;u=l.value}var c=u,h=c.byteCount>>2,f=c.vData;for(a=0;a<h;)aW.push(f[a++]),aW.push(f[a++]),aW.push(f[a++]),sW.push(f[a++]),sW.push(f[a++]),oW.push(f[a++]),oW.push(f[a++]),oW.push(f[a++]),oW.push(f[a++]);h=c.indiceCount;var d=c.iData;for(a=0;a<h;)lW.push(d[a++])}var _=Jf({primitiveMode:n,positions:aW,uvs:sW,colors:oW,attributes:rW,indices:lW},void 0,{calculateBounds:!1});e.model=t.createModel(Hf,e.node),e.model.initSubModel(0,_.getSubMesh(0),e.material),e.model.enabled=!0,e.markForUpdateRenderData()}},_expandStroke:function(e){var t=.5*e.lineWidth,i=e.lineCap,n=e.lineJoin,r=e.miterLimit;if(cW=e.impl){var a=function(e,t,i){var n=2*eW(e/(e+i));return JH(2,$H(t/n))}(t,QH,cW.tessTol);this._calculateJoins(cW,t,n,r);for(var s=cW.paths,o=0,l=cW.pathOffset,u=cW.pathLength;l<u;l++){var c=s[l],h=c.points.length;n===Sz.ROUND?o+=2*(h+c.nbevel*(a+2)+1):o+=2*(h+5*c.nbevel+1),c.closed||(i===bz.ROUND?o+=2*(2*a+2):o+=12)}var f=uW=this.getRenderData(e,o);if(f){for(var d=f.vData,_=f.iData,p=cW.pathOffset,v=cW.pathLength;p<v;p++){var m=s[p],y=m.points,g=y.length,b=f.vertexStart,x=void 0,S=void 0,T=0,w=0,E=m.closed;if(w=E?(x=y[g-1],S=y[0],T=0,g):(x=y[0],S=y[1],g-(T=1)),!E){var A=new XH(S.x,S.y);A.subtract(x),A.normalize();var C=A.x,k=A.y;i===bz.BUTT?this._buttCap(x,C,k,t,0):i===bz.SQUARE?this._buttCap(x,C,k,t,t):i===bz.ROUND&&this._roundCapStart(x,C,k,t,a)}for(var R=T;R<w;++R)n===Sz.ROUND?this._roundJoin(x,S,t,t,a):0!=(S.flags&(wz.PT_BEVEL|wz.PT_INNERBEVEL))?this._bevelJoin(x,S,t,t):(this._vset(S.x+S.dmx*t,S.y+S.dmy*t),this._vset(S.x-S.dmx*t,S.y-S.dmy*t)),x=S,S=y[R+1];if(E){var O=9*b,M=d.slice(O,O+9);d.set(M,9*f.vertexStart),O+=9,f.vertexStart++,M=d.slice(O,O+9),d.set(M,9*f.vertexStart),f.vertexStart++}else{var I=new XH(S.x,S.y);I.subtract(x),I.normalize();var B=I.x,L=I.y;i===bz.BUTT?this._buttCap(S,B,L,t,0):i===bz.SQUARE?this._buttCap(S,B,L,t,t):i===bz.ROUND&&this._roundCapEnd(S,B,L,t,a)}for(var P=f.indiceStart,F=b+2,z=f.vertexStart;F<z;F++)_[P++]=F-2,_[P++]=F-1,_[P++]=F;if((f.indiceStart=P)!==f.indiceCount){var D=new Array(f.indiceCount-P);f.iData.set(D,P)}}cW=uW=null}}},_expandFill:function(e){if(cW=e.impl){for(var t=cW.paths,i=0,n=cW.pathOffset,r=cW.pathLength;n<r;n++){i+=t[n].points.length}var a=uW=this.getRenderData(e,i);if(a){for(var s=a,o=s.vData,l=s.iData,u=cW.pathOffset,c=cW.pathLength;u<c;u++){var h=t[u],f=h.points,d=f.length;if(0!==d){for(var _=a.vertexStart,p=0;p<d;++p)this._vset(f[p].x,f[p].y);var v=a.indiceStart;if(h.complex){for(var m=[],y=_,g=a.vertexStart;y<g;y++){var b=9*y;m.push(o[b++]),m.push(o[b++]),m.push(o[b++])}var x=zH(m,null,3);if(!x||0===x.length)continue;for(var S=0,T=x.length;S<T;S++)l[v++]=x[S]+_}else for(var w=_,E=_+2,A=s.vertexStart;E<A;E++)l[v++]=w,l[v++]=E-1,l[v++]=E;if((s.indiceStart=v)!==s.indiceCount){var C=new Array(s.indiceCount-v);s.iData.set(C,v)}}}cW=uW=null}}},_calculateJoins:function(e,t,i,n){var r=0;0<t&&(r=1/t);for(var a=e.paths,s=e.pathOffset,o=e.pathLength;s<o;s++)for(var l=a[s],u=l.points,c=u.length,h=u[c-1],f=u[0],d=l.nbevel=0;d<c;d++){var _,p,v=h.dy,m=-h.dx,y=f.dy,g=-f.dx;if(f.dmx=.5*(v+y),f.dmy=.5*(m+g),1e-6<(_=f.dmx*f.dmx+f.dmy*f.dmy)){var b=1/_;600<b&&(b=600),f.dmx*=b,f.dmy*=b}0<f.dx*h.dy-h.dx*f.dy&&(f.flags|=wz.PT_LEFT),_*(p=JH(11,ZH(h.len,f.len)*r))*p<1&&(f.flags|=wz.PT_INNERBEVEL),f.flags&wz.PT_CORNER&&(_*n*n<1||i===Sz.BEVEL||i===Sz.ROUND)&&(f.flags|=wz.PT_BEVEL),0!=(f.flags&(wz.PT_BEVEL|wz.PT_INNERBEVEL))&&l.nbevel++,h=f,f=u[d+1]}},_flattenPaths:function(e){for(var t=e.paths,i=e.pathOffset,n=e.pathLength;i<n;i++){var r=t[i],a=r.points,s=a[a.length-1],o=a[0];s.equals(o)&&(r.closed=!0,a.pop(),s=a[a.length-1]);for(var l=0,u=a.length;l<u;l++){var c=new XH(o.x,o.y);c.subtract(s),s.len=c.length(),(c.x||c.y)&&c.normalize(),s.dx=c.x,s.dy=c.y,s=o,o=a[l+1]}}},_chooseBevel:function(e,t,i,n){var r=i.x,a=i.y,s=0,o=0,l=0,u=0;return 0!==e?(s=r+t.dy*n,o=a-t.dx*n,l=r+i.dy*n,u=a-i.dx*n):(s=l=r+i.dmx*n,o=u=a+i.dmy*n),[s,o,l,u]},_buttCap:function(e,t,i,n,r){var a=e.x-t*r,s=e.y-i*r,o=i,l=-t;this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n)},_roundCapStart:function(e,t,i,n,r){for(var a=e.x,s=e.y,o=i,l=-t,u=0;u<r;u++){var c=u/(r-1)*QH,h=tW(c)*n,f=iW(c)*n;this._vset(a-o*h-t*f,s-l*h-i*f),this._vset(a,s)}this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n)},_roundCapEnd:function(e,t,i,n,r){var a=e.x,s=e.y,o=i,l=-t;this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n);for(var u=0;u<r;u++){var c=u/(r-1)*QH,h=tW(c)*n,f=iW(c)*n;this._vset(a,s),this._vset(a-o*h+t*f,s-l*h+i*f)}},_roundJoin:function(e,t,i,n,r){var a=e.dy,s=-e.dx,o=t.dy,l=-t.dx,u=t.x,c=t.y;if(0!=(t.flags&wz.PT_LEFT)){var h=this._chooseBevel(t.flags&wz.PT_INNERBEVEL,e,t,i),f=h[0],d=h[1],_=h[2],p=h[3],v=nW(-s,-a),m=nW(-l,-o);v<m&&(m-=2*QH),this._vset(f,d),this._vset(u-a*n,t.y-s*n);for(var y=_W($H((v-m)/QH)*r,2,r),g=0;g<y;g++){var b=v+g/(y-1)*(m-v),x=u+tW(b)*n,S=c+iW(b)*n;this._vset(u,c),this._vset(x,S)}this._vset(_,p),this._vset(u-o*n,c-l*n)}else{var T=this._chooseBevel(t.flags&wz.PT_INNERBEVEL,e,t,-n),w=T[0],E=T[1],A=T[2],C=T[3],k=nW(s,a),R=nW(l,o);R<k&&(R+=2*QH),this._vset(u+a*n,c+s*n,0),this._vset(w,E,0);for(var O=_W($H((R-k)/QH)*r,2,r),M=0;M<O;M++){var I=k+M/(O-1)*(R-k),B=u+tW(I)*i,L=c+iW(I)*i;this._vset(B,L,0),this._vset(u,c,0)}this._vset(u+o*n,c+l*n),this._vset(A,C)}},_bevelJoin:function(e,t,i,n){var r=0,a=0,s=0,o=0,l=0,u=0,c=0,h=0,f=e.dy,d=-e.dx,_=t.dy,p=-t.dx;if(t.flags&wz.PT_LEFT){var v=this._chooseBevel(t.flags&wz.PT_INNERBEVEL,e,t,i);l=v[0],u=v[1],c=v[2],h=v[3],this._vset(l,u,0),this._vset(t.x-f*n,t.y-d*n,0),this._vset(c,h,0),this._vset(t.x-_*n,t.y-p*n,0)}else{var m=this._chooseBevel(t.flags&wz.PT_INNERBEVEL,e,t,-n);r=m[0],a=m[1],s=m[2],o=m[3],this._vset(t.x+f*i,t.y+d*i,0),this._vset(r,a),this._vset(t.x+_*i,t.y+p*i,0),this._vset(s,o)}},_vset:function(e,t){if(uW){var i=uW,n=9*i.vertexStart,r=i.vData;r[n++]=e,r[n++]=t,r[n++]=0,r[n++]=1,r[n++]=1,ar.toArray(r,hW,n),i.vertexStart++}}}),vW=m4("graphicsAssembler",{getAssembler:function(e){return pW}});rD.Assembler=vW;function mW(){y(this,mW),this.u=0,this.v=0,this.width=0,this.height=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.validDefinition=!1,this.xAdvance=0}var yW=function(){function e(){y(this,e),this._letterDefinitions={}}return l(e,[{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=new mW;Ne(r,this._letterDefinitions[n]),e[n]=r}return e}},{key:"assignLetterDefinitions",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=e[n];Ne(this._letterDefinitions[n],r)}}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=this._letterDefinitions[n];r.width*=e,r.height*=e,r.offsetX*=e,r.offsetY*=e,r.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e){return this._letterDefinitions.hasOwnProperty(e.charCodeAt(0))?this._letterDefinitions[e.charCodeAt(0)]:null}},{key:"letterDefinitions",get:function(){return this._letterDefinitions}}]),e}();cc.FontAtlas=yW;function gW(){y(this,gW),this.char="",this.valid=!0,this.positionX=0,this.positionY=0,this.lineIndex=0}var bW=new Jn,xW=null,SW=[],TW=[],wW=[],EW=[],AW=new jn,CW=null,kW=null,RW=0,OW=0,MW=0,IW=0,BW=0,LW=1,PW=null,FW="",zW=0,DW=0,NW=new jn,UW=0,VW=0,GW=0,HW=0,WW=0,qW=!1,jW=0,XW=0,YW=0,KW={updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&xW!==e&&(xW=e,this._updateProperties(),this._updateContent(),xW.actualFontSize=zW,xW.node.setContentSize(NW),xW.renderData.vertDirty=xW.renderData.uvDirty=!1,xW=null,this._resetProperties())},_updateFontScale:function(){LW=zW/DW},_updateProperties:function(){if(xW){var e=xW.font;if(e){if(PW=e.spriteFrame,kW=e.fntConfig,!(CW=xW.fontAtlas)){CW=new yW;for(var t=kW.fontDefDictionary,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i],a=new mW,s=t[r].rect;a.offsetX=t[r].xOffset,a.offsetY=t[r].yOffset,a.width=s.width,a.height=s.height,a.u=s.x,a.v=s.y,a.textureID=0,a.validDefinition=!0,a.xAdvance=t[r].xAdvance,CW.addLetterDefinitions(r,a)}xW.fontAtlas=CW}FW=xW.string.toString(),zW=xW.fontSize,DW=kW.fontSize;var o=xW.node.getContentSize();NW.width=o.width,NW.height=o.height,UW=xW.horizontalAlign,VW=xW.verticalAlign,GW=xW.spacingX,WW=xW.overflow,HW=xW.lineHeight,qW=WW!==LP.NONE&&(WW===LP.RESIZE_HEIGHT||xW.enableWrapText),this._setupBMFontOverflowMetrics()}}},_resetProperties:function(){PW=kW=CW=null},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=FW,t=e.length,i=kW.kerningDict,n=SW,r=-1,a=0;a<t;++a){var s=e.charCodeAt(a),o=i[r<<16|65535&s]||0;n[a]=a<t-1?o:0,r=s}},_multilineTextWrap:function(e){var t=FW.length,i=0,n=0,r=0,a=0,s=0,o=0,l=0,u=null,c=new Ii;this._updateFontScale();for(var h=CW.letterDefinitions,f=0;f<t;){var d=FW.charAt(f);if("\n"!==d){for(var _=e(FW,f,t),p=o,v=l,m=s,y=n,g=!1,b=0;b<_;++b){var x=f+b;if("\r"!==(d=FW.charAt(x)))if(u=CW&&CW.getLetterDefinitionForChar(d)){var S=y+u.offsetX*LW;if(qW&&0<YW&&0<n&&S+u.width*LW>YW&&!Ks(d)){wW.push(s),i++,r-=HW*LW+(n=s=0),g=!0;break}c.x=S,c.y=r-u.offsetY*LW,this._recordLetterInfo(h,c,d,x,i),x+1<SW.length&&x<t-1&&(y+=SW[x+1]),y+=u.xAdvance*LW+GW,m=c.x+u.width*LW,p<c.y&&(p=c.y),v>c.y-u.height*LW&&(v=c.y-u.height*LW)}else this._recordPlaceholderInfo(x,d),console.log("Can't find letter definition in texture atlas "+kW.atlasName+" for letter:"+d);else this._recordPlaceholderInfo(x,d)}g||(n=y,o<p&&(o=p),v<l&&(l=v),a<(s=m)&&(a=s),f+=_)}else wW.push(s),i++,r-=HW*LW+(n=s=0),this._recordPlaceholderInfo(f,d),f++}return wW.push(s),OW=(RW=i+1)*HW*LW,1<RW&&(OW+=0*(RW-1)),NW.width=jW,NW.height=XW,jW<=0&&(NW.width=parseFloat(a.toFixed(2))),XW<=0&&(NW.height=parseFloat(OW.toFixed(2))),IW=NW.height,(BW=0)<o&&(IW=NW.height+o),l<-OW&&(BW=OW+l),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(Ys(n)||"\n"===n||Ks(n))return 1;var r=1,a=CW&&CW.getLetterDefinitionForChar(n);if(!a)return r;for(var s=a._xAdvance*LW+GW,o=t+1;o<i&&(n=e.charAt(o),a=CW&&CW.getLetterDefinitionForChar(n));++o){if(s+a._offsetX*LW+a._width*LW>YW&&!Ks(n)&&0<YW)return r;if(s+=a._xAdvance*LW+GW,"\n"===n||Ks(n)||Ys(n))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=TW.length){var i=new gW;TW.push(i)}TW[e].char=t,TW[e].valid=!1},_recordLetterInfo:function(e,t,i,n,r){if(n>=TW.length){var a=new gW;TW.push(a)}var s=i.charCodeAt(0);TW[n].lineIndex=r,TW[n].char=i,TW[n].valid=e[s].validDefinition,TW[n].positionX=t.x,TW[n].positionY=t.y},_alignText:function(){OW=0,wW.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),WW===LP.SHRINK&&0<zW&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||WW===LP.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(t=!(e=.1)),zW=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=zW,i=HW,n=CW,r=0,a=n?n.cloneLetterDefinition():{},s=!0;e();){var o=t-++r;if(s=!1,o<=0)break;var l=o/t;n&&(n.assignLetterDefinitions(a),n.scaleFontLetterDefinition(l)),HW=i*l,this._multilineTextWrapByWord(),this._computeAlignmentOffset()}HW=i,n&&n.assignLetterDefinitions(a),s||0<=t-r&&this._scaleFontSizeDown(t-r)},_isVerticalClamp:function(){return OW>NW.height},_isHorizontalClamp:function(){if(CW){for(var e=CW.letterDefinitions,t=!1,i=0,n=FW.length;i<n;++i){var r=TW[i];if(r.valid){var a=e[r.char],s=r.positionX+a.width/2*LW,o=r.lineIndex;if(0<jW)if(qW){if(wW[o]>NW.width&&(s>NW.width||s<0)){t=!0;break}}else if(s>NW.width){t=!0;break}}}return t}},_isHorizontalClamped:function(e,t){var i=wW[t],n=e>NW.width||e<0;return qW?i>NW.width&&n:n},_updateQuads:function(){if(!xW)return!1;var e=CW?CW.letterDefinitions:{},t=PW,i=xW.node,n=xW.renderData;n.dataLength=n.vertexCount=n.indiceCount=0;for(var r=i.getAnchorPoint(),a=NW,s=r.x*a.width,o=r.y*a.height,l=!0,u=0,c=FW.length;u<c;++u){var h=TW[u];if(h.valid){var f=e[h.char.charCodeAt(0)];if(f){bW.height=f.height,bW.width=f.width,bW.x=f.u,bW.y=f.v;var d=h.positionY+MW;if(0<XW){if(IW<d){var _=d-IW;bW.y+=_,bW.height-=_,d-=_}d-f.height*LW<BW&&(bW.height=d<BW?0:d-BW)}var p=h.lineIndex,v=h.positionX+f.width/2*LW+EW[p];if(0<jW&&this._isHorizontalClamped(v,p))if(WW===LP.CLAMP)bW.width=0;else if(WW===LP.SHRINK){if(NW.width>f.width){l=!1;break}bW.width=0}if(PW&&0<bW.height&&0<bW.width){var m=PW.isRotated(),y=PW.getOriginalSize(),g=PW.getRect(),b=PW.getOffset(),x=b.x+(y.width-g.width)/2,S=b.y-(y.height-g.height)/2;if(m){var T=bW.x;bW.x=g.x+g.height-bW.y-bW.height-S,bW.y=T+g.y-x,bW.y<0&&(bW.height=bW.height+S)}else bW.x+=g.x-x,bW.y+=g.y+S;var w=h.positionX+EW[h.lineIndex];this.appendQuad(xW,t,bW,m,w-s,d-o,LW)}}else console.warn("Can't find letter in this bitmap-font")}}return l},appendQuad:function(e,t,i,n,r,a,s){},_computeAlignmentOffset:function(){switch(EW.length=0,UW){case OP.LEFT:for(var e=0;e<RW;++e)EW.push(0);break;case OP.CENTER:for(var t=0,i=wW.length;t<i;t++)EW.push((NW.width-wW[t])/2);break;case OP.RIGHT:for(var n=0,r=wW.length;n<r;n++)EW.push(NW.width-wW[n])}switch(VW){case IP.TOP:MW=NW.height;break;case IP.CENTER:MW=(NW.height+OW)/2;break;case IP.BOTTOM:MW=OW}},_setupBMFontOverflowMetrics:function(){var e=NW.width,t=NW.height;WW===LP.RESIZE_HEIGHT&&(t=0),WW===LP.NONE&&(t=e=0),jW=e,XW=t,AW.width=e,AW.height=t,YW=e}},QW=m4("bmfont",{createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){uL(e.node,t,e.renderData,e.color)},appendQuad:function(e,t,i,n,r,a,s){var o=e.renderData;if(o){var l=o.dataLength;o.dataLength+=4,o.vertexCount=o.dataLength,o.indiceCount=o.dataLength/2*3;var u=o.datas,c=t.width,h=t.height,f=i.width,d=i.height,_=0,p=0,v=0,m=0;n?(_=i.x/c,m=(i.x+d)/c,p=(i.y+f)/h,v=i.y/h,u[l].u=_,u[l].v=v,u[l+1].u=_,u[l+1].v=p,u[l+2].u=m,u[l+2].v=v,u[l+3].u=m,u[l+3].v=p):(_=i.x/c,m=(i.x+f)/c,p=(i.y+d)/h,v=i.y/h,u[l].u=_,u[l].v=p,u[l+1].u=m,u[l+1].v=p,u[l+2].u=_,u[l+2].v=v,u[l+3].u=m,u[l+3].v=v),u[l].x=r,u[l].y=a-d*s,u[l+1].x=r+f*s,u[l+1].y=a-d*s,u[l+2].x=r,u[l+2].y=a,u[l+3].x=r+f*s,u[l+3].y=a}}});De(QW,KW);function ZW(){y(this,ZW),this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""}function JW(){y(this,JW),this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0}var $W=jP.Overflow,eq=ar.WHITE.clone(),tq=jP.HorizontalAlign,iq=jP.VerticalAlign,nq=function(){function i(e,t){y(this,i),this.spriteframe=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.hash=void 0,this._lastImage=null,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}return l(i,[{key:"updateRenderData",value:function(){this._updateProperties(),this._updateTexture()}},{key:"destroy",value:function(){this.spriteframe&&(this.spriteframe.texture.destroy(),this.spriteframe.destroy(),this.spriteframe=null)}},{key:"_updateProperties",value:function(){if(this.spriteframe=new Jh,this.data=jP.CanvasPool.get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=Qs(this.context,this.char);this.width=parseFloat(e.toFixed(2)),this.height=this.labelInfo.fontSize}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this._lastImage&&(this._lastImage._texture.destroy(),this._lastImage.destroy());var t=new sh(this.canvas),i=(this._lastImage=t)._texture;this.spriteframe.texture=i}},{key:"_updateTexture",value:function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,i=this.canvas.width,n=this.canvas.height;e.textAlign="center",e.textBaseline="middle",e.clearRect(0,0,i,n),e.fillStyle="rgba(255, 255, 255, 0.005)",e.fillRect(0,0,i,n),e.font=t.fontDesc;var r=i/2,a=n/2,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba(".concat(s.r,", ").concat(s.g,", ").concat(s.b,", ",1,")"),t.isOutlined){var o=t.out||eq;e.strokeStyle="rgba(".concat(o.r,", ").concat(o.g,", ").concat(o.b,", ").concat(o.a/255,")"),e.lineWidth=2*t.margin,e.strokeText(this.char,r,a)}e.fillText(this.char,r,a),this.spriteframe.texture.updateImage()}}}]),i}(),rq=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return _(e,Hh),l(e,[{key:"initWithSize",value:function(e,t,i){var n=2<arguments.length&&void 0!==i?i:Hc.RGBA8888;this.destroy(),this.reset({width:e,height:t,format:n}),this.loaded=!0,this.emit("load")}},{key:"drawTextureAt",value:function(e,t,i){var n=this.getGFXTexture();if(e._image&&n){var r=this._getGFXDevice();if(r){var a={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:t,y:i,z:0},texExtent:{width:e._image.width,height:e._image.height,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}};r.copyTexImagesToTexture([e._image.data],n,[a])}else console.warn("Unable to get device")}}}]),e}(),aq=function(){function i(e,t){y(this,i),this.texture=void 0,this._x=2,this._y=2,this._nexty=2,this._width=0,this._height=0,this._letterDefinitions=new Map,this._imageAssets=[],this._dirty=!1,this.texture=new rq,this.texture.initWithSize(e,t),this._width=e,this._height=t,kx.on(Cx.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}return l(i,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),l(i,[{key:"insertLetterTexture",value:function(e){var t=e.spriteframe,i=kx.root.device;if(!(t&&this.texture&&i&&t._image))return null;var n=t.width,r=t.height;if(this._x+n+2>this._width&&(this._x=2,this._y=this._nexty),this._y+r>this._nexty&&(this._nexty=this._y+r+2),this._nexty>this._height)return null;this.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var a=new JW;return a.u=this._x,a.v=this._y,a.texture=this.texture,a.valid=!0,a.w=e.width,a.h=e.height,a.xAdvance=e.width,this._x+=n+2,this._letterDefinitions.set(e.hash,a),a}},{key:"update",value:function(){this._dirty&&(this._dirty=!1)}},{key:"reset",value:function(){this._x=2,this._y=2,this._nexty=2,this._letterDefinitions.clear()}},{key:"destroy",value:function(){this.reset(),this.texture&&this.texture.destroy()}},{key:"beforeSceneLoad",value:function(){this.destroy();var e=new rq;e.initWithSize(this._width,this._height),this.texture=e}},{key:"getLetter",value:function(e){return this._letterDefinitions.get(e)}},{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=new JW;Ne(r,this._letterDefinitions[n]),e[n]=r}return e}},{key:"assignLetterDefinitions",value:function(e){var i=this;e.forEach(function(e,t){Ne(i._letterDefinitions[t],e)})}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=this._letterDefinitions[n];r.w*=e,r.h*=e,r.offsetX*=e,r.offsetY*=e,r.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e,t){var i=e.charCodeAt(0)+t.hash,n=this._letterDefinitions.get(i);if(!n){var r=new nq(e,t);r.updateRenderData(),n=this.insertLetterTexture(r),r.destroy()}return n}}]),i}(),sq=new Jn,oq=null,lq=[],uq=[],cq=[],hq=[],fq=new jn,dq=null,_q=0,pq=0,vq=0,mq=0,yq=0,gq=1,bq="",xq=0,Sq=0,Tq=new jn,wq=0,Eq=0,Aq=0,Cq=0,kq=0,Rq=!1,Oq=0,Mq=0,Iq=0,Bq="",Lq=!1,Pq={fontSize:0,lineHeight:0,hash:"",fontFamily:"",fontDesc:"Arial",hAlign:0,vAlign:0,color:eq,isOutlined:!1,out:eq,margin:0},Fq={getAssemblerData:function(){return(dq=dq||new aq(1024,1024)).texture},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&oq!==e&&(oq=e,this._updateFontFamily(e),Pq.fontFamily=Bq,this._updateProperties(),Pq.fontDesc=this._getFontDesc(),this._updateContent(),oq.actualFontSize=xq,oq.node.setContentSize(Tq),oq.renderData.vertDirty=oq.renderData.uvDirty=!1,oq=null,this._resetProperties())},_updateFontScale:function(){gq=xq/Sq},_updateProperties:function(){if(oq){bq=oq.string.toString(),xq=oq.fontSize,Sq=xq;var e=oq.node.getContentSize();Tq.width=e.width,Tq.height=e.height,wq=oq.horizontalAlign,Eq=oq.verticalAlign,Aq=oq.spacingX,kq=oq.overflow,Cq=oq.lineHeight,Lq=oq.isBold,Rq=kq!==$W.NONE&&(kq===$W.RESIZE_HEIGHT||oq.enableWrapText);var t=oq.getComponent($D);t&&t.enabled?(Pq.isOutlined=!0,Pq.margin=t.width,Pq.out=t.color,Pq.out.a=t.color.a*oq.color.a/255):(Pq.isOutlined=!1,Pq.margin=0),Pq.lineHeight=Cq,Pq.fontSize=xq,Pq.fontFamily=Bq,Pq.color=oq.color,Pq.hash=this._computeHash(Pq),this._setupBMFontOverflowMetrics()}},_updateFontFamily:function(i){i.useSystemFont?Bq=i.fontFamily:i.font?i.font._nativeAsset?Bq=i.font._nativeAsset:(Bq=gw.getRes(i.font.nativeUrl)||"")||gw.load(i.font.nativeUrl,function(e,t){Bq=t||"Arial",i.font&&(i.font._nativeAsset=t),i.updateRenderData(!0)}):Bq="Arial"},_computeHash:function(e){var t=e.color.toHEX("#rrggbb"),i="";return e.isOutlined&&(i=e.out.toHEX("#rrggbb")),""+e.fontSize+e.fontFamily+t+i},_getFontDesc:function(){var e=xq.toString()+"px ";return e+=Bq,Lq&&(e="bold "+e),e},_resetProperties:function(){},_updateContent:function(){this._updateFontScale(),this._alignText()},_computeHorizontalKerningForText:function(){},_multilineTextWrap:function(e){var t=bq.length,i=0,n=0,r=0,a=0,s=0,o=0,l=0,u=null,c=new Ii(0,0);this._updateFontScale();for(var h=0;h<t;){var f=bq.charAt(h);if("\n"!==f){for(var d=e(bq,h,t),_=o,p=l,v=s,m=n,y=!1,g=0;g<d;++g){var b=h+g;if("\r"!==(f=bq.charAt(b)))if(u=dq&&dq.getLetterDefinitionForChar(f,Pq)){var x=m+u.offsetX*gq;if(Rq&&0<Iq&&0<n&&x+u.w*gq>Iq&&!Ks(f)){cq.push(s),i++,r-=Cq*gq+(n=s=0),y=!0;break}c.x=x,c.y=r-u.offsetY*gq,this._recordLetterInfo(c,f,b,i),b+1<lq.length&&b<t-1&&(m+=lq[b+1]),m+=u.xAdvance*gq+Aq,v=c.x+u.w*gq,_<c.y&&(_=c.y),p>c.y-u.h*gq&&(p=c.y-u.h*gq)}else this._recordPlaceholderInfo(b,f);else this._recordPlaceholderInfo(b,f)}y||(n=m,o<_&&(o=_),p<l&&(l=p),a<(s=v)&&(a=s),h+=d)}else cq.push(s),i++,r-=Cq*gq+(n=s=0),this._recordPlaceholderInfo(h,f),h++}return cq.push(s),pq=(_q=i+1)*Cq*gq,1<_q&&(pq+=0*(_q-1)),Tq.width=Oq,Tq.height=Mq,Oq<=0&&(Tq.width=parseFloat(a.toFixed(2))),Mq<=0&&(Tq.height=parseFloat(pq.toFixed(2))),mq=Tq.height,(yq=0)<o&&(mq=Tq.height+o),l<-pq&&(yq=pq+l),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(Ys(n)||"\n"===n||Ks(n))return 1;if(dq){var r=1,a=dq.getLetterDefinitionForChar(n,Pq);if(!a)return r;for(var s=a.xAdvance*gq+Aq,o=t+1;o<i&&(n=e.charAt(o),a=dq.getLetterDefinitionForChar(n,Pq));++o){if(s+a.offsetX*gq+a.w*gq>Iq&&!Ks(n)&&0<Iq)return r;if(s+=a.xAdvance*gq+Aq,"\n"===n||Ks(n)||Ys(n))break;r++}return r}},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=uq.length){var i=new ZW;uq.push(i)}uq[e].char=t,uq[e].hash=t.charCodeAt(0)+Pq.hash,uq[e].valid=!1},_recordLetterInfo:function(e,t,i,n){if(i>=uq.length){var r=new ZW;uq.push(r)}var a=t.charCodeAt(0)+Pq.hash;uq[i].line=n,uq[i].char=t,uq[i].hash=a;var s=dq&&dq.getLetter(a);uq[i].valid=!!s&&!!s.valid,uq[i].x=e.x,uq[i].y=e.y},_alignText:function(){pq=0,cq.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),this._updateQuads()},_scaleFontSizeDown:function(e){var t=!0;e||(t=!(e=.1)),xq=e,t&&this._updateContent()},_isVerticalClamp:function(){return pq>Tq.height},_isHorizontalClamp:function(){for(var e=!1,t=0,i=bq.length;t<i;++t){var n=uq[t];if(n.valid){var r=dq.getLetter(n.hash);if(!r)continue;var a=n.x+r.w*gq,s=n.line;if(0<Oq)if(Rq){if(cq[s]>Tq.width&&(a>Tq.width||a<0)){e=!0;break}}else if(a>Tq.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var i=cq[t],n=e>Tq.width||e<0;return Rq?i>Tq.width&&n:n},_updateQuads:function(){if(oq&&dq){var e=dq.texture,t=oq.node,i=oq.renderData;i.dataLength=i.vertexCount=i.indiceCount=0;for(var n=Tq,r=t.getAnchorPoint(),a=r.x*n.width,s=r.y*n.height,o=!0,l=0,u=bq.length;l<u;++l){var c=uq[l];if(c.valid){var h=dq.getLetter(c.hash);if(h){sq.height=h.h,sq.width=h.w,sq.x=h.u,sq.y=h.v;var f=c.y+vq;if(0<Mq){if(mq<f){var d=f-mq;sq.y+=d,sq.height-=d,f-=d}f-h.h*gq<yq&&(sq.height=f<yq?0:f-yq)}var _=c.line,p=c.x+h.w/2*gq+hq[_];if(0<Oq&&this._isHorizontalClamped(p,_))if(kq===$W.CLAMP)sq.width=0;else if(kq===$W.SHRINK){if(Tq.width>h.w){o=!1;break}sq.width=0}if(0<sq.height&&0<sq.width){var v=c.x+hq[c.line];this.appendQuad(i,e,sq,!1,v-a,f-s,gq)}}}}return o}},appendQuad:function(e,t,i,n,r,a,s){},_computeAlignmentOffset:function(){switch(hq.length=0,wq){case tq.LEFT:for(var e=0;e<_q;++e)hq.push(0);break;case tq.CENTER:for(var t=0,i=cq.length;t<i;t++)hq.push((Tq.width-cq[t])/2);break;case tq.RIGHT:for(var n=0,r=cq.length;n<r;n++)hq.push(Tq.width-cq[n])}switch(Eq){case iq.TOP:vq=Tq.height;break;case iq.CENTER:vq=(Tq.height+pq)/2-(Cq-xq)/2;break;case iq.BOTTOM:vq=(Tq.height+pq)/2-(Cq-xq)}},_setupBMFontOverflowMetrics:function(){var e=Tq.width,t=Tq.height;kq===$W.RESIZE_HEIGHT&&(t=0),kq===$W.NONE&&(t=e=0),Oq=e,Mq=t,fq.width=e,fq.height=t,Iq=e}},zq=new ar(255,255,255,255),Dq=m4("letter",{createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){if(e.renderData){var i=e.node;zq.a=e.color.a,uL(i,t,e.renderData,zq)}},appendQuad:QW.appendQuad});De(Dq,Fq);var Nq=jP.Overflow,Uq=ar.WHITE.clone(),Vq=Ge($D,Tm),Gq=null,Hq=null,Wq=null,qq="",jq="",Xq=0,Yq=0,Kq=[],Qq=new jn,Zq=0,Jq=0,$q=0,ej=new ar,tj="",ij=Nq.NONE,nj=!1,rj=!1,aj=new ar,sj=0,oj=0,lj=!1,uj=!1,cj=!1,hj=new DP,fj={getAssemblerData:function(){var e=document.createElement("canvas"),t={canvas:e,context:e.getContext("2d")};return t.canvas.width=t.canvas.height=1,t},resetAssemblerData:function(e){cc.game.renderType===cc.game.RENDER_TYPE_CANVAS&&e&&hj.put(e)},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&(this._updateFontFamly(e),this._updateProperties(e),this._calculateLabelFont(),this._calculateSplitedStrings(),this._updateLabelDimensions(),this._calculateTextBaseline(),this._updateTexture(),e.actualFontSize=Xq,e.node.setContentSize(Qq),this.updateVerts(e),e.markForUpdateRenderData(!1),Wq=Hq=Gq=null)},updateVerts:function(e){},_updateFontFamly:function(i){i.useSystemFont?tj=i.fontFamily:i.font?i.font._nativeAsset?tj=i.font._nativeAsset:gw.load(i.font.nativeUrl,function(e,t){tj=t||"Arial",i.updateRenderData(!0)}):tj="Arial"},_updateProperties:function(e){var t=e.assemblerData;if(t){Gq=t.context,Hq=t.canvas,Wq=e.spriteFrame,jq=e.string.toString(),Xq=e.fontSize,Yq=Xq,ij=e.overflow,Qq.width=e.node.width,Qq.height=e.node.height,Zq=e.lineHeight,Jq=e.horizontalAlign,$q=e.verticalAlign,ej=e.color,lj=e.isBold,uj=e.isItalic,cj=e.isUnderline,nj=ij!==Nq.NONE&&(ij===Nq.RESIZE_HEIGHT||e.enableWrapText);var i=Vq&&e.getComponent($D);i&&i.enabled?(rj=!0,oj=sj=i.width,(aj=i.color.clone()).a=aj.a*e.color.a/255):(rj=!1,oj=0)}},_calculateFillTextStartPosition:function(){var e,t,i=this._getLineHeight(),n=Kq.length;return e=Jq===OP.RIGHT?Qq.width-oj:Jq===OP.CENTER?Qq.width/2:0+oj,t=$q===IP.TOP?0:$q===IP.CENTER?Qq.height/2-i*(n-1)/2:Qq.height-i*(n-1),new Ii(e,t)},_updateTexture:function(){if(Gq&&Hq){Gq.clearRect(0,0,Hq.width,Hq.height),Gq.font=qq;var e,t=this._calculateFillTextStartPosition(),i=this._getLineHeight();Gq.lineJoin="round",Gq.fillStyle="rgba(".concat(ej.r,", ").concat(ej.g,", ").concat(ej.b,", ").concat(ej.a/255,")");for(var n=0;n<Kq.length;++n){if(rj){var r=aj||Uq;Gq.strokeStyle="rgba(".concat(r.r,", ").concat(r.g,", ").concat(r.b,", ").concat(r.a/255,")"),Gq.lineWidth=2*sj,Gq.strokeText(Kq[n],t.x,t.y+n*i)}Gq.fillText(Kq[n],t.x,t.y+n*i),cj&&(e=this._calculateUnderlineStartPosition(),Gq.save(),Gq.beginPath(),Gq.lineWidth=Xq/8,Gq.strokeStyle="rgba(".concat(ej.r,", ").concat(ej.g,", ").concat(ej.b,", ").concat(ej.a/255,")"),Gq.moveTo(e.x,e.y+n*i-1),Gq.lineTo(e.x+Hq.width,e.y+n*i-1),Gq.stroke(),Gq.restore())}if(Wq){var a;a=Wq instanceof Jh?Wq.texture:Wq;var s=0===Hq.width||0===Hq.height;a.reset({width:Hq.width,height:Hq.height,mipmapLevel:s?0:1}),s||a.uploadData(Hq)}}},_calculateUnderlineStartPosition:function(){var e,t,i=this._getLineHeight(),n=Kq.length;return e=0+oj,t=$q===IP.TOP?Xq:$q===IP.CENTER?Qq.height/2-i*(n-1)/2+Xq/2:Qq.height-i*(n-1),new Ii(e,t)},_updateLabelDimensions:function(){if(Gq){var e=jq.split("\n");if(ij===Nq.RESIZE_HEIGHT)Qq.height=Kq.length*this._getLineHeight();else if(ij===Nq.NONE){var t=0,i=0,n=Kq=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=Qs(Gq,s);t=o<t?t:o}i=Kq.length*this._getLineHeight(),Qq.width=parseFloat(t.toFixed(2))+2*oj,Qq.height=parseFloat(i.toFixed(2)),uj&&(Qq.width+=Yq*Math.tan(.20943951))}Hq&&(Hq.width=Qq.width,Hq.height=Qq.height)}},_calculateTextBaseline:function(){var e,t;e=Jq===OP.RIGHT?"right":Jq===OP.CENTER?"center":"left",t=$q===IP.TOP?"top":$q===IP.CENTER?"middle":"bottom",Gq&&(Gq.textAlign=e,Gq.textBaseline=t)},_calculateSplitedStrings:function(){if(Gq){var e=jq.split("\n");if(nj){Kq=[];var t=Qq.width-2*oj,i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=Zs(a,Qs(Gq,a),t,this._measureText(Gq));Kq=Kq.concat(s)}}else Kq=e}},_getFontDesc:function(){var e=Xq.toString()+"px ";return e+=tj,lj&&(e="bold "+e),uj&&(e="italic "+e),e},_getLineHeight:function(){var e=Zq;return 0|(e=0===e?Xq:e*Xq/Yq)},_calculateParagraphLength:function(e,t){var i=[],n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=Qs(t,s);i.push(o)}return i},_measureText:function(t){return function(e){return Qs(t,e)}},_calculateLabelFont:function(){if(Gq&&(qq=this._getFontDesc(),Gq.font=qq,ij===Nq.SHRINK)){var e=jq.split("\n"),t=this._calculateParagraphLength(e,Gq);Kq=e;var i=0,n=0,r=0;if(nj){var a=Qq.width-2*oj,s=Qq.height-2*oj;if(a<0||s<0)return qq=this._getFontDesc(),void(Gq.font=qq);n=1+s,r=1+a;for(var o=Xq+1,l=[],u=!0,c=0|o;s<n||a<r;){if(u?o=c/2|0:c=o=c-1,o<=0){B(4003);break}for(Xq=o,qq=this._getFontDesc(),Gq.font=qq,Kq=[],i=n=0;i<e.length;++i){var h=0,f=Qs(Gq,e[i]);for(l=Zs(e[i],f,a,this._measureText(Gq));h<l.length;){r=Qs(Gq,l[h]),n+=this._getLineHeight(),++h}Kq=Kq.concat(l)}u&&(s<n?c=0|o:(u=!1,n=1+s))}}else{for(n=e.length*this._getLineHeight(),i=0;i<e.length;++i)r<t[i]&&(r=t[i]);var d=(Qq.width-2*oj)/r,_=Qq.height/n;Xq=Yq*Math.min(1,d,_)|0,qq=this._getFontDesc(),Gq.font=qq}}}},dj=ar.WHITE.clone(),_j=m4("ttf",{createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.vertexCount=4,t.indiceCount=6;var i=t.vData=new Float32Array(36);i[3]=i[21]=i[22]=i[31]=0,i[4]=i[12]=i[13]=i[30]=1;for(var n=5,r=0;r<4;r++)ar.toArray(i,dj,n),n+=9;return t},fillBuffers:function(e,t){var i=e.renderData,n=i.datas,r=e.node,a=t.currBufferBatch,s=a.byteOffset>>2,o=a.indiceOffset,l=a.vertexOffset;a.request()||(a=t.currBufferBatch,l=o=0);var u=a.vData,c=a.iData,h=i.vData,f=n[0],d=n[3];r.updateWorldTransform();var _=r._pos,p=r._rot,v=r._scale,m=f.x*v.x,y=d.x*v.x,g=f.y*v.y,b=d.y*v.y,x=p.x,S=p.y,T=p.z,w=p.w,E=x*S,A=T*w,C=x*x-S*S,k=w*w-T*T,R=k+C,O=2*(E-A),M=k-C,I=2*(E+A),B=_.x,L=_.y;h[0]=R*m+O*g+B,h[1]=M*g+I*m+L,h[9]=R*y+O*g+B,h[10]=M*g+I*y+L,h[18]=R*m+O*b+B,h[19]=M*b+I*m+L,h[27]=R*y+O*b+B,h[28]=M*b+I*y+L,u.set(h,s),c[o++]=l,c[o++]=l+1,c[o++]=l+2,c[o++]=l+2,c[o++]=l+1,c[o++]=l+3},updateVerts:function(e){var t=e.renderData;if(t){var i=e.node,n=i.width,r=i.height,a=i.anchorX*n,s=i.anchorY*r,o=t.datas;o[0].x=-a,o[0].y=-s,o[3].x=n-a,o[3].y=r-s}}});De(_j,fj);var pj=m4("labelAssembler",{getAssembler:function(e){var t=_j;return e.font instanceof LT?t=QW:e.cacheMode===jP.CacheMode.CHAR&&(fl.browserType===fl.BROWSER_TYPE_WECHAT_GAME_SUB?A("sorry, subdomain does not support CHAR mode currently!"):t=Dq),t}});jP.Assembler=pj;var vj=mx.sharedManager,mj=m4("mask",{createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indiceCount=6,t},updateRenderData:function(e){var t=e.renderData;t&&t.vertDirty&&this.updateVerts&&this.updateVerts(e)},updateVerts:function(e){var t=e.renderData;if(t){var i,n,r,a,s=e.node,o=t.datas,l=s.width,u=s.height,c=s.anchorX*l,h=s.anchorY*u;i=-c,n=-h,r=l-c,a=u-h,o[0].x=i,o[0].y=n,o[3].x=r,o[3].y=a,t.vertDirty=!1}},fillBuffers:function(e,t){vj.pushMask(e),vj.clear(),e.clearGraphics.updateAssembler(t),vj.enterLevel(),e.graphics.updateAssembler(t),vj.enableMask()}}),yj=m4("maskEnd",{fillBuffers:function(e,t){vj.exitMask()}}),gj={getAssembler:function(){return mj}},bj={getAssembler:function(){return yj}};kD.Assembler=gj,kD.PostAssembler=bj;var xj=WL.FillType,Sj=new Pn,Tj=m4("barFilled",{useModel:!1,updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t){var n=i.uvDirty,r=i.vertDirty;if(!n&&!r)return;var a=e.fillStart,s=e.fillRange;s<0&&(a+=s,s=-s),s=(s=1<(s=a+s)?1:s)<0?0:s;var o=(a=(a=1<a?1:a)<0?0:a)+(s=(s-=a)<0?0:s);o=1<o?1:o,n&&this.updateUVs(e,a,o),r&&(this.updateVerts&&this.updateVerts(e,a,o),this.updateWorldVerts(e))}},updateUVs:function(e,t,i){var n=e.spriteFrame,r=e.renderData,a=r.datas,s=n.width,o=n.height,l=n.getRect(),u=0,c=0,h=0,f=0,d=0,_=0,p=0,v=0,m=0,y=0;switch(n.isRotated()?(u=l.x/s,c=(l.y+l.width)/o,h=d=u,p=m=(l.x+l.height)/s,_=y=c,f=v=l.y/o):(u=l.x/s,c=(l.y+l.height)/o,h=p=u,d=m=(l.x+l.width)/s,f=_=c,v=y=l.y/o),e.fillType){case xj.HORIZONTAL:a[0].u=h+(d-h)*t,a[0].v=f+(_-f)*t,a[1].u=h+(d-h)*i,a[1].v=f+(_-f)*i,a[2].u=p+(m-p)*t,a[2].v=v+(y-v)*t,a[3].u=p+(m-p)*i,a[3].v=v+(y-v)*i;break;case xj.VERTICAL:a[0].u=h+(p-h)*t,a[0].v=f+(v-f)*t,a[1].u=d+(m-d)*t,a[1].v=_+(y-_)*t,a[2].u=h+(p-h)*i,a[2].v=f+(v-f)*i,a[3].u=d+(m-d)*i,a[3].v=_+(y-_)*i;break;default:z(2626)}r.uvDirty=!1},updateVerts:function(e,t,i){var n=e.renderData,r=n.datas,a=e.node,s=a.width,o=a.height,l=a.anchorX*s,u=a.anchorY*o,c=-l,h=-u,f=s-l,d=o-u,_=0;switch(e.fillType){case xj.HORIZONTAL:_=c+(f-c)*i,c=c+(f-c)*t,f=_;break;case xj.VERTICAL:_=h+(d-h)*i,h=h+(d-h)*t,d=_;break;default:z(2626)}r[4].x=c,r[4].y=h,r[5].x=f,r[5].y=h,r[6].x=c,r[6].y=d,r[7].x=f,r[7].y=d,n.vertDirty=!1},createData:function(e){var t=e.requestRenderData();t.dataLength=8,t.vertexCount=4,t.indiceCount=6;var i=t.datas,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.z=0}return t},updateWorldVerts:function(e){var t=e.node,i=e.renderData.datas;t.getWorldMatrix(Sj);for(var n=0;n<4;n++){var r=i[n+4],a=i[n];Ni.transformMat4(a,r,Sj)}},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVerts(e);e.node;!function(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,u=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,u=l=o=0);for(var c=a.vData,h=0;h<o;h++){var f=r[h];c[s++]=f.x,c[s++]=f.y,c[s++]=f.z,c[s++]=f.u,c[s++]=f.v,ar.toArray(c,n,s),s+=4}var d=a.iData;d[l++]=u,d[l++]=u+1,d[l++]=u+2,d[l++]=u+1,d[l++]=u+3,d[l++]=u+2}(0,t,e.renderData,e.color)}}),wj=2*Math.PI,Ej=[new Ii,new Ii,new Ii,new Ii],Aj=new Array(4),Cj=new Array(8),kj=[new Ii,new Ii,new Ii,new Ii],Rj=[new Ii,new Ii,new Ii,new Ii],Oj=new Ii,Mj=[new Ii,new Ii,new Ii,new Ii];function Ij(e,t,i,n,r,a,s){var o=Math.sin(a);o=1e-6<Math.abs(o)?o:0;var l=Math.cos(a),u=0,c=0;if(0!==(l=1e-6<Math.abs(l)?l:0)){if(u=o/l,0<(e-r.x)*l){var h=r.y+u*(e-r.x);s[0].x=e,s[0].y=h}if(0<(t-r.x)*l){var f=r.y+u*(t-r.x);s[2].x=t,s[2].y=f}}if(0!==o){if(c=l/o,0<(n-r.y)*o){var d=r.x+c*(n-r.y);s[3].x=d,s[3].y=n}if(0<(i-r.y)*o){var _=r.x+c*(i-r.y);s[1].x=_,s[1].y=i}}}function Bj(e,t){var i=t.x-e.x,n=t.y-e.y;if(0==i&&0==n)return 0;if(0==i)return 0<n?.5*Math.PI:1.5*Math.PI;var r=Math.atan(n/i);return i<0&&(r+=Math.PI),r}function Lj(e,t,i,n,r){var a=Aj,s=a[0],o=a[1],l=a[2],u=a[3];e[t].x=i.x,e[t].y=i.y,e[t+1].x=n.x,e[t+1].y=n.y,e[t+2].x=r.x,e[t+2].y=r.y;Pj((i.x-s)/(l-s),(i.y-o)/(u-o),e,t),Pj((n.x-s)/(l-s),(n.y-o)/(u-o),e,t+1),Pj((r.x-s)/(l-s),(r.y-o)/(u-o),e,t+2)}function Pj(e,t,i,n){var r=Cj,a=r[0]+(r[2]-r[0])*e,s=r[4]+(r[6]-r[4])*e,o=r[1]+(r[3]-r[1])*e,l=r[5]+(r[7]-r[5])*e,u=i[n];u.u=a+(s-a)*t,u.v=o+(l-o)*t}for(var Fj=m4("radialFilled",{useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t&&(i.vertDirty||i.uvDirty)){var n=i.datas,r=e.fillStart,a=e.fillRange;for(a<0&&(r+=a,a=-a);1<=r;)r-=1;for(;r<0;)r+=1;var s=(r*=wj)+(a*=wj);!function(e){var t=e.node,i=t.width,n=t.height,r=t.anchorX*i,a=t.anchorY*n,s=-r,o=-a,l=i-r,u=n-a,c=Aj;c[0]=s,c[1]=o,c[2]=l,c[3]=u;var h=e.fillCenter,f=Oj.x=Math.min(Math.max(0,h.x),1)*(l-s)+s,d=Oj.y=Math.min(Math.max(0,h.y),1)*(u-o)+o;Ej[0].x=Ej[3].x=s,Ej[1].x=Ej[2].x=l,Ej[0].y=Ej[1].y=o,Ej[2].y=Ej[3].y=u;var _=Mj,p=Array.isArray(_),v=0;for(_=p?_:_[Symbol.iterator]();;){var m;if(p){if(v>=_.length)break;m=_[v++]}else{if((v=_.next()).done)break;m=v.value}var y=m;Ii.set(y,0,0)}f!==c[0]&&Ii.set(Mj[0],3,0),f!==c[2]&&Ii.set(Mj[2],1,2),d!==c[1]&&Ii.set(Mj[1],0,1),d!==c[3]&&Ii.set(Mj[3],2,3)}(e),function(e){var t=e.width,i=e.height,n=e.getRect(),r=0,a=0,s=0,o=0,l=Cj;e.isRotated()?(r=n.x/t,a=(n.x+n.height)/t,s=n.y/i,o=(n.y+n.width)/i,l[0]=l[2]=r,l[4]=l[6]=a,l[3]=l[7]=o,l[1]=l[5]=s):(r=n.x/t,a=(n.x+n.width)/t,s=n.y/i,o=(n.y+n.height)/i,l[0]=l[4]=r,l[2]=l[6]=a,l[1]=l[3]=o,l[5]=l[7]=s)}(t),Ij(Aj[0],Aj[2],Aj[1],Aj[3],Oj,r,kj),Ij(Aj[0],Aj[2],Aj[1],Aj[3],Oj,r+a,Rj);for(var o=0,l=0;l<4;++l){var u=Mj[l];if(u)if(wj<=a)i.dataLength=o+3,Lj(n,o,Oj,Ej[u.x],Ej[u.y]),o+=3;else{var c=Bj(Oj,Ej[u.x]),h=Bj(Oj,Ej[u.y]);h<c&&(h+=wj),c-=wj,h-=wj;for(var f=0;f<3;++f)s<=c||(r<=c?(i.dataLength=o+3,Lj(n,o,Oj,Ej[u.x],s<=h?Rj[l]:Ej[u.y]),o+=3):h<=r||(h<=s?(i.dataLength=o+3,Lj(n,o,Oj,kj[l],Ej[u.y])):(i.dataLength=o+3,Lj(n,o,Oj,kj[l],Rj[l])),o+=3)),c+=wj,h+=wj}}i.indiceCount=i.vertexCount=o,i.vertDirty=i.uvDirty=!1}},fillBuffers:function(e,t){!function(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,u=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,u=l=o=0);var c=a.vData;e.getWorldMatrix(lL);for(var h=0;h<o;h++){var f=r[h];Ni.set(oL,f.x,f.y,0),Ni.transformMat4(oL,oL,lL),c[s++]=oL.x,c[s++]=oL.y,c[s++]=oL.z,c[s++]=f.u,c[s++]=f.v,ar.toArray(c,n,s),s+=4}for(var d=a.iData,_=0;_<i.dataLength;_++)d[l+_]=u+_}(e.node,t,e.renderData,e.color)}}),zj=[],Dj=0;Dj<4;Dj++)zj.push(new Ni);var Nj,Uj,Vj,Gj,Hj,Wj,qj,jj,Xj,Yj,Kj=m4("simple",{createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indiceCount=6,t.vData=new Float32Array(36),t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&(i.vertDirty&&this.updateVerts(e),i.uvDirty&&this.updateUvs(e))},fillBuffers:function(e,t){if(null!==e){var i=e.renderData.datas,n=e.node,r=t.currBufferBatch,a=r.byteOffset>>2,s=r.indiceOffset,o=r.vertexOffset;r.request()||(r=t.currBufferBatch,o=s=a=0);var l=r.vData,u=r.iData,c=e.renderData.vData,h=i[0],f=i[3],d=n.worldMatrix,_=d.m00,p=d.m01,v=d.m04,m=d.m05,y=d.m12,g=d.m13,b=h.x,x=f.x,S=h.y,T=f.y,w=_*b,E=_*x,A=p*b,C=p*x,k=v*S,R=v*T,O=m*S,M=m*T;c[0]=w+k+y,c[1]=A+O+g,c[9]=E+k+y,c[10]=C+O+g,c[18]=w+R+y,c[19]=A+M+g,c[27]=E+R+y,c[28]=C+M+g,l.set(c,a),u[s++]=o,u[s++]=o+1,u[s++]=o+2,u[s++]=o+2,u[s++]=o+1,u[s++]=o+3}},updateVerts:function(e){var t=e.renderData;if(t){var i=e.node,n=t.datas,r=i.width,a=i.height,s=i.anchorX*r,o=i.anchorY*a,l=0,u=0,c=0,h=0;if(e.trim)l=-s,u=-o,c=r-s,h=a-o;else{var f=e.spriteFrame,d=f.getOriginalSize(),_=f.getRect(),p=d.width,v=d.height,m=_.width,y=_.height,g=f.getOffset(),b=r/p,x=a/v,S=g.x+(p-m)/2,T=g.x-(p-m)/2;l=S*b-s,u=(g.y+(v-y)/2)*x-o,c=r+T*b-s,h=a+(g.y-(v-y)/2)*x-o}n[0].x=l,n[0].y=u,n[0].z=0,n[3].x=c,n[3].y=h,n[3].z=0,t.vertDirty=!1}},updateUvs:function(e){var t=e.renderData,i=t.vData,n=e.spriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7],t.uvDirty=!1},updateColor:function(e){for(var t=e.renderData.vData,i=5,n=e.color,r=n.r/255,a=n.g/255,s=n.b/255,o=n.a/255,l=0;l<4;l++)t[i]=r,t[i+1]=a,t[i+2]=s,t[i+3]=o,i+=9}}),Qj=new Ni,Zj=new Pn,Jj=m4("sliced",{useModel:!1,createData:function(e){var t=e.requestRenderData();return t.dataLength=20,t.vertexCount=16,t.indiceCount=54,t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&i.vertDirty&&(this.updateVerts(e),this.updateWorldVerts(e))},updateVerts:function(e){var t=e.renderData,i=t.datas,n=e.node,r=n.width,a=n.height,s=n.anchorX*r,o=n.anchorY*a,l=e.spriteFrame,u=l.insetLeft,c=l.insetRight,h=l.insetTop,f=l.insetBottom,d=r-u-c,_=a-h-f,p=r/(u+c),v=a/(h+f);p=isNaN(p)||1<p?1:p,v=isNaN(v)||1<v?1:v,d=d<0?0:d,_=_<0?0:_,i[0].x=-s,i[0].y=-o,i[1].x=u*p-s,i[1].y=f*v-o,i[2].x=i[1].x+d,i[2].y=i[1].y+_,i[3].x=r-s,i[3].y=a-o,t.vertDirty=!1},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVerts(e);var i=t.currBufferBatch,n=e.renderData,r=n.datas,a=i.byteOffset>>2,s=n.vertexCount,o=i.indiceOffset,l=i.vertexOffset,u=e.spriteFrame.uvSliced;i.request(s,n.indiceCount)||(i=t.currBufferBatch,l=o=a=0);for(var c=i.vData,h=i.iData,f=4;f<20;++f){var d=r[f],_=u[f-4];c[a++]=d.x,c[a++]=d.y,c[a++]=d.z,c[a++]=_.u,c[a++]=_.v,ar.toArray(c,e.color,a),a+=4}for(var p=0;p<3;++p)for(var v=0;v<3;++v){var m=l+4*p+v;h[o++]=m,h[o++]=m+1,h[o++]=m+4,h[o++]=m+1,h[o++]=m+5,h[o++]=m+4}},updateWorldVerts:function(e){var t=e.node,i=e.renderData.datas;t.getWorldMatrix(Zj);for(var n=0;n<4;++n)for(var r=i[n],a=0;a<4;++a){var s=i[a],o=i[4+4*n+a];Ni.set(Qj,s.x,r.y,0),Ni.transformMat4(o,Qj,Zj)}}}),$j=WL.Type,eX=WL.FillType,tX=m4("spriteAssembler",{getAssembler:function(e){var t=Kj,i=e;switch(i.type){case $j.SLICED:t=Jj;break;case $j.FILLED:t=i.fillType===eX.RADIAL?Fj:Tj}return t}});WL.Assembler=tX,cc.UI={MeshBuffer:vx,UIVertexFormat:Sx,barFilled:Tj,radialFilled:Fj,simple:Kj,sliced:Jj,ttf:_j,bmfont:QW,letter:Dq,mask:mj,maskEnd:yj,graphics:pW,spriteAssembler:tX,graphicsAssembler:vW,labelAssembler:pj};var iX,nX,rX,aX,sX,oX,lX,uX,cX,hX,fX,dX,_X,pX,vX,mX,yX,gX,bX,xX,SX,TX,wX,EX,AX,CX,kX,RX,OX,MX,IX,BX,LX,PX,FX,zX,DX,NX,UX,VX,GX,HX,WX,qX,jX,XX,YX,KX,QX,ZX,JX,$X,eY,tY,iY,nY,rY,aY,sY,oY,lY,uY,cY,hY,fY,dY,_Y,pY,vY,mY,yY,gY,bY,xY,SY,TY,wY,EY,AY,CY,kY,RY,OY,MY,IY,BY,LY,PY,FY,zY,DY,NY=m4("BillboardComponent",(Nj=fo("cc.BillboardComponent"),Uj=go("Components/Billboard"),Vj=_o({type:Hh}),Gj=_o({type:Hh}),Nj(Hj=Uj(Hj=mo((qj=m((Wj=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"_texture",qj,c(e)),v(e,"_height",jj,c(e)),v(e,"_width",Xj,c(e)),v(e,"_rotation",Yj,c(e)),e._model=null,e._mesh=null,e._material=null,e._uniform=new Xi(1,1,0,0),e}return _(t,Tm),l(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._material&&(this._uniform.y=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._material&&(this._uniform.x=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*gi(this._rotation))/100},set:function(e){this._rotation=yi(e),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),l(t,[{key:"onEnable",value:function(){this._model||this.createModel(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}},{key:"createModel",value:function(){this._mesh=Jf({primitiveMode:_u.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[ar.WHITE.r,ar.WHITE.g,ar.WHITE.b,ar.WHITE.a,ar.WHITE.r,ar.WHITE.g,ar.WHITE.b,ar.WHITE.a,ar.WHITE.r,ar.WHITE.g,ar.WHITE.b,ar.WHITE.a,ar.WHITE.r,ar.WHITE.g,ar.WHITE.b,ar.WHITE.a],attributes:[{name:eu.ATTR_POSITION,format:ru.RGB32F},{name:eu.ATTR_TEX_COORD,format:ru.RG32F},{name:eu.ATTR_COLOR,format:ru.RGBA8UI,isNormalized:!0}],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1}),this._model=this._getRenderScene().createModel(Hf,this.node),null==this._material&&(this._material=new F_,this._material.copy(t_.get("default-billboard-material"))),this._model.initSubModel(0,this._mesh.getSubMesh(0),this._material)}}]),t}()).prototype,"_texture",[Vj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m(Wj.prototype,"texture",[Gj],Object.getOwnPropertyDescriptor(Wj.prototype,"texture"),Wj.prototype),jj=m(Wj.prototype,"_height",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m(Wj.prototype,"height",[_o],Object.getOwnPropertyDescriptor(Wj.prototype,"height"),Wj.prototype),Xj=m(Wj.prototype,"_width",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m(Wj.prototype,"width",[_o],Object.getOwnPropertyDescriptor(Wj.prototype,"width"),Wj.prototype),Yj=m(Wj.prototype,"_rotation",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m(Wj.prototype,"rotation",[_o],Object.getOwnPropertyDescriptor(Wj.prototype,"rotation"),Wj.prototype),Hj=Wj))||Hj)||Hj)||Hj)),UY=[{name:eu.ATTR_POSITION,format:ru.RGB32F},{name:eu.ATTR_TEX_COORD,format:ru.RGBA32F},{name:eu.ATTR_TEX_COORD1,format:ru.RGB32F},{name:eu.ATTR_COLOR,format:ru.RGBA8,isNormalized:!0}],VY=new Ni,GY=new Ni,HY=function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,e,t)))._capacity=void 0,i._vertSize=0,i._vBuffer=null,i._vertAttrsFloatCount=0,i._vdataF32=null,i._vdataUint32=null,i._iaInfo=void 0,i._iaInfoBuffer=void 0,i._subMeshData=null,i._vertCount=0,i._indexCount=0,i._capacity=100,i._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},i._iaInfoBuffer=i._device.createBuffer({usage:su.INDIRECT,memUsage:lu.HOST|lu.DEVICE,size:56,stride:1}),i}return _(n,Hf),l(n,[{key:"setCapacity",value:function(e){this._capacity=e,this.createBuffer()}},{key:"createBuffer",value:function(){this._vertSize=0;var e=UY,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.offset=this._vertSize,this._vertSize+=xc[r.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this._createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"_createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var e=this._device.createBuffer({usage:su.VERTEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);e.update(t);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),n=0,r=0;r<this._capacity-1;++r){var a=2*r;i[n++]=a,i[n++]=1+a,i[n++]=2+a,i[n++]=3+a,i[n++]=2+a,i[n++]=1+a}var s=this._device.createBuffer({usage:su.INDEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return s.update(i),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[e],indexBuffer:s,indirectBuffer:this._iaInfoBuffer,attributes:UY,primitiveMode:_u.TRIANGLE_LIST,flatBuffers:[]},this.setSubModelMesh(0,this._subMeshData),t}},{key:"addLineVertexData",value:function(e,t,i){if(1<e.length){var n=0;Ni.subtract(VY,e[1],e[0]),this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=0,this._vdataF32[n++]=VY.x,this._vdataF32[n++]=VY.y,this._vdataF32[n++]=VY.z,this._vdataUint32[n++]=i.evaluate(0,1)._val,this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=1,this._vdataF32[n++]=VY.x,this._vdataF32[n++]=VY.y,this._vdataF32[n++]=VY.z,this._vdataUint32[n++]=i.evaluate(0,1)._val;for(var r=1;r<e.length-1;r++){Ni.subtract(VY,e[r-1],e[r]),Ni.subtract(GY,e[r+1],e[r]),Ni.subtract(GY,GY,VY);var a=r/e.length;this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(a,1),this._vdataF32[n++]=a,this._vdataF32[n++]=0,this._vdataF32[n++]=GY.x,this._vdataF32[n++]=GY.y,this._vdataF32[n++]=GY.z,this._vdataUint32[n++]=i.evaluate(a,1)._val,this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(a,1),this._vdataF32[n++]=a,this._vdataF32[n++]=1,this._vdataF32[n++]=GY.x,this._vdataF32[n++]=GY.y,this._vdataF32[n++]=GY.z,this._vdataUint32[n++]=i.evaluate(a,1)._val}Ni.subtract(VY,e[e.length-1],e[e.length-2]),this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=0,this._vdataF32[n++]=VY.x,this._vdataF32[n++]=VY.y,this._vdataF32[n++]=VY.z,this._vdataUint32[n++]=i.evaluate(1,1)._val,this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=1,this._vdataF32[n++]=VY.x,this._vdataF32[n++]=VY.y,this._vdataF32[n++]=VY.z,this._vdataUint32[n++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,e.length-1))}},{key:"updateIA",value:function(e){this.getSubModel(0).inputAssembler.vertexBuffers[0].update(this._vdataF32),this.getSubModel(0).inputAssembler.indexCount=this._indexCount*e,this.getSubModel(0).inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}},{key:"destroySubMeshData",value:function(){var e=this._subMeshData.vertexBuffers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._subMeshData.indexBuffer.destroy()}}]),n}(),WY=vt({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),qY=(iX=fo("cc.CurveRange"),nX=_o({type:WY}),rX=_o({type:Vs}),aX=_o({type:Vs}),sX=_o({type:Vs}),iX((yX=mX=function(){function e(){y(this,e),v(this,"mode",uX,this),v(this,"curve",cX,this),v(this,"curveMin",hX,this),v(this,"curveMax",fX,this),v(this,"constant",dX,this),v(this,"constantMin",_X,this),v(this,"constantMax",pX,this),v(this,"multiplier",vX,this)}return l(e,[{key:"evaluate",value:function(e,t){switch(this.mode){case WY.Constant:return this.constant;case WY.Curve:return this.curve.evaluate(e)*this.multiplier;case WY.TwoCurves:return mi(this.curveMin.evaluate(e),this.curveMax.evaluate(e),t)*this.multiplier;case WY.TwoConstants:return mi(this.constantMin,this.constantMax,t)}}},{key:"getMax",value:function(){switch(this.mode){case WY.Constant:return this.constant;case WY.Curve:return this.multiplier;case WY.TwoConstants:return this.constantMax;case WY.TwoCurves:return this.multiplier}return 0}}]),e}(),mX.Mode=WY,uX=m((lX=yX).prototype,"mode",[nX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WY.Constant}}),cX=m(lX.prototype,"curve",[rX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vs}}),hX=m(lX.prototype,"curveMin",[aX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vs}}),fX=m(lX.prototype,"curveMax",[sX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vs}}),dX=m(lX.prototype,"constant",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_X=m(lX.prototype,"constantMin",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pX=m(lX.prototype,"constantMax",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vX=m(lX.prototype,"multiplier",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),oX=lX))||oX),jY=vt({Blend:0,Fixed:1}),XY=(fo("cc.ColorKey")((xX=m((bX=function e(){y(this,e),v(this,"color",xX,this),v(this,"time",SX,this)}).prototype,"color",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ar.WHITE.clone()}}),SX=m(bX.prototype,"time",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gX=bX)),fo("cc.AlphaKey")((EX=m((wX=function e(){y(this,e),v(this,"alpha",EX,this),v(this,"time",AX,this)}).prototype,"alpha",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),AX=m(wX.prototype,"time",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),TX=wX)),fo("cc.Gradient")((BX=IX=function(){function e(){y(this,e),v(this,"colorKeys",RX,this),v(this,"alphaKeys",OX,this),v(this,"mode",MX,this),this._color=void 0,this._color=ar.WHITE.clone()}return l(e,[{key:"setKeys",value:function(e,t){this.colorKeys=e,this.alphaKeys=t}},{key:"sortKeys",value:function(){1<this.colorKeys.length&&this.colorKeys.sort(function(e,t){return e.time-t.time}),1<this.alphaKeys.length&&this.alphaKeys.sort(function(e,t){return e.time-t.time})}},{key:"evaluate",value:function(e){return this.getRGB(e),this._color._set_a_unsafe(this.getAlpha(e)),this._color}},{key:"randomColor",value:function(){var e=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],t=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(e.color),this._color._set_a_unsafe(t.alpha),this._color}},{key:"getRGB",value:function(e){if(!(1<this.colorKeys.length))return 1===this.colorKeys.length?this._color.set(this.colorKeys[0].color):this._color.set(ar.WHITE),this._color;e=Ci(e,1);for(var t=1;t<this.colorKeys.length;++t){var i=this.colorKeys[t-1].time,n=this.colorKeys[t].time;if(i<=e&&e<n){if(this.mode===jY.Fixed)return this.colorKeys[t].color;var r=(e-i)/(n-i);return ar.lerp(this._color,this.colorKeys[t-1].color,this.colorKeys[t].color,r),this._color}}var a=this.colorKeys.length-1;e<this.colorKeys[0].time?ar.lerp(this._color,ar.BLACK,this.colorKeys[0].color,e/this.colorKeys[0].time):e>this.colorKeys[a].time&&ar.lerp(this._color,this.colorKeys[a].color,ar.BLACK,(e-this.colorKeys[a].time)/(1-this.colorKeys[a].time))}},{key:"getAlpha",value:function(e){if(!(1<this.alphaKeys.length))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;e=Ci(e,1);for(var t=1;t<this.alphaKeys.length;++t){var i=this.alphaKeys[t-1].time,n=this.alphaKeys[t].time;if(i<=e&&e<n){if(this.mode===jY.Fixed)return this.alphaKeys[t].alpha;var r=(e-i)/(n-i);return mi(this.alphaKeys[t-1].alpha,this.alphaKeys[t].alpha,r)}}var a=this.alphaKeys.length-1;return e<this.alphaKeys[0].time?mi(255,this.alphaKeys[0].alpha,e/this.alphaKeys[0].time):e>this.alphaKeys[a].time?mi(this.alphaKeys[a].alpha,255,(e-this.alphaKeys[a].time)/(1-this.alphaKeys[a].time)):void 0}}]),e}(),IX.Mode=jY,RX=m((kX=BX).prototype,"colorKeys",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),OX=m(kX.prototype,"alphaKeys",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),MX=m(kX.prototype,"mode",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jY.Blend}}),CX=kX))||CX),YY=vt({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),KY=(LX=fo("cc.GradientRange"),PX=_o({type:YY}),FX=_o({type:XY}),zX=_o({type:XY}),DX=_o({type:XY}),NX=_o({type:YY}),LX((QX=KX=function(){function e(){y(this,e),v(this,"color",GX,this),v(this,"colorMin",HX,this),v(this,"colorMax",WX,this),v(this,"gradient",qX,this),v(this,"gradientMin",jX,this),v(this,"gradientMax",XX,this),v(this,"_mode",YX,this),this._color=ar.WHITE.clone()}return l(e,[{key:"evaluate",value:function(e,t){switch(this.mode){case YY.Color:return this.color;case YY.TwoColors:return ar.lerp(this._color,this.colorMin,this.colorMax,t),this._color;case YY.RandomColor:return this.gradient.randomColor();case YY.Gradient:return this.gradient.evaluate(e);case YY.TwoGradients:return ar.lerp(this._color,this.gradientMin.evaluate(e),this.gradientMax.evaluate(e),t),this._color;default:return this.color}}},{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}}]),e}(),KX.Mode=YY,m((VX=QX).prototype,"mode",[PX],Object.getOwnPropertyDescriptor(VX.prototype,"mode"),VX.prototype),GX=m(VX.prototype,"color",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ar.WHITE.clone()}}),HX=m(VX.prototype,"colorMin",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ar.WHITE.clone()}}),WX=m(VX.prototype,"colorMax",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ar.WHITE.clone()}}),qX=m(VX.prototype,"gradient",[FX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new XY}}),jX=m(VX.prototype,"gradientMin",[zX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new XY}}),XX=m(VX.prototype,"gradientMax",[DX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new XY}}),YX=m(VX.prototype,"_mode",[NX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YY.Color}}),UX=VX))||UX),QY="CC_USE_WORLD_SPACE",ZY={CC_USE_WORLD_SPACE:!1},JY=m4("LineComponent",(ZX=fo("cc.LineComponent"),JX=go("Components/Line"),$X=_o({type:Hh}),eY=_o({type:Hh,displayOrder:0}),tY=_o({displayOrder:1}),iY=_o({type:[Ni]}),nY=_o({type:[Ni],displayOrder:2}),rY=_o({type:qY}),aY=_o({type:qY,displayOrder:3}),sY=_o({type:Ii,displayOrder:4}),oY=_o({type:Ii,displayOrder:5}),lY=_o({type:KY}),uY=_o({type:KY,displayOrder:6}),ZX(cY=JX(cY=mo((fY=m((hY=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"_texture",fY,c(e)),e._material=null,v(e,"_worldSpace",dY,c(e)),v(e,"_positions",_Y,c(e)),v(e,"_width",pY,c(e)),v(e,"_tile",vY,c(e)),v(e,"_offset",mY,c(e)),v(e,"_color",yY,c(e)),e._model=null,e._tile_offset=new Xi,e}return _(t,Tm),l(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(e){this._worldSpace=e,this._material&&(ZY[QY]=this.worldSpace,this._material.recompileShaders(ZY),this._model&&this._model.setSubModelMaterial(0,this._material))}},{key:"positions",get:function(){return this._positions},set:function(e){this._positions=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(e){this._tile.set(e),this._material&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e),this._material&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),l(t,[{key:"onEnable",value:function(){this._model||(this._model=this._getRenderScene().createModel(HY,this.node),this._model.setCapacity(100),null==this._material&&(this._material=new F_,this._material.copy(t_.get("default-trail-material")),ZY[QY]=this.worldSpace,this._material.recompileShaders(ZY)),this._model.setSubModelMaterial(0,this._material)),this._model.enabled=!0,this.texture=this.texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}}]),t}()).prototype,"_texture",[$X],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m(hY.prototype,"texture",[eY],Object.getOwnPropertyDescriptor(hY.prototype,"texture"),hY.prototype),dY=m(hY.prototype,"_worldSpace",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),m(hY.prototype,"worldSpace",[tY],Object.getOwnPropertyDescriptor(hY.prototype,"worldSpace"),hY.prototype),_Y=m(hY.prototype,"_positions",[iY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),m(hY.prototype,"positions",[nY],Object.getOwnPropertyDescriptor(hY.prototype,"positions"),hY.prototype),pY=m(hY.prototype,"_width",[rY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),m(hY.prototype,"width",[aY],Object.getOwnPropertyDescriptor(hY.prototype,"width"),hY.prototype),vY=m(hY.prototype,"_tile",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii(1,1)}}),m(hY.prototype,"tile",[sY],Object.getOwnPropertyDescriptor(hY.prototype,"tile"),hY.prototype),mY=m(hY.prototype,"_offset",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ii(0,0)}}),m(hY.prototype,"offset",[oY],Object.getOwnPropertyDescriptor(hY.prototype,"offset"),hY.prototype),yY=m(hY.prototype,"_color",[lY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new KY}}),m(hY.prototype,"color",[uY],Object.getOwnPropertyDescriptor(hY.prototype,"color"),hY.prototype),cY=hY))||cY)||cY)||cY)),$Y=(gY=fo("cc.ColorOvertimeModule"),bY=_o({displayOrder:0}),xY=_o({type:KY,displayOrder:1}),gY((wY=m((TY=function(){function e(){y(this,e),v(this,"enable",wY,this),v(this,"color",EY,this)}return l(e,[{key:"animate",value:function(e){this.enable&&(e.color.set(e.startColor),e.color.multiply(this.color.evaluate(1-e.remainingLifetime/e.startLifetime,Ti(e.randomSeed+91041))))}}]),e}()).prototype,"enable",[bY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),EY=m(TY.prototype,"color",[xY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new KY}}),SY=TY))||SY),eK=vt({World:0,Local:1,Custom:2}),tK=vt({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),iK=vt({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),nK=vt({Base:0,Edge:1,Shell:2,Volume:3}),rK=vt({Random:0,Loop:1,PingPong:2}),aK=vt({Particles:0,Ribbon:1}),sK=vt({Stretch:0,Repeat:1}),oK=new Ni(0,0,-1);function lK(e,t,i,n){return t!==e?(e===eK.World||Pn.invert(i,i),Pn.getRotation(n,i),!0):(fn.set(n,0,0,0,1),!1)}function uK(e,t){Ii.set(e,Math.cos(t),Math.sin(t))}function cK(e){var t=xi(-1,1),i=xi(0,2*Math.PI),n=Math.sqrt(1-t*t),r=n*Math.cos(i),a=n*Math.sin(i);Ni.set(e,r,a,t)}function hK(e,t,i){cK(e),Ni.multiplyScalar(e,e,t+(i-t)*bi())}function fK(e,t,i,n){uK(e,n),e.z=0,Ni.multiplyScalar(e,e,t+(i-t)*bi())}function dK(e){for(var t=0;t<e.length;t++){var i=t+Si(0,e.length-t),n=e[i];e[i]=e[t],e[t]=n}}function _K(){var e=xi(-1,1);return 0===e&&e++,se(e)}var pK,vK,mK,yK,gK,bK,xK,SK,TK,wK,EK,AK,CK,kK,RK,OK,MK,IK,BK,LK,PK,FK,zK,DK,NK,UK,VK,GK,HK,WK,qK,jK,XK=212165,YK=new Ni,KK=(AY=fo("cc.ForceOvertimeModule"),CY=_o({displayOrder:0}),kY=_o({type:qY,range:[-1,1],displayOrder:2}),RY=_o({type:qY,range:[-1,1],displayOrder:3}),OY=_o({type:qY,range:[-1,1],displayOrder:4}),MY=_o({type:eK,displayOrder:1}),AY((LY=m((BY=function(){function e(){y(this,e),v(this,"enable",LY,this),v(this,"x",PY,this),v(this,"y",FY,this),v(this,"z",zY,this),v(this,"space",DY,this),this.randomized=!1,this.rotation=void 0,this.needTransform=void 0,this.rotation=new fn,this.needTransform=!1}return l(e,[{key:"update",value:function(e,t){this.needTransform=lK(e,this.space,t,this.rotation)}},{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime,n=Ni.set(YK,this.x.evaluate(i,Ti(e.randomSeed+XK)),this.y.evaluate(i,Ti(e.randomSeed+XK)),this.z.evaluate(i,Ti(e.randomSeed+XK)));this.needTransform&&Ni.transformQuat(n,n,this.rotation),Ni.scaleAndAdd(e.velocity,e.velocity,n,t)}}]),e}()).prototype,"enable",[CY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),PY=m(BY.prototype,"x",[kY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),FY=m(BY.prototype,"y",[RY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),zY=m(BY.prototype,"z",[OY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),DY=m(BY.prototype,"space",[MY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eK.Local}}),IY=BY))||IY),QK=23541,ZK=new Ni,JK=(pK=fo("cc.LimitVelocityOvertimeModule"),vK=_o({displayOrder:0}),mK=_o({type:qY,range:[-1,1],displayOrder:4}),yK=_o({type:qY,range:[-1,1],displayOrder:5}),gK=_o({type:qY,range:[-1,1],displayOrder:6}),bK=_o({type:qY,range:[-1,1],displayOrder:3}),xK=_o({displayOrder:7}),SK=_o({displayOrder:2}),TK=_o({type:eK,displayOrder:1}),pK((AK=m((EK=function(){function e(){y(this,e),v(this,"enable",AK,this),v(this,"limitX",CK,this),v(this,"limitY",kK,this),v(this,"limitZ",RK,this),v(this,"limit",OK,this),v(this,"dampen",MK,this),v(this,"separateAxes",IK,this),v(this,"space",BK,this),this.drag=null,this.multiplyDragByParticleSize=!1,this.multiplyDragByParticleVelocity=!1}return l(e,[{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=ZK;this.separateAxes?Ni.set(i,$K(e.ultimateVelocity.x,this.limitX.evaluate(t,Ti(e.randomSeed+QK)),this.dampen),$K(e.ultimateVelocity.y,this.limitY.evaluate(t,Ti(e.randomSeed+QK)),this.dampen),$K(e.ultimateVelocity.z,this.limitZ.evaluate(t,Ti(e.randomSeed+QK)),this.dampen)):(Ni.normalize(i,e.ultimateVelocity),Ni.multiplyScalar(i,i,$K(e.ultimateVelocity.length(),this.limit.evaluate(t,Ti(e.randomSeed+QK)),this.dampen))),Ni.copy(e.ultimateVelocity,i)}}]),e}()).prototype,"enable",[vK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),CK=m(EK.prototype,"limitX",[mK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),kK=m(EK.prototype,"limitY",[yK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),RK=m(EK.prototype,"limitZ",[gK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),OK=m(EK.prototype,"limit",[bK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),MK=m(EK.prototype,"dampen",[xK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),IK=m(EK.prototype,"separateAxes",[SK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),BK=m(EK.prototype,"space",[TK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eK.Local}}),wK=EK))||wK);function $K(e,t,i){var n=Math.sign(e),r=Math.abs(e);return t<r&&(r=mi(r,t,i)),r*n}var eQ,tQ,iQ,nQ,rQ,aQ,sQ,oQ,lQ,uQ,cQ,hQ,fQ,dQ,_Q,pQ,vQ,mQ,yQ,gQ,bQ,xQ,SQ,TQ,wQ,EQ,AQ,CQ,kQ,RQ,OQ,MQ,IQ,BQ,LQ,PQ,FQ,zQ,DQ,NQ,UQ,VQ,GQ,HQ,WQ,qQ,jQ,XQ,YQ,KQ,QQ,ZQ,JQ,$Q,eZ,tZ,iZ,nZ,rZ,aZ,sZ,oZ,lZ,uZ,cZ,hZ,fZ,dZ,_Z,pZ,vZ,mZ,yZ,gZ,bZ,xZ,SZ,TZ,wZ,EZ,AZ,CZ,kZ,RZ,OZ,MZ,IZ,BZ,LZ,PZ,FZ,zZ,DZ,NZ,UZ,VZ,GZ,HZ,WZ,qZ,jZ,XZ,YZ,KZ,QZ,ZZ,JZ,$Z,eJ,tJ=(LK=fo("cc.RotationOvertimeModule"),PK=_o({displayOrder:0}),FK=_o({displayOrder:1}),zK=_o({type:qY,range:[-1,1],radian:!0,displayOrder:2}),DK=_o({type:qY,range:[-1,1],radian:!0,displayOrder:3}),NK=_o({type:qY,range:[-1,1],radian:!0,displayOrder:4}),LK((GK=m((VK=function(){function e(){y(this,e),v(this,"enable",GK,this),v(this,"_separateAxes",HK,this),v(this,"x",WK,this),v(this,"y",qK,this),v(this,"z",jK,this)}return l(e,[{key:"separateAxes",get:function(){return this._separateAxes},set:function(e){this._separateAxes=e}}]),l(e,[{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime;if(this._separateAxes){var n=Ti(e.randomSeed+125292);e.rotation.x+=this.x.evaluate(i,n)*t,e.rotation.y+=this.y.evaluate(i,n)*t,e.rotation.z+=this.z.evaluate(i,n)*t}else e.rotation.z+=this.z.evaluate(i,Ti(e.randomSeed+125292))*t}}]),e}()).prototype,"enable",[PK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),HK=m(VK.prototype,"_separateAxes",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),m(VK.prototype,"separateAxes",[FK],Object.getOwnPropertyDescriptor(VK.prototype,"separateAxes"),VK.prototype),WK=m(VK.prototype,"x",[zK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),qK=m(VK.prototype,"y",[DK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),jK=m(VK.prototype,"z",[NK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),UK=VK))||UK),iJ=(eQ=fo("cc.SizeOvertimeModule"),tQ=_o({displayOrder:0}),iQ=_o({displayOrder:1}),nQ=_o({type:qY,displayOrder:2}),rQ=_o({type:qY,displayOrder:3}),aQ=_o({type:qY,displayOrder:4}),sQ=_o({type:qY,displayOrder:5}),eQ((uQ=m((lQ=function(){function e(){y(this,e),v(this,"enable",uQ,this),v(this,"separateAxes",cQ,this),v(this,"size",hQ,this),v(this,"x",fQ,this),v(this,"y",dQ,this),v(this,"z",_Q,this)}return l(e,[{key:"animate",value:function(e){if(this.separateAxes){var t=1-e.remainingLifetime/e.startLifetime,i=Ti(e.randomSeed+39825);e.size.x=e.startSize.x*this.x.evaluate(t,i),e.size.y=e.startSize.y*this.y.evaluate(t,i),e.size.z=e.startSize.z*this.z.evaluate(t,i)}else Ni.multiplyScalar(e.size,e.startSize,this.size.evaluate(1-e.remainingLifetime/e.startLifetime,Ti(e.randomSeed+39825)))}}]),e}()).prototype,"enable",[tQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cQ=m(lQ.prototype,"separateAxes",[iQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),hQ=m(lQ.prototype,"size",[nQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),fQ=m(lQ.prototype,"x",[rQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),dQ=m(lQ.prototype,"y",[aQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),_Q=m(lQ.prototype,"z",[sQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),oQ=lQ))||oQ),nJ=90794,rJ=vt({Grid:0}),aJ=vt({WholeSheet:0,SingleRow:1}),sJ=(pQ=fo("cc.TextureAnimationModule"),vQ=_o({displayOrder:0}),mQ=_o({type:rJ}),yQ=_o({type:rJ,displayOrder:1}),gQ=_o({displayOrder:2}),bQ=_o({displayOrder:3}),xQ=_o({type:aJ,displayOrder:4}),SQ=_o({type:qY,displayOrder:7}),TQ=_o({type:qY,displayOrder:8}),wQ=_o({displayOrder:9}),EQ=_o({displayOrder:5}),AQ=_o({displayOrder:6}),pQ((RQ=m((kQ=function(){function e(){y(this,e),v(this,"_enable",RQ,this),v(this,"_mode",OQ,this),v(this,"numTilesX",MQ,this),v(this,"numTilesY",IQ,this),v(this,"animation",BQ,this),v(this,"frameOverTime",LQ,this),v(this,"startFrame",PQ,this),v(this,"cycleCount",FQ,this),v(this,"_flipU",zQ,this),v(this,"_flipV",DQ,this),v(this,"_uvChannelMask",NQ,this),v(this,"randomRow",UQ,this),v(this,"rowIndex",VQ,this),this.ps=null}return l(e,[{key:"onInit",value:function(e){this.ps=e}},{key:"init",value:function(e){e.startRow=Math.floor(Math.random()*this.numTilesY)}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=this.startFrame.evaluate(t,Ti(e.randomSeed+nJ))/(this.numTilesX*this.numTilesY);if(this.animation===aJ.WholeSheet)e.frameIndex=Ci(this.cycleCount*(this.frameOverTime.evaluate(t,Ti(e.randomSeed+nJ))+i),1);else if(this.animation===aJ.SingleRow){var n=1/this.numTilesY;if(this.randomRow){var r=Ci(this.cycleCount*(this.frameOverTime.evaluate(t,Ti(e.randomSeed+nJ))+i),1),a=e.startRow*n,s=a+n;e.frameIndex=mi(a,s,r)}else{var o=this.rowIndex*n,l=o+n;e.frameIndex=mi(o,l,Ci(this.cycleCount*(this.frameOverTime.evaluate(t,Ti(e.randomSeed+nJ))+i),1))}}}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e,this.ps&&this.ps.renderer._updateMaterialParams()}},{key:"mode",get:function(){return this._mode},set:function(e){e===rJ.Grid||console.error("particle texture animation's sprites is not supported!")}},{key:"flipU",get:function(){return this._flipU},set:function(e){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(e){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(e){console.error("particle texture animation's uvChannelMask is not supported!")}}]),e}()).prototype,"_enable",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),m(kQ.prototype,"enable",[vQ],Object.getOwnPropertyDescriptor(kQ.prototype,"enable"),kQ.prototype),OQ=m(kQ.prototype,"_mode",[mQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rJ.Grid}}),m(kQ.prototype,"mode",[yQ],Object.getOwnPropertyDescriptor(kQ.prototype,"mode"),kQ.prototype),MQ=m(kQ.prototype,"numTilesX",[gQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),IQ=m(kQ.prototype,"numTilesY",[bQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BQ=m(kQ.prototype,"animation",[xQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return aJ.WholeSheet}}),LQ=m(kQ.prototype,"frameOverTime",[SQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),PQ=m(kQ.prototype,"startFrame",[TQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),FQ=m(kQ.prototype,"cycleCount",[wQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zQ=m(kQ.prototype,"_flipU",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DQ=m(kQ.prototype,"_flipV",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NQ=m(kQ.prototype,"_uvChannelMask",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),UQ=m(kQ.prototype,"randomRow",[EQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),VQ=m(kQ.prototype,"rowIndex",[AQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),CQ=kQ))||CQ),oJ=new Ni,lJ=(GQ=fo("cc.VelocityOvertimeModule"),HQ=_o({displayOrder:0}),WQ=_o({type:qY,range:[-1,1],displayOrder:2}),qQ=_o({type:qY,range:[-1,1],displayOrder:3}),jQ=_o({type:qY,range:[-1,1],displayOrder:4}),XQ=_o({type:qY,range:[-1,1],displayOrder:5}),YQ=_o({type:eK,displayOrder:1}),GQ((ZQ=m((QQ=function(){function e(){y(this,e),v(this,"enable",ZQ,this),v(this,"x",JQ,this),v(this,"y",$Q,this),v(this,"z",eZ,this),v(this,"speedModifier",tZ,this),v(this,"space",iZ,this),this.rotation=void 0,this.needTransform=void 0,this.rotation=new fn,this.speedModifier.constant=1,this.needTransform=!1}return l(e,[{key:"update",value:function(e,t){this.needTransform=lK(e,this.space,t,this.rotation)}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=Ni.set(oJ,this.x.evaluate(t,Ti(197866^e.randomSeed)),this.y.evaluate(t,Ti(156497^e.randomSeed)),this.z.evaluate(t,Ti(984136^e.randomSeed)));this.needTransform&&Ni.transformQuat(i,i,this.rotation),Ni.add(e.animatedVelocity,e.animatedVelocity,i),Ni.add(e.ultimateVelocity,e.velocity,e.animatedVelocity),Ni.multiplyScalar(e.ultimateVelocity,e.ultimateVelocity,this.speedModifier.evaluate(1-e.remainingLifetime/e.startLifetime,Ti(e.randomSeed+197866)))}}]),e}()).prototype,"enable",[HQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),JQ=m(QQ.prototype,"x",[WQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),$Q=m(QQ.prototype,"y",[qQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),eZ=m(QQ.prototype,"z",[jQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),tZ=m(QQ.prototype,"speedModifier",[XQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),iZ=m(QQ.prototype,"space",[YQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eK.Local}}),KQ=QQ))||KQ),uJ=(nZ=fo("cc.Burst"),rZ=_o({type:qY}),nZ((oZ=m((sZ=function(){function e(){y(this,e),v(this,"_time",oZ,this),v(this,"minCount",lZ,this),v(this,"maxCount",uZ,this),v(this,"_repeatCount",cZ,this),v(this,"repeatInterval",hZ,this),v(this,"count",fZ,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=1,this._curTime=0}return l(e,[{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._curTime=e}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e,this._remainingCount=e}}]),l(e,[{key:"update",value:function(e,t){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),0<this._remainingCount){var i=Ci(e._time-e.startDelay.evaluate(0,1),e.duration)-t;i=0<i?i:0;var n=Ci(e.time-e.startDelay.evaluate(0,1),e.duration);this._curTime>=i&&this._curTime<n&&(e.emit(this.count.evaluate(this._curTime/e.duration,1),t-(n-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}}},{key:"getMaxCount",value:function(e){return this.count.getMax()*Math.min(Math.ceil(e.duration/this.repeatInterval),this.repeatCount)}}]),e}()).prototype,"_time",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m(sZ.prototype,"time",[_o],Object.getOwnPropertyDescriptor(sZ.prototype,"time"),sZ.prototype),lZ=m(sZ.prototype,"minCount",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),uZ=m(sZ.prototype,"maxCount",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),cZ=m(sZ.prototype,"_repeatCount",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),m(sZ.prototype,"repeatCount",[_o],Object.getOwnPropertyDescriptor(sZ.prototype,"repeatCount"),sZ.prototype),hZ=m(sZ.prototype,"repeatInterval",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),fZ=m(sZ.prototype,"count",[rZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),aZ=sZ))||aZ),cJ=new Ni(0,0,0),hJ=new Array,fJ=new Ni(.5,.5,.5),dJ=(dZ=fo("cc.ShapeModule"),_Z=_o({displayOrder:13}),pZ=_o({displayOrder:14}),vZ=_o({displayOrder:15}),mZ=_o({displayOrder:6}),yZ=_o({displayOrder:5}),gZ=_o({displayOrder:0}),bZ=_o({type:iK,displayOrder:1,formerlySerializedAs:"shapeType"}),xZ=_o({type:iK}),SZ=_o({type:nK,displayOrder:2}),TZ=_o({displayOrder:16}),wZ=_o({displayOrder:17}),EZ=_o({displayOrder:18}),AZ=_o({displayOrder:19}),CZ=_o({displayOrder:3}),kZ=_o({displayOrder:4}),RZ=_o({type:rK,displayOrder:7}),OZ=_o({displayOrder:9}),MZ=_o({type:qY,displayOrder:10}),IZ=_o({displayOrder:11}),BZ=_o({displayOrder:12}),dZ((m((PZ=function(){function e(){y(this,e),v(this,"enable",FZ,this),v(this,"_shapeType",zZ,this),v(this,"emitFrom",DZ,this),v(this,"alignToDirection",NZ,this),v(this,"randomDirectionAmount",UZ,this),v(this,"sphericalDirectionAmount",VZ,this),v(this,"randomPositionAmount",GZ,this),v(this,"radius",HZ,this),v(this,"radiusThickness",WZ,this),v(this,"arcMode",qZ,this),v(this,"arcSpread",jZ,this),v(this,"arcSpeed",XZ,this),v(this,"length",YZ,this),v(this,"boxThickness",KZ,this),v(this,"_position",QZ,this),v(this,"_rotation",ZZ,this),v(this,"_scale",JZ,this),v(this,"_arc",$Z,this),v(this,"_angle",eJ,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new Pn,this.quat=new fn,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}return l(e,[{key:"position",get:function(){return this._position},set:function(e){this._position=e,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation=e,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.constructMat()}},{key:"arc",get:function(){return gi(this._arc)},set:function(e){this._arc=yi(e)}},{key:"angle",get:function(){return Math.round(100*gi(this._angle))/100},set:function(e){this._angle=yi(e)}},{key:"shapeType",get:function(){return this._shapeType},set:function(e){switch(this._shapeType=e,this._shapeType){case iK.Box:this.emitFrom===nK.Base&&(this.emitFrom=nK.Volume);break;case iK.Cone:this.emitFrom===nK.Edge&&(this.emitFrom=nK.Base);break;case iK.Sphere:case iK.Hemisphere:this.emitFrom!==nK.Base&&this.emitFrom!==nK.Edge||(this.emitFrom=nK.Volume)}}}]),l(e,[{key:"onInit",value:function(e){this.particleSystem=e,this.constructMat(),this.lastTime=this.particleSystem._time}},{key:"emit",value:function(e){switch(this.shapeType){case iK.Box:!function(e,t,i,n){switch(e){case nK.Volume:!function(e,t){Ni.set(e,xi(-t.x,t.x),xi(-t.y,t.y),xi(-t.z,t.z))}(i,fJ);break;case nK.Shell:hJ.splice(0,hJ.length),hJ.push(xi(-.5,.5)),hJ.push(xi(-.5,.5)),hJ.push(.5*_K()),dK(hJ),_J(hJ,t),Ni.set(i,hJ[0],hJ[1],hJ[2]);break;case nK.Edge:hJ.splice(0,hJ.length),hJ.push(xi(-.5,.5)),hJ.push(.5*_K()),hJ.push(.5*_K()),dK(hJ),_J(hJ,t),Ni.set(i,hJ[0],hJ[1],hJ[2]);break;default:console.warn(e+" is not supported for box emitter.")}Ni.copy(n,oK)}(this.emitFrom,this.boxThickness,e.position,e.velocity);break;case iK.Circle:!function(e,t,i,n,r){fK(n,e*(1-t),e,i),Ni.normalize(r,n)}(this.radius,this.radiusThickness,this.generateArcAngle(),e.position,e.velocity);break;case iK.Cone:!function(e,t,i,n,r,a,s,o){switch(e){case nK.Base:fK(s,t*(1-i),t,n),Ii.multiplyScalar(o,s,Math.sin(r)),o.z=-Math.cos(r)*t,Ni.normalize(o,o),s.z=0;break;case nK.Shell:uK(s,n),Ii.multiplyScalar(o,s,Math.sin(r)),o.z=-Math.cos(r),Ni.normalize(o,o),Ii.multiplyScalar(s,s,t),s.z=0;break;case nK.Volume:fK(s,t*(1-i),t,n),Ii.multiplyScalar(o,s,Math.sin(r)),o.z=-Math.cos(r)*t,Ni.normalize(o,o),s.z=0,Ni.add(s,s,Ni.multiplyScalar(cJ,o,a*bi()/-o.z));break;default:console.warn(e+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,e.position,e.velocity);break;case iK.Sphere:!function(e,t,i,n,r){switch(e){case nK.Volume:hK(n,t*(1-i),t),Ni.copy(r,n),Ni.normalize(r,r);break;case nK.Shell:cK(n),Ni.multiplyScalar(n,n,t),Ni.copy(r,n);break;default:console.warn(e+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;case iK.Hemisphere:!function(e,t,i,n,r){switch(e){case nK.Volume:hK(n,t*(1-i),t),0<n.z&&(n.z*=-1),Ni.copy(r,n),Ni.normalize(r,r);break;case nK.Shell:cK(n),Ni.multiplyScalar(n,n,t),0<n.z&&(n.z*=-1),Ni.copy(r,n);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(0<this.randomPositionAmount&&(e.position.x+=xi(-this.randomPositionAmount,this.randomPositionAmount),e.position.y+=xi(-this.randomPositionAmount,this.randomPositionAmount),e.position.z+=xi(-this.randomPositionAmount,this.randomPositionAmount)),Ni.transformQuat(e.velocity,e.velocity,this.quat),Ni.transformMat4(e.position,e.position,this.mat),0<this.sphericalDirectionAmount){var t=Ni.normalize(cJ,e.position);Ni.lerp(e.velocity,e.velocity,t,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time}},{key:"constructMat",value:function(){fn.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),Pn.fromRTS(this.mat,this.quat,this._position,this._scale)}},{key:"generateArcAngle",value:function(){if(this.arcMode===rK.Random)return xi(0,this._arc);var e=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=e,0!==this.arcSpread&&(e=Math.floor(e/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case rK.Loop:return Ci(e,this._arc);case rK.PingPong:return ki(e,this._arc)}}}]),e}()).prototype,"position",[_Z],Object.getOwnPropertyDescriptor(PZ.prototype,"position"),PZ.prototype),m(PZ.prototype,"rotation",[pZ],Object.getOwnPropertyDescriptor(PZ.prototype,"rotation"),PZ.prototype),m(PZ.prototype,"scale",[vZ],Object.getOwnPropertyDescriptor(PZ.prototype,"scale"),PZ.prototype),m(PZ.prototype,"arc",[mZ],Object.getOwnPropertyDescriptor(PZ.prototype,"arc"),PZ.prototype),m(PZ.prototype,"angle",[yZ],Object.getOwnPropertyDescriptor(PZ.prototype,"angle"),PZ.prototype),FZ=m(PZ.prototype,"enable",[gZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zZ=m(PZ.prototype,"_shapeType",[bZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iK.Cone}}),m(PZ.prototype,"shapeType",[xZ],Object.getOwnPropertyDescriptor(PZ.prototype,"shapeType"),PZ.prototype),DZ=m(PZ.prototype,"emitFrom",[SZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nK.Volume}}),NZ=m(PZ.prototype,"alignToDirection",[TZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UZ=m(PZ.prototype,"randomDirectionAmount",[wZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VZ=m(PZ.prototype,"sphericalDirectionAmount",[EZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GZ=m(PZ.prototype,"randomPositionAmount",[AZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HZ=m(PZ.prototype,"radius",[CZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),WZ=m(PZ.prototype,"radiusThickness",[kZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qZ=m(PZ.prototype,"arcMode",[RZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rK.Random}}),jZ=m(PZ.prototype,"arcSpread",[OZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),XZ=m(PZ.prototype,"arcSpeed",[MZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),YZ=m(PZ.prototype,"length",[IZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),KZ=m(PZ.prototype,"boxThickness",[BZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni(0,0,0)}}),QZ=m(PZ.prototype,"_position",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni(0,0,0)}}),ZZ=m(PZ.prototype,"_rotation",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni(0,0,0)}}),JZ=m(PZ.prototype,"_scale",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni(1,1,1)}}),$Z=m(PZ.prototype,"_arc",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yi(360)}}),eJ=m(PZ.prototype,"_angle",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yi(25)}}),LZ=PZ))||LZ);function _J(e,t){0<t.x&&(e[0]+=.5*xi(-t.x,t.x),e[0]=pi(e[0],-.5,.5)),0<t.y&&(e[1]+=.5*xi(-t.y,t.y),e[1]=pi(e[1],-.5,.5)),0<t.z&&(e[2]+=.5*xi(-t.z,t.z),e[2]=pi(e[2],-.5,.5))}function pJ(e){y(this,pJ),this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=e,this.position=new Ni(0,0,0),this.velocity=new Ni(0,0,0),this.animatedVelocity=new Ni(0,0,0),this.ultimateVelocity=new Ni(0,0,0),this.angularVelocity=new Ni(0,0,0),this.axisOfRotation=new Ni(0,0,0),this.rotation=new Ni(0,0,0),this.startSize=new Ni(0,0,0),this.size=new Ni(0,0,0),this.startColor=ar.WHITE.clone(),this.color=ar.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}var vJ,mJ,yJ,gJ,bJ,xJ,SJ,TJ,wJ,EJ,AJ,CJ,kJ,RJ,OJ,MJ,IJ,BJ,LJ,PJ,FJ,zJ,DJ,NJ,UJ,VJ,GJ,HJ,WJ,qJ,jJ,XJ,YJ,KJ,QJ,ZJ,JJ,$J,e$,t$,i$,n$,r$,a$,s$,o$,l$,u$,c$,h$=function(){function n(e,t){var i;return y(this,n),(i=x(this,g(n).call(this,e,t)))._capacity=void 0,i._vertAttrs=void 0,i._vertSize=void 0,i._vBuffer=void 0,i._vertAttrsFloatCount=void 0,i._vdataF32=void 0,i._vdataUint32=void 0,i._iaInfo=void 0,i._iaInfoBuffer=void 0,i._subMeshData=void 0,i._mesh=void 0,i._vertCount=0,i._indexCount=0,i._type="particle-batch",i._capacity=0,i._vertAttrs=null,i._vertSize=0,i._vBuffer=null,i._vertAttrsFloatCount=0,i._vdataF32=null,i._vdataUint32=null,i._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},i._iaInfoBuffer=i._device.createBuffer({usage:su.INDIRECT,memUsage:lu.HOST|lu.DEVICE,size:56,stride:1}),i._subMeshData=null,i._mesh=null,i}return _(n,Hf),l(n,[{key:"setCapacity",value:function(e){var t=this._capacity!==e;this._capacity=e,this._inited&&t&&this._recreateBuffer()}},{key:"setVertexAttributes",value:function(e,t){if(this._mesh!==e||this._vertAttrs!==t){this._mesh=e,this._vertAttrs=t,this._vertSize=0;var i=this._vertAttrs,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.offset=this._vertSize,this._vertSize+=xc[s.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this._createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer),this._inited=!0}}},{key:"_createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var e=this._device.createBuffer({usage:su.VERTEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh){var i=this._vertAttrs.findIndex(function(e){return e.name===eu.ATTR_TEX_COORD3}),n=this._vertAttrs[i++].offset;if(this._mesh.copyAttribute(0,eu.ATTR_POSITION,t,this._vertSize,n),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,eu.ATTR_NORMAL,t,this._vertSize,n),n=this._vertAttrs[this._vertAttrs.findIndex(function(e){return e.name===eu.ATTR_TEX_COORD})].offset,this._mesh.copyAttribute(0,eu.ATTR_TEX_COORD,t,this._vertSize,n),n=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,eu.ATTR_COLOR,t,this._vertSize,n))for(var r=new Uint32Array(t),a=0;a<this._vertCount;++a)r[a*this._vertAttrsFloatCount+n/4]=ar.WHITE._val;for(var s=new Float32Array(t),o=1;o<this._capacity;o++)s.copyWithin(o*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}e.update(t);var l=new Uint16Array(this._capacity*this._indexCount);if(this._mesh){this._mesh.copyIndices(0,l);for(var u=1;u<this._capacity;u++)for(var c=0;c<this._indexCount;c++)l[u*this._indexCount+c]=l[c]+u*this._vertCount}else for(var h=0,f=0;f<this._capacity;++f){var d=4*f;l[h++]=d,l[h++]=1+d,l[h++]=2+d,l[h++]=3+d,l[h++]=2+d,l[h++]=1+d}var _=this._device.createBuffer({usage:su.INDEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return _.update(l),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[e],indexBuffer:_,indirectBuffer:this._iaInfoBuffer,attributes:this._vertAttrs,primitiveMode:_u.TRIANGLE_LIST,flatBuffers:[]},this.setSubModelMesh(0,this._subMeshData),t}},{key:"setSubModelMaterial",value:function(e,t){this.initLocalBindings(t),p(g(n.prototype),"setSubModelMaterial",this).call(this,e,t)}},{key:"addParticleVertexData",value:function(e,t){if(this._mesh)for(var i=0;i<this._vertCount;i++){var n=(e*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[n++]=t[0].x,this._vdataF32[n++]=t[0].y,this._vdataF32[n++]=t[0].z,n+=2,this._vdataF32[n++]=t[1].z,this._vdataF32[n++]=t[2].x,this._vdataF32[n++]=t[2].y,this._vdataF32[n++]=t[2].z,this._vdataF32[n++]=t[3].x,this._vdataF32[n++]=t[3].y,this._vdataF32[n++]=t[3].z,this._vdataUint32[n++]=t[4]}else{var r=e*this._vertAttrsFloatCount;this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=t[1].x,this._vdataF32[r++]=t[1].y,this._vdataF32[r++]=t[1].z,this._vdataF32[r++]=t[2].x,this._vdataF32[r++]=t[2].y,this._vdataF32[r++]=t[2].z,this._vdataF32[r++]=t[3].x,this._vdataF32[r++]=t[3].y,this._vdataF32[r++]=t[3].z,this._vdataUint32[r++]=t[4],t[5]&&(this._vdataF32[r++]=t[5].x,this._vdataF32[r++]=t[5].y,this._vdataF32[r++]=t[5].z)}}},{key:"updateIA",value:function(e){this.getSubModel(0).inputAssembler.vertexBuffers[0].update(this._vdataF32),this.getSubModel(0).inputAssembler.indexCount=this._indexCount*e,this.getSubModel(0).inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}},{key:"clear",value:function(){this.getSubModel(0).inputAssembler.indexCount=0}},{key:"destroy",value:function(){p(g(n.prototype),"destroy",this).call(this),this._vBuffer=null,this._vdataF32=null,this._subMeshData&&this.destroySubMeshData(),this._iaInfoBuffer.destroy(),this._subMeshData=null}},{key:"_recreateBuffer",value:function(){this._vBuffer=this._createSubMeshData(),this.getSubModel(0).updateCommandBuffer(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"destroySubMeshData",value:function(){var e=this._subMeshData.vertexBuffers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._subMeshData.indexBuffer.destroy()}}]),n}(),f$=new Ni,d$=(new Ii,new Pn),_$=[0,0,1,0,0,1,1,1],p$="CC_USE_WORLD_SPACE",v$="CC_USE_BILLBOARD",m$="CC_USE_STRETCHED_BILLBOARD",y$="CC_USE_HORIZONTAL_BILLBOARD",g$="CC_USE_VERTICAL_BILLBOARD",b$="CC_USE_MESH",x$=[{name:eu.ATTR_POSITION,format:ru.RGB32F},{name:eu.ATTR_TEX_COORD,format:ru.RGB32F},{name:eu.ATTR_TEX_COORD1,format:ru.RGB32F},{name:eu.ATTR_TEX_COORD2,format:ru.RGB32F},{name:eu.ATTR_COLOR,format:ru.RGBA8,isNormalized:!0}],S$=[{name:eu.ATTR_POSITION,format:ru.RGB32F},{name:eu.ATTR_TEX_COORD,format:ru.RGB32F},{name:eu.ATTR_TEX_COORD1,format:ru.RGB32F},{name:eu.ATTR_TEX_COORD2,format:ru.RGB32F},{name:eu.ATTR_COLOR,format:ru.RGBA8,isNormalized:!0},{name:eu.ATTR_COLOR1,format:ru.RGB32F}],T$=[{name:eu.ATTR_POSITION,format:ru.RGB32F},{name:eu.ATTR_TEX_COORD,format:ru.RGB32F},{name:eu.ATTR_TEX_COORD1,format:ru.RGB32F},{name:eu.ATTR_TEX_COORD2,format:ru.RGB32F},{name:eu.ATTR_COLOR,format:ru.RGBA8,isNormalized:!0},{name:eu.ATTR_TEX_COORD3,format:ru.RGB32F},{name:eu.ATTR_NORMAL,format:ru.RGB32F},{name:eu.ATTR_COLOR1,format:ru.RGBA8,isNormalized:!0}],w$=(vJ=fo("cc.ParticleSystemRenderer"),mJ=_o({type:tK,displayOrder:0}),yJ=_o({displayOrder:1}),gJ=_o({displayOrder:2}),bJ=_o({type:tK,displayOrder:3}),xJ=_o({displayOrder:4}),SJ=_o({displayOrder:5}),TJ=_o({displayOrder:6}),wJ=_o({type:cc.ParticleSystemComponent,visible:!1}),EJ=_o({type:ff,displayOrder:7}),AJ=_o({type:F_,displayOrder:8}),CJ=_o({type:F_,displayOrder:9}),vJ((m((RJ=function(){function e(){y(this,e),v(this,"_renderMode",OJ,this),v(this,"_velocityScale",MJ,this),v(this,"_lengthScale",IJ,this),v(this,"_mesh",BJ,this),v(this,"_particleSystem",LJ,this),this._defines=void 0,this._trailDefines=void 0,this._model=void 0,this.frameTile_velLenScale=void 0,this._node_scale=void 0,this.attrs=void 0,this._vertAttrs=[],this._particles=null,this._defaultMat=null,this._defaultTrailMat=null,this._model=null,this.frameTile_velLenScale=new Xi(1,1,0,0),this._node_scale=new Xi,this.attrs=new Array(5),this._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},this._trailDefines={CC_USE_WORLD_SPACE:!0}}return l(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode!==e&&(this._renderMode=e,this._setVertexAttrib(),this._updateModel(),this._updateMaterialParams())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(e){this._velocityScale=e,this._updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(e){this._lengthScale=e,this._updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this._model&&this._model.setVertexAttributes(this._renderMode===tK.Mesh?this._mesh:null,this._vertAttrs)}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(e){this._particleSystem.setMaterial(e,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(e){this._particleSystem.setMaterial(e,1)}}]),l(e,[{key:"onInit",value:function(e){var t=this;this._particleSystem=e,this._particles=new Os(function(){return new pJ(t)},16),this._setVertexAttrib(),this.onEnable(),this._updateModel(),this._updateMaterialParams(),this._updateTrailMaterial()}},{key:"onEnable",value:function(){this._particleSystem&&(null==this._model&&(this._model=this._particleSystem._getRenderScene().createModel(h$,this._particleSystem.node),this._model.visFlags=this._particleSystem.visibility),this._model.inited||(this._model.setCapacity(this._particleSystem.capacity),this._model.node=this._particleSystem.node),this._model.enabled=this._particleSystem.enabledInHierarchy)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=this._particleSystem.enabledInHierarchy)}},{key:"onDestroy",value:function(){this._model&&(this._model.scene.destroyModel(this._model),this._model=null)}},{key:"clear",value:function(){this._particles.reset(),this._updateRenderData()}},{key:"_getFreeParticle",value:function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()}},{key:"_setNewParticle",value:function(e){}},{key:"_updateParticles",value:function(e){switch(this._particleSystem.node.getWorldMatrix(d$),this._particleSystem.scaleSpace){case eK.Local:this._particleSystem.node.getScale(this._node_scale);break;case eK.World:this._particleSystem.node.getWorldScale(this._node_scale)}(this._particleSystem.sharedMaterial?this.particleMaterial:this._defaultMat).setProperty("scale",this._node_scale),this._particleSystem.velocityOvertimeModule.enable&&this._particleSystem.velocityOvertimeModule.update(this._particleSystem._simulationSpace,d$),this._particleSystem.forceOvertimeModule.enable&&this._particleSystem.forceOvertimeModule.update(this._particleSystem._simulationSpace,d$),this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.update();for(var t=0;t<this._particles.length;++t){var i=this._particles.data[t];i.remainingLifetime-=e,Ni.set(i.animatedVelocity,0,0,0),i.remainingLifetime<0?(this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.removeParticle(i),this._particles.removeAt(t),--t):(i.velocity.y-=9.8*this._particleSystem.gravityModifier.evaluate(1-i.remainingLifetime/i.startLifetime,i.randomSeed)*e,this._particleSystem.sizeOvertimeModule.enable&&this._particleSystem.sizeOvertimeModule.animate(i),this._particleSystem.colorOverLifetimeModule.enable&&this._particleSystem.colorOverLifetimeModule.animate(i),this._particleSystem.forceOvertimeModule.enable&&this._particleSystem.forceOvertimeModule.animate(i,e),this._particleSystem.velocityOvertimeModule.enable?this._particleSystem.velocityOvertimeModule.animate(i):Ni.copy(i.ultimateVelocity,i.velocity),this._particleSystem.limitVelocityOvertimeModule.enable&&this._particleSystem.limitVelocityOvertimeModule.animate(i),this._particleSystem.rotationOvertimeModule.enable&&this._particleSystem.rotationOvertimeModule.animate(i,e),this._particleSystem.textureAnimationModule.enable&&this._particleSystem.textureAnimationModule.animate(i),Ni.scaleAndAdd(i.position,i.position,i.ultimateVelocity,e),this._particleSystem.trailModule.enable&&this._particleSystem.trailModule.animate(i,e))}return this._particles.length}},{key:"_updateRenderData",value:function(){for(var e=0,t=this._renderMode===tK.StrecthedBillboard,i=0;i<this._particles.length;++i){var n=this._particles.data[i],r=0;this._particleSystem.textureAnimationModule.enable&&(r=n.frameIndex),e=4*i;var a=0;if(this._renderMode!==tK.Mesh)for(var s=0;s<4;++s)a=0,this.attrs[a++]=n.position,f$.x=_$[2*s],f$.y=_$[2*s+1],f$.z=r,this.attrs[a++]=f$,this.attrs[a++]=n.size,this.attrs[a++]=n.rotation,this.attrs[a++]=n.color._val,this.attrs[a++]=t?n.ultimateVelocity:null,this._model.addParticleVertexData(e++,this.attrs);else a=0,this.attrs[a++]=n.position,f$.z=r,this.attrs[a++]=f$,this.attrs[a++]=n.size,this.attrs[a++]=n.rotation,this.attrs[a++]=n.color._val,this._model.addParticleVertexData(i,this.attrs)}this._model.updateIA(this._particles.length)}},{key:"updateShaderUniform",value:function(){}},{key:"getParticleCount",value:function(){return this._particles.length}},{key:"_onMaterialModified",value:function(e,t){0===e?(this._updateModel(),this._updateMaterialParams()):this._updateTrailMaterial()}},{key:"_onRebuildPSO",value:function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t),this._particleSystem.trailModule._trailModel&&1===e&&this._particleSystem.trailModule._trailModel.setSubModelMaterial(0,t)}},{key:"_setVertexAttrib",value:function(){switch(this._renderMode){case tK.StrecthedBillboard:this._vertAttrs=S$.slice();break;case tK.Mesh:this._vertAttrs=T$.slice();break;default:this._vertAttrs=x$.slice()}}},{key:"_updateMaterialParams",value:function(){if(this._particleSystem){null!=this._particleSystem.sharedMaterial&&-1===this._particleSystem.sharedMaterial._effectAsset._name.indexOf("particle")&&this._particleSystem.setMaterial(null,0,!1),null==this._particleSystem.sharedMaterial&&null==this._defaultMat&&(this._defaultMat=F_.getInstantiatedMaterial(t_.get("default-particle-material"),this._particleSystem,!0));var e=this._particleSystem.sharedMaterial?this.particleMaterial:this._defaultMat;this._particleSystem._simulationSpace===eK.World?this._defines[p$]=!0:this._defines[p$]=!1,this._renderMode===tK.Billboard?(this._defines[v$]=!0,this._defines[m$]=!1,this._defines[y$]=!1,this._defines[g$]=!1,this._defines[b$]=!1):this._renderMode===tK.StrecthedBillboard?(this._defines[v$]=!1,this._defines[m$]=!0,this._defines[y$]=!1,this._defines[g$]=!1,this._defines[b$]=!1,this.frameTile_velLenScale.z=this._velocityScale,this.frameTile_velLenScale.w=this._lengthScale):this._renderMode===tK.HorizontalBillboard?(this._defines[v$]=!1,this._defines[m$]=!1,this._defines[y$]=!0,this._defines[g$]=!1,this._defines[b$]=!1):this._renderMode===tK.VerticalBillboard?(this._defines[v$]=!1,this._defines[m$]=!1,this._defines[y$]=!1,this._defines[g$]=!0,this._defines[b$]=!1):this._renderMode===tK.Mesh?(this._defines[v$]=!1,this._defines[m$]=!1,this._defines[y$]=!1,this._defines[g$]=!1,this._defines[b$]=!0):console.warn("particle system renderMode ".concat(this._renderMode," not support.")),this._particleSystem.textureAnimationModule.enable&&Ii.set(this.frameTile_velLenScale,this._particleSystem.textureAnimationModule.numTilesX,this._particleSystem.textureAnimationModule.numTilesY),e.setProperty("frameTile_velLenScale",this.frameTile_velLenScale),e.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,this._particleSystem.sharedMaterial||this._defaultMat)}}},{key:"_updateTrailMaterial",value:function(){if(this._particleSystem.trailModule.enable){this._particleSystem._simulationSpace===eK.World||this._particleSystem.trailModule.space===eK.World?this._trailDefines[p$]=!0:this._trailDefines[p$]=!1;var e=this.trailMaterial;null===e&&null===this._defaultTrailMat&&(this._defaultTrailMat=F_.getInstantiatedMaterial(t_.get("default-trail-material"),this._particleSystem,!0)),null===e&&(e=this._defaultTrailMat),e.recompileShaders(this._trailDefines),this._particleSystem.trailModule._updateMaterial()}}},{key:"_updateModel",value:function(){this._model&&this._model.setVertexAttributes(this._renderMode===tK.Mesh?this._mesh:null,this._vertAttrs)}}]),e}()).prototype,"renderMode",[mJ],Object.getOwnPropertyDescriptor(RJ.prototype,"renderMode"),RJ.prototype),m(RJ.prototype,"velocityScale",[yJ],Object.getOwnPropertyDescriptor(RJ.prototype,"velocityScale"),RJ.prototype),m(RJ.prototype,"lengthScale",[gJ],Object.getOwnPropertyDescriptor(RJ.prototype,"lengthScale"),RJ.prototype),OJ=m(RJ.prototype,"_renderMode",[bJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tK.Billboard}}),MJ=m(RJ.prototype,"_velocityScale",[xJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),IJ=m(RJ.prototype,"_lengthScale",[SJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),BJ=m(RJ.prototype,"_mesh",[TJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LJ=m(RJ.prototype,"_particleSystem",[wJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m(RJ.prototype,"mesh",[EJ],Object.getOwnPropertyDescriptor(RJ.prototype,"mesh"),RJ.prototype),m(RJ.prototype,"particleMaterial",[AJ],Object.getOwnPropertyDescriptor(RJ.prototype,"particleMaterial"),RJ.prototype),m(RJ.prototype,"trailMaterial",[CJ],Object.getOwnPropertyDescriptor(RJ.prototype,"trailMaterial"),RJ.prototype),kJ=RJ))||kJ);Object.assign(w$,{uv:_$});var E$,A$,C$,k$,R$,O$,M$,I$,B$,L$,P$,F$,z$,D$,N$,U$,V$,G$,H$,W$,q$,j$,X$,Y$,K$,Q$,Z$,J$,$$,e0,t0,i0,n0,r0,a0,s0,o0,l0,u0,c0,h0,f0,d0,_0,p0,v0,m0,y0,g0,b0,x0,S0,T0,w0,E0,A0,C0,k0,R0,O0,M0,I0,B0,L0,P0,F0,z0,D0,N0,U0,V0,G0,H0,W0,q0,j0,X0,Y0,K0=Math.cos(yi(100)),Q0={position:new Ni,velocity:new Ni},Z0=new fn,J0=new Pn,$0=new Ni,e1=new Ni,t1=new ar,i1=function(){function t(e){for(y(this,t),this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];e--;)this.trailElements.push({position:new Ni,lifetime:0,width:0,velocity:new Ni,direction:0,color:new ar})}return l(t,[{key:"getElement",value:function(e){return-1===this.start?null:(e<0&&(e=(e+this.trailElements.length)%this.trailElements.length),e>=this.trailElements.length&&(e%=this.trailElements.length),this.trailElements[e])}},{key:"addElement",value:function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new Ni,lifetime:0,width:0,velocity:new Ni,direction:0,color:new ar}),this.start++,this.start%=this.trailElements.length);var e=this.end++;return this.end%=this.trailElements.length,this.trailElements[e]}},{key:"iterateElement",value:function(e,t,i,n){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,a=this.start;a<r;a++)t(e,this.trailElements[a%this.trailElements.length],i,n)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)}},{key:"count",value:function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start}},{key:"clear",value:function(){this.start=-1,this.end=-1}}]),t}(),n1=(PJ=fo("cc.TrailModule"),FJ=_o({displayOrder:0}),zJ=_o({type:aK,displayOrder:1}),DJ=_o({type:qY,displayOrder:3}),NJ=_o({displayOrder:5}),UJ=_o({type:eK,displayOrder:6}),VJ=_o({displayOrder:7}),GJ=_o({type:sK,displayOrder:8}),HJ=_o({displayOrder:9}),WJ=_o({type:qY,displayOrder:10}),qJ=_o({displayOrder:11}),jJ=_o({type:KY,displayOrder:12}),XJ=_o({type:KY,displayOrder:13}),YJ=_o({type:eK}),KJ=_o({type:cc.ParticleSystemComponent,visible:!1}),PJ((m((ZJ=function(){function a(){y(this,a),v(this,"_enable",JJ,this),v(this,"mode",$J,this),v(this,"lifeTime",e$,this),v(this,"_minParticleDistance",t$,this),v(this,"existWithParticles",i$,this),v(this,"textureMode",n$,this),v(this,"widthFromParticle",r$,this),v(this,"widthRatio",a$,this),v(this,"colorFromParticle",s$,this),v(this,"colorOverTrail",o$,this),v(this,"colorOvertime",l$,this),v(this,"_space",u$,this),v(this,"_particleSystem",c$,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._defaultMat=null,this._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},this._vertAttrs=[{name:eu.ATTR_POSITION,format:ru.RGB32F},{name:eu.ATTR_TEX_COORD,format:ru.RGBA32F},{name:eu.ATTR_TEX_COORD1,format:ru.RGB32F},{name:eu.ATTR_COLOR,format:ru.RGBA8,isNormalized:!0}],this._vertSize=0;var e=this._vertAttrs,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;this._vertSize+=xc[r.format].size}this._particleTrail=new Map}return l(a,[{key:"enable",get:function(){return this._enable},set:function(e){e&&!this._trailModel&&this._createModel(),e&&!this._enable&&(this._enable=e,this._particleSystem.renderer._updateTrailMaterial()),this._enable=e,this._trailModel&&(this._trailModel.enabled=e)}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(e){this._minParticleDistance=e,this._minSquaredDistance=e*e}},{key:"space",get:function(){return this._space},set:function(e){this._space=e,this._particleSystem&&this._particleSystem.renderer._updateTrailMaterial()}}]),l(a,[{key:"onInit",value:function(e){this._particleSystem=e,this.minParticleDistance=this._minParticleDistance;var t=0,i=this._particleSystem.bursts,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}t+=a.getMaxCount(this._particleSystem)}this._trailNum=Math.ceil(this._particleSystem.startLifetime.getMax()*this.lifeTime.getMax()*60*(this._particleSystem.rateOverTime.getMax()*this._particleSystem.duration+t)),this._trailSegments=new Rs(function(){return new i1(10)},Math.ceil(this._particleSystem.rateOverTime.getMax()*this._particleSystem.duration)),this._enable&&(this.enable=this._enable,this._updateMaterial())}},{key:"onEnable",value:function(){this._enable&&this._trailModel&&(this._trailModel.enabled=!0)}},{key:"onDisable",value:function(){this._enable&&this._trailModel&&(this._trailModel.enabled=!1)}},{key:"destroy",value:function(){this._trailModel&&(this._trailModel.scene.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.clear(function(e){e.trailElements.length=0}),this._trailSegments=null)}},{key:"clear",value:function(){if(this.enable){for(var e=this._particleTrail.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._particleTrail.clear(),this.updateRenderData()}}},{key:"_updateMaterial",value:function(){if(this._particleSystem&&this._trailModel){var e=this._particleSystem.renderer.trailMaterial;e?this._trailModel.setSubModelMaterial(0,e):this._trailModel.setSubModelMaterial(0,this._particleSystem.renderer._defaultTrailMat)}}},{key:"update",value:function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===eK.World&&this._particleSystem._simulationSpace===eK.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(J0),this._particleSystem.node.getWorldRotation(Z0)):this._needTransform=!1}},{key:"animate",value:function(e,t){if(this._trailSegments){var i=this._particleTrail.get(e);i||(i=this._trailSegments.alloc(),this._particleTrail.set(e,i));var n=i.getElement(i.end-1);if(this._needTransform?Ni.transformMat4($0,e.position,J0):Ni.copy($0,e.position),!(n&&(i.iterateElement(this,this._updateTrailElement,e,t),Ni.squaredDistance(n.position,$0)<this._minSquaredDistance))&&(n=i.addElement())){Ni.copy(n.position,$0),n.lifetime=0,this.widthFromParticle?n.width=e.size.x*this.widthRatio.evaluate(0,1):n.width=this.widthRatio.evaluate(0,1);var r=i.count();if(2===r){var a=i.getElement(i.end-2);Ni.subtract(a.velocity,n.position,a.position)}else if(2<r){var s=i.getElement(i.end-2),o=i.getElement(i.end-3);Ni.subtract($0,o.position,s.position),Ni.subtract(e1,n.position,s.position),Ni.subtract(s.velocity,e1,$0),Ni.equals(Ni.ZERO,s.velocity)&&Ni.copy(s.velocity,$0),Ni.normalize(s.velocity,s.velocity),this._checkDirectionReverse(s,o)}this.colorFromParticle?n.color.set(e.color):n.color.set(this.colorOvertime.evaluate(0,1))}}}},{key:"removeParticle",value:function(e){var t=this._particleTrail.get(e);t&&this._trailSegments&&(t.clear(),this._trailSegments.free(t),this._particleTrail.delete(e))}},{key:"updateRenderData",value:function(){this.vbOffset=0,this.ibOffset=0;var e=this._particleTrail.keys(),t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=this._particleTrail.get(r);if(-1!==a.start){var s=4*this.vbOffset/this._vertSize,o=a.start>=a.end?a.end+a.trailElements.length:a.end,l=o-a.start,u=1/l,c=a.trailElements[a.start];this._fillVertexBuffer(c,this.colorOverTrail.evaluate(1,1),s,1,0,4);for(var h=a.start+1;h<o;h++){var f=a.trailElements[h%a.trailElements.length],d=h-a.start;this._fillVertexBuffer(f,this.colorOverTrail.evaluate(1-d/l,1),s,1-d*u,d,5)}if(this._needTransform?Ni.transformMat4(Q0.position,r.position,J0):Ni.copy(Q0.position,r.position),1==l||2==l){var _=a.getElement(a.end-1);Ni.subtract(_.velocity,Q0.position,_.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=_.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=_.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=_.velocity.z,this._vbF32[this.vbOffset-4]=_.velocity.x,this._vbF32[this.vbOffset-3]=_.velocity.y,this._vbF32[this.vbOffset-2]=_.velocity.z,Ni.subtract(Q0.velocity,Q0.position,_.position),this._checkDirectionReverse(Q0,_)}else if(2<l){var p=a.getElement(a.end-1),v=a.getElement(a.end-2);Ni.subtract($0,v.position,p.position),Ni.subtract(e1,Q0.position,p.position),Ni.subtract(p.velocity,e1,$0),Ni.normalize(p.velocity,p.velocity),this._checkDirectionReverse(p,v),this._vbF32[this.vbOffset-this._vertSize/4-4]=p.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=p.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=p.velocity.z,this._vbF32[this.vbOffset-4]=p.velocity.x,this._vbF32[this.vbOffset-3]=p.velocity.y,this._vbF32[this.vbOffset-2]=p.velocity.z,Ni.subtract(Q0.velocity,Q0.position,p.position),Ni.normalize(Q0.velocity,Q0.velocity),this._checkDirectionReverse(Q0,p)}Q0.width=r.size.x,Q0.color=r.color,Ni.equals(Q0.velocity,Ni.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(Q0,this.colorOverTrail.evaluate(0,1),s,0,l,1)}}this.updateIA(this.ibOffset)}},{key:"updateIA",value:function(e){if(this._trailModel&&0<this._trailModel.subModelNum){var t=this._trailModel.getSubModel(0);t.inputAssembler.vertexBuffers[0].update(this._vbF32),t.inputAssembler.indexBuffer.update(this._iBuffer),t.inputAssembler.indexCount=e,t.inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}}},{key:"_createModel",value:function(){if(!this._trailModel){var e=kx.root.device,t=e.createBuffer({usage:su.VERTEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:this._vertSize*(this._trailNum+1)*2,stride:this._vertSize}),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),t.update(i);var n=e.createBuffer({usage:su.INDEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:6*this._trailNum*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});this._iBuffer=new Uint16Array(6*this._trailNum),n.update(this._iBuffer),this._iaInfoBuffer=e.createBuffer({usage:su.INDIRECT,memUsage:lu.HOST|lu.DEVICE,size:56,stride:1}),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[t],indexBuffer:n,indirectBuffer:this._iaInfoBuffer,attributes:this._vertAttrs,primitiveMode:_u.TRIANGLE_LIST,flatBuffers:[]},this._trailModel=this._particleSystem._getRenderScene().createModel(Hf,this._particleSystem.node),this._trailModel.visFlags=this._particleSystem.visibility,this._trailModel.setSubModelMesh(0,this._subMeshData),this._trailModel.enabled=!0}}},{key:"_updateTrailElement",value:function(e,t,i,n){return t.lifetime+=n,e.colorFromParticle?(t.color.set(i.color),t.color.multiply(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):t.color.set(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),e.widthFromParticle?t.width=i.size.x*e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1):t.width=e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1),t.lifetime>e._trailLifetime}},{key:"_fillVertexBuffer",value:function(e,t,i,n,r,a){this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,t1.set(e.color),t1.multiply(t),this._vbUint32[this.vbOffset++]=t1._val,this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=1-e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,this._vbUint32[this.vbOffset++]=t1._val,1&a&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r-1,this._iBuffer[this.ibOffset++]=i+2*r+1),4&a&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r+1,this._iBuffer[this.ibOffset++]=i+2*r+2)}},{key:"_checkDirectionReverse",value:function(e,t){Ni.dot(e.velocity,t.velocity)<K0?e.direction=1-t.direction:e.direction=t.direction}}]),a}()).prototype,"enable",[FJ],Object.getOwnPropertyDescriptor(ZJ.prototype,"enable"),ZJ.prototype),JJ=m(ZJ.prototype,"_enable",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$J=m(ZJ.prototype,"mode",[zJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return aK.Particles}}),e$=m(ZJ.prototype,"lifeTime",[DJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),t$=m(ZJ.prototype,"_minParticleDistance",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),m(ZJ.prototype,"minParticleDistance",[NJ],Object.getOwnPropertyDescriptor(ZJ.prototype,"minParticleDistance"),ZJ.prototype),m(ZJ.prototype,"space",[UJ],Object.getOwnPropertyDescriptor(ZJ.prototype,"space"),ZJ.prototype),i$=m(ZJ.prototype,"existWithParticles",[VJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),n$=m(ZJ.prototype,"textureMode",[GJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sK.Stretch}}),r$=m(ZJ.prototype,"widthFromParticle",[HJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),a$=m(ZJ.prototype,"widthRatio",[WJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),s$=m(ZJ.prototype,"colorFromParticle",[qJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),o$=m(ZJ.prototype,"colorOverTrail",[jJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new KY}}),l$=m(ZJ.prototype,"colorOvertime",[XJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new KY}}),u$=m(ZJ.prototype,"_space",[YJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eK.World}}),c$=m(ZJ.prototype,"_particleSystem",[KJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QJ=ZJ))||QJ),r1=new Pn,a1=m4("ParticleSystemComponent",(E$=fo("cc.ParticleSystemComponent"),A$=go("Components/ParticleSystem"),C$=bo(99),k$=_o({displayOrder:1}),R$=_o({type:KY,displayOrder:8}),O$=_o({type:eK,displayOrder:9}),M$=_o({displayOrder:10}),I$=_o({type:qY,displayOrder:10,formerlySerializedAs:"startSize"}),B$=_o({type:qY,displayOrder:10}),L$=_o({type:qY,displayOrder:10}),P$=_o({type:qY,range:[-1,1],displayOrder:11}),F$=_o({displayOrder:12}),z$=_o({type:qY,range:[-1,1],radian:!0,displayOrder:12}),D$=_o({type:qY,range:[-1,1],radian:!0,displayOrder:12}),N$=_o({type:qY,range:[-1,1],radian:!0,displayOrder:12,formerlySerializedAs:"startRotation"}),U$=_o({type:qY,displayOrder:6}),V$=_o({type:qY,displayOrder:7}),G$=_o({displayOrder:0}),H$=_o({displayOrder:2}),W$=_o({displayOrder:3}),q$=_o({type:eK,displayOrder:4}),j$=_o({displayOrder:5}),X$=_o({displayOrder:2}),Y$=_o({type:qY,range:[-1,1],displayOrder:13}),K$=_o({type:qY,displayOrder:14}),Q$=_o({type:qY,displayOrder:15}),Z$=_o({type:[uJ],displayOrder:16}),J$=_o({type:F_,displayName:"Materials",visible:!1,override:!0}),$$=_o({type:$Y,displayOrder:23}),e0=_o({type:dJ,displayOrder:17}),t0=_o({type:iJ,displayOrder:21}),i0=_o({type:lJ,displayOrder:18}),n0=_o({type:KK,displayOrder:19}),r0=_o({type:JK,displayOrder:20}),a0=_o({type:tJ,displayOrder:22}),s0=_o({type:sJ,displayOrder:24}),o0=_o({type:n1,displayOrder:25}),l0=_o({type:w$,displayOrder:26}),E$(u0=A$(u0=C$(u0=mo((m((c0=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"startColor",h0,c(e)),v(e,"scaleSpace",f0,c(e)),v(e,"startSize3D",d0,c(e)),v(e,"startSizeX",_0,c(e)),v(e,"startSizeY",p0,c(e)),v(e,"startSizeZ",v0,c(e)),v(e,"startSpeed",m0,c(e)),v(e,"startRotation3D",y0,c(e)),v(e,"startRotationX",g0,c(e)),v(e,"startRotationY",b0,c(e)),v(e,"startRotationZ",x0,c(e)),v(e,"startDelay",S0,c(e)),v(e,"startLifetime",T0,c(e)),v(e,"duration",w0,c(e)),v(e,"loop",E0,c(e)),v(e,"simulationSpeed",A0,c(e)),v(e,"playOnAwake",C0,c(e)),v(e,"gravityModifier",k0,c(e)),v(e,"rateOverTime",R0,c(e)),v(e,"rateOverDistance",O0,c(e)),v(e,"bursts",M0,c(e)),v(e,"colorOverLifetimeModule",I0,c(e)),v(e,"shapeModule",B0,c(e)),v(e,"sizeOvertimeModule",L0,c(e)),v(e,"velocityOvertimeModule",P0,c(e)),v(e,"forceOvertimeModule",F0,c(e)),v(e,"limitVelocityOvertimeModule",z0,c(e)),v(e,"rotationOvertimeModule",D0,c(e)),v(e,"textureAnimationModule",N0,c(e)),v(e,"trailModule",U0,c(e)),v(e,"renderer",V0,c(e)),e._isPlaying=void 0,e._isPaused=void 0,e._isStopped=void 0,e._isEmitting=void 0,e._time=void 0,e._emitRateTimeCounter=void 0,e._emitRateDistanceCounter=void 0,e._oldWPos=void 0,e._curWPos=void 0,e._customData1=void 0,e._customData2=void 0,e._subEmitters=void 0,v(e,"_prewarm",G0,c(e)),v(e,"_capacity",H0,c(e)),v(e,"_simulationSpace",W0,c(e)),e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSizeX.constant=1,e.startSpeed.constant=5,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new Ni,e._curWPos=new Ni,e._customData1=new Ii,e._customData2=new Ii,e._subEmitters=[],e}return _(t,ZA),l(t,[{key:"capacity",get:function(){return this._capacity},set:function(e){this._capacity=e,this.renderer&&this.renderer._model&&this.renderer._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(e){!0===e&&this.loop,this._prewarm=e}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(e){e!==this._simulationSpace&&(this._simulationSpace=e,this.renderer._updateMaterialParams(),this.renderer._updateTrailMaterial())}},{key:"sharedMaterials",get:function(){return p(g(t.prototype),"sharedMaterials",this)},set:function(e){r(g(t.prototype),"sharedMaterials",e,this,!0)}}]),l(t,[{key:"onLoad",value:function(){this.renderer.onInit(this),this.shapeModule.onInit(this),this.trailModule.onInit(this),this.textureAnimationModule.onInit(this),this._resetPosition()}},{key:"_onMaterialModified",value:function(e,t){this.renderer._onMaterialModified(e,t)}},{key:"_onRebuildPSO",value:function(e,t){this.renderer._onRebuildPSO(e,t)}},{key:"_getModel",value:function(){return this.renderer._model}},{key:"recreateModel",value:function(){if(this.isValid){var e=this.renderer;e&&e._model&&(e._model.scene.destroyModel(e._model),e._model=null,e.onEnable(),e._updateModel(),e._updateMaterialParams(),e._updateTrailMaterial())}}},{key:"play",value:function(){this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem()}},{key:"pause",value:function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)}},{key:"stop",value:function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0}},{key:"clear",value:function(){this.enabledInHierarchy&&(this.renderer.clear(),this.trailModule.clear())}},{key:"getParticleCount",value:function(){return this.renderer.getParticleCount()}},{key:"setCustomData1",value:function(e,t){Ii.set(this._customData1,e,t)}},{key:"setCustomData2",value:function(e,t){Ii.set(this._customData2,e,t)}},{key:"onDestroy",value:function(){this.renderer.onDestroy(),this.trailModule.destroy()}},{key:"onEnable",value:function(){this.playOnAwake&&this.play(),this.renderer.onEnable(),this.trailModule.onEnable()}},{key:"onDisable",value:function(){this.renderer.onDisable(),this.trailModule.onDisable()}},{key:"update",value:function(e){var t=e*this.simulationSpeed;this._isPlaying&&(this._time+=t,this._emit(t),0!==this.renderer._updateParticles(t)||this._isEmitting||this.stop(),this.renderer._updateRenderData(),this.trailModule.enable&&this.trailModule.updateRenderData())}},{key:"_onVisiblityChange",value:function(e){this.renderer._model&&(this.renderer._model.visFlags=e)}},{key:"emit",value:function(e,t){for(var i=0;i<e;++i){var n=this.renderer._getFreeParticle();if(null===n)return;var r=Ti(Si(0,ae));switch(this.shapeModule.enable?this.shapeModule.emit(n):(Ni.set(n.position,0,0,0),Ni.copy(n.velocity,oK)),this.textureAnimationModule.enable&&this.textureAnimationModule.init(n),Ni.multiplyScalar(n.velocity,n.velocity,this.startSpeed.evaluate(this._time/this.duration,r)),this._simulationSpace){case eK.Local:break;case eK.World:this.node.getWorldMatrix(r1),Ni.transformMat4(n.position,n.position,r1);var a=new fn;this.node.getWorldRotation(a),Ni.transformQuat(n.velocity,n.velocity,a);break;case eK.Custom:}Ni.copy(n.ultimateVelocity,n.velocity),this.startRotation3D?Ni.set(n.rotation,this.startRotationX.evaluate(this._time/this.duration,r),this.startRotationY.evaluate(this._time/this.duration,r),this.startRotationZ.evaluate(this._time/this.duration,r)):Ni.set(n.rotation,0,0,this.startRotationZ.evaluate(this._time/this.duration,r)),this.startSize3D?Ni.set(n.startSize,this.startSizeX.evaluate(this._time/this.duration,r),this.startSizeY.evaluate(this._time/this.duration,r),this.startSizeZ.evaluate(this._time/this.duration,r)):(Ni.set(n.startSize,this.startSizeX.evaluate(this._time/this.duration,r),1,1),n.startSize.y=n.startSize.x),Ni.copy(n.size,n.startSize),n.startColor.set(this.startColor.evaluate(this._time/this.duration,r)),n.color.set(n.startColor),n.startLifetime=this.startLifetime.evaluate(this._time/this.duration,r)+t,n.remainingLifetime=n.startLifetime,n.randomSeed=Si(0,233280),this.renderer._setNewParticle(n)}}},{key:"_prewarmSystem",value:function(){this.startDelay.mode=WY.Constant,this.startDelay.constant=0;for(var e=this.duration/1,t=0;t<e;++t)this._time+=1,this._emit(1),this.renderer._updateParticles(1)}},{key:"_emit",value:function(e){var t=this.startDelay.evaluate(0,1);if(this._time>t){if(this._time>this.duration+t&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*e,1<this._emitRateTimeCounter&&this._isEmitting){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i,this.emit(i,e)}this.node.getWorldPosition(this._curWPos);var n=Ni.distance(this._curWPos,this._oldWPos);if(Ni.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=n*this.rateOverDistance.evaluate(this._time/this.duration,1),1<this._emitRateDistanceCounter&&this._isEmitting){var r=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=r,this.emit(r,e)}var a=this.bursts,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.update(this,e)}}}},{key:"_resetPosition",value:function(){this.node.getWorldPosition(this._oldWPos),Ni.copy(this._curWPos,this._oldWPos)}},{key:"addSubEmitter",value:function(e){this._subEmitters.push(e)}},{key:"removeSubEmitter",value:function(e){this._subEmitters.splice(this._subEmitters.indexOf(e),1)}},{key:"addBurst",value:function(e){this.bursts.push(e)}},{key:"removeBurst",value:function(e){this.bursts.splice(this.bursts.indexOf(e),1)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),t}()).prototype,"capacity",[k$],Object.getOwnPropertyDescriptor(c0.prototype,"capacity"),c0.prototype),h0=m(c0.prototype,"startColor",[R$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new KY}}),f0=m(c0.prototype,"scaleSpace",[O$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eK.Local}}),d0=m(c0.prototype,"startSize3D",[M$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_0=m(c0.prototype,"startSizeX",[I$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),p0=m(c0.prototype,"startSizeY",[B$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),v0=m(c0.prototype,"startSizeZ",[L$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),m0=m(c0.prototype,"startSpeed",[P$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),y0=m(c0.prototype,"startRotation3D",[F$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),g0=m(c0.prototype,"startRotationX",[z$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),b0=m(c0.prototype,"startRotationY",[D$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),x0=m(c0.prototype,"startRotationZ",[N$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),S0=m(c0.prototype,"startDelay",[U$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),T0=m(c0.prototype,"startLifetime",[V$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),w0=m(c0.prototype,"duration",[G$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),E0=m(c0.prototype,"loop",[H$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),m(c0.prototype,"prewarm",[W$],Object.getOwnPropertyDescriptor(c0.prototype,"prewarm"),c0.prototype),m(c0.prototype,"simulationSpace",[q$],Object.getOwnPropertyDescriptor(c0.prototype,"simulationSpace"),c0.prototype),A0=m(c0.prototype,"simulationSpeed",[j$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),C0=m(c0.prototype,"playOnAwake",[X$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),k0=m(c0.prototype,"gravityModifier",[Y$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),R0=m(c0.prototype,"rateOverTime",[K$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),O0=m(c0.prototype,"rateOverDistance",[Q$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qY}}),M0=m(c0.prototype,"bursts",[Z$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),m(c0.prototype,"sharedMaterials",[J$],Object.getOwnPropertyDescriptor(c0.prototype,"sharedMaterials"),c0.prototype),I0=m(c0.prototype,"colorOverLifetimeModule",[$$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $Y}}),B0=m(c0.prototype,"shapeModule",[e0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new dJ}}),L0=m(c0.prototype,"sizeOvertimeModule",[t0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new iJ}}),P0=m(c0.prototype,"velocityOvertimeModule",[i0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new lJ}}),F0=m(c0.prototype,"forceOvertimeModule",[n0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new KK}}),z0=m(c0.prototype,"limitVelocityOvertimeModule",[r0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new JK}}),D0=m(c0.prototype,"rotationOvertimeModule",[a0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tJ}}),N0=m(c0.prototype,"textureAnimationModule",[s0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new sJ}}),U0=m(c0.prototype,"trailModule",[o0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new n1}}),V0=m(c0.prototype,"renderer",[l0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w$}}),G0=m(c0.prototype,"_prewarm",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),H0=m(c0.prototype,"_capacity",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),W0=m(c0.prototype,"_simulationSpace",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eK.Local}}),u0=c0))||u0)||u0)||u0)||u0)),s1=m4("ParticleUtils",function(){function e(){y(this,e)}return l(e,null,[{key:"instantiate",value:function(e){return this.registeredSceneEvent||(kx.on(Cx.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(e._uuid)||this.particleSystemPool.set(e._uuid,new Rs(function(){return Zo(e)},1)),this.particleSystemPool.get(e._uuid).alloc()}},{key:"destroy",value:function(e){this.particleSystemPool.has(e._prefab.asset._uuid)&&(this.stop(e),this.particleSystemPool.get(e._prefab.asset._uuid).free(e))}},{key:"onSceneUnload",value:function(){this.particleSystemPool.forEach(function(e){e.clear(function(e){e.destroy()})}),this.particleSystemPool.clear()}},{key:"play",value:function(e){var t=e.getComponentsInChildren(a1),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.play()}}},{key:"stop",value:function(e){var t=e.getComponentsInChildren(a1),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.stop()}}}]),e}());function o1(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function l1(e,t){return e(t={exports:{}},t.exports),t.exports}s1.particleSystemPool=new Map,s1.registeredSceneEvent=!1,cc.ParticleSystemComponent=a1,cc.BillboardComponent=NY,cc.LineComponent=JY,cc.ParticleUtils=s1;var u1,c1,h1,f1,d1=l1(function(e,t){e.exports=function r(a,s,o){function l(i,e){if(!s[i]){if(!a[i]){var t=o1;if(!e&&t)return t(i,!0);if(u)return u(i,!0);throw new Error("Cannot find module '"+i+"'")}var n=s[i]={exports:{}};a[i][0].call(n.exports,function(e){var t=a[i][1][e];return l(t||e)},n,n.exports,r,a,s,o)}return s[i].exports}for(var u=o1,e=0;e<o.length;e++)l(o[e]);return l}({1:[function(e,t,i){t.exports={name:"cannon",version:"1.0.1",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/cocos-creator/cannon.js",author:"JayceLai",keywords:["cannon.js","cannon","physics","engine","3d"],scripts:{build:"grunt && npm run preprocess && grunt addLicense && grunt addDate",preprocess:"node node_modules/uglify-js/bin/uglifyjs build/cannon.js -o build/cannon.min.js -d doProfiling=false,DEBUG=false -c -m"},main:"./build/cannon.min.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/cocos-creator/cannon.js.git"},bugs:{url:"https://github.com/cocos-creator/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t,i){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Transform:e("./math/Transform"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":10,"./collision/RaycastResult":11,"./collision/SAPBroadphase":12,"./constraints/ConeTwistConstraint":13,"./constraints/Constraint":14,"./constraints/DistanceConstraint":15,"./constraints/HingeConstraint":16,"./constraints/LockConstraint":17,"./constraints/PointToPointConstraint":18,"./equations/ContactEquation":20,"./equations/Equation":21,"./equations/FrictionEquation":22,"./equations/RotationalEquation":23,"./equations/RotationalMotorEquation":24,"./material/ContactMaterial":25,"./material/Material":26,"./math/Mat3":28,"./math/Quaternion":29,"./math/Transform":30,"./math/Vec3":31,"./objects/Body":32,"./objects/RaycastVehicle":33,"./objects/RigidVehicle":34,"./objects/SPHSystem":35,"./objects/Spring":36,"./shapes/Box":38,"./shapes/ConvexPolyhedron":39,"./shapes/Cylinder":40,"./shapes/Heightfield":41,"./shapes/Particle":42,"./shapes/Plane":43,"./shapes/Shape":44,"./shapes/Sphere":45,"./shapes/Trimesh":46,"./solver/GSSolver":47,"./solver/Solver":48,"./solver/SplitSolver":49,"./utils/EventTarget":50,"./utils/Pool":52,"./utils/Vec3Pool":55,"./world/Narrowphase":56,"./world/World":57}],3:[function(e,t,i){var n=e("../math/Vec3");function r(e){e=e||{},this.lowerBound=new n,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new n,e.upperBound&&this.upperBound.copy(e.upperBound)}e("../utils/Utils"),t.exports=r;var u=new n;r.prototype.setFromPoints=function(e,t,i,n){var r=this.lowerBound,a=this.upperBound,s=i;r.copy(e[0]),s&&s.vmult(r,r),a.copy(r);for(var o=1;o<e.length;o++){var l=e[o];s&&(s.vmult(l,u),l=u),l.x>a.x&&(a.x=l.x),l.x<r.x&&(r.x=l.x),l.y>a.y&&(a.y=l.y),l.y<r.y&&(r.y=l.y),l.z>a.z&&(a.z=l.z),l.z<r.z&&(r.z=l.z)}return t&&(t.vadd(r,r),t.vadd(a,a)),n&&(r.x-=n,r.y-=n,r.z-=n,a.x+=n,a.y+=n,a.z+=n),this},r.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},r.prototype.clone=function(){return(new r).copy(this)},r.prototype.extend=function(e){this.lowerBound.x=Math.min(this.lowerBound.x,e.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,e.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,e.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,e.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,e.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,e.upperBound.z)},r.prototype.overlaps=function(e){var t=this.lowerBound,i=this.upperBound,n=e.lowerBound,r=e.upperBound,a=n.x<=i.x&&i.x<=r.x||t.x<=r.x&&r.x<=i.x,s=n.y<=i.y&&i.y<=r.y||t.y<=r.y&&r.y<=i.y,o=n.z<=i.z&&i.z<=r.z||t.z<=r.z&&r.z<=i.z;return a&&s&&o},r.prototype.volume=function(){var e=this.lowerBound,t=this.upperBound;return(t.x-e.x)*(t.y-e.y)*(t.z-e.z)},r.prototype.contains=function(e){var t=this.lowerBound,i=this.upperBound,n=e.lowerBound,r=e.upperBound;return t.x<=n.x&&i.x>=r.x&&t.y<=n.y&&i.y>=r.y&&t.z<=n.z&&i.z>=r.z},r.prototype.getCorners=function(e,t,i,n,r,a,s,o){var l=this.lowerBound,u=this.upperBound;e.copy(l),t.set(u.x,l.y,l.z),i.set(u.x,u.y,l.z),n.set(l.x,u.y,u.z),r.set(u.x,l.y,l.z),a.set(l.x,u.y,l.z),s.set(l.x,l.y,u.z),o.copy(u)};var d=[new n,new n,new n,new n,new n,new n,new n,new n];r.prototype.toLocalFrame=function(e,t){var i=d,n=i[0],r=i[1],a=i[2],s=i[3],o=i[4],l=i[5],u=i[6],c=i[7];this.getCorners(n,r,a,s,o,l,u,c);for(var h=0;8!==h;h++){var f=i[h];e.pointToLocal(f,f)}return t.setFromPoints(i)},r.prototype.toWorldFrame=function(e,t){var i=d,n=i[0],r=i[1],a=i[2],s=i[3],o=i[4],l=i[5],u=i[6],c=i[7];this.getCorners(n,r,a,s,o,l,u,c);for(var h=0;8!==h;h++){var f=i[h];e.pointToWorld(f,f)}return t.setFromPoints(i)},r.prototype.overlapsRay=function(e){var t=1/e._direction.x,i=1/e._direction.y,n=1/e._direction.z,r=(this.lowerBound.x-e.from.x)*t,a=(this.upperBound.x-e.from.x)*t,s=(this.lowerBound.y-e.from.y)*i,o=(this.upperBound.y-e.from.y)*i,l=(this.lowerBound.z-e.from.z)*n,u=(this.upperBound.z-e.from.z)*n,c=Math.max(Math.max(Math.min(r,a),Math.min(s,o)),Math.min(l,u)),h=Math.min(Math.min(Math.max(r,a),Math.max(s,o)),Math.max(l,u));return!(h<0||h<c)}},{"../math/Vec3":31,"../utils/Utils":54}],4:[function(e,t,i){function n(){this.matrix=[]}(t.exports=n).prototype.get=function(e,t){if((e=e.index)<(t=t.index)){var i=t;t=e,e=i}return this.matrix[(e*(e+1)>>1)+t-1]},n.prototype.set=function(e,t,i){if((e=e.index)<(t=t.index)){var n=t;t=e,e=n}this.matrix[(e*(e+1)>>1)+t-1]=i?1:0},n.prototype.reset=function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0},n.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t,i){var n=e("../objects/Body"),r=e("../math/Vec3"),a=e("../math/Quaternion");function s(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}e("../shapes/Shape"),e("../shapes/Plane"),(t.exports=s).prototype.collisionPairs=function(e,t,i){throw new Error("collisionPairs not implemented for this BroadPhase class!")},s.prototype.needBroadphaseCollision=function(e,t){return 0!=(e.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&e.collisionFilterMask)&&(0==(e.type&n.STATIC)&&e.sleepState!==n.SLEEPING||0==(t.type&n.STATIC)&&t.sleepState!==n.SLEEPING)},s.prototype.intersectionTest=function(e,t,i,n){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,i,n):this.doBoundingSphereBroadphase(e,t,i,n)};var o=new r;new r,new a,new r,s.prototype.doBoundingSphereBroadphase=function(e,t,i,n){var r=o;t.position.vsub(e.position,r);var a=Math.pow(e.boundingRadius+t.boundingRadius,2);r.norm2()<a&&(i.push(e),n.push(t))},s.prototype.doBoundingBoxBroadphase=function(e,t,i,n){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(i.push(e),n.push(t))};var h={keys:[]},f=[],d=[];s.prototype.makePairsUnique=function(e,t){for(var i=h,n=f,r=d,a=e.length,s=0;s!==a;s++)n[s]=e[s],r[s]=t[s];for(e.length=0,s=t.length=0;s!==a;s++){var o=n[s].id,l=r[s].id;i[u=o<l?o+","+l:l+","+o]=s,i.keys.push(u)}for(s=0;s!==i.keys.length;s++){var u=i.keys.pop(),c=i[u];e.push(n[c]),t.push(r[c]),delete i[u]}},s.prototype.setWorld=function(e){};var l=new r;s.boundingSphereCheck=function(e,t){var i=l;return e.position.vsub(t.position,i),Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>i.norm2()},s.prototype.aabbQuery=function(e,t,i){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Plane":43,"../shapes/Shape":44}],6:[function(e,t,i){t.exports=n;var o=e("./Broadphase"),l=e("../math/Vec3"),ie=e("../shapes/Shape");function n(e,t,i,n,r){o.apply(this),this.nx=i||10,this.ny=n||10,this.nz=r||10,this.aabbMin=e||new l(100,100,100),this.aabbMax=t||new l(-100,-100,-100);var a=this.nx*this.ny*this.nz;if(a<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=a,this.binLengths.length=a;for(var s=0;s<a;s++)this.bins[s]=[],this.binLengths[s]=0}(n.prototype=new o).constructor=n;var ne=new l;new l,n.prototype.collisionPairs=function(e,t,i){for(var n=e.numObjects(),r=e.bodies,a=this.aabbMax,s=this.aabbMin,m=this.nx,y=this.ny,g=this.nz,b=y*g,x=g,S=1,o=a.x,l=a.y,u=a.z,T=s.x,w=s.y,E=s.z,A=m/(o-T),C=y/(l-w),k=g/(u-E),c=(o-T)/m,h=(l-w)/y,f=(u-E)/g,d=.5*Math.sqrt(c*c+h*h+f*f),_=ie.types,p=_.SPHERE,v=_.PLANE,R=(_.BOX,_.COMPOUND,_.CONVEXPOLYHEDRON,this.bins),O=this.binLengths,M=this.bins.length,I=0;I!==M;I++)O[I]=0;var B=Math.ceil;function L(e,t,i,n,r,a,s){var o=(e-T)*A|0,l=(t-w)*C|0,u=(i-E)*k|0,c=B((n-T)*A),h=B((r-w)*C),f=B((a-E)*k);o<0?o=0:m<=o&&(o=m-1),l<0?l=0:y<=l&&(l=y-1),u<0?u=0:g<=u&&(u=g-1),c<0?c=0:m<=c&&(c=m-1),h<0?h=0:y<=h&&(h=y-1),f<0?f=0:g<=f&&(f=g-1),l*=x,u*=S,c*=b,h*=x,f*=S;for(var d=o*=b;d<=c;d+=b)for(var _=l;_<=h;_+=x)for(var p=u;p<=f;p+=S){var v=d+_+p;R[v][O[v]++]=s}}for(s=Math.min,a=Math.max,I=0;I!==n;I++){var P=(ee=r[I]).shape;switch(P.type){case p:var F=ee.position.x,z=ee.position.y,D=ee.position.z,N=P.radius;L(F-N,z-N,D-N,F+N,z+N,D+N,ee);break;case v:P.worldNormalNeedsUpdate&&P.computeWorldNormal(ee.quaternion);var U=P.worldNormal,V=T+.5*c-ee.position.x,G=w+.5*h-ee.position.y,H=E+.5*f-ee.position.z,W=ne;W.set(V,G,H);for(var q=0,j=0;q!==m;q++,j+=b,W.y=G,W.x+=c)for(var X=0,Y=0;X!==y;X++,Y+=x,W.z=H,W.y+=h)for(var K=0,Q=0;K!==g;K++,Q+=S,W.z+=f)if(W.dot(U)<d){var Z=j+Y+Q;R[Z][O[Z]++]=ee}break;default:ee.aabbNeedsUpdate&&ee.computeAABB(),L(ee.aabb.lowerBound.x,ee.aabb.lowerBound.y,ee.aabb.lowerBound.z,ee.aabb.upperBound.x,ee.aabb.upperBound.y,ee.aabb.upperBound.z,ee)}}for(I=0;I!==M;I++){var J=O[I];if(1<J){var $=R[I];for(q=0;q!==J;q++){var ee=$[q];for(X=0;X!==q;X++){var te=$[X];this.needBroadphaseCollision(ee,te)&&this.intersectionTest(ee,te,t,i)}}}}this.makePairsUnique(t,i)}},{"../math/Vec3":31,"../shapes/Shape":44,"./Broadphase":5}],7:[function(e,t,i){t.exports=a;var n=e("./Broadphase"),r=e("./AABB");function a(){n.apply(this)}((a.prototype=new n).constructor=a).prototype.collisionPairs=function(e,t,i){var n,r,a,s,o=e.bodies,l=o.length;for(n=0;n!==l;n++)for(r=0;r!==n;r++)a=o[n],s=o[r],this.needBroadphaseCollision(a,s)&&this.intersectionTest(a,s,t,i)},new r,a.prototype.aabbQuery=function(e,t,i){i=i||[];for(var n=0;n<e.bodies.length;n++){var r=e.bodies[n];r.aabbNeedsUpdate&&r.computeAABB(),r.aabb.overlaps(t)&&i.push(r)}return i}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t,i){function n(){this.matrix={}}(t.exports=n).prototype.get=function(e,t){if((e=e.id)<(t=t.id)){var i=t;t=e,e=i}return e+"-"+t in this.matrix},n.prototype.set=function(e,t,i){if((e=e.id)<(t=t.id)){var n=t;t=e,e=n}i?this.matrix[e+"-"+t]=!0:delete this.matrix[e+"-"+t]},n.prototype.reset=function(){this.matrix={}},n.prototype.setNumObjects=function(e){}},{}],9:[function(e,t,i){function n(){this.current=[],this.previous=[]}function c(e,t){e.push((4294901760&t)>>16,65535&t)}(t.exports=n).prototype.getKey=function(e,t){if(t<e){var i=t;t=e,e=i}return e<<16|t},n.prototype.set=function(e,t){for(var i=this.getKey(e,t),n=this.current,r=0;i>n[r];)r++;if(i!==n[r]){for(t=n.length-1;r<=t;t--)n[t+1]=n[t];n[r]=i}},n.prototype.tick=function(){var e=this.current;this.current=this.previous,this.previous=e,this.current.length=0},n.prototype.reset=function(){this.previous.length=0,this.current.length=0},n.prototype.getDiff=function(e,t){for(var i=this.current,n=this.previous,r=i.length,a=n.length,s=0,o=0;o<r;o++){for(var l=i[o];l>n[s];)s++;l===n[s]||c(e,l)}for(o=s=0;o<a;o++){for(var u=n[o];u>i[s];)s++;i[s]===u||c(t,u)}},n.prototype.copy=function(e){this.current.length=0,this.previous.length=0,this.current=e.current.slice(),this.previous=e.previous.slice()}},{}],10:[function(e,t,i){t.exports=u;var v=e("../math/Vec3"),n=e("../math/Quaternion"),A=e("../math/Transform"),r=(e("../shapes/ConvexPolyhedron"),e("../shapes/Box"),e("../collision/RaycastResult")),a=e("../shapes/Shape"),_=e("../collision/AABB");function u(e,t){this.from=e?e.clone():new v,this.to=t?t.clone():new v,this._direction=new v,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=u.ANY,this.result=new r,this.hasHit=!1,this.callback=function(e){}}(u.prototype.constructor=u).CLOSEST=1,u.ANY=2,u.ALL=4;var s=new _,o=[];u.prototype.intersectWorld=function(e,t){return this.mode=t.mode||u.ANY,this.result=t.result||new r,this.skipBackfaces=!!t.skipBackfaces,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:-1,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(s),o.length=0,e.broadphase.aabbQuery(e,s,o),this.intersectBodies(o),this.hasHit};var h=new v,f=new v;function k(e,t,i,n){n.vsub(t,d),i.vsub(t,h),e.vsub(t,f);var r,a,s=d.dot(d),o=d.dot(h),l=d.dot(f),u=h.dot(h),c=h.dot(f);return 0<=(r=u*l-o*c)&&0<=(a=s*c-o*l)&&r+a<s*u-o*o}u.pointInTriangle=k;var l=new v,c=new n;u.prototype.intersectBody=function(e,t){t&&(this.result=t,this._updateDirection());var i=this.checkCollisionResponse;if((!i||e.collisionResponse)&&0!=(this.collisionFilterGroup&e.collisionFilterMask)&&0!=(e.collisionFilterGroup&this.collisionFilterMask))for(var n=l,r=c,a=0,s=e.shapes.length;a<s;a++){var o=e.shapes[a];if((!i||o.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[a],r),e.quaternion.vmult(e.shapeOffsets[a],n),n.vadd(e.position,n),this.intersectShape(o,r,n,e),this.result._shouldStop))break}},u.prototype.intersectBodies=function(e,t){t&&(this.result=t,this._updateDirection());for(var i=0,n=e.length;!this.result._shouldStop&&i<n;i++)this.intersectBody(e[i])},u.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},u.prototype.intersectShape=function(e,t,i,n){if(!(function(e,t,i){i.vsub(e,d);var n=d.dot(t);return t.mult(n,S),S.vadd(e,S),i.distanceTo(S)}(this.from,this._direction,i)>e.boundingSphereRadius)){var r=this[e.type];r&&r.call(this,e,t,i,n,e)}},new v,new v;var R=new v,O=new v,M=new v,I=new v;new v,new r,u.prototype.intersectBox=function(e,t,i,n,r){return this.intersectConvex(e.convexPolyhedronRepresentation,t,i,n,r)},u.prototype[a.types.BOX]=u.prototype.intersectBox,u.prototype.intersectPlane=function(e,t,i,n,r){var a=this.from,s=this.to,o=this._direction,l=new v(0,0,1);t.vmult(l,l);var u=new v;a.vsub(i,u);var c=u.dot(l);if(s.vsub(i,u),!(0<c*u.dot(l)||a.distanceTo(s)<c)){var h=l.dot(o);if(!(Math.abs(h)<this.precision)){var f=new v,d=new v,_=new v;a.vsub(i,f);var p=-l.dot(f)/h;o.scale(p,d),a.vadd(d,_),this.reportIntersection(l,_,r,n,-1)}}},u.prototype[a.types.PLANE]=u.prototype.intersectPlane,u.prototype.getAABB=function(e){var t=this.to,i=this.from;e.lowerBound.x=Math.min(t.x,i.x),e.lowerBound.y=Math.min(t.y,i.y),e.lowerBound.z=Math.min(t.z,i.z),e.upperBound.x=Math.max(t.x,i.x),e.upperBound.y=Math.max(t.y,i.y),e.upperBound.z=Math.max(t.z,i.z)};var p={faceList:[0]},m=new v,y=new u,g=[];u.prototype.intersectHeightfield=function(e,t,i,n,r){e.data,e.elementSize;var a=y;a.from.copy(this.from),a.to.copy(this.to),A.pointToLocalFrame(i,t,a.from,a.from),A.pointToLocalFrame(i,t,a.to,a.to),a._updateDirection();var s,o,l,u,c=g;s=o=0,l=u=e.data.length-1;var h=new _;a.getAABB(h),e.getIndexOfPosition(h.lowerBound.x,h.lowerBound.y,c,!0),s=Math.max(s,c[0]),o=Math.max(o,c[1]),e.getIndexOfPosition(h.upperBound.x,h.upperBound.y,c,!0),l=Math.min(l,c[0]+1),u=Math.min(u,c[1]+1);for(var f=s;f<l;f++)for(var d=o;d<u;d++){if(this.result._shouldStop)return;if(e.getAabbAtIndex(f,d,h),h.overlapsRay(a)){if(e.getConvexTrianglePillar(f,d,!1),A.pointToWorldFrame(i,t,e.pillarOffset,m),this.intersectConvex(e.pillarConvex,t,m,n,r,p),this.result._shouldStop)return;e.getConvexTrianglePillar(f,d,!0),A.pointToWorldFrame(i,t,e.pillarOffset,m),this.intersectConvex(e.pillarConvex,t,m,n,r,p)}}},u.prototype[a.types.HEIGHTFIELD]=u.prototype.intersectHeightfield;var b=new v,x=new v;u.prototype.intersectSphere=function(e,t,i,n,r){var a=this.from,s=this.to,o=e.radius,l=Math.pow(s.x-a.x,2)+Math.pow(s.y-a.y,2)+Math.pow(s.z-a.z,2),u=2*((s.x-a.x)*(a.x-i.x)+(s.y-a.y)*(a.y-i.y)+(s.z-a.z)*(a.z-i.z)),c=Math.pow(a.x-i.x,2)+Math.pow(a.y-i.y,2)+Math.pow(a.z-i.z,2)-Math.pow(o,2),h=Math.pow(u,2)-4*l*c,f=b,d=x;if(!(h<0))if(0==h)a.lerp(s,h,f),f.vsub(i,d),d.normalize(),this.reportIntersection(d,f,r,n,-1);else{var _=(-u-Math.sqrt(h))/(2*l),p=(-u+Math.sqrt(h))/(2*l);if(0<=_&&_<=1&&(a.lerp(s,_,f),f.vsub(i,d),d.normalize(),this.reportIntersection(d,f,r,n,-1)),this.result._shouldStop)return;0<=p&&p<=1&&(a.lerp(s,p,f),f.vsub(i,d),d.normalize(),this.reportIntersection(d,f,r,n,-1))}},u.prototype[a.types.SPHERE]=u.prototype.intersectSphere;var B=new v,L=(new v,new v,new v);u.prototype.intersectConvex=function(e,t,i,n,r,a){for(var s=B,o=L,l=a&&a.faceList||null,u=e.faces,c=e.vertices,h=e.faceNormals,f=this._direction,d=this.from,_=this.to,p=d.distanceTo(_),v=l?l.length:u.length,m=this.result,y=0;!m._shouldStop&&y<v;y++){var g=l?l[y]:y,b=u[g],x=h[g],S=t,T=i;o.copy(c[b[0]]),S.vmult(o,o),o.vadd(T,o),o.vsub(d,o),S.vmult(x,s);var w=f.dot(s);if(!(Math.abs(w)<this.precision)){var E=s.dot(o)/w;if(!(E<0)){f.mult(E,R),R.vadd(d,R),O.copy(c[b[0]]),S.vmult(O,O),T.vadd(O,O);for(var A=1;!m._shouldStop&&A<b.length-1;A++){M.copy(c[b[A]]),I.copy(c[b[A+1]]),S.vmult(M,M),S.vmult(I,I),T.vadd(M,M),T.vadd(I,I);var C=R.distanceTo(d);!k(R,O,M,I)&&!k(R,M,O,I)||p<C||this.reportIntersection(s,R,r,n,g)}}}}},u.prototype[a.types.CONVEXPOLYHEDRON]=u.prototype.intersectConvex;var C=new v,P=new v,F=new v,z=new v,D=new v,N=new v,U=(new _,[]),V=new A;u.prototype.intersectTrimesh=function(e,t,i,n,r,a){var s=C,o=U,l=V,u=L,c=P,h=F,f=z,d=N,_=D,p=(a&&a.faceList,e.indices),v=(e.vertices,e.faceNormals,this.from),m=this.to,y=this._direction;l.position.copy(i),l.quaternion.copy(t),A.vectorToLocalFrame(i,t,y,c),A.pointToLocalFrame(i,t,v,h),A.pointToLocalFrame(i,t,m,f),f.x*=e.scale.x,f.y*=e.scale.y,f.z*=e.scale.z,h.x*=e.scale.x,h.y*=e.scale.y,h.z*=e.scale.z,f.vsub(h,c),c.normalize();var g=h.distanceSquared(f);e.tree.rayQuery(this,l,o);for(var b=0,x=o.length;!this.result._shouldStop&&b!==x;b++){var S=o[b];e.getNormal(S,s),e.getVertex(p[3*S],O),O.vsub(h,u);var T=c.dot(s),w=s.dot(u)/T;if(!(w<0)){c.scale(w,R),R.vadd(h,R),e.getVertex(p[3*S+1],M),e.getVertex(p[3*S+2],I);var E=R.distanceSquared(h);!k(R,M,O,I)&&!k(R,O,M,I)||g<E||(A.vectorToWorldFrame(t,s,_),A.pointToWorldFrame(i,t,R,d),this.reportIntersection(_,d,r,n,S))}}o.length=0},u.prototype[a.types.TRIMESH]=u.prototype.intersectTrimesh,u.prototype.reportIntersection=function(e,t,i,n,r){var a=this.from,s=this.to,o=a.distanceTo(t),l=this.result;if(!(this.skipBackfaces&&0<e.dot(this._direction)))switch(l.hitFaceIndex=void 0!==r?r:-1,this.mode){case u.ALL:this.hasHit=!0,l.set(a,s,e,t,i,n,o),l.hasHit=!0,this.callback(l);break;case u.CLOSEST:(o<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(a,s,e,t,i,n,o));break;case u.ANY:this.hasHit=!0,l.hasHit=!0,l.set(a,s,e,t,i,n,o),l._shouldStop=!0}};var d=new v,S=new v},{"../collision/AABB":3,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../shapes/Box":38,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44}],11:[function(e,t,i){var n=e("../math/Vec3");function r(){this.rayFromWorld=new n,this.rayToWorld=new n,this.hitNormalWorld=new n,this.hitPointWorld=new n,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}(t.exports=r).prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},r.prototype.abort=function(){this._shouldStop=!0},r.prototype.set=function(e,t,i,n,r,a,s){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(n),this.shape=r,this.body=a,this.distance=s}},{"../math/Vec3":31}],12:[function(e,t,i){e("../shapes/Shape");var n=e("../collision/Broadphase");function c(e){n.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var i=this.axisList;this._addBodyHandler=function(e){i.push(e.body)},this._removeBodyHandler=function(e){var t=i.indexOf(e.body);-1!==t&&i.splice(t,1)},e&&this.setWorld(e)}((t.exports=c).prototype=new n).setWorld=function(e){for(var t=this.axisList.length=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},c.insertionSortX=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.x<=n.aabb.lowerBound.x);r--)e[r+1]=e[r];e[r+1]=n}return e},c.insertionSortY=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.y<=n.aabb.lowerBound.y);r--)e[r+1]=e[r];e[r+1]=n}return e},c.insertionSortZ=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.z<=n.aabb.lowerBound.z);r--)e[r+1]=e[r];e[r+1]=n}return e},c.prototype.collisionPairs=function(e,t,i){var n,r,a=this.axisList,s=a.length,o=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),n=0;n!==s;n++){var l=a[n];for(r=n+1;r<s;r++){var u=a[r];if(this.needBroadphaseCollision(l,u)){if(!c.checkBounds(l,u,o))break;this.intersectionTest(l,u,t,i)}}}},c.prototype.sortList=function(){for(var e=this.axisList,t=this.axisIndex,i=e.length,n=0;n!==i;n++){var r=e[n];r.aabbNeedsUpdate&&r.computeAABB()}0===t?c.insertionSortX(e):1===t?c.insertionSortY(e):2===t&&c.insertionSortZ(e)},c.checkBounds=function(e,t,i){var n,r;0===i?(n=e.position.x,r=t.position.x):1===i?(n=e.position.y,r=t.position.y):2===i&&(n=e.position.z,r=t.position.z);var a=e.boundingRadius,s=t.boundingRadius;return r-s<n+a},c.prototype.autoDetectAxis=function(){for(var e=0,t=0,i=0,n=0,r=0,a=0,s=this.axisList,o=s.length,l=1/o,u=0;u!==o;u++){var c=s[u],h=c.position.x;e+=h,t+=h*h;var f=c.position.y;i+=f,n+=f*f;var d=c.position.z;r+=d,a+=d*d}var _=t-e*e*l,p=n-i*i*l,v=a-r*r*l;this.axisIndex=p<_?v<_?0:2:v<p?1:2},c.prototype.aabbQuery=function(e,t,i){i=i||[],this.dirty&&(this.sortList(),this.dirty=!1);var n=this.axisIndex,r="x";1===n&&(r="y"),2===n&&(r="z");for(var a=this.axisList,s=(t.lowerBound[r],t.upperBound[r],0);s<a.length;s++){var o=a[s];o.aabbNeedsUpdate&&o.computeAABB(),o.aabb.overlaps(t)&&i.push(o)}return i}},{"../collision/Broadphase":5,"../shapes/Shape":44}],13:[function(e,t,i){t.exports=n,e("./Constraint");var l=e("./PointToPointConstraint"),u=e("../equations/ConeEquation"),c=e("../equations/RotationalEquation"),h=(e("../equations/ContactEquation"),e("../math/Vec3"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,r=i.pivotA?i.pivotA.clone():new h,a=i.pivotB?i.pivotB.clone():new h;this.axisA=i.axisA?i.axisA.clone():new h,this.axisB=i.axisB?i.axisB.clone():new h,l.call(this,e,r,t,a,n),this.collideConnected=!!i.collideConnected,this.angle=void 0!==i.angle?i.angle:0;var s=this.coneEquation=new u(e,t,i),o=this.twistEquation=new c(e,t,i);this.twistAngle=void 0!==i.twistAngle?i.twistAngle:0,s.maxForce=0,s.minForce=-n,o.maxForce=0,o.minForce=-n,this.equations.push(s,o)}n.prototype=new l,n.constructor=n,new h,new h,n.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.coneEquation,n=this.twistEquation;l.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,i.axisA),t.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(n.axisA,n.axisA),e.vectorToWorldFrame(n.axisA,n.axisA),this.axisB.tangents(n.axisB,n.axisB),t.vectorToWorldFrame(n.axisB,n.axisB),i.angle=this.angle,n.maxAngle=this.twistAngle}},{"../equations/ConeEquation":19,"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],14:[function(e,t,i){t.exports=r;var n=e("../utils/Utils");function r(e,t,i){i=n.defaults(i,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=t,this.id=r.idCounter++,this.collideConnected=i.collideConnected,i.wakeUpBodies&&(e&&e.wakeUp(),t&&t.wakeUp())}r.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},r.prototype.enable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0},r.prototype.disable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1},r.idCounter=0},{"../utils/Utils":54}],15:[function(e,t,i){t.exports=n;var a=e("./Constraint"),s=e("../equations/ContactEquation");function n(e,t,i,n){a.call(this,e,t),void 0===i&&(i=e.position.distanceTo(t.position)),void 0===n&&(n=1e6),this.distance=i;var r=this.distanceEquation=new s(e,t);this.equations.push(r),r.minForce=-n,r.maxForce=n}(n.prototype=new a).update=function(){var e=this.bodyA,t=this.bodyB,i=this.distanceEquation,n=.5*this.distance,r=i.ni;t.position.vsub(e.position,r),r.normalize(),r.mult(n,i.ri),r.mult(-n,i.rj)}},{"../equations/ContactEquation":20,"./Constraint":14}],16:[function(e,t,i){t.exports=n,e("./Constraint");var u=e("./PointToPointConstraint"),c=e("../equations/RotationalEquation"),h=e("../equations/RotationalMotorEquation"),f=(e("../equations/ContactEquation"),e("../math/Vec3"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,r=i.pivotA?i.pivotA.clone():new f,a=i.pivotB?i.pivotB.clone():new f;u.call(this,e,r,t,a,n),(this.axisA=i.axisA?i.axisA.clone():new f(1,0,0)).normalize(),(this.axisB=i.axisB?i.axisB.clone():new f(1,0,0)).normalize();var s=this.rotationalEquation1=new c(e,t,i),o=this.rotationalEquation2=new c(e,t,i),l=this.motorEquation=new h(e,t,n);l.enabled=!1,this.equations.push(s,o,l)}n.prototype=new u,(n.constructor=n).prototype.enableMotor=function(){this.motorEquation.enabled=!0},n.prototype.disableMotor=function(){this.motorEquation.enabled=!1},n.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},n.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var d=new f,_=new f;n.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.motorEquation,n=this.rotationalEquation1,r=this.rotationalEquation2,a=d,s=_,o=this.axisA,l=this.axisB;u.prototype.update.call(this),e.quaternion.vmult(o,a),t.quaternion.vmult(l,s),a.tangents(n.axisA,r.axisA),n.axisB.copy(s),r.axisB.copy(s),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,i.axisA),t.quaternion.vmult(this.axisB,i.axisB))}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],17:[function(e,t,i){t.exports=n,e("./Constraint");var c=e("./PointToPointConstraint"),h=e("../equations/RotationalEquation"),f=(e("../equations/RotationalMotorEquation"),e("../equations/ContactEquation"),e("../math/Vec3"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,r=new f,a=new f,s=new f;e.position.vadd(t.position,s),s.scale(.5,s),t.pointToLocalFrame(s,a),e.pointToLocalFrame(s,r),c.call(this,e,r,t,a,n),this.xA=e.vectorToLocalFrame(f.UNIT_X),this.xB=t.vectorToLocalFrame(f.UNIT_X),this.yA=e.vectorToLocalFrame(f.UNIT_Y),this.yB=t.vectorToLocalFrame(f.UNIT_Y),this.zA=e.vectorToLocalFrame(f.UNIT_Z),this.zB=t.vectorToLocalFrame(f.UNIT_Z);var o=this.rotationalEquation1=new h(e,t,i),l=this.rotationalEquation2=new h(e,t,i),u=this.rotationalEquation3=new h(e,t,i);this.equations.push(o,l,u)}n.prototype=new c,n.constructor=n,new f,new f,n.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),n=this.rotationalEquation2,r=this.rotationalEquation3;c.prototype.update.call(this),e.vectorToWorldFrame(this.xA,i.axisA),t.vectorToWorldFrame(this.yB,i.axisB),e.vectorToWorldFrame(this.yA,n.axisA),t.vectorToWorldFrame(this.zB,n.axisB),e.vectorToWorldFrame(this.zA,r.axisA),t.vectorToWorldFrame(this.xB,r.axisB)}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],18:[function(e,t,i){t.exports=n;var l=e("./Constraint"),u=e("../equations/ContactEquation"),c=e("../math/Vec3");function n(e,t,i,n,r){l.call(this,e,i),r=void 0!==r?r:1e6,this.pivotA=t?t.clone():new c,this.pivotB=n?n.clone():new c;var a=this.equationX=new u(e,i),s=this.equationY=new u(e,i),o=this.equationZ=new u(e,i);this.equations.push(a,s,o),a.minForce=s.minForce=o.minForce=-r,a.maxForce=s.maxForce=o.maxForce=r,a.ni.set(1,0,0),s.ni.set(0,1,0),o.ni.set(0,0,1)}(n.prototype=new l).update=function(){var e=this.bodyA,t=this.bodyB,i=this.equationX,n=this.equationY,r=this.equationZ;e.quaternion.vmult(this.pivotA,i.ri),t.quaternion.vmult(this.pivotB,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),r.ri.copy(i.ri),r.rj.copy(i.rj)}},{"../equations/ContactEquation":20,"../math/Vec3":31,"./Constraint":14}],19:[function(e,t,i){t.exports=n;var r=e("../math/Vec3"),a=(e("../math/Mat3"),e("./Equation"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;a.call(this,e,t,-n,n),this.axisA=i.axisA?i.axisA.clone():new r(1,0,0),this.axisB=i.axisB?i.axisB.clone():new r(0,1,0),this.angle=void 0!==i.angle?i.angle:0}(n.prototype=new a).constructor=n;var u=new r,c=new r;n.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.axisA,r=this.axisB,a=u,s=c,o=this.jacobianElementA,l=this.jacobianElementB;return n.cross(r,a),r.cross(n,s),o.rotational.copy(s),l.rotational.copy(a),-(Math.cos(this.angle)-n.dot(r))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],20:[function(e,t,i){t.exports=a;var n=e("./Equation"),r=e("../math/Vec3");function a(e,t,i){i=void 0!==i?i:1e6,n.call(this,e,t,0,i),this.si=null,this.sj=null,this.restitution=0,this.ri=new r,this.rj=new r,this.ni=new r}e("../math/Mat3"),(a.prototype=new n).constructor=a;var g=new r,b=new r,x=new r;a.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.bi,r=this.bj,a=this.ri,s=this.rj,o=g,l=b,u=n.velocity,c=n.angularVelocity,h=(n.force,n.torque,r.velocity),f=r.angularVelocity,d=(r.force,r.torque,x),_=this.jacobianElementA,p=this.jacobianElementB,v=this.ni;a.cross(v,o),s.cross(v,l),v.negate(_.spatial),o.negate(_.rotational),p.spatial.copy(v),p.rotational.copy(l),d.copy(r.position),d.vadd(s,d),d.vsub(n.position,d),d.vsub(a,d);var m=v.dot(d),y=this.restitution+1;return-m*t-(y*h.dot(v)-y*u.dot(v)+f.dot(l)-c.dot(o))*i-e*this.computeGiMf()};var s=new r,o=new r,l=new r,u=new r,c=new r;a.prototype.getImpactVelocityAlongNormal=function(){var e=s,t=o,i=l,n=u,r=c;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,n),this.bi.getVelocityAtWorldPoint(i,e),this.bj.getVelocityAtWorldPoint(n,t),e.vsub(t,r),this.ni.dot(r)}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],21:[function(e,t,i){t.exports=a;var r=e("../math/JacobianElement"),n=e("../math/Vec3");function a(e,t,i,n){this.id=a.id++,this.minForce=void 0===i?-1e6:i,this.maxForce=void 0===n?1e6:n,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new r,this.jacobianElementB=new r,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}(a.prototype.constructor=a).id=0,a.prototype.setSpookParams=function(e,t,i){var n=t,r=e,a=i;this.a=4/(a*(1+4*n)),this.b=4*n/(1+4*n),this.eps=4/(a*a*r*(1+4*n))},a.prototype.computeB=function(e,t,i){var n=this.computeGW();return-this.computeGq()*e-n*t-this.computeGiMf()*i},a.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.position,a=n.position;return e.spatial.dot(r)+t.spatial.dot(a)},new n,a.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.velocity,a=n.velocity,s=i.angularVelocity,o=n.angularVelocity;return e.multiplyVectors(r,s)+t.multiplyVectors(a,o)},a.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.vlambda,a=n.vlambda,s=i.wlambda,o=n.wlambda;return e.multiplyVectors(r,s)+t.multiplyVectors(a,o)};var c=new n,h=new n,f=new n,d=new n;a.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.force,a=i.torque,s=n.force,o=n.torque,l=i.invMassSolve,u=n.invMassSolve;return r.scale(l,c),s.scale(u,h),i.invInertiaWorldSolve.vmult(a,f),n.invInertiaWorldSolve.vmult(o,d),e.multiplyVectors(c,f)+t.multiplyVectors(h,d)};var u=new n;a.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.invMassSolve,a=n.invMassSolve,s=i.invInertiaWorldSolve,o=n.invInertiaWorldSolve,l=r+a;return s.vmult(e.rotational,u),l+=u.dot(e.rotational),o.vmult(t.rotational,u),l+=u.dot(t.rotational)};var s=new n;new n,new n,new n,new n,new n,a.prototype.addToWlambda=function(e){var t=this.jacobianElementA,i=this.jacobianElementB,n=this.bi,r=this.bj,a=s;n.vlambda.addScaledVector(n.invMassSolve*e,t.spatial,n.vlambda),r.vlambda.addScaledVector(r.invMassSolve*e,i.spatial,r.vlambda),n.invInertiaWorldSolve.vmult(t.rotational,a),n.wlambda.addScaledVector(e,a,n.wlambda),r.invInertiaWorldSolve.vmult(i.rotational,a),r.wlambda.addScaledVector(e,a,r.wlambda)},a.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":27,"../math/Vec3":31}],22:[function(e,t,i){t.exports=a;var n=e("./Equation"),r=e("../math/Vec3");function a(e,t,i){n.call(this,e,t,-i,i),this.ri=new r,this.rj=new r,this.t=new r}e("../math/Mat3"),(a.prototype=new n).constructor=a;var u=new r,c=new r;a.prototype.computeB=function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.ri),n=this.rj,r=u,a=c,s=this.t;i.cross(s,r),n.cross(s,a);var o=this.jacobianElementA,l=this.jacobianElementB;return s.negate(o.spatial),r.negate(o.rotational),l.spatial.copy(s),l.rotational.copy(a),-this.computeGW()*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],23:[function(e,t,i){t.exports=n;var r=e("../math/Vec3"),a=(e("../math/Mat3"),e("./Equation"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;a.call(this,e,t,-n,n),this.axisA=i.axisA?i.axisA.clone():new r(1,0,0),this.axisB=i.axisB?i.axisB.clone():new r(0,1,0),this.maxAngle=Math.PI/2}(n.prototype=new a).constructor=n;var u=new r,c=new r;n.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.axisA,r=this.axisB,a=u,s=c,o=this.jacobianElementA,l=this.jacobianElementB;return n.cross(r,a),r.cross(n,s),o.rotational.copy(s),l.rotational.copy(a),-(Math.cos(this.maxAngle)-n.dot(r))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],24:[function(e,t,i){t.exports=a;var n=e("../math/Vec3"),r=(e("../math/Mat3"),e("./Equation"));function a(e,t,i){i=void 0!==i?i:1e6,r.call(this,e,t,-i,i),this.axisA=new n,this.axisB=new n,this.targetVelocity=0}((a.prototype=new r).constructor=a).prototype.computeB=function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.axisA),n=this.axisB,r=this.jacobianElementA,a=this.jacobianElementB;return r.rotational.copy(i),n.negate(a.rotational),-(this.computeGW()-this.targetVelocity)*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],25:[function(e,t,i){var r=e("../utils/Utils");(t.exports=function e(t,i,n){n=r.defaults(n,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=e.idCounter++,this.materials=[t,i],this.friction=n.friction,this.restitution=n.restitution,this.contactEquationStiffness=n.contactEquationStiffness,this.contactEquationRelaxation=n.contactEquationRelaxation,this.frictionEquationStiffness=n.frictionEquationStiffness,this.frictionEquationRelaxation=n.frictionEquationRelaxation}).idCounter=0},{"../utils/Utils":54}],26:[function(e,t,i){(t.exports=function e(t){var i="";"string"==typeof(t=t||{})?(i=t,t={}):"object"==typeof t&&(i=""),this.name=i,this.id=e.idCounter++,this.friction=void 0!==t.friction?t.friction:-1,this.restitution=void 0!==t.restitution?t.restitution:-1}).idCounter=0},{}],27:[function(e,t,i){t.exports=r;var n=e("./Vec3");function r(){this.spatial=new n,this.rotational=new n}r.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},r.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":31}],28:[function(e,t,i){t.exports=u;var c=e("./Vec3");function u(e){this.elements=e||[0,0,0,0,0,0,0,0,0]}u.prototype.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},u.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},u.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z},u.prototype.getTrace=function(e){e=e||new c;var t=this.elements;e.x=t[0],e.y=t[4],e.z=t[8]},u.prototype.vmult=function(e,t){t=t||new c;var i=this.elements,n=e.x,r=e.y,a=e.z;return t.x=i[0]*n+i[1]*r+i[2]*a,t.y=i[3]*n+i[4]*r+i[5]*a,t.z=i[6]*n+i[7]*r+i[8]*a,t},u.prototype.smult=function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e},u.prototype.mmult=function(e,t){for(var i=t||new u,n=0;n<3;n++)for(var r=0;r<3;r++){for(var a=0,s=0;s<3;s++)a+=e.elements[n+3*s]*this.elements[s+3*r];i.elements[n+3*r]=a}return i},u.prototype.scale=function(e,t){t=t||new u;for(var i=this.elements,n=t.elements,r=0;3!==r;r++)n[3*r+0]=e.x*i[3*r+0],n[3*r+1]=e.y*i[3*r+1],n[3*r+2]=e.z*i[3*r+2];return t},u.prototype.solve=function(e,t){t=t||new c;for(var i,n=[],r=0;r<12;r++)n.push(0);for(r=0;r<3;r++)for(i=0;i<3;i++)n[r+4*i]=this.elements[r+3*i];n[3]=e.x,n[7]=e.y,n[11]=e.z;var a,s,o=3,l=o;do{if(0===n[(r=l-o)+4*r])for(i=r+1;i<l;i++)if(0!==n[r+4*i]){for(a=4;n[(s=4-a)+4*r]+=n[s+4*i],--a;);break}if(0!==n[r+4*r])for(i=r+1;i<l;i++){var u=n[r+4*i]/n[r+4*r];for(a=4;n[(s=4-a)+4*i]=s<=r?0:n[s+4*i]-n[s+4*r]*u,--a;);}}while(--o);if(t.z=n[11]/n[10],t.y=(n[7]-n[6]*t.z)/n[5],t.x=(n[3]-n[2]*t.z-n[1]*t.y)/n[0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===1/0||t.y===1/0||t.z===1/0)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return t},u.prototype.e=function(e,t,i){if(void 0===i)return this.elements[t+3*e];this.elements[t+3*e]=i},u.prototype.copy=function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this},u.prototype.toString=function(){for(var e="",t=0;t<9;t++)e+=this.elements[t]+",";return e},u.prototype.reverse=function(e){e=e||new u;for(var t,i=[],n=0;n<18;n++)i.push(0);for(n=0;n<3;n++)for(t=0;t<3;t++)i[n+6*t]=this.elements[n+3*t];i[3]=1,i[9]=0,i[15]=0,i[4]=0,i[10]=1,i[16]=0,i[5]=0,i[11]=0,i[17]=1;var r,a,s=3,o=s;do{if(0===i[(n=o-s)+6*n])for(t=n+1;t<o;t++)if(0!==i[n+6*t]){for(r=6;i[(a=6-r)+6*n]+=i[a+6*t],--r;);break}if(0!==i[n+6*n])for(t=n+1;t<o;t++){var l=i[n+6*t]/i[n+6*n];for(r=6;i[(a=6-r)+6*t]=a<=n?0:i[a+6*t]-i[a+6*n]*l,--r;);}}while(--s);n=2;do{t=n-1;do{for(l=i[n+6*t]/i[n+6*n],r=6;i[(a=6-r)+6*t]=i[a+6*t]-i[a+6*n]*l,--r;);}while(t--)}while(--n);n=2;do{for(l=1/i[n+6*n],r=6;i[(a=6-r)+6*n]=i[a+6*n]*l,--r;);}while(n--);n=2;do{t=2;do{if(a=i[3+t+6*n],isNaN(a)||a===1/0)throw"Could not reverse! A=["+this.toString()+"]";e.e(n,t,a)}while(t--)}while(n--);return e},u.prototype.setRotationFromQuaternion=function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,s=i+i,o=n+n,l=t*a,u=t*s,c=t*o,h=i*s,f=i*o,d=n*o,_=r*a,p=r*s,v=r*o,m=this.elements;return m[0]=1-(h+d),m[1]=u-v,m[2]=c+p,m[3]=u+v,m[4]=1-(l+d),m[5]=f-_,m[6]=c-p,m[7]=f+_,m[8]=1-(l+h),this},u.prototype.transpose=function(e){for(var t=(e=e||new u).elements,i=this.elements,n=0;3!==n;n++)for(var r=0;3!==r;r++)t[3*n+r]=i[3*r+n];return e}},{"./Vec3":31}],29:[function(e,t,i){t.exports=v;var d=e("./Vec3");function v(e,t,i,n){this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==i?i:0,this.w=void 0!==n?n:1}v.prototype.set=function(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this},v.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},v.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},v.prototype.setFromAxisAngle=function(e,t){var i=Math.sin(.5*t);return this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this.w=Math.cos(.5*t),this},v.prototype.toAxisAngle=function(e){e=e||new d,this.normalize();var t=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/i,e.y=this.y/i,e.z=this.z/i),[e,t]};var a=new d,s=new d;v.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var i=a,n=s;e.tangents(i,n),this.setFromAxisAngle(i,Math.PI)}else{var r=e.cross(t);this.x=r.x,this.y=r.y,this.z=r.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t),this.normalize()}return this},new d,new d,new d,v.prototype.mult=function(e,t){t=t||new v;var i=this.x,n=this.y,r=this.z,a=this.w,s=e.x,o=e.y,l=e.z,u=e.w;return t.x=i*u+a*s+n*l-r*o,t.y=n*u+a*o+r*s-i*l,t.z=r*u+a*l+i*o-n*s,t.w=a*u-i*s-n*o-r*l,t},v.prototype.inverse=function(e){var t=this.x,i=this.y,n=this.z,r=this.w;e=e||new v,this.conjugate(e);var a=1/(t*t+i*i+n*n+r*r);return e.x*=a,e.y*=a,e.z*=a,e.w*=a,e},v.prototype.conjugate=function(e){return(e=e||new v).x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},v.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},v.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0==e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},v.prototype.vmult=function(e,t){t=t||new d;var i=e.x,n=e.y,r=e.z,a=this.x,s=this.y,o=this.z,l=this.w,u=l*i+s*r-o*n,c=l*n+o*i-a*r,h=l*r+a*n-s*i,f=-a*i-s*n-o*r;return t.x=u*l+f*-a+c*-o-h*-s,t.y=c*l+f*-s+h*-a-u*-o,t.z=h*l+f*-o+u*-s-c*-a,t},v.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},v.prototype.toEuler=function(e,t){var i,n,r;t=t||"YZX";var a=this.x,s=this.y,o=this.z,l=this.w;switch(t){case"YZX":var u=a*s+o*l;if(.499<u&&(i=2*Math.atan2(a,l),n=Math.PI/2,r=0),u<-.499&&(i=-2*Math.atan2(a,l),n=-Math.PI/2,r=0),isNaN(i)){var c=a*a,h=s*s,f=o*o;i=Math.atan2(2*s*l-2*a*o,1-2*h-2*f),n=Math.asin(2*u),r=Math.atan2(2*a*l-2*s*o,1-2*c-2*f)}break;default:throw new Error("Euler order "+t+" not supported yet.")}e.y=i,e.z=n,e.x=r},v.prototype.setFromEuler=function(e,t,i,n){n=n||"XYZ";var r=Math.cos(e/2),a=Math.cos(t/2),s=Math.cos(i/2),o=Math.sin(e/2),l=Math.sin(t/2),u=Math.sin(i/2);return"XYZ"===n?(this.x=o*a*s+r*l*u,this.y=r*l*s-o*a*u,this.z=r*a*u+o*l*s,this.w=r*a*s-o*l*u):"YXZ"===n?(this.x=o*a*s+r*l*u,this.y=r*l*s-o*a*u,this.z=r*a*u-o*l*s,this.w=r*a*s+o*l*u):"ZXY"===n?(this.x=o*a*s-r*l*u,this.y=r*l*s+o*a*u,this.z=r*a*u+o*l*s,this.w=r*a*s-o*l*u):"ZYX"===n?(this.x=o*a*s-r*l*u,this.y=r*l*s+o*a*u,this.z=r*a*u-o*l*s,this.w=r*a*s+o*l*u):"YZX"===n?(this.x=o*a*s+r*l*u,this.y=r*l*s+o*a*u,this.z=r*a*u-o*l*s,this.w=r*a*s-o*l*u):"XZY"===n&&(this.x=o*a*s-r*l*u,this.y=r*l*s-o*a*u,this.z=r*a*u+o*l*s,this.w=r*a*s+o*l*u),this},v.prototype.clone=function(){return new v(this.x,this.y,this.z,this.w)},v.prototype.slerp=function(e,t,i){i=i||new v;var n,r,a,s,o,l=this.x,u=this.y,c=this.z,h=this.w,f=e.x,d=e.y,_=e.z,p=e.w;return(r=l*f+u*d+c*_+h*p)<0&&(r=-r,f=-f,d=-d,_=-_,p=-p),o=1e-6<1-r?(n=Math.acos(r),a=Math.sin(n),s=Math.sin((1-t)*n)/a,Math.sin(t*n)/a):(s=1-t,t),i.x=s*l+o*f,i.y=s*u+o*d,i.z=s*c+o*_,i.w=s*h+o*p,i},v.prototype.integrate=function(e,t,i,n){n=n||new v;var r=e.x*i.x,a=e.y*i.y,s=e.z*i.z,o=this.x,l=this.y,u=this.z,c=this.w,h=.5*t;return n.x+=h*(r*c+a*u-s*l),n.y+=h*(a*c+s*o-r*u),n.z+=h*(s*c+r*l-a*o),n.w+=h*(-r*o-a*l-s*u),n}},{"./Vec3":31}],30:[function(e,t,i){var r=e("./Vec3"),n=e("./Quaternion");function a(e){e=e||{},this.position=new r,e.position&&this.position.copy(e.position),this.quaternion=new n,e.quaternion&&this.quaternion.copy(e.quaternion)}t.exports=a;var s=new n;a.pointToLocalFrame=function(e,t,i,n){return n=n||new r,i.vsub(e,n),t.conjugate(s),s.vmult(n,n),n},a.prototype.pointToLocal=function(e,t){return a.pointToLocalFrame(this.position,this.quaternion,e,t)},a.pointToWorldFrame=function(e,t,i,n){return n=n||new r,t.vmult(i,n),n.vadd(e,n),n},a.prototype.pointToWorld=function(e,t){return a.pointToWorldFrame(this.position,this.quaternion,e,t)},a.prototype.vectorToWorldFrame=function(e,t){return t=t||new r,this.quaternion.vmult(e,t),t},a.vectorToWorldFrame=function(e,t,i){return e.vmult(t,i),i},a.vectorToLocalFrame=function(e,t,i,n){return n=n||new r,t.w*=-1,t.vmult(i,n),t.w*=-1,n}},{"./Quaternion":29,"./Vec3":31}],31:[function(e,t,i){t.exports=l;var n=e("./Mat3");function l(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0}l.ZERO=new l(0,0,0),l.UNIT_X=new l(1,0,0),l.UNIT_Y=new l(0,1,0),l.UNIT_Z=new l(0,0,1),l.prototype.cross=function(e,t){var i=e.x,n=e.y,r=e.z,a=this.x,s=this.y,o=this.z;return(t=t||new l).x=s*r-o*n,t.y=o*i-a*r,t.z=a*n-s*i,t},l.prototype.set=function(e,t,i){return this.x=e,this.y=t,this.z=i,this},l.prototype.setZero=function(){this.x=this.y=this.z=0},l.prototype.vadd=function(e,t){if(!t)return new l(this.x+e.x,this.y+e.y,this.z+e.z);t.x=e.x+this.x,t.y=e.y+this.y,t.z=e.z+this.z},l.prototype.vsub=function(e,t){if(!t)return new l(this.x-e.x,this.y-e.y,this.z-e.z);t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},l.prototype.crossmat=function(){return new n([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},l.prototype.normalize=function(){var e=this.x,t=this.y,i=this.z,n=Math.sqrt(e*e+t*t+i*i);if(0<n){var r=1/n;this.x*=r,this.y*=r,this.z*=r}else this.x=0,this.y=0,this.z=0;return n},l.prototype.unit=function(e){e=e||new l;var t=this.x,i=this.y,n=this.z,r=Math.sqrt(t*t+i*i+n*n);return 0<r?(r=1/r,e.x=t*r,e.y=i*r,e.z=n*r):(e.x=1,e.y=0,e.z=0),e},l.prototype.length=l.prototype.norm=function(){var e=this.x,t=this.y,i=this.z;return Math.sqrt(e*e+t*t+i*i)},l.prototype.lengthSquared=l.prototype.norm2=function(){return this.dot(this)},l.prototype.distanceTo=function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return Math.sqrt((r-t)*(r-t)+(a-i)*(a-i)+(s-n)*(s-n))},l.prototype.distanceSquared=function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return(r-t)*(r-t)+(a-i)*(a-i)+(s-n)*(s-n)},l.prototype.mult=function(e,t){t=t||new l;var i=this.x,n=this.y,r=this.z;return t.x=e*i,t.y=e*n,t.z=e*r,t},l.prototype.vmul=function(e,t){return(t=t||new l).x=e.x*this.x,t.y=e.y*this.y,t.z=e.z*this.z,t},l.prototype.scale=l.prototype.mult,l.prototype.addScaledVector=function(e,t,i){return(i=i||new l).x=this.x+e*t.x,i.y=this.y+e*t.y,i.z=this.z+e*t.z,i},l.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},l.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},l.prototype.negate=function(e){return(e=e||new l).x=-this.x,e.y=-this.y,e.z=-this.z,e};var s=new l,o=new l;l.prototype.tangents=function(e,t){var i=this.norm();if(0<i){var n=s,r=1/i;n.set(this.x*r,this.y*r,this.z*r);var a=o;Math.abs(n.x)<.9?a.set(1,0,0):a.set(0,1,0),n.cross(a,e),n.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)},l.prototype.toString=function(){return this.x+","+this.y+","+this.z},l.prototype.toArray=function(){return[this.x,this.y,this.z]},l.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},l.prototype.lerp=function(e,t,i){var n=this.x,r=this.y,a=this.z;i.x=n+(e.x-n)*t,i.y=r+(e.y-r)*t,i.z=a+(e.z-a)*t},l.prototype.almostEquals=function(e,t){return void 0===t&&(t=1e-6),!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)},l.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)};var r=new l;l.prototype.isAntiparallelTo=function(e,t){return this.negate(r),r.almostEquals(e,t)},l.prototype.clone=function(){return new l(this.x,this.y,this.z)}},{"./Mat3":28}],32:[function(e,t,i){t.exports=y;var n=e("../utils/EventTarget"),a=(e("../shapes/Shape"),e("../math/Vec3")),r=e("../math/Mat3"),s=e("../math/Quaternion"),o=(e("../material/Material"),e("../collision/AABB")),l=e("../shapes/Box"),u=e("../world/World");function y(e){e=e||{},n.apply(this),this.id=y.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new a,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionResponse=!0,this.position=new a,this.previousPosition=new a,this.interpolatedPosition=new a,this.initPosition=new a,e.position&&(this.position.copy(e.position),this.previousPosition.copy(e.position),this.interpolatedPosition.copy(e.position),this.initPosition.copy(e.position)),this.velocity=new a,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new a,this.force=new a;var t="number"==typeof e.mass?e.mass:0;this.mass=t,this.invMass=0<t?1/t:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=t<=0?y.STATIC:y.DYNAMIC,typeof e.type==typeof y.STATIC&&(this.type=e.type),this.allowSleep=void 0===e.allowSleep||e.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new a,this.quaternion=new s,this.initQuaternion=new s,this.previousQuaternion=new s,this.interpolatedQuaternion=new s,e.quaternion&&(this.quaternion.copy(e.quaternion),this.initQuaternion.copy(e.quaternion),this.previousQuaternion.copy(e.quaternion),this.interpolatedQuaternion.copy(e.quaternion)),this.angularVelocity=new a,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new a,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new a,this.invInertia=new a,this.invInertiaWorld=new r,this.invMassSolve=0,this.invInertiaSolve=new a,this.invInertiaWorldSolve=new r,this.fixedRotation=void 0!==e.fixedRotation&&e.fixedRotation,this.useGravity=!0,this.angularDamping=void 0!==e.angularDamping?e.angularDamping:.01,this.linearFactor=new a(1,1,1),e.linearFactor&&this.linearFactor.copy(e.linearFactor),this.angularFactor=new a(1,1,1),e.angularFactor&&this.angularFactor.copy(e.angularFactor),this.aabb=new o,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new a,e.shape&&this.addShape(e.shape),this.updateMassProperties()}((y.prototype=new n).constructor=y).COLLIDE_EVENT_NAME="collide",y.DYNAMIC=1,y.STATIC=2,y.KINEMATIC=4,y.AWAKE=0,y.SLEEPY=1,y.SLEEPING=2,y.idCounter=0,y.wakeupEvent={type:"wakeup"},y.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,this._wakeUpAfterNarrowphase=!1,e===y.SLEEPING&&this.dispatchEvent(y.wakeupEvent)},y.prototype.sleep=function(){this.sleepState=y.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this._wakeUpAfterNarrowphase=!1},y.sleepyEvent={type:"sleepy"},y.sleepEvent={type:"sleep"},y.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState,i=this.velocity.norm2()+this.angularVelocity.norm2(),n=Math.pow(this.sleepSpeedLimit,2);t===y.AWAKE&&i<n?(this.sleepState=y.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(y.sleepyEvent)):t===y.SLEEPY&&n<i?this.wakeUp():t===y.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(y.sleepEvent))}},y.prototype.updateSolveMassProperties=function(){this.sleepState===y.SLEEPING||this.type===y.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},y.prototype.pointToLocalFrame=function(e,t){return t=t||new a,e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t},y.prototype.vectorToLocalFrame=function(e,t){return t=t||new a,this.quaternion.conjugate().vmult(e,t),t},y.prototype.pointToWorldFrame=function(e,t){return t=t||new a,this.quaternion.vmult(e,t),t.vadd(this.position,t),t},y.prototype.vectorToWorldFrame=function(e,t){return t=t||new a,this.quaternion.vmult(e,t),t};var h=new a,f=new s;y.prototype.addShape=function(e,t,i){if(-1===this.shapes.indexOf(e)){var n=new a,r=new s;return t&&n.copy(t),i&&r.copy(i),u.idToShapeMap[e.id]=e,this.shapes.push(e),this.shapeOffsets.push(n),this.shapeOrientations.push(r),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,e.body=this}},y.prototype.removeShape=function(e){var t=this.shapes.indexOf(e);-1!==t&&(this.shapes.splice(t,1),this.shapeOffsets.splice(t,1),this.shapeOrientations.splice(t,1),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0)},y.prototype.updateBoundingRadius=function(){for(var e=this.shapes,t=this.shapeOffsets,i=e.length,n=0,r=0;r!==i;r++){var a=e[r];a.updateBoundingSphereRadius();var s=t[r].norm(),o=a.boundingSphereRadius;n<s+o&&(n=s+o)}this.boundingRadius=n};var d=new o;y.prototype.computeAABB=function(){for(var e=this.shapes,t=this.shapeOffsets,i=this.shapeOrientations,n=e.length,r=h,a=f,s=this.quaternion,o=this.aabb,l=d,u=0;u!==n;u++){var c=e[u];s.vmult(t[u],r),r.vadd(this.position,r),i[u].mult(s,a),c.calculateWorldAABB(r,a,l.lowerBound,l.upperBound),0===u?o.copy(l):o.extend(l)}this.aabbNeedsUpdate=!1};var c=new r,_=new r;new r,y.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x!==t.y||t.y!==t.z||e){var i=c,n=_;i.setRotationFromQuaternion(this.quaternion),i.transpose(n),i.scale(t,i),i.mmult(n,this.invInertiaWorld)}};var p=new a;y.prototype.applyForce=function(e,t){if(this.type===y.DYNAMIC){var i=p;t.cross(e,i),this.force.vadd(e,this.force),this.torque.vadd(i,this.torque)}};var v=new a,m=new a;y.prototype.applyLocalForce=function(e,t){if(this.type===y.DYNAMIC){var i=v,n=m;this.vectorToWorldFrame(e,i),this.vectorToWorldFrame(t,n),this.applyForce(i,n)}};var g=new a,b=new a;y.prototype.applyImpulse=function(e,t){if(this.type===y.DYNAMIC){var i=t,n=g;n.copy(e),n.mult(this.invMass,n),this.velocity.vadd(n,this.velocity);var r=b;i.cross(e,r),this.invInertiaWorld.vmult(r,r),this.angularVelocity.vadd(r,this.angularVelocity)}};var x=new a,S=new a;y.prototype.applyLocalImpulse=function(e,t){if(this.type===y.DYNAMIC){var i=x,n=S;this.vectorToWorldFrame(e,i),this.vectorToWorldFrame(t,n),this.applyImpulse(i,n)}};var T=new a;y.prototype.updateMassProperties=function(){var e=T;this.invMass=0<this.mass?1/this.mass:0;var t=this.inertia,i=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),l.calculateInertia(e,this.mass,t),this.invInertia.set(0<t.x&&!i?1/t.x:0,0<t.y&&!i?1/t.y:0,0<t.z&&!i?1/t.z:0),this.updateInertiaWorld(!0)},y.prototype.getVelocityAtWorldPoint=function(e,t){var i=new a;return e.vsub(this.position,i),this.angularVelocity.cross(i,t),this.velocity.vadd(t,t),t},y.prototype.integrate=function(e,t,i){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===y.DYNAMIC||this.type===y.KINEMATIC)&&this.sleepState!==y.SLEEPING){var n=this.velocity,r=this.angularVelocity,a=this.position,s=this.force,o=this.torque,l=this.quaternion,u=this.invMass,c=this.invInertiaWorld,h=this.linearFactor,f=u*e;n.x+=s.x*f*h.x,n.y+=s.y*f*h.y,n.z+=s.z*f*h.z;var d=c.elements,_=this.angularFactor,p=o.x*_.x,v=o.y*_.y,m=o.z*_.z;r.x+=e*(d[0]*p+d[1]*v+d[2]*m),r.y+=e*(d[3]*p+d[4]*v+d[5]*m),r.z+=e*(d[6]*p+d[7]*v+d[8]*m),a.x+=n.x*e,a.y+=n.y*e,a.z+=n.z*e,l.integrate(this.angularVelocity,e,this.angularFactor,l),t&&(i?l.normalizeFast():l.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}},y.prototype.isSleeping=function(){return this.sleepState===y.SLEEPING},y.prototype.isSleepy=function(){return this.sleepState===y.SLEEPY},y.prototype.isAwake=function(){return this.sleepState===y.AWAKE}},{"../collision/AABB":3,"../material/Material":26,"../math/Mat3":28,"../math/Quaternion":29,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Shape":44,"../utils/EventTarget":50,"../world/World":57}],33:[function(e,t,i){e("./Body");var E=e("../math/Vec3"),c=e("../math/Quaternion"),n=(e("../collision/RaycastResult"),e("../collision/Ray")),r=e("../objects/WheelInfo");function a(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:1,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:0,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:2}t.exports=a,new E,new E,new E;var h=new E,f=new E,d=new E;new n,a.prototype.addWheel=function(e){var t=new r(e=e||{}),i=this.wheelInfos.length;return this.wheelInfos.push(t),i},a.prototype.setSteeringValue=function(e,t){this.wheelInfos[t].steering=e},new E,a.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e},a.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e},a.prototype.addToWorld=function(e){this.constraints,e.addBody(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},a.prototype.getVehicleAxisWorld=function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)},a.prototype.updateVehicle=function(e){for(var t=this.wheelInfos,i=t.length,n=this.chassisBody,r=0;r<i;r++)this.updateWheelTransform(r);this.currentVehicleSpeedKmHour=3.6*n.velocity.norm();var a=new E;for(this.getVehicleAxisWorld(this.indexForwardAxis,a),a.dot(n.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),r=0;r<i;r++)this.castRay(t[r]);this.updateSuspension(e);var s=new E,o=new E;for(r=0;r<i;r++){var l=(f=t[r]).suspensionForce;l>f.maxSuspensionForce&&(l=f.maxSuspensionForce),f.raycastResult.hitNormalWorld.scale(l*e,s),f.raycastResult.hitPointWorld.vsub(n.position,o),n.applyImpulse(s,o)}this.updateFriction(e);var u=new E,c=new E,h=new E;for(r=0;r<i;r++){var f=t[r];n.getVelocityAtWorldPoint(f.chassisConnectionPointWorld,h);var d=1;switch(this.indexUpAxis){case 1:d=-1}if(f.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,c);var _=c.dot(f.raycastResult.hitNormalWorld);f.raycastResult.hitNormalWorld.scale(_,u),c.vsub(u,c);var p=c.dot(h);f.deltaRotation=d*p*e/f.radius}!f.sliding&&f.isInContact||0===f.engineForce||!f.useCustomSlidingRotationalSpeed||(f.deltaRotation=(0<f.engineForce?1:-1)*f.customSlidingRotationalSpeed*e),Math.abs(f.brake)>Math.abs(f.engineForce)&&(f.deltaRotation=0),f.rotation+=f.deltaRotation,f.deltaRotation*=.99}},a.prototype.updateSuspension=function(e){for(var t=this.chassisBody.mass,i=this.wheelInfos,n=i.length,r=0;r<n;r++){var a=i[r];if(a.isInContact){var s,o=a.suspensionRestLength-a.suspensionLength;s=a.suspensionStiffness*o*a.clippedInvContactDotSuspension;var l=a.suspensionRelativeVelocity;s-=(l<0?a.dampingCompression:a.dampingRelaxation)*l,a.suspensionForce=s*t,a.suspensionForce<0&&(a.suspensionForce=0)}else a.suspensionForce=0}},a.prototype.removeFromWorld=function(e){this.constraints,e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null};var m=new E,y=new E;a.prototype.castRay=function(e){var t=m,i=y;this.updateWheelTransformWorld(e);var n=this.chassisBody,r=-1,a=e.suspensionRestLength+e.radius;e.directionWorld.scale(a,t);var s=e.chassisConnectionPointWorld;s.vadd(t,i);var o=e.raycastResult;o.reset();var l=n.collisionResponse;n.collisionResponse=!1,this.world.rayTest(s,i,o),n.collisionResponse=l;var u=o.body;if(e.raycastResult.groundObject=0,u){r=o.distance,e.raycastResult.hitNormalWorld=o.hitNormalWorld,e.isInContact=!0;var c=o.distance;e.suspensionLength=c-e.radius;var h=e.suspensionRestLength-e.maxSuspensionTravel,f=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<h&&(e.suspensionLength=h),e.suspensionLength>f&&(e.suspensionLength=f,e.raycastResult.reset());var d=e.raycastResult.hitNormalWorld.dot(e.directionWorld),_=new E;n.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,_);var p=e.raycastResult.hitNormalWorld.dot(_);if(-.1<=d)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var v=-1/d;e.suspensionRelativeVelocity=p*v,e.clippedInvContactDotSuspension=v}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return r},a.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)},a.prototype.updateWheelTransform=function(e){var t=h,i=f,n=d,r=this.wheelInfos[e];this.updateWheelTransformWorld(r),r.directionLocal.scale(-1,t),i.copy(r.axleLocal),t.cross(i,n),n.normalize(),i.normalize();var a=r.steering,s=new c;s.setFromAxisAngle(t,a);var o=new c;o.setFromAxisAngle(i,r.rotation);var l=r.worldTransform.quaternion;this.chassisBody.quaternion.mult(s,l),l.mult(o,l),l.normalize();var u=r.worldTransform.position;u.copy(r.directionWorld),u.scale(r.suspensionLength,u),u.vadd(r.chassisConnectionPointWorld,u)};var A=[new E(1,0,0),new E(0,1,0),new E(0,0,1)];a.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var C=new E,k=[],R=[];a.prototype.updateFriction=function(e){for(var t=C,i=this.wheelInfos,n=i.length,r=this.chassisBody,a=R,s=k,o=0;o<n;o++)h=(b=i[o]).raycastResult.body,b.sideImpulse=0,b.forwardImpulse=0,a[o]||(a[o]=new E),s[o]||(s[o]=new E);for(o=0;o<n;o++)if(h=(b=i[o]).raycastResult.body){var l=s[o];this.getWheelTransformWorld(o).vectorToWorldFrame(A[this.indexRightAxis],l);var u=b.raycastResult.hitNormalWorld,c=l.dot(u);u.scale(c,t),l.vsub(t,l),l.normalize(),u.cross(l,a[o]),a[o].normalize(),b.sideImpulse=M(r,b.raycastResult.hitPointWorld,h,b.raycastResult.hitPointWorld,l),b.sideImpulse*=1}for(this.sliding=!1,o=0;o<n;o++){var h=(b=i[o]).raycastResult.body,f=0;if(b.slipInfo=1,h){var d=b.brake?b.brake:0;f=O(r,h,b.raycastResult.hitPointWorld,a[o],d);var _=d/(f+=b.engineForce*e);b.slipInfo*=_}if(b.forwardImpulse=0,b.skidInfo=1,h){b.skidInfo=1;var p=b.suspensionForce*e*b.frictionSlip,v=p*p;b.forwardImpulse=f;var m=.5*b.forwardImpulse,y=1*b.sideImpulse,g=m*m+y*y;b.sliding=!1,v<g&&(this.sliding=!0,b.sliding=!0,_=p/Math.sqrt(g),b.skidInfo*=_)}}if(this.sliding)for(o=0;o<n;o++)0!==(b=i[o]).sideImpulse&&b.skidInfo<1&&(b.forwardImpulse*=b.skidInfo,b.sideImpulse*=b.skidInfo);for(o=0;o<n;o++){var b=i[o],x=new E;if(b.raycastResult.hitPointWorld.vsub(r.position,x),0!==b.forwardImpulse){var S=new E;a[o].scale(b.forwardImpulse,S),r.applyImpulse(S,x)}if(0!==b.sideImpulse){h=b.raycastResult.body;var T=new E;b.raycastResult.hitPointWorld.vsub(h.position,T);var w=new E;s[o].scale(b.sideImpulse,w),r.vectorToLocalFrame(x,x),x["xyz"[this.indexUpAxis]]*=b.rollInfluence,r.vectorToWorldFrame(x,x),r.applyImpulse(w,x),w.scale(-1,w),h.applyImpulse(w,T)}}};var _=new E,p=new E,v=new E;function O(e,t,i,n,r){var a=0,s=i,o=_,l=p,u=v;return e.getVelocityAtWorldPoint(s,o),t.getVelocityAtWorldPoint(s,l),o.vsub(l,u),r<(a=-n.dot(u)*(1/(b(e,i,n)+b(t,i,n))))&&(a=r),a<-r&&(a=-r),a}var o=new E,l=new E,u=new E,g=new E;function b(e,t,i){var n=o,r=l,a=u,s=g;return t.vsub(e.position,n),n.cross(i,r),e.invInertiaWorld.vmult(r,s),s.cross(n,a),e.invMass+i.dot(a)}var x=new E,S=new E,T=new E;function M(e,t,i,n,r){if(1.1<r.norm2())return 0;var a=x,s=S,o=T;return e.getVelocityAtWorldPoint(t,a),i.getVelocityAtWorldPoint(n,s),a.vsub(s,o),-.2*r.dot(o)*(1/(e.invMass+i.invMass))}},{"../collision/Ray":10,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Vec3":31,"../objects/WheelInfo":37,"./Body":32}],34:[function(e,t,i){var s=e("./Body"),o=e("../shapes/Sphere"),n=e("../shapes/Box"),l=e("../math/Vec3"),u=e("../constraints/HingeConstraint");function r(e){if(this.wheelBodies=[],this.coordinateSystem=void 0===e.coordinateSystem?new l(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var t=new n(new l(5,2,.5));this.chassisBody=new s(1,t)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}(t.exports=r).prototype.addWheel=function(e){var t=(e=e||{}).body;t=t||new s(1,new o(1.2)),this.wheelBodies.push(t),this.wheelForces.push(0),new l;var i=void 0!==e.position?e.position.clone():new l,n=new l;this.chassisBody.pointToWorldFrame(i,n),t.position.set(n.x,n.y,n.z);var r=void 0!==e.axis?e.axis.clone():new l(0,1,0);this.wheelAxes.push(r);var a=new u(this.chassisBody,t,{pivotA:i,axisA:r,pivotB:l.ZERO,axisB:r,collideConnected:!1});return this.constraints.push(a),this.wheelBodies.length-1},r.prototype.setSteeringValue=function(e,t){var i=this.wheelAxes[t],n=Math.cos(e),r=Math.sin(e),a=i.x,s=i.y;this.constraints[t].axisA.set(n*a-r*s,r*a+n*s,0)},r.prototype.setMotorSpeed=function(e,t){var i=this.constraints[t];i.enableMotor(),i.motorTargetVelocity=e},r.prototype.disableMotor=function(e){this.constraints[e].disableMotor()};var a=new l;r.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e},r.prototype.applyWheelForce=function(e,t){var i=this.wheelAxes[t],n=this.wheelBodies[t],r=n.torque;i.scale(e,a),n.vectorToWorldFrame(a,a),r.vadd(a,r)},r.prototype.addToWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)e.addBody(i[n]);for(n=0;n<t.length;n++)e.addConstraint(t[n]);e.addEventListener("preStep",this._update.bind(this))},r.prototype._update=function(){for(var e=this.wheelForces,t=0;t<e.length;t++)this.applyWheelForce(e[t],t)},r.prototype.removeFromWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)e.remove(i[n]);for(n=0;n<t.length;n++)e.removeConstraint(t[n])};var c=new l;r.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e],i=this.wheelBodies[e].angularVelocity;return this.chassisBody.vectorToWorldFrame(t,c),i.dot(c)}},{"../constraints/HingeConstraint":16,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Sphere":45,"./Body":32}],35:[function(e,t,i){t.exports=r,e("../shapes/Shape");var n=e("../math/Vec3");function r(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e("../math/Quaternion"),e("../shapes/Particle"),e("../objects/Body"),e("../material/Material"),r.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},r.prototype.remove=function(e){var t=this.particles.indexOf(e);-1!==t&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var l=new n;r.prototype.getNeighbors=function(e,t){for(var i=this.particles.length,n=e.id,r=this.smoothingRadius*this.smoothingRadius,a=l,s=0;s!==i;s++){var o=this.particles[s];o.position.vsub(e.position,a),n!==o.id&&a.norm2()<r&&t.push(o)}};var S=new n,T=new n,w=new n,E=new n,A=new n,C=new n;r.prototype.update=function(){for(var e=this.particles.length,t=S,i=this.speedOfSound,n=this.eps,r=0;r!==e;r++){var a=this.particles[r];(y=this.neighbors[r]).length=0,this.getNeighbors(a,y),y.push(this.particles[r]);for(var s=y.length,o=0,l=0;l!==s;l++){a.position.vsub(y[l].position,t);var u=t.norm(),c=this.w(u);o+=y[l].mass*c}this.densities[r]=o,this.pressures[r]=i*i*(this.densities[r]-this.density)}var h=T,f=w,d=E,_=A,p=C;for(r=0;r!==e;r++){var v,m,y,g=this.particles[r];for(h.set(0,0,0),f.set(0,0,0),s=(y=this.neighbors[r]).length,l=0;l!==s;l++){var b=y[l];g.position.vsub(b.position,_);var x=_.norm();v=-b.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+n)+this.pressures[l]/(this.densities[l]*this.densities[l]+n)),this.gradw(_,d),d.mult(v,d),h.vadd(d,h),b.velocity.vsub(g.velocity,p),p.mult(1/(1e-4+this.densities[r]*this.densities[l])*this.viscosity*b.mass,p),m=this.nablaw(x),p.mult(m,p),f.vadd(p,f)}f.mult(g.mass,f),h.mult(g.mass,h),g.force.vadd(f,g.force),g.force.vadd(h,g.force)}},r.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)},r.prototype.gradw=function(e,t){var i=e.norm(),n=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(n,9))*Math.pow(n*n-i*i,2),t)},r.prototype.nablaw=function(e){var t=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t)}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Particle":42,"../shapes/Shape":44}],36:[function(e,t,i){var n=e("../math/Vec3");function r(e,t,i){i=i||{},this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=e,this.bodyB=t,this.localAnchorA=new n,this.localAnchorB=new n,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}(t.exports=r).prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},r.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},r.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},r.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var m=new n,y=new n,g=new n,b=new n,x=new n,S=new n,T=new n,w=new n,E=new n,A=new n,C=new n;r.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,i=this.restLength,n=this.bodyA,r=this.bodyB,a=m,s=y,o=g,l=b,u=C,c=x,h=S,f=T,d=w,_=E,p=A;this.getWorldAnchorA(c),this.getWorldAnchorB(h),c.vsub(n.position,f),h.vsub(r.position,d),h.vsub(c,a);var v=a.norm();s.copy(a),s.normalize(),r.velocity.vsub(n.velocity,o),r.angularVelocity.cross(d,u),o.vadd(u,o),n.angularVelocity.cross(f,u),o.vsub(u,o),s.mult(-e*(v-i)-t*o.dot(s),l),n.force.vsub(l,n.force),r.force.vadd(l,r.force),f.cross(l,_),d.cross(l,p),n.torque.vsub(_,n.torque),r.torque.vadd(p,r.torque)}},{"../math/Vec3":31}],37:[function(e,t,i){var n=e("../math/Vec3"),r=e("../math/Transform"),a=e("../collision/RaycastResult"),s=e("../utils/Utils");function o(e){e=s.defaults(e,{chassisConnectionPointLocal:new n,chassisConnectionPointWorld:new n,directionLocal:new n,directionWorld:new n,axleLocal:new n,axleWorld:new n,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new a,this.worldTransform=new r,this.isInContact=!1}t.exports=o;var l=new n,u=new n;l=new n,o.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var i=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,u),e.getVelocityAtWorldPoint(u,l);var n=t.hitNormalWorld.dot(l);if(-.1<=i)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var r=-1/i;this.suspensionRelativeVelocity=n*r,this.clippedInvContactDotSuspension=r}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":11,"../math/Transform":30,"../math/Vec3":31,"../utils/Utils":54}],38:[function(e,t,i){t.exports=r;var n=e("./Shape"),s=e("../math/Vec3"),o=e("./ConvexPolyhedron");function r(e){n.call(this,{type:n.types.BOX}),this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}((r.prototype=new n).constructor=r).prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,t=this.halfExtents.y,i=this.halfExtents.z,n=s,r=[new n(-e,-t,-i),new n(e,-t,-i),new n(e,t,-i),new n(-e,t,-i),new n(-e,-t,i),new n(e,-t,i),new n(e,t,i),new n(-e,t,i)],a=(new n(0,0,1),new n(0,1,0),new n(1,0,0),new o(r,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]]));(this.convexPolyhedronRepresentation=a).material=this.material},r.prototype.calculateLocalInertia=function(e,t){return t=t||new s,r.calculateInertia(this.halfExtents,e,t),t},r.calculateInertia=function(e,t,i){var n=e;n.isZero()?(i.x=2/12*t,i.y=2/12*t,i.z=2/12*t):(i.x=1/12*t*(2*n.y*2*n.y+2*n.z*2*n.z),i.y=1/12*t*(2*n.x*2*n.x+2*n.z*2*n.z),i.z=1/12*t*(2*n.y*2*n.y+2*n.x*2*n.x))},r.prototype.getSideNormals=function(e,t){var i=e,n=this.halfExtents;if(i[0].set(n.x,0,0),i[1].set(0,n.y,0),i[2].set(0,0,n.z),i[3].set(-n.x,0,0),i[4].set(0,-n.y,0),i[5].set(0,0,-n.z),void 0!==t)for(var r=0;r!==i.length;r++)t.vmult(i[r],i[r]);return i},r.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var l=new s;new s,r.prototype.forEachWorldCorner=function(e,t,i){for(var n=this.halfExtents,r=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]],a=0;a<r.length;a++)l.set(r[a][0],r[a][1],r[a][2]),t.vmult(l,l),e.vadd(l,l),i(l.x,l.y,l.z)};var c=[new s,new s,new s,new s,new s,new s,new s,new s];r.prototype.calculateWorldAABB=function(e,t,i,n){var r=this.halfExtents;c[0].set(r.x,r.y,r.z),c[1].set(-r.x,r.y,r.z),c[2].set(-r.x,-r.y,r.z),c[3].set(-r.x,-r.y,-r.z),c[4].set(r.x,-r.y,-r.z),c[5].set(r.x,r.y,-r.z),c[6].set(-r.x,r.y,-r.z),c[7].set(r.x,-r.y,r.z);var a=c[0];t.vmult(a,a),e.vadd(a,a),n.copy(a),i.copy(a);for(var s=1;s<8;s++){a=c[s],t.vmult(a,a),e.vadd(a,a);var o=a.x,l=a.y,u=a.z;o>n.x&&(n.x=o),l>n.y&&(n.y=l),u>n.z&&(n.z=u),o<i.x&&(i.x=o),l<i.y&&(i.y=l),u<i.z&&(i.z=u)}}},{"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],39:[function(e,t,i){t.exports=f;var n=e("./Shape"),b=e("../math/Vec3"),p=(e("../math/Quaternion"),e("../math/Transform"));function f(e,t,i){n.call(this,{type:n.types.CONVEXPOLYHEDRON}),this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=t||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=i?i.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}(f.prototype=new n).constructor=f;var h=new b;f.prototype.computeEdges=function(){var e=this.faces,t=this.vertices,i=(t.length,this.uniqueEdges);i.length=0;for(var n=h,r=0;r!==e.length;r++)for(var a=e[r],s=a.length,o=0;o!==s;o++){var l=(o+1)%s;t[a[o]].vsub(t[a[l]],n),n.normalize();for(var u=!1,c=0;c!==i.length;c++)if(i[c].almostEquals(n)||i[c].almostEquals(n)){u=!0;break}u||i.push(n.clone())}},f.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");var i=this.faceNormals[e]||new b;this.getFaceNormal(e,i),i.negate(i),this.faceNormals[e]=i;var n=this.vertices[this.faces[e][0]];if(i.dot(n)<0)for(console.error(".faceNormals["+e+"] = Vec3("+i.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule."),t=0;t<this.faces[e].length;t++)console.warn(".vertices["+this.faces[e][t]+"] = Vec3("+this.vertices[this.faces[e][t]].toString()+")")}};var r=new b,a=new b;f.computeNormal=function(e,t,i,n){t.vsub(e,a),i.vsub(t,r),r.cross(a,n),n.isZero()||n.normalize()},f.prototype.getFaceNormal=function(e,t){var i=this.faces[e],n=this.vertices[i[0]],r=this.vertices[i[1]],a=this.vertices[i[2]];return f.computeNormal(n,r,a,t)};var x=new b;f.prototype.clipAgainstHull=function(e,t,i,n,r,a,s,o,l){for(var u=x,c=-1,h=-Number.MAX_VALUE,f=0;f<i.faces.length;f++){u.copy(i.faceNormals[f]),r.vmult(u,u);var d=u.dot(a);h<d&&(h=d,c=f)}for(var _=[],p=i.faces[c],v=p.length,m=0;m<v;m++){var y=i.vertices[p[m]],g=new b;g.copy(y),r.vmult(g,g),n.vadd(g,g),_.push(g)}0<=c&&this.clipFaceAgainstHull(a,e,t,_,s,o,l)};var w=new b,E=new b,A=new b,C=new b,k=new b,R=new b;f.prototype.findSeparatingAxis=function(e,t,i,n,r,a,s,o){var l=w,u=E,c=A,h=C,f=k,d=R,_=Number.MAX_VALUE,p=this;if(p.uniqueAxes)for(m=0;m!==p.uniqueAxes.length;m++){if(i.vmult(p.uniqueAxes[m],l),!1===(b=p.testSepAxis(l,e,t,i,n,r)))return!1;b<_&&(_=b,a.copy(l))}else for(var v=s?s.length:p.faces.length,m=0;m<v;m++){var y=s?s[m]:m;if(l.copy(p.faceNormals[y]),i.vmult(l,l),!1===(b=p.testSepAxis(l,e,t,i,n,r)))return!1;b<_&&(_=b,a.copy(l))}if(e.uniqueAxes)for(m=0;m!==e.uniqueAxes.length;m++){if(r.vmult(e.uniqueAxes[m],u),!1===(b=p.testSepAxis(u,e,t,i,n,r)))return!1;b<_&&(_=b,a.copy(u))}else for(var g=o?o.length:e.faces.length,m=0;m<g;m++){var b;if(y=o?o[m]:m,u.copy(e.faceNormals[y]),r.vmult(u,u),!1===(b=p.testSepAxis(u,e,t,i,n,r)))return!1;b<_&&(_=b,a.copy(u))}for(var x=0;x!==p.uniqueEdges.length;x++){i.vmult(p.uniqueEdges[x],h);for(var S=0;S!==e.uniqueEdges.length;S++)if(r.vmult(e.uniqueEdges[S],f),h.cross(f,d),!d.almostZero()){d.normalize();var T=p.testSepAxis(d,e,t,i,n,r);if(!1===T)return!1;T<_&&(_=T,a.copy(d))}}return n.vsub(t,c),0<c.dot(a)&&a.negate(a),!0};var d=[],_=[];f.prototype.testSepAxis=function(e,t,i,n,r,a){f.project(this,e,i,n,d),f.project(t,e,r,a,_);var s=d[0],o=d[1],l=_[0],u=_[1];if(s<u||l<o)return!1;var c=s-u,h=l-o;return c<h?c:h};var s=new b,o=new b;f.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(s,o);var i=o.x-s.x,n=o.y-s.y,r=o.z-s.z;t.x=1/12*e*(2*n*2*n+2*r*2*r),t.y=1/12*e*(2*i*2*i+2*r*2*r),t.z=1/12*e*(2*n*2*n+2*i*2*i)},f.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e],i=this.faceNormals[e],n=this.vertices[t[0]];return-i.dot(n)};var L=new b,P=new b,F=new b,z=new b,D=new b,N=new b,U=new b,V=new b;f.prototype.clipFaceAgainstHull=function(e,t,i,n,r,a,s){for(var o=L,l=P,u=F,c=z,h=D,f=N,d=U,_=V,p=n,v=[],m=-1,y=Number.MAX_VALUE,g=0;g<this.faces.length;g++){o.copy(this.faceNormals[g]),i.vmult(o,o);var b=o.dot(e);b<y&&(y=b,m=g)}if(!(m<0)){var x=this.faces[m];x.connectedFaces=[];for(var S=0;S<this.faces.length;S++)for(var T=0;T<this.faces[S].length;T++)-1!==x.indexOf(this.faces[S][T])&&S!==m&&-1===x.connectedFaces.indexOf(S)&&x.connectedFaces.push(S);p.length;for(var w=x.length,E=0;E<w;E++){var A=this.vertices[x[E]],C=this.vertices[x[(E+1)%w]];A.vsub(C,l),u.copy(l),i.vmult(u,u),t.vadd(u,u),c.copy(this.faceNormals[m]),i.vmult(c,c),t.vadd(c,c),u.cross(c,h),h.negate(h),f.copy(A),i.vmult(f,f),t.vadd(f,f),f.dot(h);var k=x.connectedFaces[E];d.copy(this.faceNormals[k]);var R=this.getPlaneConstantOfFace(k);_.copy(d),i.vmult(_,_);var O=R-_.dot(t);for(this.clipFaceAgainstPlane(p,v,_,O);p.length;)p.shift();for(;v.length;)p.push(v.shift())}for(d.copy(this.faceNormals[m]),R=this.getPlaneConstantOfFace(m),_.copy(d),i.vmult(_,_),O=R-_.dot(t),S=0;S<p.length;S++){var M=_.dot(p[S])+O;if(M<=r&&(M=r),M<=a){var I=p[S];if(M<=0){var B={point:I,normal:_,depth:M};s.push(B)}}}}},f.prototype.clipFaceAgainstPlane=function(e,t,i,n){var r,a,s=e.length;if(s<2)return t;var o=e[e.length-1],l=e[0];r=i.dot(o)+n;for(var u=0;u<s;u++){if(l=e[u],a=i.dot(l)+n,r<0)if(a<0)(c=new b).copy(l),t.push(c);else{var c=new b;o.lerp(l,r/(r-a),c),t.push(c)}else a<0&&(c=new b,o.lerp(l,r/(r-a),c),t.push(c),t.push(l));o=l,r=a}return t},f.prototype.computeWorldVertices=function(e,t){for(var i=this.vertices.length;this.worldVertices.length<i;)this.worldVertices.push(new b);for(var n=this.vertices,r=this.worldVertices,a=0;a!==i;a++)t.vmult(n[a],r[a]),e.vadd(r[a],r[a]);this.worldVerticesNeedsUpdate=!1},new b,f.prototype.computeLocalAABB=function(e,t){var i=this.vertices.length,n=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var r=0;r<i;r++){var a=n[r];a.x<e.x?e.x=a.x:a.x>t.x&&(t.x=a.x),a.y<e.y?e.y=a.y:a.y>t.y&&(t.y=a.y),a.z<e.z?e.z=a.z:a.z>t.z&&(t.z=a.z)}},f.prototype.computeWorldFaceNormals=function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new b);for(var i=this.faceNormals,n=this.worldFaceNormals,r=0;r!==t;r++)e.vmult(i[r],n[r]);this.worldFaceNormalsNeedsUpdate=!1},f.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=0,n=t.length;i!==n;i++){var r=t[i].norm2();e<r&&(e=r)}this.boundingSphereRadius=Math.sqrt(e)};var v=new b;f.prototype.calculateWorldAABB=function(e,t,i,n){for(var r,a,s,o,l,u,c=this.vertices.length,h=this.vertices,f=0;f<c;f++){v.copy(h[f]),t.vmult(v,v),e.vadd(v,v);var d=v;d.x<r||void 0===r?r=d.x:(d.x>o||void 0===o)&&(o=d.x),d.y<a||void 0===a?a=d.y:(d.y>l||void 0===l)&&(l=d.y),d.z<s||void 0===s?s=d.z:(d.z>u||void 0===u)&&(u=d.z)}i.set(r,a,s),n.set(o,l,u)},f.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},f.prototype.getAveragePointLocal=function(e){e=e||new b;for(var t=this.vertices.length,i=this.vertices,n=0;n<t;n++)e.vadd(i[n],e);return e.mult(1/t,e),e},f.prototype.transformAllPoints=function(e,t){var i=this.vertices.length,n=this.vertices;if(t){for(var r=0;r<i;r++){var a=n[r];t.vmult(a,a)}for(r=0;r<this.faceNormals.length;r++)a=this.faceNormals[r],t.vmult(a,a)}if(e)for(r=0;r<i;r++)(a=n[r]).vadd(e,a)};var m=new b,y=new b,g=new b;f.prototype.pointIsInside=function(e){var t=this.vertices.length,i=this.vertices,n=this.faces,r=this.faceNormals,a=this.faces.length,s=m;this.getAveragePointLocal(s);for(var o=0;o<a;o++){this.faces[o].length,t=r[o];var l=i[n[o][0]],u=y;e.vsub(l,u);var c=t.dot(u),h=g;s.vsub(l,h);var f=t.dot(h);if(c<0&&0<f||0<c&&f<0)return!1}return-1},new b;var S=new b,T=new b;f.project=function(e,t,i,n,r){var a=e.vertices.length,s=S,o=0,l=0,u=T,c=e.vertices;u.setZero(),p.vectorToLocalFrame(i,n,t,s),p.pointToLocalFrame(i,n,u,u);var h=u.dot(s);l=o=c[0].dot(s);for(var f=1;f<a;f++){var d=c[f].dot(s);o<d&&(o=d),d<l&&(l=d)}if((o-=h)<(l-=h)){var _=l;l=o,o=_}r[0]=o,r[1]=l}},{"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"./Shape":44}],40:[function(e,t,i){t.exports=n,e("./Shape");var v=e("../math/Vec3"),m=(e("../math/Quaternion"),e("./ConvexPolyhedron"));function n(e,t,i,n){var r=n,a=[],s=[],o=[],l=[],u=[],c=Math.cos,h=Math.sin;a.push(new v(t*c(0),t*h(0),.5*-i)),l.push(0),a.push(new v(e*c(0),e*h(0),.5*i)),u.push(1);for(var f=0;f<r;f++){var d=2*Math.PI/r*(f+1),_=2*Math.PI/r*(f+.5);f<r-1?(a.push(new v(t*c(d),t*h(d),.5*-i)),l.push(2*f+2),a.push(new v(e*c(d),e*h(d),.5*i)),u.push(2*f+3),o.push([2*f+2,2*f+3,2*f+1,2*f])):o.push([0,1,2*f+1,2*f]),(r%2==1||f<r/2)&&s.push(new v(c(_),h(_),0))}o.push(u),s.push(new v(0,0,1));var p=[];for(f=0;f<l.length;f++)p.push(l[l.length-f-1]);o.push(p),m.call(this,a,o,s)}n.prototype=new m},{"../math/Quaternion":29,"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],41:[function(e,t,i){var n=e("./Shape"),h=e("./ConvexPolyhedron"),f=e("../math/Vec3"),r=e("../utils/Utils");function a(e,t){t=r.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,n.call(this,{type:n.types.HEIGHTFIELD}),this.pillarConvex=new h,this.pillarOffset=new f,this.updateBoundingSphereRadius(),this._cachedPillars={}}((t.exports=a).prototype=new n).update=function(){this._cachedPillars={}},a.prototype.updateMinValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var n=0;n!==e[i].length;n++){var r=e[i][n];r<t&&(t=r)}this.minValue=t},a.prototype.updateMaxValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var n=0;n!==e[i].length;n++){var r=e[i][n];t<r&&(t=r)}this.maxValue=t},a.prototype.setHeightValueAtIndex=function(e,t,i){this.data[e][t]=i,this.clearCachedConvexTrianglePillar(e,t,!1),0<e&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),0<t&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),0<t&&0<e&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)},a.prototype.getRectMinMax=function(e,t,i,n,r){r=r||[];for(var a=this.data,s=this.minValue,o=e;o<=i;o++)for(var l=t;l<=n;l++){var u=a[o][l];s<u&&(s=u)}r[0]=this.minValue,r[1]=s},a.prototype.getIndexOfPosition=function(e,t,i,n){var r=this.elementSize,a=this.data,s=Math.floor(e/r),o=Math.floor(t/r);return i[0]=s,i[1]=o,n&&(s<0&&(s=0),o<0&&(o=0),s>=a.length-1&&(s=a.length-1),o>=a[0].length-1&&(o=a[0].length-1)),!(s<0||o<0||s>=a.length-1||o>=a[0].length-1)};var d=[],_=new f,p=new f,v=new f,m=new f;a.prototype.getTriangleAt=function(e,t,i,n,r,a){var s=d;this.getIndexOfPosition(e,t,s,i);var o=s[0],l=s[1],u=this.data;i&&(o=Math.min(u.length-2,Math.max(0,o)),l=Math.min(u[0].length-2,Math.max(0,l)));var c=this.elementSize,h=Math.pow(e/c-o,2)+Math.pow(t/c-l,2),f=Math.pow(e/c-(o+1),2)+Math.pow(t/c-(l+1),2)<h;return this.getTriangle(o,l,f,n,r,a),f};var u=new f,c=new f,y=new f,g=new f,b=new f;a.prototype.getNormalAt=function(e,t,i,n){var r=u,a=c,s=y,o=g,l=b;this.getTriangleAt(e,t,i,r,a,s),a.vsub(r,o),s.vsub(r,l),o.cross(l,n),n.normalize()},a.prototype.getAabbAtIndex=function(e,t,i){var n=this.data,r=this.elementSize;i.lowerBound.set(e*r,t*r,n[e][t]),i.upperBound.set((e+1)*r,(t+1)*r,n[e+1][t+1])},a.prototype.getHeightAt=function(e,t,i){var n=this.data,r=p,a=v,s=m,o=d;this.getIndexOfPosition(e,t,o,i);var l=o[0],u=o[1];i&&(l=Math.min(n.length-2,Math.max(0,l)),u=Math.min(n[0].length-2,Math.max(0,u)));var c=this.getTriangleAt(e,t,i,r,a,s);!function(e,t,i,n,r,a,s,o,l){l.x=((a-o)*(e-s)+(s-r)*(t-o))/((a-o)*(i-s)+(s-r)*(n-o)),l.y=((o-n)*(e-s)+(i-s)*(t-o))/((a-o)*(i-s)+(s-r)*(n-o)),l.z=1-l.x-l.y}(e,t,r.x,r.y,a.x,a.y,s.x,s.y,_);var h=_;return c?n[l+1][u+1]*h.x+n[l][u+1]*h.y+n[l+1][u]*h.z:n[l][u]*h.x+n[l+1][u]*h.y+n[l][u+1]*h.z},a.prototype.getCacheConvexTrianglePillarKey=function(e,t,i){return e+"_"+t+"_"+(i?1:0)},a.prototype.getCachedConvexTrianglePillar=function(e,t,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},a.prototype.setCachedConvexTrianglePillar=function(e,t,i,n,r){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]={convex:n,offset:r}},a.prototype.clearCachedConvexTrianglePillar=function(e,t,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},a.prototype.getTriangle=function(e,t,i,n,r,a){var s=this.data,o=this.elementSize;i?(n.set((e+1)*o,(t+1)*o,s[e+1][t+1]),r.set(e*o,(t+1)*o,s[e][t+1]),a.set((e+1)*o,t*o,s[e+1][t])):(n.set(e*o,t*o,s[e][t]),r.set((e+1)*o,t*o,s[e+1][t]),a.set(e*o,(t+1)*o,s[e][t+1]))},a.prototype.getConvexTrianglePillar=function(e,t,i){var n=this.pillarConvex,r=this.pillarOffset;if(this.cacheEnabled){if(a=this.getCachedConvexTrianglePillar(e,t,i))return this.pillarConvex=a.convex,void(this.pillarOffset=a.offset);n=new h,r=new f,this.pillarConvex=n,this.pillarOffset=r}var a=this.data,s=this.elementSize,o=n.faces;n.vertices.length=6;for(var l=0;l<6;l++)n.vertices[l]||(n.vertices[l]=new f);for(o.length=5,l=0;l<5;l++)o[l]||(o[l]=[]);var u=n.vertices,c=(Math.min(a[e][t],a[e+1][t],a[e][t+1],a[e+1][t+1])-this.minValue)/2+this.minValue;i?(r.set((e+.75)*s,(t+.75)*s,c),u[0].set(.25*s,.25*s,a[e+1][t+1]-c),u[1].set(-.75*s,.25*s,a[e][t+1]-c),u[2].set(.25*s,-.75*s,a[e+1][t]-c),u[3].set(.25*s,.25*s,-c-1),u[4].set(-.75*s,.25*s,-c-1),u[5].set(.25*s,-.75*s,-c-1),o[0][0]=0,o[0][1]=1,o[0][2]=2,o[1][0]=5,o[1][1]=4,o[1][2]=3,o[2][0]=2,o[2][1]=5,o[2][2]=3,o[2][3]=0,o[3][0]=3,o[3][1]=4,o[3][2]=1,o[3][3]=0,o[4][0]=1,o[4][1]=4,o[4][2]=5,o[4][3]=2):(r.set((e+.25)*s,(t+.25)*s,c),u[0].set(-.25*s,-.25*s,a[e][t]-c),u[1].set(.75*s,-.25*s,a[e+1][t]-c),u[2].set(-.25*s,.75*s,a[e][t+1]-c),u[3].set(-.25*s,-.25*s,-c-1),u[4].set(.75*s,-.25*s,-c-1),u[5].set(-.25*s,.75*s,-c-1),o[0][0]=0,o[0][1]=1,o[0][2]=2,o[1][0]=5,o[1][1]=4,o[1][2]=3,o[2][0]=0,o[2][1]=2,o[2][2]=5,o[2][3]=3,o[3][0]=1,o[3][1]=0,o[3][2]=3,o[3][3]=4,o[4][0]=4,o[4][1]=5,o[4][2]=2,o[4][3]=1),n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,i,n,r)},a.prototype.calculateLocalInertia=function(e,t){return(t=t||new f).set(0,0,0),t},a.prototype.volume=function(){return Number.MAX_VALUE},a.prototype.calculateWorldAABB=function(e,t,i,n){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},a.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new f(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()},a.prototype.setHeightsFromImage=function(e,t){var i=document.createElement("canvas");i.width=e.width,i.height=e.height;var n=i.getContext("2d");n.drawImage(e,0,0);var r=n.getImageData(0,0,e.width,e.height),a=this.data;a.length=0,this.elementSize=Math.abs(t.x)/r.width;for(var s=0;s<r.height;s++){for(var o=[],l=0;l<r.width;l++){var u=(r.data[4*(s*r.height+l)]+r.data[4*(s*r.height+l)+1]+r.data[4*(s*r.height+l)+2])/4/255*t.z;t.x<0?o.push(u):o.unshift(u)}t.y<0?a.unshift(o):a.push(o)}this.updateMaxValue(),this.updateMinValue(),this.update()}},{"../math/Vec3":31,"../utils/Utils":54,"./ConvexPolyhedron":39,"./Shape":44}],42:[function(e,t,i){t.exports=a;var n=e("./Shape"),r=e("../math/Vec3");function a(){n.call(this,{type:n.types.PARTICLE})}((a.prototype=new n).constructor=a).prototype.calculateLocalInertia=function(e,t){return(t=t||new r).set(0,0,0),t},a.prototype.volume=function(){return 0},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},a.prototype.calculateWorldAABB=function(e,t,i,n){i.copy(e),n.copy(e)}},{"../math/Vec3":31,"./Shape":44}],43:[function(e,t,i){t.exports=a;var n=e("./Shape"),r=e("../math/Vec3");function a(){n.call(this,{type:n.types.PLANE}),this.worldNormal=new r,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}((a.prototype=new n).constructor=a).prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1},a.prototype.calculateLocalInertia=function(e,t){return t=t||new r},a.prototype.volume=function(){return Number.MAX_VALUE};var s=new r;a.prototype.calculateWorldAABB=function(e,t,i,n){s.set(0,0,1),t.vmult(s,s);var r=Number.MAX_VALUE;i.set(-r,-r,-r),n.set(r,r,r),1===s.x&&(n.x=e.x),1===s.y&&(n.y=e.y),1===s.z&&(n.z=e.z),-1===s.x&&(i.x=e.x),-1===s.y&&(i.y=e.y),-1===s.z&&(i.z=e.z)},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":31,"./Shape":44}],44:[function(e,t,i){t.exports=r;var n=e("../utils/EventTarget"),r=e("./Shape");function r(e){e=e||{},n.apply(this),this.id=r.idCounter++,this.type=e.type||0,this.boundingSphereRadius=0,this.collisionResponse=!e.collisionResponse||e.collisionResponse,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.material=e.material?e.material:null,this.body=null}e("../math/Vec3"),e("../math/Quaternion"),e("../material/Material"),r.prototype=new n,(r.prototype.constructor=r).prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},r.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},r.prototype.calculateLocalInertia=function(e,t){throw"calculateLocalInertia() not implemented for shape type "+this.type},r.idCounter=0,r.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../utils/EventTarget":50,"./Shape":44}],45:[function(e,t,i){t.exports=a;var n=e("./Shape"),r=e("../math/Vec3");function a(e){if(n.call(this,{type:n.types.SPHERE}),this.radius=void 0!==e?e:1,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}((a.prototype=new n).constructor=a).prototype.calculateLocalInertia=function(e,t){t=t||new r;var i=2*e*this.radius*this.radius/5;return t.x=i,t.y=i,t.z=i,t},a.prototype.volume=function(){return 4*Math.PI*this.radius/3},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},a.prototype.calculateWorldAABB=function(e,t,i,n){for(var r=this.radius,a=["x","y","z"],s=0;s<a.length;s++){var o=a[s];i[o]=e[o]-r,n[o]=e[o]+r}}},{"../math/Vec3":31,"./Shape":44}],46:[function(e,t,i){t.exports=y;var n=e("./Shape"),u=e("../math/Vec3"),r=(e("../math/Quaternion"),e("../math/Transform")),c=e("../collision/AABB"),a=e("../utils/Octree");function y(e,t){n.call(this,{type:n.types.TRIMESH}),this.vertices=new Float32Array(e),this.indices=new Int16Array(t),this.normals=new Float32Array(t.length),this.aabb=new c,this.edges=null,this.scale=new u(1,1,1),this.tree=new a,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}(y.prototype=new n).constructor=y;var o=new u;y.prototype.updateTree=function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var t=this.scale;e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var i=new c,n=new u,r=new u,a=new u,s=[n,r,a],o=0;o<this.indices.length/3;o++){var l=3*o;this._getUnscaledVertex(this.indices[l],n),this._getUnscaledVertex(this.indices[1+l],r),this._getUnscaledVertex(this.indices[2+l],a),i.setFromPoints(s),e.insert(i,o)}e.removeEmptyNodes()};var l=new c;y.prototype.getTrianglesInAABB=function(e,t){l.copy(e);var i=this.scale,n=i.x,r=i.y,a=i.z,s=l.lowerBound,o=l.upperBound;return s.x/=n,s.y/=r,s.z/=a,o.x/=n,o.y/=r,o.z/=a,this.tree.aabbQuery(l,t)},y.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z,i=e.x===e.y===e.z;t&&i||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},y.prototype.updateNormals=function(){for(var e=o,t=this.normals,i=0;i<this.indices.length/3;i++){var n=3*i,r=this.indices[n],a=this.indices[1+n],s=this.indices[2+n];this.getVertex(r,_),this.getVertex(a,p),this.getVertex(s,v),y.computeNormal(p,_,v,e),t[n]=e.x,t[1+n]=e.y,t[2+n]=e.z}},y.prototype.updateEdges=function(){function e(e,t){i[r<a?r+"_"+a:a+"_"+r]=!0}for(var i={},t=0;t<this.indices.length/3;t++){var n=3*t,r=this.indices[n],a=this.indices[1+n];this.indices[2+n],e(),e(),e()}var s=Object.keys(i);for(this.edges=new Int16Array(2*s.length),t=0;t<s.length;t++){var o=s[t].split("_");this.edges[2*t]=parseInt(o[0],10),this.edges[2*t+1]=parseInt(o[1],10)}},y.prototype.getEdgeVertex=function(e,t,i){var n=this.edges[2*e+(t?1:0)];this.getVertex(n,i)};var s=new u,h=new u;y.prototype.getEdgeVector=function(e,t){var i=s,n=h;this.getEdgeVertex(e,0,i),this.getEdgeVertex(e,1,n),n.vsub(i,t)};var f=new u,d=new u;y.computeNormal=function(e,t,i,n){t.vsub(e,d),i.vsub(t,f),f.cross(d,n),n.isZero()||n.normalize()};var _=new u,p=new u,v=new u;y.prototype.getVertex=function(e,t){var i=this.scale;return this._getUnscaledVertex(e,t),t.x*=i.x,t.y*=i.y,t.z*=i.z,t},y.prototype._getUnscaledVertex=function(e,t){var i=3*e,n=this.vertices;return t.set(n[i],n[1+i],n[2+i])},y.prototype.getWorldVertex=function(e,t,i,n){return this.getVertex(e,n),r.pointToWorldFrame(t,i,n,n),n},y.prototype.getTriangleVertices=function(e,t,i,n){var r=3*e;this.getVertex(this.indices[r],t),this.getVertex(this.indices[1+r],i),this.getVertex(this.indices[2+r],n)},y.prototype.getNormal=function(e,t){var i=3*e;return t.set(this.normals[i],this.normals[1+i],this.normals[2+i])};var m=new c;y.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(m);var i=m.upperBound.x-m.lowerBound.x,n=m.upperBound.y-m.lowerBound.y,r=m.upperBound.z-m.lowerBound.z;return t.set(1/12*e*(2*n*2*n+2*r*2*r),1/12*e*(2*i*2*i+2*r*2*r),1/12*e*(2*n*2*n+2*i*2*i))};var g=new u;y.prototype.computeLocalAABB=function(e){var t=e.lowerBound,i=e.upperBound,n=this.vertices.length,r=(this.vertices,g);this.getVertex(0,r),t.copy(r),i.copy(r);for(var a=0;a!==n;a++)this.getVertex(a,r),r.x<t.x?t.x=r.x:r.x>i.x&&(i.x=r.x),r.y<t.y?t.y=r.y:r.y>i.y&&(i.y=r.y),r.z<t.z?t.z=r.z:r.z>i.z&&(i.z=r.z)},y.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},y.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=new u,n=0,r=t.length/3;n!==r;n++){this.getVertex(n,i);var a=i.norm2();e<a&&(e=a)}this.boundingSphereRadius=Math.sqrt(e)},new u;var b=new r,x=new c;y.prototype.calculateWorldAABB=function(e,t,i,n){var r=b,a=x;r.position=e,r.quaternion=t,this.aabb.toWorldFrame(r,a),i.copy(a.lowerBound),n.copy(a.upperBound)},y.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},y.createTorus=function(e,t,i,n,r){e=e||1,t=t||.5,i=i||8,n=n||6,r=r||2*Math.PI;for(var a=[],s=[],o=0;o<=i;o++)for(var l=0;l<=n;l++){var u=l/n*r,c=o/i*Math.PI*2,h=(e+t*Math.cos(c))*Math.cos(u),f=(e+t*Math.cos(c))*Math.sin(u),d=t*Math.sin(c);a.push(h,f,d)}for(o=1;o<=i;o++)for(l=1;l<=n;l++){var _=(n+1)*o+l-1,p=(n+1)*(o-1)+l-1,v=(n+1)*(o-1)+l,m=(n+1)*o+l;s.push(_,p,m),s.push(p,v,m)}return new y(a,s)}},{"../collision/AABB":3,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../utils/Octree":51,"./Shape":44}],47:[function(e,t,i){t.exports=r,e("../math/Vec3"),e("../math/Quaternion");var n=e("./Solver");function r(){n.call(this),this.iterations=10,this.tolerance=1e-7}r.prototype=new n;var k=[],R=[],O=[];r.prototype.solve=function(e,t){var i,n,r,a,s,o=0,l=this.iterations,u=this.tolerance*this.tolerance,c=this.equations,h=c.length,f=t.bodies,d=f.length,_=e;if(0!==h)for(var p=0;p!==d;p++)f[p].updateSolveMassProperties();var v=R,m=O,y=k;for(v.length=h,m.length=h,y.length=h,p=0;p!==h;p++){var g=c[p];y[p]=0,m[p]=g.computeB(_),v[p]=1/g.computeC()}if(0!==h){for(p=0;p!==d;p++){var b=(T=f[p]).vlambda,x=T.wlambda;b.set(0,0,0),x.set(0,0,0)}for(o=0;o!==l;o++){for(var S=a=0;S!==h;S++)g=c[S],i=m[S],n=v[S],(s=y[S])+(r=n*(i-g.computeGWlambda()-g.eps*s))<g.minForce?r=g.minForce-s:s+r>g.maxForce&&(r=g.maxForce-s),y[S]+=r,a+=0<r?r:-r,g.addToWlambda(r);if(a*a<u)break}for(p=0;p!==d;p++){var T,w=(T=f[p]).velocity,E=T.angularVelocity;T.vlambda.vmul(T.linearFactor,T.vlambda),w.vadd(T.vlambda,w),T.wlambda.vmul(T.angularFactor,T.wlambda),E.vadd(T.wlambda,E)}for(var A=c.length,C=1/_;A--;)c[A].multiplier=y[A]*C}return o}},{"../math/Quaternion":29,"../math/Vec3":31,"./Solver":48}],48:[function(e,t,i){function n(){this.equations=[]}(t.exports=n).prototype.solve=function(e,t){return 0},n.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},n.prototype.removeEquation=function(e){var t=this.equations,i=t.indexOf(e);-1!==i&&t.splice(i,1)},n.prototype.removeAllEquations=function(){this.equations.length=0}},{}],49:[function(e,t,i){t.exports=a,e("../math/Vec3"),e("../math/Quaternion");var n=e("./Solver"),r=e("../objects/Body");function a(e){for(n.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}a.prototype=new n;var x=[],S=[],T={bodies:[]},s=r.STATIC;function w(e){for(var t=e.length,i=0;i!==t;i++){var n=e[i];if(!(n.visited||n.body.type&s))return n}return!1}var o=[];function E(e,t,i,n){for(o.push(e),e.visited=!0,t(e,i,n);o.length;)for(var r,a=o.pop();r=w(a.children);)r.visited=!0,t(r,i,n),o.push(r)}function A(e,t,i){t.push(e.body);for(var n=e.eqs.length,r=0;r!==n;r++){var a=e.eqs[r];-1===i.indexOf(a)&&i.push(a)}}function C(e,t){return t.id-e.id}a.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},a.prototype.solve=function(e,t){for(var i=x,n=this.nodePool,r=t.bodies,a=this.equations,s=a.length,o=r.length,l=this.subsolver;n.length<o;)n.push(this.createNode());i.length=o;for(var u=0;u<o;u++)i[u]=n[u];for(u=0;u!==o;u++){var c=i[u];c.body=r[u],c.children.length=0,c.eqs.length=0,c.visited=!1}for(var h=0;h!==s;h++){var f=a[h],d=(u=r.indexOf(f.bi),r.indexOf(f.bj)),_=i[u],p=i[d];_.children.push(p),_.eqs.push(f),p.children.push(_),p.eqs.push(f)}var v,m=0,y=S;l.tolerance=this.tolerance,l.iterations=this.iterations;for(var g=T;v=w(i);){y.length=0,g.bodies.length=0,E(v,A,g.bodies,y);var b=y.length;for(y=y.sort(C),u=0;u!==b;u++)l.addEquation(y[u]);l.solve(e,g),l.removeAllEquations(),m++}return m}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"./Solver":48}],50:[function(e,t,i){function n(){}(t.exports=n).prototype={constructor:n,addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t),this},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[e]&&-1!==i[e].indexOf(t)},hasAnyEventListener:function(e){return void 0!==this._listeners&&void 0!==this._listeners[e]},removeEventListener:function(e,t){if(void 0===this._listeners)return this;var i=this._listeners;if(void 0===i[e])return this;var n=i[e].indexOf(t);return-1!==n&&i[e].splice(n,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var i=0,n=t.length;i<n;i++)t[i].call(this,e)}return this}}},{}],51:[function(e,t,i){var l=e("../collision/AABB"),u=e("../math/Vec3");function c(e){e=e||{},this.root=e.root||null,this.aabb=e.aabb?e.aabb.clone():new l,this.data=[],this.children=[]}(t.exports=function(e,t){(t=t||{}).root=null,t.aabb=e,c.call(this,t),this.maxDepth=void 0!==t.maxDepth?t.maxDepth:8}).prototype=new c,c.prototype.reset=function(e,t){this.children.length=this.data.length=0},c.prototype.insert=function(e,t,i){var n=this.data;if(i=i||0,!this.aabb.contains(e))return!1;var r=this.children;if(i<(this.maxDepth||this.root.maxDepth)){var a=!1;r.length||(this.subdivide(),a=!0);for(var s=0;8!==s;s++)if(r[s].insert(e,t,i+1))return!0;a&&(r.length=0)}return n.push(t),!0};var h=new u;c.prototype.subdivide=function(){var e=this.aabb,t=e.lowerBound,i=e.upperBound,n=this.children;n.push(new c({aabb:new l({lowerBound:new u(0,0,0)})}),new c({aabb:new l({lowerBound:new u(1,0,0)})}),new c({aabb:new l({lowerBound:new u(1,1,0)})}),new c({aabb:new l({lowerBound:new u(1,1,1)})}),new c({aabb:new l({lowerBound:new u(0,1,1)})}),new c({aabb:new l({lowerBound:new u(0,0,1)})}),new c({aabb:new l({lowerBound:new u(1,0,1)})}),new c({aabb:new l({lowerBound:new u(0,1,0)})})),i.vsub(t,h),h.scale(.5,h);for(var r=this.root||this,a=0;8!==a;a++){var s=n[a];s.root=r;var o=s.aabb.lowerBound;o.x*=h.x,o.y*=h.y,o.z*=h.z,o.vadd(t,o),o.vadd(h,s.aabb.upperBound)}},c.prototype.aabbQuery=function(e,t){this.data,this.children;for(var i=[this];i.length;){var n=i.pop();n.aabb.overlaps(e)&&Array.prototype.push.apply(t,n.data),Array.prototype.push.apply(i,n.children)}return t};var n=new l;c.prototype.rayQuery=function(e,t,i){return e.getAABB(n),n.toLocalFrame(t,n),this.aabbQuery(n,i),i},c.prototype.removeEmptyNodes=function(){for(var e=[this];e.length;){for(var t=e.pop(),i=t.children.length-1;0<=i;i--)t.children[i].data.length||t.children.splice(i,1);Array.prototype.push.apply(e,t.children)}}},{"../collision/AABB":3,"../math/Vec3":31}],52:[function(e,t,i){function n(){this.objects=[],this.type=Object}(t.exports=n).prototype.release=function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(arguments[t]);return this},n.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},n.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")},n.prototype.resize=function(e){for(var t=this.objects;t.length>e;)t.pop();for(;t.length<e;)t.push(this.constructObject());return this}},{}],53:[function(e,t,i){function n(){this.data={keys:[]}}(t.exports=n).prototype.get=function(e,t){if(t<e){var i=t;t=e,e=i}return this.data[e+"-"+t]},n.prototype.set=function(e,t,i){if(t<e){var n=t;t=e,e=n}var r=e+"-"+t;return this.get(e,t)||this.data.keys.push(r),this.data[r]=i,this.data[r]},n.prototype.reset=function(){for(var e=this.data,t=e.keys;0<t.length;)delete e[t.pop()]},n.prototype.getLength=function(){return this.data.keys.length},n.prototype.getKeyByIndex=function(e){return this.data.keys[e]},n.prototype.getDataByKey=function(e){return this.data[e]}},{}],54:[function(e,t,i){(t.exports=function(){}).defaults=function(e,t){for(var i in e=e||{},t)i in e||(e[i]=t[i]);return e}},{}],55:[function(e,t,i){t.exports=a;var n=e("../math/Vec3"),r=e("./Pool");function a(){r.call(this),this.type=n}(a.prototype=new r).constructObject=function(){return new n}},{"../math/Vec3":31,"./Pool":52}],56:[function(e,t,i){t.exports=o;var n=e("../collision/AABB"),T=e("../objects/Body"),r=e("../shapes/Shape"),P=e("../collision/Ray"),y=e("../math/Vec3"),F=e("../math/Transform"),a=(e("../shapes/ConvexPolyhedron"),e("../math/Quaternion")),s=(e("../solver/Solver"),e("../utils/Vec3Pool")),c=e("../equations/ContactEquation"),v=e("../equations/FrictionEquation");function o(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new s,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}o.prototype.createContactEquation=function(e,t,i,n,r,a){var s;this.contactPointPool.length?((s=this.contactPointPool.pop()).bi=e,s.bj=t):s=new c(e,t);var o=this.currentContactMaterial;s.restitution=o.restitution,s.setSpookParams(o.contactEquationStiffness,o.contactEquationRelaxation,this.world.dt);var l=i.material||e.material,u=n.material||t.material;return l&&u&&0<=l.restitution&&0<=u.restitution&&(s.restitution=l.restitution*u.restitution),s.si=r||i,s.sj=a||n,s},o.prototype.createFrictionEquationsFromContact=function(e,t){var i=e.bi,n=e.bj,r=e.si,a=e.sj,s=this.world,o=this.currentContactMaterial,l=o.friction,u=r.material||i.material,c=a.material||n.material;if(u&&c&&0<=u.friction&&0<=c.friction&&(l=u.friction*c.friction),0<l){var h=l*s.gravity.length(),f=i.invMass+n.invMass;0<f&&(f=1/f);var d=this.frictionEquationPool,_=d.length?d.pop():new v(i,n,h*f),p=d.length?d.pop():new v(i,n,h*f);return _.bi=p.bi=i,_.bj=p.bj=n,_.minForce=p.minForce=-h*f,_.maxForce=p.maxForce=h*f,_.ri.copy(e.ri),_.rj.copy(e.rj),p.ri.copy(e.ri),p.rj.copy(e.rj),e.ni.tangents(_.t,p.t),_.setSpookParams(o.frictionEquationStiffness,o.frictionEquationRelaxation,s.dt),p.setSpookParams(o.frictionEquationStiffness,o.frictionEquationRelaxation,s.dt),_.enabled=p.enabled=e.enabled,t.push(_,p),!0}return!1};var l=new y,u=new y,h=new y;o.prototype.createFrictionFromAverage=function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var i=this.frictionResult[this.frictionResult.length-2],n=this.frictionResult[this.frictionResult.length-1];l.setZero(),u.setZero(),h.setZero();for(var r=t.bi,a=(t.bj,0);a!==e;a++)(t=this.result[this.result.length-1-a]).bodyA!==r?(l.vadd(t.ni,l),u.vadd(t.ri,u),h.vadd(t.rj,h)):(l.vsub(t.ni,l),u.vadd(t.rj,u),h.vadd(t.ri,h));var s=1/e;u.scale(s,i.ri),h.scale(s,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),l.normalize(),l.tangents(i.t,n.t)}};var w=new y,E=new y,A=new a,C=new a;o.prototype.getContacts=function(e,t,i,n,r,a,s){this.frictionEquationPool=s,this.result=n,this.frictionResult=a;for(var o=A,l=C,u=w,c=E,h=0,f=e.length;h!==f;h++){var d=e[h],_=t[h],p=null;d.material&&_.material&&(p=i.getContactMaterial(d.material,_.material)||null);for(var v=0==d.collisionResponse||0==_.collisionResponse||d.type&T.KINEMATIC&&_.type&T.STATIC||d.type&T.STATIC&&_.type&T.KINEMATIC||d.type&T.KINEMATIC&&_.type&T.KINEMATIC,m=0;m<d.shapes.length;m++){d.quaternion.mult(d.shapeOrientations[m],o),d.quaternion.vmult(d.shapeOffsets[m],u),u.vadd(d.position,u);for(var y=d.shapes[m],g=0;g<_.shapes.length;g++){_.quaternion.mult(_.shapeOrientations[g],l),_.quaternion.vmult(_.shapeOffsets[g],c),c.vadd(_.position,c);var b=_.shapes[g];if(y.collisionFilterMask&b.collisionFilterGroup&&b.collisionFilterMask&y.collisionFilterGroup&&!(u.distanceTo(c)>y.boundingSphereRadius+b.boundingSphereRadius)){v|=0==y.collisionResponse||0==b.collisionResponse;var x=null;y.material&&b.material&&(x=i.getContactMaterial(y.material,b.material)||null),this.currentContactMaterial=x||p||i.defaultContactMaterial;var S=this[y.type|b.type];S&&(y.type<b.type?S.call(this,y,b,u,c,o,l,d,_,y,b,v):S.call(this,b,y,c,u,l,o,_,d,y,b,v))&&v&&(i.shapeOverlapKeeper.set(y.id,b.id),i.shapeOverlapKeeperExit.set(y.id,b.id))}}}}},o.prototype[r.types.BOX|r.types.BOX]=o.prototype.boxBox=function(e,t,i,n,r,a,s,o,l,u,c){return e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,i,n,r,a,s,o,e,t,c)},o.prototype[r.types.BOX|r.types.CONVEXPOLYHEDRON]=o.prototype.boxConvex=function(e,t,i,n,r,a,s,o,l,u,c){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,i,n,r,a,s,o,e,t,c)},o.prototype[r.types.BOX|r.types.PARTICLE]=o.prototype.boxParticle=function(e,t,i,n,r,a,s,o,l,u,c){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,i,n,r,a,s,o,e,t,c)},o.prototype[r.types.SPHERE]=o.prototype.sphereSphere=function(e,t,i,n,r,a,s,o,l,u,c){if(c)return i.distanceSquared(n)<Math.pow(e.radius+t.radius,2);var h=this.createContactEquation(s,o,e,t,l,u);n.vsub(i,h.ni),h.ni.normalize(),h.ri.copy(h.ni),h.rj.copy(h.ni),h.ri.mult(e.radius,h.ri),h.rj.mult(-t.radius,h.rj),h.ri.vadd(i,h.ri),h.ri.vsub(s.position,h.ri),h.rj.vadd(n,h.rj),h.rj.vsub(o.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)};var g=new y,b=new y,x=new y;o.prototype[r.types.PLANE|r.types.TRIMESH]=o.prototype.planeTrimesh=function(e,t,i,n,r,a,s,o,l,u,c){var h=new y,f=g;f.set(0,0,1),r.vmult(f,f);for(var d=0;d<t.vertices.length/3;d++){t.getVertex(d,h);var _=new y;_.copy(h),F.pointToWorldFrame(n,a,_,h);var p=b;if(h.vsub(i,p),f.dot(p)<=0){if(c)return!0;var v=this.createContactEquation(s,o,e,t,l,u);v.ni.copy(f);var m=x;f.scale(p.dot(f),m),h.vsub(m,m),v.ri.copy(m),v.ri.vsub(s.position,v.ri),v.rj.copy(h),v.rj.vsub(o.position,v.rj),this.result.push(v),this.createFrictionEquationsFromContact(v,this.frictionResult)}}};var z=new y,D=new y,N=(new y,new y),U=new y,V=new y,G=new y,H=new y,W=new y,q=new y,j=new y,X=new y,Y=new y,K=new y,Q=new n,Z=[];o.prototype[r.types.SPHERE|r.types.TRIMESH]=o.prototype.sphereTrimesh=function(e,t,i,n,r,a,s,o,l,u,c){var h=V,f=G,d=H,_=W,p=q,v=j,m=Q,y=U,g=D,b=Z;F.pointToLocalFrame(n,a,i,p);var x=e.radius;m.lowerBound.set(p.x-x,p.y-x,p.z-x),m.upperBound.set(p.x+x,p.y+x,p.z+x),t.getTrianglesInAABB(m,b);for(var S=N,T=e.radius*e.radius,w=0;w<b.length;w++)for(var E=0;E<3;E++)if(t.getVertex(t.indices[3*b[w]+E],S),S.vsub(p,g),g.norm2()<=T){if(y.copy(S),F.pointToWorldFrame(n,a,y,S),S.vsub(i,g),c)return!0;(k=this.createContactEquation(s,o,e,t,l,u)).ni.copy(g),k.ni.normalize(),k.ri.copy(k.ni),k.ri.scale(e.radius,k.ri),k.ri.vadd(i,k.ri),k.ri.vsub(s.position,k.ri),k.rj.copy(S),k.rj.vsub(o.position,k.rj),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)}for(w=0;w<b.length;w++)for(E=0;E<3;E++){t.getVertex(t.indices[3*b[w]+E],h),t.getVertex(t.indices[3*b[w]+(E+1)%3],f),f.vsub(h,d),p.vsub(f,v);var A=v.dot(d);p.vsub(h,v);var C=v.dot(d);if(0<C&&A<0&&(p.vsub(h,v),_.copy(d),_.normalize(),C=v.dot(_),_.scale(C,v),v.vadd(h,v),(L=v.distanceTo(p))<e.radius)){if(c)return!0;var k=this.createContactEquation(s,o,e,t,l,u);v.vsub(p,k.ni),k.ni.normalize(),k.ni.scale(e.radius,k.ri),F.pointToWorldFrame(n,a,v,v),v.vsub(o.position,k.rj),F.vectorToWorldFrame(a,k.ni,k.ni),F.vectorToWorldFrame(a,k.ri,k.ri),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)}}for(var R=X,O=Y,M=K,I=z,B=(w=0,b.length);w!==B;w++){t.getTriangleVertices(b[w],R,O,M),t.getNormal(b[w],I),p.vsub(R,v);var L=v.dot(I);if(I.scale(L,v),p.vsub(v,v),L=v.distanceTo(p),P.pointInTriangle(v,R,O,M)&&L<e.radius){if(c)return!0;k=this.createContactEquation(s,o,e,t,l,u),v.vsub(p,k.ni),k.ni.normalize(),k.ni.scale(e.radius,k.ri),F.pointToWorldFrame(n,a,v,v),v.vsub(o.position,k.rj),F.vectorToWorldFrame(a,k.ni,k.ni),F.vectorToWorldFrame(a,k.ri,k.ri),this.result.push(k),this.createFrictionEquationsFromContact(k,this.frictionResult)}}b.length=0};var _=new y,p=new y,m=new y,S=new y,k=new y;o.prototype[r.types.SPHERE|r.types.PLANE]=o.prototype.spherePlane=function(e,t,i,n,r,a,s,o,l,u,c){if(m.set(0,0,1),a.vmult(m,m),m.negate(m),m.normalize(),m.mult(e.radius,S),i.vsub(n,_),m.mult(m.dot(_),p),_.vsub(p,k),-_.dot(m)<=e.radius){if(c)return!0;var h=this.createContactEquation(s,o,e,t,l,u);h.ni.copy(m),h.ri.copy(S),h.rj.copy(k);var f=h.ri,d=h.rj;f.vadd(i,f),f.vsub(s.position,f),d.vadd(n,d),d.vsub(o.position,d),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}};var f=new y,d=new y,R=new y;function J(e,t,i){for(var n=null,r=e.length,a=0;a!==r;a++){var s=e[a],o=f;e[(a+1)%r].vsub(s,o);var l=d;o.cross(t,l);var u=R;i.vsub(s,u);var c=l.dot(u);if(!(null===n||0<c&&!0===n||c<=0&&!1===n))return!1;null===n&&(n=0<c)}return!0}var $=new y,ee=new y,te=new y,ie=new y,ne=[new y,new y,new y,new y,new y,new y],re=new y,ae=new y,se=new y,oe=new y;o.prototype[r.types.SPHERE|r.types.BOX]=o.prototype.sphereBox=function(e,t,i,n,r,a,s,o,l,u,c){var h=this.v3pool,f=ne;i.vsub(n,$),t.getSideNormals(f,a);for(var d=e.radius,_=!1,p=ae,v=se,m=oe,y=null,g=0,b=0,x=0,S=null,T=0,w=f.length;T!==w&&!1===_;T++){var E=ee;E.copy(f[T]);var A=E.norm();E.normalize();var C=$.dot(E);if(C<A+d&&0<C){var k=te,R=ie;k.copy(f[(T+1)%3]),R.copy(f[(T+2)%3]);var O=k.norm(),M=R.norm();k.normalize(),R.normalize();var I=$.dot(k),B=$.dot(R);if(I<O&&-O<I&&B<M&&-M<B){var L=Math.abs(C-A-d);if((null===S||L<S)&&(S=L,b=I,x=B,y=A,p.copy(E),v.copy(k),m.copy(R),g++,c))return!0}}}if(g){_=!0;var P=this.createContactEquation(s,o,e,t,l,u);p.mult(-d,P.ri),P.ni.copy(p),P.ni.negate(P.ni),p.mult(y,p),v.mult(b,v),p.vadd(v,p),m.mult(x,m),p.vadd(m,P.rj),P.ri.vadd(i,P.ri),P.ri.vsub(s.position,P.ri),P.rj.vadd(n,P.rj),P.rj.vsub(o.position,P.rj),this.result.push(P),this.createFrictionEquationsFromContact(P,this.frictionResult)}for(var F=h.get(),z=re,D=0;2!==D&&!_;D++)for(var N=0;2!==N&&!_;N++)for(var U=0;2!==U&&!_;U++)if(F.set(0,0,0),D?F.vadd(f[0],F):F.vsub(f[0],F),N?F.vadd(f[1],F):F.vsub(f[1],F),U?F.vadd(f[2],F):F.vsub(f[2],F),n.vadd(F,z),z.vsub(i,z),z.norm2()<d*d){if(c)return!0;_=!0,(P=this.createContactEquation(s,o,e,t,l,u)).ri.copy(z),P.ri.normalize(),P.ni.copy(P.ri),P.ri.mult(d,P.ri),P.rj.copy(F),P.ri.vadd(i,P.ri),P.ri.vsub(s.position,P.ri),P.rj.vadd(n,P.rj),P.rj.vsub(o.position,P.rj),this.result.push(P),this.createFrictionEquationsFromContact(P,this.frictionResult)}h.release(F),F=null;var V=h.get(),G=h.get(),H=(P=h.get(),h.get()),W=(L=h.get(),f.length);for(D=0;D!==W&&!_;D++)for(N=0;N!==W&&!_;N++)if(D%3!=N%3){f[N].cross(f[D],V),V.normalize(),f[D].vadd(f[N],G),P.copy(i),P.vsub(G,P),P.vsub(n,P);var q=P.dot(V);for(V.mult(q,H),U=0;U===D%3||U===N%3;)U++;L.copy(i),L.vsub(H,L),L.vsub(G,L),L.vsub(n,L);var j=Math.abs(q),X=L.norm();if(j<f[U].norm()&&X<d){if(c)return!0;_=!0;var Y=this.createContactEquation(s,o,e,t,l,u);G.vadd(H,Y.rj),Y.rj.copy(Y.rj),L.negate(Y.ni),Y.ni.normalize(),Y.ri.copy(Y.rj),Y.ri.vadd(n,Y.ri),Y.ri.vsub(i,Y.ri),Y.ri.normalize(),Y.ri.mult(d,Y.ri),Y.ri.vadd(i,Y.ri),Y.ri.vsub(s.position,Y.ri),Y.rj.vadd(n,Y.rj),Y.rj.vsub(o.position,Y.rj),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult)}}h.release(V,G,P,H,L)};var le=new y,ue=new y,ce=new y,he=new y,fe=new y,de=new y,_e=new y,pe=new y,ve=new y,me=new y;o.prototype[r.types.SPHERE|r.types.CONVEXPOLYHEDRON]=o.prototype.sphereConvex=function(e,t,i,n,r,a,s,o,l,u,c){var h=this.v3pool;i.vsub(n,le);for(var f=t.faceNormals,d=t.faces,_=t.vertices,p=e.radius,v=0;v!==_.length;v++){var m=_[v],y=fe;a.vmult(m,y),n.vadd(y,y);var g=he;if(y.vsub(i,g),g.norm2()<p*p)return!!c||(b=!0,(L=this.createContactEquation(s,o,e,t,l,u)).ri.copy(g),L.ri.normalize(),L.ni.copy(L.ri),L.ri.mult(p,L.ri),y.vsub(n,L.rj),L.ri.vadd(i,L.ri),L.ri.vsub(s.position,L.ri),L.rj.vadd(n,L.rj),L.rj.vsub(o.position,L.rj),this.result.push(L),void this.createFrictionEquationsFromContact(L,this.frictionResult))}for(var b=!1,x=(v=0,d.length);v!==x&&!1===b;v++){var S=f[v],T=d[v],w=de;a.vmult(S,w);var E=_e;a.vmult(_[T[0]],E),E.vadd(n,E);var A=pe;w.mult(-p,A),i.vadd(A,A);var C=ve;A.vsub(E,C);var k=C.dot(w),R=me;if(i.vsub(E,R),k<0&&0<R.dot(w)){for(var O=[],M=0,I=T.length;M!==I;M++){var B=h.get();a.vmult(_[T[M]],B),n.vadd(B,B),O.push(B)}if(J(O,w,i)){if(c)return!0;b=!0;var L=this.createContactEquation(s,o,e,t,l,u);w.mult(-p,L.ri),w.negate(L.ni);var P=h.get();w.mult(-k,P);var F=h.get();w.mult(-p,F),i.vsub(n,L.rj),L.rj.vadd(F,L.rj),L.rj.vadd(P,L.rj),L.rj.vadd(n,L.rj),L.rj.vsub(o.position,L.rj),L.ri.vadd(i,L.ri),L.ri.vsub(s.position,L.ri),h.release(P),h.release(F),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult),M=0;for(var z=O.length;M!==z;M++)h.release(O[M]);return}for(M=0;M!==T.length;M++){var D=h.get(),N=h.get();a.vmult(_[T[(M+1)%T.length]],D),a.vmult(_[T[(M+2)%T.length]],N),n.vadd(D,D),n.vadd(N,N);var U=ue;N.vsub(D,U);var V=ce;U.unit(V);var G=h.get(),H=h.get();i.vsub(D,H);var W=H.dot(V);V.mult(W,G),G.vadd(D,G);var q=h.get();if(G.vsub(i,q),0<W&&W*W<U.norm2()&&q.norm2()<p*p){if(c)return!0;for(L=this.createContactEquation(s,o,e,t,l,u),G.vsub(n,L.rj),G.vsub(i,L.ni),L.ni.normalize(),L.ni.mult(p,L.ri),L.rj.vadd(n,L.rj),L.rj.vsub(o.position,L.rj),L.ri.vadd(i,L.ri),L.ri.vsub(s.position,L.ri),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult),M=0,z=O.length;M!==z;M++)h.release(O[M]);return h.release(D),h.release(N),h.release(G),h.release(q),void h.release(H)}h.release(D),h.release(N),h.release(G),h.release(q),h.release(H)}for(M=0,z=O.length;M!==z;M++)h.release(O[M])}}},new y,new y,o.prototype[r.types.PLANE|r.types.BOX]=o.prototype.planeBox=function(e,t,i,n,r,a,s,o,l,u,c){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,t.convexPolyhedronRepresentation.id=t.id,this.planeConvex(e,t.convexPolyhedronRepresentation,i,n,r,a,s,o,e,t,c)};var O=new y,M=new y,I=new y,B=new y;o.prototype[r.types.PLANE|r.types.CONVEXPOLYHEDRON]=o.prototype.planeConvex=function(e,t,i,n,r,a,s,o,l,u,c){var h=O,f=M;f.set(0,0,1),r.vmult(f,f);for(var d=0,_=I,p=0;p!==t.vertices.length;p++)if(h.copy(t.vertices[p]),a.vmult(h,h),n.vadd(h,h),h.vsub(i,_),f.dot(_)<=0){if(c)return!0;var v=this.createContactEquation(s,o,e,t,l,u),m=B;f.mult(f.dot(_),m),h.vsub(m,m),m.vsub(i,v.ri),v.ni.copy(f),h.vsub(n,v.rj),v.ri.vadd(i,v.ri),v.ri.vsub(s.position,v.ri),v.rj.vadd(n,v.rj),v.rj.vsub(o.position,v.rj),this.result.push(v),d++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(v,this.frictionResult)}this.enableFrictionReduction&&d&&this.createFrictionFromAverage(d)};var L=new y,ye=new y;o.prototype[r.types.CONVEXPOLYHEDRON]=o.prototype.convexConvex=function(e,t,i,n,r,a,s,o,l,u,c,h,f){var d=L;if(!(i.distanceTo(n)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,i,r,n,a,d,h,f)){var _=[],p=ye;e.clipAgainstHull(i,r,t,n,a,d,-100,100,_);for(var v=0,m=0;m!==_.length;m++){if(c)return!0;var y=this.createContactEquation(s,o,e,t,l,u),g=y.ri,b=y.rj;d.negate(y.ni),_[m].normal.negate(p),p.mult(_[m].depth,p),_[m].point.vadd(p,g),b.copy(_[m].point),g.vsub(i,g),b.vsub(n,b),g.vadd(i,g),g.vsub(s.position,g),b.vadd(n,b),b.vsub(o.position,b),this.result.push(y),v++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(y,this.frictionResult)}this.enableFrictionReduction&&v&&this.createFrictionFromAverage(v)}};var ge=new y,be=new y,xe=new y;o.prototype[r.types.PLANE|r.types.PARTICLE]=o.prototype.planeParticle=function(e,t,i,n,r,a,s,o,l,u,c){var h=ge;h.set(0,0,1),s.quaternion.vmult(h,h);var f=be;if(n.vsub(s.position,f),h.dot(f)<=0){if(c)return!0;var d=this.createContactEquation(o,s,t,e,l,u);d.ni.copy(h),d.ni.negate(d.ni),d.ri.set(0,0,0);var _=xe;h.mult(h.dot(n),_),n.vsub(_,_),d.rj.copy(_),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult)}};var Se=new y;o.prototype[r.types.PARTICLE|r.types.SPHERE]=o.prototype.sphereParticle=function(e,t,i,n,r,a,s,o,l,u,c){var h=Se;if(h.set(0,0,1),n.vsub(i,h),h.norm2()<=e.radius*e.radius){if(c)return!0;var f=this.createContactEquation(o,s,t,e,l,u);h.normalize(),f.rj.copy(h),f.rj.mult(e.radius,f.rj),f.ni.copy(h),f.ni.negate(f.ni),f.ri.set(0,0,0),this.result.push(f),this.createFrictionEquationsFromContact(f,this.frictionResult)}};var Te=new a,we=new y,Ee=(new y,new y),Ae=new y,Ce=new y;o.prototype[r.types.PARTICLE|r.types.CONVEXPOLYHEDRON]=o.prototype.convexParticle=function(e,t,i,n,r,a,s,o,l,u,c){var h=-1,f=Ee,d=Ce,_=null,p=we;if(p.copy(n),p.vsub(i,p),r.conjugate(Te),Te.vmult(p,p),e.pointIsInside(p)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(i,r),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(r);for(var v=0,m=e.faces.length;v!==m;v++){var y=[e.worldVertices[e.faces[v][0]]],g=e.worldFaceNormals[v];n.vsub(y[0],Ae);var b=-g.dot(Ae);if(null===_||Math.abs(b)<Math.abs(_)){if(c)return!0;_=b,h=v,f.copy(g)}}if(-1!==h){var x=this.createContactEquation(o,s,t,e,l,u);f.mult(_,d),d.vadd(n,d),d.vsub(i,d),x.rj.copy(d),f.negate(x.ni),x.ri.set(0,0,0);var S=x.ri,T=x.rj;S.vadd(n,S),S.vsub(o.position,S),T.vadd(i,T),T.vsub(s.position,T),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},o.prototype[r.types.BOX|r.types.HEIGHTFIELD]=o.prototype.boxHeightfield=function(e,t,i,n,r,a,s,o,l,u,c){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,i,n,r,a,s,o,e,t,c)};var ke=new y,Re=new y,Oe=[0];o.prototype[r.types.CONVEXPOLYHEDRON|r.types.HEIGHTFIELD]=o.prototype.convexHeightfield=function(e,t,i,n,r,a,s,o,l,u,c){var h=t.data,f=t.elementSize,d=e.boundingSphereRadius,_=Re,p=Oe,v=ke;F.pointToLocalFrame(n,a,i,v);var m=Math.floor((v.x-d)/f)-1,y=Math.ceil((v.x+d)/f)+1,g=Math.floor((v.y-d)/f)-1,b=Math.ceil((v.y+d)/f)+1;if(!(y<0||b<0||m>h.length||g>h[0].length)){m<0&&(m=0),y<0&&(y=0),g<0&&(g=0),b<0&&(b=0),m>=h.length&&(m=h.length-1),y>=h.length&&(y=h.length-1),b>=h[0].length&&(b=h[0].length-1),g>=h[0].length&&(g=h[0].length-1);var x=[];t.getRectMinMax(m,g,y,b,x);var S=x[0],T=x[1];if(!(v.z-d>T||v.z+d<S))for(var w=m;w<y;w++)for(var E=g;E<b;E++){var A=!1;if(t.getConvexTrianglePillar(w,E,!1),F.pointToWorldFrame(n,a,t.pillarOffset,_),i.distanceTo(_)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(A=this.convexConvex(e,t.pillarConvex,i,_,r,a,s,o,null,null,c,p,null)),c&&A)return!0;if(t.getConvexTrianglePillar(w,E,!0),F.pointToWorldFrame(n,a,t.pillarOffset,_),i.distanceTo(_)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(A=this.convexConvex(e,t.pillarConvex,i,_,r,a,s,o,null,null,c,p,null)),c&&A)return!0}}};var Me=new y,Ie=new y;o.prototype[r.types.SPHERE|r.types.HEIGHTFIELD]=o.prototype.sphereHeightfield=function(e,t,i,n,r,a,s,o,l,u,c){var h=t.data,f=e.radius,d=t.elementSize,_=Ie,p=Me;F.pointToLocalFrame(n,a,i,p);var v=Math.floor((p.x-f)/d)-1,m=Math.ceil((p.x+f)/d)+1,y=Math.floor((p.y-f)/d)-1,g=Math.ceil((p.y+f)/d)+1;if(!(m<0||g<0||v>h.length||g>h[0].length)){v<0&&(v=0),m<0&&(m=0),y<0&&(y=0),g<0&&(g=0),v>=h.length&&(v=h.length-1),m>=h.length&&(m=h.length-1),g>=h[0].length&&(g=h[0].length-1),y>=h[0].length&&(y=h[0].length-1);var b=[];t.getRectMinMax(v,y,m,g,b);var x=b[0],S=b[1];if(!(p.z-f>S||p.z+f<x))for(var T=this.result,w=v;w<m;w++)for(var E=y;E<g;E++){var A=T.length,C=!1;if(t.getConvexTrianglePillar(w,E,!1),F.pointToWorldFrame(n,a,t.pillarOffset,_),i.distanceTo(_)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(C=this.sphereConvex(e,t.pillarConvex,i,_,r,a,s,o,e,t,c)),c&&C)return!0;if(t.getConvexTrianglePillar(w,E,!0),F.pointToWorldFrame(n,a,t.pillarOffset,_),i.distanceTo(_)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(C=this.sphereConvex(e,t.pillarConvex,i,_,r,a,s,o,e,t,c)),c&&C)return!0;if(2<T.length-A)return}}}},{"../collision/AABB":3,"../collision/Ray":10,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../objects/Body":32,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44,"../solver/Solver":48,"../utils/Vec3Pool":55}],57:[function(y,g,e){(function(e){g.exports=d,y("../shapes/Shape");var t=y("../math/Vec3"),i=(y("../math/Quaternion"),y("../solver/GSSolver")),n=(y("../equations/ContactEquation"),y("../equations/FrictionEquation"),y("./Narrowphase")),r=y("../utils/EventTarget"),a=(y("../collision/ArrayCollisionMatrix"),y("../collision/ObjectCollisionMatrix")),s=y("../collision/OverlapKeeper"),o=y("../material/Material"),l=y("../material/ContactMaterial"),B=y("../objects/Body"),u=y("../utils/TupleDictionary"),c=y("../collision/RaycastResult"),h=(y("../collision/AABB"),y("../collision/Ray")),f=y("../collision/NaiveBroadphase");function d(e){e=e||{},r.apply(this),this.dt=-1,this.allowSleep=!!e.allowSleep,this.contacts=[],this.frictionEquations=[],this.contactsDic=new u,this.oldContactsDic=new u,this.quatNormalizeSkip=void 0!==e.quatNormalizeSkip?e.quatNormalizeSkip:0,this.quatNormalizeFast=void 0!==e.quatNormalizeFast&&e.quatNormalizeFast,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new t,e.gravity&&this.gravity.copy(e.gravity),this.broadphase=void 0!==e.broadphase?e.broadphase:new f,this.bodies=[],this.solver=void 0!==e.solver?e.solver:new i,this.constraints=[],this.narrowphase=new n(this),this.collisionMatrix=new a,this.triggerMatrix=new a,this.shapeOverlapKeeper=new s,this.shapeOverlapKeeperExit=new s,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new u,this.defaultMaterial=new o("default"),this.defaultContactMaterial=new l(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.broadphase.setWorld(this)}e?(e.doProfiling=!1,e.DEBUG=!0):window&&(window.doProfiling=!1,window.DEBUG=!0),d.idToBodyMap={},d.idToShapeMap={},d.prototype=new r;var _=new h;d.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)},d.prototype.numObjects=function(){return this.bodies.length},d.prototype.collisionMatrixTick=function(){},d.prototype.add=d.prototype.addBody=function(e){-1===this.bodies.indexOf(e)&&(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof B&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,d.idToBodyMap[e.id]=e,this.dispatchEvent(this.addBodyEvent))},d.prototype.addConstraint=function(e){this.constraints.push(e)},d.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);-1!==t&&this.constraints.splice(t,1)},d.prototype.rayTest=function(e,t,i){i instanceof c?this.raycastClosest(e,t,{skipBackfaces:!0},i):this.raycastAll(e,t,{skipBackfaces:!0},i)},d.prototype.raycastAll=function(e,t,i,n){return i.mode=h.ALL,i.from=e,i.to=t,i.callback=n,_.intersectWorld(this,i)},d.prototype.raycastAny=function(e,t,i,n){return i.mode=h.ANY,i.from=e,i.to=t,i.result=n,_.intersectWorld(this,i)},d.prototype.raycastClosest=function(e,t,i,n){return i.mode=h.CLOSEST,i.from=e,i.to=t,i.result=n,_.intersectWorld(this,i)},d.prototype.removeBody=d.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,i=this.bodies,n=i.indexOf(e);if(-1!==n){i.splice(n,1);for(var r=0;r!==i.length;r++)i[r].index=r;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,delete d.idToBodyMap[e.id],this.dispatchEvent(this.removeBodyEvent)}},d.prototype.getBodyById=function(e){return d.idToBodyMap[e]},d.prototype.getShapeById=function(e){return d.idToShapeMap[e]},d.prototype.addMaterial=function(e){this.materials.push(e)},d.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},d.prototype.step=function(e,t,i){if(i=i||10,t=t||0,x=this.contacts.slice(),0===t)this.internalStep(e),this.time+=e;else{this.accumulator+=t;for(var n=0;this.accumulator>=e&&n<i;)this.internalStep(e),this.accumulator-=e,n++;for(var r=this.accumulator%e/e,a=0;a!==this.bodies.length;a++){var s=this.bodies[a];s.previousPosition.lerp(s.position,r,s.interpolatedPosition),s.previousQuaternion.slerp(s.quaternion,r,s.interpolatedQuaternion),s.previousQuaternion.normalize()}this.time+=t}for(var o,l,u=this.contacts,c=this.contacts.length;c--;){var h=(g=u[c]).si,f=g.sj,d=this.contactsDic.get(h.id,f.id);null==d&&(d=this.contactsDic.set(h.id,f.id,[])),d.push(g)}for(this.emitTriggeredEvents(),c=this.contactsDic.getLength();c--;)if(o=this.contactsDic.getKeyByIndex(c),null!=(l=this.contactsDic.getDataByKey(o))){var _=l[0].bi,p=l[0].bj;if(h=l[0].si,f=l[0].sj,_.allowSleep&&_.type===B.DYNAMIC&&_.sleepState===B.SLEEPING&&p.sleepState===B.AWAKE&&p.type!==B.STATIC){var v=p.velocity.norm2()+p.angularVelocity.norm2();2*Math.pow(p.sleepSpeedLimit,2)<=v&&_.wakeUp()}if(p.allowSleep&&p.type===B.DYNAMIC&&p.sleepState===B.SLEEPING&&_.sleepState===B.AWAKE&&_.type!==B.STATIC){var m=_.velocity.norm2()+_.angularVelocity.norm2();2*Math.pow(_.sleepSpeedLimit,2)<=m&&p.wakeUp()}this.collisionMatrix.get(_,p)?b.event="onCollisionStay":(this.collisionMatrix.set(_,p,!0),b.event="onCollisionEnter"),b.contacts=l,b.body=f.body,b.selfShape=h,b.otherShape=f,h.body.dispatchEvent(b),b.body=h.body,b.selfShape=f,b.otherShape=h,f.body.dispatchEvent(b)}var y=x;for(c=y.length;c--;){var g;h=(g=y[c]).si,f=g.sj,null==this.oldContactsDic.get(h.id,f.id)&&this.oldContactsDic.set(h.id,f.id,g)}for(c=this.oldContactsDic.getLength();c--;)o=this.oldContactsDic.getKeyByIndex(c),null==this.contactsDic.getDataByKey(o)&&(_=(l=this.oldContactsDic.getDataByKey(o)).bi,p=l.bj,h=l.si,f=l.sj,this.collisionMatrix.get(_,p)&&(_.isSleeping()&&p.isSleeping()||(this.collisionMatrix.set(_,p,!1),b.event="onCollisionExit",b.body=f.body,b.selfShape=h,b.otherShape=f,b.contacts.length=0,b.contacts.push(l),h.body.dispatchEvent(b),b.body=h.body,b.selfShape=f,b.otherShape=h,f.body.dispatchEvent(b))));this.contactsDic.reset(),this.oldContactsDic.reset(),this.shapeOverlapKeeper.reset()};var b={type:"collide",event:"",body:null,selfShape:null,otherShape:null,contacts:null},x=[],L=[],P=[],F=[];d.prototype.internalStep=function(e){this.dt=e;var t=this.contacts,i=P,n=F,r=this.numObjects(),a=this.bodies,s=this.solver,o=this.gravity,l=(this.profile,B.DYNAMIC),u=this.constraints,c=L,h=o.x,f=o.y,d=o.z,_=0;for(_=0;_!==r;_++)if((A=a[_]).useGravity&&A.type===l){var p=A.force,v=A.mass;p.x+=v*h,p.y+=v*f,p.z+=v*d}_=0;for(var m=this.subsystems.length;_!==m;_++)this.subsystems[_].update();i.length=0,n.length=0,this.broadphase.collisionPairs(this,i,n);var y=u.length;for(_=0;_!==y;_++)if(!(S=u[_]).collideConnected)for(var g=i.length-1;0<=g;g-=1)(S.bodyA===i[g]&&S.bodyB===n[g]||S.bodyB===i[g]&&S.bodyA===n[g])&&(i.splice(g,1),n.splice(g,1));this.shapeOverlapKeeperExit.tick(),t.length=0;var b=this.frictionEquations.length;for(_=0;_!==b;_++)c.push(this.frictionEquations[_]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(i,n,this,t,null,this.frictionEquations,c),_=0;_<this.frictionEquations.length;_++)s.addEquation(this.frictionEquations[_]);var x=t.length;for(_=0;_!==x;_++)s.addEquation(t[_]);for(y=u.length,_=0;_!==y;_++){var S;(S=u[_]).update(),g=0;for(var T=S.equations.length;g!==T;g++){var w=S.equations[g];s.addEquation(w)}}s.solve(e,this),s.removeAllEquations();var E=Math.pow;for(r=this.numObjects(),_=0;_!==r;_++){var A;if((A=a[_]).type&l){var C=E(1-A.linearDamping,e),k=A.velocity;k.mult(C,k);var R=A.angularVelocity;if(R){var O=E(1-A.angularDamping,e);R.mult(O,R)}}}var M=this.stepnumber%(this.quatNormalizeSkip+1)==0,I=this.quatNormalizeFast;for(_=0;_!==r;_++)a[_].integrate(e,M,I);if(this.clearForces(),this.broadphase.dirty=!0,this.time+=e,this.stepnumber+=1,this.allowSleep)for(_=0;_!==r;_++)a[_].sleepTick(this.time)};var p=[],v=[],m={type:"triggered",event:"",selfBody:null,otherBody:null,selfShape:null,otherShape:null};d.prototype.emitTriggeredEvents=function(){p.length=v.length=0,this.shapeOverlapKeeperExit.getDiff(p,v);for(var e=0,t=v.length;e<t;e+=2){m.event="onTriggerExit";var i=this.getShapeById(v[e]),n=this.getShapeById(v[e+1]);this.triggerMatrix.set(i,n,!1),m.selfShape=i,m.otherShape=n,m.selfBody=i.body,m.otherBody=n.body,i.dispatchEvent(m),m.selfShape=n,m.otherShape=i,m.selfBody=n.body,m.otherBody=i.body,n.dispatchEvent(m)}for(p.length=v.length=0,this.shapeOverlapKeeper.getDiff(p,v),e=0,t=p.length;e<t;e+=2){var r=p[e],a=p[e+1];i=this.getShapeById(r),n=this.getShapeById(a),this.triggerMatrix.get(i,n)?m.event="onTriggerStay":(this.triggerMatrix.set(i,n,!0),m.event="onTriggerEnter"),m.selfShape=i,m.otherShape=n,m.selfBody=i.body,m.otherBody=n.body,i.dispatchEvent(m),m.selfShape=n,m.otherShape=i,m.selfBody=n.body,m.otherBody=i.body,n.dispatchEvent(m)}},d.prototype.clearForces=function(){for(var e=this.bodies,t=e.length,i=0;i!==t;i++){var n=e[i];n.force.set(0,0,0),n.torque.set(0,0,0)}}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/ObjectCollisionMatrix":8,"../collision/OverlapKeeper":9,"../collision/Ray":10,"../collision/RaycastResult":11,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../material/ContactMaterial":25,"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Shape":44,"../solver/GSSolver":47,"../utils/EventTarget":50,"../utils/TupleDictionary":53,"./Narrowphase":56}]},{},[2])(2)});d1.CANNON,d1.Shape;function _1(e){return Ni.strictEquals(e,new Ni)?"<origin>":"(x: ".concat(e.x,", y: ").concat(e.y,", z: ").concat(e.z,")")}function p1(e,t){e.__cc_wrapper__=t}function v1(e){return e.__cc_wrapper__}(c1=u1=u1||{})[c1.DYNAMIC=1]="DYNAMIC",c1[c1.STATIC=2]="STATIC",c1[c1.KINEMATIC=4]="KINEMATIC",(f1=h1=h1||{})[f1.SCENE=0]="SCENE",f1[f1.PHYSIC=1]="PHYSIC";var m1=function(){function t(e){y(this,t),this._body=void 0,this._onCollidedListener=void 0,this._collisionCallbacks=[],this._shapes=[],this._userData=void 0,this._world=null,this._name=void 0,e=e||{},this._name=e.name||"",this._body=new d1.Body({type:u1.DYNAMIC}),p1(this._body,this),this._body.sleepSpeedLimit=.1,this._body.sleepTimeLimit=1,this._onCollidedListener=this._onCollided.bind(this)}return l(t,[{key:"impl",get:function(){return this._body}}]),l(t,[{key:"getAllowSleep",value:function(){return this._body.allowSleep}},{key:"setAllowSleep",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.allowSleep=e}},{key:"getGroup",value:function(){return this._body.collisionFilterGroup}},{key:"setGroup",value:function(e){this._body.collisionFilterGroup=e}},{key:"addGroup",value:function(e){this._body.collisionFilterGroup|=e}},{key:"removeGroup",value:function(e){this._body.collisionFilterGroup&=~e}},{key:"getMask",value:function(){return this._body.collisionFilterMask}},{key:"setMask",value:function(e){this._body.collisionFilterMask=e}},{key:"addMask",value:function(e){this._body.collisionFilterMask|=e}},{key:"removeMask",value:function(e){this._body.collisionFilterMask&=~e}},{key:"wakeUp",value:function(){return this._body.wakeUp()}},{key:"sleep",value:function(){return this._body.sleep()}},{key:"name",value:function(){return this._name}},{key:"getType",value:function(){return this._body.type}},{key:"setType",value:function(e){this._body.type=e}},{key:"isAwake",value:function(){return this._body.isAwake()}},{key:"isSleepy",value:function(){return this._body.isSleepy()}},{key:"isSleeping",value:function(){return this._body.isSleeping()}},{key:"addShape",value:function(e,t){this._shapes.push(e),null!=t?this._body.addShape(e.impl,Ni.copy(b1,t)):this._body.addShape(e.impl),e.setBody(this._body,this._shapes.length-1)}},{key:"removeShape",value:function(e){var t=this._shapes.indexOf(e);0<=t&&(this._shapes.splice(t,1),this._body.removeShape(e.impl),e.setBody(null,-1))}},{key:"getMass",value:function(){return this._body.mass}},{key:"setMass",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.mass=e,this._body.updateMassProperties()}},{key:"getIsKinematic",value:function(){return this._body.type===d1.Body.KINEMATIC}},{key:"setIsKinematic",value:function(e){this._body.type=e?d1.Body.KINEMATIC:d1.Body.DYNAMIC}},{key:"getLinearDamping",value:function(){return this._body.linearDamping}},{key:"setLinearDamping",value:function(e){this._body.linearDamping=e}},{key:"getAngularDamping",value:function(){return this._body.angularDamping}},{key:"setAngularDamping",value:function(e){this._body.angularDamping=e}},{key:"getUseGravity",value:function(){return this._body.useGravity}},{key:"setUseGravity",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.useGravity=e}},{key:"getCollisionResponse",value:function(){return this._body.collisionResponse}},{key:"setCollisionResponse",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.collisionResponse=!e}},{key:"getLinearVelocity",value:function(e){return Ni.copy(e,this._body.velocity),e}},{key:"setLinearVelocity",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Ni.copy(this._body.velocity,e)}},{key:"getAngularVelocity",value:function(e){return Ni.copy(e,this._body.angularVelocity),e}},{key:"setAngularVelocity",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Ni.copy(this._body.angularVelocity,e)}},{key:"getLinearFactor",value:function(e){return Ni.copy(e,this._body.linearFactor),e}},{key:"setLinearFactor",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Ni.copy(this._body.linearFactor,e)}},{key:"getAngularFactor",value:function(e){return Ni.copy(e,this._body.angularFactor),e}},{key:"setAngularFactor",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Ni.copy(this._body.angularFactor,e)}},{key:"getFreezeRotation",value:function(){return this._body.fixedRotation}},{key:"setFreezeRotation",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.fixedRotation=e,this._body.updateMassProperties()}},{key:"applyForce",value:function(e,t){null==t&&(t=Ni.ZERO),this._body.isSleeping()&&this._body.wakeUp(),this._body.applyForce(Ni.copy(b1,e),Ni.copy(x1,t))}},{key:"applyImpulse",value:function(e,t){null==t&&(t=Ni.ZERO),this._body.isSleeping()&&this._body.wakeUp(),this._body.applyImpulse(Ni.copy(b1,e),Ni.copy(x1,t))}},{key:"applyLocalForce",value:function(e,t){null==t&&(t=Ni.ZERO),this._body.isSleeping()&&this._body.wakeUp(),this._body.applyLocalForce(Ni.copy(b1,e),Ni.copy(x1,t))}},{key:"applyLocalImpulse",value:function(e,t){null==t&&(t=Ni.ZERO),this._body.isSleeping()&&this._body.wakeUp(),this._body.applyLocalImpulse(Ni.copy(b1,e),Ni.copy(x1,t))}},{key:"applyTorque",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),this._body.torque.x+=e.x,this._body.torque.y+=e.y,this._body.torque.z+=e.z}},{key:"applyLocalTorque",value:function(e){this._body.isSleeping()&&this._body.wakeUp(),Ni.copy(b1,e),this._body.vectorToWorldFrame(b1,b1),this._body.torque.x+=b1.x,this._body.torque.y+=b1.y,this._body.torque.z+=b1.z}},{key:"setWorld",value:function(e){this._world&&(this._body.removeEventListener("collide",this._onCollidedListener),this._body.world.remove(this._body),this._world=null);var t=e;t&&(t.impl.addBody(this._body),this._body.addEventListener("collide",this._onCollidedListener),null==this._body.material&&(this._body.material=t.impl.defaultMaterial)),this._world=t}},{key:"getPosition",value:function(e){Ni.copy(e,this._body.position)}},{key:"setPosition",value:function(e){Ni.copy(this._body.position,e)}},{key:"getRotation",value:function(e){fn.copy(e,this._body.quaternion)}},{key:"setRotation",value:function(e){fn.copy(this._body.quaternion,e)}},{key:"translateAndRotate",value:function(e,t){Pn.getTranslation(this._body.position,e),fn.copy(this._body.quaternion,t)}},{key:"scaleAllShapes",value:function(e){var t=this._shapes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.setScale(e)}}},{key:"addCollisionCallback",value:function(e){this._collisionCallbacks.push(e)}},{key:"removeCollisionCllback",value:function(e){var t=this._collisionCallbacks.indexOf(e);0<=t&&this._collisionCallbacks.splice(t,1)}},{key:"getUserData",value:function(){return this._userData}},{key:"setUserData",value:function(e){this._userData=e}},{key:"_stringfyThis",value:function(){return"".concat(this._name.length?this._name:"<No-name>")}},{key:"_devStrinfy",value:function(){var e=this._body.shapes.map(function(e){return v1(e)._devStrinfy()}).join("; ");return"Name: [[".concat(this._name.length?this._name:"<No-name>","]], position: ").concat(_1(this._body.position),", shapes: [").concat(e,"]")}},{key:"_onCollided",value:function(e){y1.type=e.event,y1.selfCollider=v1(e.selfShape).getUserData(),y1.otherCollider=v1(e.otherShape).getUserData();var t=0;for(t=y1.contacts.length;t--;)g1.push(y1.contacts.pop());for(t=0;t<e.contacts.length;t++){var i=e.contacts[t];if(0<g1.length){var n=g1.pop();Ni.copy(n.contactA,i.ri),Ni.copy(n.contactB,i.rj),Ni.copy(n.normal,i.ni),y1.contacts.push(n)}else{var r={contactA:Ni.copy(new Ni,i.ri),contactB:Ni.copy(new Ni,i.rj),normal:Ni.copy(new Ni,i.ni)};y1.contacts.push(r)}}for(t=0;t<this._collisionCallbacks.length;t++){(0,this._collisionCallbacks[t])(y1)}}}]),t}(),y1={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[]},g1=[],b1=new d1.Vec3,x1=new d1.Vec3,S1=function(){function e(){y(this,e),this._hitPoint=new Ni,this._distance=0,this._collidier=null,this._node=null}return l(e,[{key:"_assign",value:function(e,t,i,n){Ni.copy(this._hitPoint,e),this._distance=t,this._node=n.getUserData(),this._collidier=i.getUserData()}},{key:"hitPoint",get:function(){return this._hitPoint}},{key:"distance",get:function(){return this._distance}},{key:"collider",get:function(){return this._collidier}},{key:"node",get:function(){return this._node}}]),e}();function T1(e){return function(e,t){for(var i={},n=0,r=Object.keys(e);n<r.length;n++){var a=r[n],s=a;if(t){var o=t[a];o&&(s=o)}i[s]=e[a]}return i}(e,{queryTriggerInteraction:"checkCollisionResponse"})}function w1(e,t){e._assign(t.hitPointWorld,t.distance,v1(t.shape),v1(t.body))}function E1(e){e.updateMassProperties(),e.updateBoundingRadius(),e.aabbNeedsUpdate=!0}var A1=function(){function t(){y(this,t),this._scale=new Ni(1,1,1),this._shape=null,this._body=null,this._index=-1,this._center=new Ni(0,0,0),this._userData=void 0,this._onTriggerListener=void 0,this._triggeredCB=[],this._onTriggerListener=this.onTrigger.bind(this)}return l(t,[{key:"impl",get:function(){return this._shape}},{key:"material",set:function(e){null==e?this._shape.material=null:(null==t.idToMaterial[e._uuid]&&(t.idToMaterial[e._uuid]=new d1.Material(e._uuid)),this._shape.material=t.idToMaterial[e._uuid],this._shape.material.friction=e.friction,this._shape.material.restitution=e.restitution)}}]),l(t,[{key:"addTriggerCallback",value:function(e){this._triggeredCB.push(e)}},{key:"removeTriggerCallback",value:function(e){var t=this._triggeredCB.indexOf(e);0<=t&&this._triggeredCB.splice(t,1)}},{key:"getUserData",value:function(){return this._userData}},{key:"setUserData",value:function(e){this._userData=e}},{key:"setBody",value:function(e,t){null==e?this._shape.removeEventListener("triggered",this._onTriggerListener):this._shape.addEventListener("triggered",this._onTriggerListener),this._body=e,this._index=t}},{key:"setCenter",value:function(e){Ni.copy(this._center,e),this._recalcCenter()}},{key:"setScale",value:function(e){Ni.copy(this._scale,e),this._recalcCenter()}},{key:"setRotation",value:function(e){}},{key:"getCollisionResponse",value:function(){return this.impl.collisionResponse}},{key:"setCollisionResponse",value:function(e){this.impl.collisionResponse=e}},{key:"_devStrinfy",value:function(){return this._body?"centerOffset: ".concat(_1(this._body.shapeOffsets[this._index])):"<NotAttached>"}},{key:"onTrigger",value:function(e){B1.type=e.event,B1.selfCollider=v1(e.selfShape).getUserData(),B1.otherCollider=v1(e.otherShape).getUserData();var t=this._triggeredCB,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r(B1)}}},{key:"_recalcCenter",value:function(){if(this._body){var e=this._body.shapeOffsets[this._index];Ni.copy(e,this._center),Ni.multiply(e,e,this._scale),E1(this._body)}}}]),t}();A1.idToMaterial={};var C1,k1,R1,O1,M1,I1,B1={type:"",selfCollider:null,otherCollider:null},L1=function(){function e(){y(this,e),this._world=void 0,this._customBeforeStepListener=[],this._customAfterStepListener=[],this._raycastResult=new d1.RaycastResult,this._world=new d1.World,p1(this._world,this),this._world.broadphase=new d1.NaiveBroadphase}return l(e,[{key:"impl",get:function(){return this._world}}]),l(e,[{key:"getAllowSleep",value:function(){return this._world.allowSleep}},{key:"setAllowSleep",value:function(e){this._world.allowSleep=e}},{key:"setGravity",value:function(e){Ni.copy(this._world.gravity,e)}},{key:"getGravity",value:function(e){Ni.copy(e,this._world.gravity)}},{key:"destroy",value:function(){}},{key:"step",value:function(e,t,i){this._callCustomBeforeSteps(),this._world.step(e,t,i),this._callCustomAfterSteps()}},{key:"addBeforeStep",value:function(e){this._customBeforeStepListener.push(e)}},{key:"removeBeforeStep",value:function(e){var t=this._customBeforeStepListener.indexOf(e);t<0||this._customBeforeStepListener.splice(t,1)}},{key:"addAfterStep",value:function(e){this._customAfterStepListener.push(e)}},{key:"removeAfterStep",value:function(e){var t=this._customAfterStepListener.indexOf(e);t<0||this._customAfterStepListener.splice(t,1)}},{key:"raycastClosest",value:function(e,t,i,n){var r=this._world.raycastClosest(e,t,T1(i),this._raycastResult);return r&&w1(n,this._raycastResult),r}},{key:"raycastAny",value:function(e,t,i,n){var r=this._world.raycastAny(e,t,T1(i),this._raycastResult);return r&&w1(n,this._raycastResult),r}},{key:"raycastAll",value:function(e,t,i,n){return this._world.raycastAll(e,t,T1(i),function(e){var t=new S1;w1(t,e),n(t)})}},{key:"addConstraint",value:function(e){this._world.addConstraint(e.impl)}},{key:"removeConstraint",value:function(e){this._world.removeConstraint(e.impl)}},{key:"_callCustomBeforeSteps",value:function(){this._customBeforeStepListener.forEach(function(e){return e()})}},{key:"_callCustomAfterSteps",value:function(){this._customAfterStepListener.forEach(function(e){return e()})}},{key:"defaultMaterial",set:function(e){this._world.defaultMaterial.friction=e.friction,this._world.defaultMaterial.restitution=e.restitution,null!=A1.idToMaterial[e._uuid]&&(A1.idToMaterial[e._uuid]=this._world.defaultMaterial)}}]),e}();q0=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this)))._box=void 0,t._halfExtent=new d1.Vec3,Ni.multiplyScalar(t._halfExtent,e,.5),t._box=new d1.Box(t._halfExtent.clone()),p1(t._box,c(t)),t._shape=t._box,t._shape.addEventListener("trigger",t.onTrigger),t}return _(i,A1),l(i,[{key:"setScale",value:function(e){p(g(i.prototype),"setScale",this).call(this,e),this._recalcExtents()}},{key:"setSize",value:function(e){Ni.multiplyScalar(this._halfExtent,e,.5),this._recalcExtents()}},{key:"_stringfyThis",value:function(){return"".concat(this._body?v1(this._body)._stringfyThis():"<No-body>","(Box)")}},{key:"_devStrinfy",value:function(){return"Box(".concat(p(g(i.prototype),"_devStrinfy",this).call(this),", halfExtents: ").concat(_1(this._box.halfExtents),")")}},{key:"_recalcExtents",value:function(){Ni.multiply(this._box.halfExtents,this._halfExtent,this._scale),this._box.updateConvexPolyhedronRepresentation(),null!=this._body&&E1(this._body)}}]),i}(),j0=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this)))._sphere=void 0,t._radius=0,t._radius=e,t._sphere=new d1.Sphere(t._radius),p1(t._sphere,c(t)),t._shape=t._sphere,t}return _(i,A1),l(i,[{key:"setScale",value:function(e){p(g(i.prototype),"setScale",this).call(this,e),this._recalcRadius()}},{key:"setRadius",value:function(e){this._radius=e,this._recalcRadius()}},{key:"_devStrinfy",value:function(){return"Sphere(".concat(p(g(i.prototype),"_devStrinfy",this).call(this),", radius: ").concat(this._sphere.radius,")")}},{key:"_recalcRadius",value:function(){this._sphere.radius=this._radius*function(e){return Math.max(e.x,Math.max(e.y,e.z))}(this._scale),null!=this._body&&E1(this._body)}}]),i}(),X0=m1,Y0=L1;var P1=m4("PhysicMaterial",fo("cc.PhysicMaterial")((I1=M1=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"_friction",R1,c(e)),v(e,"_restitution",O1,c(e)),t.allMaterials.push(c(e)),""==e._uuid&&(e._uuid="pm_"+t._idCounter++),e}return _(t,nh),l(t,[{key:"friction",get:function(){return this._friction},set:function(e){di(this._friction,e)||(this._friction=e,this.emit("physics_material_update"))}},{key:"restitution",get:function(){return this._restitution},set:function(e){di(this._restitution,e)||(this._restitution=e,this.emit("physics_material_update"))}}]),l(t,[{key:"clone",value:function(){var e=new t;return e._friction=this._friction,e._restitution=this._restitution,e}},{key:"destroy",value:function(){if(p(g(t.prototype),"destroy",this).call(this)){var e=t.allMaterials.indexOf(this);return 0<=e&&t.allMaterials.splice(e,1),!0}return!1}}]),t}(),M1.allMaterials=[],M1._idCounter=0,R1=m((k1=I1).prototype,"_friction",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),O1=m(k1.prototype,"_restitution",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),C1=k1))||C1);cc.createRaycastResult=function(){return new S1};var F1=m4("PhysicsSystem",function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._world=void 0,e._enable=!0,e._deltaTime=1/60,e._maxSubStep=2,e._allowSleep=!0,e._gravity=new Ni(0,-10,0),e._material=null,e._world=new Y0,e.gravity=e._gravity,e.allowSleep=e._allowSleep,e._material=new P1,e._material.friction=.6,e._material.restitution=-1,e._material.on("physics_material_update",e._updateMaterial,c(e)),e._world.defaultMaterial=e._material,e}return _(t,iv),l(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this._world.setAllowSleep(this._allowSleep)}},{key:"maxSubStep",get:function(){return this._maxSubStep},set:function(e){this._maxSubStep=e}},{key:"deltaTime",get:function(){return this._deltaTime},set:function(e){this._deltaTime=e}},{key:"gravity",get:function(){return this._world.getGravity(this._gravity),this._gravity},set:function(e){this._gravity.x=e.x,this._gravity.y=e.y,this._gravity.z=e.z,this._world.setGravity(e)}},{key:"defaultMaterial",get:function(){return this._material}}]),l(t,[{key:"postUpdate",value:function(e){this._enable&&(kx.emit(Cx.EVENT_BEFORE_PHYSICS),this._world.step(this._deltaTime,e,this._maxSubStep),kx.emit(Cx.EVENT_AFTER_PHYSICS))}},{key:"_updateMaterial",value:function(){this._world.defaultMaterial=this._material}}]),t}());F1.instance=void 0,F1.ID=void 0,cc.PhysicsSystem=F1,kx.on(Cx.EVENT_INIT,function(){var e=new F1;F1.instance=e,kx.registerSystem(F1.ID,e,0)});var z1,D1,N1,U1,V1,G1,H1,W1,q1,j1,X1=function(){function o(){var e;return y(this,o),(e=x(this,g(o).call(this)))._sharedBody=void 0,e._isPreLoaded=!1,e}return _(o,Tm),l(o,[{key:"_body",get:function(){return this._sharedBody.body}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"_assertPreload",get:function(){return this._isPreLoaded||C("Physic Error: Please make sure that the node has been added to the scene"),this._isPreLoaded}}]),l(o,[{key:"setGroup",value:function(e){if(this._assertPreload)return this._body.setGroup(e)}},{key:"getGroup",value:function(){return this._assertPreload?this._body.getGroup():0}},{key:"addGroup",value:function(e){if(this._assertPreload)return this._body.addGroup(e)}},{key:"removeGroup",value:function(e){if(this._assertPreload)return this._body.removeGroup(e)}},{key:"getMask",value:function(){return this._assertPreload?this._body.getMask():0}},{key:"setMask",value:function(e){if(this._assertPreload)return this._body.setMask(e)}},{key:"addMask",value:function(e){if(this._assertPreload)return this._body.addMask(e)}},{key:"removeMask",value:function(e){if(this._assertPreload)return this._body.removeMask(e)}},{key:"__preload",value:function(){if(null==this._sharedBody){var e=null,t=this.node.getComponents(o),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a._sharedBody){e=a._sharedBody;break}}if(!e){var s=this.getComponent(cc.RigidBodyComponent);e=new Y1(this.node,s,F1.instance._world)}e.ref(),this._sharedBody=e}this._isPreLoaded=!0}},{key:"onEnable",value:function(){this.sharedBody.enable()}},{key:"onDisable",value:function(){this.sharedBody.disable()}},{key:"onDestroy",value:function(){this._sharedBody.deref(),this._sharedBody=null}},{key:"_findRigidbody",value:function(e){var t=e.getComponent(cc.RigidBodyComponent);return t||(e.parent?e.parent===e.scene?null:this._findRigidbody(e.parent):null)}}]),o}(),Y1=function(){function n(e,t,i){y(this,n),this._body=void 0,this._refCount=0,this._actived=!1,this._world=void 0,this._rigidBody=void 0,this._node=void 0,this._worldScale=new Ni(1,1,1),this._beforeStepCallback=void 0,this._afterStepCallback=void 0,this._isShapeOnly=!0,this._body=function(e){return new X0(e)}({name:e.name}),this._node=e,this._rigidBody=t,this._world=i,this._body.setUserData(this._rigidBody),this._beforeStepCallback=this._beforeStep.bind(this),this._afterStepCallback=this._afterStep.bind(this),this._rigidBody?this._isShapeOnly=!1:(this._isShapeOnly=!0,this._body.setUseGravity(!1))}return l(n,[{key:"isShapeOnly",get:function(){return this._isShapeOnly}},{key:"body",get:function(){return this._body}},{key:"transfromSource",set:function(e){e===h1.SCENE?this._isShapeOnly=!0:this._isShapeOnly=!1}},{key:"rigidBody",get:function(){return this._rigidBody}}]),l(n,[{key:"ref",value:function(){++this._refCount}},{key:"deref",value:function(){--this._refCount,this._refCount||this.destroy()}},{key:"enable",value:function(){this._activeBody()}},{key:"disable",value:function(){this._deactiveBody()}},{key:"destroy",value:function(){this._deactiveBody(),this._body.setUserData(null),this._body=null,this._beforeStepCallback=null,this._afterStepCallback=null,this._world=null,this._node=null,this._rigidBody&&(this._rigidBody=null)}},{key:"syncPhysWithScene",value:function(){this._syncPhysWithScene(this._node)}},{key:"_syncPhysWithScene",value:function(e){e.getWorldMatrix(n._tempMat4),e.getWorldRotation(n._tempQuat),this._body.translateAndRotate(n._tempMat4,n._tempQuat)}},{key:"_syncSceneWithPhys",value:function(){this._node&&(this._body.getPosition(n._tempVec3),this._node.setWorldPosition(n._tempVec3),this._body.getFreezeRotation()||(this._body.getRotation(n._tempQuat),this._node.setWorldRotation(n._tempQuat)))}},{key:"_activeBody",value:function(){this._syncPhysWithScene(this._node),this._actived||(this._actived=!0,this._body.setWorld(this._world),this._world.addBeforeStep(this._beforeStepCallback),this._world.addAfterStep(this._afterStepCallback),this._body.wakeUp())}},{key:"_deactiveBody",value:function(){this._actived&&(this._actived=!1,this._world.removeBeforeStep(this._beforeStepCallback),this._world.removeAfterStep(this._afterStepCallback),this._body.sleep(),this._body.setWorld(null))}},{key:"_beforeStep",value:function(){this._node.hasChangedFlags&&(this._node.hasChangedFlags&Vm.SCALE&&this._body.scaleAllShapes(this._node.worldScale),this._syncPhysWithScene(this._node),this._body.isSleeping()&&this._body.wakeUp())}},{key:"_afterStep",value:function(){this._isShapeOnly||this._body.getType()!==u1.DYNAMIC?this._node.hasChangedFlags&&(this._syncPhysWithScene(this._node),this._body.isSleeping()&&this._body.wakeUp()):this._syncSceneWithPhys()}}]),n}();Y1._tempMat4=new Pn,Y1._tempQuat=new fn,Y1._tempVec3=new Ni;var K1=m4("ColliderComponent",(z1=fo("cc.ColliderComponent"),D1=_o({type:P1,displayName:"Material",displayOrder:-1}),N1=_o({displayOrder:0}),U1=_o({type:Ni,displayOrder:1,tooltip:"The center of the collider, in local space"}),V1=_o({type:P1}),z1((m((H1=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._callbackTable=ke(!0),e._shapeBase=void 0,e._isSharedMaterial=!0,e._trrigerCallback=void 0,e._collisionCallBack=void 0,v(e,"_material",W1,c(e)),v(e,"_isTrigger",q1,c(e)),v(e,"_center",j1,c(e)),e._trrigerCallback=e._onTrigger.bind(c(e)),e._collisionCallBack=e._onCollision.bind(c(e)),e}return _(t,X1),l(t,[{key:"sharedMaterial",get:function(){return this._material},set:function(e){this.material=e}},{key:"material",get:function(){return this._isSharedMaterial&&null!=this._material&&(this._material.off("physics_material_update",this._updateMaterial,this),this._material=this._material.clone(),this._material.on("physics_material_update",this._updateMaterial,this),this._isSharedMaterial=!1),this._material},set:function(e){null!=e&&null!=this._material?this._material._uuid!=e._uuid&&(this._material.off("physics_material_update",this._updateMaterial,this),e.on("physics_material_update",this._updateMaterial,this),this._isSharedMaterial=!1,this._material=e):null!=e&&null==this._material?(e.on("physics_material_update",this._updateMaterial,this),this._material=e):null==e&&null!=this._material&&(this._material.off("physics_material_update",this._updateMaterial,this),this._material=e),this._updateMaterial()}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){if(this._isTrigger=e,this.sharedBody){var t=this._isTrigger?u1.DYNAMIC:u1.STATIC;this.sharedBody.body.setType(t),this._shapeBase.setCollisionResponse(!this._isTrigger)}}},{key:"center",get:function(){return this._center},set:function(e){Ni.copy(this._center,e);var t=this.sharedBody.rigidBody;null!=t?(Ni.subtract(V2,this.node.worldPosition,t.node.worldPosition),Ni.add(V2,V2,this._center),this._shapeBase.setCenter(V2)):this._shapeBase.setCenter(this._center)}},{key:"attachedRigidbody",get:function(){return this.sharedBody.rigidBody}}]),l(t,[{key:"on",value:function(e,t,i,n){}},{key:"off",value:function(e,t,i,n){}},{key:"once",value:function(e,t,i,n){}},{key:"targetOff",value:function(e){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"onLoad",value:function(){this.isTrigger=this._isTrigger,this.sharedMaterial=null==this._material?F1.instance.defaultMaterial:this._material,this.center=this._center}},{key:"onEnable",value:function(){p(g(t.prototype),"onEnable",this).call(this);var e=this.sharedBody.rigidBody;null!=e?(Ni.subtract(V2,this.node.worldPosition,e.node.worldPosition),Ni.add(V2,V2,this._center),this.sharedBody.body.addShape(this._shapeBase,V2)):this.sharedBody.body.addShape(this._shapeBase,this._center),this.center=this._center,this._shapeBase.addTriggerCallback(this._trrigerCallback),this.sharedBody.body.addCollisionCallback(this._collisionCallBack),this.sharedBody.syncPhysWithScene()}},{key:"onDisable",value:function(){this._shapeBase.removeTriggerCallback(this._trrigerCallback),this.sharedBody.body.removeCollisionCllback(this._collisionCallBack),this.sharedBody.body.removeShape(this._shapeBase),this.sharedBody.isShapeOnly&&p(g(t.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){this.sharedBody.body.removeShape(this._shapeBase),null!=this._material&&this._material._uuid!=F1.instance.defaultMaterial._uuid&&(this._material.destroy(),this._material=null),p(g(t.prototype),"onDestroy",this).call(this)}},{key:"_updateMaterial",value:function(){this._shapeBase.material=this._material}},{key:"_onTrigger",value:function(e){this.emit(e.type,e)}},{key:"_onCollision",value:function(e){this.emit(e.type,e)}}]),t}()).prototype,"sharedMaterial",[D1],Object.getOwnPropertyDescriptor(H1.prototype,"sharedMaterial"),H1.prototype),m(H1.prototype,"isTrigger",[N1],Object.getOwnPropertyDescriptor(H1.prototype,"isTrigger"),H1.prototype),m(H1.prototype,"center",[U1],Object.getOwnPropertyDescriptor(H1.prototype,"center"),H1.prototype),W1=m(H1.prototype,"_material",[V1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),q1=m(H1.prototype,"_isTrigger",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),j1=m(H1.prototype,"_center",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new cc.Vec3(0,0,0)}}),G1=H1))||G1));Lc(K1,[ll,cl]);var Q1,Z1,J1,$1,e2,t2,i2,n2,r2,a2,s2,o2,l2,u2,c2,h2,f2,d2,_2,p2,v2,m2,y2,g2,b2,x2,S2,T2,w2,E2,A2,C2,k2,R2,O2,M2,I2,B2,L2,P2,F2,z2,D2,N2,U2,V2=new Ni,G2=m4("BoxColliderComponent",(Q1=fo("cc.BoxColliderComponent"),Z1=bo(98),J1=go("Components/BoxCollider"),$1=_o({type:Ni}),Q1(e2=Z1(e2=J1(e2=mo((i2=m((t2=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._shape=void 0,v(e,"_size",i2,c(e)),e._shape=function(e){return new q0(e)}(e._size),e._shape.setUserData(c(e)),e._shapeBase=e._shape,e}return _(t,K1),l(t,[{key:"onLoad",value:function(){p(g(t.prototype),"onLoad",this).call(this),this.size=this._size,this._shape.setScale(this.node.worldScale)}},{key:"size",get:function(){return this._size},set:function(e){Ni.copy(this._size,e),this._shape.setSize(this._size)}}]),t}()).prototype,"_size",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni(0,0,0)}}),m(t2.prototype,"size",[$1],Object.getOwnPropertyDescriptor(t2.prototype,"size"),t2.prototype),e2=t2))||e2)||e2)||e2)||e2)),H2=m4("SphereColliderComponent",fo("cc.SphereColliderComponent")(n2=bo(98)(n2=go("Components/SphereCollider")(n2=mo((a2=m((r2=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._shape=void 0,v(e,"_radius",a2,c(e)),e._shape=function(e){return new j0(e)}(e._radius),e._shape.setUserData(c(e)),e._shapeBase=e._shape,e}return _(t,K1),l(t,[{key:"onLoad",value:function(){p(g(t.prototype),"onLoad",this).call(this),this.radius=this._radius,this._shape.setScale(this.node.worldScale)}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e,this._shape.setRadius(this._radius)}}]),t}()).prototype,"_radius",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m(r2.prototype,"radius",[_o],Object.getOwnPropertyDescriptor(r2.prototype,"radius"),r2.prototype),n2=r2))||n2)||n2)||n2)||n2),W2=10,q2=0,j2=0,X2=m4("RigidBodyComponent",(s2=fo("cc.RigidBodyComponent"),o2=bo(99),l2=go("Components/RigidBody"),u2=_o({displayOrder:0}),c2=_o({displayOrder:1}),h2=_o({displayOrder:2}),f2=_o({displayOrder:3}),d2=_o({displayOrder:4}),_2=_o({displayOrder:5}),p2=_o({displayOrder:6}),v2=_o({displayOrder:7}),s2(m2=o2(m2=l2(m2=mo(m2=xo((m((y2=function(){function t(){var e;return y(this,t),(e=x(this,g(t).call(this)))._allowSleep=!0,v(e,"_mass",g2,c(e)),v(e,"_linearDamping",b2,c(e)),v(e,"_angularDamping",x2,c(e)),v(e,"_fixedRotation",S2,c(e)),v(e,"_isKinematic",T2,c(e)),v(e,"_useGravity",w2,c(e)),v(e,"_linearFactor",E2,c(e)),v(e,"_angularFactor",A2,c(e)),e}return _(t,X1),l(t,[{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this.sharedBody.body.setAllowSleep(e)}},{key:"mass",get:function(){return this._mass},set:function(e){this._mass=e,this._body.setMass(e)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._body.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._body.setAngularDamping(e)}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic=e,this._body.setIsKinematic(e)}},{key:"useGravity",get:function(){return this._useGravity},set:function(e){this._useGravity=e,this._body.setUseGravity(e)}},{key:"fixedRotation",get:function(){return this._fixedRotation},set:function(e){this._fixedRotation=e,this._body.setFreezeRotation(e)}},{key:"linearFactor",get:function(){return this._body.getLinearFactor(this._linearFactor)},set:function(e){Ni.copy(this._linearFactor,e),this._body.setLinearFactor(this._linearFactor)}},{key:"angularFactor",get:function(){return this._body.getAngularFactor(this._angularFactor)},set:function(e){Ni.copy(this._angularFactor,e),this._body.setAngularFactor(this._angularFactor)}},{key:"isAwake",get:function(){return!!this._assertPreload&&this._body.isAwake()}},{key:"isSleepy",get:function(){return!!this._assertPreload&&this._body.isSleepy()}},{key:"isSleeping",get:function(){return!!this._assertPreload&&this._body.isSleeping()}}]),l(t,[{key:"applyForce",value:function(e,t){this._assertPreload&&this._body.applyForce(e,t)}},{key:"applyLocalForce",value:function(e,t){this._assertPreload&&this._body.applyLocalForce(e,t)}},{key:"applyImpulse",value:function(e,t){this._assertPreload&&this._body.applyImpulse(e,t)}},{key:"applyLocalImpulse",value:function(e,t){this._assertPreload&&this._body.applyLocalImpulse(e,t)}},{key:"applyTorque",value:function(e){this._assertPreload&&this._body.applyTorque(e)}},{key:"applyLocalTorque",value:function(e){this._assertPreload&&this._body.applyLocalTorque(e)}},{key:"wakeUp",value:function(){this._assertPreload&&this._body.wakeUp()}},{key:"sleep",value:function(){this._assertPreload&&this._body.sleep()}},{key:"getLinearVelocity",value:function(e){this._assertPreload&&this._body.getLinearVelocity(e)}},{key:"setLinearVelocity",value:function(e){this._assertPreload&&this._body.setLinearVelocity(e)}},{key:"getAngularVelocity",value:function(e){this._assertPreload&&this._body.getAngularVelocity(e)}},{key:"setAngularVelocity",value:function(e){this._assertPreload&&this._body.setAngularVelocity(e)}},{key:"onLoad",value:function(){this.sharedBody&&(this.allowSleep=this._allowSleep,this.mass=this._mass,this.linearDamping=this._linearDamping,this.angularDamping=this._angularDamping,this.useGravity=this._useGravity,this.isKinematic=this._isKinematic,this.fixedRotation=this._fixedRotation,this.linearFactor=this._linearFactor,this.angularFactor=this._angularFactor)}}]),t}()).prototype,"mass",[u2],Object.getOwnPropertyDescriptor(y2.prototype,"mass"),y2.prototype),m(y2.prototype,"linearDamping",[c2],Object.getOwnPropertyDescriptor(y2.prototype,"linearDamping"),y2.prototype),m(y2.prototype,"angularDamping",[h2],Object.getOwnPropertyDescriptor(y2.prototype,"angularDamping"),y2.prototype),m(y2.prototype,"isKinematic",[f2],Object.getOwnPropertyDescriptor(y2.prototype,"isKinematic"),y2.prototype),m(y2.prototype,"useGravity",[d2],Object.getOwnPropertyDescriptor(y2.prototype,"useGravity"),y2.prototype),m(y2.prototype,"fixedRotation",[_2],Object.getOwnPropertyDescriptor(y2.prototype,"fixedRotation"),y2.prototype),m(y2.prototype,"linearFactor",[p2],Object.getOwnPropertyDescriptor(y2.prototype,"linearFactor"),y2.prototype),m(y2.prototype,"angularFactor",[v2],Object.getOwnPropertyDescriptor(y2.prototype,"angularFactor"),y2.prototype),g2=m(y2.prototype,"_mass",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return W2}}),b2=m(y2.prototype,"_linearDamping",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return q2}}),x2=m(y2.prototype,"_angularDamping",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return j2}}),S2=m(y2.prototype,"_fixedRotation",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T2=m(y2.prototype,"_isKinematic",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),w2=m(y2.prototype,"_useGravity",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),E2=m(y2.prototype,"_linearFactor",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni(1,1,1)}}),A2=m(y2.prototype,"_angularFactor",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni(1,1,1)}}),m2=y2))||m2)||m2)||m2)||m2)||m2)),Y2=m4("ConstantForce",(C2=fo("cc.ConstantForce"),k2=bo(98),R2=yo(X2),O2=go("Components/ConstantForce"),M2=_o({displayOrder:0}),I2=_o({displayOrder:1}),B2=_o({displayOrder:2}),L2=_o({displayOrder:3}),C2(P2=k2(P2=R2(P2=O2(P2=xo(P2=mo((z2=m((F2=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._rigidbody=null,v(t,"_force",z2,c(t)),v(t,"_localForce",D2,c(t)),v(t,"_torque",N2,c(t)),v(t,"_localTorque",U2,c(t)),t._mask=0,t}return _(a,Tm),l(a,[{key:"onLoad",value:function(){this._rigidbody=this.node.getComponent(X2),this._maskUpdate(this._force,1),this._maskUpdate(this._localForce,2),this._maskUpdate(this._torque,4),this._maskUpdate(this._localTorque,8)}},{key:"lateUpdate",value:function(e){null!=this._rigidbody&&0!=this._mask&&(1&this._mask&&this._rigidbody.applyForce(this._force),2&this._mask&&this._rigidbody.applyLocalForce(this.localForce),4&this._mask&&this._rigidbody.applyTorque(this._torque),8&this._mask&&this._rigidbody.applyLocalTorque(this._localTorque))}},{key:"_maskUpdate",value:function(e,t){e.strictEquals(Ni.ZERO)?this._mask&=~t:this._mask|=t}},{key:"force",get:function(){return this._force},set:function(e){Ni.copy(this._force,e),this._maskUpdate(this._force,1)}},{key:"localForce",get:function(){return this._localForce},set:function(e){Ni.copy(this._localForce,e),this._maskUpdate(this.localForce,2)}},{key:"torque",get:function(){return this._torque},set:function(e){Ni.copy(this._torque,e),this._maskUpdate(this._torque,4)}},{key:"localTorque",get:function(){return this._localTorque},set:function(e){Ni.copy(this._localTorque,e),this._maskUpdate(this._localTorque,8)}}]),a}()).prototype,"_force",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni}}),D2=m(F2.prototype,"_localForce",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni}}),N2=m(F2.prototype,"_torque",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni}}),U2=m(F2.prototype,"_localTorque",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni}}),m(F2.prototype,"force",[M2],Object.getOwnPropertyDescriptor(F2.prototype,"force"),F2.prototype),m(F2.prototype,"localForce",[I2],Object.getOwnPropertyDescriptor(F2.prototype,"localForce"),F2.prototype),m(F2.prototype,"torque",[B2],Object.getOwnPropertyDescriptor(F2.prototype,"torque"),F2.prototype),m(F2.prototype,"localTorque",[L2],Object.getOwnPropertyDescriptor(F2.prototype,"localTorque"),F2.prototype),P2=F2))||P2)||P2)||P2)||P2)||P2)||P2));cc.ConstantForce=Y2,or(F1,"PhysicsSystem",[{name:"ins",newName:"instance"}]),cc.ColliderComponent=K1,cc.BoxColliderComponent=G2,cc.SphereColliderComponent=H2,cc.RigidBodyComponent=X2,cc.PhysicMaterial=P1;var K2,Q2,Z2,J2,$2,e3,t3,i3,n3={INITIALIZING:0,PLAYING:1,STOPPED:2},r3=function(){function i(e){var t=this;y(this,i),this._state=n3.STOPPED,this._duration=0,this._eventTarget=void 0,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._blocking=!1,this._duration=e.duration,this._eventTarget=e.eventTarget,this._onHide=function(){t._blocking=!0,t._state===n3.PLAYING&&(t.pause(),t._interrupted=!0)},this._onShow=function(){t._blocking=!1,t._interrupted&&(t.play(),t._interrupted=!1)},cc.game.on(cc.Game.EVENT_HIDE,this._onHide),cc.game.on(cc.Game.EVENT_SHOW,this._onShow)}return l(i,[{key:"getState",value:function(){return this._state}},{key:"getDuration",value:function(){return this._duration}},{key:"destroy",value:function(){cc.game.off(cc.Game.EVENT_HIDE,this._onHide),cc.game.off(cc.Game.EVENT_SHOW,this._onShow)}}]),i}(),a3=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._volume=1,t._loop=!1,t._oneShoting=!1,t._audio=void 0,t._post_play=void 0,t._on_gesture=void 0,t._audio=e.clip,t._post_play=function(){t._state=n3.PLAYING,t._eventTarget.emit("started")},t._on_gesture=function(){if(t._audio){var e=t._audio.play();e?e.then(function(){t._interrupted?(t._post_play(),t._interrupted=!1):(t._audio.pause(),t._audio.currentTime=0),cc.game.canvas.removeEventListener("touchend",t._on_gesture),cc.game.canvas.removeEventListener("mouseup",t._on_gesture)}):console.warn("no promise returned from HTMLMediaElement.play()")}},t._audio.volume=t._volume,t._audio.loop=t._loop,t._audio.addEventListener("ended",function(){t._oneShoting||(t._state=n3.STOPPED,t._audio.currentTime=0,t._eventTarget.emit("ended"))}),cc.game.canvas.addEventListener("touchend",t._on_gesture),cc.game.canvas.addEventListener("mouseup",t._on_gesture),t}return _(i,r3),l(i,[{key:"play",value:function(){var e=this;if(this._audio&&this._state!==n3.PLAYING)if(this._blocking)this._interrupted=!0;else{var t=this._audio.play();t?t.then(this._post_play).catch(function(){e._interrupted=!0}):console.warn("no promise returned from HTMLMediaElement.play()")}}},{key:"pause",value:function(){this._audio&&this._state===n3.PLAYING&&(this._audio.pause(),this._state=n3.STOPPED,this._oneShoting=!1)}},{key:"stop",value:function(){this._audio&&(this._audio.currentTime=0,this._state===n3.PLAYING&&(this._audio.pause(),this._state=n3.STOPPED,this._oneShoting=!1))}},{key:"playOneShot",value:function(e){var t=this,i=0<arguments.length&&void 0!==e?e:1,n=this._audio;n&&(n.currentTime=0,n.volume=i,this._oneShoting||(n.loop=!1,this._oneShoting=!0,n.play().then(function(){n.addEventListener("ended",function(){n.currentTime=0,n.volume=t._volume,n.loop=t._loop,t._oneShoting=!1},{once:!0})}).catch(function(){t._oneShoting=!1})))}},{key:"setCurrentTime",value:function(e){this._audio&&(this._audio.currentTime=pi(e,0,this._duration))}},{key:"getCurrentTime",value:function(){return this._audio?this._audio.currentTime:0}},{key:"setVolume",value:function(e,t){this._volume=e,this._audio&&(this._audio.volume=e)}},{key:"getVolume",value:function(){return this._audio?this._audio.volume:this._volume}},{key:"setLoop",value:function(e){this._loop=e,this._audio&&(this._audio.loop=e)}},{key:"getLoop",value:function(){return this._loop}},{key:"destroy",value:function(){this._audio&&(this._audio.src=""),p(g(i.prototype),"destroy",this).call(this)}}]),i}(),s3=fl.__audioSupport,o3=function(){function i(e){var t;return y(this,i),(t=x(this,g(i).call(this,e)))._startTime=0,t._offset=0,t._volume=1,t._loop=!1,t._currentTimer=0,t._audio=void 0,t._context=void 0,t._sourceNode=void 0,t._gainNode=void 0,t._on_ended=void 0,t._do_play=void 0,t._on_gesture=void 0,t._audio=e.clip,t._context=s3.context,t._sourceNode=t._context.createBufferSource(),t._gainNode=t._context.createGain(),t._gainNode.connect(t._context.destination),t._on_ended=function(){t._offset=0,t._startTime=t._context.currentTime,t._sourceNode.loop||(t._eventTarget.emit("ended"),t._state=n3.STOPPED)},t._do_play=function(){t._sourceNode=t._context.createBufferSource(),t._sourceNode.buffer=t._audio,t._sourceNode.loop=t._loop,t._sourceNode.connect(t._gainNode),t._sourceNode.start(0,t._offset),t._state=n3.PLAYING,t._startTime=t._context.currentTime,kx.once(Cx.EVENT_AFTER_UPDATE,function(){t._eventTarget.emit("started")}),clearInterval(t._currentTimer),t._currentTimer=window.setInterval(function(){t._on_ended(),clearInterval(t._currentTimer),t._sourceNode.loop&&(t._currentTimer=window.setInterval(t._on_ended,1e3*t._audio.duration))},1e3*(t._audio.duration-t._offset))},t._on_gesture=function(){t._context.resume().then(function(){t._interrupted&&(t._do_play(),t._interrupted=!1),cc.game.canvas.removeEventListener("touchend",t._on_gesture),cc.game.canvas.removeEventListener("mouseup",t._on_gesture)})},"running"!==t._context.state&&(cc.game.canvas.addEventListener("touchend",t._on_gesture),cc.game.canvas.addEventListener("mouseup",t._on_gesture)),t}return _(i,r3),l(i,[{key:"play",value:function(){this._audio&&this._state!==n3.PLAYING&&(this._blocking||"running"!==this._context.state?this._interrupted=!0:this._do_play())}},{key:"pause",value:function(){this._state===n3.PLAYING&&(this._sourceNode.stop(),this._offset+=this._context.currentTime-this._startTime,this._state=n3.STOPPED,clearInterval(this._currentTimer))}},{key:"stop",value:function(){this._offset=0,this._state===n3.PLAYING&&(this._sourceNode.stop(),this._state=n3.STOPPED,clearInterval(this._currentTimer))}},{key:"playOneShot",value:function(e){var t=0<arguments.length&&void 0!==e?e:1;if(this._audio){var i=this._context.createGain();i.connect(this._context.destination),i.gain.value=t;var n=this._context.createBufferSource();n.buffer=this._audio,n.loop=!1,n.connect(i),n.start()}}},{key:"setCurrentTime",value:function(e){this._offset=pi(e,0,this._audio&&this._audio.duration||this._duration),this._state===n3.PLAYING&&(this._sourceNode.stop(),this._do_play())}},{key:"getCurrentTime",value:function(){return this._state!==n3.PLAYING?this._offset:this._context.currentTime-this._startTime+this._offset}},{key:"setVolume",value:function(e,t){this._volume=e,!t&&this._gainNode.gain.setTargetAtTime?this._gainNode.gain.setTargetAtTime(e,this._context.currentTime,.01):this._gainNode.gain.value=e}},{key:"getVolume",value:function(){return this._volume}},{key:"setLoop",value:function(e){this._loop=e,this._sourceNode.loop=e}},{key:"getLoop",value:function(){return this._loop}},{key:"destroy",value:function(){p(g(i.prototype),"destroy",this).call(this)}}]),i}(),l3=vt({WEB_AUDIO:0,DOM_AUDIO:1,WX_GAME_AUDIO:2,UNKNOWN_AUDIO:3}),u3=m4("AudioClip",(K2=fo("cc.AudioClip"),Q2=_o({type:l3}),K2((i3=t3=function(){function t(){var e;return y(this,t),v(e=x(this,g(t).call(this)),"_duration",$2,c(e)),v(e,"_loadMode",e3,c(e)),e._audio=null,e._player=null,e.loaded=!1,e}return _(t,nh),l(t,[{key:"destroy",value:function(){return this._player&&this._player.destroy(),p(g(t.prototype),"destroy",this).call(this)}},{key:"play",value:function(){this._player&&this._player.play()}},{key:"pause",value:function(){this._player&&this._player.pause()}},{key:"stop",value:function(){this._player&&this._player.stop()}},{key:"playOneShot",value:function(e){this._player&&this._player.playOneShot(e)}},{key:"setCurrentTime",value:function(e){this._player&&this._player.setCurrentTime(e)}},{key:"getCurrentTime",value:function(){return this._player?this._player.getCurrentTime():0}},{key:"getDuration",value:function(){return this._player?this._player.getDuration():this._duration}},{key:"setVolume",value:function(e,t){this._player&&this._player.setVolume(e,t||!1)}},{key:"getVolume",value:function(){return this._player?this._player.getVolume():1}},{key:"setLoop",value:function(e){this._player&&this._player.setLoop(e)}},{key:"getLoop",value:function(){return!!this._player&&this._player.getLoop()}},{key:"_nativeAsset",set:function(e){var t;(this._audio=e)?("undefined"!=typeof AudioBuffer&&e instanceof AudioBuffer?(t=o3,this._loadMode=l3.WEB_AUDIO):(t=a3,this._loadMode=l3.DOM_AUDIO),this._player=new t({clip:e,duration:this._duration,eventTarget:this}),this.loaded=!0,this.emit("load")):(this._player=null,this._loadMode=l3.UNKNOWN_AUDIO,this._duration=0,this.loaded=!1)},get:function(){return this._audio}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.getState():n3.INITIALIZING}}]),t}(),t3.PlayingState=n3,t3.AudioType=l3,t3.preventDeferredLoadDependents=!0,$2=m((J2=i3).prototype,"_duration",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),e3=m(J2.prototype,"_loadMode",[Q2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return l3.UNKNOWN_AUDIO}}),Z2=J2))||Z2));cc.AudioClip=u3;var c3,h3,f3,d3,_3,p3,v3,m3,y3,g3,b3=fl.__audioSupport,x3=b3.format;function S3(t,i){var e=document.createElement("audio");e.src=t.url;function n(){clearTimeout(r),e.removeEventListener("canplaythrough",a,!1),e.removeEventListener("error",s,!1),b3.USE_LOADER_EVENT&&e.removeEventListener(b3.USE_LOADER_EVENT,a,!1)}var r=setTimeout(function(){0===e.readyState?s():a()},8e3),a=function(){n(),i(null,e)},s=function(){n();var e="load audio failure - "+t.url;E(e),i(e)};e.addEventListener("canplaythrough",a,!1),e.addEventListener("error",s,!1),b3.USE_LOADER_EVENT&&e.addEventListener(b3.USE_LOADER_EVENT,a,!1)}function T3(e,t){var i=b3.context;i||t(new Error(G(4926)));var n=gw.getXMLHttpRequest();n.open("GET",e.url,!0),n.responseType="arraybuffer",n.onload=function(){i.decodeAudioData(n.response,function(e){t(null,e)},function(){t("decode error - "+e.id,null)})},n.onerror=function(){t("request error - "+e.id,null)},n.send()}function w3(e,t){if(0===x3.length)return new Error(G(4927));(b3.WEB_AUDIO?e._owner instanceof u3?e._owner.loadMode===l3.WEB_AUDIO?T3:S3:e.urlParam&&e.urlParam.useDom?S3:T3:S3)(e,t)}gw.downloader.addHandlers({mp3:w3,ogg:w3,wav:w3,m4a:w3});var E3=m4("AudioSourceComponent",(c3=fo("cc.AudioSourceComponent"),h3=go("Components/AudioSource"),f3=_o(u3),d3=_o({type:u3}),c3(_3=h3((v3=m((p3=function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))),"_clip",v3,c(t)),v(t,"_loop",m3,c(t)),v(t,"_playOnAwake",y3,c(t)),v(t,"_volume",g3,c(t)),t._cachedCurrentTime=0,t}return _(a,Tm),l(a,[{key:"onLoad",value:function(){this._syncStates(),this._playOnAwake&&this.play()}},{key:"play",value:function(){this._clip&&(this.playing?this.currentTime=0:this._clip.play())}},{key:"pause",value:function(){this._clip&&this._clip.pause()}},{key:"stop",value:function(){this._clip&&this._clip.stop()}},{key:"playOneShot",value:function(e,t){var i=1<arguments.length&&void 0!==t?t:1;e.playOneShot(this._volume*i)}},{key:"_syncStates",value:function(){this._clip&&(this._clip.setCurrentTime(this._cachedCurrentTime),this._clip.setLoop(this._loop),this._clip.setVolume(this._volume,!0),this._volume=this._clip.getVolume())}},{key:"clip",set:function(e){this._clip=e,this._syncStates()},get:function(){return this._clip}},{key:"loop",set:function(e){this._loop=e,this._clip&&this._clip.setLoop(e)},get:function(){return this._loop}},{key:"playOnAwake",set:function(e){this._playOnAwake=e},get:function(){return this._playOnAwake}},{key:"volume",set:function(e){isNaN(e)?console.warn("illegal audio volume!"):(e=pi(e,0,1),this._clip?(this._clip.setVolume(e),this._volume=this._clip.getVolume()):this._volume=e)},get:function(){return this._volume}},{key:"currentTime",set:function(e){isNaN(e)?console.warn("illegal audio time!"):(e=pi(e,0,this.duration),this._cachedCurrentTime=e,this._clip&&this._clip.setCurrentTime(this._cachedCurrentTime))},get:function(){return this._clip?this._clip.getCurrentTime():this._cachedCurrentTime}},{key:"duration",get:function(){return this._clip?this._clip.getDuration():0}},{key:"state",get:function(){return this._clip?this._clip.state:u3.PlayingState.INITIALIZING}},{key:"playing",get:function(){return this.state===u3.PlayingState.PLAYING}}]),a}()).prototype,"_clip",[f3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m3=m(p3.prototype,"_loop",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),y3=m(p3.prototype,"_playOnAwake",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),g3=m(p3.prototype,"_volume",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),m(p3.prototype,"clip",[d3],Object.getOwnPropertyDescriptor(p3.prototype,"clip"),p3.prototype),m(p3.prototype,"loop",[_o],Object.getOwnPropertyDescriptor(p3.prototype,"loop"),p3.prototype),m(p3.prototype,"playOnAwake",[_o],Object.getOwnPropertyDescriptor(p3.prototype,"playOnAwake"),p3.prototype),m(p3.prototype,"volume",[_o],Object.getOwnPropertyDescriptor(p3.prototype,"volume"),p3.prototype),_3=p3))||_3)||_3));cc.AudioSourceComponent=E3;function A3(e,t,i,n){if(y(this,A3),this.id=void 0,this.tween=void 0,this._opts=void 0,this._props=void 0,this.id=A3._idCounter++,this.tween=new C3.Tween(e),this._props=i,this._opts=n,this.tween.to(i,t),null!=n){if(null!=n.delay&&this.tween.delay(n.delay),null!=n.repeat&&this.tween.repeat(n.repeat),null!=n.repeatDelay&&this.tween.repeatDelay(n.repeatDelay),null!=n.yoyo&&this.tween.yoyo(n.yoyo),null!=n.easing)if("string"==typeof n.easing){var r=n.easing.split("-");if(2<=r.length){var a=r[0],s=r[1];"Linear"===a?"None"===s&&this.tween.easing(C3.Easing[a][s]):"In"!==s&&"Out"!==s&&"InOut"!==s||this.tween.easing(C3.Easing[a][s])}}else this.tween.easing(n.easing);if(null!=n.interpolation)if("string"==typeof n.interpolation){var o=n.interpolation.split("-");if(1<=o.length){var l=o[0];this.tween.interpolation(C3.Interpolation[l])}}else this.tween.interpolation(n.interpolation);null!=n.onStart&&this.tween.onStart(n.onStart),null!=n.onStop&&this.tween.onStop(n.onStop),null!=n.onUpdate&&this.tween.onUpdate(n.onUpdate),null!=n.onComplete&&this.tween.onComplete(n.onComplete)}}var C3=l1(function(e,t){function i(){this._tweens={},this._tweensAddedDuringUpdate={}}i.prototype={getAll:function(){return Object.keys(this._tweens).map(function(e){return this._tweens[e]}.bind(this))},removeAll:function(){this._tweens={}},add:function(e){this._tweens[e.getId()]=e,this._tweensAddedDuringUpdate[e.getId()]=e},remove:function(e){delete this._tweens[e.getId()],delete this._tweensAddedDuringUpdate[e.getId()]},update:function(e,t){var i=Object.keys(this._tweens);if(0===i.length)return!1;for(e=void 0!==e?e:l.now();0<i.length;){this._tweensAddedDuringUpdate={};for(var n=0;n<i.length;n++){var r=this._tweens[i[n]];r&&!1===r.update(e)&&(r._isPlaying=!1,t||delete this._tweens[i[n]])}i=Object.keys(this._tweensAddedDuringUpdate)}return!0}};var n,l=new i;l.Group=i,l._nextId=0,l.nextId=function(){return l._nextId++},"undefined"==typeof self&&"undefined"!=typeof process&&process.hrtime?l.now=function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:"undefined"!=typeof self&&void 0!==self.performance&&void 0!==self.performance.now?l.now=self.performance.now.bind(self.performance):void 0!==Date.now?l.now=Date.now:l.now=function(){return(new Date).getTime()},l.Tween=function(e,t){this._object=e,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._repeat=0,this._repeatDelayTime=void 0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=null,this._easingFunction=l.Easing.Linear.None,this._interpolationFunction=l.Interpolation.Linear,this._chainedTweens=[],this._onStartCallback=null,this._onStartCallbackFired=!1,this._onUpdateCallback=null,this._onRepeatCallback=null,this._onCompleteCallback=null,this._onStopCallback=null,this._group=t||l,this._id=l.nextId(),this._onCompleteCallbackForCocos=null},l.Tween.prototype={getId:function(){return this._id},isPlaying:function(){return this._isPlaying},to:function(e,t){return this._valuesEnd=JSON.parse(JSON.stringify(e)),void 0!==t&&(this._duration=t),this},duration:function(e){return this._duration=e,this},start:function(e){return this._group.add(this),this._isPlaying=!0,this._onStartCallbackFired=!1,this._startTime=void 0!==e?"string"==typeof e?l.now()+parseFloat(e):e:l.now(),this._startTime+=this._delayTime,l._recursiveObjetCopy(this._valuesEnd,this._valuesStart,this._valuesStartRepeat,this._object),this},stop:function(){return this._isPlaying&&(this._group.remove(this),this._isPlaying=!1,null!==this._onStopCallback&&this._onStopCallback(this._object),this.stopChainedTweens()),this},end:function(){return this.update(1/0),this},stopChainedTweens:function(){for(var e=0,t=this._chainedTweens.length;e<t;e++)this._chainedTweens[e].stop()},group:function(e){return this._group=e,this},delay:function(e){return this._delayTime=e,this},repeat:function(e){return this._repeat=e,this},repeatDelay:function(e){return this._repeatDelayTime=e,this},yoyo:function(e){return this._yoyo=e,this},easing:function(e){return this._easingFunction=e,this},interpolation:function(e){return this._interpolationFunction=e,this},chain:function(){return this._chainedTweens=arguments,this},onStart:function(e){return this._onStartCallback=e,this},onUpdate:function(e){return this._onUpdateCallback=e,this},onRepeat:function(e){return this._onRepeatCallback=e,this},onComplete:function(e){return this._onCompleteCallback=e,this},onStop:function(e){return this._onStopCallback=e,this},update:function(e){var t,i,n;if(e<this._startTime)return!0;if(!1===this._onStartCallbackFired&&(null!==this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),i=(e-this._startTime)/this._duration,i=0===this._duration||1<i?1:i,n=this._easingFunction(i),l._recursiveObjetUpdate(this._valuesEnd,this._valuesStart,n,this._object,this),null!==this._onUpdateCallback&&this._onUpdateCallback(this._object,i),1!==i)return!0;if(0<this._repeat){for(t in isFinite(this._repeat)&&this._repeat--,this._valuesStartRepeat){if("string"==typeof this._valuesEnd[t]&&(this._valuesStartRepeat[t]=this._valuesStartRepeat[t]+parseFloat(this._valuesEnd[t])),this._yoyo){var r=this._valuesStartRepeat[t];this._valuesStartRepeat[t]=this._valuesEnd[t],this._valuesEnd[t]=r}this._valuesStart[t]=this._valuesStartRepeat[t]}return this._yoyo&&(this._reversed=!this._reversed),void 0!==this._repeatDelayTime?this._startTime=e+this._repeatDelayTime:this._startTime=e+this._delayTime,null!==this._onRepeatCallback&&this._onRepeatCallback(this._object),!0}if(null!==this._onCompleteCallback&&this._onCompleteCallback(this._object),null!==this._onCompleteCallbackForCocos)this._onCompleteCallbackForCocos(this);else for(var a=0,s=this._chainedTweens.length;a<s;a++)this._chainedTweens[a].start(this._startTime+this._duration);return!1},cc_onCompleteCallback:function(e){this._onCompleteCallbackForCocos=e}},l._recursiveObjetUpdate=function(e,t,i,n,r){var a,s;for(var o in e)a=e[o],s=t[o],a instanceof Array?n[o]=r._interpolationFunction(a,i):("string"==typeof a&&(a="+"===a.charAt(0)||"-"===a.charAt(0)?s+parseFloat(a):parseFloat(a)),"number"==typeof a?n[o]=s+(a-s)*i:"object"==typeof a&&l._recursiveObjetUpdate(a,s,i,n[o],r))},l._recursiveObjetCopy=function(e,t,i,n){for(var r in e){if(e[r]instanceof Array){if(0===e[r].length)continue;e[r]=[n[r]].concat(e[r])}void 0!==n[r]&&("object"==typeof n[r]?(t[r]={},i[r]={},l._recursiveObjetCopy(e[r],t[r],i[r],n[r])):(t[r]=n[r],"string"==typeof t[r]&&(t[r]*=1),i[r]=t[r]||0))}},l.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){return 0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)},Out:function(e){return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1}},Back:{In:function(e){return e*e*(2.70158*e-1.70158)},Out:function(e){return--e*e*(2.70158*e+1.70158)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((1+t)*e-t)*.5:.5*((e-=2)*e*((1+t)*e+t)+2)}},Bounce:{In:function(e){return 1-l.Easing.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*l.Easing.Bounce.In(2*e):.5*l.Easing.Bounce.Out(2*e-1)+.5}}},l.Interpolation={Linear:function(e,t){var i=e.length-1,n=i*t,r=Math.floor(n),a=l.Interpolation.Utils.Linear;return t<0?a(e[0],e[1],n):1<t?a(e[i],e[i-1],i-n):a(e[r],e[i<r+1?i:r+1],n-r)},Bezier:function(e,t){for(var i=0,n=e.length-1,r=Math.pow,a=l.Interpolation.Utils.Bernstein,s=0;s<=n;s++)i+=r(1-t,n-s)*r(t,s)*e[s]*a(n,s);return i},CatmullRom:function(e,t){var i=e.length-1,n=i*t,r=Math.floor(n),a=l.Interpolation.Utils.CatmullRom;return e[0]===e[i]?(t<0&&(r=Math.floor(n=i*(1+t))),a(e[(r-1+i)%i],e[r],e[(r+1)%i],e[(r+2)%i],n-r)):t<0?e[0]-(a(e[0],e[0],e[1],e[1],-n)-e[0]):1<t?e[i]-(a(e[i],e[i],e[i-1],e[i-1],n-i)-e[i]):a(e[r?r-1:0],e[r],e[i<r+1?i:r+1],e[i<r+2?i:r+2],n-r)},Utils:{Linear:function(e,t,i){return(t-e)*i+e},Bernstein:function(e,t){var i=l.Interpolation.Utils.Factorial;return i(e)/i(t)/i(e-t)},Factorial:(n=[1],function(e){var t=1;if(n[e])return n[e];for(var i=e;1<i;i--)t*=i;return n[e]=t}),CatmullRom:function(e,t,i,n,r){var a=.5*(i-e),s=.5*(n-t),o=r*r;return r*o*(2*t-2*i+a+s)+(-3*t+3*i-2*a-s)*o+a*r+t}}},e.exports=l});C3.TWEEN;function k3(e,t){e.__cc_wrapper__=t}A3._idCounter=0,cc.TweenAction=A3,window.TWEEN=C3;var R3=function(){function e(){y(this,e),this.quene=[]}return l(e,[{key:"updateChain",value:function(){for(var e=this.length,t=0,i=1;t<e;){var n=this.quene[t];if(i<e){if(0<n.length){var r=this.quene[i];if(0===n.repeatTimes){if(0<r.length)n.lastAction.tween.chain(r.lastAction.tween)}else this.wrapAndEvent(n)}}else if(0<n.length&&0!==n.repeatTimes){var a=n.lastAction;k3(a.tween,n),a.tween.cc_onCompleteCallback(this._onComplete.bind(this))}++t,++i}}},{key:"start",value:function(){this.updateChain(),0<this.length&&this.firstUnion.start()}},{key:"stop",value:function(){for(var e=0;e<this.length;e++){if(this.quene[e].stop())break}}},{key:"union",value:function(e){this.quene.push(e)}},{key:"isExistUnion",value:function(e){return-1!==this.quene.indexOf(e)}},{key:"wrapAndEvent",value:function(e){var t=e.lastAction;k3(t.tween,e),t.tween.cc_onCompleteCallback(this._onComplete.bind(this))}},{key:"_onComplete",value:function(e){var t=function(e){return e.__cc_wrapper__}(e);if(0<t.repeatTimes&&0<t.lastCount){t.runTimes++;var i=this.quene.indexOf(t);if(0<=i){for(var n=0;n<i;n++)this.quene[n].runTimes=0;this.firstUnion.start()}}else if(-1===t.repeatTimes){var r=this.quene.indexOf(t);if(0<=r){for(var a=0;a<r;a++)this.quene[a].runTimes=0;this.firstUnion.start()}}else{t.onCompeleteCallback&&t.onCompeleteCallback(e._object);var s=this.quene.indexOf(t);if(s!==this.length-1)this.quene[s+1].start()}}},{key:"length",get:function(){return this.quene.length}},{key:"firstUnion",get:function(){return this.quene[0]}},{key:"lastUnion",get:function(){return this.quene[this.quene.length-1]}}]),e}();cc.TweenCommand=R3;var O3=function(){function t(e){y(this,t),this.id=void 0,this._actions=[],this._target=void 0,this._runTimes=0,this._repeatTimes=0,this._onCompeleteCallback=void 0,this._delay=0,this.id=t._idCounter++,this._target=e}return l(t,[{key:"actions",get:function(){return this._actions}},{key:"length",get:function(){return this._actions.length}},{key:"firstAction",get:function(){return this._actions[0]}},{key:"lastAction",get:function(){return this._actions[this._actions.length-1]}},{key:"target",get:function(){return this._target}},{key:"runTimes",get:function(){return this._runTimes},set:function(e){this._runTimes=e}},{key:"repeatTimes",get:function(){return this._repeatTimes},set:function(e){this._repeatTimes=e}},{key:"lastCount",get:function(){return this._repeatTimes-this._runTimes}},{key:"onCompeleteCallback",set:function(e){this._onCompeleteCallback=e},get:function(){return this._onCompeleteCallback}},{key:"delay",get:function(){return this._delay},set:function(e){this._delay=e}}]),l(t,[{key:"start",value:function(){if(0<this.length)if(0<this.delay){var e=this.actions[0].tween;setTimeout(e.start.bind(e),this.delay)}else this.actions[0].tween.start()}},{key:"stop",value:function(){for(var e=0;e<this._actions.length;e++){var t=this._actions[e].tween;if(t.isPlaying())return t.stop(),!0}return!1}}]),t}();O3._idCounter=0,cc.TweenUnion=O3;var M3=m4("Tween",function(){function r(e){y(this,r),this._command=new R3,this._default=void 0,this._uionDirty=!1,this._default=new O3(e)}return l(r,null,[{key:"_recursiveForBy",value:function(e){var t;for(var i in e)if("number"==typeof(t=e[i])){var n=0<t?"+":"-";e[i]=n+t}else"object"===be(t)&&r._recursiveForBy(t)}}]),l(r,[{key:"to",value:function(e,t,i){this._uionDirty&&(this._default=new O3(this._default.target),this._uionDirty=!1);var n=new A3(this._default.target,1e3*e,t,i);return 0<this._default.length&&this._default.actions[this._default.length-1].tween.chain(n.tween),this._default.actions.push(n),this}},{key:"by",value:function(e,t,i){this._uionDirty&&(this._default=new O3(this._default.target),this._uionDirty=!1),r._recursiveForBy(t);var n=new A3(this._default.target,1e3*e,t,i);return 0<this._default.length&&this._default.actions[this._default.length-1].tween.chain(n.tween),this._default.actions.push(n),this}},{key:"union",value:function(){return this._command.isExistUnion(this._default)||(this._command.union(this._default),this._uionDirty=!0),this}},{key:"start",value:function(){return 0<this._default.length&&(this._command.isExistUnion(this._default)||this._command.union(this._default)),this._command.start(),this}},{key:"stop",value:function(){return this._command.stop(),this}},{key:"repeat",value:function(e){return this._uionDirty?this._default.repeatTimes=e:0<this._default.length&&this._default.lastAction.tween.repeat(e),this}},{key:"repeatForever",value:function(){return this._uionDirty?this._default.repeatTimes=-1:0<this._default.length&&this._default.lastAction.tween.repeat(1/0),this}},{key:"delay",value:function(e){return this._uionDirty?this._default.delay=1e3*e:0<this._default.length&&this._default.lastAction.tween.delay(1e3*e),this}},{key:"call",value:function(e){return this._uionDirty?this._default.onCompeleteCallback=e:0<this._default.length&&this._default.lastAction.tween.onComplete(e),this}}]),r}());function I3(e){return new M3(e)}cc.Tween=M3,cc.tweenUtil=I3;var B3=function(){function e(){return y(this,e),x(this,g(e).apply(this,arguments))}return _(e,iv),l(e,[{key:"postUpdate",value:function(e){window.TWEEN&&window.TWEEN.update(performance.now())}}]),e}();function L3(e){return A("tween' is deprecated, please use 'tweenUtil' instead "),I3(e)}B3.ID="tween",kx.on(Cx.EVENT_INIT,function(){var e=new B3;kx.registerSystem(B3.ID,e,100)}),cc.tween=L3;m4("HeightField",function(){function n(e,t){y(this,n),this.data=new Uint16Array,this.w=0,this.h=0,this.w=e,this.h=t,this.data=new Uint16Array(e*t);for(var i=0;i<e*t;++i)this.data[i]=0}return l(n,[{key:"set",value:function(e,t,i){this.data[t*this.w+e]=i}},{key:"get",value:function(e,t){return this.data[t*this.w+e]}},{key:"getClamp",value:function(e,t){return e=pi(e,0,this.w-1),t=pi(t,0,this.h-1),this.get(e,t)}},{key:"getAt",value:function(e,t){var i=e/this.w,n=t/this.h,r=Math.floor(i),a=Math.floor(n),s=r+1,o=a+1,l=i-r,u=n-a;r=pi(r,0,this.w-1),a=pi(a,0,this.h-1),s=pi(s,0,this.w-1),o=pi(o,0,this.h-1);var c=this.get(r,a),h=this.get(s,a),f=this.get(r,o),d=this.get(s,o),_=.5*(h+f);return l+u<=1?d=_-c+_:c=_-d+_,(c*(1-l)+h*l)*(1-u)+(f*(1-l)+d*l)*u}}]),n}()),m4("TERRAIN_MAX_LEVELS",4),m4("TERRAIN_MAX_BLEND_LAYERS",4);var P3,F3,z3,D3,N3,U3,V3,G3,H3,W3,q3,j3,X3,Y3,K3,Q3,Z3,J3,$3,e4,t4,i4,n4,r4,a4,s4,o4,l4=m4("TERRAIN_MAX_LAYER_COUNT",256),u4=m4("TERRAIN_BLOCK_TILE_COMPLEXITY",32),c4=m4("TERRAIN_BLOCK_VERTEX_COMPLEXITY",33),h4=m4("TERRAIN_BLOCK_VERTEX_SIZE",8),f4=(m4("TERRAIN_NORTH_INDEX",0),m4("TERRAIN_SOUTH_INDEX",1),m4("TERRAIN_WEST_INDEX",2),m4("TERRAIN_EAST_INDEX",3),m4("TerrainInfo",fo("cc.TerrainInfo")((z3=m((F3=function(){function e(){y(this,e),v(this,"tileSize",z3,this),v(this,"blockCount",D3,this),v(this,"weightMapSize",N3,this),v(this,"lightMapSize",U3,this),this._tileCount=[0,0],this._vertexCount=[0,0],this._size=new jn(0,0)}return l(e,[{key:"initialize",value:function(){this._tileCount[0]=this.blockCount[0]*u4,this._tileCount[1]=this.blockCount[1]*u4,this._vertexCount[0]=this._tileCount[0]+1,this._vertexCount[1]=this._tileCount[1]+1,this._size.width=this._tileCount[0]*this.tileSize,this._size.height=this._tileCount[1]*this.tileSize}},{key:"tileCount",get:function(){return this._tileCount}},{key:"vertexCount",get:function(){return this._vertexCount}},{key:"size",get:function(){return this._size}}]),e}()).prototype,"tileSize",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),D3=m(F3.prototype,"blockCount",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[1,1]}}),N3=m(F3.prototype,"weightMapSize",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),U3=m(F3.prototype,"lightMapSize",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),P3=F3))||P3)),d4=m4("TerrainLayer",fo("cc.TerrainLayer")((H3=m((G3=function e(){y(this,e),v(this,"detailMap",H3,this),v(this,"tileSize",W3,this)}).prototype,"detailMap",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),W3=m(G3.prototype,"tileSize",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),V3=G3))||V3),_4=(m4("TerrainVertex",function e(){y(this,e),this.position=new Ni(0,0,0),this.normal=new Ni(0,1,0),this.uv=new Ii(0,0)}),m4("TerrainRenderable",function(){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=x(this,(e=g(a)).call.apply(e,[this].concat(n))))._model=null,t._meshData=null,t._brushMaterial=null,t._currentMaterial=null,t._currentMaterialLayers=0,t}return _(a,ZA),l(a,[{key:"destroy",value:function(){this._invalidMaterial(),null!=this._model&&(this._getRenderScene().destroyModel(this._model),this._model=null),p(g(a.prototype),"destroy",this).call(this)}},{key:"_invalidMaterial",value:function(){null!=this._currentMaterial&&(this._clearMaterials(),(this._currentMaterial=null)!=this._model&&(this._model.enabled=!1))}},{key:"_updateMaterial",value:function(e,t){if(null!=this._meshData&&null!=this._model){var i=e.getMaxLayer();if(null==this._currentMaterial||i!==this._currentMaterialLayers){if(this._currentMaterial=new F_,this._currentMaterial.initialize({effectAsset:P_.get("builtin-terrain"),defines:e._getMaterialDefines(i)}),null!==this._brushMaterial)this._currentMaterial.passes.push(this._brushMaterial.passes[0]);t&&this._model.initSubModel(0,this._meshData,this._currentMaterial),this.setMaterial(this._currentMaterial,0),this._currentMaterialLayers=i,this._model.enabled=!0}}}},{key:"_onMaterialModified",value:function(e,t){null!=this._model&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.setSubModelMaterial(e,t)}},{key:"_clearMaterials",value:function(){null!=this._model&&this._onMaterialModified(0,null)}},{key:"_getBuiltinMaterial",value:function(){return t_.get("missing-material")}}]),a}())),p4=m4("TerrainBlockInfo",fo("cc.TerrainBlockInfo")((X3=m((j3=function e(){y(this,e),v(this,"layers",X3,this)}).prototype,"layers",[_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[-1,-1,-1,-1]}}),q3=j3))||q3),v4=m4("TerrainBlock",function(){function n(e,t,i){y(this,n),this._terrain=void 0,this._info=void 0,this._node=void 0,this._renderable=void 0,this._index=[1,1],this._weightMap=null,this._terrain=e,this._info=e.getBlockInfo(t,i),this._index[0]=t,this._index[1]=i,this._node=new dg(""),this._node.setParent(this._terrain.node),this._node._objFlags|=cc.Object.Flags.DontSave,this._renderable=this._node.addComponent(_4)}return l(n,[{key:"build",value:function(){for(var e=kx.root.device,t=new Float32Array(h4*c4*c4),i=0,n=0;n<c4;++n)for(var r=0;r<c4;++r){var a=this._index[0]*u4+r,s=this._index[1]*u4+n,o=this._terrain.getPosition(a,s),l=this._terrain.getNormal(a,s),u=new Ii(r/u4,n/u4);t[i++]=o.x,t[i++]=o.y,t[i++]=o.z,t[i++]=l.x,t[i++]=l.y,t[i++]=l.z,t[i++]=u.x,t[i++]=u.y}var c=e.createBuffer({usage:su.VERTEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:h4*Float32Array.BYTES_PER_ELEMENT*c4*c4,stride:h4*Float32Array.BYTES_PER_ELEMENT});c.update(t);var h=[{name:eu.ATTR_POSITION,format:ru.RGB32F},{name:eu.ATTR_NORMAL,format:ru.RGB32F},{name:eu.ATTR_TEX_COORD,format:ru.RG32F}];this._renderable._meshData={attributes:h,vertexBuffers:[c],indexBuffer:this._terrain.getSharedIndexBuffer(),primitiveMode:_u.TRIANGLE_LIST},this._renderable._model=this._renderable._getRenderScene().createModel(Hf,this._node),this._updateWeightMap(),this._updateMaterial(!0)}},{key:"rebuild",value:function(){this._updateHeight(),this._updateWeightMap(),this._renderable._invalidMaterial(),this._updateMaterial(!1)}},{key:"destroy",value:function(){null!=this._renderable&&this._renderable.destroy(),null!=this._node&&this._node.destroy(),null!=this._weightMap&&this._weightMap.destroy()}},{key:"update",value:function(){this._updateMaterial(!1);var e=this._renderable._currentMaterial;if(null!=e){var t=this.getMaxLayer(),i=new Xi(1,1,1,1);if(0===t)if(-1!==this.layers[0]){var n=this._terrain.getLayer(this.layers[0]);null!=n&&(i.x=1/n.tileSize),e.setProperty("detailMap0",null!=n?n.detailMap:null)}else e.setProperty("detailMap0",t_.get("default-texture"));else if(1===t){var r=this._terrain.getLayer(this.layers[0]),a=this._terrain.getLayer(this.layers[1]);null!=r&&(i.x=1/r.tileSize),null!=a&&(i.y=1/a.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=r?r.detailMap:null),e.setProperty("detailMap1",null!=a?a.detailMap:null)}else if(2===t){var s=this._terrain.getLayer(this.layers[0]),o=this._terrain.getLayer(this.layers[1]),l=this._terrain.getLayer(this.layers[2]);null!=s&&(i.x=1/s.tileSize),null!=o&&(i.y=1/o.tileSize),null!=l&&(i.z=1/l.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=s?s.detailMap:null),e.setProperty("detailMap1",null!=o?o.detailMap:null),e.setProperty("detailMap2",null!=l?l.detailMap:null)}else if(3===t){var u=this._terrain.getLayer(this.layers[0]),c=this._terrain.getLayer(this.layers[1]),h=this._terrain.getLayer(this.layers[2]),f=this._terrain.getLayer(this.layers[3]);null!=u&&(i.x=1/u.tileSize),null!=c&&(i.y=1/c.tileSize),null!=h&&(i.z=1/h.tileSize),null!=f&&(i.z=1/f.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=u?u.detailMap:null),e.setProperty("detailMap1",null!=c?c.detailMap:null),e.setProperty("detailMap2",null!=h?h.detailMap:null),e.setProperty("detailMap3",null!=f?f.detailMap:null)}e.setProperty("UVScale",i)}}},{key:"setBrushMaterial",value:function(e){this._renderable._brushMaterial!==e&&(this._renderable._brushMaterial=e,this._renderable._invalidMaterial())}},{key:"getTerrain",value:function(){return this._terrain}},{key:"getIndex",value:function(){return this._index}},{key:"getRect",value:function(){var e=new Jn;return e.x=this._index[0]*u4,e.y=this._index[1]*u4,e.width=u4,e.height=u4,e}},{key:"setLayer",value:function(e,t){this.layers[e]!==t&&(this.layers[e]=t,this._renderable._invalidMaterial(),this._updateMaterial(!1))}},{key:"getLayer",value:function(e){return this.layers[e]}},{key:"getMaxLayer",value:function(){return 0<=this.layers[3]?3:0<=this.layers[2]?2:0<=this.layers[1]?1:0}},{key:"_getMaterialDefines",value:function(e){return 0===e?{LAYERS:1}:1===e?{LAYERS:2}:2===e?{LAYERS:3}:3===e?{LAYERS:4}:{LAYERS:0}}},{key:"_invalidMaterial",value:function(){this._renderable._invalidMaterial()}},{key:"_updateMaterial",value:function(e){this._renderable._updateMaterial(this,e)}},{key:"_updateHeight",value:function(){if(null!=this._renderable._meshData){for(var e=new Float32Array(h4*c4*c4),t=0,i=0;i<c4;++i)for(var n=0;n<c4;++n){var r=this._index[0]*u4+n,a=this._index[1]*u4+i,s=this._terrain.getPosition(r,a),o=this._terrain.getNormal(r,a),l=new Ii(n/c4,i/c4);e[t++]=s.x,e[t++]=s.y,e[t++]=s.z,e[t++]=o.x,e[t++]=o.y,e[t++]=o.z,e[t++]=l.x,e[t++]=l.y}this._renderable._meshData.vertexBuffers[0].update(e)}}},{key:"_updateWeightMap",value:function(){if(0!==this.getMaxLayer()){null==this._weightMap&&(this._weightMap=new Hh,this._weightMap.create(this._terrain.info.weightMapSize,this._terrain.info.weightMapSize,Hc.RGBA8888),this._weightMap.setFilters(Xc.LINEAR,Xc.LINEAR),this._weightMap.setWrapMode(qc.CLAMP_TO_EDGE,qc.CLAMP_TO_EDGE));for(var e=new Uint8Array(this._terrain.info.weightMapSize*this._terrain.info.weightMapSize*4),t=0,i=0;i<this._terrain.info.weightMapSize;++i)for(var n=0;n<this._terrain.info.weightMapSize;++n){var r=this._index[0]*this._terrain.info.weightMapSize+n,a=this._index[1]*this._terrain.info.weightMapSize+i,s=this._terrain.getWeight(r,a);e[4*t+0]=Math.floor(255*s.x),e[4*t+1]=Math.floor(255*s.y),e[4*t+2]=Math.floor(255*s.z),e[4*t+3]=Math.floor(255*s.w),t+=1}this._weightMap.uploadData(e.buffer)}else null!=this._weightMap&&(this._weightMap.destroy(),this._weightMap=null)}},{key:"layers",get:function(){return this._info.layers}}]),n}());m4("Terrain",(Y3=fo("cc.Terrain"),K3=go("Components/Terrain"),Q3=_o({type:f4,visible:!0}),Z3=_o({type:d4,visible:!0}),J3=_o({visible:!1}),$3=_o({visible:!1}),e4=_o({visible:!1}),Y3(t4=K3(t4=mo((n4=m((i4=function(){function i(){var e;y(this,i),v(e=x(this,g(i).call(this)),"_info",n4,c(e)),v(e,"_layers",r4,c(e)),v(e,"_heights",a4,c(e)),v(e,"_weights",s4,c(e)),v(e,"_blockInfos",o4,c(e)),e._normals=[],e._blocks=[],e._sharedIndexBuffer=null;for(var t=0;t<l4;++t)e._layers.push(null);return e}return _(i,Tm),l(i,[{key:"build",value:function(e){return this._info.tileSize=e.tileSize,this._info.blockCount[0]=e.blockCount[0],this._info.blockCount[1]=e.blockCount[1],this._info.weightMapSize=e.weightMapSize,this._info.lightMapSize=e.lightMapSize,this._info.initialize(),this._buildImp()}},{key:"rebuild",value:function(e){e.initialize();for(var t=[],i=0;i<e.blockCount[0]*e.blockCount[1];++i)t.push(new p4);for(var n=Math.min(this.info.blockCount[0],e.blockCount[0]),r=Math.min(this.info.blockCount[1],e.blockCount[1]),a=0;a<r;++a)for(var s=0;s<n;++s){var o=a*e.vertexCount[0]+s,l=a*this.info.vertexCount[0]+s;t[o]=this._blockInfos[l]}this._blockInfos=t;var u=this._blocks,c=Array.isArray(u),h=0;for(u=c?u:u[Symbol.iterator]();;){var f;if(c){if(h>=u.length)break;f=u[h++]}else{if((h=u.next()).done)break;f=h.value}f.destroy()}this._blocks=[],this._rebuildHeights(e),this._rebuildWeights(e),this._info.tileSize=e.tileSize,this._info.blockCount[0]=e.blockCount[0],this._info.blockCount[1]=e.blockCount[1],this._info.weightMapSize=e.weightMapSize,this._info.lightMapSize=e.lightMapSize,this._info.initialize(),this._buildNormals();for(var d=0;d<this._info.blockCount[1];++d)for(var _=0;_<this._info.blockCount[0];++_)this._blocks.push(new v4(this,_,d));var p=this._blocks,v=Array.isArray(p),m=0;for(p=v?p:p[Symbol.iterator]();;){var y;if(v){if(m>=p.length)break;y=p[m++]}else{if((m=p.next()).done)break;y=m.value}y.build()}}},{key:"importHeightField",value:function(e,t){for(var i=0,n=0;n<this._info.vertexCount[1];++n)for(var r=0;r<this._info.vertexCount[0];++r){var a=r/this._info.tileCount[0],s=n/this._info.tileCount[1],o=e.getAt(a*e.w,s*e.h)*t;this._heights[i++]=o}this._buildNormals();var l=this._blocks,u=Array.isArray(l),c=0;for(l=u?l:l[Symbol.iterator]();;){var h;if(u){if(c>=l.length)break;h=l[c++]}else{if((c=l.next()).done)break;h=c.value}h._updateHeight()}}},{key:"exportHeightField",value:function(e,t){for(var i=0,n=0;n<e.h;++n)for(var r=0;r<e.w;++r){var a=r/(e.w-1),s=n/(e.h-1),o=a*this._info.size.width,l=s*this._info.size.height,u=this.getHeightAt(o,l);null!=u&&(e.data[i++]=u*t)}}},{key:"onLoad",value:function(){for(var e=kx.root.device,t=new Uint16Array(u4*u4*6),i=0,n=0;n<u4;++n)for(var r=0;r<u4;++r){var a=n*c4+r,s=n*c4+r+1,o=(n+1)*c4+r,l=(n+1)*c4+r+1;t[i++]=a,t[i++]=o,t[i++]=s,t[i++]=s,t[i++]=o,t[i++]=l}this._sharedIndexBuffer=e.createBuffer({usage:su.INDEX|su.TRANSFER_DST,memUsage:lu.HOST|lu.DEVICE,size:Uint16Array.BYTES_PER_ELEMENT*u4*u4*6,stride:Uint16Array.BYTES_PER_ELEMENT}),this._sharedIndexBuffer.update(t)}},{key:"onEnable",value:function(){0===this._blocks.length&&this._buildImp()}},{key:"onDisable",value:function(){var e=this._blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._blocks=[]}},{key:"onDestroy",value:function(){for(var e=0;e<this._layers.length;++e)this._layers[e]=null;null!=this._sharedIndexBuffer&&this._sharedIndexBuffer.destroy()}},{key:"onRestore",value:function(){this.onDisable(),this.onLoad(),this._buildImp()}},{key:"update",value:function(e){var t=this._blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.update()}}},{key:"addLayer",value:function(e){for(var t=0;t<this._layers.length;++t)if(null==this._layers[t])return this._layers[t]=e,t;return-1}},{key:"setLayer",value:function(e,t){this._layers[e]=t}},{key:"removeLayer",value:function(e){this._layers[e]=null}},{key:"getLayer",value:function(e){return this._layers[e]}},{key:"getPosition",value:function(e,t){var i=e*this._info.tileSize,n=t*this._info.tileSize,r=this.getHeight(e,t);return new Ni(i,r,n)}},{key:"setHeight",value:function(e,t,i){this._heights[t*this._info.vertexCount[0]+e]=i}},{key:"getHeight",value:function(e,t){return this._heights[t*this._info.vertexCount[0]+e]}},{key:"getHeightClamp",value:function(e,t){return e=pi(e,0,this._info.vertexCount[0]-1),t=pi(t,0,this._info.vertexCount[1]-1),this.getHeight(e,t)}},{key:"getHeightAt",value:function(e,t){var i=e/this._info.vertexCount[0],n=t/this._info.vertexCount[1],r=Math.floor(i),a=Math.floor(n),s=r+1,o=a+1,l=i-r,u=n-a;if(r<0||r>this._info.vertexCount[0]-1||a<0||a>this._info.vertexCount[1]-1)return null;r=pi(r,0,this._info.vertexCount[0]-1),a=pi(a,0,this._info.vertexCount[1]-1),s=pi(s,0,this._info.vertexCount[0]-1),o=pi(o,0,this._info.vertexCount[1]-1);var c=this.getHeight(r,a),h=this.getHeight(s,a),f=this.getHeight(r,o),d=this.getHeight(s,o),_=.5*(h+f);return l+u<=1?d=_-c+_:c=_-d+_,(c*(1-l)+h*l)*(1-u)+(f*(1-l)+d*l)*u}},{key:"_setNormal",value:function(e,t,i){var n=t*this._info.vertexCount[0]+e;this._normals[3*n+0]=i.x,this._normals[3*n+1]=i.y,this._normals[3*n+2]=i.z}},{key:"getNormal",value:function(e,t){var i=t*this._info.vertexCount[0]+e,n=new Ni;return n.x=this._normals[3*i+0],n.y=this._normals[3*i+1],n.z=this._normals[3*i+2],n}},{key:"getNormalAt",value:function(e,t){var i=e/this._info.vertexCount[0],n=t/this._info.vertexCount[1],r=Math.floor(i),a=Math.floor(n),s=r+1,o=a+1,l=i-r,u=n-a;if(r<0||r>this._info.vertexCount[0]-1||a<0||a>this._info.vertexCount[1]-1)return null;r=pi(r,0,this._info.vertexCount[0]-1),a=pi(a,0,this._info.vertexCount[1]-1),s=pi(s,0,this._info.vertexCount[0]-1),o=pi(o,0,this._info.vertexCount[1]-1);var c=this.getNormal(r,a),h=this.getNormal(s,a),f=this.getNormal(r,o),d=this.getNormal(s,o),_=new Ni;Ni.add(_,h,f).multiplyScalar(.5),l+u<=1?(d.set(_),d.subtract(c),d.add(_)):(c.set(_),c.subtract(d),c.add(_));var p=new Ni,v=new Ni,m=new Ni;return Ni.lerp(p,c,h,l),Ni.lerp(v,f,d,l),Ni.lerp(m,p,v,u),m}},{key:"setWeight",value:function(e,t,i){var n=t*this.info.weightMapSize*this.info.blockCount[0]+e;this._weights[4*n+0]=255*i.x,this._weights[4*n+1]=255*i.y,this._weights[4*n+2]=255*i.z,this._weights[4*n+3]=255*i.w}},{key:"getWeight",value:function(e,t){var i=t*this.info.weightMapSize*this.info.blockCount[0]+e,n=new Xi;return n.x=this._weights[4*i+0]/255,n.y=this._weights[4*i+1]/255,n.z=this._weights[4*i+2]/255,n.w=this._weights[4*i+3]/255,n}},{key:"getWeightAt",value:function(e,t){var i=e/this._info.vertexCount[0],n=t/this._info.vertexCount[1],r=Math.floor(i),a=Math.floor(n),s=r+1,o=a+1,l=i-r,u=n-a;if(r<0||r>this._info.vertexCount[0]-1||a<0||a>this._info.vertexCount[1]-1)return null;r=pi(r,0,this._info.vertexCount[0]-1),a=pi(a,0,this._info.vertexCount[1]-1),s=pi(s,0,this._info.vertexCount[0]-1),o=pi(o,0,this._info.vertexCount[1]-1);var c=this.getWeight(r,a),h=this.getWeight(s,a),f=this.getWeight(r,o),d=this.getWeight(s,o),_=new Xi;Xi.add(_,h,f).multiplyScalar(.5),l+u<=1?(d=new Xi,Xi.subtract(d,_,c).add(_)):(c=new Xi,Xi.subtract(c,_,d).add(_));var p=new Xi,v=new Xi,m=new Xi;return Xi.lerp(p,c,h,l),Xi.lerp(v,f,d,l),Xi.lerp(m,p,v,u),m}},{key:"getBlockInfo",value:function(e,t){return this._blockInfos[t*this._info.blockCount[0]+e]}},{key:"getBlock",value:function(e,t){return this._blocks[t*this._info.blockCount[0]+e]}},{key:"getBlocks",value:function(){return this._blocks}},{key:"getSharedIndexBuffer",value:function(){return this._sharedIndexBuffer}},{key:"rayCheck",value:function(e,t,i){var n=0,r=e,a=null,s=new Ni;if(s.set(t),s.multiplyScalar(i),t.equals(new Ni(0,1,0))){var o=this.getHeightAt(r.x,r.z);null!=o&&r.y<=o&&(a=new Ni(r.x,o,r.z))}else if(t.equals(new Ni(0,-1,0))){var l=this.getHeightAt(r.x,r.z);null!=l&&r.y>=l&&(a=new Ni(r.x,l,r.z))}else for(;n++<2e3;){var u=this.getHeightAt(r.x,r.z);if(null!=u&&r.y<=u){a=new Ni(r.x,u,r.z);break}r.add(s)}return a}},{key:"_calcuNormal",value:function(e,t){var i,n,r=1,a=this.getPosition(e,t);i=e<this._info.vertexCount[0]-1?this.getPosition(e+1,t):(r*=-1,this.getPosition(e-1,t)),n=t<this._info.vertexCount[1]-1?this.getPosition(e,t+1):(r*=-1,this.getPosition(e,t-1)),i.subtract(a),n.subtract(a);var s=new Ni;return s.set(n),s.cross(i),s.multiplyScalar(r),s.normalize(),s}},{key:"_buildNormals",value:function(){for(var e=0,t=0;t<this._info.vertexCount[1];++t)for(var i=0;i<this._info.vertexCount[0];++i){var n=this._calcuNormal(i,t);this._normals[3*e+0]=n.x,this._normals[3*e+1]=n.y,this._normals[3*e+2]=n.z,e+=1}}},{key:"_buildImp",value:function(){if(0<this._blocks.length)return!0;if(this._info.initialize(),0===this._info.blockCount[0]||0===this._info.blockCount[1])return!1;var e=this._info.vertexCount[0]*this._info.vertexCount[1];if(this._heights.length!==e){this._heights=new Array(e),this._normals=new Array(3*e);for(var t=0;t<e;++t)this._heights[t]=0,this._normals[3*t+0]=0,this._normals[3*t+1]=1,this._normals[3*t+2]=0}else this._normals=new Array(3*e),this._buildNormals();var i=this.info.weightMapSize*this.info.blockCount[0],n=this.info.weightMapSize*this.info.blockCount[1];if(this._weights.length!==i*n*4){this._weights=new Uint8Array(i*n*4);for(var r=0;r<i*n;++r)this._weights[4*r+0]=255,this._weights[4*r+1]=0,this._weights[4*r+2]=0,this._weights[4*r+3]=0}if(this._blockInfos.length!==this.info.blockCount[0]*this.info.blockCount[1]){this._blockInfos=[];for(var a=0;a<this.info.blockCount[1];++a)for(var s=0;s<this.info.blockCount[0];++s)this._blockInfos.push(new p4)}for(var o=0;o<this.info.blockCount[1];++o)for(var l=0;l<this.info.blockCount[0];++l)this._blocks.push(new v4(this,l,o));var u=this._blocks,c=Array.isArray(u),h=0;for(u=c?u:u[Symbol.iterator]();;){var f;if(c){if(h>=u.length)break;f=u[h++]}else{if((h=u.next()).done)break;f=h.value}f.build()}}},{key:"_rebuildHeights",value:function(e){if(this.info.vertexCount[0]===e.vertexCount[0]&&this.info.vertexCount[1]===e.vertexCount[1])return!1;for(var t=new Array(e.vertexCount[0]*e.vertexCount[1]),i=0;i<t.length;++i)t[i]=0;for(var n=Math.min(this.info.vertexCount[0],e.vertexCount[0]),r=Math.min(this.info.vertexCount[1],e.vertexCount[1]),a=0;a<r;++a)for(var s=0;s<n;++s){var o=a*e.vertexCount[0]+s,l=a*this.info.vertexCount[0]+s;t[o]=this._heights[l]}return this._heights=t,!0}},{key:"_rebuildWeights",value:function(e){var g=this,t=this.info.weightMapSize,a=this.info.weightMapSize*this.info.blockCount[0],i=this.info.weightMapSize*this.info.blockCount[1],n=e.weightMapSize*e.blockCount[0],r=e.weightMapSize*e.blockCount[1];if(n==a&&r==i)return!1;for(var s=new Uint8Array(n*r*4),o=0;o<n*r;++o)s[4*o+0]=255,s[4*o+1]=0,s[4*o+2]=0,s[4*o+3]=0;for(var l=Math.min(e.blockCount[0],this.info.blockCount[0]),u=Math.min(e.blockCount[1],this.info.blockCount[1]),b=function(e,t,i){var n=t*a+e,r=new Xi;return r.x=i[4*n+0]/255,r.y=i[4*n+1]/255,r.z=i[4*n+2]/255,r.w=i[4*n+3]/255,r},c=function(e,t,i,n,r){var a=Math.floor(e),s=Math.floor(t),o=a+1,l=s+1,u=e-a,c=t-s,h=b(a+i,s+n,g._weights),f=b(o+i,s+n,g._weights),d=b(a+i,l+n,g._weights),_=b(o+i,l+n,g._weights),p=new Xi;Xi.add(p,f,d).multiplyScalar(.5),u+c<=1?(_.set(p),_.subtract(h),_.add(p)):(h.set(p),h.subtract(_),h.add(p));var v=new Xi,m=new Xi,y=new Xi;return Xi.lerp(v,h,f,u),Xi.lerp(m,d,_,u),Xi.lerp(y,v,m,c),y},h=0;h<u;++h)for(var f=0;f<l;++f)for(var d=f*t,_=h*t,p=0;p<this.info.weightMapSize;++p)for(var v=0;v<this.info.weightMapSize;++v){var m=void 0;if(e.weightMapSize==t)m=b(v+d,p+_,this._weights);else m=c(v/(this.info.weightMapSize-1)*(t-1),p/(this.info.weightMapSize-1)*(t-1),d,_,this._weights);var y=f*this.info.weightMapSize+v,x=(h*this.info.weightMapSize+p)*n+y;s[4*x+0]=255*m.x,s[4*x+1]=255*m.y,s[4*x+2]=255*m.z,s[4*x+3]=255*m.w}return this._weights=s,!0}},{key:"info",get:function(){return this._info}}]),i}()).prototype,"_info",[Q3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f4}}),r4=m(i4.prototype,"_layers",[Z3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),a4=m(i4.prototype,"_heights",[J3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),s4=m(i4.prototype,"_weights",[$3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Uint8Array}}),o4=m(i4.prototype,"_blockInfos",[e4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),t4=i4))||t4)||t4)||t4))}}});
